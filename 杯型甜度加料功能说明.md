# 杯型、甜度、加料功能说明

## 🎯 功能概述

系统已升级支持：
1. **多杯型选择** - 同一款饮品可有多个杯型和价格
2. **甜度选择** - 5种甜度等级（0%、30%、50%、70%、100%）
3. **加料选择** - 4种加料（芝士、果冻、波霸、奶盖）
4. **管理员配置** - 可为每个菜品单独配置或批量修改

---

## 📊 数据结构变化

### 菜品表新增字段

```sql
sizes TEXT              -- 杯型价格 JSON: {"Medium 中杯": 120, "Large 大杯": 150}
sugar_levels TEXT       -- 可选甜度 JSON: ["0", "30", "50", "70", "100"]
available_toppings TEXT -- 可选加料 JSON: [1, 2, 3, 4] (加料商品ID)
```

---

## 🔄 更新步骤

### 1. 数据库迁移

```bash
cd /Volumes/512G/06-工具开发/BODA
node db/migrate-products.js
```

这会为products表添加新字段。

### 2. 更新菜单数据

```bash
node db/update-menu-v2.js
```

这会：
- 删除旧菜单
- 创建新菜单（已合并相同名称）
- 配置杯型、甜度、加料

### 3. 重启服务器

```bash
npm start
```

---

## 📋 菜单变化

### 合并前（53个商品）

```
抹茶系列：
- Creamy Matcha 奶香抹茶（中杯）120 EGP
- Creamy Matcha 奶香抹茶（大杯）150 EGP
- Strawberry Matcha 草莓抹茶（中杯）120 EGP
- Strawberry Matcha 草莓抹茶（大杯）150 EGP
...
```

### 合并后（37个商品）

```
抹茶系列：
- Creamy Matcha 奶香抹茶
  └─ 中杯 120 EGP / 大杯 150 EGP
  └─ 甜度: 0%, 30%, 50%, 70%, 100%
  └─ 加料: 芝士/果冻/波霸/奶盖 (+20 EGP)
  
- Strawberry Matcha 草莓抹茶
  └─ 中杯 120 EGP / 大杯 150 EGP
  └─ 甜度: 0%, 30%, 50%, 70%, 100%
  └─ 加料: 芝士/果冻/波霸/奶盖 (+20 EGP)
...
```

---

## 🍹 甜度选项

### 标准甜度级别

| 选项 | 百分比 | 说明 |
|------|--------|------|
| Zero | 0% | 无糖 |
| Light | 30% | 微糖 |
| Half | 50% | 半糖 |
| Less | 70% | 少糖 |
| Regular | 100% | 标准甜度 |

### JSON格式

```json
["0", "30", "50", "70", "100"]
```

---

## 🧋 加料选项

### 标准加料（各20 EGP）

1. **Cheese 芝士** - ID: 1
2. **Jelly 果冻** - ID: 2
3. **Boba 波霸** - ID: 3
4. **Cream 奶盖** - ID: 4

### JSON格式

```json
[1, 2, 3, 4]  // 所有加料都可选
[1, 3]        // 只允许芝士和波霸
[]            // 不允许加料
```

---

## 💡 前端实现（待开发）

### 用户下单界面

```
┌─────────────────────────────────┐
│ 🧋 Creamy Matcha 奶香抹茶       │
├─────────────────────────────────┤
│                                  │
│ 选择杯型：                       │
│ ○ Medium 中杯  120 EGP          │
│ ● Large 大杯   150 EGP  ✓       │
│                                  │
│ 选择甜度：                       │
│ ○ 0% 无糖                       │
│ ○ 30% 微糖                      │
│ ● 50% 半糖  ✓                   │
│ ○ 70% 少糖                      │
│ ○ 100% 标准                     │
│                                  │
│ 加料（多选）：                   │
│ ☐ Cheese 芝士     +20 EGP       │
│ ☑ Jelly 果冻      +20 EGP  ✓   │
│ ☑ Boba 波霸       +20 EGP  ✓   │
│ ☐ Cream 奶盖      +20 EGP       │
│                                  │
│ 总价: 190 EGP                   │
│ (150 + 20×2)                    │
│                                  │
│      [加入购物车]                │
└─────────────────────────────────┘
```

### 订单数据结构

```json
{
  "product_id": 15,
  "product_name": "Creamy Matcha 奶香抹茶",
  "size": "Large 大杯",
  "base_price": 150,
  "sugar_level": "50",
  "toppings": [
    { "id": 2, "name": "Jelly 果冻", "price": 20 },
    { "id": 3, "name": "Boba 波霸", "price": 20 }
  ],
  "quantity": 1,
  "total_price": 190
}
```

---

## ⚙️ 管理员功能（待开发）

### 单个菜品配置

```
编辑菜品：Creamy Matcha 奶香抹茶

┌─ 杯型价格 ─────────────────┐
│ Medium 中杯    [120] EGP   │
│ Large 大杯     [150] EGP   │
│ [+ 添加杯型]               │
└───────────────────────────┘

┌─ 可选甜度 ─────────────────┐
│ ☑ 0% 无糖                 │
│ ☑ 30% 微糖                │
│ ☑ 50% 半糖                │
│ ☑ 70% 少糖                │
│ ☑ 100% 标准               │
└───────────────────────────┘

┌─ 可选加料 ─────────────────┐
│ ☑ Cheese 芝士   20 EGP    │
│ ☑ Jelly 果冻    20 EGP    │
│ ☑ Boba 波霸     20 EGP    │
│ ☑ Cream 奶盖    20 EGP    │
└───────────────────────────┘

[保存] [取消]
```

### 批量配置

```
批量设置

选择商品：
☑ 抹茶系列 (4个商品)
☑ 可可系列 (4个商品)
☐ 咖啡系列 (4个商品)

操作：
○ 设置甜度选项
● 设置加料选项
○ 设置杯型

加料选项：
☑ Cheese 芝士
☑ Jelly 果冻
☑ Boba 波霸
☐ Cream 奶盖

[应用到选中商品]
```

---

## 🔌 API更新（需要实现）

### 前端提交订单

```http
POST /api/user/orders
Content-Type: application/json

{
  "items": [
    {
      "product_id": 15,
      "size": "Large 大杯",
      "sugar_level": "50",
      "toppings": [2, 3],
      "quantity": 1
    }
  ]
}
```

### 管理员更新菜品配置

```http
PUT /api/admin/products/:id/config
Content-Type: application/json

{
  "sizes": {
    "Medium 中杯": 120,
    "Large 大杯": 150
  },
  "sugar_levels": ["0", "30", "50", "70", "100"],
  "available_toppings": [1, 2, 3, 4]
}
```

### 批量更新

```http
POST /api/admin/products/batch-update
Content-Type: application/json

{
  "product_ids": [15, 16, 17, 18],
  "updates": {
    "sugar_levels": ["0", "50", "100"],
    "available_toppings": [1, 2, 3]
  }
}
```

---

## ✅ 当前状态

### 已完成 ✅
- [x] 数据库结构设计
- [x] 数据库迁移脚本
- [x] 菜单合并和数据更新
- [x] 加料商品创建

### 待开发 🚧
- [ ] 前端用户下单界面（杯型/甜度/加料选择）
- [ ] 前端购物车显示选项
- [ ] 后端API更新（支持新字段）
- [ ] 管理后台配置界面
- [ ] 批量配置功能

---

## 🚀 快速开始

### 1. 运行迁移和更新

```bash
# 迁移数据库
node db/migrate-products.js

# 更新菜单
node db/update-menu-v2.js

# 重启服务器
npm start
```

### 2. 验证数据

查看数据库中的products表，应该看到新增的字段：
- sizes
- sugar_levels  
- available_toppings

### 3. 当前效果

- 菜单从53个减少到37个（合并了相同名称）
- 每个菜品都配置了杯型、甜度和加料选项
- 数据结构已就绪，等待前端实现

---

## 📝 下一步开发计划

1. **优先级1**：前端用户下单界面
   - 杯型选择组件
   - 甜度选择组件
   - 加料多选组件
   - 价格实时计算

2. **优先级2**：后端API适配
   - 订单创建支持新字段
   - 价格计算逻辑
   - 验证选项有效性

3. **优先级3**：管理后台配置
   - 单个菜品配置界面
   - 批量配置界面
   - 加料商品管理

---

现在数据库结构和数据都已就绪，请运行更新脚本！🎉

