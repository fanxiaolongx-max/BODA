<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åšå®¢ç®¡ç† - DevBlog</title>
  <link rel="stylesheet" href="/css/blog.css">
  <link rel="stylesheet" href="/css/blog-unified.css">
  <style>
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
      background-color: #F9FAFB;
      min-height: 100vh;
    }
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .admin-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid #E5E7EB;
      margin-bottom: 1.5rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      background: transparent;
    }
    .admin-tabs::-webkit-scrollbar {
      display: none;
    }
    .admin-tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: #6B7280;
      transition: all 0.2s;
      white-space: nowrap;
      font-family: var(--font-family-base);
      position: relative;
    }
    .admin-tab:hover {
      color: #9333ea;
    }
    .admin-tab.active {
      color: #9333ea;
      border-bottom-color: #9333ea;
      background: transparent;
    }
    .admin-tab-content {
      display: none;
    }
    .admin-tab-content.active {
      display: block;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: #FFFFFF;
      border-radius: 0;
      overflow: hidden;
    }
    .admin-table th {
      background: #F9FAFB;
      padding: 0.875rem 1rem;
      text-align: left;
      font-weight: 600;
      color: #6B7280;
      font-family: var(--font-family-base);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid #E5E7EB;
    }
    .admin-table td {
      padding: 1rem;
      border-top: 1px solid #F3F4F6;
      background: #FFFFFF;
    }
    .admin-table tbody tr {
      background: #FFFFFF;
    }
    .admin-table tbody tr:hover {
      background: #F9FAFB;
    }
    .admin-table tr.category-header-row {
      background: #FFFFFF !important;
    }
    .admin-table tr.category-header-row:hover {
      background: #F9FAFB !important;
    }
    .admin-table tr.category-post-row {
      background: #FFFFFF !important;
    }
    .admin-table tr.category-post-row:hover {
      background: #F9FAFB !important;
    }
    .admin-table tr.category-header-row + tr {
      border-top: 1px solid #F3F4F6;
    }
    .admin-card {
      background: #FFFFFF;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #E5E7EB;
      margin-bottom: 1.5rem;
    }
    .admin-form {
      background: #FFFFFF;
      padding: 2rem;
      border-radius: 0.5rem;
      border: 1px solid #E5E7EB;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-badge.published {
      background-color: #D1FAE5;
      color: #065F46;
    }
    .status-badge.draft {
      background-color: #F3F4F6;
      color: #6B7280;
    }
    .category-tag {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      font-weight: 500;
      background-color: #F3F4F6;
      color: #374151;
    }
    .admin-form-group {
      margin-bottom: 1.5rem;
    }
    .admin-form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #374151;
    }
    .admin-form-input,
    .admin-form-textarea,
    .admin-form-select {
      width: 100%;
      max-width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      box-sizing: border-box;
    }
    
    /* ç‰¹æ®Šç±»åˆ«è¡¨å•ä¸­çš„è¾“å…¥æ¡†æ ·å¼ */
    .weather-item .admin-form-input,
    .weather-item .admin-form-select,
    .exchange-rate-item .admin-form-input {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    /* ç¡®ä¿gridå¸ƒå±€ä¸­çš„è¾“å…¥æ¡†ä¸ä¼šæº¢å‡º */
    .weather-item > div[style*="grid"],
    .exchange-rate-item > div[style*="grid"] {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .weather-item .admin-form-group,
    .exchange-rate-item .admin-form-group {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .admin-form-textarea {
      min-height: 200px;
      font-family: monospace;
    }
    .admin-form-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* æ–‡ç« è¡¨å•åŠ è½½æç¤ºæ ·å¼ */
    .post-form-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      min-height: 300px;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #9333ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    
    .loading-text {
      color: #6b7280;
      font-size: 0.875rem;
      margin: 0;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    /* åŠ è½½æ—¶éšè—è¡¨å•å†…å®¹ */
    #postForm.loading #postFormContent {
      display: none;
    }
    
    #postForm.loading #postFormLoading {
      display: flex !important;
    }
    .admin-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid #E5E7EB;
      background: #FFFFFF;
    }
    .admin-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .admin-btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.8125rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      font-family: var(--font-family-base);
      font-weight: 500;
      backdrop-filter: blur(10px);
    }
    .admin-btn-edit {
      background: rgba(59, 130, 246, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    .admin-btn-edit:hover {
      background: rgba(37, 99, 235, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
    }
    .admin-btn-delete {
      background: rgba(239, 68, 68, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }
    .admin-btn-delete:hover {
      background: rgba(220, 38, 38, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
    }
    .admin-btn-copy {
      background: rgba(16, 185, 129, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    .admin-btn-copy:hover {
      background: rgba(5, 150, 105, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
    }
    .admin-btn-approve {
      background: rgba(16, 185, 129, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    .admin-btn-approve:hover {
      background: rgba(5, 150, 105, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
    }
    
    /* ç§»åŠ¨ç«¯å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 640px) {
      .admin-container {
        padding: 1rem 0.75rem;
      }
      
      .admin-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .admin-header h1 {
        font-size: 1.5rem;
      }
      
      .admin-tabs {
        width: 100%;
        padding-bottom: 0.5rem;
      }
      
      .admin-tab {
        padding: 0.5rem 1rem;
        font-size: 0.8125rem;
      }
      
      .admin-form {
        padding: 1.5rem 1rem;
      }
      
      .admin-actions {
        flex-direction: column;
      }
      
      .admin-btn-small {
        width: 100%;
        justify-content: center;
      }
      
      .admin-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }
    .markdown-editor {
      min-height: 400px;
    }
    
    /* è§†é¢‘å—æ ·å¼ï¼ˆå…¼å®¹Quillå’ŒWangEditorï¼‰ */
    .ql-video-block,
    .video-block {
      margin: 1rem 0;
      width: 100%;
    }
    
    .ql-video-block video,
    .video-block video {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 1rem 0;
      border-radius: 0.375rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .ql-video-block iframe,
    .video-block iframe {
      max-width: 100%;
      width: 100%;
      height: 400px;
      display: block;
      margin: 1rem 0;
      border-radius: 0.375rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: none;
    }
    
    @media (max-width: 768px) {
      .ql-video-block iframe,
      .video-block iframe {
        height: 250px;
      }
    }
    
    /* SimpleMDE å·¥å…·æ æ ·å¼ä¿®å¤ */
    .editor-toolbar {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem 0.375rem 0 0;
      background: #f9fafb;
      padding: 0.5rem;
    }
    
    .editor-toolbar a {
      color: #374151;
      border: 1px solid transparent;
      border-radius: 0.25rem;
      padding: 0.375rem 0.5rem;
      margin: 0 0.125rem;
      display: inline-block;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .editor-toolbar a:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      color: #111827;
    }
    
    .editor-toolbar a.active {
      background: #9333ea;
      color: white;
      border-color: #9333ea;
    }
    
    .editor-toolbar i.separator {
      display: inline-block;
      width: 0;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      color: transparent;
      text-indent: -10000px;
      margin: 0 0.5rem;
      height: 1.5rem;
    }
    
    .editor-toolbar a.fa {
      font-family: FontAwesome;
      font-style: normal;
      font-weight: normal;
      text-decoration: none;
    }
    
    .CodeMirror {
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.375rem 0.375rem;
      font-size: 0.875rem;
      min-height: 400px;
    }
    
    .editor-preview {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 1rem;
      background: white;
    }
    
    .editor-preview-side {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 1rem;
      background: white;
    }
  </style>
  <!-- WangEditor v5 (ä½¿ç”¨jsdelivr CDNä»¥ç¬¦åˆCSPç­–ç•¥) -->
  <link href="https://cdn.jsdelivr.net/npm/@wangeditor/editor@5.1.23/dist/css/style.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@wangeditor/editor@5.1.23/dist/index.js"></script>
</head>
<body class="blog-page">
  <div class="admin-container">
    <div class="admin-header">
      <div>
        <h1 style="font-size: 2rem; font-weight: bold; color: #111827;">
          åšå®¢ç®¡ç†
        </h1>
        <p style="color: #6b7280; margin-top: 0.5rem;">ç®¡ç†æ–‡ç« ã€åˆ†ç±»ã€æ ‡ç­¾å’Œè¯„è®º</p>
      </div>
      <div>
        <a href="/blog.html" class="blog-btn blog-btn-secondary">è¿”å›åšå®¢</a>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('posts', this)">æ–‡ç« </button>
      <button class="admin-tab" onclick="switchTab('categories', this)">åˆ†ç±»</button>
      <button class="admin-tab" onclick="switchTab('tags', this)">æ ‡ç­¾</button>
      <button class="admin-tab" onclick="switchTab('comments', this)">è¯„è®º</button>
    </div>

    <!-- æ–‡ç« ç®¡ç† -->
    <div id="tab-posts" class="admin-tab-content active">
      <div class="admin-card-header">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0;">æ–‡ç« ç®¡ç†</h2>
        <button class="blog-btn blog-btn-primary" onclick="showPostForm()" style="background-color: #9333ea; border-color: #9333ea;">+ æ–°å»ºæ–‡ç« </button>
      </div>

      <!-- æ–‡ç« è¡¨å• -->
      <div id="postForm" class="admin-form" style="display: none;">
        <!-- åŠ è½½æç¤º -->
        <div id="postFormLoading" class="post-form-loading" style="display: none;">
          <div class="loading-spinner"></div>
          <p class="loading-text">æ­£åœ¨åŠ è½½æ–‡ç« å†…å®¹...</p>
        </div>
        <!-- è¡¨å•å†…å®¹ -->
        <div id="postFormContent">
        <h3 id="postFormTitle">æ–°å»ºæ–‡ç« </h3>
        <form id="postFormElement" onsubmit="savePost(event)">
          <input type="hidden" id="postId">
          <div class="admin-form-group">
            <label class="admin-form-label" for="postName">æ–‡ç« åç§°/æ ‡é¢˜ *</label>
            <input type="text" id="postName" class="admin-form-input" required oninput="syncNameAndTitle()">
            <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">åç§°å’Œæ ‡é¢˜ä¼šè‡ªåŠ¨ä¿æŒåŒæ­¥</p>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postSlug">Slug</label>
            <input type="text" id="postSlug" class="admin-form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postExcerpt">æ‘˜è¦</label>
            <textarea id="postExcerpt" class="admin-form-input" rows="3"></textarea>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postImage">å›¾ç‰‡URL</label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
              <input type="text" id="postImage" class="admin-form-input" style="flex: 1;" placeholder="è¾“å…¥å›¾ç‰‡URLæˆ–ç‚¹å‡»ä¸Šä¼ æŒ‰é’®ä¸Šä¼ å›¾ç‰‡">
              <button type="button" class="blog-btn blog-btn-secondary" onclick="document.getElementById('imageUploadInput').click()" style="white-space: nowrap;">
                <i class="fa fa-upload" style="margin-right: 0.25rem;"></i>ä¸Šä¼ å›¾ç‰‡
              </button>
            </div>
            <input type="file" id="imageUploadInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <div id="imageUploadProgress" style="display: none; margin-top: 0.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="flex: 1; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                  <div id="imageUploadProgressBar" style="height: 100%; background: #9333ea; width: 0%; transition: width 0.3s;"></div>
                </div>
                <span id="imageUploadStatus" style="font-size: 0.875rem; color: #6b7280;">ä¸Šä¼ ä¸­...</span>
              </div>
            </div>
            <div id="imagePreview" style="margin-top: 0.5rem; display: none;">
              <img id="imagePreviewImg" src="" alt="é¢„è§ˆ" style="max-width: 200px; max-height: 200px; border-radius: 0.375rem; border: 1px solid #d1d5db;">
            </div>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postApiName">API/åˆ†ç±» *</label>
            <select id="postApiName" class="admin-form-select" required onchange="onApiNameChange()">
              <option value="">è¯·é€‰æ‹©APIï¼ˆåˆ†ç±»ï¼‰</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">é€‰æ‹©æ–‡ç« æ‰€å±çš„APIï¼ŒAPIåç§°å°†ä½œä¸ºæ–‡ç« åˆ†ç±»</p>
          </div>
          <div class="admin-form-group" id="fieldMappingInfo" style="display: none;">
            <div class="text-sm text-blue-600">
              <p>æ­¤APIå·²é…ç½®å­—æ®µæ˜ å°„ï¼Œæ–‡ç« å°†æ ¹æ®æ˜ å°„è§„åˆ™ä¿å­˜åˆ°å¯¹åº”å­—æ®µ</p>
            </div>
          </div>
          
          <!-- ç‰¹æ®Šç±»åˆ«å®šåˆ¶åŒ–è¡¨å• -->
          <!-- ç¿»è¯‘å¡ç‰‡ (translation) -->
          <div id="specialForm-translation" class="admin-form-group" style="display: none;">
            <h4 style="color: #9333ea; margin-bottom: 1rem;">ç¿»è¯‘å¡ç‰‡ç¼–è¾‘</h4>
            <div class="admin-form-group" style="max-width: 500px;">
              <label class="admin-form-label" for="translationChinese">ä¸­æ–‡ *</label>
              <input type="text" id="translationChinese" class="admin-form-input" placeholder="è¾“å…¥ä¸­æ–‡" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 500px;">
              <label class="admin-form-label" for="translationArabic">é˜¿æ‹‰ä¼¯æ–‡ *</label>
              <input type="text" id="translationArabic" class="admin-form-input" placeholder="è¾“å…¥é˜¿æ‹‰ä¼¯æ–‡" dir="rtl" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="translationCategory">åˆ†ç±»</label>
              <input type="text" id="translationCategory" class="admin-form-input" placeholder="å¦‚ï¼šé—®å€™ã€ç¤¼è²Œã€è´­ç‰©ç­‰" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- å¤©æ°”è·¯å†µ (weather) -->
          <div id="specialForm-weather" class="admin-form-group" style="display: none;">
            <h4 style="color: #3b82f6; margin-bottom: 1rem;">å¤©æ°”è·¯å†µç¼–è¾‘</h4>
            
            <!-- Global Alert å…¨å±€é¢„è­¦ -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <h5 style="color: #3b82f6; margin-bottom: 0.75rem;">å…¨å±€é¢„è­¦ (Global Alert)</h5>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="weatherGlobalAlertLevel">é¢„è­¦çº§åˆ«</label>
              <select id="weatherGlobalAlertLevel" class="admin-form-select" style="width: 100%; max-width: 100%; box-sizing: border-box;">
                <option value="low">ä½ (low)</option>
                <option value="medium">ä¸­ (medium)</option>
                <option value="high">é«˜ (high)</option>
              </select>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="weatherGlobalAlertMessage">é¢„è­¦æ¶ˆæ¯ *</label>
              <textarea id="weatherGlobalAlertMessage" class="admin-form-input" rows="3" placeholder="è¾“å…¥é¢„è­¦æ¶ˆæ¯" style="width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
            </div>
            </div>
            
            <!-- Attractions æ™¯ç‚¹å¤©æ°” -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #3b82f6; margin: 0;">æ™¯ç‚¹å¤©æ°” (Attractions)</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addWeatherAttraction()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>æ·»åŠ æ™¯ç‚¹
                </button>
              </div>
              <div id="weatherAttractionsList"></div>
            </div>
            
            <!-- Traffic è·¯å†µä¿¡æ¯ -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #3b82f6; margin: 0;">è·¯å†µä¿¡æ¯ (Traffic)</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addWeatherTraffic()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>æ·»åŠ è·¯å†µ
                </button>
              </div>
              <div id="weatherTrafficList"></div>
            </div>
          </div>
          
          <!-- æ±‡ç‡è½¬æ¢ (exchange-rate) -->
          <div id="specialForm-exchange-rate" class="admin-form-group" style="display: none;">
            <h4 style="color: #10b981; margin-bottom: 1rem;">æ±‡ç‡è½¬æ¢ç¼–è¾‘</h4>
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #10b981; margin: 0;">æ±‡ç‡åˆ—è¡¨</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addExchangeRate()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>æ·»åŠ æ±‡ç‡
                </button>
              </div>
              <div id="exchangeRatesList"></div>
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="exchangeUpdateTime">æ›´æ–°æ—¶é—´</label>
              <input type="datetime-local" id="exchangeUpdateTime" class="admin-form-input" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- äºŒæ‰‹å¸‚åœº (second-hand) ç‰¹æ®Šå­—æ®µ -->
          <div id="specialForm-second-hand" class="admin-form-group" style="display: none;">
            <h4 style="color: #f59e0b; margin-bottom: 1rem;">äºŒæ‰‹å¸‚åœºç‰¹æ®Šå­—æ®µ</h4>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="secondHandPrice">ä»·æ ¼ *</label>
              <input type="text" id="secondHandPrice" class="admin-form-input" placeholder="å¦‚ï¼š500ã€1000ç­‰" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="secondHandPhone">è”ç³»æ–¹å¼ *</label>
              <input type="text" id="secondHandPhone" name="secondHandPhone" class="admin-form-input" placeholder="å¦‚ï¼š+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="secondHandAddress">åœ°å€ *</label>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="secondHandAddress" name="secondHandAddress" class="admin-form-input" placeholder="å¦‚ï¼šå¼€ç½—å¸‚ä¸­å¿ƒï¼ŒHeliopolis åŒº" style="flex: 1; width: 100%; max-width: 100%; box-sizing: border-box;" required>
                <button type="button" id="secondHandAddressSearchBtn" class="blog-btn blog-btn-secondary" onclick="openMapPicker('second-hand')" style="white-space: nowrap; padding: 0.75rem 1rem;">
                  <span style="margin-right: 0.25rem;">ğŸ—ºï¸</span>åœ°å›¾é€‰ç‚¹
                </button>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="openLinkParser('second-hand')" style="white-space: nowrap; padding: 0.75rem 1rem;" title="ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è§£æ">
                  <span style="margin-right: 0.25rem;">ğŸ”—</span>è§£æé“¾æ¥
                </button>
              </div>
              <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">ç‚¹å‡»"åœ°å›¾é€‰ç‚¹"åœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®ï¼Œæˆ–ç‚¹å‡»"è§£æé“¾æ¥"ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è·å–ä½ç½®</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 100%;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="secondHandLatitude">çº¬åº¦ *</label>
                <input type="number" step="any" id="secondHandLatitude" name="secondHandLatitude" class="admin-form-input" placeholder="å¦‚ï¼š30.0444" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="secondHandLongitude">ç»åº¦ *</label>
                <input type="number" step="any" id="secondHandLongitude" name="secondHandLongitude" class="admin-form-input" placeholder="å¦‚ï¼š31.2357" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
            </div>
          </div>
          
          <!-- ç§Ÿæˆ¿é…’åº— (rentals) ç‰¹æ®Šå­—æ®µ -->
          <div id="specialForm-rentals" class="admin-form-group" style="display: none;">
            <h4 style="color: #8b5cf6; margin-bottom: 1rem;">ç§Ÿæˆ¿é…’åº—ç‰¹æ®Šå­—æ®µ</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; width: 100%; max-width: 100%; box-sizing: border-box;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsPrice">ä»·æ ¼ *</label>
                <input type="text" id="rentalsPrice" class="admin-form-input" placeholder="å¦‚ï¼š3500" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsRooms">æˆ¿é—´æ•° *</label>
                <input type="text" id="rentalsRooms" class="admin-form-input" placeholder="å¦‚ï¼š2" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsArea">é¢ç§¯ *</label>
                <input type="text" id="rentalsArea" class="admin-form-input" placeholder="å¦‚ï¼š80" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsViews">æµè§ˆæ¬¡æ•°</label>
                <input type="number" id="rentalsViews" class="admin-form-input" placeholder="å¦‚ï¼š1" min="0" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="rentalsPhone">è”ç³»æ–¹å¼ *</label>
              <input type="text" id="rentalsPhone" name="rentalsPhone" class="admin-form-input" placeholder="å¦‚ï¼š+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="rentalsAddress">åœ°å€ *</label>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="rentalsAddress" name="rentalsAddress" class="admin-form-input" placeholder="å¦‚ï¼šå¼€ç½—å¸‚ä¸­å¿ƒï¼ŒHeliopolis åŒº" style="flex: 1; width: 100%; max-width: 100%; box-sizing: border-box;" required>
                <button type="button" id="rentalsAddressSearchBtn" class="blog-btn blog-btn-secondary" onclick="openMapPicker('rentals')" style="white-space: nowrap; padding: 0.75rem 1rem;">
                  <span style="margin-right: 0.25rem;">ğŸ—ºï¸</span>åœ°å›¾é€‰ç‚¹
                </button>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="openLinkParser('rentals')" style="white-space: nowrap; padding: 0.75rem 1rem;" title="ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è§£æ">
                  <span style="margin-right: 0.25rem;">ğŸ”—</span>è§£æé“¾æ¥
                </button>
              </div>
              <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">ç‚¹å‡»"åœ°å›¾é€‰ç‚¹"åœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®ï¼Œæˆ–ç‚¹å‡»"è§£æé“¾æ¥"ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è·å–ä½ç½®</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 100%;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsLatitude">çº¬åº¦ *</label>
                <input type="number" step="any" id="rentalsLatitude" name="rentalsLatitude" class="admin-form-input" placeholder="å¦‚ï¼š30.0444" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsLongitude">ç»åº¦ *</label>
                <input type="number" step="any" id="rentalsLongitude" name="rentalsLongitude" class="admin-form-input" placeholder="å¦‚ï¼š31.2357" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
            </div>
          </div>
          
          <!-- é€šç”¨ä½ç½®å­—æ®µï¼ˆç”¨äºå…¶ä»–éœ€è¦ä½ç½®çš„åˆ†ç±»ï¼‰ -->
          <div id="commonLocationFields" class="admin-form-group" style="display: none;">
            <h4 style="color: #059669; margin-bottom: 1rem;">ä½ç½®ä¿¡æ¯</h4>
            <div class="admin-form-group" id="commonPhoneField" style="max-width: 300px; display: none;">
              <label class="admin-form-label" id="commonPhoneLabel" for="commonPhone">è”ç³»æ–¹å¼ *</label>
              <input type="text" id="commonPhone" name="commonPhone" class="admin-form-input" placeholder="å¦‚ï¼š+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" id="commonAddressLabel" for="commonAddress">åœ°å€ *</label>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="commonAddress" name="commonAddress" class="admin-form-input" placeholder="å¦‚ï¼šå¼€ç½—å¸‚ä¸­å¿ƒï¼ŒHeliopolis åŒº" style="flex: 1; width: 100%; max-width: 100%; box-sizing: border-box;" required>
                <button type="button" id="commonAddressSearchBtn" class="blog-btn blog-btn-secondary" onclick="openMapPicker('common')" style="white-space: nowrap; padding: 0.75rem 1rem;">
                  <span style="margin-right: 0.25rem;">ğŸ—ºï¸</span>åœ°å›¾é€‰ç‚¹
                </button>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="openLinkParser('common')" style="white-space: nowrap; padding: 0.75rem 1rem;" title="ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è§£æ">
                  <span style="margin-right: 0.25rem;">ğŸ”—</span>è§£æé“¾æ¥
                </button>
              </div>
              <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">ç‚¹å‡»"åœ°å›¾é€‰ç‚¹"åœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®ï¼Œæˆ–ç‚¹å‡»"è§£æé“¾æ¥"ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è·å–ä½ç½®</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 100%;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" id="commonLatitudeLabel" for="commonLatitude">çº¬åº¦ *</label>
                <input type="number" step="any" id="commonLatitude" name="commonLatitude" class="admin-form-input" placeholder="å¦‚ï¼š30.0444" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" id="commonLongitudeLabel" for="commonLongitude">ç»åº¦ *</label>
                <input type="number" step="any" id="commonLongitude" name="commonLongitude" class="admin-form-input" placeholder="å¦‚ï¼š31.2357" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label" for="postCategory">åˆ†ç±»/æ ‡ç­¾ *</label>
            <input type="text" id="postCategory" class="admin-form-input" placeholder="æ–‡ç« åˆ†ç±»ï¼ˆä½œä¸ºæ ‡ç­¾ä½¿ç”¨ï¼‰" required>
            <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">æ­¤åˆ†ç±»ç”¨äºåœ¨åšå®¢é¡µé¢ä½œä¸ºæ ‡ç­¾å±•ç¤º</p>
          </div>
          <div class="admin-form-group" style="display: none;">
            <label class="admin-form-label" for="postTags">æ ‡ç­¾ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ä¸Šé¢çš„åˆ†ç±»å­—æ®µï¼‰</label>
            <input type="text" id="postTags" class="admin-form-input" placeholder="æ ‡ç­¾1, æ ‡ç­¾2" disabled>
          </div>
          <div class="admin-form-group" id="normalContentEditor">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <label class="admin-form-label" for="postContent" style="margin-bottom: 0;">å†…å®¹ *</label>
            </div>
            <div id="htmlEditorContainer">
              <div id="postHtmlContent" style="min-height: 400px;"></div>
            </div>
          </div>
          <div class="admin-form-group">
            <div class="admin-form-checkbox">
              <input type="checkbox" id="postPublished">
              <label for="postPublished">å‘å¸ƒ</label>
            </div>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">ä¿å­˜</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hidePostForm()">å–æ¶ˆ</button>
          </div>
        </form>
        </div>
      </div>

      <!-- æ–‡ç« åˆ—è¡¨ -->
      <div class="admin-card">
        <div style="overflow-x: auto;">
          <table class="admin-table">
          <thead>
            <tr>
              <th>æ ‡é¢˜</th>
              <th>åˆ†ç±»</th>
              <th>çŠ¶æ€</th>
              <th>é˜…è¯»é‡</th>
              <th>æ—¥æœŸ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="postsTableBody">
            <tr><td colspan="6" class="blog-loading">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
        </div>
      </div>
    </div>

    <!-- åˆ†ç±»ç®¡ç† -->
    <div id="tab-categories" class="admin-tab-content">
      <div class="admin-card-header">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0;">åˆ†ç±»ç®¡ç†</h2>
        <button class="blog-btn blog-btn-primary" onclick="showCategoryForm()" style="background-color: #9333ea; border-color: #9333ea;">+ æ–°å»ºåˆ†ç±»</button>
      </div>

      <div id="categoryForm" class="admin-form" style="display: none;">
        <h3 id="categoryFormTitle">æ–°å»ºåˆ†ç±»</h3>
        <form id="categoryFormElement" onsubmit="saveCategory(event)">
          <input type="hidden" id="categoryId">
          <div class="admin-form-group">
            <label class="admin-form-label" for="categoryName">åˆ†ç±»åç§° *</label>
            <input type="text" id="categoryName" class="admin-form-input" required>
            <p class="text-xs text-gray-500 mt-1">æ­¤åç§°å°†æ˜¾ç¤ºåœ¨åšå®¢åˆ†ç±»åˆ—è¡¨ä¸­</p>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="categoryPath">åˆ†ç±»è·¯å¾„/æè¿° *</label>
            <input type="text" id="categoryPath" class="admin-form-input" required placeholder="/category-name">
            <p class="text-xs text-gray-500 mt-1">è·¯å¾„å¿…é¡»ä»¥ / å¼€å¤´ï¼Œå°†ä½œä¸ºåˆ†ç±»çš„æè¿°ä¿¡æ¯</p>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">ä¿å­˜</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hideCategoryForm()">å–æ¶ˆ</button>
          </div>
        </form>
      </div>

      <div class="admin-card">
        <div style="overflow-x: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>åç§°</th>
                <th>è·¯å¾„/æè¿°</th>
                <th>æ–‡ç« æ•°</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="categoriesTableBody">
              <tr><td colspan="4" class="blog-loading">åŠ è½½ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ ‡ç­¾ç®¡ç† -->
    <div id="tab-tags" class="admin-tab-content">
      <div class="admin-card-header">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0;">æ ‡ç­¾ç®¡ç†</h2>
        <button class="blog-btn blog-btn-primary" onclick="showTagForm()" style="background-color: #9333ea; border-color: #9333ea;">+ æ–°å»ºæ ‡ç­¾</button>
      </div>

      <div id="tagForm" class="admin-form" style="display: none;">
        <h3>æ–°å»ºæ ‡ç­¾</h3>
        <form onsubmit="saveTag(event)">
          <div class="admin-form-group">
            <label class="admin-form-label" for="tagName">æ ‡ç­¾åç§° *</label>
            <input type="text" id="tagName" class="admin-form-input" required>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">ä¿å­˜</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hideTagForm()">å–æ¶ˆ</button>
          </div>
        </form>
      </div>

      <div class="admin-card">
        <div style="overflow-x: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>åç§°</th>
                <th>æ–‡ç« æ•°</th>
              </tr>
            </thead>
            <tbody id="tagsTableBody">
              <tr><td colspan="2" class="blog-loading">åŠ è½½ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- è¯„è®ºç®¡ç† -->
    <div id="tab-comments" class="admin-tab-content">
      <div class="admin-card-header">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0;">è¯„è®ºç®¡ç†</h2>
      </div>
      <div class="admin-card">
        <div style="overflow-x: auto;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>æ–‡ç« </th>
                <th>ä½œè€…</th>
                <th>å†…å®¹</th>
                <th>çŠ¶æ€</th>
                <th>æ—¥æœŸ</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="commentsTableBody">
              <tr><td colspan="6" class="blog-loading">åŠ è½½ä¸­...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="/utils/blog.js"></script>
  <script>
    const BLOG_ADMIN_API = '/api/blog-admin';
    let wangEditor = null;
    let availableApis = [];
    let allPostsData = []; // å­˜å‚¨æ‰€æœ‰æ–‡ç« æ•°æ®
    let expandedCategories = new Set(); // å­˜å‚¨å·²å±•å¼€çš„åˆ†ç±»
    let exchangeRatesCounter = 0; // æ±‡ç‡è½¬æ¢è®¡æ•°å™¨

    // åŠ è½½APIåˆ—è¡¨
    async function loadApis() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/apis`);
        if (response && response.success) {
          availableApis = response.data || [];
          updateApiSelect();
        }
      } catch (error) {
        console.error('åŠ è½½APIåˆ—è¡¨å¤±è´¥:', error);
      }
    }

    // æ›´æ–°APIé€‰æ‹©ä¸‹æ‹‰æ¡†
    function updateApiSelect() {
      const select = document.getElementById('postApiName');
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">è¯·é€‰æ‹©APIï¼ˆåˆ†ç±»ï¼‰</option>';
      
      availableApis.forEach(api => {
        const option = document.createElement('option');
        option.value = api.name;
        option.textContent = `${api.name} (${api.path})`;
        select.appendChild(option);
      });
      
      if (currentValue) {
        select.value = currentValue;
      }
    }

    // ç‰¹æ®Šç±»åˆ«å®šä¹‰
    const SPECIAL_CATEGORIES = {
      'weather': {
        name: 'weather',
        displayName: 'å¤©æ°”è·¯å†µ',
      },
      'second-hand': {
        name: 'second-hand',
        displayName: 'äºŒæ‰‹å¸‚åœº',
      },
      'rentals': {
        name: 'rentals',
        displayName: 'ç§Ÿæˆ¿é…’åº—',
        color: '#3b82f6',
        fields: ['city', 'temperature', 'condition', 'traffic', 'humidity', 'wind']
      },
      'exchange-rate': {
        name: 'exchange-rate',
        displayName: 'æ±‡ç‡è½¬æ¢',
        color: '#10b981',
        fields: ['fromCurrency', 'toCurrency', 'rate', 'updateTime']
      },
      'translation': {
        name: 'translation',
        displayName: 'ç¿»è¯‘å¡ç‰‡',
        color: '#9333ea',
        fields: ['chinese', 'arabic', 'category']
      }
    };
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»åˆ«
    function isSpecialCategory(apiName) {
      if (!apiName) return null;
      // æ£€æŸ¥APIåç§°æˆ–è·¯å¾„æ˜¯å¦åŒ¹é…
      const lowerName = apiName.toLowerCase();
      if (lowerName === 'weather' || lowerName.includes('weather')) {
        return 'weather';
      }
      if (lowerName === 'exchange-rate' || lowerName === 'exchangerate' || lowerName.includes('exchange')) {
        return 'exchange-rate';
      }
      if (lowerName === 'translation' || lowerName.includes('translation')) {
        return 'translation';
      }
      // æ£€æµ‹äºŒæ‰‹å¸‚åœº
      if (lowerName === 'second-hand' || lowerName.includes('second-hand') || lowerName.includes('secondhand') || lowerName.includes('äºŒæ‰‹')) {
        return 'second-hand';
      }
      // æ£€æµ‹ç§Ÿæˆ¿é…’åº—
      if (lowerName === 'rentals' || lowerName.includes('rental') || lowerName.includes('ç§Ÿæˆ¿') || lowerName.includes('é…’åº—')) {
        return 'rentals';
      }
      return null;
    }
    
    // APIé€‰æ‹©æ”¹å˜æ—¶çš„å¤„ç†
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ä½ç½®ä¿¡æ¯ï¼ˆlatitude, longitude, addressï¼‰
    function needsLocationFields(apiName) {
      // æ‰€æœ‰åˆ†ç±»éƒ½æ”¯æŒä½ç½®å­—æ®µï¼ˆå¯é€‰ï¼‰
      if (!apiName) return false;
      return true;
    }

    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”µè¯å­—æ®µï¼ˆæ‰€æœ‰åˆ†ç±»éƒ½æ”¯æŒç”µè¯å­—æ®µï¼Œä½œä¸ºå¯é€‰ï¼‰
    function needsPhoneField(apiName) {
      // æ‰€æœ‰åˆ†ç±»éƒ½æ”¯æŒç”µè¯å­—æ®µï¼ˆå¯é€‰ï¼‰
      if (!apiName) return false;
      return true;
    }

    // æ£€æŸ¥ä½ç½®å­—æ®µæ˜¯å¦ä¸ºå¿…å¡«ï¼ˆå¿…å¡«ï¼šå¯»å‘³ä¸­å›½ã€å¸¸ç”¨å¯¼èˆªã€æ‰“å¡åœ°ã€ç§Ÿæˆ¿ã€äºŒæ‰‹é›†å¸‚ã€çƒ­é—¨æ´»åŠ¨ï¼›å¯é€‰ï¼šç­¾è¯æŒ‡å—ã€æ”»ç•¥æŒ‡å—ã€å°¼ç½—æ²³åº”ç”¨ã€é˜²éª—æŒ‡å—ï¼‰
    function isLocationRequired(apiName) {
      if (!apiName) return false;
      const lowerName = apiName.toLowerCase();
      // å¿…å¡«ä½ç½®å­—æ®µçš„åˆ†ç±»
      return lowerName.includes('chinese-food') || 
             lowerName.includes('å¯»å‘³') || 
             lowerName.includes('location-list') ||
             lowerName.includes('å¯¼èˆª') || 
             lowerName.includes('hot-spots') ||
             lowerName.includes('æ‰“å¡') ||
             lowerName.includes('rental-list') ||
             lowerName.includes('rentals') || 
             lowerName.includes('ç§Ÿæˆ¿') || 
             lowerName.includes('é…’åº—') ||
             lowerName.includes('second-hand') || 
             lowerName.includes('äºŒæ‰‹') ||
             lowerName.includes('hot-activity') ||
             (lowerName.includes('æ´»åŠ¨') && !lowerName.includes('ç­¾è¯') && !lowerName.includes('æ”»ç•¥') && !lowerName.includes('é˜²éª—'));
    }

    async function onApiNameChange() {
      const apiName = document.getElementById('postApiName').value;
      const mappingInfo = document.getElementById('fieldMappingInfo');
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»åˆ«
      const specialType = isSpecialCategory(apiName);
      const needsLocation = needsLocationFields(apiName);
      
      // éšè—æ‰€æœ‰ç‰¹æ®Šè¡¨å•
      document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
        el.style.display = 'none';
      });

      // æ˜¾ç¤º/éšè—é€šç”¨ä½ç½®å­—æ®µ
      const commonLocationFields = document.getElementById('commonLocationFields');
      if (commonLocationFields) {
        // å¦‚æœå·²ç»åœ¨ç‰¹æ®Šè¡¨å•ä¸­æ˜¾ç¤ºäº†ä½ç½®å­—æ®µï¼ˆå¦‚rentalsæˆ–second-handï¼‰ï¼Œå°±ä¸æ˜¾ç¤ºé€šç”¨ä½ç½®å­—æ®µ
        const hasLocationInSpecialForm = (specialType === 'rentals' || specialType === 'second-hand');
        // æ‰€æœ‰åˆ†ç±»éƒ½æ˜¾ç¤ºä½ç½®å­—æ®µï¼ˆé™¤äº†ç‰¹æ®Šè¡¨å•çš„åˆ†ç±»ï¼‰
        const shouldShow = needsLocation && !hasLocationInSpecialForm;
        commonLocationFields.style.display = shouldShow ? 'block' : 'none';
        
        // æ˜¾ç¤º/éšè—ç”µè¯å­—æ®µï¼ˆæ‰€æœ‰åˆ†ç±»éƒ½æ”¯æŒï¼‰
        const needsPhone = needsPhoneField(apiName);
        const hasPhoneInSpecialForm = (specialType === 'rentals' || specialType === 'second-hand');
        // æ‰€æœ‰åˆ†ç±»éƒ½æ˜¾ç¤ºç”µè¯å­—æ®µï¼ˆé™¤äº†ç‰¹æ®Šè¡¨å•çš„åˆ†ç±»ï¼‰
        const shouldShowPhone = needsPhone && !hasPhoneInSpecialForm && shouldShow;
        
        // åˆ¤æ–­ç”µè¯å­—æ®µæ˜¯å¦ä¸ºå¿…å¡«ï¼ˆå¯»å‘³ä¸­å›½å¿…å¡«ï¼Œé˜²éª—æŒ‡å—ç­‰å¯é€‰ï¼‰
        const lowerName = apiName.toLowerCase();
        const isPhoneRequired = lowerName.includes('chinese-food') || lowerName.includes('å¯»å‘³');
        
        const commonPhoneField = document.getElementById('commonPhoneField');
        const commonPhoneInput = document.getElementById('commonPhone');
        const commonPhoneLabel = document.getElementById('commonPhoneLabel');
        if (commonPhoneField) {
          commonPhoneField.style.display = shouldShowPhone ? 'block' : 'none';
        }
        if (commonPhoneInput) {
          commonPhoneInput.required = shouldShowPhone && isPhoneRequired;
          if (!shouldShowPhone || !isPhoneRequired) commonPhoneInput.removeAttribute('required');
        }
        // æ›´æ–°ç”µè¯å­—æ®µæ ‡ç­¾
        if (commonPhoneLabel) {
          commonPhoneLabel.textContent = isPhoneRequired ? 'è”ç³»æ–¹å¼ *' : 'è”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼‰';
        }
        
        // åŠ¨æ€è®¾ç½®å¿…å¡«å±æ€§ï¼ˆåªåœ¨å­—æ®µå¯è§ä¸”ä¸ºå¿…å¡«åˆ†ç±»æ—¶è®¾ç½®ï¼‰
        const isRequired = isLocationRequired(apiName);
        const addressInput = document.getElementById('commonAddress');
        const latInput = document.getElementById('commonLatitude');
        const lngInput = document.getElementById('commonLongitude');
        const addressLabel = document.getElementById('commonAddressLabel');
        const latLabel = document.getElementById('commonLatitudeLabel');
        const lngLabel = document.getElementById('commonLongitudeLabel');
        
        if (addressInput) {
          addressInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) addressInput.removeAttribute('required');
        }
        // æ›´æ–°åœ°å€å­—æ®µæ ‡ç­¾
        if (addressLabel) {
          addressLabel.textContent = isRequired ? 'åœ°å€ *' : 'åœ°å€ï¼ˆå¯é€‰ï¼‰';
        }
        
        if (latInput) {
          latInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) latInput.removeAttribute('required');
        }
        // æ›´æ–°çº¬åº¦å­—æ®µæ ‡ç­¾
        if (latLabel) {
          latLabel.textContent = isRequired ? 'çº¬åº¦ *' : 'çº¬åº¦ï¼ˆå¯é€‰ï¼‰';
        }
        
        if (lngInput) {
          lngInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) lngInput.removeAttribute('required');
        }
        // æ›´æ–°ç»åº¦å­—æ®µæ ‡ç­¾
        if (lngLabel) {
          lngLabel.textContent = isRequired ? 'ç»åº¦ *' : 'ç»åº¦ï¼ˆå¯é€‰ï¼‰';
        }
      }
      
      // åŠ¨æ€è®¾ç½®ç‰¹æ®Šè¡¨å•ä¸­å­—æ®µçš„å¿…å¡«å±æ€§
      // å…ˆç§»é™¤æ‰€æœ‰ç‰¹æ®Šè¡¨å•å­—æ®µçš„å¿…å¡«å±æ€§ï¼Œç„¶åæ ¹æ®å½“å‰ç±»å‹é‡æ–°è®¾ç½®
      const secondHandPhone = document.getElementById('secondHandPhone');
      const secondHandAddress = document.getElementById('secondHandAddress');
      const secondHandLat = document.getElementById('secondHandLatitude');
      const secondHandLng = document.getElementById('secondHandLongitude');
      const rentalsPhone = document.getElementById('rentalsPhone');
      const rentalsAddress = document.getElementById('rentalsAddress');
      const rentalsLat = document.getElementById('rentalsLatitude');
      const rentalsLng = document.getElementById('rentalsLongitude');
      
      // å…ˆç§»é™¤æ‰€æœ‰å¿…å¡«å±æ€§
      [secondHandPhone, secondHandAddress, secondHandLat, secondHandLng, 
       rentalsPhone, rentalsAddress, rentalsLat, rentalsLng].forEach(input => {
        if (input) {
          input.removeAttribute('required');
          // ç¡®ä¿å­—æ®µå¯è§æ€§æ£€æŸ¥ï¼šå¦‚æœçˆ¶å®¹å™¨éšè—ï¼Œä¹Ÿç§»é™¤required
          const parentForm = input.closest('[id^="specialForm-"]');
          if (parentForm && parentForm.style.display === 'none') {
            input.removeAttribute('required');
          }
        }
      });
      
      // æ ¹æ®å½“å‰ç±»å‹è®¾ç½®å¿…å¡«å±æ€§ï¼ˆåªåœ¨è¡¨å•å¯è§æ—¶ï¼‰
      if (specialType === 'second-hand') {
        const secondHandForm = document.getElementById('specialForm-second-hand');
        if (secondHandForm && secondHandForm.style.display !== 'none') {
          if (secondHandPhone) secondHandPhone.required = true;
          if (secondHandAddress) secondHandAddress.required = true;
          if (secondHandLat) secondHandLat.required = true;
          if (secondHandLng) secondHandLng.required = true;
        }
      } else if (specialType === 'rentals') {
        const rentalsForm = document.getElementById('specialForm-rentals');
        if (rentalsForm && rentalsForm.style.display !== 'none') {
          if (rentalsPhone) rentalsPhone.required = true;
          if (rentalsAddress) rentalsAddress.required = true;
          if (rentalsLat) rentalsLat.required = true;
          if (rentalsLng) rentalsLng.required = true;
        }
      }
      
      // éšè—/æ˜¾ç¤ºæ™®é€šå†…å®¹ç¼–è¾‘å™¨
      const normalEditor = document.getElementById('normalContentEditor');
      if (normalEditor) {
        normalEditor.style.display = specialType ? 'none' : 'block';
      }
      
      if (!apiName) {
        mappingInfo.style.display = 'none';
        return;
      }
      
      // å¦‚æœæ˜¯ç‰¹æ®Šç±»åˆ«ï¼Œæ˜¾ç¤ºå¯¹åº”çš„è¡¨å•
      if (specialType) {
        const specialForm = document.getElementById(`specialForm-${specialType}`);
        if (specialForm) {
          specialForm.style.display = 'block';
        }
        // å¯¹äºsecond-handå’Œrentalsï¼Œä¹Ÿæ˜¾ç¤ºæ ‡å‡†å†…å®¹ç¼–è¾‘å™¨ï¼ˆå› ä¸ºå®ƒä»¬éœ€è¦ç¼–è¾‘æ™®é€šå†…å®¹ï¼‰
        const normalContentEditor = document.getElementById('normalContentEditor');
        if (specialType === 'second-hand' || specialType === 'rentals') {
          if (normalContentEditor) {
            normalContentEditor.style.display = 'block';
          }
        } else {
          if (normalContentEditor) {
            normalContentEditor.style.display = 'none';
          }
        }
        mappingInfo.style.display = 'none';
        return;
      }
      
      // æ™®é€šç±»åˆ«ï¼Œæ£€æŸ¥å­—æ®µæ˜ å°„
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/apis/${encodeURIComponent(apiName)}/field-mapping`);
        if (response && response.success && response.data) {
          mappingInfo.style.display = 'block';
          mappingInfo.innerHTML = `
            <div class="text-sm text-blue-600">
              <p>æ­¤APIå·²é…ç½®å­—æ®µæ˜ å°„ï¼Œæ–‡ç« å°†æ ¹æ®æ˜ å°„è§„åˆ™ä¿å­˜åˆ°å¯¹åº”å­—æ®µ</p>
              <details class="mt-2">
                <summary class="cursor-pointer text-xs">æŸ¥çœ‹å­—æ®µæ˜ å°„</summary>
                <pre class="text-xs mt-2 p-2 bg-gray-100 rounded">${JSON.stringify(response.data, null, 2)}</pre>
              </details>
            </div>
          `;
        } else {
          mappingInfo.style.display = 'none';
        }
      } catch (error) {
        mappingInfo.style.display = 'none';
      }
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName, tabButton = null) {
      // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
      document.querySelectorAll('.admin-tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
      const tabContent = document.getElementById(`tab-${tabName}`);
      if (tabContent) {
        tabContent.classList.add('active');
      }

      // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
      if (tabButton) {
        tabButton.classList.add('active');
      } else {
        // å¦‚æœæ²¡æœ‰æä¾›æŒ‰é’®ï¼Œé€šè¿‡æŸ¥æ‰¾åŒ…å«å¯¹åº”æ–‡æœ¬çš„æŒ‰é’®æ¥æ¿€æ´»
        const buttons = document.querySelectorAll('.admin-tab');
        buttons.forEach(btn => {
          const text = btn.textContent.trim();
          if ((tabName === 'posts' && text === 'æ–‡ç« ') ||
              (tabName === 'categories' && text === 'åˆ†ç±»') ||
              (tabName === 'tags' && text === 'æ ‡ç­¾') ||
              (tabName === 'comments' && text === 'è¯„è®º')) {
            btn.classList.add('active');
          }
        });
      }

      // åŠ è½½å¯¹åº”æ•°æ®
      if (tabName === 'posts') {
        loadPosts();
        loadApis(); // åŠ è½½APIåˆ—è¡¨
      } else if (tabName === 'categories') {
        loadCategories();
      } else if (tabName === 'tags') {
        loadTags();
      } else if (tabName === 'comments') {
        loadComments();
      }
    }

    // APIè¯·æ±‚å°è£…ï¼ˆå¸¦è®¤è¯ï¼‰
    async function adminApiRequest(url, options = {}) {
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          credentials: 'include'
        });

        if (response.status === 401) {
          showToast('è¯·å…ˆç™»å½•', 'error');
          window.location.href = '/admin.html';
          return null;
        }

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
        }
        return data;
      } catch (error) {
        console.error('APIè¯·æ±‚å¤±è´¥:', error);
        showToast('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
        throw error;
      }
    }

    // åŠ è½½æ–‡ç« åˆ—è¡¨
    async function loadPosts(resetExpanded = false) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
        if (response && response.success) {
          const posts = response.data || [];
          console.log('è·å–æ–‡ç« åˆ—è¡¨æˆåŠŸï¼Œæ–‡ç« æ•°:', posts.length);
          // ä¿å­˜æ‰€æœ‰æ–‡ç« æ•°æ®
          allPostsData = posts;
          // æŒ‰åˆ†ç±»ç»Ÿè®¡
          const byCategory = {};
          posts.forEach(p => {
            const cat = p.category || 'æ— åˆ†ç±»';
            byCategory[cat] = (byCategory[cat] || 0) + 1;
          });
          console.log('æ–‡ç« åˆ†ç±»ç»Ÿè®¡:', byCategory);
          // å¦‚æœæŒ‡å®šé‡ç½®å±•å¼€çŠ¶æ€ï¼Œåˆ™æ¸…ç©ºï¼ˆé»˜è®¤æ‰€æœ‰åˆ†ç±»éƒ½æŠ˜å ï¼‰
          if (resetExpanded) {
            expandedCategories.clear();
          }
          displayPosts(posts);
        } else {
          console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', response);
          document.getElementById('postsTableBody').innerHTML = '<tr><td colspan="6" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¼‚å¸¸:', error);
        document.getElementById('postsTableBody').innerHTML = '<tr><td colspan="6" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    // æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨ï¼ˆæŒ‰åˆ†ç±»åˆ†ç»„ï¼Œé»˜è®¤æŠ˜å ï¼‰
    function displayPosts(posts) {
      const tbody = document.getElementById('postsTableBody');
      if (!posts || posts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="blog-empty">æš‚æ— æ–‡ç« </td></tr>';
        return;
      }

      console.log('displayPosts æ¥æ”¶åˆ°çš„æ–‡ç« æ•°:', posts.length);

      // æŒ‰åˆ†ç±»åˆ†ç»„
      const postsByCategory = {};
      const seenIds = new Set(); // å‰ç«¯å†æ¬¡å»é‡ï¼Œç¡®ä¿ä¸æ˜¾ç¤ºé‡å¤
      let skippedCount = 0;
      
      for (const post of posts) {
        const postId = String(post.id || '');
        // å¦‚æœå·²å­˜åœ¨ç›¸åŒidï¼Œè·³è¿‡ï¼ˆé˜²æ­¢é‡å¤æ˜¾ç¤ºï¼‰
        if (postId && seenIds.has(postId)) {
          skippedCount++;
          console.warn('è·³è¿‡é‡å¤IDçš„æ–‡ç« :', { id: postId, category: post.category, name: post.name });
          continue;
        }
        seenIds.add(postId);
        
        // æŒ‰apiNameï¼ˆ_sourceApiNameï¼‰åˆ†ç»„ï¼Œè€Œä¸æ˜¯category
        const apiName = post._sourceApiName || post.category || 'æ— åˆ†ç±»';
        if (!postsByCategory[apiName]) {
          postsByCategory[apiName] = [];
        }
        postsByCategory[apiName].push(post);
      }

      console.log('æ˜¾ç¤ºæ–‡ç« ç»Ÿè®¡:', {
        æ€»æ¥æ”¶: posts.length,
        å»é‡å: seenIds.size,
        è·³è¿‡é‡å¤: skippedCount,
        åˆ†ç±»æ•°: Object.keys(postsByCategory).length
      });

      // ç”ŸæˆHTMLï¼šæŒ‰åˆ†ç±»åˆ†ç»„æ˜¾ç¤ºï¼Œé»˜è®¤æŠ˜å 
      let html = '';
      const sortedCategories = Object.keys(postsByCategory).sort();
      
      for (const apiName of sortedCategories) {
        const categoryPosts = postsByCategory[apiName];
        const isExpanded = expandedCategories.has(apiName);
        
        // åˆ†ç±»æ ‡é¢˜è¡Œï¼ˆæŒ‰apiNameåˆ†ç»„ï¼‰
        const specialType = isSpecialCategory(apiName);
        let categoryDisplayName = apiName;
        
        if (specialType) {
          const specialInfo = SPECIAL_CATEGORIES[specialType];
          categoryDisplayName = specialInfo.displayName;
        }
        
        // æ·»åŠ ç‚¹å‡»å±•å¼€/æŠ˜å åŠŸèƒ½ - å»æ‰æ–‡ä»¶å¤¹å›¾æ ‡
        const expandIcon = isExpanded ? 'â–¼' : 'â–¶';
        // ä½¿ç”¨ data-* å±æ€§ä¼ é€’åˆ†ç±»åç§°ï¼Œé¿å…è½¬ä¹‰é—®é¢˜
        html += `
          <tr class="category-header-row" style="background: #FFFFFF; font-weight: 600; cursor: pointer;" data-category-name="${escapeHtml(apiName)}" onclick="toggleCategory(this.dataset.categoryName)">
            <td colspan="6" style="padding: 0.875rem 1rem;">
              <span style="color: #374151; font-weight: 600; font-size: 0.875rem;">${expandIcon} ${escapeHtml(categoryDisplayName)}</span>
              <span style="color: #6B7280; font-size: 0.875rem; font-weight: normal; margin-left: 0.5rem;">
                (${categoryPosts.length} ç¯‡æ–‡ç« )
              </span>
            </td>
          </tr>
        `;
        
        // è¯¥åˆ†ç±»ä¸‹çš„æ–‡ç« ï¼ˆæ ¹æ®å±•å¼€çŠ¶æ€æ˜¾ç¤º/éšè—ï¼‰
        if (isExpanded) {
        for (const post of categoryPosts) {
          const date = formatDate(post.createdAt || post.created_at);
          const postSpecialType = isSpecialCategory(apiName);
          // æ˜¾ç¤ºcategoryä½œä¸ºæ ‡ç­¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºapiName
          const postCategory = post.category || apiName;
          let categoryDisplay = `<span class="category-tag">${escapeHtml(postCategory)}</span>`;
          
          // çŠ¶æ€Badge
          const statusBadge = post.published 
            ? '<span class="status-badge published">å·²å‘å¸ƒ</span>' 
            : '<span class="status-badge draft">è‰ç¨¿</span>';
          
          html += `
              <tr class="category-post-row" data-category="${escapeHtml(apiName)}" style="background: #FFFFFF;">
              <td style="font-weight: 500; color: #111827;">${escapeHtml(post.name || post.title || 'æœªå‘½å')}</td>
              <td>${categoryDisplay}</td>
              <td>${statusBadge}</td>
              <td style="color: #6B7280;">${post.views || 0}</td>
              <td style="color: #6B7280;">${date}</td>
              <td>
                <div class="admin-actions">
                  <button class="admin-btn-small admin-btn-edit" onclick="editPost('${post.id}')">ç¼–è¾‘</button>
                  <button class="admin-btn-small admin-btn-copy" onclick="copyPost('${post.id}')" title="å¤åˆ¶æ–‡ç« ">å¤åˆ¶</button>
                  <button class="admin-btn-small admin-btn-delete" onclick="deletePost('${post.id}')">åˆ é™¤</button>
                </div>
              </td>
            </tr>
          `;
          }
        }
      }

      tbody.innerHTML = html;
    }

    // åˆ‡æ¢åˆ†ç±»å±•å¼€/æŠ˜å çŠ¶æ€
    function toggleCategory(apiName) {
      if (expandedCategories.has(apiName)) {
        expandedCategories.delete(apiName);
      } else {
        expandedCategories.add(apiName);
      }
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      displayPosts(allPostsData);
    }

    // æ˜¾ç¤ºæ–‡ç« è¡¨å•
    async function showPostForm(post = null) {
      const form = document.getElementById('postForm');
      const formTitle = document.getElementById('postFormTitle');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      // ç¡®ä¿APIåˆ—è¡¨å·²åŠ è½½
      if (availableApis.length === 0) {
        loadApis().then(() => {
          showPostForm(post);
        });
        return;
      }
      
      // ç¡®ä¿è¡¨å•æ˜¾ç¤ºï¼Œå¹¶éšè—åŠ è½½æç¤º
      if (form) {
        form.style.display = 'block';
        form.classList.remove('loading');
      }
      if (postFormLoading) {
        postFormLoading.style.display = 'none';
      }
      if (postFormContent) {
        postFormContent.style.display = 'block';
      }
      
      // é‡ç½®è¡¨å•
      document.getElementById('postId').value = '';
      document.getElementById('postName').value = '';
      document.getElementById('postSlug').value = '';
      document.getElementById('postExcerpt').value = '';
      document.getElementById('postImage').value = '';
      updateImagePreview('');
      document.getElementById('postCategory').value = '';
      document.getElementById('postTags').value = '';
      document.getElementById('postPublished').checked = true;
      
      // æ¸…ç©ºä½ç½®å’Œè”ç³»æ–¹å¼å­—æ®µ
      const commonPhone = document.getElementById('commonPhone');
      const commonAddress = document.getElementById('commonAddress');
      const commonLatitude = document.getElementById('commonLatitude');
      const commonLongitude = document.getElementById('commonLongitude');
      const secondHandPhone = document.getElementById('secondHandPhone');
      const secondHandAddress = document.getElementById('secondHandAddress');
      const secondHandLatitude = document.getElementById('secondHandLatitude');
      const secondHandLongitude = document.getElementById('secondHandLongitude');
      const rentalsPhone = document.getElementById('rentalsPhone');
      const rentalsAddress = document.getElementById('rentalsAddress');
      const rentalsLatitude = document.getElementById('rentalsLatitude');
      const rentalsLongitude = document.getElementById('rentalsLongitude');
      
      if (commonPhone) commonPhone.value = '';
      if (commonAddress) commonAddress.value = '';
      if (commonLatitude) commonLatitude.value = '';
      if (commonLongitude) commonLongitude.value = '';
      if (secondHandPhone) secondHandPhone.value = '';
      if (secondHandAddress) secondHandAddress.value = '';
      if (secondHandLatitude) secondHandLatitude.value = '';
      if (secondHandLongitude) secondHandLongitude.value = '';
      if (rentalsPhone) rentalsPhone.value = '';
      if (rentalsAddress) rentalsAddress.value = '';
      if (rentalsLatitude) rentalsLatitude.value = '';
      if (rentalsLongitude) rentalsLongitude.value = '';
      
      if (post) {
        // å¦‚æœæ²¡æœ‰IDï¼Œè¯´æ˜æ˜¯å¤åˆ¶æˆ–æ–°å»ºï¼Œå¦åˆ™æ˜¯ç¼–è¾‘
        formTitle.textContent = post.id ? 'ç¼–è¾‘æ–‡ç« ' : 'å¤åˆ¶æ–‡ç« ';
        document.getElementById('postId').value = post.id || '';
        // nameå’Œtitleä¿æŒä¸€è‡´
        const nameValue = post.name || post.title || '';
        document.getElementById('postName').value = nameValue;
        document.getElementById('postSlug').value = post.slug || '';
        document.getElementById('postExcerpt').value = post.excerpt || post.description || '';
        const imageUrl = post.image || '';
        document.getElementById('postImage').value = imageUrl;
        updateImagePreview(imageUrl);
        const apiName = post._sourceApiName || post.category || '';
        document.getElementById('postApiName').value = apiName;
        // categoryå­—æ®µä½œä¸ºæ ‡ç­¾ä½¿ç”¨
        const category = post.category || post._sourceApiName || '';
        document.getElementById('postCategory').value = category;
        // tagså­—æ®µå·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨
        document.getElementById('postPublished').checked = post.published !== false; // é»˜è®¤ä¸ºtrue
        
        // è§¦å‘APIé€‰æ‹©æ”¹å˜äº‹ä»¶
        setTimeout(() => {
          onApiNameChange();
          
          // å¦‚æœæ˜¯ç‰¹æ®Šç±»åˆ«ï¼ŒåŠ è½½åŸå§‹æ•°æ®åˆ°è¡¨å•
          const specialType = isSpecialCategory(apiName);
          if (specialType && post._originalData) {
            loadSpecialCategoryData(specialType, post._originalData);
          }
          
          // åŠ è½½ç‰¹æ®Šå­—æ®µï¼ˆäºŒæ‰‹å¸‚åœºå’Œç§Ÿæˆ¿é…’åº—ï¼‰
          if (specialType === 'second-hand') {
            const priceInput = document.getElementById('secondHandPrice');
            if (priceInput) {
              // ä¼˜å…ˆä»_originalDataè·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»postæœ¬èº«è·å–
              const price = (post._originalData && post._originalData.price) || post.price || '';
              priceInput.value = price;
              console.log('åŠ è½½äºŒæ‰‹å¸‚åœºä»·æ ¼å­—æ®µ:', { price, fromOriginalData: post._originalData?.price, fromPost: post.price });
            }
            const phoneInput = document.getElementById('secondHandPhone');
            const addressInput = document.getElementById('secondHandAddress');
            const latInput = document.getElementById('secondHandLatitude');
            const lngInput = document.getElementById('secondHandLongitude');
            if (phoneInput) {
              const phone = (post._originalData && post._originalData.phone) || post.phone || '';
              phoneInput.value = phone;
            }
            if (addressInput) {
              const address = (post._originalData && post._originalData.address) || post.address || '';
              addressInput.value = address;
            }
            if (latInput) {
              const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
              latInput.value = lat;
            }
            if (lngInput) {
              const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
              lngInput.value = lng;
            }
          } else if (specialType === 'rentals') {
            const priceInput = document.getElementById('rentalsPrice');
            const roomsInput = document.getElementById('rentalsRooms');
            const areaInput = document.getElementById('rentalsArea');
            const viewsInput = document.getElementById('rentalsViews');
            const phoneInput = document.getElementById('rentalsPhone');
            const addressInput = document.getElementById('rentalsAddress');
            const latInput = document.getElementById('rentalsLatitude');
            const lngInput = document.getElementById('rentalsLongitude');
            if (priceInput) {
              const price = (post._originalData && post._originalData.price) || post.price || '';
              priceInput.value = price;
            }
            if (roomsInput) {
              const rooms = (post._originalData && post._originalData.rooms) || post.rooms || '';
              roomsInput.value = rooms;
            }
            if (areaInput) {
              const area = (post._originalData && post._originalData.area) || post.area || '';
              areaInput.value = area;
            }
            if (viewsInput) {
              const views = (post._originalData && post._originalData.views) || post.views || 0;
              viewsInput.value = views;
            }
            if (phoneInput) {
              const phone = (post._originalData && post._originalData.phone) || post.phone || '';
              phoneInput.value = phone;
            }
            if (addressInput) {
              const address = (post._originalData && post._originalData.address) || post.address || '';
              addressInput.value = address;
            }
            if (latInput) {
              const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
              latInput.value = lat;
            }
            if (lngInput) {
              const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
              lngInput.value = lng;
            }
            console.log('åŠ è½½ç§Ÿæˆ¿é…’åº—ç‰¹æ®Šå­—æ®µ:', {
              price: (post._originalData && post._originalData.price) || post.price,
              rooms: (post._originalData && post._originalData.rooms) || post.rooms,
              area: (post._originalData && post._originalData.area) || post.area,
              views: (post._originalData && post._originalData.views) || post.views,
              phone: (post._originalData && post._originalData.phone) || post.phone,
              address: (post._originalData && post._originalData.address) || post.address,
              latitude: (post._originalData && post._originalData.latitude) || post.latitude,
              longitude: (post._originalData && post._originalData.longitude) || post.longitude
            });
          } else {
            // åŠ è½½é€šç”¨ä½ç½®å­—æ®µï¼ˆç”¨äºå…¶ä»–éœ€è¦ä½ç½®çš„åˆ†ç±»ï¼‰
            const needsLocation = needsLocationFields(apiName);
            const needsPhone = needsPhoneField(apiName);
            if (needsLocation) {
              const addressInput = document.getElementById('commonAddress');
              const latInput = document.getElementById('commonLatitude');
              const lngInput = document.getElementById('commonLongitude');
              if (addressInput) {
                const address = (post._originalData && post._originalData.address) || post.address || '';
                addressInput.value = address;
              }
              if (latInput) {
                const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
                latInput.value = lat;
              }
              if (lngInput) {
                const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
                lngInput.value = lng;
              }
            }
            // åŠ è½½é€šç”¨ç”µè¯å­—æ®µï¼ˆç”¨äºå¯»å‘³ä¸­å›½ç­‰åˆ†ç±»ï¼‰
            if (needsPhone) {
              const phoneInput = document.getElementById('commonPhone');
              if (phoneInput) {
                const phone = (post._originalData && post._originalData.phone) || post.phone || '';
                phoneInput.value = phone;
              }
            }
          }
        }, 100);
        
        // è®¾ç½®htmlContentï¼ˆç»Ÿä¸€ä½¿ç”¨htmlContentï¼‰
        const htmlContent = post.htmlContent || (post._originalData ? (post._originalData.htmlContent || '') : '');
        
        // åˆå§‹åŒ–HTMLç¼–è¾‘å™¨å¹¶è®¾ç½®å†…å®¹
        if (!wangEditor) {
          await initQuillEditor();
        }
        if (wangEditor) {
          if (htmlContent) {
            wangEditor.setHtml(htmlContent);
          } else {
            wangEditor.setHtml('');
          }
        }
      } else {
        formTitle.textContent = 'æ–°å»ºæ–‡ç« ';
        document.getElementById('postFormElement').reset();
        document.getElementById('postId').value = '';
        document.getElementById('postApiName').value = '';
        
        // é‡ç½®æ‰€æœ‰ç‰¹æ®Šè¡¨å•
        document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
          el.style.display = 'none';
          // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
          el.querySelectorAll('input, textarea, select').forEach(input => {
            input.value = '';
          });
        });
        
        // é‡ç½®å¤©æ°”è·¯å†µçš„åŠ¨æ€åˆ—è¡¨
        document.getElementById('weatherAttractionsList').innerHTML = '';
        document.getElementById('weatherTrafficList').innerHTML = '';
        weatherAttractionsCounter = 0;
        weatherTrafficCounter = 0;
        
        // é‡ç½®ç‰¹æ®Šå­—æ®µï¼ˆäºŒæ‰‹å¸‚åœºå’Œç§Ÿæˆ¿é…’åº—ï¼‰
        const secondHandPriceInput = document.getElementById('secondHandPrice');
        if (secondHandPriceInput) secondHandPriceInput.value = '';
        const rentalsPriceInput = document.getElementById('rentalsPrice');
        if (rentalsPriceInput) rentalsPriceInput.value = '';
        const rentalsRoomsInput = document.getElementById('rentalsRooms');
        if (rentalsRoomsInput) rentalsRoomsInput.value = '';
        const rentalsAreaInput = document.getElementById('rentalsArea');
        if (rentalsAreaInput) rentalsAreaInput.value = '';
        const rentalsViewsInput = document.getElementById('rentalsViews');
        if (rentalsViewsInput) rentalsViewsInput.value = '';
        
        // é‡ç½®æ±‡ç‡è½¬æ¢åˆ—è¡¨
        const exchangeRatesList = document.getElementById('exchangeRatesList');
        if (exchangeRatesList) exchangeRatesList.innerHTML = '';
        exchangeRatesCounter = 0;
        
        // æ˜¾ç¤ºæ™®é€šå†…å®¹ç¼–è¾‘å™¨
        const normalEditor = document.getElementById('normalContentEditor');
        if (normalEditor) {
          normalEditor.style.display = 'block';
        }
        
        // åˆå§‹åŒ–HTMLç¼–è¾‘å™¨
        if (!wangEditor) {
          await initQuillEditor();
        }
        if (wangEditor) {
          wangEditor.setHtml('');
        }
        document.getElementById('fieldMappingInfo').style.display = 'none';
      }
      
      form.style.display = 'block';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    // åˆ‡æ¢ç¼–è¾‘å™¨æ¨¡å¼ï¼ˆå…¨å±€å‡½æ•°ï¼Œä¾›HTMLè°ƒç”¨ï¼‰
    window.switchEditorMode = async function switchEditorMode(mode) {
      const markdownContainer = document.getElementById('markdownEditorContainer');
      const htmlContainer = document.getElementById('htmlEditorContainer');
      
      // ä¿å­˜å½“å‰ç¼–è¾‘å™¨å†…å®¹åˆ°ä¸´æ—¶å˜é‡ï¼ˆåœ¨åˆ‡æ¢å‰ï¼‰
      let currentContent = '';
      
      if (currentEditorMode === 'html' && wangEditor) {
        // å½“å‰æ˜¯HTMLæ¨¡å¼ï¼Œä¿å­˜HTMLå†…å®¹
        currentContent = wangEditor.getHtml();
      } else if (currentEditorMode === 'markdown' && simpleMDE) {
        // å½“å‰æ˜¯Markdownæ¨¡å¼ï¼Œä¿å­˜Markdownå†…å®¹
        currentContent = simpleMDE.value();
      } else if (currentEditorMode === 'markdown') {
        // Markdownæ¨¡å¼ä½†simpleMDEæœªåˆå§‹åŒ–ï¼Œä»textareaè·å–
        const textarea = document.getElementById('postContent');
        if (textarea) {
          currentContent = textarea.value;
        }
      }
      
      // æ›´æ–°å½“å‰æ¨¡å¼
      currentEditorMode = mode;
      
      if (mode === 'markdown') {
        markdownContainer.style.display = 'block';
        htmlContainer.style.display = 'none';
        
        // ç¡®ä¿SimpleMDEå·²åˆå§‹åŒ–
        if (!simpleMDE) {
          simpleMDE = new SimpleMDE({
            element: document.getElementById('postContent'),
            spellChecker: false,
            placeholder: 'è¾“å…¥Markdownå†…å®¹...'
          });
        }
        
        // å¦‚æœåˆ‡æ¢åˆ°Markdownï¼Œå°†HTMLå†…å®¹è½¬æ¢ä¸ºMarkdownæ˜¾ç¤º
        if (currentContent) {
          if (currentContent.trim().startsWith('<')) {
            // HTMLå†…å®¹ï¼Œè½¬æ¢ä¸ºMarkdown
            const markdownContent = htmlToMarkdown(currentContent);
            simpleMDE.value(markdownContent);
          } else {
            // å·²ç»æ˜¯Markdownå†…å®¹ï¼Œç›´æ¥ä½¿ç”¨
            simpleMDE.value(currentContent);
          }
        } else {
          // æ²¡æœ‰å†…å®¹ï¼Œæ¸…ç©º
          simpleMDE.value('');
        }
      } else {
        // HTMLæ¨¡å¼
        markdownContainer.style.display = 'none';
        htmlContainer.style.display = 'block';
        
        // åˆå§‹åŒ–WangEditorç¼–è¾‘å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
        if (!wangEditor) {
          await initQuillEditor();
          // ç­‰å¾…WangEditorå®Œå…¨åˆå§‹åŒ–
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // å¦‚æœåˆ‡æ¢åˆ°HTMLï¼Œå°†Markdownå†…å®¹è½¬æ¢ä¸ºHTML
        if (currentContent && wangEditor) {
          if (currentContent.trim().startsWith('<')) {
            // å·²ç»æ˜¯HTMLå†…å®¹ï¼Œç›´æ¥ä½¿ç”¨
            wangEditor.setHtml(currentContent);
          } else {
            // Markdownå†…å®¹ï¼Œè½¬æ¢ä¸ºHTMLï¼ˆä½¿ç”¨asyncå‡½æ•°ï¼‰
            markdownToHtml(currentContent).then(htmlContent => {
              if (wangEditor) {
                wangEditor.setHtml(htmlContent);
              }
            }).catch(error => {
              console.error('Markdownè½¬æ¢å¤±è´¥:', error);
              if (wangEditor) {
                wangEditor.setHtml('<p>è½¬æ¢å¤±è´¥: ' + escapeHtml(error.message) + '</p>');
              }
            });
          }
        } else if (wangEditor) {
          // æ²¡æœ‰å†…å®¹ï¼Œæ¸…ç©º
          wangEditor.setHtml('');
        }
      }
    }
    
    // HTMLè½¬Markdownçš„è¾…åŠ©å‡½æ•°
    function htmlToMarkdown(html) {
      if (!html) return '';
      
      let markdown = html
        // æ ‡é¢˜
        .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
        .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
        .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
        .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n')
        .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n\n')
        .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n\n')
        // ç²—ä½“å’Œæ–œä½“
        .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
        .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
        .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
        .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
        // é“¾æ¥
        .replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, '[$2]($1)')
        // å›¾ç‰‡
        .replace(/<img[^>]*src=["']([^"']*)["'][^>]*alt=["']([^"']*)["'][^>]*>/gi, '![$2]($1)')
        .replace(/<img[^>]*src=["']([^"']*)["'][^>]*>/gi, '![]($1)')
        // åˆ—è¡¨
        .replace(/<ul[^>]*>/gi, '')
        .replace(/<\/ul>/gi, '\n')
        .replace(/<ol[^>]*>/gi, '')
        .replace(/<\/ol>/gi, '\n')
        .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
        // ä»£ç å—
        .replace(/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/gis, '```\n$1\n```\n')
        .replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`')
        // æ®µè½å’Œæ¢è¡Œ
        .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
        .replace(/<br[^>]*>/gi, '\n')
        .replace(/<div[^>]*>(.*?)<\/div>/gis, '$1\n')
        // ç§»é™¤æ‰€æœ‰å‰©ä½™çš„HTMLæ ‡ç­¾
        .replace(/<[^>]+>/g, '')
        // æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
        .replace(/\n{3,}/g, '\n\n')
        .trim();
      
      return markdown;
    }
    
    // Markdownè½¬HTMLçš„è¾…åŠ©å‡½æ•°ï¼ˆä½¿ç”¨marked.jsï¼‰
    async function markdownToHtml(markdown) {
      if (!markdown) return '';
      
      // å¦‚æœå·²ç»æ˜¯HTMLï¼Œç›´æ¥è¿”å›
      if (markdown.trim().startsWith('<')) {
        return markdown;
      }
      
      // ä½¿ç”¨marked.jsè¿›è¡Œè½¬æ¢
      if (typeof marked !== 'undefined') {
        try {
          // é…ç½®markedé€‰é¡¹
          marked.setOptions({
            breaks: true, // æ”¯æŒGFMæ¢è¡Œ
            gfm: true, // å¯ç”¨GitHub Flavored Markdown
            headerIds: true,
            mangle: false
          });
          return marked.parse(markdown);
        } catch (error) {
          console.error('Markdownè½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨ç®€å•è½¬æ¢:', error);
          // å¦‚æœmarked.jsè½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨ç®€å•è½¬æ¢ä½œä¸ºåå¤‡
        }
      }
      
      // åå¤‡æ–¹æ¡ˆï¼šç®€å•è½¬æ¢ï¼ˆå¦‚æœmarked.jsæœªåŠ è½½ï¼‰
      let html = markdown
        // æ ‡é¢˜
        .replace(/^###### (.*?)$/gm, '<h6>$1</h6>')
        .replace(/^##### (.*?)$/gm, '<h5>$1</h5>')
        .replace(/^#### (.*?)$/gm, '<h4>$1</h4>')
        .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
        .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
        // ç²—ä½“å’Œæ–œä½“
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // é“¾æ¥
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        // å›¾ç‰‡
        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')
        // ä»£ç å—
        .replace(/```([^`]+)```/gs, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // åˆ—è¡¨
        .replace(/^\- (.*?)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        // æ®µè½ï¼ˆå¤„ç†åŒæ¢è¡Œï¼‰
        .split(/\n\n+/)
        .map(para => {
          para = para.trim();
          if (!para) return '';
          // å¦‚æœå·²ç»æ˜¯HTMLæ ‡ç­¾ï¼Œä¸åŒ…è£…
          if (para.match(/^<(h[1-6]|ul|ol|pre|code|div)/)) {
            return para;
          }
          return '<p>' + para.replace(/\n/g, '<br>') + '</p>';
        })
        .join('\n');
      
      return html;
    }
    
    // åˆå§‹åŒ–WangEditor v5 HTMLç¼–è¾‘å™¨
    function initQuillEditor() {
      // å…¼å®¹æ€§ï¼šä¿æŒå‡½æ•°åä¸å˜ï¼Œå†…éƒ¨ä½¿ç”¨WangEditor
      return initWangEditor();
    }
    
    async function initWangEditor() {
      // æ£€æŸ¥WangEditoræ˜¯å¦å·²åŠ è½½ï¼ˆWangEditor v5ä½¿ç”¨window.wangEditorï¼‰
      // ç­‰å¾…WangEditoråŠ è½½
      return new Promise((resolve) => {
        let checkCount = 0;
        const maxChecks = 50; // æœ€å¤šæ£€æŸ¥5ç§’ï¼ˆ50 * 100msï¼‰
        
        const checkWangEditor = setInterval(() => {
          checkCount++;
          
          // æ£€æŸ¥window.wangEditoræ˜¯å¦å­˜åœ¨
          if (typeof window.wangEditor !== 'undefined' && 
              window.wangEditor && 
              window.wangEditor.createEditor && 
              window.wangEditor.createToolbar) {
            clearInterval(checkWangEditor);
            console.log('WangEditorå·²åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–ç¼–è¾‘å™¨');
            try {
              initWangEditorInternal();
              resolve();
            } catch (e) {
              console.error('WangEditoråˆå§‹åŒ–å¤±è´¥:', e);
              showToast('HTMLç¼–è¾‘å™¨åˆå§‹åŒ–å¤±è´¥: ' + e.message, 'error');
              resolve();
            }
          } else if (checkCount >= maxChecks) {
            clearInterval(checkWangEditor);
            console.error('WangEditoråŠ è½½è¶…æ—¶', {
              windowWangEditor: typeof window.wangEditor,
              wangEditorType: typeof wangEditor,
              checkCount: checkCount
            });
            showToast('HTMLç¼–è¾‘å™¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            resolve();
          }
        }, 100);
      });
    }
    
    function initWangEditorInternal() {
      const editorContainer = document.getElementById('postHtmlContent');
      if (!editorContainer) {
        console.error('ç¼–è¾‘å™¨å®¹å™¨ä¸å­˜åœ¨');
        return;
      }
      
      // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œå…ˆé”€æ¯
      if (wangEditor) {
        try {
          wangEditor.destroy();
          wangEditor = null;
        } catch (e) {
          console.warn('é”€æ¯ç¼–è¾‘å™¨æ—¶å‡ºé”™:', e);
        }
      }
      
      // æ¸…ç©ºå®¹å™¨å†…å®¹ï¼Œåˆ›å»ºç¼–è¾‘å™¨å’Œå·¥å…·æ å®¹å™¨
      editorContainer.innerHTML = `
        <div id="wang-editor-toolbar" style="border: 1px solid #ccc; border-bottom: none;"></div>
        <div id="wang-editor-container" style="border: 1px solid #ccc; min-height: 500px;"></div>
      `;
      
      try {
        // ä½¿ç”¨CDNç‰ˆæœ¬çš„WangEditorï¼ˆ@wangeditor/editor v5ï¼‰
        // WangEditor v5é€šè¿‡CDNåŠ è½½åï¼Œé€šè¿‡window.wangEditorå¯¼å‡º
        if (typeof window.wangEditor === 'undefined') {
          console.error('WangEditoræœªåŠ è½½ï¼Œè¯·æ£€æŸ¥CDNé“¾æ¥');
          throw new Error('WangEditoræœªæ­£ç¡®åŠ è½½ï¼Œè¯·æ£€æŸ¥CDNé“¾æ¥å’ŒCSPç­–ç•¥');
        }
        
        const { createEditor, createToolbar } = window.wangEditor;
        
        if (!createEditor || !createToolbar) {
          console.error('WangEditor APIä¸å­˜åœ¨:', window.wangEditor);
          throw new Error('WangEditor APIæœªæ­£ç¡®å¯¼å‡ºï¼Œè¯·æ£€æŸ¥CDNç‰ˆæœ¬');
        }
        
        // WangEditor v5é…ç½®
        const editorConfig = {
          placeholder: 'è¾“å…¥HTMLå†…å®¹...',
          MENU_CONF: {
            uploadImage: {
              server: '/api/admin/custom-apis/upload-image',
              fieldName: 'image',
              maxFileSize: 10 * 1024 * 1024, // 10MB
              allowedFileTypes: ['image/*'],
              withCredentials: true,
              customUpload: async (file, insertFn) => {
                try {
                  const imageUrl = await uploadImageToServer(file);
                  insertFn(imageUrl, file.name, imageUrl);
                  showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                } catch (error) {
                  showToast('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                }
              }
            },
            uploadVideo: {
              server: '/api/admin/custom-apis/upload-video',
              fieldName: 'video',
              maxFileSize: 200 * 1024 * 1024, // 200MB
              allowedFileTypes: ['video/*'],
              withCredentials: true,
              customUpload: async (file, insertFn) => {
                // åˆ›å»ºå…¨å±€è¿›åº¦æ˜¾ç¤º
                const globalProgressId = 'wangEditorVideoProgress';
                let progressContainer = document.getElementById(globalProgressId);
                
                if (!progressContainer) {
                  progressContainer = document.createElement('div');
                  progressContainer.id = globalProgressId;
                  progressContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; min-width: 300px; max-width: 400px;';
                  progressContainer.innerHTML = `
                    <div style="margin-bottom: 0.5rem; font-weight: 600; color: #333;">è§†é¢‘ä¸Šä¼ ä¸­...</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <div style="flex: 1; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                        <div id="wangEditorVideoProgressBar" style="height: 100%; background: #9333ea; width: 0%; transition: width 0.3s;"></div>
                      </div>
                      <span id="wangEditorVideoStatus" style="font-size: 0.875rem; color: #6b7280; white-space: nowrap; min-width: 60px; text-align: right;">0%</span>
                    </div>
                    <div id="wangEditorVideoMessage" style="font-size: 0.75rem; color: #6b7280;">å‡†å¤‡ä¸Šä¼ ...</div>
                  `;
                  document.body.appendChild(progressContainer);
                } else {
                  // é‡ç½®è¿›åº¦
                  const progressBar = document.getElementById('wangEditorVideoProgressBar');
                  const statusSpan = document.getElementById('wangEditorVideoStatus');
                  const messageSpan = document.getElementById('wangEditorVideoMessage');
                  if (progressBar) progressBar.style.width = '0%';
                  if (statusSpan) statusSpan.textContent = '0%';
                  if (messageSpan) messageSpan.textContent = 'å‡†å¤‡ä¸Šä¼ ...';
                  progressContainer.style.display = 'block';
                }
                
                const progressBar = document.getElementById('wangEditorVideoProgressBar');
                const statusSpan = document.getElementById('wangEditorVideoStatus');
                const messageSpan = document.getElementById('wangEditorVideoMessage');
                
                try {
                  const videoInfo = await uploadVideoToServer(file, (progress, message) => {
                    // æ›´æ–°å…¨å±€è¿›åº¦æ˜¾ç¤º
                    if (progressBar && statusSpan) {
                      progressBar.style.width = Math.min(Math.max(progress, 0), 100) + '%';
                      statusSpan.textContent = `${Math.round(progress)}%`;
                      if (progress >= 100) {
                        statusSpan.style.color = '#10b981'; // ç»¿è‰²è¡¨ç¤ºå®Œæˆ
                      } else {
                        statusSpan.style.color = '#6b7280'; // ç°è‰²è¡¨ç¤ºè¿›è¡Œä¸­
                      }
                    }
                    if (messageSpan && message) {
                      messageSpan.textContent = message;
                    }
                  });
                  
                  // å®Œæˆ
                  if (progressBar && statusSpan && messageSpan) {
                    progressBar.style.width = '100%';
                    statusSpan.textContent = '100%';
                    statusSpan.style.color = '#10b981';
                    messageSpan.textContent = 'ä¸Šä¼ å®Œæˆï¼';
                  }
                  
                  insertFn(videoInfo.url, file.name, videoInfo.url);
                  showToast('è§†é¢‘ä¸Šä¼ æˆåŠŸ', 'success');
                  
                  // 3ç§’åéšè—è¿›åº¦æ¡
                  setTimeout(() => {
                    if (progressContainer) {
                      progressContainer.style.display = 'none';
                    }
                  }, 3000);
                } catch (error) {
                  // æ˜¾ç¤ºé”™è¯¯
                  if (progressBar && statusSpan && messageSpan) {
                    progressBar.style.width = '0%';
                    statusSpan.textContent = 'å¤±è´¥';
                    statusSpan.style.color = '#ef4444';
                    messageSpan.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
                  }
                  
                  showToast('è§†é¢‘ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                  
                  // 5ç§’åéšè—è¿›åº¦æ¡
                  setTimeout(() => {
                    if (progressContainer) {
                      progressContainer.style.display = 'none';
                    }
                  }, 5000);
                }
              }
            }
          }
        };
        
        // åˆ›å»ºç¼–è¾‘å™¨
        wangEditor = createEditor({
          selector: '#wang-editor-container',
          config: editorConfig,
          mode: 'default'
        });
        
        // åˆ›å»ºå·¥å…·æ 
        const toolbar = createToolbar({
          editor: wangEditor,
          selector: '#wang-editor-toolbar',
          config: {},
          mode: 'default'
        });
        
        // ç›‘å¬ç²˜è´´äº‹ä»¶ï¼Œå¤„ç†ç²˜è´´çš„å›¾ç‰‡æ–‡ä»¶å’Œå¤–éƒ¨å›¾ç‰‡URL
        const editorDom = document.getElementById('wang-editor-container');
        if (editorDom) {
          editorDom.addEventListener('paste', async function(e) {
            const clipboardData = e.clipboardData || window.clipboardData;
            if (!clipboardData) return;
            
            // æ£€æŸ¥å‰ªè´´æ¿ä¸­æ˜¯å¦æœ‰base64å›¾ç‰‡æ•°æ®
            const pasteData = clipboardData.getData('text/html');
            if (pasteData && (pasteData.includes('data:image') || pasteData.includes('data:video'))) {
              // å¦‚æœåŒ…å«base64å›¾ç‰‡æˆ–è§†é¢‘ï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸º
              e.preventDefault();
              showToast('æ£€æµ‹åˆ°base64å†…å®¹ï¼Œè¯·ä½¿ç”¨ä¸Šä¼ åŠŸèƒ½ä¸Šä¼ æ–‡ä»¶', 'warning');
              return;
            }
            
            const items = clipboardData.items;
            let hasImageFile = false;
            let externalImageUrl = null;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡æ–‡ä»¶
            for (let i = 0; i < items.length; i++) {
              const item = items[i];
              if (item.kind === 'file' && item.type.indexOf('image') !== -1) {
                hasImageFile = true;
                break;
              }
            }
            
            // å¦‚æœæ²¡æœ‰å›¾ç‰‡æ–‡ä»¶ï¼Œæ£€æŸ¥HTMLå†…å®¹ä¸­æ˜¯å¦æœ‰å¤–éƒ¨å›¾ç‰‡URL
            if (!hasImageFile) {
              const htmlPromise = new Promise((resolve) => {
                for (let i = 0; i < items.length; i++) {
                  const item = items[i];
                  if (item.kind === 'string' && item.type === 'text/html') {
                    item.getAsString(function(html) {
                      resolve(html);
                    });
                    return;
                  }
                }
                resolve(null);
              });
              
              const html = await htmlPromise;
              if (html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const images = doc.querySelectorAll('img');
                
                if (images.length > 0) {
                  const imgSrc = images[0].src;
                  if (imgSrc && !imgSrc.startsWith('data:') && !imgSrc.startsWith('blob:')) {
                    try {
                      const currentHost = window.location.host;
                      const imgUrl = new URL(imgSrc, window.location.origin);
                      if (imgUrl.host !== currentHost && imgUrl.host !== '') {
                        externalImageUrl = imgSrc;
                      }
                    } catch (e) {
                      // URLè§£æå¤±è´¥ï¼Œå¿½ç•¥
                    }
                  }
                }
              }
            }
            
            // å¦‚æœæœ‰å›¾ç‰‡æ–‡ä»¶ï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸ºå¹¶ä¸Šä¼ 
            if (hasImageFile) {
              e.preventDefault();
              
              for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.kind === 'file' && item.type.indexOf('image') !== -1) {
                  const file = item.getAsFile();
                  if (!file) continue;
                  
                  if (file.size > 10 * 1024 * 1024) {
                    showToast('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
                    continue;
                  }
                  
                  try {
                    const imageUrl = await uploadImageToServer(file);
                    if (wangEditor && wangEditor.insertNode) {
                      const imageNode = {
                        type: 'image',
                        src: imageUrl,
                        alt: file.name,
                        href: ''
                      };
                      wangEditor.insertNode(imageNode);
                    } else if (wangEditor && wangEditor.dangerouslyInsertHtml) {
                      wangEditor.dangerouslyInsertHtml(`<img src="${imageUrl}" alt="${file.name}" />`);
                    }
                    showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                  } catch (error) {
                    showToast('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                  }
                  break;
                }
              }
            } else if (externalImageUrl) {
              // å¦‚æœæœ‰å¤–éƒ¨å›¾ç‰‡URLï¼Œé˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œä¸‹è½½å¹¶ä¸Šä¼ 
              e.preventDefault();
              
              try {
                const response = await fetch(externalImageUrl, { 
                  mode: 'cors',
                  credentials: 'omit'
                });
                
                if (!response.ok) {
                  throw new Error('ä¸‹è½½å›¾ç‰‡å¤±è´¥: ' + response.statusText);
                }
                
                const blob = await response.blob();
                
                if (blob.size > 10 * 1024 * 1024) {
                  throw new Error('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
                }
                
                if (!blob.type.startsWith('image/')) {
                  throw new Error('ä¸‹è½½çš„æ–‡ä»¶ä¸æ˜¯å›¾ç‰‡æ ¼å¼');
                }
                
                const fileExtension = blob.type.split('/')[1] || 'jpg';
                const fileName = `image.${fileExtension}`;
                const file = new File([blob], fileName, { type: blob.type });
                
                const imageUrl = await uploadImageToServer(file);
                
                if (wangEditor && wangEditor.insertNode) {
                  const imageNode = {
                    type: 'image',
                    src: imageUrl,
                    alt: fileName,
                    href: ''
                  };
                  wangEditor.insertNode(imageNode);
                } else if (wangEditor && wangEditor.dangerouslyInsertHtml) {
                  wangEditor.dangerouslyInsertHtml(`<img src="${imageUrl}" alt="${fileName}" />`);
                }
                
                showToast('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
              } catch (error) {
                showToast('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
                console.error('ä¸‹è½½å¹¶ä¸Šä¼ å¤–éƒ¨å›¾ç‰‡å¤±è´¥:', error);
              }
            }
          });
          
          // æ·»åŠ æ‹–æ”¾ä¸Šä¼ å›¾ç‰‡åŠŸèƒ½
          // é˜»æ­¢é»˜è®¤çš„æ‹–æ”¾è¡Œä¸º
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            editorDom.addEventListener(eventName, function(e) {
              e.preventDefault();
              e.stopPropagation();
            });
          });
          
          // æ·»åŠ æ‹–æ”¾åŒºåŸŸè§†è§‰åé¦ˆ
          ['dragenter', 'dragover'].forEach(eventName => {
            editorDom.addEventListener(eventName, function() {
              editorDom.style.border = '2px dashed #3b82f6';
              editorDom.style.backgroundColor = '#eff6ff';
            });
          });
          
          ['dragleave', 'drop'].forEach(eventName => {
            editorDom.addEventListener(eventName, function() {
              editorDom.style.border = '';
              editorDom.style.backgroundColor = '';
            });
          });
          
          // å¤„ç†æ–‡ä»¶æ‹–æ”¾
          editorDom.addEventListener('drop', async function(e) {
            const files = e.dataTransfer.files;
            
            if (!files || files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              
              if (!file.type.startsWith('image/')) {
                continue;
              }
              
              if (file.size > 10 * 1024 * 1024) {
                showToast(`å›¾ç‰‡ ${file.name} å¤§å°è¶…è¿‡10MBï¼Œå·²è·³è¿‡`, 'error');
                continue;
              }
              
              try {
                const imageUrl = await uploadImageToServer(file);
                if (wangEditor && wangEditor.insertNode) {
                  const imageNode = {
                    type: 'image',
                    src: imageUrl,
                    alt: file.name,
                    href: ''
                  };
                  wangEditor.insertNode(imageNode);
                } else if (wangEditor && wangEditor.dangerouslyInsertHtml) {
                  wangEditor.dangerouslyInsertHtml(`<img src="${imageUrl}" alt="${file.name}" />`);
                }
                showToast(`å›¾ç‰‡ ${file.name} ä¸Šä¼ æˆåŠŸ`, 'success');
              } catch (error) {
                showToast(`å›¾ç‰‡ ${file.name} ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                console.error('æ‹–æ”¾ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
              }
            }
          });
        }
        
        console.log('WangEditor v5ç¼–è¾‘å™¨åˆå§‹åŒ–æˆåŠŸ', {
          editor: wangEditor,
          container: document.getElementById('wang-editor-container'),
          toolbar: document.getElementById('wang-editor-toolbar')
        });
      } catch (error) {
        console.error('åˆå§‹åŒ–WangEditorç¼–è¾‘å™¨å¤±è´¥:', error);
        console.error('é”™è¯¯è¯¦æƒ…:', {
          message: error.message,
          stack: error.stack,
          windowWangEditor: typeof window.wangEditor,
          wangEditor: typeof wangEditor
        });
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯å¹¶æ¢å¤å®¹å™¨
        const editorContainer = document.getElementById('postHtmlContent');
        if (editorContainer) {
          editorContainer.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #ef4444; border: 1px solid #ef4444; border-radius: 0.375rem; background: #fef2f2;">
              <p style="margin: 0 0 1rem 0; font-weight: 500;">ç¼–è¾‘å™¨åŠ è½½å¤±è´¥</p>
              <p style="margin: 0; font-size: 0.875rem;">${error.message}</p>
              <p style="margin: 1rem 0 0 0; font-size: 0.875rem;">è¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚</p>
            </div>
          `;
        }
        showToast('HTMLç¼–è¾‘å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // Video handlerå·²é›†æˆåˆ°WangEditoré…ç½®ä¸­ï¼Œæ­¤å‡½æ•°ä¿ç•™ç”¨äºå…¼å®¹
    function initVideoHandler() {
                  // åˆ›å»ºè§†é¢‘æ’å…¥å¯¹è¯æ¡†ï¼ˆWangEditorå·²æ”¯æŒè§†é¢‘ä¸Šä¼ ï¼‰
                  const dialog = document.createElement('div');
                  dialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 10000; min-width: 400px; max-width: 600px;';
                  
                  dialog.innerHTML = `
                    <h3 style="margin-top: 0; margin-bottom: 1rem; color: #333;">æ’å…¥è§†é¢‘</h3>
                    <div style="margin-bottom: 1rem;">
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">è§†é¢‘URLï¼š</label>
                      <input type="text" id="videoUrlInput" placeholder="è¾“å…¥è§†é¢‘URL" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">æˆ–ä¸Šä¼ è§†é¢‘æ–‡ä»¶ï¼š</label>
                      <input type="file" id="videoFileInput" accept="video/*" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">è§†é¢‘æ ¼å¼ï¼š</label>
                      <select id="videoFormatSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; box-sizing: border-box;">
                        <option value="video-tag">æ–¹å¼1: videoæ ‡ç­¾ï¼ˆå¸¦srcï¼Œç¬¦åˆç¤ºä¾‹æ ¼å¼ï¼‰</option>
                        <option value="video-source">æ–¹å¼2: videoæ ‡ç­¾ï¼ˆå¸¦sourceï¼‰</option>
                        <option value="youtube-iframe">æ–¹å¼3: YouTube iframeåµŒå…¥</option>
                        <option value="video-link">æ–¹å¼4: è§†é¢‘é“¾æ¥</option>
                      </select>
                      <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        æ–¹å¼1æ ¼å¼ï¼š&lt;video src="..." poster="..."&gt;&lt;/video&gt;
                      </p>
                    </div>
                    <div style="margin-bottom: 1rem;" id="posterUrlContainer">
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">å°é¢å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰ï¼š</label>
                      <input type="text" id="posterUrlInput" placeholder="è¾“å…¥å°é¢å›¾ç‰‡URL" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; box-sizing: border-box;">
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                      <button id="videoInsertCancel" style="padding: 0.5rem 1rem; background: #e5e7eb; border: none; border-radius: 0.25rem; cursor: pointer;">å–æ¶ˆ</button>
                      <button id="videoInsertConfirm" style="padding: 0.5rem 1rem; background: #9333ea; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">æ’å…¥</button>
                    </div>
                  `;
                  
                  // æ·»åŠ é®ç½©å±‚
                  const overlay = document.createElement('div');
                  overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;';
                  
                  document.body.appendChild(overlay);
                  document.body.appendChild(dialog);
                  
                  // æ ¹æ®æ ¼å¼é€‰æ‹©æ˜¾ç¤º/éšè—å°é¢è¾“å…¥æ¡†
                  const formatSelect = dialog.querySelector('#videoFormatSelect');
                  const posterContainer = dialog.querySelector('#posterUrlContainer');
                  const urlInput = dialog.querySelector('#videoUrlInput');
                  
                  // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€
                  if (formatSelect.value === 'video-tag' || formatSelect.value === 'video-source') {
                    posterContainer.style.display = 'block';
                  } else {
                    posterContainer.style.display = 'none';
                  }
                  
                  formatSelect.addEventListener('change', function() {
                    if (this.value === 'video-tag' || this.value === 'video-source') {
                      posterContainer.style.display = 'block';
                    } else {
                      posterContainer.style.display = 'none';
                    }
                    
                    // å¦‚æœæ˜¯YouTubeæ ¼å¼ï¼Œæ›´æ–°æç¤º
                    if (this.value === 'youtube-iframe') {
                      urlInput.placeholder = 'è¾“å…¥YouTubeè§†é¢‘URLæˆ–è§†é¢‘IDï¼ˆå¦‚ï¼šhttps://www.youtube.com/watch?v=VIDEO_ID æˆ– VIDEO_IDï¼‰';
                    } else {
                      urlInput.placeholder = 'è¾“å…¥è§†é¢‘URL';
                    }
                  });
                  
                  // æ·»åŠ è¿›åº¦æ˜¾ç¤ºå…ƒç´ 
                  const progressContainer = document.createElement('div');
                  progressContainer.id = 'videoUploadProgress';
                  progressContainer.style.cssText = 'display: none; margin-top: 1rem; margin-bottom: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.25rem; border: 1px solid #e5e7eb;';
                  progressContainer.innerHTML = `
                    <div style="margin-bottom: 0.5rem; font-weight: 600; color: #333; font-size: 0.875rem;">è§†é¢‘ä¸Šä¼ è¿›åº¦</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <div style="flex: 1; height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden;">
                        <div id="videoUploadProgressBar" style="height: 100%; background: linear-gradient(90deg, #9333ea, #a855f7); width: 0%; transition: width 0.3s ease;"></div>
                      </div>
                      <span id="videoUploadStatus" style="font-size: 0.875rem; color: #6b7280; white-space: nowrap; min-width: 80px; text-align: right; font-weight: 500;">0%</span>
                    </div>
                    <div id="videoUploadMessage" style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">å‡†å¤‡ä¸Šä¼ ...</div>
                  `;
                  // æ’å…¥åˆ°posterè¾“å…¥æ¡†ä¹‹åï¼ŒæŒ‰é’®ä¹‹å‰ï¼ˆposterContainerå·²åœ¨ä¸Šé¢å£°æ˜ï¼‰
                  if (posterContainer && posterContainer.nextSibling) {
                    posterContainer.parentNode.insertBefore(progressContainer, posterContainer.nextSibling);
                  } else {
                    // å¦‚æœæ‰¾ä¸åˆ°ï¼Œæ’å…¥åˆ°æŒ‰é’®å®¹å™¨ä¹‹å‰
                    const buttonContainer = dialog.querySelector('div[style*="flex"][style*="justify-content: flex-end"]');
                    if (buttonContainer && buttonContainer.parentNode) {
                      buttonContainer.parentNode.insertBefore(progressContainer, buttonContainer);
                    } else {
                      // æœ€åçš„åå¤‡æ–¹æ¡ˆï¼šæ’å…¥åˆ°å¯¹è¯æ¡†å†…å®¹çš„æœ€å
                      dialog.appendChild(progressContainer);
                    }
                  }
                  
                  // ä¸Šä¼ çŠ¶æ€æ ‡å¿—ï¼ˆåœ¨å¯¹è¯æ¡†ä½œç”¨åŸŸå†…ï¼‰
                  let isUploading = false;
                  
                  // ç¦ç”¨/å¯ç”¨å¯¹è¯æ¡†æ§ä»¶çš„è¾…åŠ©å‡½æ•°
                  function setDialogControlsEnabled(enabled) {
                    isUploading = !enabled;
                    const urlInput = dialog.querySelector('#videoUrlInput');
                    const fileInput = dialog.querySelector('#videoFileInput');
                    const formatSelect = dialog.querySelector('#videoFormatSelect');
                    const posterInput = dialog.querySelector('#posterUrlInput');
                    const cancelBtn = dialog.querySelector('#videoInsertCancel');
                    const confirmBtn = dialog.querySelector('#videoInsertConfirm');
                    
                    const controls = [urlInput, fileInput, formatSelect, posterInput, cancelBtn, confirmBtn];
                    controls.forEach(control => {
                      if (control) {
                        control.disabled = !enabled;
                        if (control.style) {
                          control.style.opacity = enabled ? '1' : '0.6';
                          control.style.cursor = enabled ? '' : 'not-allowed';
                        }
                      }
                    });
                    
                    // ç¦ç”¨/å¯ç”¨é®ç½©å±‚ç‚¹å‡»ï¼ˆoverlayåœ¨å¤–éƒ¨ä½œç”¨åŸŸï¼‰
                    // overlayå˜é‡åœ¨initVideoHandlerå‡½æ•°çš„ä½œç”¨åŸŸä¸­ï¼Œè¿™é‡Œé€šè¿‡é—­åŒ…è®¿é—®
                    try {
                      if (typeof overlay !== 'undefined' && overlay) {
                        overlay.style.pointerEvents = enabled ? 'auto' : 'none';
                      }
                    } catch (e) {
                      // å¦‚æœoverlayä¸å¯è®¿é—®ï¼Œå¿½ç•¥é”™è¯¯
                    }
                  }
                  
                  // æ–‡ä»¶é€‰æ‹©å¤„ç†
                  const fileInput = dialog.querySelector('#videoFileInput');
                  fileInput.addEventListener('change', async function() {
                    const file = this.files[0];
                    if (!file) return;
                    
                    // éªŒè¯æ–‡ä»¶ç±»å‹
                    if (!file.type.startsWith('video/')) {
                      showToast('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
                      this.value = '';
                      return;
                    }
                    
                    // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ200MBï¼‰
                    if (file.size > 200 * 1024 * 1024) {
                      showToast('è§†é¢‘æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡200MB', 'error');
                      this.value = '';
                      return;
                    }
                    
                    // æ˜¾ç¤ºè¿›åº¦æ¡
                    progressContainer.style.display = 'block';
                    const progressBar = dialog.querySelector('#videoUploadProgressBar');
                    const statusSpan = dialog.querySelector('#videoUploadStatus');
                    const messageSpan = dialog.querySelector('#videoUploadMessage');
                    
                    // é‡ç½®è¿›åº¦
                    if (progressBar) progressBar.style.width = '0%';
                    if (statusSpan) {
                      statusSpan.textContent = '0%';
                      statusSpan.style.color = '#6b7280';
                    }
                    if (messageSpan) messageSpan.textContent = 'å‡†å¤‡ä¸Šä¼ ...';
                    
                    // ç¦ç”¨æ‰€æœ‰æ§ä»¶ï¼Œé˜²æ­¢ç”¨æˆ·æ“ä½œ
                    setDialogControlsEnabled(false);
                    
                    // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
                    const ext = file.name.split('.').pop().toLowerCase();
                    const needsConversion = ext !== 'mp4';
                    
                    try {
                      // ä¸Šä¼ è§†é¢‘ï¼ˆå¸¦è¿›åº¦å›è°ƒï¼‰- è¿›åº¦å·²åˆå¹¶ä¸º0-100%
                      const videoInfo = await uploadVideoToServer(file, (progress, message) => {
                        // ç¡®ä¿è¿›åº¦æ¡å’ŒçŠ¶æ€å…ƒç´ å­˜åœ¨
                        if (progressBar) {
                          progressBar.style.width = Math.min(Math.max(progress, 0), 100) + '%';
                        }
                        if (statusSpan) {
                          statusSpan.textContent = `${Math.round(progress)}%`;
                          // æ›´æ–°é¢œè‰²
                          if (progress >= 100) {
                            statusSpan.style.color = '#10b981'; // ç»¿è‰²è¡¨ç¤ºå®Œæˆ
                          } else {
                            statusSpan.style.color = '#6b7280'; // ç°è‰²è¡¨ç¤ºè¿›è¡Œä¸­
                          }
                        }
                        if (messageSpan && message) {
                          messageSpan.textContent = message;
                        }
                      });
                      
                      // å®Œæˆè¿›åº¦
                      if (progressBar) progressBar.style.width = '100%';
                      if (statusSpan) {
                        statusSpan.textContent = '100%';
                        statusSpan.style.color = '#10b981'; // ç»¿è‰²è¡¨ç¤ºå®Œæˆ
                      }
                      if (messageSpan) messageSpan.textContent = 'å¤„ç†å®Œæˆï¼';
                      
                      // å°†è§†é¢‘URLå¡«å……åˆ°è¾“å…¥æ¡†ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»"æ’å…¥"æŒ‰é’®
                      dialog.querySelector('#videoUrlInput').value = videoInfo.url;
                      
                      // å¦‚æœæœ‰poster URLï¼Œè‡ªåŠ¨å¡«å……åˆ°posterè¾“å…¥æ¡†
                      if (videoInfo.posterUrl) {
                        dialog.querySelector('#posterUrlInput').value = videoInfo.posterUrl;
                        // ç¡®ä¿posterè¾“å…¥æ¡†å¯è§ï¼ˆå¦‚æœæ ¼å¼æ”¯æŒï¼‰
                        // ä½¿ç”¨dialogé‡æ–°æŸ¥è¯¢ï¼Œé¿å…ä½œç”¨åŸŸé—®é¢˜
                        const posterContainerEl = dialog.querySelector('#posterUrlContainer');
                        if (posterContainerEl && (formatSelect.value === 'video-tag' || formatSelect.value === 'video-source')) {
                          posterContainerEl.style.display = 'block';
                        }
                      }
                      
                      const successMessage = videoInfo.converted 
                        ? 'è§†é¢‘ä¸Šä¼ æˆåŠŸï¼Œå·²è‡ªåŠ¨è½¬æ¢ä¸ºMP4æ ¼å¼ï¼Œè¯·ç‚¹å‡»"æ’å…¥"æŒ‰é’®æ’å…¥è§†é¢‘'
                        : 'è§†é¢‘ä¸Šä¼ æˆåŠŸï¼Œè¯·ç‚¹å‡»"æ’å…¥"æŒ‰é’®æ’å…¥è§†é¢‘';
                      showToast(successMessage, 'success');
                      
                      // æ¢å¤æ‰€æœ‰æ§ä»¶
                      setDialogControlsEnabled(true);
                      
                      // ä¸è‡ªåŠ¨å…³é—­å¯¹è¯æ¡†ï¼Œç­‰å¾…ç”¨æˆ·ç‚¹å‡»"æ’å…¥"æŒ‰é’®
                    } catch (error) {
                      // æ˜¾ç¤ºé”™è¯¯
                      if (progressBar) progressBar.style.width = '0%';
                      if (statusSpan) {
                        statusSpan.textContent = 'å¤±è´¥';
                        statusSpan.style.color = '#ef4444'; // çº¢è‰²è¡¨ç¤ºé”™è¯¯
                      }
                      if (messageSpan) messageSpan.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
                      
                      // æ¢å¤æ‰€æœ‰æ§ä»¶
                      setDialogControlsEnabled(true);
                      
                      // æ£€æŸ¥æ˜¯å¦æ˜¯æ ¼å¼ä¸å…¼å®¹é”™è¯¯
                      let errorMessage = error.message;
                      if (errorMessage.includes('æ ¼å¼ä¸å…¼å®¹') || errorMessage.includes('æ— æ³•è½¬æ¢ä¸ºMP4')) {
                        errorMessage = `è§†é¢‘æ ¼å¼ä¸å…¼å®¹ï¼š${errorMessage}ã€‚å»ºè®®ä½¿ç”¨MP4æ ¼å¼çš„è§†é¢‘æ–‡ä»¶ã€‚`;
                      } else if (errorMessage.includes('ffmpeg')) {
                        errorMessage = `è§†é¢‘è½¬æ¢å¤±è´¥ï¼š${errorMessage}ã€‚è¯·ç¡®ä¿æœåŠ¡å™¨å·²å®‰è£…ffmpegï¼Œæˆ–ä½¿ç”¨MP4æ ¼å¼çš„è§†é¢‘æ–‡ä»¶ã€‚`;
                      }
                      
                      showToast('è§†é¢‘ä¸Šä¼ å¤±è´¥: ' + errorMessage, 'error');
                      
                      // 5ç§’åé‡ç½®çŠ¶æ€æ–‡æœ¬é¢œè‰²
                      setTimeout(() => {
                        if (statusSpan) {
                          statusSpan.style.color = '#6b7280';
                        }
                      }, 5000); // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º5ç§’
                    }
                  });
                  
                  // ç¡®è®¤æŒ‰é’®å¤„ç†
                  dialog.querySelector('#videoInsertConfirm').addEventListener('click', function() {
                    const videoUrl = dialog.querySelector('#videoUrlInput').value.trim();
                    const format = formatSelect.value;
                    let posterUrl = dialog.querySelector('#posterUrlInput').value.trim();
                    
                    if (!videoUrl) {
                      showToast('è¯·è¾“å…¥è§†é¢‘URLæˆ–é€‰æ‹©è§†é¢‘æ–‡ä»¶', 'error');
                      return;
                    }
                    
                    // éªŒè¯poster URLï¼ˆå¿…é¡»æ˜¯å›¾ç‰‡ï¼Œä¸èƒ½æ˜¯è§†é¢‘ï¼‰
                    if (posterUrl) {
                      const fullPosterUrl = ensureFullUrl(posterUrl);
                      if (!isValidPosterUrl(fullPosterUrl)) {
                        showToast('å°é¢å›¾ç‰‡URLä¸èƒ½æ˜¯è§†é¢‘æ–‡ä»¶ï¼Œè¯·è¾“å…¥å›¾ç‰‡URLï¼ˆå¦‚.jpgã€.pngç­‰ï¼‰', 'error');
                        return;
                      }
                    }
                    
                    // å¦‚æœæ˜¯YouTubeæ ¼å¼ï¼ŒéªŒè¯URLæ ¼å¼
                    if (format === 'youtube-iframe') {
                      const youtubePattern = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                      if (!youtubePattern.test(videoUrl) && !/^[a-zA-Z0-9_-]{11}$/.test(videoUrl)) {
                        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„YouTubeè§†é¢‘URLæˆ–è§†é¢‘ID', 'error');
                        return;
                      }
                    }
                    
                    try {
                      // ç¡®ä¿URLæ˜¯å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼ˆå…¼å®¹å°ç¨‹åºç­‰ç¯å¢ƒï¼‰
                      const fullVideoUrl = ensureFullUrl(videoUrl);
                      // poster URLéªŒè¯å·²åœ¨generateVideoHtmlå‡½æ•°ä¸­å¤„ç†
                      const fullPosterUrl = posterUrl ? ensureFullUrl(posterUrl) : '';
                      
                      // æ ¹æ®é€‰æ‹©çš„æ ¼å¼ç”Ÿæˆè§†é¢‘HTMLï¼ˆä¼šè‡ªåŠ¨éªŒè¯poster URLï¼‰
                      const videoHtml = generateVideoHtml(fullVideoUrl, format, fullPosterUrl);
                      
                      // ä½¿ç”¨WangEditoræ’å…¥HTML
                      if (wangEditor && wangEditor.dangerouslyInsertHtml) {
                        wangEditor.dangerouslyInsertHtml(`<div class="video-block">${videoHtml}</div><p><br></p>`);
                      } else if (wangEditor && wangEditor.insertNode) {
                        // å¦‚æœæ”¯æŒinsertNodeï¼Œåˆ›å»ºè§†é¢‘èŠ‚ç‚¹ï¼ˆä½¿ç”¨å®Œæ•´URLï¼‰
                        // ç¡®ä¿posteræ˜¯æœ‰æ•ˆçš„å›¾ç‰‡URLï¼ˆgenerateVideoHtmlå·²ç»éªŒè¯è¿‡ï¼‰
                        const validPosterUrl = fullPosterUrl && isValidPosterUrl(fullPosterUrl) ? fullPosterUrl : '';
                        const videoNode = {
                          type: 'video',
                          src: fullVideoUrl,
                          poster: validPosterUrl
                        };
                        wangEditor.insertNode(videoNode);
                      } else {
                        // åå¤‡æ–¹æ¡ˆï¼šç›´æ¥æ’å…¥HTML
                        const currentHtml = wangEditor ? wangEditor.getHtml() : '';
                        if (wangEditor) {
                          wangEditor.setHtml(currentHtml + `<div class="video-block">${videoHtml}</div><p><br></p>`);
                        }
                      }
                      
                      showToast('è§†é¢‘æ’å…¥æˆåŠŸ', 'success');
                      
                      // å…³é—­å¯¹è¯æ¡†
                      document.body.removeChild(overlay);
                      document.body.removeChild(dialog);
                    } catch (error) {
                      console.error('æ’å…¥è§†é¢‘å¤±è´¥:', error);
                      showToast('æ’å…¥è§†é¢‘å¤±è´¥: ' + error.message, 'error');
                    }
                  });
                  
                  // å–æ¶ˆæŒ‰é’®å¤„ç†
                  dialog.querySelector('#videoInsertCancel').addEventListener('click', function() {
                    // å¦‚æœæ­£åœ¨ä¸Šä¼ ï¼Œä¸å…è®¸å…³é—­
                    if (isUploading) {
                      showToast('æ­£åœ¨ä¸Šä¼ è§†é¢‘ï¼Œè¯·ç¨å€™...', 'warning');
                      return;
                    }
                    document.body.removeChild(overlay);
                    document.body.removeChild(dialog);
                  });
                  
                  // ç‚¹å‡»é®ç½©å±‚å…³é—­
                  overlay.addEventListener('click', function() {
                    // å¦‚æœæ­£åœ¨ä¸Šä¼ ï¼Œä¸å…è®¸å…³é—­
                    if (isUploading) {
                      showToast('æ­£åœ¨ä¸Šä¼ è§†é¢‘ï¼Œè¯·ç¨å€™...', 'warning');
                      return;
                    }
                    document.body.removeChild(overlay);
                    document.body.removeChild(dialog);
                  });
                  
                  // èšç„¦URLè¾“å…¥æ¡†
                  dialog.querySelector('#videoUrlInput').focus();
    }
    
    // éšè—æ–‡ç« è¡¨å•
    function hidePostForm() {
      document.getElementById('postForm').style.display = 'none';
      // å¦‚æœæ˜¯åœ¨æ–°çª—å£ä¸­æ‰“å¼€çš„ï¼Œå…³é—­çª—å£
      if (window.opener) {
        window.close();
      }
    }

    // å¤©æ°”è·¯å†µæ•°æ®ç®¡ç†
    let weatherAttractionsCounter = 0;
    let weatherTrafficCounter = 0;
    
    // æ·»åŠ æ™¯ç‚¹å¤©æ°”
    function addWeatherAttraction(attraction = null) {
      const container = document.getElementById('weatherAttractionsList');
      const index = attraction ? attraction._index : weatherAttractionsCounter++;
      const itemId = attraction ? attraction.id : '';
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'weather-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #3b82f6;">æ™¯ç‚¹ #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeWeatherAttraction(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> åˆ é™¤
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ID</label>
            <input type="number" class="admin-form-input weather-attraction-id" value="${itemId}" placeholder="è‡ªåŠ¨ç”Ÿæˆ" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ™¯ç‚¹åç§° *</label>
            <input type="text" class="admin-form-input weather-attraction-name" value="${attraction ? escapeHtml(attraction.name || '') : ''}" placeholder="å¦‚ï¼šé‡‘å­—å¡”" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ¸©åº¦ (Â°C) *</label>
            <input type="number" class="admin-form-input weather-attraction-temperature" value="${attraction ? attraction.temperature || '' : ''}" placeholder="å¦‚ï¼š36" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">èƒ½è§åº¦</label>
            <input type="text" class="admin-form-input weather-attraction-visibility" value="${attraction ? escapeHtml(attraction.visibility || '') : ''}" placeholder="å¦‚ï¼šé«˜ã€ä¸­ã€ä½" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ç´«å¤–çº¿æŒ‡æ•°</label>
            <input type="number" class="admin-form-input weather-attraction-uvIndex" value="${attraction ? attraction.uvIndex || '' : ''}" placeholder="å¦‚ï¼š10" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">é£é€Ÿ</label>
            <input type="text" class="admin-form-input weather-attraction-windSpeed" value="${attraction ? escapeHtml(attraction.windSpeed || '') : ''}" placeholder="å¦‚ï¼š3çº§" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
        </div>
        <div class="admin-form-group" style="margin-bottom: 0; margin-top: 0.75rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          <label class="admin-form-label" style="font-size: 0.875rem;">å»ºè®®</label>
          <textarea class="admin-form-input weather-attraction-suggestion" rows="2" placeholder="å¦‚ï¼šæ—©æ™¨ 8 ç‚¹å‰å»ï¼Œå¸¦è¶³æ°´ã€‚" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;">${attraction ? escapeHtml(attraction.suggestion || '') : ''}</textarea>
        </div>
      `;
      
      container.appendChild(itemDiv);
    }
    
    // åˆ é™¤æ™¯ç‚¹å¤©æ°”
    function removeWeatherAttraction(index) {
      const container = document.getElementById('weatherAttractionsList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ™¯ç‚¹å—ï¼Ÿ')) {
        item.remove();
      }
    }
    
    // æ·»åŠ è·¯å†µä¿¡æ¯
    function addWeatherTraffic(traffic = null) {
      const container = document.getElementById('weatherTrafficList');
      const index = traffic ? traffic._index : weatherTrafficCounter++;
      const itemId = traffic ? traffic.id : '';
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'weather-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #3b82f6;">è·¯å†µ #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeWeatherTraffic(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> åˆ é™¤
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ID</label>
            <input type="number" class="admin-form-input weather-traffic-id" value="${itemId}" placeholder="è‡ªåŠ¨ç”Ÿæˆ" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ—¶é—´ *</label>
            <input type="text" class="admin-form-input weather-traffic-time" value="${traffic ? escapeHtml(traffic.time || '') : ''}" placeholder="å¦‚ï¼š10:30" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ç±»å‹ *</label>
            <select class="admin-form-select weather-traffic-type" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
              <option value="è½¦ç¥¸" ${traffic && traffic.type === 'è½¦ç¥¸' ? 'selected' : ''}>è½¦ç¥¸</option>
              <option value="æ–½å·¥" ${traffic && traffic.type === 'æ–½å·¥' ? 'selected' : ''}>æ–½å·¥</option>
              <option value="å¤©æ°”" ${traffic && traffic.type === 'å¤©æ°”' ? 'selected' : ''}>å¤©æ°”</option>
              <option value="æ‹¥å µ" ${traffic && traffic.type === 'æ‹¥å µ' ? 'selected' : ''}>æ‹¥å µ</option>
              <option value="å…¶ä»–" ${traffic && traffic.type === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
            </select>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; grid-column: 1 / -1; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">åœ°ç‚¹ *</label>
            <input type="text" class="admin-form-input weather-traffic-location" value="${traffic ? escapeHtml(traffic.location || '') : ''}" placeholder="å¦‚ï¼šç¯åŸè·¯ Maadi å‡ºå£æ–¹å‘" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; grid-column: 1 / -1; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ¶ˆæ¯ *</label>
            <textarea class="admin-form-input weather-traffic-message" rows="2" placeholder="å¦‚ï¼šå‘ç”Ÿè¿½å°¾ï¼Œæåº¦æ‹¥å µã€‚" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;">${traffic ? escapeHtml(traffic.message || '') : ''}</textarea>
          </div>
        </div>
      `;
      
      container.appendChild(itemDiv);
    }
    
    // åˆ é™¤è·¯å†µä¿¡æ¯
    function removeWeatherTraffic(index) {
      const container = document.getElementById('weatherTrafficList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è·¯å†µä¿¡æ¯å—ï¼Ÿ')) {
        item.remove();
      }
    }
    
    // æ·»åŠ æ±‡ç‡è½¬æ¢é¡¹
    function addExchangeRate(rate = null) {
      const container = document.getElementById('exchangeRatesList');
      const index = rate ? rate._index : exchangeRatesCounter++;
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'exchange-rate-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #10b981;">æ±‡ç‡ #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeExchangeRate(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> åˆ é™¤
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æºè´§å¸ *</label>
            <input type="text" class="admin-form-input exchange-rate-from" value="${rate ? escapeHtml(rate.fromCurrency || '') : ''}" placeholder="å¦‚ï¼šCNY" pattern="^[A-Z]{3}$" maxlength="3" style="font-size: 0.875rem; text-transform: uppercase; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">3ä½å¤§å†™å­—æ¯</small>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ç›®æ ‡è´§å¸ *</label>
            <input type="text" class="admin-form-input exchange-rate-to" value="${rate ? escapeHtml(rate.toCurrency || '') : ''}" placeholder="å¦‚ï¼šEGP" pattern="^[A-Z]{3}$" maxlength="3" style="font-size: 0.875rem; text-transform: uppercase; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">3ä½å¤§å†™å­—æ¯</small>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ±‡ç‡ *</label>
            <input type="number" class="admin-form-input exchange-rate-value" value="${rate ? escapeHtml(rate.rate || '') : ''}" placeholder="å¦‚ï¼š6.74" step="0.0001" min="0" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">1æºè´§å¸=?ç›®æ ‡è´§å¸</small>
          </div>
        </div>
      `;
      
      container.appendChild(itemDiv);
      
      // è‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™
      const fromInput = itemDiv.querySelector('.exchange-rate-from');
      const toInput = itemDiv.querySelector('.exchange-rate-to');
      fromInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
      toInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
    }
    
    // åˆ é™¤æ±‡ç‡è½¬æ¢é¡¹
    function removeExchangeRate(index) {
      const container = document.getElementById('exchangeRatesList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ±‡ç‡å—ï¼Ÿ')) {
        item.remove();
      }
    }
    
    // åŠ è½½ç‰¹æ®Šç±»åˆ«æ•°æ®åˆ°è¡¨å•
    function loadSpecialCategoryData(specialType, originalData) {
      if (specialType === 'translation') {
        document.getElementById('translationChinese').value = originalData.chinese || '';
        document.getElementById('translationArabic').value = originalData.arabic || '';
        document.getElementById('translationCategory').value = originalData.category || '';
      } else if (specialType === 'weather') {
        // åŠ è½½globalAlert
        if (originalData.globalAlert) {
          document.getElementById('weatherGlobalAlertLevel').value = originalData.globalAlert.level || 'medium';
          document.getElementById('weatherGlobalAlertMessage').value = originalData.globalAlert.message || '';
        }
        
        // åŠ è½½attractions
        const attractionsContainer = document.getElementById('weatherAttractionsList');
        attractionsContainer.innerHTML = '';
        weatherAttractionsCounter = 0;
        if (originalData.attractions && Array.isArray(originalData.attractions)) {
          originalData.attractions.forEach((attraction, index) => {
            attraction._index = index;
            addWeatherAttraction(attraction);
            weatherAttractionsCounter++;
          });
        }
        
        // åŠ è½½traffic
        const trafficContainer = document.getElementById('weatherTrafficList');
        trafficContainer.innerHTML = '';
        weatherTrafficCounter = 0;
        if (originalData.traffic && Array.isArray(originalData.traffic)) {
          originalData.traffic.forEach((traffic, index) => {
            traffic._index = index;
            addWeatherTraffic(traffic);
            weatherTrafficCounter++;
          });
        }
      } else if (specialType === 'exchange-rate') {
        // åŠ è½½æ‰€æœ‰è´§å¸æ±‡ç‡
        const ratesContainer = document.getElementById('exchangeRatesList');
        ratesContainer.innerHTML = '';
        exchangeRatesCounter = 0;
        
        // éå†originalDataä¸­çš„æ‰€æœ‰è´§å¸å­—æ®µï¼ˆCNY, USD, EURç­‰ï¼‰
        Object.keys(originalData).forEach(currency => {
          // è·³è¿‡æ ‡å‡†å­—æ®µ
          if (['id', 'name', 'title', 'slug', 'excerpt', 'description', 'htmlContent', 'image', 'category', 'tags', 'published', 'views', 'createdAt', 'updatedAt', 'detailApi', 'updateTime'].includes(currency)) {
            return;
          }
          
          // å¦‚æœè¯¥å­—æ®µæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆåŒ…å«ç›®æ ‡è´§å¸å’Œæ±‡ç‡ï¼‰
          if (originalData[currency] && typeof originalData[currency] === 'object' && !Array.isArray(originalData[currency])) {
            // éå†è¯¥è´§å¸çš„æ‰€æœ‰ç›®æ ‡è´§å¸
            Object.keys(originalData[currency]).forEach(targetCurrency => {
              const rate = originalData[currency][targetCurrency];
              addExchangeRate({
                fromCurrency: currency,
                toCurrency: targetCurrency,
                rate: rate
              });
              exchangeRatesCounter++;
            });
          }
        });
        
        // å¦‚æœæ²¡æœ‰æ±‡ç‡æ•°æ®ï¼Œè‡³å°‘æ·»åŠ ä¸€è¡Œç©ºè¡Œ
        if (exchangeRatesCounter === 0) {
          addExchangeRate();
        }
        
        // åŠ è½½æ›´æ–°æ—¶é—´
        if (originalData.updateTime) {
          const date = new Date(originalData.updateTime);
          const localDateTime = date.toISOString().slice(0, 16);
          document.getElementById('exchangeUpdateTime').value = localDateTime;
        }
      }
    }
    
    // ä»è¡¨å•æ”¶é›†ç‰¹æ®Šç±»åˆ«æ•°æ®
    function collectSpecialCategoryData(specialType) {
      const data = {};
      
      if (specialType === 'translation') {
        data.chinese = document.getElementById('translationChinese').value.trim();
        data.arabic = document.getElementById('translationArabic').value.trim();
        data.category = document.getElementById('translationCategory').value.trim();
        
        if (!data.chinese || !data.arabic) {
          throw new Error('ä¸­æ–‡å’Œé˜¿æ‹‰ä¼¯æ–‡ä¸ºå¿…å¡«é¡¹');
        }
      } else if (specialType === 'weather') {
        // æ”¶é›†globalAlert
        const alertLevel = document.getElementById('weatherGlobalAlertLevel').value;
        const alertMessage = document.getElementById('weatherGlobalAlertMessage').value.trim();
        
        if (!alertMessage) {
          throw new Error('é¢„è­¦æ¶ˆæ¯ä¸ºå¿…å¡«é¡¹');
        }
        
        data.globalAlert = {
          level: alertLevel,
          message: alertMessage
        };
        
        // æ”¶é›†attractions
        const attractionsContainer = document.getElementById('weatherAttractionsList');
        const attractionItems = attractionsContainer.querySelectorAll('.weather-item');
        data.attractions = [];
        
        attractionItems.forEach((item, index) => {
          const idInput = item.querySelector('.weather-attraction-id');
          const nameInput = item.querySelector('.weather-attraction-name');
          const tempInput = item.querySelector('.weather-attraction-temperature');
          const visibilityInput = item.querySelector('.weather-attraction-visibility');
          const uvIndexInput = item.querySelector('.weather-attraction-uvIndex');
          const windSpeedInput = item.querySelector('.weather-attraction-windSpeed');
          const suggestionInput = item.querySelector('.weather-attraction-suggestion');
          
          const name = nameInput.value.trim();
          const temperature = tempInput.value.trim();
          
          if (!name || !temperature) {
            throw new Error(`æ™¯ç‚¹ #${index + 1}ï¼šåç§°å’Œæ¸©åº¦ä¸ºå¿…å¡«é¡¹`);
          }
          
          const attraction = {
            id: idInput.value ? parseInt(idInput.value) : index + 1,
            name: name,
            temperature: parseInt(temperature),
            visibility: visibilityInput.value.trim() || undefined,
            uvIndex: uvIndexInput.value ? parseInt(uvIndexInput.value) : undefined,
            windSpeed: windSpeedInput.value.trim() || undefined,
            suggestion: suggestionInput.value.trim() || undefined
          };
          
          // ç§»é™¤undefinedå­—æ®µ
          Object.keys(attraction).forEach(key => {
            if (attraction[key] === undefined) {
              delete attraction[key];
            }
          });
          
          data.attractions.push(attraction);
        });
        
        // æ”¶é›†traffic
        const trafficContainer = document.getElementById('weatherTrafficList');
        const trafficItems = trafficContainer.querySelectorAll('.weather-item');
        data.traffic = [];
        
        trafficItems.forEach((item, index) => {
          const idInput = item.querySelector('.weather-traffic-id');
          const timeInput = item.querySelector('.weather-traffic-time');
          const typeInput = item.querySelector('.weather-traffic-type');
          const locationInput = item.querySelector('.weather-traffic-location');
          const messageInput = item.querySelector('.weather-traffic-message');
          
          const time = timeInput.value.trim();
          const type = typeInput.value;
          const location = locationInput.value.trim();
          const message = messageInput.value.trim();
          
          if (!time || !type || !location || !message) {
            throw new Error(`è·¯å†µ #${index + 1}ï¼šæ—¶é—´ã€ç±»å‹ã€åœ°ç‚¹å’Œæ¶ˆæ¯ä¸ºå¿…å¡«é¡¹`);
          }
          
          const traffic = {
            id: idInput.value ? parseInt(idInput.value) : index + 1,
            time: time,
            type: type,
            location: location,
            message: message
          };
          
          data.traffic.push(traffic);
        });
        
        // ä¿ç•™dataå­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼Œç”¨äºåˆ—è¡¨æ˜¾ç¤ºï¼‰
        // dataå­—æ®µä¼šåœ¨åç«¯å¤„ç†æ—¶è‡ªåŠ¨ç”Ÿæˆæˆ–ä¿ç•™
      } else if (specialType === 'exchange-rate') {
        // æ”¶é›†æ‰€æœ‰æ±‡ç‡é¡¹
        const ratesContainer = document.getElementById('exchangeRatesList');
        const rateItems = ratesContainer.querySelectorAll('.exchange-rate-item');
        
        // æ„å»ºæ±‡ç‡å¯¹è±¡ï¼š{CNY: {EGP: 6.74}, USD: {EGP: 30.5}, ...}
        const exchangeRates = {};
        
        rateItems.forEach((item, index) => {
          const fromInput = item.querySelector('.exchange-rate-from');
          const toInput = item.querySelector('.exchange-rate-to');
          const rateInput = item.querySelector('.exchange-rate-value');
          
          const fromCurrency = fromInput.value.trim().toUpperCase();
          const toCurrency = toInput.value.trim().toUpperCase();
          const rate = parseFloat(rateInput.value);
          
          if (!fromCurrency || !toCurrency || isNaN(rate) || rate <= 0) {
            throw new Error(`æ±‡ç‡ #${index + 1}ï¼šæºè´§å¸ã€ç›®æ ‡è´§å¸å’Œæ±‡ç‡ä¸ºå¿…å¡«é¡¹ï¼Œä¸”æ±‡ç‡å¿…é¡»å¤§äº0`);
          }
          
          // éªŒè¯è´§å¸ä»£ç æ ¼å¼
          if (!/^[A-Z]{3}$/.test(fromCurrency)) {
            throw new Error(`æ±‡ç‡ #${index + 1}ï¼šæºè´§å¸æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º3ä½å¤§å†™å­—æ¯ï¼Œå¦‚ CNYã€USDã€EGP`);
          }
          if (!/^[A-Z]{3}$/.test(toCurrency)) {
            throw new Error(`æ±‡ç‡ #${index + 1}ï¼šç›®æ ‡è´§å¸æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º3ä½å¤§å†™å­—æ¯ï¼Œå¦‚ CNYã€USDã€EGP`);
          }
          
          // å¦‚æœè¯¥æºè´§å¸å·²å­˜åœ¨ï¼Œæ·»åŠ ç›®æ ‡è´§å¸
          if (!exchangeRates[fromCurrency]) {
            exchangeRates[fromCurrency] = {};
          }
          exchangeRates[fromCurrency][toCurrency] = rate;
        });
        
        // å°†æ±‡ç‡å¯¹è±¡åˆå¹¶åˆ°dataä¸­
        Object.assign(data, exchangeRates);
        
        // æ·»åŠ æ›´æ–°æ—¶é—´
        const updateTime = document.getElementById('exchangeUpdateTime').value;
        if (updateTime) {
          data.updateTime = new Date(updateTime).toISOString();
        }
      }
      
      return data;
    }
    
    // ä¿å­˜æ–‡ç« 
    async function savePost(event) {
      event.preventDefault();
      
      const id = document.getElementById('postId').value;
      const name = document.getElementById('postName').value.trim();
      // nameå’Œtitleä¿æŒä¸€è‡´
      const title = name;
      const slug = document.getElementById('postSlug').value.trim();
      const excerpt = document.getElementById('postExcerpt').value.trim();
      const image = document.getElementById('postImage').value.trim();
      const apiName = document.getElementById('postApiName').value.trim();
      const category = document.getElementById('postCategory').value.trim();
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»åˆ«
      const specialType = isSpecialCategory(apiName);
      
      // è·å–htmlContentï¼ˆç»Ÿä¸€ä½¿ç”¨htmlContentå­—æ®µï¼‰
      let htmlContent = '';
      let specialData = null;
      
          // åªæœ‰ weatherã€exchange-rateã€translation ä¸ä½¿ç”¨ htmlContent
          // second-hand å’Œ rentals ä»ç„¶éœ€è¦ htmlContent
          const needsSpecialDataOnly = specialType && (specialType === 'weather' || specialType === 'exchange-rate' || specialType === 'translation');
          
          if (specialType) {
            // ç‰¹æ®Šç±»åˆ«ï¼šæ”¶é›†ç‰¹æ®Šæ•°æ®
            try {
              specialData = collectSpecialCategoryData(specialType);
              // åªæœ‰ weatherã€exchange-rateã€translation ä¸éœ€è¦ htmlContent
              // second-hand å’Œ rentals ä»ç„¶éœ€è¦ htmlContent
              if (!needsSpecialDataOnly) {
                // è·å–htmlContentï¼ˆsecond-hand å’Œ rentals éœ€è¦ï¼‰
                if (wangEditor) {
                  htmlContent = wangEditor.getHtml();
                  // ç¡®ä¿æ‰€æœ‰URLéƒ½æ˜¯å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼ˆå…¼å®¹å°ç¨‹åºç­‰ç¯å¢ƒï¼‰
                  htmlContent = ensureFullUrlsInHtml(htmlContent);
                  // æ¸…ç†æ‰€æœ‰base64å›¾ç‰‡å’Œè§†é¢‘
                  htmlContent = removeBase64Content(htmlContent);
                }
              } else {
                // weatherã€exchange-rateã€translation ä¸éœ€è¦ htmlContent
                htmlContent = undefined;
              }
            } catch (error) {
              showToast(error.message, 'error');
              return;
            }
          } else {
            // æ™®é€šç±»åˆ«ï¼šè·å–htmlContent
                if (wangEditor) {
                  htmlContent = wangEditor.getHtml();
                  // ç¡®ä¿æ‰€æœ‰URLéƒ½æ˜¯å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼ˆå…¼å®¹å°ç¨‹åºç­‰ç¯å¢ƒï¼‰
                  htmlContent = ensureFullUrlsInHtml(htmlContent);
                  // æ¸…ç†æ‰€æœ‰base64å›¾ç‰‡å’Œè§†é¢‘
                  htmlContent = removeBase64Content(htmlContent);
                }
          }
      
      const published = document.getElementById('postPublished').checked;

      if (!name) {
        showToast('è¯·å¡«å†™æ–‡ç« åç§°', 'error');
        return;
      }

      if (!apiName) {
        showToast('è¯·é€‰æ‹©APIï¼ˆåˆ†ç±»ï¼‰', 'error');
        return;
      }

      // åœ¨éªŒè¯å‰ï¼Œå…ˆç§»é™¤æ‰€æœ‰éšè—è¡¨å•å­—æ®µçš„requiredå±æ€§ï¼Œé¿å…æµè§ˆå™¨éªŒè¯é”™è¯¯
      const allSpecialForms = ['specialForm-second-hand', 'specialForm-rentals', 'specialForm-weather', 
                               'specialForm-exchange-rate', 'specialForm-translation'];
      allSpecialForms.forEach(formId => {
        const form = document.getElementById(formId);
        if (form && form.style.display === 'none') {
          // è¡¨å•éšè—æ—¶ï¼Œç§»é™¤å…¶ä¸­æ‰€æœ‰å­—æ®µçš„requiredå±æ€§
          const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
          inputs.forEach(input => {
            input.removeAttribute('required');
          });
        }
      });

      // éªŒè¯å¿…å¡«å­—æ®µ
      // specialType å·²ç»åœ¨ä¸Šé¢å£°æ˜è¿‡äº†ï¼ˆç¬¬2076è¡Œï¼‰ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
      const needsLocation = needsLocationFields(apiName);
      const isLocationReq = isLocationRequired(apiName);
      
      // éªŒè¯è”ç³»æ–¹å¼ï¼ˆåœ¨ç§Ÿæˆ¿ã€äºŒæ‰‹é›†å¸‚å’Œå¯»å‘³ä¸­å›½ä¸­å¿…å¡«ï¼Œé˜²éª—æŒ‡å—ç­‰å¯é€‰ï¼‰
      const needsPhone = needsPhoneField(apiName);
      // åˆ¤æ–­ç”µè¯å­—æ®µæ˜¯å¦ä¸ºå¿…å¡«ï¼ˆå¯»å‘³ä¸­å›½å¿…å¡«ï¼Œé˜²éª—æŒ‡å—ç­‰å¯é€‰ï¼‰
      const lowerNameForPhone = apiName.toLowerCase();
      const isPhoneRequired = lowerNameForPhone.includes('chinese-food') || 
                              lowerNameForPhone.includes('å¯»å‘³') ||
                              specialType === 'second-hand' || 
                              specialType === 'rentals';
      
      if (needsPhone && isPhoneRequired) {
        let phoneInput;
        if (specialType === 'second-hand') {
          phoneInput = document.getElementById('secondHandPhone');
        } else if (specialType === 'rentals') {
          phoneInput = document.getElementById('rentalsPhone');
        } else {
          // å¯»å‘³ä¸­å›½ç­‰å…¶ä»–åˆ†ç±»ä½¿ç”¨é€šç”¨ç”µè¯å­—æ®µ
          phoneInput = document.getElementById('commonPhone');
        }
        
        // æ£€æŸ¥å­—æ®µæ˜¯å¦å¯è§ï¼ˆä¸åœ¨éšè—çš„è¡¨å•ä¸­ï¼‰
        if (phoneInput) {
          const isVisible = phoneInput.offsetParent !== null; // æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§
          if (isVisible && !phoneInput.value.trim()) {
            showToast('è”ç³»æ–¹å¼æ˜¯å¿…å¡«é¡¹', 'error');
            phoneInput.focus();
            return;
          }
        }
      }
      
      // éªŒè¯ä½ç½®ä¿¡æ¯ï¼ˆåªåœ¨å¿…å¡«åˆ†ç±»ä¸­éªŒè¯ï¼‰
      if (needsLocation && isLocationReq) {
        let addressInput, latInput, lngInput;
        
        if (specialType === 'second-hand') {
          addressInput = document.getElementById('secondHandAddress');
          latInput = document.getElementById('secondHandLatitude');
          lngInput = document.getElementById('secondHandLongitude');
        } else if (specialType === 'rentals') {
          addressInput = document.getElementById('rentalsAddress');
          latInput = document.getElementById('rentalsLatitude');
          lngInput = document.getElementById('rentalsLongitude');
        } else {
          addressInput = document.getElementById('commonAddress');
          latInput = document.getElementById('commonLatitude');
          lngInput = document.getElementById('commonLongitude');
        }
        
        // åªéªŒè¯å¯è§çš„å­—æ®µ
        if (addressInput) {
          const isVisible = addressInput.offsetParent !== null;
          if (isVisible && !addressInput.value.trim()) {
            showToast('åœ°å€æ˜¯å¿…å¡«é¡¹', 'error');
            addressInput.focus();
            return;
          }
        }
        if (latInput) {
          const isVisible = latInput.offsetParent !== null;
          if (isVisible && !latInput.value.trim()) {
            showToast('çº¬åº¦æ˜¯å¿…å¡«é¡¹', 'error');
            latInput.focus();
            return;
          }
        }
        if (lngInput) {
          const isVisible = lngInput.offsetParent !== null;
          if (isVisible && !lngInput.value.trim()) {
            showToast('ç»åº¦æ˜¯å¿…å¡«é¡¹', 'error');
            lngInput.focus();
            return;
          }
        }
      }

      if (!category) {
        showToast('è¯·å¡«å†™åˆ†ç±»/æ ‡ç­¾', 'error');
        return;
      }

      try {
        // ç›´æ¥ä½¿ç”¨idï¼ˆidç°åœ¨æ˜¯å…¨å±€å”¯ä¸€çš„UUIDï¼‰
        // å¦‚æœIDä¸ºç©ºå­—ç¬¦ä¸²æˆ–null/undefinedï¼Œåˆ™åˆ›å»ºæ–°æ–‡ç« 
        const hasId = id && id.trim() !== '';
        const url = hasId ? `${BLOG_ADMIN_API}/posts/${id}` : `${BLOG_ADMIN_API}/posts`;
        const method = hasId ? 'PUT' : 'POST';
        
        const requestBody = {
          name,
          title: title, // nameå’Œtitleä¿æŒä¸€è‡´
          slug: slug || undefined,
          excerpt,
          image: image || undefined,
          apiName: apiName, // APIåç§°ï¼ˆç”¨äºç¡®å®šæ•°æ®å­˜å‚¨ä½ç½®ï¼‰
          category: category, // åˆ†ç±»/æ ‡ç­¾ï¼ˆç”¨äºåšå®¢å±•ç¤ºï¼Œæ›¿ä»£åŸæ¥çš„tagså­—æ®µï¼‰
          published
        };
        
        // æ·»åŠ ç‰¹æ®Šå­—æ®µï¼ˆäºŒæ‰‹å¸‚åœºå’Œç§Ÿæˆ¿é…’åº—ï¼‰
        // specialType å’Œ needsLocation å·²ç»åœ¨ä¸Šé¢å£°æ˜è¿‡äº†ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
        
        if (specialType === 'second-hand') {
          const price = document.getElementById('secondHandPrice').value.trim();
          const phone = document.getElementById('secondHandPhone').value.trim();
          const address = document.getElementById('secondHandAddress').value.trim();
          const latitude = document.getElementById('secondHandLatitude').value.trim();
          const longitude = document.getElementById('secondHandLongitude').value.trim();
          // å³ä½¿å­—æ®µä¸ºç©ºä¹Ÿè¦å‘é€ï¼Œä»¥ä¾¿åç«¯å¯ä»¥åˆ é™¤è¿™äº›å­—æ®µ
          requestBody.price = price || null;
          requestBody.phone = phone || null;
          requestBody.address = address || null;
          requestBody.latitude = latitude ? parseFloat(latitude) : null;
          requestBody.longitude = longitude ? parseFloat(longitude) : null;
        } else if (specialType === 'rentals') {
          const price = document.getElementById('rentalsPrice').value.trim();
          const rooms = document.getElementById('rentalsRooms').value.trim();
          const area = document.getElementById('rentalsArea').value.trim();
          const views = document.getElementById('rentalsViews').value.trim();
          const phone = document.getElementById('rentalsPhone').value.trim();
          const address = document.getElementById('rentalsAddress').value.trim();
          const latitude = document.getElementById('rentalsLatitude').value.trim();
          const longitude = document.getElementById('rentalsLongitude').value.trim();
          // å³ä½¿å­—æ®µä¸ºç©ºä¹Ÿè¦å‘é€ï¼Œä»¥ä¾¿åç«¯å¯ä»¥åˆ é™¤è¿™äº›å­—æ®µ
          requestBody.price = price || null;
          requestBody.rooms = rooms || null;
          requestBody.area = area || null;
          requestBody.views = views ? parseInt(views) || 0 : null;
          requestBody.phone = phone || null;
          requestBody.address = address || null;
          requestBody.latitude = latitude ? parseFloat(latitude) : null;
          requestBody.longitude = longitude ? parseFloat(longitude) : null;
        } else if (needsLocation) {
          // é€šç”¨ä½ç½®å­—æ®µï¼ˆç”¨äºå…¶ä»–éœ€è¦ä½ç½®çš„åˆ†ç±»ï¼‰
          const addressInput = document.getElementById('commonAddress');
          const latInput = document.getElementById('commonLatitude');
          const lngInput = document.getElementById('commonLongitude');
          // å³ä½¿å­—æ®µä¸ºç©ºä¹Ÿè¦å‘é€ï¼Œä»¥ä¾¿åç«¯å¯ä»¥åˆ é™¤è¿™äº›å­—æ®µ
          if (addressInput) {
            const address = addressInput.value.trim();
            requestBody.address = address || null;
          }
          if (latInput) {
            const latitude = latInput.value.trim();
            requestBody.latitude = latitude ? parseFloat(latitude) : null;
          }
          if (lngInput) {
            const longitude = lngInput.value.trim();
            requestBody.longitude = longitude ? parseFloat(longitude) : null;
          }
        }
        
        // æ·»åŠ é€šç”¨ç”µè¯å­—æ®µï¼ˆç”¨äºå¯»å‘³ä¸­å›½ç­‰åˆ†ç±»ï¼‰
        const needsPhone = needsPhoneField(apiName);
        if (needsPhone && specialType !== 'second-hand' && specialType !== 'rentals') {
          const phoneInput = document.getElementById('commonPhone');
          if (phoneInput) {
            const phone = phoneInput.value.trim();
            // å³ä½¿å­—æ®µä¸ºç©ºä¹Ÿè¦å‘é€ï¼Œä»¥ä¾¿åç«¯å¯ä»¥åˆ é™¤è¿™äº›å­—æ®µ
            requestBody.phone = phone || null;
          }
        }
        
        // å¦‚æœæ˜¯ç‰¹æ®Šç±»åˆ«ï¼Œæ·»åŠ ç‰¹æ®Šæ•°æ®
        // æ³¨æ„ï¼šsecond-hand å’Œ rentals è™½ç„¶éœ€è¦ç‰¹æ®Šå­—æ®µï¼Œä½†ä»ç„¶éœ€è¦ htmlContent
        const needsSpecialDataOnly = specialType && (specialType === 'weather' || specialType === 'exchange-rate' || specialType === 'translation');
        
        if (specialType && specialData) {
          requestBody._specialData = specialData;
          requestBody._specialType = specialType;
          
          // åªæœ‰ weatherã€exchange-rateã€translation ä¸ä½¿ç”¨ htmlContent
          // second-hand å’Œ rentals ä»ç„¶éœ€è¦ htmlContent
          if (!needsSpecialDataOnly) {
            requestBody.htmlContent = htmlContent || undefined;
          }
          
          // æ·»åŠ è°ƒè¯•ä¿¡æ¯
          console.log('ä¿å­˜ç‰¹æ®Šç±»åˆ«æ–‡ç« ', {
            specialType,
            needsSpecialDataOnly,
            specialDataKeys: Object.keys(specialData),
            specialDataPreview: JSON.stringify(specialData).substring(0, 500),
            hasHtmlContent: !needsSpecialDataOnly && htmlContent
          });
        } else {
          // æ™®é€šç±»åˆ«æ‰æ·»åŠ htmlContent
          requestBody.htmlContent = htmlContent || undefined;
        }
        
        console.log('å‘é€è¯·æ±‚', {
          url,
          method,
          requestBody: JSON.stringify(requestBody, null, 2)
        });
        
        const response = await adminApiRequest(url, {
          method,
          body: JSON.stringify(requestBody)
        });
        
        console.log('æ”¶åˆ°å“åº”', {
          success: response?.success,
          data: response?.data,
          message: response?.message
        });
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯é¢æ¿
        showDebugInfo({
          request: requestBody,
          response: response,
          specialType: specialType,
          specialData: specialData
        });
        
        if (response && response.success) {
          // æ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸä¿¡æ¯ï¼ˆåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼‰
          const debugInfo = specialType && specialData 
            ? `\nè°ƒè¯•ä¿¡æ¯ï¼š\n- ç±»å‹: ${specialType}\n- æ•°æ®é”®: ${Object.keys(specialData).join(', ')}\n- æ•°æ®é¢„è§ˆ: ${JSON.stringify(specialData).substring(0, 200)}`
            : '';
          
          console.log('ä¿å­˜æˆåŠŸ', {
            id: response.data?.id,
            name: response.data?.name,
            apiName: response.data?.category,
            debugInfo
          });
          
          showToast(id ? 'æ–‡ç« æ›´æ–°æˆåŠŸ' : 'æ–‡ç« åˆ›å»ºæˆåŠŸ', 'success');
          window.currentEditingPost = null; // æ¸…é™¤å½“å‰ç¼–è¾‘çš„æ–‡ç« 
          
          // å¦‚æœæ˜¯åœ¨æ–°çª—å£ä¸­æ‰“å¼€çš„ï¼Œåˆ·æ–°çˆ¶çª—å£å¹¶å…³é—­å½“å‰çª—å£
          if (window.opener) {
            // é€šçŸ¥çˆ¶çª—å£åˆ·æ–°å†…å®¹ï¼ˆæ ¹æ®çˆ¶çª—å£ç±»å‹è°ƒç”¨ä¸åŒçš„åˆ·æ–°æ–¹æ³•ï¼‰
            try {
              // blog-admin.html ä½¿ç”¨ loadPosts
              if (typeof window.opener.loadPosts === 'function') {
                window.opener.loadPosts(false);
              }
              // blog-detail.html ä½¿ç”¨ loadPost
              if (typeof window.opener.loadPost === 'function') {
                window.opener.loadPost();
              }
              // blog.html å¯èƒ½ä½¿ç”¨ loadPosts æˆ– loadArchiveï¼ˆå·²åœ¨çª—å£å…³é—­æ—¶å¤„ç†ï¼‰
            } catch (e) {
              console.warn('æ— æ³•é€šçŸ¥çˆ¶çª—å£åˆ·æ–°:', e);
            }
            // å»¶è¿Ÿå…³é—­ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
            setTimeout(() => {
              window.close();
            }, 1000);
          } else {
            // åœ¨å½“å‰çª—å£ä¸­ï¼Œæ­£å¸¸å¤„ç†
            hidePostForm();
            loadPosts(false); // ä¿å­˜åä¿æŒå±•å¼€çŠ¶æ€
          }
        } else {
          console.error('ä¿å­˜å¤±è´¥', response);
          showToast('ä¿å­˜å¤±è´¥: ' + (response?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜æ–‡ç« å¤±è´¥:', error);
        showToast('ä¿å­˜æ–‡ç« å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    // ç¼–è¾‘æ–‡ç« ï¼ˆåœ¨æ–°çª—å£æ‰“å¼€ï¼‰
    function editPost(id) {
      // åœ¨æ–°çª—å£æ‰“å¼€ç¼–è¾‘é¡µé¢
      const editUrl = `${window.location.pathname}?edit=${encodeURIComponent(id)}`;
      const editWindow = window.open(editUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!editWindow) {
        showToast('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
        return;
      }
      
      // ç›‘å¬æ–°çª—å£å…³é—­äº‹ä»¶ï¼Œåˆ·æ–°æ–‡ç« åˆ—è¡¨
      const checkClosed = setInterval(() => {
        if (editWindow.closed) {
          clearInterval(checkClosed);
          // åˆ·æ–°æ–‡ç« åˆ—è¡¨
          loadPosts(false);
        }
      }, 500);
    }
    
    // ç¼–è¾‘æ–‡ç« ï¼ˆå†…éƒ¨å‡½æ•°ï¼Œç”¨äºåœ¨æ–°çª—å£ä¸­åŠ è½½æ–‡ç« æ•°æ®ï¼‰
    async function editPostInternal(id) {
      const postForm = document.getElementById('postForm');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      try {
        // æ˜¾ç¤ºè¡¨å•å’ŒåŠ è½½æç¤º
        if (postForm) {
          postForm.style.display = 'block';
          postForm.classList.add('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'flex';
        }
        if (postFormContent) {
          postFormContent.style.display = 'none';
        }
        
        // åˆ‡æ¢åˆ°æ–‡ç« æ ‡ç­¾é¡µï¼ˆå¦‚æœä¸åœ¨æ–°çª—å£ï¼‰
        if (!window.opener) {
          switchTab('posts');
        }
        
        console.log('ç¼–è¾‘æ–‡ç« ï¼ŒID:', id);
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
        console.log('è·å–æ–‡ç« åˆ—è¡¨å“åº”:', response);
        
        if (response && response.success && response.data) {
          // ç›´æ¥ä½¿ç”¨idåŒ¹é…ï¼ˆidç°åœ¨æ˜¯å…¨å±€å”¯ä¸€çš„UUIDï¼‰
          const post = response.data.find(p => {
            const pId = String(p.id || '');
            const searchId = String(id || '');
            return pId === searchId;
          });
          
          console.log('æ‰¾åˆ°çš„æ–‡ç« :', post);
          
          if (post) {
            // ä¿å­˜å½“å‰æ–‡ç« å¯¹è±¡ï¼Œç”¨äºåç»­ä¿å­˜æ—¶ä½¿ç”¨
            window.currentEditingPost = post;
            // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºè¡¨å•å†…å®¹
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postFormContent) {
              postFormContent.style.display = 'block';
            }
            // å¡«å……è¡¨å•æ•°æ®
            showPostForm(post);
          } else {
            console.error('æœªæ‰¾åˆ°æ–‡ç« ï¼ŒID:', id, 'å¯ç”¨æ–‡ç« ID:', response.data.map(p => p.id));
            // éšè—åŠ è½½æç¤º
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postForm) {
              postForm.style.display = 'none';
            }
            showToast('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„æ–‡ç« ', 'error');
          }
        } else {
          console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', response);
          // éšè—åŠ è½½æç¤º
          if (postForm) {
            postForm.classList.remove('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'none';
          }
          if (postForm) {
            postForm.style.display = 'none';
          }
          showToast('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
        // éšè—åŠ è½½æç¤º
        if (postForm) {
          postForm.classList.remove('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'none';
        }
        if (postForm) {
          postForm.style.display = 'none';
        }
        showToast('åŠ è½½æ–‡ç« å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    // å¤åˆ¶æ–‡ç« ï¼ˆåœ¨æ–°çª—å£æ‰“å¼€ï¼‰
    function copyPost(id) {
      // åœ¨æ–°çª—å£æ‰“å¼€å¤åˆ¶é¡µé¢
      const copyUrl = `${window.location.pathname}?copy=${encodeURIComponent(id)}`;
      const copyWindow = window.open(copyUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!copyWindow) {
        showToast('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
        return;
      }
      
      // ç›‘å¬æ–°çª—å£å…³é—­äº‹ä»¶ï¼Œåˆ·æ–°æ–‡ç« åˆ—è¡¨
      const checkClosed = setInterval(() => {
        if (copyWindow.closed) {
          clearInterval(checkClosed);
          // åˆ·æ–°æ–‡ç« åˆ—è¡¨
          loadPosts(false);
        }
      }, 500);
    }
    
    // å¤åˆ¶æ–‡ç« ï¼ˆå†…éƒ¨å‡½æ•°ï¼Œç”¨äºåœ¨æ–°çª—å£ä¸­åŠ è½½æ–‡ç« æ•°æ®ï¼‰
    async function copyPostInternal(id) {
      const postForm = document.getElementById('postForm');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      try {
        // æ˜¾ç¤ºè¡¨å•å’ŒåŠ è½½æç¤º
        if (postForm) {
          postForm.style.display = 'block';
          postForm.classList.add('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'flex';
        }
        if (postFormContent) {
          postFormContent.style.display = 'none';
        }
        
        // åˆ‡æ¢åˆ°æ–‡ç« æ ‡ç­¾é¡µï¼ˆå¦‚æœä¸åœ¨æ–°çª—å£ï¼‰
        if (!window.opener) {
          switchTab('posts');
        }
        
        console.log('å¤åˆ¶æ–‡ç« ï¼ŒID:', id);
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
        console.log('è·å–æ–‡ç« åˆ—è¡¨å“åº”:', response);
        
        if (response && response.success && response.data) {
          // ç›´æ¥ä½¿ç”¨idåŒ¹é…ï¼ˆidç°åœ¨æ˜¯å…¨å±€å”¯ä¸€çš„UUIDï¼‰
          const post = response.data.find(p => {
            const pId = String(p.id || '');
            const searchId = String(id || '');
            return pId === searchId;
          });
          
          console.log('æ‰¾åˆ°çš„æ–‡ç« :', post);
          
          if (post) {
            // åˆ›å»ºæ–‡ç« å‰¯æœ¬ï¼Œæ¸…é™¤IDå’Œslugï¼Œä¿®æ”¹æ ‡é¢˜
            const copiedPost = {
              ...post,
              id: '', // æ¸…é™¤IDï¼Œä¿å­˜æ—¶ä¼šåˆ›å»ºæ–°æ–‡ç« 
              slug: '', // æ¸…é™¤slugï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆæ–°çš„
              name: (post.name || post.title || 'æœªå‘½å') + 'ï¼ˆå‰¯æœ¬ï¼‰',
              title: (post.name || post.title || 'æœªå‘½å') + 'ï¼ˆå‰¯æœ¬ï¼‰',
              published: false, // é»˜è®¤è®¾ä¸ºè‰ç¨¿
              views: 0, // é‡ç½®æµè§ˆé‡
              createdAt: null, // æ¸…é™¤åˆ›å»ºæ—¶é—´
              updatedAt: null // æ¸…é™¤æ›´æ–°æ—¶é—´
            };
            
            // ä¿å­˜å½“å‰æ–‡ç« å¯¹è±¡ï¼ˆç”¨äºåç»­ä¿å­˜æ—¶ä½¿ç”¨ï¼‰
            window.currentEditingPost = copiedPost;
            
            // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºè¡¨å•å†…å®¹
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postFormContent) {
              postFormContent.style.display = 'block';
            }
            // å¡«å……è¡¨å•æ•°æ®
            showPostForm(copiedPost);
          } else {
            console.error('æœªæ‰¾åˆ°æ–‡ç« ï¼ŒID:', id, 'å¯ç”¨æ–‡ç« ID:', response.data.map(p => p.id));
            // éšè—åŠ è½½æç¤º
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postForm) {
              postForm.style.display = 'none';
            }
            showToast('æœªæ‰¾åˆ°è¦å¤åˆ¶çš„æ–‡ç« ', 'error');
          }
        } else {
          console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', response);
          // éšè—åŠ è½½æç¤º
          if (postForm) {
            postForm.classList.remove('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'none';
          }
          if (postForm) {
            postForm.style.display = 'none';
          }
          showToast('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
        // éšè—åŠ è½½æç¤º
        if (postForm) {
          postForm.classList.remove('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'none';
        }
        if (postForm) {
          postForm.style.display = 'none';
        }
        showToast('åŠ è½½æ–‡ç« å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    // åˆ é™¤æ–‡ç« 
    async function deletePost(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('æ–‡ç« åˆ é™¤æˆåŠŸ', 'success');
          loadPosts(false); // åˆ é™¤åä¿æŒå±•å¼€çŠ¶æ€
        }
      } catch (error) {
        console.error('åˆ é™¤æ–‡ç« å¤±è´¥:', error);
      }
    }

    // åˆ†ç±»ç®¡ç†å‡½æ•°
    async function loadCategories() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories`);
        if (response && response.success) {
          const tbody = document.getElementById('categoriesTableBody');
          const categories = response.data || [];
          if (categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="blog-empty">æš‚æ— åˆ†ç±»</td></tr>';
          } else {
            tbody.innerHTML = categories.map(cat => `
              <tr>
                <td>${escapeHtml(cat.name)}</td>
                <td>${escapeHtml(cat.description || cat.path || '')}</td>
                <td>${cat.postCount || 0}</td>
                <td>
                  <div class="admin-actions">
                    <button class="admin-btn-small admin-btn-edit" onclick="editCategory(${cat.id})">ç¼–è¾‘</button>
                    <button class="admin-btn-small admin-btn-delete" onclick="deleteCategory(${cat.id})">åˆ é™¤</button>
                  </div>
                </td>
              </tr>
            `).join('');
          }
        }
      } catch (error) {
        document.getElementById('categoriesTableBody').innerHTML = '<tr><td colspan="4" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    function showCategoryForm(category = null) {
      const form = document.getElementById('categoryForm');
      const formTitle = document.getElementById('categoryFormTitle');
      
      if (category) {
        formTitle.textContent = 'ç¼–è¾‘åˆ†ç±»';
        document.getElementById('categoryId').value = category.id;
        document.getElementById('categoryName').value = category.name || '';
        document.getElementById('categoryPath').value = category.description || category.path || '';
      } else {
        formTitle.textContent = 'æ–°å»ºåˆ†ç±»';
        document.getElementById('categoryFormElement').reset();
        document.getElementById('categoryId').value = '';
      }
      
      form.style.display = 'block';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    function hideCategoryForm() {
      document.getElementById('categoryForm').style.display = 'none';
      document.getElementById('categoryFormElement').reset();
      document.getElementById('categoryId').value = '';
    }

    async function saveCategory(event) {
      event.preventDefault();
      const id = document.getElementById('categoryId').value;
      const name = document.getElementById('categoryName').value.trim();
      const path = document.getElementById('categoryPath').value.trim();

      if (!name || !path) {
        showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
        return;
      }

      if (!path.startsWith('/')) {
        showToast('è·¯å¾„å¿…é¡»ä»¥ / å¼€å¤´', 'error');
        return;
      }

      try {
        const url = id ? `${BLOG_ADMIN_API}/categories/${id}` : `${BLOG_ADMIN_API}/categories`;
        const method = id ? 'PUT' : 'POST';
        
        const response = await adminApiRequest(url, {
          method,
          body: JSON.stringify({ name, path })
        });

        if (response && response.success) {
          showToast(id ? 'åˆ†ç±»æ›´æ–°æˆåŠŸ' : 'åˆ†ç±»åˆ›å»ºæˆåŠŸ', 'success');
          hideCategoryForm();
          loadCategories();
        }
      } catch (error) {
        console.error('ä¿å­˜åˆ†ç±»å¤±è´¥:', error);
        showToast('ä¿å­˜åˆ†ç±»å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    async function editCategory(id) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories`);
        if (response && response.success) {
          const category = response.data.find(c => c.id === id);
          if (category) {
            showCategoryForm(category);
          }
        }
      } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
      }
    }

    async function deleteCategory(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿå¦‚æœæœ‰æ–‡ç« ä½¿ç”¨æ­¤åˆ†ç±»ï¼Œåˆ é™¤å°†å¤±è´¥ã€‚')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('åˆ†ç±»åˆ é™¤æˆåŠŸ', 'success');
          loadCategories();
        }
      } catch (error) {
        console.error('åˆ é™¤åˆ†ç±»å¤±è´¥:', error);
        showToast('åˆ é™¤åˆ†ç±»å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    // æ ‡ç­¾ç®¡ç†å‡½æ•°
    async function loadTags() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/tags`);
        if (response && response.success) {
          const tbody = document.getElementById('tagsTableBody');
          const tags = response.data || [];
          if (tags.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="blog-empty">æš‚æ— æ ‡ç­¾</td></tr>';
          } else {
            tbody.innerHTML = tags.map(tag => `
              <tr>
                <td>${escapeHtml(tag.name)}</td>
                <td>${tag.postCount || 0}</td>
              </tr>
            `).join('');
          }
        }
      } catch (error) {
        document.getElementById('tagsTableBody').innerHTML = '<tr><td colspan="2" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    function showTagForm() {
      document.getElementById('tagForm').style.display = 'block';
    }

    function hideTagForm() {
      document.getElementById('tagForm').style.display = 'none';
      document.getElementById('tagForm').querySelector('form').reset();
    }

    async function saveTag(event) {
      event.preventDefault();
      const name = document.getElementById('tagName').value.trim();

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/tags`, {
          method: 'POST',
          body: JSON.stringify({ name })
        });

        if (response && response.success) {
          showToast('æ ‡ç­¾åˆ›å»ºæˆåŠŸ', 'success');
          hideTagForm();
          loadTags();
        }
      } catch (error) {
        console.error('åˆ›å»ºæ ‡ç­¾å¤±è´¥:', error);
      }
    }

    // è¯„è®ºç®¡ç†å‡½æ•°
    async function loadComments() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments`);
        if (response && response.success) {
          const tbody = document.getElementById('commentsTableBody');
          const comments = response.data || [];
          if (comments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="blog-empty">æš‚æ— è¯„è®º</td></tr>';
          } else {
            tbody.innerHTML = comments.map(comment => {
              const date = formatDateTime(comment.createdAt || comment.created_at);
              return `
                <tr>
                  <td>${escapeHtml(comment.postName || '')}</td>
                  <td>${escapeHtml(comment.authorName)}</td>
                  <td>${escapeHtml(truncate(comment.content, 50))}</td>
                  <td>${comment.approved ? '<span style="color: #10b981;">å·²å®¡æ ¸</span>' : '<span style="color: #f59e0b;">å¾…å®¡æ ¸</span>'}</td>
                  <td>${date}</td>
                  <td>
                    <div class="admin-actions">
                      ${!comment.approved ? `<button class="admin-btn-small admin-btn-approve" onclick="approveComment('${comment.id}')">å®¡æ ¸</button>` : ''}
                      <button class="admin-btn-small admin-btn-delete" onclick="deleteComment('${comment.id}')">åˆ é™¤</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('');
          }
        }
      } catch (error) {
        document.getElementById('commentsTableBody').innerHTML = '<tr><td colspan="6" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    async function approveComment(id) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments/${id}/approve`, {
          method: 'PUT',
          body: JSON.stringify({ approved: true })
        });

        if (response && response.success) {
          showToast('è¯„è®ºå·²å®¡æ ¸é€šè¿‡', 'success');
          loadComments();
        }
      } catch (error) {
        console.error('å®¡æ ¸è¯„è®ºå¤±è´¥:', error);
      }
    }

    async function deleteComment(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('è¯„è®ºåˆ é™¤æˆåŠŸ', 'success');
          loadComments();
        }
      } catch (error) {
        console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
      }
    }

    // åˆå§‹åŒ–
    // è·å–URLå‚æ•°
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // æ£€æŸ¥URLå‚æ•°å¹¶è‡ªåŠ¨æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
    async function checkUrlParams() {
      const editId = getUrlParam('edit');
      const copyId = getUrlParam('copy');
      
      if (editId) {
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåå†æ‰§è¡Œç¼–è¾‘
        setTimeout(async () => {
          await editPostInternal(editId);
          // æ¸…é™¤URLå‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤æ‰§è¡Œ
          const url = new URL(window.location);
          url.searchParams.delete('edit');
          window.history.replaceState({}, '', url);
        }, 500);
      }
      
      if (copyId) {
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåå†æ‰§è¡Œå¤åˆ¶
        setTimeout(async () => {
          await copyPostInternal(copyId);
          // æ¸…é™¤URLå‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤æ‰§è¡Œ
          const url = new URL(window.location);
          url.searchParams.delete('copy');
          window.history.replaceState({}, '', url);
        }, 500);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // å¦‚æœæ˜¯åœ¨æ–°çª—å£ä¸­æ‰“å¼€ç¼–è¾‘æˆ–å¤åˆ¶é¡µé¢ï¼ŒåªåŠ è½½å¿…è¦çš„èµ„æº
      const editId = getUrlParam('edit');
      const copyId = getUrlParam('copy');
      const isEditWindow = window.opener && (editId || copyId);
      
      if (isEditWindow) {
        // æ–°çª—å£ï¼šéšè—ä¸ç›¸å…³çš„å…ƒç´ ï¼Œåªæ˜¾ç¤ºç¼–è¾‘è¡¨å•
        hideUnnecessaryElements();
        // æ›´æ–°é¡µé¢æ ‡é¢˜
        if (copyId) {
          updatePageTitleForEdit('å¤åˆ¶æ–‡ç« ');
        } else {
          updatePageTitleForEdit();
        }
        // ç«‹å³æ˜¾ç¤ºè¡¨å•å’ŒåŠ è½½æç¤ºï¼ˆç­‰å¾…DOMå®Œå…¨åŠ è½½ï¼‰
        setTimeout(() => {
          const postForm = document.getElementById('postForm');
          const postFormLoading = document.getElementById('postFormLoading');
          const postFormContent = document.getElementById('postFormContent');
          if (postForm) {
            postForm.style.display = 'block';
            postForm.classList.add('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'flex';
          }
          if (postFormContent) {
            postFormContent.style.display = 'none';
          }
        }, 100);
      } else {
        // ä¸»çª—å£ï¼šåŠ è½½æ–‡ç« åˆ—è¡¨
      loadPosts();
      }
      
      // æ‰€æœ‰çª—å£éƒ½éœ€è¦åŠ è½½APIåˆ—è¡¨
      loadApis();
      
      // ç›‘å¬å›¾ç‰‡URLè¾“å…¥æ¡†å˜åŒ–ï¼Œå®æ—¶æ›´æ–°é¢„è§ˆ
      const postImageInput = document.getElementById('postImage');
      if (postImageInput) {
        postImageInput.addEventListener('input', function() {
          updateImagePreview(this.value);
        });
        
        // åˆå§‹åŒ–æ—¶ä¹Ÿæ£€æŸ¥ä¸€æ¬¡
        updateImagePreview(postImageInput.value);
      }
      
      // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæœ‰editå‚æ•°ï¼Œè‡ªåŠ¨æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
      await checkUrlParams();
    });
    
    // éšè—æ–°çª—å£ä¸­ä¸éœ€è¦çš„å…ƒç´ 
    function hideUnnecessaryElements() {
      // éšè—æ ‡ç­¾é¡µå¯¼èˆª
      const tabsContainer = document.querySelector('.admin-tabs');
      if (tabsContainer) {
        tabsContainer.style.display = 'none';
      }
      
      // éšè—æ–‡ç« ç®¡ç†æ ‡é¢˜å’Œæ–°å»ºæŒ‰é’®
      const postsHeader = document.querySelector('#tab-posts > div:first-child');
      if (postsHeader) {
        postsHeader.style.display = 'none';
      }
      
      // éšè—æ–‡ç« åˆ—è¡¨è¡¨æ ¼
      const postsTable = document.querySelector('#tab-posts > div:last-child');
      if (postsTable && postsTable.querySelector('#postsTableBody')) {
        postsTable.style.display = 'none';
      }
      
      // éšè—å…¶ä»–æ ‡ç­¾é¡µå†…å®¹
      const otherTabs = ['tab-categories', 'tab-tags', 'tab-comments'];
      otherTabs.forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (tab) {
          tab.style.display = 'none';
        }
      });
      
      // ç¡®ä¿æ–‡ç« è¡¨å•å®¹å™¨å¯è§
      const postsTab = document.getElementById('tab-posts');
      if (postsTab) {
        postsTab.style.display = 'block';
        postsTab.classList.add('active');
      }
      
      // éšè—"è¿”å›åšå®¢"æŒ‰é’®ï¼ˆæ–°çª—å£ä¸­ä¸éœ€è¦ï¼‰
      const returnButton = document.querySelector('.admin-header a[href="/blog.html"]');
      if (returnButton) {
        returnButton.style.display = 'none';
      }
      
      // è°ƒæ•´å®¹å™¨æ ·å¼ï¼Œè®©ç¼–è¾‘è¡¨å•æ›´çªå‡º
      const adminContainer = document.querySelector('.admin-container');
      if (adminContainer) {
        adminContainer.style.maxWidth = '100%';
        adminContainer.style.padding = '1rem';
      }
    }
    
    // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸ºç¼–è¾‘æ¨¡å¼
    function updatePageTitleForEdit(customTitle) {
      const headerTitle = document.querySelector('.admin-header h1');
      if (headerTitle) {
        headerTitle.textContent = customTitle || 'ç¼–è¾‘æ–‡ç« ';
      }
      
      const headerSubtitle = document.querySelector('.admin-header p');
      if (headerSubtitle) {
        if (customTitle === 'å¤åˆ¶æ–‡ç« ') {
          headerSubtitle.textContent = 'å¤åˆ¶å¹¶ç¼–è¾‘æ–‡ç« å†…å®¹';
        } else {
          headerSubtitle.textContent = 'ç¼–è¾‘æ–‡ç« å†…å®¹';
        }
      }
    }
    
    /**
     * ä¸Šä¼ å›¾ç‰‡åˆ°æœåŠ¡å™¨ï¼ˆé€šç”¨å‡½æ•°ï¼‰
     * @param {File} file - å›¾ç‰‡æ–‡ä»¶
     * @returns {Promise<string>} è¿”å›å›¾ç‰‡URL
     */
    async function uploadImageToServer(file) {
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('image/')) {
        throw new Error('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
      if (file.size > 10 * 1024 * 1024) {
        throw new Error('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
      }
      
      // åˆ›å»ºFormData
      const formData = new FormData();
      formData.append('image', file);
      
      // å‘é€ä¸Šä¼ è¯·æ±‚
      const response = await fetch('/api/admin/custom-apis/upload-image', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin' // åŒ…å«cookieç”¨äºèº«ä»½éªŒè¯
      });
      
      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
      }
      
      // è¿”å›å›¾ç‰‡URL
      return result.image.url;
    }
    
    /**
     * ä¸Šä¼ è§†é¢‘åˆ°æœåŠ¡å™¨ï¼ˆé€šç”¨å‡½æ•°ï¼‰
     * @param {File} file - è§†é¢‘æ–‡ä»¶
     * @param {Function} onProgress - è¿›åº¦å›è°ƒå‡½æ•° (progress: number) => void
     * @returns {Promise<string>} è¿”å›è§†é¢‘URL
     */
    async function uploadVideoToServer(file, onProgress) {
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('video/')) {
        throw new Error('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶');
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ200MBï¼‰
      if (file.size > 200 * 1024 * 1024) {
        throw new Error('è§†é¢‘æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡200MB');
      }
      
      // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
      const ext = file.name.split('.').pop().toLowerCase();
      const supportedFormats = ['mp4', 'mov', 'webm', 'ogg', 'ogv', 'avi', 'wmv', 'flv', 'mkv', 'm4v'];
      if (!supportedFormats.includes(ext)) {
        throw new Error(`ä¸æ”¯æŒçš„è§†é¢‘æ ¼å¼ï¼ˆ${ext}ï¼‰ã€‚æ”¯æŒçš„æ ¼å¼ï¼š${supportedFormats.join(', ')}`);
      }
      
      // åˆ›å»ºFormData
      const formData = new FormData();
      formData.append('video', file);
      
      // ä½¿ç”¨XMLHttpRequestä»¥æ”¯æŒä¸Šä¼ è¿›åº¦
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        let uploadComplete = false;
        let taskId = null;
        let progressInterval = null;
        
        // ç›‘å¬ä¸Šä¼ è¿›åº¦
        if (onProgress) {
          // ç«‹å³æ˜¾ç¤ºå¼€å§‹ä¸Šä¼ 
          onProgress(0, 'å¼€å§‹ä¸Šä¼ ...');
          
          xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable && !uploadComplete) {
              // ä¸Šä¼ è¿›åº¦ï¼ˆ0-30%ï¼‰ï¼Œå‰©ä½™70%ç”¨äºæœåŠ¡å™¨ç«¯å¤„ç†ï¼ˆè½¬æ¢é€šå¸¸éœ€è¦æ›´é•¿æ—¶é—´ï¼‰
              const percentComplete = Math.min((e.loaded / e.total) * 30, 30);
              const uploadPercent = Math.round((e.loaded / e.total) * 100);
              onProgress(percentComplete, `ä¸Šä¼ ä¸­... ${uploadPercent}%`);
            }
          });
        }
        
        // ç›‘å¬å®Œæˆï¼ˆä¸Šä¼ å®Œæˆï¼Œå¼€å§‹å¤„ç†ï¼‰
        xhr.addEventListener('load', function() {
          uploadComplete = true;
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const result = JSON.parse(xhr.responseText);
              if (result.success && result.taskId) {
                taskId = result.taskId;
                
                // å¼€å§‹è½®è¯¢è¿›åº¦
                if (onProgress) {
                  onProgress(30, 'ä¸Šä¼ å®Œæˆï¼Œå¼€å§‹å¤„ç†...');
                }
                
                // è½®è¯¢è¿›åº¦ï¼ˆæ¯200msï¼‰
                progressInterval = setInterval(async () => {
                  try {
                    const progressResponse = await fetch(`/api/admin/custom-apis/video-upload-progress/${taskId}?t=${Date.now()}`, {
                      credentials: 'include',
                      cache: 'no-cache'
                    });
                    
                    if (progressResponse.ok) {
                      const progressData = await progressResponse.json();
                      
                      if (progressData.success) {
                        if (progressData.running) {
                          // æ›´æ–°è¿›åº¦
                          const progress = progressData.progress || {};
                          const percent = Math.min(Math.max(progress.percent || 0, 0), 100);
                          const message = progress.message || 'å¤„ç†ä¸­...';
                          
                          // è¿›åº¦æ˜ å°„ï¼š30% - 100%ï¼ˆä¸Šä¼ å®Œæˆåï¼Œå¤„ç†é˜¶æ®µï¼‰
                          // 30% + (percent * 0.7) = 30% + 70%çš„å¤„ç†è¿›åº¦
                          const totalPercent = Math.min(30 + (percent * 0.7), 100);
                          if (onProgress) {
                            onProgress(totalPercent, message);
                          }
                        } else {
                          // å¤„ç†å®Œæˆæˆ–å‡ºé”™
                          clearInterval(progressInterval);
                          progressInterval = null;
                          
                          if (progressData.error) {
                            if (onProgress) {
                              onProgress(0, 'å¤„ç†å¤±è´¥');
                            }
                            reject(new Error(progressData.error));
                          } else if (progressData.result) {
                            // å®Œæˆï¼Œè¿”å›è§†é¢‘ä¿¡æ¯
                            if (onProgress) {
                              onProgress(100, 'å¤„ç†å®Œæˆ');
                            }
                            resolve(progressData.result);
                          } else {
                            if (onProgress) {
                              onProgress(0, 'å¤„ç†å¤±è´¥');
                            }
                            reject(new Error('å¤„ç†å®Œæˆä½†æœªè¿”å›ç»“æœ'));
                          }
                        }
                      } else {
                        clearInterval(progressInterval);
                        progressInterval = null;
                        if (onProgress) {
                          onProgress(0, 'è·å–è¿›åº¦å¤±è´¥');
                        }
                        reject(new Error(progressData.message || 'è·å–è¿›åº¦å¤±è´¥'));
                      }
                    } else {
                      clearInterval(progressInterval);
                      progressInterval = null;
                      if (onProgress) {
                        onProgress(0, 'è·å–è¿›åº¦å¤±è´¥');
                      }
                      reject(new Error('è·å–è¿›åº¦å¤±è´¥: ' + progressResponse.statusText));
                    }
                  } catch (pollError) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                    if (onProgress) {
                      onProgress(0, 'è½®è¯¢å¤±è´¥');
                    }
                    reject(new Error('è½®è¯¢è¿›åº¦å¤±è´¥: ' + pollError.message));
                  }
                }, 200); // æ¯200msè½®è¯¢ä¸€æ¬¡
                
                // è®¾ç½®æœ€å¤§è½®è¯¢æ—¶é—´ï¼ˆ10åˆ†é’Ÿï¼‰
                setTimeout(() => {
                  if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                    if (onProgress) {
                      onProgress(0, 'å¤„ç†è¶…æ—¶');
                    }
                    reject(new Error('å¤„ç†è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•'));
                  }
                }, 10 * 60 * 1000);
              } else {
                if (onProgress) {
                  onProgress(0, 'ä¸Šä¼ å¤±è´¥');
                }
                reject(new Error(result.message || 'ä¸Šä¼ å¤±è´¥'));
              }
            } catch (e) {
              if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
              }
              if (onProgress) {
                onProgress(0, 'è§£æå¤±è´¥');
              }
              reject(new Error('è§£æå“åº”å¤±è´¥'));
            }
          } else {
            try {
              const errorResult = JSON.parse(xhr.responseText);
              reject(new Error(errorResult.message || 'ä¸Šä¼ å¤±è´¥: ' + xhr.statusText));
            } catch (e) {
              reject(new Error('ä¸Šä¼ å¤±è´¥: ' + xhr.statusText));
            }
          }
        });
        
        // ç›‘å¬é”™è¯¯
        xhr.addEventListener('error', function() {
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
          if (onProgress) {
            onProgress(0, 'ç½‘ç»œé”™è¯¯');
          }
          reject(new Error('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
        });
        
        // ç›‘å¬è¶…æ—¶
        xhr.addEventListener('timeout', function() {
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
          if (onProgress) {
            onProgress(0, 'ä¸Šä¼ è¶…æ—¶');
          }
          reject(new Error('ä¸Šä¼ è¶…æ—¶ï¼Œè§†é¢‘æ–‡ä»¶å¯èƒ½è¿‡å¤§æˆ–ç½‘ç»œè¾ƒæ…¢'));
        });
        
        // è®¾ç½®è¶…æ—¶æ—¶é—´ï¼ˆ5åˆ†é’Ÿï¼Œå› ä¸ºè§†é¢‘ä¸Šä¼ å¯èƒ½éœ€è¦æ—¶é—´ï¼‰
        xhr.timeout = 5 * 60 * 1000;
        
        // å‘é€è¯·æ±‚
        xhr.open('POST', '/api/admin/custom-apis/upload-video');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.withCredentials = true; // åŒ…å«cookieç”¨äºèº«ä»½éªŒè¯
        xhr.send(formData);
      });
    }
    
    /**
     * ç¡®ä¿URLæ˜¯å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼ˆå…¼å®¹å°ç¨‹åºç­‰ç¯å¢ƒï¼‰
     * @param {string} url - å¯èƒ½æ˜¯ç›¸å¯¹è·¯å¾„æˆ–å®Œæ•´URL
     * @returns {string} å®Œæ•´çš„ç½‘ç»œåœ°å€
     */
    function ensureFullUrl(url) {
      if (!url) return '';
      
      // å¦‚æœå·²ç»æ˜¯å®Œæ•´çš„URLï¼ˆhttp:// æˆ– https://ï¼‰ï¼Œç›´æ¥è¿”å›
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return url;
      }
      
      // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆä»¥ / å¼€å¤´ï¼‰ï¼Œè½¬æ¢ä¸ºå®Œæ•´URL
      if (url.startsWith('/')) {
        const protocol = window.location.protocol;
        const host = window.location.host;
        return `${protocol}//${host}${url}`;
      }
      
      // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼ˆä¸ä»¥ / å¼€å¤´ï¼‰ï¼ŒåŸºäºå½“å‰è·¯å¾„
      if (!url.startsWith('//')) {
        const protocol = window.location.protocol;
        const host = window.location.host;
        const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
        return `${protocol}//${host}${basePath}/${url}`;
      }
      
      // å¦‚æœæ˜¯åè®®ç›¸å¯¹URLï¼ˆ//example.comï¼‰ï¼Œæ·»åŠ å½“å‰åè®®
      if (url.startsWith('//')) {
        return `${window.location.protocol}${url}`;
      }
      
      return url;
    }
    
    /**
     * éªŒè¯poster URLæ˜¯å¦æ˜¯å›¾ç‰‡ï¼ˆä¸èƒ½æ˜¯è§†é¢‘ï¼‰
     * @param {string} posterUrl - poster URL
     * @returns {boolean} å¦‚æœæ˜¯å›¾ç‰‡è¿”å›trueï¼Œå¦‚æœæ˜¯è§†é¢‘è¿”å›false
     */
    function isValidPosterUrl(posterUrl) {
      if (!posterUrl) return false;
      
      // è§†é¢‘æ–‡ä»¶æ‰©å±•å
      const videoExtensions = ['.mp4', '.mov', '.webm', '.ogg', '.ogv', '.avi', '.wmv', '.flv', '.mkv', '.m4v', '.mpg', '.mpeg', '.3gp'];
      
      // æ£€æŸ¥URLæ˜¯å¦åŒ…å«è§†é¢‘æ‰©å±•å
      const urlLower = posterUrl.toLowerCase();
      for (const ext of videoExtensions) {
        if (urlLower.includes(ext)) {
          return false; // æ˜¯è§†é¢‘æ–‡ä»¶ï¼Œæ— æ•ˆ
        }
      }
      
      // å›¾ç‰‡æ–‡ä»¶æ‰©å±•å
      const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg', '.bmp', '.ico'];
      
      // æ£€æŸ¥URLæ˜¯å¦åŒ…å«å›¾ç‰‡æ‰©å±•å
      for (const ext of imageExtensions) {
        if (urlLower.includes(ext)) {
          return true; // æ˜¯å›¾ç‰‡æ–‡ä»¶ï¼Œæœ‰æ•ˆ
        }
      }
      
      // å¦‚æœæ²¡æœ‰æ˜ç¡®çš„æ‰©å±•åï¼Œæ£€æŸ¥URLè·¯å¾„ä¸­æ˜¯å¦åŒ…å«å›¾ç‰‡ç›¸å…³çš„å…³é”®è¯
      if (urlLower.includes('/image') || urlLower.includes('/img') || urlLower.includes('/picture') || urlLower.includes('/photo')) {
        return true; // å¯èƒ½æ˜¯å›¾ç‰‡
      }
      
      // å¦‚æœåŒ…å«è§†é¢‘ç›¸å…³çš„å…³é”®è¯ï¼Œè¿”å›false
      if (urlLower.includes('/video') || urlLower.includes('/videos')) {
        return false;
      }
      
      // é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®çš„è§†é¢‘æ‰©å±•åï¼Œå…è®¸ï¼ˆå¯èƒ½æ˜¯å›¾ç‰‡ï¼‰
      return true;
    }
    
    /**
     * ç”Ÿæˆè§†é¢‘HTMLä»£ç 
     * @param {string} videoUrl - è§†é¢‘URL
     * @param {string} format - è§†é¢‘æ ¼å¼ï¼š'video-tag' | 'video-source' | 'video-link'
     * @param {string} posterUrl - å°é¢å›¾ç‰‡URLï¼ˆå¯é€‰ï¼‰
     * @returns {string} è§†é¢‘HTMLä»£ç 
     */
    /**
     * ç¡®ä¿HTMLå†…å®¹ä¸­æ‰€æœ‰è§†é¢‘å’Œå›¾ç‰‡URLéƒ½æ˜¯å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼ˆå…¼å®¹å°ç¨‹åºç­‰ç¯å¢ƒï¼‰
     * @param {string} html - HTMLå†…å®¹
     * @returns {string} å¤„ç†åçš„HTMLå†…å®¹
     */
    function ensureFullUrlsInHtml(html) {
      if (!html) return html;
      
      // å¤„ç†imgæ ‡ç­¾çš„srcå±æ€§ï¼ˆç¡®ä¿å›¾ç‰‡URLæ˜¯å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼‰
      html = html.replace(/<img([^>]*)>/gi, function(match, attrs) {
        const srcMatch = attrs.match(/src=["']([^"']*)["']/i);
        if (srcMatch) {
          const originalSrc = srcMatch[1];
          // æ£€æŸ¥æ˜¯å¦æ˜¯æ ¹ç›®å½•çš„æ–‡ä»¶ï¼ˆå¦‚ /IMG_1343.MOVï¼‰ï¼Œåº”è¯¥ç§»åŠ¨åˆ°uploadsç›®å½•
          // ä½†è¿™é‡Œåªè½¬æ¢URLï¼Œä¸ç§»åŠ¨æ–‡ä»¶
          const fullSrc = ensureFullUrl(originalSrc);
          const newAttrs = attrs.replace(/src=["'][^"']*["']/i, `src="${fullSrc}"`);
          return `<img${newAttrs}>`;
        }
        return match;
      });
      
      // å¤„ç†videoæ ‡ç­¾çš„srcå’Œposterå±æ€§
      html = html.replace(/<video([^>]*)>/gi, function(match, attrs) {
        // æå–srcå’Œposterå±æ€§
        const srcMatch = attrs.match(/src=["']([^"']*)["']/i);
        const posterMatch = attrs.match(/poster=["']([^"']*)["']/i);
        
        let newAttrs = attrs;
        
        // å¤„ç†srcå±æ€§
        if (srcMatch) {
          const originalSrc = srcMatch[1];
          const fullSrc = ensureFullUrl(originalSrc);
          newAttrs = newAttrs.replace(/src=["'][^"']*["']/i, `src="${fullSrc}"`);
        }
        
        // å¤„ç†posterå±æ€§ï¼ˆéªŒè¯å¿…é¡»æ˜¯å›¾ç‰‡ï¼Œä¸èƒ½æ˜¯è§†é¢‘ï¼‰
        if (posterMatch) {
          const originalPoster = posterMatch[1];
          const fullPoster = ensureFullUrl(originalPoster);
          
          // éªŒè¯posteræ˜¯å¦æ˜¯å›¾ç‰‡ï¼ˆä¸èƒ½æ˜¯è§†é¢‘ï¼‰
          if (isValidPosterUrl(fullPoster)) {
            newAttrs = newAttrs.replace(/poster=["'][^"']*["']/i, `poster="${fullPoster}"`);
          } else {
            // posteræ˜¯è§†é¢‘URLï¼Œç§»é™¤posterå±æ€§ï¼ˆå…¼å®¹å¾®ä¿¡å°ç¨‹åºï¼‰
            console.warn('æ£€æµ‹åˆ°posterå±æ€§ä½¿ç”¨äº†è§†é¢‘URLï¼Œå·²ç§»é™¤ï¼ˆposterå¿…é¡»æ˜¯å›¾ç‰‡ï¼‰', { posterUrl: fullPoster });
            newAttrs = newAttrs.replace(/poster=["'][^"']*["']/i, '');
          }
        }
        
        return `<video${newAttrs}>`;
      });
      
      // å¤„ç†sourceæ ‡ç­¾çš„srcå±æ€§ï¼ˆåœ¨videoæ ‡ç­¾å†…ï¼‰
      html = html.replace(/<source([^>]*)>/gi, function(match, attrs) {
        const srcMatch = attrs.match(/src=["']([^"']*)["']/i);
        if (srcMatch) {
          const originalSrc = srcMatch[1];
          const fullSrc = ensureFullUrl(originalSrc);
          const newAttrs = attrs.replace(/src=["'][^"']*["']/i, `src="${fullSrc}"`);
          return `<source${newAttrs}>`;
        }
        return match;
      });
      
      return html;
    }
    
    /**
     * ç§»é™¤HTMLå†…å®¹ä¸­çš„æ‰€æœ‰base64å›¾ç‰‡å’Œè§†é¢‘
     * @param {string} html - HTMLå†…å®¹
     * @returns {string} æ¸…ç†åçš„HTMLå†…å®¹
     */
    function removeBase64Content(html) {
      if (!html) return html;
      
      // ç§»é™¤base64å›¾ç‰‡ (data:image/...)
      html = html.replace(/<img[^>]*src=["']data:image\/[^"']*["'][^>]*>/gi, '');
      
      // ç§»é™¤base64è§†é¢‘ (data:video/...)
      html = html.replace(/<video[^>]*src=["']data:video\/[^"']*["'][^>]*>.*?<\/video>/gi, '');
      html = html.replace(/<source[^>]*src=["']data:video\/[^"']*["'][^>]*>/gi, '');
      
      // ç§»é™¤åŒ…å«base64çš„styleå±æ€§
      html = html.replace(/style=["'][^"']*data:image\/[^"']*["']/gi, '');
      html = html.replace(/style=["'][^"']*data:video\/[^"']*["']/gi, '');
      
      // ç§»é™¤blob: URL
      html = html.replace(/src=["']blob:[^"']*["']/gi, '');
      html = html.replace(/href=["']blob:[^"']*["']/gi, '');
      
      return html;
    }
    
    function generateVideoHtml(videoUrl, format, posterUrl = '') {
      // ç¡®ä¿URLæ˜¯å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼ˆå…¼å®¹å°ç¨‹åºç­‰ç¯å¢ƒï¼‰
      const fullVideoUrl = ensureFullUrl(videoUrl);
      
      // éªŒè¯å¹¶å¤„ç†poster URL
      let fullPosterUrl = '';
      if (posterUrl) {
        const fullPoster = ensureFullUrl(posterUrl);
        // éªŒè¯posteræ˜¯å¦æ˜¯å›¾ç‰‡ï¼ˆä¸èƒ½æ˜¯è§†é¢‘ï¼‰
        if (isValidPosterUrl(fullPoster)) {
          fullPosterUrl = fullPoster;
        } else {
          // posteræ˜¯è§†é¢‘URLï¼Œå‘å‡ºè­¦å‘Šå¹¶å¿½ç•¥
          console.warn('posterå±æ€§ä½¿ç”¨äº†è§†é¢‘URLï¼Œå·²å¿½ç•¥ï¼ˆposterå¿…é¡»æ˜¯å›¾ç‰‡ï¼‰', { posterUrl: fullPoster });
          showToast('è­¦å‘Šï¼šå°é¢å›¾ç‰‡URLä¸èƒ½æ˜¯è§†é¢‘æ–‡ä»¶ï¼Œå·²å¿½ç•¥posterå±æ€§', 'warning');
        }
      }
      
      // è½¬ä¹‰URLä¸­çš„ç‰¹æ®Šå­—ç¬¦
      const escapedVideoUrl = fullVideoUrl.replace(/"/g, '&quot;');
      const escapedPosterUrl = fullPosterUrl ? fullPosterUrl.replace(/"/g, '&quot;') : '';
      
      switch (format) {
        case 'video-tag':
          // æ–¹å¼1: ç›´æ¥ video æ ‡ç­¾ï¼ˆç¬¦åˆç¤ºä¾‹æ ¼å¼ï¼š<video src="..." poster="..."></video>ï¼‰
          // ç¡®ä¿ä½¿ç”¨å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼Œå…¼å®¹å°ç¨‹åºç¯å¢ƒ
          if (fullPosterUrl) {
            return `<video src="${escapedVideoUrl}" poster="${escapedPosterUrl}"></video>`;
          } else {
            return `<video src="${escapedVideoUrl}"></video>`;
          }
        case 'video-source':
          // æ–¹å¼2: video æ ‡ç­¾åŒ…å« sourceï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
          // æ£€æµ‹è§†é¢‘æ–‡ä»¶æ‰©å±•åæ¥ç¡®å®šMIMEç±»å‹
          const videoExt = escapedVideoUrl.split('.').pop().toLowerCase();
          let videoType = 'video/mp4'; // é»˜è®¤
          if (videoExt === 'mov' || videoExt === 'qt') {
            videoType = 'video/quicktime';
          } else if (videoExt === 'webm') {
            videoType = 'video/webm';
          } else if (videoExt === 'ogg' || videoExt === 'ogv') {
            videoType = 'video/ogg';
          } else if (videoExt === 'avi') {
            videoType = 'video/x-msvideo';
          } else if (videoExt === 'wmv') {
            videoType = 'video/x-ms-wmv';
          } else if (videoExt === 'flv') {
            videoType = 'video/x-flv';
          } else if (videoExt === 'mkv') {
            videoType = 'video/x-matroska';
          }
          
          // ç¡®ä¿ä½¿ç”¨å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼ˆposterå·²åœ¨ä¸Šæ–¹éªŒè¯ï¼‰
          if (fullPosterUrl) {
            return `<video poster="${escapedPosterUrl}">
  <source src="${escapedVideoUrl}" type="${videoType}">
</video>`;
          } else {
            return `<video>
  <source src="${escapedVideoUrl}" type="${videoType}">
</video>`;
          }
        case 'youtube-iframe':
          // æ–¹å¼3: YouTube iframeåµŒå…¥ï¼ˆç¬¦åˆç¤ºä¾‹æ ¼å¼ï¼š<iframe src="https://www.youtube.com/embed/VIDEO_ID"></iframe>ï¼‰
          // ä»YouTube URLä¸­æå–è§†é¢‘ID
          let videoId = '';
          if (videoUrl.includes('youtube.com/watch?v=')) {
            videoId = videoUrl.split('v=')[1].split('&')[0];
          } else if (videoUrl.includes('youtu.be/')) {
            videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
          } else if (videoUrl.includes('youtube.com/embed/')) {
            videoId = videoUrl.split('embed/')[1].split('?')[0];
          } else {
            // å‡è®¾ç›´æ¥è¾“å…¥çš„æ˜¯è§†é¢‘ID
            videoId = videoUrl.trim();
          }
          
          if (!videoId) {
            throw new Error('æ— æ³•ä»URLä¸­æå–YouTubeè§†é¢‘ID');
          }
          
          return `<iframe src="https://www.youtube.com/embed/${videoId}"></iframe>`;
        case 'video-link':
          // æ–¹å¼4: è§†é¢‘é“¾æ¥ï¼ˆä¼šæ˜¾ç¤ºä¸ºå¯ç‚¹å‡»çš„é“¾æ¥ï¼‰
          return `<a href="${escapedVideoUrl}" target="_blank" style="display: inline-block; padding: 0.5rem 1rem; background: #9333ea; color: white; text-decoration: none; border-radius: 0.25rem; margin: 1rem 0;">ğŸ“¹ è§†é¢‘é“¾æ¥</a>`;
        default:
          // é»˜è®¤ä½¿ç”¨æ–¹å¼1ï¼ˆç¬¦åˆç¤ºä¾‹æ ¼å¼ï¼‰
          // ç¡®ä¿ä½¿ç”¨å®Œæ•´çš„ç½‘ç»œåœ°å€ï¼ˆposterå·²åœ¨ä¸Šæ–¹éªŒè¯ï¼‰
          if (fullPosterUrl) {
            return `<video src="${escapedVideoUrl}" poster="${escapedPosterUrl}"></video>`;
          } else {
            return `<video src="${escapedVideoUrl}"></video>`;
          }
      }
    }
    
    /**
     * å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆç”¨äºè¡¨å•ä¸­çš„å›¾ç‰‡URLè¾“å…¥æ¡†ï¼‰
     */
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) {
        return;
      }
      
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        event.target.value = '';
        return;
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
      if (file.size > 10 * 1024 * 1024) {
        alert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
        event.target.value = '';
        return;
      }
      
      // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
      const progressDiv = document.getElementById('imageUploadProgress');
      const progressBar = document.getElementById('imageUploadProgressBar');
      const statusSpan = document.getElementById('imageUploadStatus');
      
      progressDiv.style.display = 'block';
      progressBar.style.width = '0%';
      statusSpan.textContent = 'ä¸Šä¼ ä¸­...';
      
      try {
        // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress < 90) {
            progressBar.style.width = progress + '%';
          }
        }, 100);
        
        // ä½¿ç”¨é€šç”¨ä¸Šä¼ å‡½æ•°
        const imageUrl = await uploadImageToServer(file);
        
        clearInterval(progressInterval);
        
        // ä¸Šä¼ æˆåŠŸ
        progressBar.style.width = '100%';
        statusSpan.textContent = 'ä¸Šä¼ æˆåŠŸï¼';
        
        // å¡«å……åˆ°å›¾ç‰‡URLè¾“å…¥æ¡†
        document.getElementById('postImage').value = imageUrl;
        
        // æ›´æ–°é¢„è§ˆ
        updateImagePreview(imageUrl);
        
        // 2ç§’åéšè—è¿›åº¦æ¡
        setTimeout(() => {
          progressDiv.style.display = 'none';
          progressBar.style.width = '0%';
        }, 2000);
        
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
        event.target.value = '';
        
      } catch (error) {
        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
        progressBar.style.width = '0%';
        statusSpan.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
        statusSpan.style.color = '#ef4444';
        
        setTimeout(() => {
          progressDiv.style.display = 'none';
          statusSpan.style.color = '#6b7280';
        }, 3000);
        
        event.target.value = '';
      }
    }
    
    /**
     * æ›´æ–°å›¾ç‰‡é¢„è§ˆ
     */
    function updateImagePreview(imageUrl) {
      const previewDiv = document.getElementById('imagePreview');
      const previewImg = document.getElementById('imagePreviewImg');
      
      if (imageUrl && imageUrl.trim()) {
        previewImg.src = imageUrl;
        previewDiv.style.display = 'block';
      } else {
        previewDiv.style.display = 'none';
      }
    }
    
    /**
     * åŒæ­¥nameå’Œtitleå­—æ®µ
     */
    function syncNameAndTitle() {
      const nameInput = document.getElementById('postName');
      if (nameInput) {
        // nameå’Œtitleä¿æŒä¸€è‡´ï¼Œè¿™é‡Œåªéœ€è¦ç¡®ä¿nameå­—æ®µçš„å€¼æ­£ç¡®å³å¯
        // titleä¼šåœ¨ä¿å­˜æ—¶è‡ªåŠ¨è®¾ç½®ä¸ºä¸nameç›¸åŒ
      }
    }
    
    /**
     * æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯é¢æ¿
     */
    function showDebugInfo(info) {
      // åˆ›å»ºæˆ–è·å–è°ƒè¯•é¢æ¿
      let debugPanel = document.getElementById('debugPanel');
      if (!debugPanel) {
        debugPanel = document.createElement('div');
        debugPanel.id = 'debugPanel';
        debugPanel.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          width: 500px;
          max-height: 80vh;
          background: #1f2937;
          color: #f3f4f6;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
          z-index: 10000;
          font-family: 'Courier New', monospace;
          font-size: 12px;
          overflow-y: auto;
          display: none;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Ã—';
        closeBtn.style.cssText = `
          position: absolute;
          top: 10px;
          right: 10px;
          background: #ef4444;
          color: white;
          border: none;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 20px;
          line-height: 1;
        `;
        closeBtn.onclick = () => {
          debugPanel.style.display = 'none';
        };
        debugPanel.appendChild(closeBtn);
        
        const title = document.createElement('h3');
        title.textContent = 'è°ƒè¯•ä¿¡æ¯';
        title.style.cssText = 'margin: 0 0 15px 0; color: #60a5fa;';
        debugPanel.appendChild(title);
        
        document.body.appendChild(debugPanel);
      }
      
      // æ¸…ç©ºå†…å®¹ï¼ˆä¿ç•™æ ‡é¢˜å’Œå…³é—­æŒ‰é’®ï¼‰
      const title = debugPanel.querySelector('h3');
      const closeBtn = debugPanel.querySelector('button');
      debugPanel.innerHTML = '';
      debugPanel.appendChild(closeBtn);
      debugPanel.appendChild(title);
      
      // æ·»åŠ è°ƒè¯•ä¿¡æ¯
      const sections = [
        { title: 'è¯·æ±‚æ•°æ®', data: info.request },
        { title: 'å“åº”æ•°æ®', data: info.response },
        { title: 'ç‰¹æ®Šç±»å‹', data: info.specialType },
        { title: 'ç‰¹æ®Šæ•°æ®', data: info.specialData }
      ];
      
      sections.forEach(section => {
        if (section.data) {
          const sectionDiv = document.createElement('div');
          sectionDiv.style.cssText = 'margin-bottom: 15px;';
          
          const sectionTitle = document.createElement('h4');
          sectionTitle.textContent = section.title;
          sectionTitle.style.cssText = 'color: #34d399; margin: 0 0 5px 0; font-size: 14px;';
          sectionDiv.appendChild(sectionTitle);
          
          const pre = document.createElement('pre');
          pre.style.cssText = 'margin: 0; padding: 10px; background: #111827; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;';
          pre.textContent = JSON.stringify(section.data, null, 2);
          sectionDiv.appendChild(pre);
          
          debugPanel.appendChild(sectionDiv);
        }
      });
      
      // æ˜¾ç¤ºé¢æ¿
      debugPanel.style.display = 'block';
      
      // 5ç§’åè‡ªåŠ¨éšè—ï¼ˆå¯é€‰ï¼‰
      setTimeout(() => {
        if (debugPanel.style.display === 'block') {
          debugPanel.style.display = 'none';
        }
      }, 10000);
    }

    // ==================== åœ°å›¾é€‰ç‚¹åŠŸèƒ½ ====================
    let mapPickerModal = null;
    let mapPickerMap = null;
    let mapPickerMarker = null;
    let mapPickerCurrentType = null; // 'common', 'second-hand', 'rentals'

    // æ‰“å¼€åœ°å›¾é€‰ç‚¹å¼¹çª—
    function openMapPicker(type) {
      mapPickerCurrentType = type;
      
      // åˆ›å»ºæˆ–æ˜¾ç¤ºå¼¹çª—
      if (!mapPickerModal) {
        createMapPickerModal();
      }
      
      mapPickerModal.style.display = 'flex';
      
      // åŠ è½½Leafletåº“ï¼ˆå¦‚æœæœªåŠ è½½ï¼‰
      if (typeof L === 'undefined') {
        loadLeafletLibrary(() => {
          initMapPicker();
        });
      } else {
        initMapPicker();
      }
    }

    // åˆ›å»ºåœ°å›¾é€‰ç‚¹å¼¹çª—
    function createMapPickerModal() {
      mapPickerModal = document.createElement('div');
      mapPickerModal.id = 'mapPickerModal';
      mapPickerModal.style.cssText = `
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      `;

      // å¼¹çª—å¤´éƒ¨
      const header = document.createElement('div');
      header.style.cssText = `
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      `;
      header.innerHTML = `
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #374151;">åœ°å›¾é€‰ç‚¹</h3>
        <button id="mapPickerCloseBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
      `;

      // æœç´¢æ¡†
      const searchContainer = document.createElement('div');
      searchContainer.style.cssText = `
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
      `;
      searchContainer.innerHTML = `
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" id="mapPickerSearchInput" placeholder="æœç´¢åœ°å€ï¼ˆå¦‚ï¼šå¼€ç½—å¸‚ä¸­å¿ƒã€Cairoï¼‰" 
            style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
          <button id="mapPickerSearchBtn" class="blog-btn blog-btn-primary" style="white-space: nowrap;">æœç´¢</button>
        </div>
        <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä½ç½®ï¼Œæˆ–æœç´¢åœ°å€åç‚¹å‡»ç»“æœ</p>
      `;

      // åœ°å›¾å®¹å™¨
      const mapContainer = document.createElement('div');
      mapContainer.id = 'mapPickerMap';
      mapContainer.style.cssText = `
        width: 100%;
        height: 500px;
        min-height: 400px;
        background: #f3f4f6;
      `;

      // åº•éƒ¨æŒ‰é’®
      const footer = document.createElement('div');
      footer.style.cssText = `
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
      `;
      footer.innerHTML = `
        <button id="mapPickerCancelBtn" class="blog-btn blog-btn-secondary">å–æ¶ˆ</button>
        <button id="mapPickerConfirmBtn" class="blog-btn blog-btn-primary">ç¡®è®¤é€‰æ‹©</button>
      `;

      modalContent.appendChild(header);
      modalContent.appendChild(searchContainer);
      modalContent.appendChild(mapContainer);
      modalContent.appendChild(footer);
      mapPickerModal.appendChild(modalContent);
      document.body.appendChild(mapPickerModal);

      // ç»‘å®šäº‹ä»¶
      document.getElementById('mapPickerCloseBtn').onclick = closeMapPicker;
      document.getElementById('mapPickerCancelBtn').onclick = closeMapPicker;
      document.getElementById('mapPickerConfirmBtn').onclick = confirmMapPicker;
      document.getElementById('mapPickerSearchBtn').onclick = searchAddress;
      document.getElementById('mapPickerSearchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          searchAddress();
        }
      });

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      mapPickerModal.addEventListener('click', (e) => {
        if (e.target === mapPickerModal) {
          closeMapPicker();
        }
      });
    }

    // åŠ è½½Leafletåº“
    function loadLeafletLibrary(callback) {
      // åŠ è½½CSS
      if (!document.querySelector('link[href*="leaflet"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css';
        link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
        link.crossOrigin = '';
        document.head.appendChild(link);
      }

      // åŠ è½½JS
      if (typeof L === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
        script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
        script.crossOrigin = '';
        script.onload = callback;
        script.onerror = () => {
          showToast('åœ°å›¾åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
        };
        document.head.appendChild(script);
      } else {
        callback();
      }
    }

    // åˆå§‹åŒ–åœ°å›¾
    function initMapPicker() {
      const mapContainer = document.getElementById('mapPickerMap');
      if (!mapContainer || !window.L) return;

      // è·å–å½“å‰ç»çº¬åº¦ï¼ˆå¦‚æœæœ‰ï¼‰
      let currentLat = 30.0444; // å¼€ç½—é»˜è®¤ä½ç½®
      let currentLng = 31.2357;
      
      const addressInput = document.getElementById(getAddressInputId());
      const latInput = document.getElementById(getLatitudeInputId());
      const lngInput = document.getElementById(getLongitudeInputId());
      
      if (latInput && latInput.value) {
        currentLat = parseFloat(latInput.value) || currentLat;
      }
      if (lngInput && lngInput.value) {
        currentLng = parseFloat(lngInput.value) || currentLng;
      }

      // æ¸…é™¤æ—§åœ°å›¾
      if (mapPickerMap) {
        mapPickerMap.remove();
        mapPickerMap = null;
        mapPickerMarker = null;
      }

      // åˆ›å»ºæ–°åœ°å›¾
      mapPickerMap = L.map('mapPickerMap').setView([currentLat, currentLng], latInput && latInput.value ? 15 : 13);

      // æ·»åŠ OpenStreetMapå›¾å±‚
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(mapPickerMap);

      // æ·»åŠ æ ‡è®°ï¼ˆå¦‚æœæœ‰ç°æœ‰å€¼ï¼‰
      if (latInput && latInput.value && lngInput && lngInput.value) {
        mapPickerMarker = L.marker([currentLat, currentLng]).addTo(mapPickerMap);
        mapPickerMarker.bindPopup(`å½“å‰ä½ç½®<br>${addressInput && addressInput.value ? escapeHtml(addressInput.value) : `${currentLat.toFixed(4)}, ${currentLng.toFixed(4)}`}`).openPopup();
        
        // å¦‚æœæœ‰åœ°å€ï¼Œæ˜¾ç¤ºåœ¨æœç´¢æ¡†
        if (addressInput && addressInput.value) {
          document.getElementById('mapPickerSearchInput').value = addressInput.value;
        } else {
          // å¦‚æœæ²¡æœ‰åœ°å€ï¼Œå°è¯•åå‘åœ°ç†ç¼–ç 
          reverseGeocode(currentLat, currentLng);
        }
      }

      // åœ°å›¾ç‚¹å‡»äº‹ä»¶
      mapPickerMap.on('click', (e) => {
        const { lat, lng } = e.latlng;
        updateMapMarker(lat, lng);
      });
    }

    // æ›´æ–°åœ°å›¾æ ‡è®°
    function updateMapMarker(lat, lng) {
      if (!mapPickerMap) return;

      if (mapPickerMarker) {
        mapPickerMarker.setLatLng([lat, lng]);
      } else {
        mapPickerMarker = L.marker([lat, lng]).addTo(mapPickerMap);
      }
      
      mapPickerMap.setView([lat, lng], mapPickerMap.getZoom());
      
      // åå‘åœ°ç†ç¼–ç è·å–åœ°å€
      reverseGeocode(lat, lng);
    }

    // æœç´¢åœ°å€
    async function searchAddress() {
      const searchInput = document.getElementById('mapPickerSearchInput');
      const query = searchInput.value.trim();
      
      if (!query) {
        showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
        return;
      }

      try {
        // ä½¿ç”¨Nominatimè¿›è¡Œåœ°ç†ç¼–ç ï¼ˆå…è´¹ï¼‰
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (!response.ok) {
          throw new Error('æœç´¢å¤±è´¥');
        }

        const results = await response.json();
        
        if (results.length === 0) {
          showToast('æœªæ‰¾åˆ°ç›¸å…³åœ°å€', 'warning');
          return;
        }

        // å¦‚æœåªæœ‰ä¸€ä¸ªç»“æœï¼Œç›´æ¥å®šä½
        if (results.length === 1) {
          const result = results[0];
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          updateMapMarker(lat, lng);
          document.getElementById('mapPickerSearchInput').value = result.display_name;
          showToast('å·²å®šä½åˆ°æœç´¢ç»“æœ', 'success');
        } else {
          // å¤šä¸ªç»“æœï¼Œæ˜¾ç¤ºé€‰æ‹©åˆ—è¡¨
          showSearchResults(results);
        }
      } catch (error) {
        console.error('åœ°å€æœç´¢å¤±è´¥:', error);
        showToast('åœ°å€æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœåˆ—è¡¨
    function showSearchResults(results) {
      // ç§»é™¤æ—§çš„ç»“æœåˆ—è¡¨
      const oldResults = document.getElementById('mapPickerSearchResults');
      if (oldResults) {
        oldResults.remove();
      }

      const resultsContainer = document.createElement('div');
      resultsContainer.id = 'mapPickerSearchResults';
      resultsContainer.style.cssText = `
        position: absolute;
        top: 80px;
        left: 1.5rem;
        right: 1.5rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        max-height: 300px;
        overflow-y: auto;
        z-index: 10001;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      `;

      results.forEach((result, index) => {
        const item = document.createElement('div');
        item.style.cssText = `
          padding: 0.75rem 1rem;
          border-bottom: 1px solid #f3f4f6;
          cursor: pointer;
          transition: background 0.2s;
        `;
        item.style.cssText += index === results.length - 1 ? 'border-bottom: none;' : '';
        item.innerHTML = `
          <div style="font-weight: 500; color: #374151; margin-bottom: 0.25rem;">${escapeHtml(result.display_name)}</div>
          <div style="font-size: 0.75rem; color: #6b7280;">${result.lat}, ${result.lon}</div>
        `;
        item.onmouseover = () => { item.style.background = '#f9fafb'; };
        item.onmouseout = () => { item.style.background = 'white'; };
        item.onclick = () => {
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          updateMapMarker(lat, lng);
          document.getElementById('mapPickerSearchInput').value = result.display_name;
          resultsContainer.remove();
          showToast('å·²å®šä½åˆ°é€‰æ‹©çš„ä½ç½®', 'success');
        };
        resultsContainer.appendChild(item);
      });

      const modalContent = mapPickerModal.querySelector('div');
      modalContent.style.position = 'relative';
      modalContent.appendChild(resultsContainer);
    }

    // åå‘åœ°ç†ç¼–ç ï¼ˆæ ¹æ®ç»çº¬åº¦è·å–åœ°å€ï¼‰
    async function reverseGeocode(lat, lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.display_name) {
            document.getElementById('mapPickerSearchInput').value = result.display_name;
          }
        }
      } catch (error) {
        console.error('åå‘åœ°ç†ç¼–ç å¤±è´¥:', error);
        // å¤±è´¥ä¸å½±å“ä½¿ç”¨ï¼Œåªæ˜¯ä¸æ˜¾ç¤ºåœ°å€
      }
    }

    // ç¡®è®¤é€‰æ‹©
    function confirmMapPicker() {
      if (!mapPickerMarker) {
        showToast('è¯·å…ˆåœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®', 'warning');
        return;
      }

      const latlng = mapPickerMarker.getLatLng();
      const lat = latlng.lat.toFixed(6);
      const lng = latlng.lng.toFixed(6);
      const address = document.getElementById('mapPickerSearchInput').value.trim();

      // æ›´æ–°å¯¹åº”çš„è¾“å…¥æ¡†
      const addressInput = document.getElementById(getAddressInputId());
      const latInput = document.getElementById(getLatitudeInputId());
      const lngInput = document.getElementById(getLongitudeInputId());

      if (addressInput) {
        addressInput.value = address || `${lat}, ${lng}`;
      }
      if (latInput) {
        latInput.value = lat;
      }
      if (lngInput) {
        lngInput.value = lng;
      }

      showToast('ä½ç½®å·²é€‰æ‹©', 'success');
      closeMapPicker();
    }

    // å…³é—­åœ°å›¾é€‰ç‚¹å¼¹çª—
    function closeMapPicker() {
      if (mapPickerModal) {
        mapPickerModal.style.display = 'none';
        // æ¸…é™¤æœç´¢ç»“æœ
        const results = document.getElementById('mapPickerSearchResults');
        if (results) {
          results.remove();
        }
      }
    }

    // è·å–å½“å‰ç±»å‹çš„è¾“å…¥æ¡†ID
    function getAddressInputId() {
      switch (mapPickerCurrentType) {
        case 'second-hand':
          return 'secondHandAddress';
        case 'rentals':
          return 'rentalsAddress';
        case 'common':
        default:
          return 'commonAddress';
      }
    }

    function getLatitudeInputId() {
      switch (mapPickerCurrentType) {
        case 'second-hand':
          return 'secondHandLatitude';
        case 'rentals':
          return 'rentalsLatitude';
        case 'common':
        default:
          return 'commonLatitude';
      }
    }

    function getLongitudeInputId() {
      switch (mapPickerCurrentType) {
        case 'second-hand':
          return 'secondHandLongitude';
        case 'rentals':
          return 'rentalsLongitude';
        case 'common':
        default:
          return 'commonLongitude';
      }
    }

    // ==================== è°·æ­Œåœ°å›¾é“¾æ¥è§£æåŠŸèƒ½ ====================
    let linkParserModal = null;
    let linkParserCurrentType = null;

    // æ‰“å¼€é“¾æ¥è§£æå¼¹çª—
    function openLinkParser(type) {
      linkParserCurrentType = type;
      
      // åˆ›å»ºæˆ–æ˜¾ç¤ºå¼¹çª—
      if (!linkParserModal) {
        createLinkParserModal();
      }
      
      linkParserModal.style.display = 'flex';
      const input = document.getElementById('linkParserInput');
      if (input) {
        input.value = '';
        input.focus();
      }
    }

    // åˆ›å»ºé“¾æ¥è§£æå¼¹çª—
    function createLinkParserModal() {
      linkParserModal = document.createElement('div');
      linkParserModal.id = 'linkParserModal';
      linkParserModal.style.cssText = `
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 600px;
        padding: 2rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      `;

      // å¼¹çª—å¤´éƒ¨
      const header = document.createElement('div');
      header.style.cssText = `
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      `;
      header.innerHTML = `
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #374151;">è§£æè°·æ­Œåœ°å›¾é“¾æ¥</h3>
        <button id="linkParserCloseBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
      `;

      // è¾“å…¥æ¡†
      const inputContainer = document.createElement('div');
      inputContainer.style.cssText = `margin-bottom: 1rem;`;
      inputContainer.innerHTML = `
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥ï¼š</label>
        <input type="text" id="linkParserInput" placeholder="ä¾‹å¦‚ï¼šhttps://www.google.com/maps?q=30.0444,31.2357 æˆ– https://maps.google.com/?q=å¼€ç½—" 
          style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-sizing: border-box;">
        <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">
          æ”¯æŒæ ¼å¼ï¼š<br>
          â€¢ https://www.google.com/maps?q=30.0444,31.2357<br>
          â€¢ https://maps.google.com/?q=åœ°å€åç§°<br>
          â€¢ https://www.google.com/maps/@30.0444,31.2357,15z<br>
          â€¢ https://www.google.com/maps/place/.../@30.0444,31.2357,15z<br>
          â€¢ https://maps.app.goo.gl/...ï¼ˆçŸ­é“¾æ¥ï¼‰<br>
          â€¢ https://goo.gl/maps/...ï¼ˆçŸ­é“¾æ¥ï¼‰
        </p>
      `;

      // åº•éƒ¨æŒ‰é’®
      const footer = document.createElement('div');
      footer.style.cssText = `
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1.5rem;
      `;
      footer.innerHTML = `
        <button id="linkParserCancelBtn" class="blog-btn blog-btn-secondary">å–æ¶ˆ</button>
        <button id="linkParserParseBtn" class="blog-btn blog-btn-primary">è§£æå¹¶å¡«å……</button>
      `;

      modalContent.appendChild(header);
      modalContent.appendChild(inputContainer);
      modalContent.appendChild(footer);
      linkParserModal.appendChild(modalContent);
      document.body.appendChild(linkParserModal);

      // ç»‘å®šäº‹ä»¶
      document.getElementById('linkParserCloseBtn').onclick = closeLinkParser;
      document.getElementById('linkParserCancelBtn').onclick = closeLinkParser;
      document.getElementById('linkParserParseBtn').onclick = parseGoogleMapsLink;
      document.getElementById('linkParserInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          parseGoogleMapsLink();
        }
      });

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      linkParserModal.addEventListener('click', (e) => {
        if (e.target === linkParserModal) {
          closeLinkParser();
        }
      });
    }

    // è§£æè°·æ­Œåœ°å›¾é“¾æ¥
    async function parseGoogleMapsLink() {
      const input = document.getElementById('linkParserInput');
      const link = input.value.trim();
      
      if (!link) {
        showToast('è¯·è¾“å…¥è°·æ­Œåœ°å›¾é“¾æ¥', 'warning');
        return;
      }

      try {
        // æ£€æŸ¥æ˜¯å¦æ˜¯çŸ­é“¾æ¥ï¼ˆgoo.gl æˆ– maps.app.goo.glï¼‰
        const isShortLink = /^(https?:\/\/)?(maps\.app\.)?goo\.gl\/.+$/i.test(link) || 
                            /^(https?:\/\/)?maps\.app\.goo\.gl\/.+$/i.test(link);

        let lat = null;
        let lng = null;
        let address = null;

        // å¦‚æœæ˜¯çŸ­é“¾æ¥ï¼Œä½¿ç”¨åç«¯APIè§£æ
        if (isShortLink) {
          try {
            // ä½¿ç”¨adminApiRequestå‡½æ•°ç¡®ä¿æ­£ç¡®çš„è®¤è¯å’Œé”™è¯¯å¤„ç†
            const result = await adminApiRequest('/api/admin/parse-google-maps-link', {
              method: 'POST',
              body: JSON.stringify({ link: link })
            });
            
            if (!result) {
              // adminApiRequestè¿”å›nullè¡¨ç¤ºéœ€è¦ç™»å½•
              return;
            }
            
            if (result.success && result.data) {
              lat = result.data.lat;
              lng = result.data.lng;
              address = result.data.address;
              
              // å¦‚æœåç«¯è¿”å›äº†ç»çº¬åº¦
              if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
                // å¦‚æœæ²¡æœ‰åœ°å€ï¼Œå°è¯•åå‘åœ°ç†ç¼–ç 
                if (!address) {
                  try {
                    const addressResult = await reverseGeocodeFromLink(lat, lng);
                    if (addressResult) {
                      address = addressResult;
                    }
                  } catch (error) {
                    console.warn('åå‘åœ°ç†ç¼–ç å¤±è´¥ï¼Œå°†åªå¡«å……ç»çº¬åº¦:', error);
                  }
                }
                
                fillLocationFields(lat, lng, address);
                showToast('ä½ç½®ä¿¡æ¯å·²å¡«å……', 'success');
                closeLinkParser();
                return;
              }
              
              // å¦‚æœåªæœ‰åœ°å€åç§°ï¼Œè¿›è¡Œåœ°ç†ç¼–ç 
              if (address && (lat === null || lng === null)) {
                try {
                  const geocodeResult = await geocodeAddress(address);
                  if (geocodeResult && geocodeResult.lat && geocodeResult.lng) {
                    fillLocationFields(geocodeResult.lat, geocodeResult.lng, geocodeResult.address || address);
                    showToast('ä½ç½®ä¿¡æ¯å·²å¡«å……', 'success');
                    closeLinkParser();
                    return;
                  }
                } catch (error) {
                  console.error('åœ°ç†ç¼–ç å¤±è´¥:', error);
                }
              }
            } else {
              showToast(result.message || 'æ— æ³•è§£æè¯¥çŸ­é“¾æ¥', 'error');
              return;
            }
          } catch (error) {
            console.error('åç«¯è§£æçŸ­é“¾æ¥å¤±è´¥:', error);
            showToast('çŸ­é“¾æ¥è§£æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            return;
          }
        } else {
          // é•¿é“¾æ¥ï¼Œä½¿ç”¨å‰ç«¯è§£æ
          // è§£æå„ç§è°·æ­Œåœ°å›¾é“¾æ¥æ ¼å¼
          // æ ¼å¼1: https://www.google.com/maps?q=30.0444,31.2357
          // æ ¼å¼2: https://maps.google.com/?q=30.0444,31.2357
          let match = link.match(/[?&]q=([^&]+)/);
          if (match) {
            const qValue = decodeURIComponent(match[1]);
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç»çº¬åº¦æ ¼å¼ (lat,lng)
            const coordsMatch = qValue.match(/^(-?\d+\.?\d*),(-?\d+\.?\d*)$/);
            if (coordsMatch) {
              lat = parseFloat(coordsMatch[1]);
              lng = parseFloat(coordsMatch[2]);
            } else {
              // å¦åˆ™æ˜¯åœ°å€åç§°ï¼Œéœ€è¦åœ°ç†ç¼–ç 
              address = qValue;
            }
          }

          // æ ¼å¼3: https://www.google.com/maps/@30.0444,31.2357,15z
          // æ ¼å¼4: https://www.google.com/maps/place/.../@30.0444,31.2357,15z
          if (lat === null || lng === null) {
            match = link.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
          }

          // æ ¼å¼5: ç›´æ¥åŒ…å«ç»çº¬åº¦çš„URLå‚æ•°
          if (lat === null || lng === null) {
            match = link.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
          }

          // æ ¼å¼6: placeé“¾æ¥ï¼Œå°è¯•ä»URLä¸­æå–
          if (lat === null || lng === null) {
            match = link.match(/place\/[^/]+\/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
          }

          // å¦‚æœæ‰¾åˆ°äº†ç»çº¬åº¦
          if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
            // éªŒè¯ç»çº¬åº¦èŒƒå›´
            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
              // ä½¿ç”¨åå‘åœ°ç†ç¼–ç è·å–åœ°å€
              try {
                const addressResult = await reverseGeocodeFromLink(lat, lng);
                if (addressResult) {
                  address = addressResult;
                }
              } catch (error) {
                console.warn('åå‘åœ°ç†ç¼–ç å¤±è´¥ï¼Œå°†åªå¡«å……ç»çº¬åº¦:', error);
              }
              
              // å¡«å……å­—æ®µ
              fillLocationFields(lat, lng, address);
              showToast('ä½ç½®ä¿¡æ¯å·²å¡«å……', 'success');
              closeLinkParser();
              return;
            }
          }

          // å¦‚æœåªæœ‰åœ°å€åç§°ï¼Œè¿›è¡Œåœ°ç†ç¼–ç 
          if (address) {
            try {
              const result = await geocodeAddress(address);
              if (result && result.lat && result.lng) {
                fillLocationFields(result.lat, result.lng, result.address || address);
                showToast('ä½ç½®ä¿¡æ¯å·²å¡«å……', 'success');
                closeLinkParser();
                return;
              }
            } catch (error) {
              console.error('åœ°ç†ç¼–ç å¤±è´¥:', error);
              showToast('æ— æ³•è§£æè¯¥é“¾æ¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ ¼å¼', 'error');
              return;
            }
          }

          // å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°
          showToast('æ— æ³•ä»é“¾æ¥ä¸­æå–ä½ç½®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ ¼å¼', 'error');
        }
      } catch (error) {
        console.error('è§£æé“¾æ¥å¤±è´¥:', error);
        showToast('è§£æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    // åå‘åœ°ç†ç¼–ç ï¼ˆä»ç»çº¬åº¦è·å–åœ°å€ï¼‰
    async function reverseGeocodeFromLink(lat, lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          return result.display_name || null;
        }
      } catch (error) {
        console.error('åå‘åœ°ç†ç¼–ç å¤±è´¥:', error);
      }
      return null;
    }

    // åœ°ç†ç¼–ç ï¼ˆä»åœ°å€è·å–ç»çº¬åº¦ï¼‰
    async function geocodeAddress(address) {
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (response.ok) {
          const results = await response.json();
          if (results.length > 0) {
            const result = results[0];
            return {
              lat: parseFloat(result.lat),
              lng: parseFloat(result.lon),
              address: result.display_name
            };
          }
        }
      } catch (error) {
        console.error('åœ°ç†ç¼–ç å¤±è´¥:', error);
      }
      return null;
    }

    // å¡«å……ä½ç½®å­—æ®µ
    function fillLocationFields(lat, lng, address) {
      const addressInput = document.getElementById(getAddressInputIdForParser());
      const latInput = document.getElementById(getLatitudeInputIdForParser());
      const lngInput = document.getElementById(getLongitudeInputIdForParser());

      if (addressInput) {
        addressInput.value = address || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
      if (latInput) {
        latInput.value = lat.toFixed(6);
      }
      if (lngInput) {
        lngInput.value = lng.toFixed(6);
      }
    }

    // è·å–å½“å‰ç±»å‹çš„è¾“å…¥æ¡†IDï¼ˆç”¨äºé“¾æ¥è§£æï¼‰
    function getAddressInputIdForParser() {
      switch (linkParserCurrentType) {
        case 'second-hand':
          return 'secondHandAddress';
        case 'rentals':
          return 'rentalsAddress';
        case 'common':
        default:
          return 'commonAddress';
      }
    }

    function getLatitudeInputIdForParser() {
      switch (linkParserCurrentType) {
        case 'second-hand':
          return 'secondHandLatitude';
        case 'rentals':
          return 'rentalsLatitude';
        case 'common':
        default:
          return 'commonLatitude';
      }
    }

    function getLongitudeInputIdForParser() {
      switch (linkParserCurrentType) {
        case 'second-hand':
          return 'secondHandLongitude';
        case 'rentals':
          return 'rentalsLongitude';
        case 'common':
        default:
          return 'commonLongitude';
      }
    }

    // å…³é—­é“¾æ¥è§£æå¼¹çª—
    function closeLinkParser() {
      if (linkParserModal) {
        linkParserModal.style.display = 'none';
        const input = document.getElementById('linkParserInput');
        if (input) {
          input.value = '';
        }
      }
    }
  </script>
</body>
</html>
