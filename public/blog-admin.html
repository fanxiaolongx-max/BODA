<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>博客管理 - DevBlog</title>
  <link rel="stylesheet" href="/css/blog.css">
  <style>
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .admin-tabs {
      display: flex;
      gap: 1rem;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 2rem;
    }
    .admin-tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: #6b7280;
      transition: all 0.3s;
    }
    .admin-tab.active {
      color: #9333ea;
      border-bottom-color: #9333ea;
    }
    .admin-tab-content {
      display: none;
    }
    .admin-tab-content.active {
      display: block;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .admin-table th {
      background: linear-gradient(to right, rgba(236, 72, 153, 0.1), rgba(147, 51, 234, 0.1));
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #171717;
    }
    .admin-table td {
      padding: 1rem;
      border-top: 1px solid #f3f4f6;
    }
    .admin-table tr:hover {
      background: rgba(147, 51, 234, 0.05);
    }
    .admin-table tr.category-header-row:hover {
      background: linear-gradient(to right, rgba(236, 72, 153, 0.15), rgba(147, 51, 234, 0.15));
    }
    .admin-table tr.category-header-row + tr {
      border-top: 2px solid rgba(147, 51, 234, 0.2);
    }
    .admin-form {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .admin-form-group {
      margin-bottom: 1.5rem;
    }
    .admin-form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #374151;
    }
    .admin-form-input,
    .admin-form-textarea,
    .admin-form-select {
      width: 100%;
      max-width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      box-sizing: border-box;
    }
    
    /* 特殊类别表单中的输入框样式 */
    .weather-item .admin-form-input,
    .weather-item .admin-form-select,
    .exchange-rate-item .admin-form-input {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    /* 确保grid布局中的输入框不会溢出 */
    .weather-item > div[style*="grid"],
    .exchange-rate-item > div[style*="grid"] {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .weather-item .admin-form-group,
    .exchange-rate-item .admin-form-group {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .admin-form-textarea {
      min-height: 200px;
      font-family: monospace;
    }
    .admin-form-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* 文章表单加载提示样式 */
    .post-form-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      min-height: 300px;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #9333ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    
    .loading-text {
      color: #6b7280;
      font-size: 0.875rem;
      margin: 0;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    /* 加载时隐藏表单内容 */
    #postForm.loading #postFormContent {
      display: none;
    }
    
    #postForm.loading #postFormLoading {
      display: flex !important;
    }
    .admin-actions {
      display: flex;
      gap: 0.5rem;
    }
    .admin-btn-small {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }
    .admin-btn-edit {
      background: #3b82f6;
      color: white;
    }
    .admin-btn-edit:hover {
      background: #2563eb;
    }
    .admin-btn-delete {
      background: #ef4444;
      color: white;
    }
    .admin-btn-delete:hover {
      background: #dc2626;
    }
    .admin-btn-approve {
      background: #10b981;
      color: white;
    }
    .admin-btn-approve:hover {
      background: #059669;
    }
    .markdown-editor {
      min-height: 400px;
    }
    
    /* SimpleMDE 工具栏样式修复 */
    .editor-toolbar {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem 0.375rem 0 0;
      background: #f9fafb;
      padding: 0.5rem;
    }
    
    .editor-toolbar a {
      color: #374151;
      border: 1px solid transparent;
      border-radius: 0.25rem;
      padding: 0.375rem 0.5rem;
      margin: 0 0.125rem;
      display: inline-block;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .editor-toolbar a:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      color: #111827;
    }
    
    .editor-toolbar a.active {
      background: #9333ea;
      color: white;
      border-color: #9333ea;
    }
    
    .editor-toolbar i.separator {
      display: inline-block;
      width: 0;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      color: transparent;
      text-indent: -10000px;
      margin: 0 0.5rem;
      height: 1.5rem;
    }
    
    .editor-toolbar a.fa {
      font-family: FontAwesome;
      font-style: normal;
      font-weight: normal;
      text-decoration: none;
    }
    
    .CodeMirror {
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.375rem 0.375rem;
      font-size: 0.875rem;
      min-height: 400px;
    }
    
    .editor-preview {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 1rem;
      background: white;
    }
    
    .editor-preview-side {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 1rem;
      background: white;
    }
  </style>
  <!-- Font Awesome for SimpleMDE toolbar icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <!-- SimpleMDE Markdown Editor -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  <!-- Quill HTML Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
</head>
<body class="blog-page">
  <div class="admin-container">
    <div class="admin-header">
      <div>
        <h1 style="font-size: 2rem; font-weight: bold; background: linear-gradient(to right, #ec4899, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
          博客管理
        </h1>
        <p style="color: #6b7280; margin-top: 0.5rem;">管理文章、分类、标签和评论</p>
      </div>
      <div>
        <a href="/blog.html" class="blog-btn blog-btn-secondary">返回博客</a>
      </div>
    </div>

    <!-- 标签页 -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('posts', this)">文章</button>
      <button class="admin-tab" onclick="switchTab('categories', this)">分类</button>
      <button class="admin-tab" onclick="switchTab('tags', this)">标签</button>
      <button class="admin-tab" onclick="switchTab('comments', this)">评论</button>
    </div>

    <!-- 文章管理 -->
    <div id="tab-posts" class="admin-tab-content active">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>文章管理</h2>
        <button class="blog-btn blog-btn-primary" onclick="showPostForm()">新建文章</button>
      </div>

      <!-- 文章表单 -->
      <div id="postForm" class="admin-form" style="display: none;">
        <!-- 加载提示 -->
        <div id="postFormLoading" class="post-form-loading" style="display: none;">
          <div class="loading-spinner"></div>
          <p class="loading-text">正在加载文章内容...</p>
        </div>
        <!-- 表单内容 -->
        <div id="postFormContent">
        <h3 id="postFormTitle">新建文章</h3>
        <form id="postFormElement" onsubmit="savePost(event)">
          <input type="hidden" id="postId">
          <div class="admin-form-group">
            <label class="admin-form-label" for="postName">文章名称/标题 *</label>
            <input type="text" id="postName" class="admin-form-input" required oninput="syncNameAndTitle()">
            <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">名称和标题会自动保持同步</p>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postSlug">Slug</label>
            <input type="text" id="postSlug" class="admin-form-input" placeholder="留空自动生成">
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postExcerpt">摘要</label>
            <textarea id="postExcerpt" class="admin-form-input" rows="3"></textarea>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postImage">图片URL</label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
              <input type="text" id="postImage" class="admin-form-input" style="flex: 1;" placeholder="输入图片URL或点击上传按钮上传图片">
              <button type="button" class="blog-btn blog-btn-secondary" onclick="document.getElementById('imageUploadInput').click()" style="white-space: nowrap;">
                <i class="fa fa-upload" style="margin-right: 0.25rem;"></i>上传图片
              </button>
            </div>
            <input type="file" id="imageUploadInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <div id="imageUploadProgress" style="display: none; margin-top: 0.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="flex: 1; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                  <div id="imageUploadProgressBar" style="height: 100%; background: #9333ea; width: 0%; transition: width 0.3s;"></div>
                </div>
                <span id="imageUploadStatus" style="font-size: 0.875rem; color: #6b7280;">上传中...</span>
              </div>
            </div>
            <div id="imagePreview" style="margin-top: 0.5rem; display: none;">
              <img id="imagePreviewImg" src="" alt="预览" style="max-width: 200px; max-height: 200px; border-radius: 0.375rem; border: 1px solid #d1d5db;">
            </div>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postApiName">API/分类 *</label>
            <select id="postApiName" class="admin-form-select" required onchange="onApiNameChange()">
              <option value="">请选择API（分类）</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">选择文章所属的API，API名称将作为文章分类</p>
          </div>
          <div class="admin-form-group" id="fieldMappingInfo" style="display: none;">
            <div class="text-sm text-blue-600">
              <p>此API已配置字段映射，文章将根据映射规则保存到对应字段</p>
            </div>
          </div>
          
          <!-- 特殊类别定制化表单 -->
          <!-- 翻译卡片 (translation) -->
          <div id="specialForm-translation" class="admin-form-group" style="display: none;">
            <h4 style="color: #9333ea; margin-bottom: 1rem;">翻译卡片编辑</h4>
            <div class="admin-form-group" style="max-width: 500px;">
              <label class="admin-form-label" for="translationChinese">中文 *</label>
              <input type="text" id="translationChinese" class="admin-form-input" placeholder="输入中文" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 500px;">
              <label class="admin-form-label" for="translationArabic">阿拉伯文 *</label>
              <input type="text" id="translationArabic" class="admin-form-input" placeholder="输入阿拉伯文" dir="rtl" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="translationCategory">分类</label>
              <input type="text" id="translationCategory" class="admin-form-input" placeholder="如：问候、礼貌、购物等" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- 天气路况 (weather) -->
          <div id="specialForm-weather" class="admin-form-group" style="display: none;">
            <h4 style="color: #3b82f6; margin-bottom: 1rem;">天气路况编辑</h4>
            
            <!-- Global Alert 全局预警 -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <h5 style="color: #3b82f6; margin-bottom: 0.75rem;">全局预警 (Global Alert)</h5>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="weatherGlobalAlertLevel">预警级别</label>
              <select id="weatherGlobalAlertLevel" class="admin-form-select" style="width: 100%; max-width: 100%; box-sizing: border-box;">
                <option value="low">低 (low)</option>
                <option value="medium">中 (medium)</option>
                <option value="high">高 (high)</option>
              </select>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="weatherGlobalAlertMessage">预警消息 *</label>
              <textarea id="weatherGlobalAlertMessage" class="admin-form-input" rows="3" placeholder="输入预警消息" style="width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
            </div>
            </div>
            
            <!-- Attractions 景点天气 -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #3b82f6; margin: 0;">景点天气 (Attractions)</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addWeatherAttraction()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>添加景点
                </button>
              </div>
              <div id="weatherAttractionsList"></div>
            </div>
            
            <!-- Traffic 路况信息 -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #3b82f6; margin: 0;">路况信息 (Traffic)</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addWeatherTraffic()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>添加路况
                </button>
              </div>
              <div id="weatherTrafficList"></div>
            </div>
          </div>
          
          <!-- 汇率转换 (exchange-rate) -->
          <div id="specialForm-exchange-rate" class="admin-form-group" style="display: none;">
            <h4 style="color: #10b981; margin-bottom: 1rem;">汇率转换编辑</h4>
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #10b981; margin: 0;">汇率列表</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addExchangeRate()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>添加汇率
                </button>
              </div>
              <div id="exchangeRatesList"></div>
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="exchangeUpdateTime">更新时间</label>
              <input type="datetime-local" id="exchangeUpdateTime" class="admin-form-input" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- 二手市场 (second-hand) 特殊字段 -->
          <div id="specialForm-second-hand" class="admin-form-group" style="display: none;">
            <h4 style="color: #f59e0b; margin-bottom: 1rem;">二手市场特殊字段</h4>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="secondHandPrice">价格 *</label>
              <input type="text" id="secondHandPrice" class="admin-form-input" placeholder="如：500、1000等" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="secondHandPhone">联系方式 *</label>
              <input type="text" id="secondHandPhone" name="secondHandPhone" class="admin-form-input" placeholder="如：+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="secondHandAddress">地址 *</label>
              <input type="text" id="secondHandAddress" name="secondHandAddress" class="admin-form-input" placeholder="如：开罗市中心，Heliopolis 区" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 100%;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="secondHandLatitude">纬度 *</label>
                <input type="number" step="any" id="secondHandLatitude" name="secondHandLatitude" class="admin-form-input" placeholder="如：30.0444" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="secondHandLongitude">经度 *</label>
                <input type="number" step="any" id="secondHandLongitude" name="secondHandLongitude" class="admin-form-input" placeholder="如：31.2357" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
            </div>
          </div>
          
          <!-- 租房酒店 (rentals) 特殊字段 -->
          <div id="specialForm-rentals" class="admin-form-group" style="display: none;">
            <h4 style="color: #8b5cf6; margin-bottom: 1rem;">租房酒店特殊字段</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; width: 100%; max-width: 100%; box-sizing: border-box;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsPrice">价格 *</label>
                <input type="text" id="rentalsPrice" class="admin-form-input" placeholder="如：3500" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsRooms">房间数 *</label>
                <input type="text" id="rentalsRooms" class="admin-form-input" placeholder="如：2" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsArea">面积 *</label>
                <input type="text" id="rentalsArea" class="admin-form-input" placeholder="如：80" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsViews">浏览次数</label>
                <input type="number" id="rentalsViews" class="admin-form-input" placeholder="如：1" min="0" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="rentalsPhone">联系方式 *</label>
              <input type="text" id="rentalsPhone" name="rentalsPhone" class="admin-form-input" placeholder="如：+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="rentalsAddress">地址 *</label>
              <input type="text" id="rentalsAddress" name="rentalsAddress" class="admin-form-input" placeholder="如：开罗市中心，Heliopolis 区" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 100%;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsLatitude">纬度 *</label>
                <input type="number" step="any" id="rentalsLatitude" name="rentalsLatitude" class="admin-form-input" placeholder="如：30.0444" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsLongitude">经度 *</label>
                <input type="number" step="any" id="rentalsLongitude" name="rentalsLongitude" class="admin-form-input" placeholder="如：31.2357" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
            </div>
          </div>
          
          <!-- 通用位置字段（用于其他需要位置的分类） -->
          <div id="commonLocationFields" class="admin-form-group" style="display: none;">
            <h4 style="color: #059669; margin-bottom: 1rem;">位置信息</h4>
            <div class="admin-form-group" id="commonPhoneField" style="max-width: 300px; display: none;">
              <label class="admin-form-label" id="commonPhoneLabel" for="commonPhone">联系方式 *</label>
              <input type="text" id="commonPhone" name="commonPhone" class="admin-form-input" placeholder="如：+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" id="commonAddressLabel" for="commonAddress">地址 *</label>
              <input type="text" id="commonAddress" name="commonAddress" class="admin-form-input" placeholder="如：开罗市中心，Heliopolis 区" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 100%;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" id="commonLatitudeLabel" for="commonLatitude">纬度 *</label>
                <input type="number" step="any" id="commonLatitude" name="commonLatitude" class="admin-form-input" placeholder="如：30.0444" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" id="commonLongitudeLabel" for="commonLongitude">经度 *</label>
                <input type="number" step="any" id="commonLongitude" name="commonLongitude" class="admin-form-input" placeholder="如：31.2357" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label" for="postCategory">分类/标签 *</label>
            <input type="text" id="postCategory" class="admin-form-input" placeholder="文章分类（作为标签使用）" required>
            <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">此分类用于在博客页面作为标签展示</p>
          </div>
          <div class="admin-form-group" style="display: none;">
            <label class="admin-form-label" for="postTags">标签（已废弃，使用上面的分类字段）</label>
            <input type="text" id="postTags" class="admin-form-input" placeholder="标签1, 标签2" disabled>
          </div>
          <div class="admin-form-group" id="normalContentEditor">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <label class="admin-form-label" for="postContent" style="margin-bottom: 0;">内容 *</label>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 0.875rem; color: #6b7280;">编辑模式：</span>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="radio" name="editorMode" value="markdown" checked onchange="switchEditorMode('markdown')">
                  <span>Markdown</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="radio" name="editorMode" value="html" onchange="switchEditorMode('html')">
                  <span>HTML</span>
                </label>
              </div>
            </div>
            <div id="markdownEditorContainer">
              <textarea id="postContent" class="admin-form-textarea markdown-editor"></textarea>
            </div>
            <div id="htmlEditorContainer" style="display: none;">
              <div id="postHtmlContent" style="min-height: 400px;"></div>
            </div>
          </div>
          <div class="admin-form-group">
            <div class="admin-form-checkbox">
              <input type="checkbox" id="postPublished">
              <label for="postPublished">发布</label>
            </div>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">保存</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hidePostForm()">取消</button>
          </div>
        </form>
        </div>
      </div>

      <!-- 文章列表 -->
      <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <table class="admin-table">
          <thead>
            <tr>
              <th>标题</th>
              <th>分类</th>
              <th>状态</th>
              <th>阅读量</th>
              <th>日期</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="postsTableBody">
            <tr><td colspan="6" class="blog-loading">加载中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 分类管理 -->
    <div id="tab-categories" class="admin-tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>分类管理</h2>
        <button class="blog-btn blog-btn-primary" onclick="showCategoryForm()">新建分类</button>
      </div>

      <div id="categoryForm" class="admin-form" style="display: none;">
        <h3 id="categoryFormTitle">新建分类</h3>
        <form id="categoryFormElement" onsubmit="saveCategory(event)">
          <input type="hidden" id="categoryId">
          <div class="admin-form-group">
            <label class="admin-form-label" for="categoryName">分类名称 *</label>
            <input type="text" id="categoryName" class="admin-form-input" required>
            <p class="text-xs text-gray-500 mt-1">此名称将显示在博客分类列表中</p>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="categoryPath">分类路径/描述 *</label>
            <input type="text" id="categoryPath" class="admin-form-input" required placeholder="/category-name">
            <p class="text-xs text-gray-500 mt-1">路径必须以 / 开头，将作为分类的描述信息</p>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">保存</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hideCategoryForm()">取消</button>
          </div>
        </form>
      </div>

      <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <table class="admin-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>路径/描述</th>
              <th>文章数</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="categoriesTableBody">
            <tr><td colspan="4" class="blog-loading">加载中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 标签管理 -->
    <div id="tab-tags" class="admin-tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>标签管理</h2>
        <button class="blog-btn blog-btn-primary" onclick="showTagForm()">新建标签</button>
      </div>

      <div id="tagForm" class="admin-form" style="display: none;">
        <h3>新建标签</h3>
        <form onsubmit="saveTag(event)">
          <div class="admin-form-group">
            <label class="admin-form-label" for="tagName">标签名称 *</label>
            <input type="text" id="tagName" class="admin-form-input" required>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">保存</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hideTagForm()">取消</button>
          </div>
        </form>
      </div>

      <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <table class="admin-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>文章数</th>
            </tr>
          </thead>
          <tbody id="tagsTableBody">
            <tr><td colspan="2" class="blog-loading">加载中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- 评论管理 -->
    <div id="tab-comments" class="admin-tab-content">
      <h2>评论管理</h2>
      <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <table class="admin-table">
          <thead>
            <tr>
              <th>文章</th>
              <th>作者</th>
              <th>内容</th>
              <th>状态</th>
              <th>日期</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="commentsTableBody">
            <tr><td colspan="6" class="blog-loading">加载中...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="/utils/blog.js"></script>
  <script>
    const BLOG_ADMIN_API = '/api/blog-admin';
    let simpleMDE = null;
    let quillEditor = null;
    let currentEditorMode = 'markdown'; // 'markdown' or 'html'
    let availableApis = [];
    let allPostsData = []; // 存储所有文章数据
    let expandedCategories = new Set(); // 存储已展开的分类
    let exchangeRatesCounter = 0; // 汇率转换计数器

    // 加载API列表
    async function loadApis() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/apis`);
        if (response && response.success) {
          availableApis = response.data || [];
          updateApiSelect();
        }
      } catch (error) {
        console.error('加载API列表失败:', error);
      }
    }

    // 更新API选择下拉框
    function updateApiSelect() {
      const select = document.getElementById('postApiName');
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">请选择API（分类）</option>';
      
      availableApis.forEach(api => {
        const option = document.createElement('option');
        option.value = api.name;
        option.textContent = `${api.name} (${api.path})`;
        select.appendChild(option);
      });
      
      if (currentValue) {
        select.value = currentValue;
      }
    }

    // 特殊类别定义
    const SPECIAL_CATEGORIES = {
      'weather': {
        name: 'weather',
        displayName: '天气路况',
      },
      'second-hand': {
        name: 'second-hand',
        displayName: '二手市场',
      },
      'rentals': {
        name: 'rentals',
        displayName: '租房酒店',
        color: '#3b82f6',
        fields: ['city', 'temperature', 'condition', 'traffic', 'humidity', 'wind']
      },
      'exchange-rate': {
        name: 'exchange-rate',
        displayName: '汇率转换',
        color: '#10b981',
        fields: ['fromCurrency', 'toCurrency', 'rate', 'updateTime']
      },
      'translation': {
        name: 'translation',
        displayName: '翻译卡片',
        color: '#9333ea',
        fields: ['chinese', 'arabic', 'category']
      }
    };
    
    // 检查是否是特殊类别
    function isSpecialCategory(apiName) {
      if (!apiName) return null;
      // 检查API名称或路径是否匹配
      const lowerName = apiName.toLowerCase();
      if (lowerName === 'weather' || lowerName.includes('weather')) {
        return 'weather';
      }
      if (lowerName === 'exchange-rate' || lowerName === 'exchangerate' || lowerName.includes('exchange')) {
        return 'exchange-rate';
      }
      if (lowerName === 'translation' || lowerName.includes('translation')) {
        return 'translation';
      }
      // 检测二手市场
      if (lowerName === 'second-hand' || lowerName.includes('second-hand') || lowerName.includes('secondhand') || lowerName.includes('二手')) {
        return 'second-hand';
      }
      // 检测租房酒店
      if (lowerName === 'rentals' || lowerName.includes('rental') || lowerName.includes('租房') || lowerName.includes('酒店')) {
        return 'rentals';
      }
      return null;
    }
    
    // API选择改变时的处理
    // 检查是否需要位置信息（latitude, longitude, address）
    function needsLocationFields(apiName) {
      // 所有分类都支持位置字段（可选）
      if (!apiName) return false;
      return true;
    }

    // 检查是否需要电话字段（所有分类都支持电话字段，作为可选）
    function needsPhoneField(apiName) {
      // 所有分类都支持电话字段（可选）
      if (!apiName) return false;
      return true;
    }

    // 检查位置字段是否为必填（必填：寻味中国、常用导航、打卡地、租房、二手集市、热门活动；可选：签证指南、攻略指南、尼罗河应用、防骗指南）
    function isLocationRequired(apiName) {
      if (!apiName) return false;
      const lowerName = apiName.toLowerCase();
      // 必填位置字段的分类
      return lowerName.includes('chinese-food') || 
             lowerName.includes('寻味') || 
             lowerName.includes('location-list') ||
             lowerName.includes('导航') || 
             lowerName.includes('hot-spots') ||
             lowerName.includes('打卡') ||
             lowerName.includes('rental-list') ||
             lowerName.includes('rentals') || 
             lowerName.includes('租房') || 
             lowerName.includes('酒店') ||
             lowerName.includes('second-hand') || 
             lowerName.includes('二手') ||
             lowerName.includes('hot-activity') ||
             (lowerName.includes('活动') && !lowerName.includes('签证') && !lowerName.includes('攻略') && !lowerName.includes('防骗'));
    }

    async function onApiNameChange() {
      const apiName = document.getElementById('postApiName').value;
      const mappingInfo = document.getElementById('fieldMappingInfo');
      
      // 检查是否是特殊类别
      const specialType = isSpecialCategory(apiName);
      const needsLocation = needsLocationFields(apiName);
      
      // 隐藏所有特殊表单
      document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
        el.style.display = 'none';
      });

      // 显示/隐藏通用位置字段
      const commonLocationFields = document.getElementById('commonLocationFields');
      if (commonLocationFields) {
        // 如果已经在特殊表单中显示了位置字段（如rentals或second-hand），就不显示通用位置字段
        const hasLocationInSpecialForm = (specialType === 'rentals' || specialType === 'second-hand');
        // 所有分类都显示位置字段（除了特殊表单的分类）
        const shouldShow = needsLocation && !hasLocationInSpecialForm;
        commonLocationFields.style.display = shouldShow ? 'block' : 'none';
        
        // 显示/隐藏电话字段（所有分类都支持）
        const needsPhone = needsPhoneField(apiName);
        const hasPhoneInSpecialForm = (specialType === 'rentals' || specialType === 'second-hand');
        // 所有分类都显示电话字段（除了特殊表单的分类）
        const shouldShowPhone = needsPhone && !hasPhoneInSpecialForm && shouldShow;
        
        // 判断电话字段是否为必填（寻味中国必填，防骗指南等可选）
        const lowerName = apiName.toLowerCase();
        const isPhoneRequired = lowerName.includes('chinese-food') || lowerName.includes('寻味');
        
        const commonPhoneField = document.getElementById('commonPhoneField');
        const commonPhoneInput = document.getElementById('commonPhone');
        const commonPhoneLabel = document.getElementById('commonPhoneLabel');
        if (commonPhoneField) {
          commonPhoneField.style.display = shouldShowPhone ? 'block' : 'none';
        }
        if (commonPhoneInput) {
          commonPhoneInput.required = shouldShowPhone && isPhoneRequired;
          if (!shouldShowPhone || !isPhoneRequired) commonPhoneInput.removeAttribute('required');
        }
        // 更新电话字段标签
        if (commonPhoneLabel) {
          commonPhoneLabel.textContent = isPhoneRequired ? '联系方式 *' : '联系方式（可选）';
        }
        
        // 动态设置必填属性（只在字段可见且为必填分类时设置）
        const isRequired = isLocationRequired(apiName);
        const addressInput = document.getElementById('commonAddress');
        const latInput = document.getElementById('commonLatitude');
        const lngInput = document.getElementById('commonLongitude');
        const addressLabel = document.getElementById('commonAddressLabel');
        const latLabel = document.getElementById('commonLatitudeLabel');
        const lngLabel = document.getElementById('commonLongitudeLabel');
        
        if (addressInput) {
          addressInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) addressInput.removeAttribute('required');
        }
        // 更新地址字段标签
        if (addressLabel) {
          addressLabel.textContent = isRequired ? '地址 *' : '地址（可选）';
        }
        
        if (latInput) {
          latInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) latInput.removeAttribute('required');
        }
        // 更新纬度字段标签
        if (latLabel) {
          latLabel.textContent = isRequired ? '纬度 *' : '纬度（可选）';
        }
        
        if (lngInput) {
          lngInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) lngInput.removeAttribute('required');
        }
        // 更新经度字段标签
        if (lngLabel) {
          lngLabel.textContent = isRequired ? '经度 *' : '经度（可选）';
        }
      }
      
      // 动态设置特殊表单中字段的必填属性
      if (specialType === 'second-hand') {
        const phoneInput = document.getElementById('secondHandPhone');
        const addressInput = document.getElementById('secondHandAddress');
        const latInput = document.getElementById('secondHandLatitude');
        const lngInput = document.getElementById('secondHandLongitude');
        if (phoneInput) phoneInput.required = true;
        if (addressInput) addressInput.required = true;
        if (latInput) latInput.required = true;
        if (lngInput) lngInput.required = true;
      } else if (specialType === 'rentals') {
        const phoneInput = document.getElementById('rentalsPhone');
        const addressInput = document.getElementById('rentalsAddress');
        const latInput = document.getElementById('rentalsLatitude');
        const lngInput = document.getElementById('rentalsLongitude');
        if (phoneInput) phoneInput.required = true;
        if (addressInput) addressInput.required = true;
        if (latInput) latInput.required = true;
        if (lngInput) lngInput.required = true;
      } else {
        // 隐藏时移除必填属性
        const secondHandPhone = document.getElementById('secondHandPhone');
        const secondHandAddress = document.getElementById('secondHandAddress');
        const secondHandLat = document.getElementById('secondHandLatitude');
        const secondHandLng = document.getElementById('secondHandLongitude');
        const rentalsPhone = document.getElementById('rentalsPhone');
        const rentalsAddress = document.getElementById('rentalsAddress');
        const rentalsLat = document.getElementById('rentalsLatitude');
        const rentalsLng = document.getElementById('rentalsLongitude');
        
        [secondHandPhone, secondHandAddress, secondHandLat, secondHandLng, 
         rentalsPhone, rentalsAddress, rentalsLat, rentalsLng].forEach(input => {
          if (input) input.removeAttribute('required');
        });
      }
      
      // 隐藏/显示普通内容编辑器
      const normalEditor = document.getElementById('normalContentEditor');
      if (normalEditor) {
        normalEditor.style.display = specialType ? 'none' : 'block';
      }
      
      if (!apiName) {
        mappingInfo.style.display = 'none';
        return;
      }
      
      // 如果是特殊类别，显示对应的表单
      if (specialType) {
        const specialForm = document.getElementById(`specialForm-${specialType}`);
        if (specialForm) {
          specialForm.style.display = 'block';
        }
        // 对于second-hand和rentals，也显示标准内容编辑器（因为它们需要编辑普通内容）
        const normalContentEditor = document.getElementById('normalContentEditor');
        if (specialType === 'second-hand' || specialType === 'rentals') {
          if (normalContentEditor) {
            normalContentEditor.style.display = 'block';
          }
        } else {
          if (normalContentEditor) {
            normalContentEditor.style.display = 'none';
          }
        }
        mappingInfo.style.display = 'none';
        return;
      }
      
      // 普通类别，检查字段映射
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/apis/${encodeURIComponent(apiName)}/field-mapping`);
        if (response && response.success && response.data) {
          mappingInfo.style.display = 'block';
          mappingInfo.innerHTML = `
            <div class="text-sm text-blue-600">
              <p>此API已配置字段映射，文章将根据映射规则保存到对应字段</p>
              <details class="mt-2">
                <summary class="cursor-pointer text-xs">查看字段映射</summary>
                <pre class="text-xs mt-2 p-2 bg-gray-100 rounded">${JSON.stringify(response.data, null, 2)}</pre>
              </details>
            </div>
          `;
        } else {
          mappingInfo.style.display = 'none';
        }
      } catch (error) {
        mappingInfo.style.display = 'none';
      }
    }

    // 切换标签页
    function switchTab(tabName, tabButton = null) {
      // 隐藏所有标签页内容
      document.querySelectorAll('.admin-tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // 显示选中的标签页
      const tabContent = document.getElementById(`tab-${tabName}`);
      if (tabContent) {
        tabContent.classList.add('active');
      }

      // 激活对应的标签按钮
      if (tabButton) {
        tabButton.classList.add('active');
      } else {
        // 如果没有提供按钮，通过查找包含对应文本的按钮来激活
        const buttons = document.querySelectorAll('.admin-tab');
        buttons.forEach(btn => {
          const text = btn.textContent.trim();
          if ((tabName === 'posts' && text === '文章') ||
              (tabName === 'categories' && text === '分类') ||
              (tabName === 'tags' && text === '标签') ||
              (tabName === 'comments' && text === '评论')) {
            btn.classList.add('active');
          }
        });
      }

      // 加载对应数据
      if (tabName === 'posts') {
        loadPosts();
        loadApis(); // 加载API列表
      } else if (tabName === 'categories') {
        loadCategories();
      } else if (tabName === 'tags') {
        loadTags();
      } else if (tabName === 'comments') {
        loadComments();
      }
    }

    // API请求封装（带认证）
    async function adminApiRequest(url, options = {}) {
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          credentials: 'include'
        });

        if (response.status === 401) {
          showToast('请先登录', 'error');
          window.location.href = '/admin.html';
          return null;
        }

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || '请求失败');
        }
        return data;
      } catch (error) {
        console.error('API请求失败:', error);
        showToast('请求失败: ' + error.message, 'error');
        throw error;
      }
    }

    // 加载文章列表
    async function loadPosts(resetExpanded = false) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
        if (response && response.success) {
          const posts = response.data || [];
          console.log('获取文章列表成功，文章数:', posts.length);
          // 保存所有文章数据
          allPostsData = posts;
          // 按分类统计
          const byCategory = {};
          posts.forEach(p => {
            const cat = p.category || '无分类';
            byCategory[cat] = (byCategory[cat] || 0) + 1;
          });
          console.log('文章分类统计:', byCategory);
          // 如果指定重置展开状态，则清空（默认所有分类都折叠）
          if (resetExpanded) {
            expandedCategories.clear();
          }
          displayPosts(posts);
        } else {
          console.error('获取文章列表失败:', response);
          document.getElementById('postsTableBody').innerHTML = '<tr><td colspan="6" class="blog-empty">加载失败</td></tr>';
        }
      } catch (error) {
        console.error('加载文章列表异常:', error);
        document.getElementById('postsTableBody').innerHTML = '<tr><td colspan="6" class="blog-empty">加载失败</td></tr>';
      }
    }

    // 显示文章列表（按分类分组，默认折叠）
    function displayPosts(posts) {
      const tbody = document.getElementById('postsTableBody');
      if (!posts || posts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="blog-empty">暂无文章</td></tr>';
        return;
      }

      console.log('displayPosts 接收到的文章数:', posts.length);

      // 按分类分组
      const postsByCategory = {};
      const seenIds = new Set(); // 前端再次去重，确保不显示重复
      let skippedCount = 0;
      
      for (const post of posts) {
        const postId = String(post.id || '');
        // 如果已存在相同id，跳过（防止重复显示）
        if (postId && seenIds.has(postId)) {
          skippedCount++;
          console.warn('跳过重复ID的文章:', { id: postId, category: post.category, name: post.name });
          continue;
        }
        seenIds.add(postId);
        
        // 按apiName（_sourceApiName）分组，而不是category
        const apiName = post._sourceApiName || post.category || '无分类';
        if (!postsByCategory[apiName]) {
          postsByCategory[apiName] = [];
        }
        postsByCategory[apiName].push(post);
      }

      console.log('显示文章统计:', {
        总接收: posts.length,
        去重后: seenIds.size,
        跳过重复: skippedCount,
        分类数: Object.keys(postsByCategory).length
      });

      // 生成HTML：按分类分组显示，默认折叠
      let html = '';
      const sortedCategories = Object.keys(postsByCategory).sort();
      
      for (const apiName of sortedCategories) {
        const categoryPosts = postsByCategory[apiName];
        const isExpanded = expandedCategories.has(apiName);
        
        // 分类标题行（按apiName分组）
        const specialType = isSpecialCategory(apiName);
        let categoryHeaderStyle = 'background: linear-gradient(to right, rgba(236, 72, 153, 0.1), rgba(147, 51, 234, 0.1));';
        let categoryHeaderColor = '#9333ea';
        let categoryDisplayName = apiName;
        
        if (specialType) {
          const specialInfo = SPECIAL_CATEGORIES[specialType];
          categoryHeaderStyle = `background: linear-gradient(to right, ${specialInfo.color}20, ${specialInfo.color}10);`;
          categoryHeaderColor = specialInfo.color;
          categoryDisplayName = specialInfo.displayName;
        }
        
        // 添加点击展开/折叠功能
        const expandIcon = isExpanded ? '📂' : '📁';
        // 使用 data-* 属性传递分类名称，避免转义问题
        html += `
          <tr class="category-header-row" style="${categoryHeaderStyle} font-weight: 600; cursor: pointer;" data-category-name="${escapeHtml(apiName)}" onclick="toggleCategory(this.dataset.categoryName)">
            <td colspan="6" style="padding: 0.75rem 1rem;">
              <span style="color: ${categoryHeaderColor}; font-weight: 600;">${expandIcon} ${escapeHtml(categoryDisplayName)}</span>
              <span style="color: #6b7280; font-size: 0.875rem; font-weight: normal; margin-left: 0.5rem;">
                (${categoryPosts.length} 篇文章)
              </span>
              <span style="color: #9ca3af; font-size: 0.75rem; margin-left: 0.5rem;">
                ${isExpanded ? '点击折叠' : '点击展开'}
              </span>
            </td>
          </tr>
        `;
        
        // 该分类下的文章（根据展开状态显示/隐藏）
        if (isExpanded) {
        for (const post of categoryPosts) {
          const date = formatDate(post.createdAt || post.created_at);
          const postSpecialType = isSpecialCategory(apiName);
          let rowStyle = '';
          // 显示category作为标签，如果没有则显示apiName
          const postCategory = post.category || apiName;
          let categoryDisplay = escapeHtml(postCategory);
          
          // 为特殊类别添加颜色标识
          if (postSpecialType) {
            const specialInfo = SPECIAL_CATEGORIES[postSpecialType];
            rowStyle = `background-color: ${specialInfo.color}15; border-left: 3px solid ${specialInfo.color};`;
            categoryDisplay = `<span style="color: ${specialInfo.color}; font-weight: 600;">${escapeHtml(postCategory)}</span>`;
          }
          
          html += `
              <tr class="category-post-row" data-category="${escapeHtml(apiName)}" style="${rowStyle}">
              <td>${escapeHtml(post.name || post.title || '未命名')}</td>
              <td>${categoryDisplay}</td>
              <td>${post.published ? '<span style="color: #10b981;">已发布</span>' : '<span style="color: #f59e0b;">草稿</span>'}</td>
              <td>${post.views || 0}</td>
              <td>${date}</td>
              <td>
                <div class="admin-actions">
                  <button class="admin-btn-small admin-btn-edit" onclick="editPost('${post.id}')">编辑</button>
                  <button class="admin-btn-small admin-btn-delete" onclick="deletePost('${post.id}')">删除</button>
                </div>
              </td>
            </tr>
          `;
          }
        }
      }

      tbody.innerHTML = html;
    }

    // 切换分类展开/折叠状态
    function toggleCategory(apiName) {
      if (expandedCategories.has(apiName)) {
        expandedCategories.delete(apiName);
      } else {
        expandedCategories.add(apiName);
      }
      // 重新渲染列表
      displayPosts(allPostsData);
    }

    // 显示文章表单
    async function showPostForm(post = null) {
      const form = document.getElementById('postForm');
      const formTitle = document.getElementById('postFormTitle');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      // 确保API列表已加载
      if (availableApis.length === 0) {
        loadApis().then(() => {
          showPostForm(post);
        });
        return;
      }
      
      // 确保表单显示，并隐藏加载提示
      if (form) {
        form.style.display = 'block';
        form.classList.remove('loading');
      }
      if (postFormLoading) {
        postFormLoading.style.display = 'none';
      }
      if (postFormContent) {
        postFormContent.style.display = 'block';
      }
      
      // 重置表单
      document.getElementById('postId').value = '';
      document.getElementById('postName').value = '';
      document.getElementById('postSlug').value = '';
      document.getElementById('postExcerpt').value = '';
      document.getElementById('postImage').value = '';
      updateImagePreview('');
      document.getElementById('postCategory').value = '';
      document.getElementById('postTags').value = '';
      document.getElementById('postPublished').checked = true;
      
      // 清空位置和联系方式字段
      const commonPhone = document.getElementById('commonPhone');
      const commonAddress = document.getElementById('commonAddress');
      const commonLatitude = document.getElementById('commonLatitude');
      const commonLongitude = document.getElementById('commonLongitude');
      const secondHandPhone = document.getElementById('secondHandPhone');
      const secondHandAddress = document.getElementById('secondHandAddress');
      const secondHandLatitude = document.getElementById('secondHandLatitude');
      const secondHandLongitude = document.getElementById('secondHandLongitude');
      const rentalsPhone = document.getElementById('rentalsPhone');
      const rentalsAddress = document.getElementById('rentalsAddress');
      const rentalsLatitude = document.getElementById('rentalsLatitude');
      const rentalsLongitude = document.getElementById('rentalsLongitude');
      
      if (commonPhone) commonPhone.value = '';
      if (commonAddress) commonAddress.value = '';
      if (commonLatitude) commonLatitude.value = '';
      if (commonLongitude) commonLongitude.value = '';
      if (secondHandPhone) secondHandPhone.value = '';
      if (secondHandAddress) secondHandAddress.value = '';
      if (secondHandLatitude) secondHandLatitude.value = '';
      if (secondHandLongitude) secondHandLongitude.value = '';
      if (rentalsPhone) rentalsPhone.value = '';
      if (rentalsAddress) rentalsAddress.value = '';
      if (rentalsLatitude) rentalsLatitude.value = '';
      if (rentalsLongitude) rentalsLongitude.value = '';
      
      if (post) {
        formTitle.textContent = '编辑文章';
        document.getElementById('postId').value = post.id || '';
        // name和title保持一致
        const nameValue = post.name || post.title || '';
        document.getElementById('postName').value = nameValue;
        document.getElementById('postSlug').value = post.slug || '';
        document.getElementById('postExcerpt').value = post.excerpt || post.description || '';
        const imageUrl = post.image || '';
        document.getElementById('postImage').value = imageUrl;
        updateImagePreview(imageUrl);
        const apiName = post._sourceApiName || post.category || '';
        document.getElementById('postApiName').value = apiName;
        // category字段作为标签使用
        const category = post.category || post._sourceApiName || '';
        document.getElementById('postCategory').value = category;
        // tags字段已废弃，不再使用
        document.getElementById('postPublished').checked = post.published !== false; // 默认为true
        
        // 触发API选择改变事件
        setTimeout(() => {
          onApiNameChange();
          
          // 如果是特殊类别，加载原始数据到表单
          const specialType = isSpecialCategory(apiName);
          if (specialType && post._originalData) {
            loadSpecialCategoryData(specialType, post._originalData);
          }
          
          // 加载特殊字段（二手市场和租房酒店）
          if (specialType === 'second-hand') {
            const priceInput = document.getElementById('secondHandPrice');
            if (priceInput) {
              // 优先从_originalData获取，如果没有则从post本身获取
              const price = (post._originalData && post._originalData.price) || post.price || '';
              priceInput.value = price;
              console.log('加载二手市场价格字段:', { price, fromOriginalData: post._originalData?.price, fromPost: post.price });
            }
            const phoneInput = document.getElementById('secondHandPhone');
            const addressInput = document.getElementById('secondHandAddress');
            const latInput = document.getElementById('secondHandLatitude');
            const lngInput = document.getElementById('secondHandLongitude');
            if (phoneInput) {
              const phone = (post._originalData && post._originalData.phone) || post.phone || '';
              phoneInput.value = phone;
            }
            if (addressInput) {
              const address = (post._originalData && post._originalData.address) || post.address || '';
              addressInput.value = address;
            }
            if (latInput) {
              const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
              latInput.value = lat;
            }
            if (lngInput) {
              const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
              lngInput.value = lng;
            }
          } else if (specialType === 'rentals') {
            const priceInput = document.getElementById('rentalsPrice');
            const roomsInput = document.getElementById('rentalsRooms');
            const areaInput = document.getElementById('rentalsArea');
            const viewsInput = document.getElementById('rentalsViews');
            const phoneInput = document.getElementById('rentalsPhone');
            const addressInput = document.getElementById('rentalsAddress');
            const latInput = document.getElementById('rentalsLatitude');
            const lngInput = document.getElementById('rentalsLongitude');
            if (priceInput) {
              const price = (post._originalData && post._originalData.price) || post.price || '';
              priceInput.value = price;
            }
            if (roomsInput) {
              const rooms = (post._originalData && post._originalData.rooms) || post.rooms || '';
              roomsInput.value = rooms;
            }
            if (areaInput) {
              const area = (post._originalData && post._originalData.area) || post.area || '';
              areaInput.value = area;
            }
            if (viewsInput) {
              const views = (post._originalData && post._originalData.views) || post.views || 0;
              viewsInput.value = views;
            }
            if (phoneInput) {
              const phone = (post._originalData && post._originalData.phone) || post.phone || '';
              phoneInput.value = phone;
            }
            if (addressInput) {
              const address = (post._originalData && post._originalData.address) || post.address || '';
              addressInput.value = address;
            }
            if (latInput) {
              const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
              latInput.value = lat;
            }
            if (lngInput) {
              const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
              lngInput.value = lng;
            }
            console.log('加载租房酒店特殊字段:', {
              price: (post._originalData && post._originalData.price) || post.price,
              rooms: (post._originalData && post._originalData.rooms) || post.rooms,
              area: (post._originalData && post._originalData.area) || post.area,
              views: (post._originalData && post._originalData.views) || post.views,
              phone: (post._originalData && post._originalData.phone) || post.phone,
              address: (post._originalData && post._originalData.address) || post.address,
              latitude: (post._originalData && post._originalData.latitude) || post.latitude,
              longitude: (post._originalData && post._originalData.longitude) || post.longitude
            });
          } else {
            // 加载通用位置字段（用于其他需要位置的分类）
            const needsLocation = needsLocationFields(apiName);
            const needsPhone = needsPhoneField(apiName);
            if (needsLocation) {
              const addressInput = document.getElementById('commonAddress');
              const latInput = document.getElementById('commonLatitude');
              const lngInput = document.getElementById('commonLongitude');
              if (addressInput) {
                const address = (post._originalData && post._originalData.address) || post.address || '';
                addressInput.value = address;
              }
              if (latInput) {
                const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
                latInput.value = lat;
              }
              if (lngInput) {
                const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
                lngInput.value = lng;
              }
            }
            // 加载通用电话字段（用于寻味中国等分类）
            if (needsPhone) {
              const phoneInput = document.getElementById('commonPhone');
              if (phoneInput) {
                const phone = (post._originalData && post._originalData.phone) || post.phone || '';
                phoneInput.value = phone;
              }
            }
          }
        }, 100);
        
        // 设置htmlContent（统一使用htmlContent）
        const htmlContent = post.htmlContent || (post._originalData ? (post._originalData.htmlContent || '') : '');
        
        // 判断内容类型并设置编辑器模式
        if (htmlContent && htmlContent.trim().startsWith('<')) {
          // HTML内容，切换到HTML编辑器
          document.querySelector('input[name="editorMode"][value="html"]').checked = true;
          await switchEditorMode('html');
          
          // 等待Quill编辑器初始化后设置内容
          if (quillEditor) {
            quillEditor.root.innerHTML = htmlContent;
          } else {
            // 如果Quill还没加载，等待一下再试
            setTimeout(async () => {
              if (!quillEditor) {
                await initQuillEditor();
              }
              if (quillEditor) {
                quillEditor.root.innerHTML = htmlContent;
              }
            }, 500);
          }
        } else {
          // Markdown内容或空内容，使用Markdown编辑器
          document.querySelector('input[name="editorMode"][value="markdown"]').checked = true;
          await switchEditorMode('markdown');
          
          // 初始化Markdown编辑器
          if (!simpleMDE) {
            simpleMDE = new SimpleMDE({
              element: document.getElementById('postContent'),
              spellChecker: false,
              placeholder: '输入Markdown内容...'
            });
          }
          // 如果有htmlContent，简单转换为Markdown显示（移除HTML标签）
          if (htmlContent) {
            const markdownContent = htmlContent
              .replace(/<h2>/g, '## ')
              .replace(/<\/h2>/g, '\n\n')
              .replace(/<p>/g, '')
              .replace(/<\/p>/g, '\n\n')
              .replace(/<br>/g, '\n')
              .replace(/<[^>]+>/g, '');
            simpleMDE.value(markdownContent.trim());
          } else {
            simpleMDE.value('');
          }
        }
      } else {
        formTitle.textContent = '新建文章';
        document.getElementById('postFormElement').reset();
        document.getElementById('postId').value = '';
        document.getElementById('postApiName').value = '';
        
        // 重置所有特殊表单
        document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
          el.style.display = 'none';
          // 清空所有输入框
          el.querySelectorAll('input, textarea, select').forEach(input => {
            input.value = '';
          });
        });
        
        // 重置天气路况的动态列表
        document.getElementById('weatherAttractionsList').innerHTML = '';
        document.getElementById('weatherTrafficList').innerHTML = '';
        weatherAttractionsCounter = 0;
        weatherTrafficCounter = 0;
        
        // 重置特殊字段（二手市场和租房酒店）
        const secondHandPriceInput = document.getElementById('secondHandPrice');
        if (secondHandPriceInput) secondHandPriceInput.value = '';
        const rentalsPriceInput = document.getElementById('rentalsPrice');
        if (rentalsPriceInput) rentalsPriceInput.value = '';
        const rentalsRoomsInput = document.getElementById('rentalsRooms');
        if (rentalsRoomsInput) rentalsRoomsInput.value = '';
        const rentalsAreaInput = document.getElementById('rentalsArea');
        if (rentalsAreaInput) rentalsAreaInput.value = '';
        const rentalsViewsInput = document.getElementById('rentalsViews');
        if (rentalsViewsInput) rentalsViewsInput.value = '';
        
        // 重置汇率转换列表
        const exchangeRatesList = document.getElementById('exchangeRatesList');
        if (exchangeRatesList) exchangeRatesList.innerHTML = '';
        exchangeRatesCounter = 0;
        
        // 显示普通内容编辑器
        const normalEditor = document.getElementById('normalContentEditor');
        if (normalEditor) {
          normalEditor.style.display = 'block';
        }
        
        // 重置编辑器模式为Markdown
        document.querySelector('input[name="editorMode"][value="markdown"]').checked = true;
        await switchEditorMode('markdown');
        
        if (simpleMDE) {
          simpleMDE.value('');
        } else {
          simpleMDE = new SimpleMDE({
            element: document.getElementById('postContent'),
            spellChecker: false,
            placeholder: '输入Markdown内容...'
          });
        }
        document.getElementById('fieldMappingInfo').style.display = 'none';
      }
      
      form.style.display = 'block';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    // 切换编辑器模式（全局函数，供HTML调用）
    window.switchEditorMode = async function switchEditorMode(mode) {
      const markdownContainer = document.getElementById('markdownEditorContainer');
      const htmlContainer = document.getElementById('htmlEditorContainer');
      
      // 保存当前编辑器内容到临时变量（在切换前）
      let currentContent = '';
      
      if (currentEditorMode === 'html' && quillEditor) {
        // 当前是HTML模式，保存HTML内容
        currentContent = quillEditor.root.innerHTML;
      } else if (currentEditorMode === 'markdown' && simpleMDE) {
        // 当前是Markdown模式，保存Markdown内容
        currentContent = simpleMDE.value();
      } else if (currentEditorMode === 'markdown') {
        // Markdown模式但simpleMDE未初始化，从textarea获取
        const textarea = document.getElementById('postContent');
        if (textarea) {
          currentContent = textarea.value;
        }
      }
      
      // 更新当前模式
      currentEditorMode = mode;
      
      if (mode === 'markdown') {
        markdownContainer.style.display = 'block';
        htmlContainer.style.display = 'none';
        
        // 确保SimpleMDE已初始化
        if (!simpleMDE) {
          simpleMDE = new SimpleMDE({
            element: document.getElementById('postContent'),
            spellChecker: false,
            placeholder: '输入Markdown内容...'
          });
        }
        
        // 如果切换到Markdown，将HTML内容转换为Markdown显示
        if (currentContent) {
          if (currentContent.trim().startsWith('<')) {
            // HTML内容，转换为Markdown
            const markdownContent = htmlToMarkdown(currentContent);
            simpleMDE.value(markdownContent);
          } else {
            // 已经是Markdown内容，直接使用
            simpleMDE.value(currentContent);
          }
        } else {
          // 没有内容，清空
          simpleMDE.value('');
        }
      } else {
        // HTML模式
        markdownContainer.style.display = 'none';
        htmlContainer.style.display = 'block';
        
        // 初始化Quill编辑器（如果还没有初始化）
        if (!quillEditor) {
          await initQuillEditor();
          // 等待Quill完全初始化
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // 如果切换到HTML，将Markdown内容转换为HTML
        if (currentContent && quillEditor) {
          if (currentContent.trim().startsWith('<')) {
            // 已经是HTML内容，直接使用
            quillEditor.root.innerHTML = currentContent;
          } else {
            // Markdown内容，转换为HTML（使用async函数）
            markdownToHtml(currentContent).then(htmlContent => {
              if (quillEditor) {
                quillEditor.root.innerHTML = htmlContent;
              }
            }).catch(error => {
              console.error('Markdown转换失败:', error);
              if (quillEditor) {
                quillEditor.root.innerHTML = '<p>转换失败: ' + escapeHtml(error.message) + '</p>';
              }
            });
          }
        } else if (quillEditor) {
          // 没有内容，清空
          quillEditor.root.innerHTML = '';
        }
      }
    }
    
    // HTML转Markdown的辅助函数
    function htmlToMarkdown(html) {
      if (!html) return '';
      
      let markdown = html
        // 标题
        .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
        .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
        .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
        .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n')
        .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n\n')
        .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n\n')
        // 粗体和斜体
        .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
        .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
        .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
        .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
        // 链接
        .replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, '[$2]($1)')
        // 图片
        .replace(/<img[^>]*src=["']([^"']*)["'][^>]*alt=["']([^"']*)["'][^>]*>/gi, '![$2]($1)')
        .replace(/<img[^>]*src=["']([^"']*)["'][^>]*>/gi, '![]($1)')
        // 列表
        .replace(/<ul[^>]*>/gi, '')
        .replace(/<\/ul>/gi, '\n')
        .replace(/<ol[^>]*>/gi, '')
        .replace(/<\/ol>/gi, '\n')
        .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
        // 代码块
        .replace(/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/gis, '```\n$1\n```\n')
        .replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`')
        // 段落和换行
        .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
        .replace(/<br[^>]*>/gi, '\n')
        .replace(/<div[^>]*>(.*?)<\/div>/gis, '$1\n')
        // 移除所有剩余的HTML标签
        .replace(/<[^>]+>/g, '')
        // 清理多余的空行
        .replace(/\n{3,}/g, '\n\n')
        .trim();
      
      return markdown;
    }
    
    // Markdown转HTML的辅助函数（使用marked.js）
    async function markdownToHtml(markdown) {
      if (!markdown) return '';
      
      // 如果已经是HTML，直接返回
      if (markdown.trim().startsWith('<')) {
        return markdown;
      }
      
      // 使用marked.js进行转换
      if (typeof marked !== 'undefined') {
        try {
          // 配置marked选项
          marked.setOptions({
            breaks: true, // 支持GFM换行
            gfm: true, // 启用GitHub Flavored Markdown
            headerIds: true,
            mangle: false
          });
          return marked.parse(markdown);
        } catch (error) {
          console.error('Markdown转换失败，使用简单转换:', error);
          // 如果marked.js转换失败，使用简单转换作为后备
        }
      }
      
      // 后备方案：简单转换（如果marked.js未加载）
      let html = markdown
        // 标题
        .replace(/^###### (.*?)$/gm, '<h6>$1</h6>')
        .replace(/^##### (.*?)$/gm, '<h5>$1</h5>')
        .replace(/^#### (.*?)$/gm, '<h4>$1</h4>')
        .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
        .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
        // 粗体和斜体
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // 链接
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        // 图片
        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')
        // 代码块
        .replace(/```([^`]+)```/gs, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // 列表
        .replace(/^\- (.*?)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        // 段落（处理双换行）
        .split(/\n\n+/)
        .map(para => {
          para = para.trim();
          if (!para) return '';
          // 如果已经是HTML标签，不包装
          if (para.match(/^<(h[1-6]|ul|ol|pre|code|div)/)) {
            return para;
          }
          return '<p>' + para.replace(/\n/g, '<br>') + '</p>';
        })
        .join('\n');
      
      return html;
    }
    
    // 初始化Quill HTML编辑器
    function initQuillEditor() {
      // 检查Quill是否已加载
      if (typeof Quill === 'undefined') {
        console.error('Quill未加载，等待加载...');
        // 等待Quill加载
        return new Promise((resolve) => {
          const checkQuill = setInterval(() => {
            if (typeof Quill !== 'undefined') {
              clearInterval(checkQuill);
              initQuillEditorInternal();
              resolve();
            }
          }, 100);
          setTimeout(() => {
            clearInterval(checkQuill);
            if (typeof Quill === 'undefined') {
              showToast('HTML编辑器加载失败，请刷新页面重试', 'error');
            }
            resolve();
          }, 5000);
        });
      } else {
        initQuillEditorInternal();
      }
    }
    
    function initQuillEditorInternal() {
      if (typeof Quill === 'undefined') {
        return;
      }
      
      const editorContainer = document.getElementById('postHtmlContent');
      if (!editorContainer) {
        console.error('编辑器容器不存在');
        return;
      }
      
      // 如果已经初始化，先销毁
      if (quillEditor) {
        try {
          quillEditor = null;
        } catch (e) {
          console.warn('销毁编辑器时出错:', e);
        }
      }
      
      // 清空容器内容（Quill会在容器内创建编辑器）
      editorContainer.innerHTML = '';
      
      try {
        // 创建Quill编辑器
        quillEditor = new Quill('#postHtmlContent', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline', 'strike'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'align': [] }],
              ['link', 'image'],
              ['blockquote', 'code-block'],
              ['clean']
            ]
          },
          placeholder: '输入HTML内容...'
        });
        console.log('Quill编辑器初始化成功');
      } catch (error) {
        console.error('初始化Quill编辑器失败:', error);
        showToast('HTML编辑器初始化失败: ' + error.message, 'error');
      }
    }
    
    // 隐藏文章表单
    function hidePostForm() {
      document.getElementById('postForm').style.display = 'none';
      // 如果是在新窗口中打开的，关闭窗口
      if (window.opener) {
        window.close();
      }
    }

    // 天气路况数据管理
    let weatherAttractionsCounter = 0;
    let weatherTrafficCounter = 0;
    
    // 添加景点天气
    function addWeatherAttraction(attraction = null) {
      const container = document.getElementById('weatherAttractionsList');
      const index = attraction ? attraction._index : weatherAttractionsCounter++;
      const itemId = attraction ? attraction.id : '';
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'weather-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #3b82f6;">景点 #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeWeatherAttraction(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> 删除
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ID</label>
            <input type="number" class="admin-form-input weather-attraction-id" value="${itemId}" placeholder="自动生成" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">景点名称 *</label>
            <input type="text" class="admin-form-input weather-attraction-name" value="${attraction ? escapeHtml(attraction.name || '') : ''}" placeholder="如：金字塔" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">温度 (°C) *</label>
            <input type="number" class="admin-form-input weather-attraction-temperature" value="${attraction ? attraction.temperature || '' : ''}" placeholder="如：36" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">能见度</label>
            <input type="text" class="admin-form-input weather-attraction-visibility" value="${attraction ? escapeHtml(attraction.visibility || '') : ''}" placeholder="如：高、中、低" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">紫外线指数</label>
            <input type="number" class="admin-form-input weather-attraction-uvIndex" value="${attraction ? attraction.uvIndex || '' : ''}" placeholder="如：10" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">风速</label>
            <input type="text" class="admin-form-input weather-attraction-windSpeed" value="${attraction ? escapeHtml(attraction.windSpeed || '') : ''}" placeholder="如：3级" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
        </div>
        <div class="admin-form-group" style="margin-bottom: 0; margin-top: 0.75rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          <label class="admin-form-label" style="font-size: 0.875rem;">建议</label>
          <textarea class="admin-form-input weather-attraction-suggestion" rows="2" placeholder="如：早晨 8 点前去，带足水。" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;">${attraction ? escapeHtml(attraction.suggestion || '') : ''}</textarea>
        </div>
      `;
      
      container.appendChild(itemDiv);
    }
    
    // 删除景点天气
    function removeWeatherAttraction(index) {
      const container = document.getElementById('weatherAttractionsList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('确定要删除这个景点吗？')) {
        item.remove();
      }
    }
    
    // 添加路况信息
    function addWeatherTraffic(traffic = null) {
      const container = document.getElementById('weatherTrafficList');
      const index = traffic ? traffic._index : weatherTrafficCounter++;
      const itemId = traffic ? traffic.id : '';
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'weather-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #3b82f6;">路况 #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeWeatherTraffic(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> 删除
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ID</label>
            <input type="number" class="admin-form-input weather-traffic-id" value="${itemId}" placeholder="自动生成" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">时间 *</label>
            <input type="text" class="admin-form-input weather-traffic-time" value="${traffic ? escapeHtml(traffic.time || '') : ''}" placeholder="如：10:30" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">类型 *</label>
            <select class="admin-form-select weather-traffic-type" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
              <option value="车祸" ${traffic && traffic.type === '车祸' ? 'selected' : ''}>车祸</option>
              <option value="施工" ${traffic && traffic.type === '施工' ? 'selected' : ''}>施工</option>
              <option value="天气" ${traffic && traffic.type === '天气' ? 'selected' : ''}>天气</option>
              <option value="拥堵" ${traffic && traffic.type === '拥堵' ? 'selected' : ''}>拥堵</option>
              <option value="其他" ${traffic && traffic.type === '其他' ? 'selected' : ''}>其他</option>
            </select>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; grid-column: 1 / -1; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">地点 *</label>
            <input type="text" class="admin-form-input weather-traffic-location" value="${traffic ? escapeHtml(traffic.location || '') : ''}" placeholder="如：环城路 Maadi 出口方向" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; grid-column: 1 / -1; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">消息 *</label>
            <textarea class="admin-form-input weather-traffic-message" rows="2" placeholder="如：发生追尾，极度拥堵。" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;">${traffic ? escapeHtml(traffic.message || '') : ''}</textarea>
          </div>
        </div>
      `;
      
      container.appendChild(itemDiv);
    }
    
    // 删除路况信息
    function removeWeatherTraffic(index) {
      const container = document.getElementById('weatherTrafficList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('确定要删除这条路况信息吗？')) {
        item.remove();
      }
    }
    
    // 添加汇率转换项
    function addExchangeRate(rate = null) {
      const container = document.getElementById('exchangeRatesList');
      const index = rate ? rate._index : exchangeRatesCounter++;
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'exchange-rate-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #10b981;">汇率 #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeExchangeRate(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> 删除
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">源货币 *</label>
            <input type="text" class="admin-form-input exchange-rate-from" value="${rate ? escapeHtml(rate.fromCurrency || '') : ''}" placeholder="如：CNY" pattern="^[A-Z]{3}$" maxlength="3" style="font-size: 0.875rem; text-transform: uppercase; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">3位大写字母</small>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">目标货币 *</label>
            <input type="text" class="admin-form-input exchange-rate-to" value="${rate ? escapeHtml(rate.toCurrency || '') : ''}" placeholder="如：EGP" pattern="^[A-Z]{3}$" maxlength="3" style="font-size: 0.875rem; text-transform: uppercase; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">3位大写字母</small>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">汇率 *</label>
            <input type="number" class="admin-form-input exchange-rate-value" value="${rate ? escapeHtml(rate.rate || '') : ''}" placeholder="如：6.74" step="0.0001" min="0" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">1源货币=?目标货币</small>
          </div>
        </div>
      `;
      
      container.appendChild(itemDiv);
      
      // 自动转换为大写
      const fromInput = itemDiv.querySelector('.exchange-rate-from');
      const toInput = itemDiv.querySelector('.exchange-rate-to');
      fromInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
      toInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
    }
    
    // 删除汇率转换项
    function removeExchangeRate(index) {
      const container = document.getElementById('exchangeRatesList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('确定要删除这条汇率吗？')) {
        item.remove();
      }
    }
    
    // 加载特殊类别数据到表单
    function loadSpecialCategoryData(specialType, originalData) {
      if (specialType === 'translation') {
        document.getElementById('translationChinese').value = originalData.chinese || '';
        document.getElementById('translationArabic').value = originalData.arabic || '';
        document.getElementById('translationCategory').value = originalData.category || '';
      } else if (specialType === 'weather') {
        // 加载globalAlert
        if (originalData.globalAlert) {
          document.getElementById('weatherGlobalAlertLevel').value = originalData.globalAlert.level || 'medium';
          document.getElementById('weatherGlobalAlertMessage').value = originalData.globalAlert.message || '';
        }
        
        // 加载attractions
        const attractionsContainer = document.getElementById('weatherAttractionsList');
        attractionsContainer.innerHTML = '';
        weatherAttractionsCounter = 0;
        if (originalData.attractions && Array.isArray(originalData.attractions)) {
          originalData.attractions.forEach((attraction, index) => {
            attraction._index = index;
            addWeatherAttraction(attraction);
            weatherAttractionsCounter++;
          });
        }
        
        // 加载traffic
        const trafficContainer = document.getElementById('weatherTrafficList');
        trafficContainer.innerHTML = '';
        weatherTrafficCounter = 0;
        if (originalData.traffic && Array.isArray(originalData.traffic)) {
          originalData.traffic.forEach((traffic, index) => {
            traffic._index = index;
            addWeatherTraffic(traffic);
            weatherTrafficCounter++;
          });
        }
      } else if (specialType === 'exchange-rate') {
        // 加载所有货币汇率
        const ratesContainer = document.getElementById('exchangeRatesList');
        ratesContainer.innerHTML = '';
        exchangeRatesCounter = 0;
        
        // 遍历originalData中的所有货币字段（CNY, USD, EUR等）
        Object.keys(originalData).forEach(currency => {
          // 跳过标准字段
          if (['id', 'name', 'title', 'slug', 'excerpt', 'description', 'htmlContent', 'image', 'category', 'tags', 'published', 'views', 'createdAt', 'updatedAt', 'detailApi', 'updateTime'].includes(currency)) {
            return;
          }
          
          // 如果该字段是一个对象（包含目标货币和汇率）
          if (originalData[currency] && typeof originalData[currency] === 'object' && !Array.isArray(originalData[currency])) {
            // 遍历该货币的所有目标货币
            Object.keys(originalData[currency]).forEach(targetCurrency => {
              const rate = originalData[currency][targetCurrency];
              addExchangeRate({
                fromCurrency: currency,
                toCurrency: targetCurrency,
                rate: rate
              });
              exchangeRatesCounter++;
            });
          }
        });
        
        // 如果没有汇率数据，至少添加一行空行
        if (exchangeRatesCounter === 0) {
          addExchangeRate();
        }
        
        // 加载更新时间
        if (originalData.updateTime) {
          const date = new Date(originalData.updateTime);
          const localDateTime = date.toISOString().slice(0, 16);
          document.getElementById('exchangeUpdateTime').value = localDateTime;
        }
      }
    }
    
    // 从表单收集特殊类别数据
    function collectSpecialCategoryData(specialType) {
      const data = {};
      
      if (specialType === 'translation') {
        data.chinese = document.getElementById('translationChinese').value.trim();
        data.arabic = document.getElementById('translationArabic').value.trim();
        data.category = document.getElementById('translationCategory').value.trim();
        
        if (!data.chinese || !data.arabic) {
          throw new Error('中文和阿拉伯文为必填项');
        }
      } else if (specialType === 'weather') {
        // 收集globalAlert
        const alertLevel = document.getElementById('weatherGlobalAlertLevel').value;
        const alertMessage = document.getElementById('weatherGlobalAlertMessage').value.trim();
        
        if (!alertMessage) {
          throw new Error('预警消息为必填项');
        }
        
        data.globalAlert = {
          level: alertLevel,
          message: alertMessage
        };
        
        // 收集attractions
        const attractionsContainer = document.getElementById('weatherAttractionsList');
        const attractionItems = attractionsContainer.querySelectorAll('.weather-item');
        data.attractions = [];
        
        attractionItems.forEach((item, index) => {
          const idInput = item.querySelector('.weather-attraction-id');
          const nameInput = item.querySelector('.weather-attraction-name');
          const tempInput = item.querySelector('.weather-attraction-temperature');
          const visibilityInput = item.querySelector('.weather-attraction-visibility');
          const uvIndexInput = item.querySelector('.weather-attraction-uvIndex');
          const windSpeedInput = item.querySelector('.weather-attraction-windSpeed');
          const suggestionInput = item.querySelector('.weather-attraction-suggestion');
          
          const name = nameInput.value.trim();
          const temperature = tempInput.value.trim();
          
          if (!name || !temperature) {
            throw new Error(`景点 #${index + 1}：名称和温度为必填项`);
          }
          
          const attraction = {
            id: idInput.value ? parseInt(idInput.value) : index + 1,
            name: name,
            temperature: parseInt(temperature),
            visibility: visibilityInput.value.trim() || undefined,
            uvIndex: uvIndexInput.value ? parseInt(uvIndexInput.value) : undefined,
            windSpeed: windSpeedInput.value.trim() || undefined,
            suggestion: suggestionInput.value.trim() || undefined
          };
          
          // 移除undefined字段
          Object.keys(attraction).forEach(key => {
            if (attraction[key] === undefined) {
              delete attraction[key];
            }
          });
          
          data.attractions.push(attraction);
        });
        
        // 收集traffic
        const trafficContainer = document.getElementById('weatherTrafficList');
        const trafficItems = trafficContainer.querySelectorAll('.weather-item');
        data.traffic = [];
        
        trafficItems.forEach((item, index) => {
          const idInput = item.querySelector('.weather-traffic-id');
          const timeInput = item.querySelector('.weather-traffic-time');
          const typeInput = item.querySelector('.weather-traffic-type');
          const locationInput = item.querySelector('.weather-traffic-location');
          const messageInput = item.querySelector('.weather-traffic-message');
          
          const time = timeInput.value.trim();
          const type = typeInput.value;
          const location = locationInput.value.trim();
          const message = messageInput.value.trim();
          
          if (!time || !type || !location || !message) {
            throw new Error(`路况 #${index + 1}：时间、类型、地点和消息为必填项`);
          }
          
          const traffic = {
            id: idInput.value ? parseInt(idInput.value) : index + 1,
            time: time,
            type: type,
            location: location,
            message: message
          };
          
          data.traffic.push(traffic);
        });
        
        // 保留data字段（如果存在，用于列表显示）
        // data字段会在后端处理时自动生成或保留
      } else if (specialType === 'exchange-rate') {
        // 收集所有汇率项
        const ratesContainer = document.getElementById('exchangeRatesList');
        const rateItems = ratesContainer.querySelectorAll('.exchange-rate-item');
        
        // 构建汇率对象：{CNY: {EGP: 6.74}, USD: {EGP: 30.5}, ...}
        const exchangeRates = {};
        
        rateItems.forEach((item, index) => {
          const fromInput = item.querySelector('.exchange-rate-from');
          const toInput = item.querySelector('.exchange-rate-to');
          const rateInput = item.querySelector('.exchange-rate-value');
          
          const fromCurrency = fromInput.value.trim().toUpperCase();
          const toCurrency = toInput.value.trim().toUpperCase();
          const rate = parseFloat(rateInput.value);
          
          if (!fromCurrency || !toCurrency || isNaN(rate) || rate <= 0) {
            throw new Error(`汇率 #${index + 1}：源货币、目标货币和汇率为必填项，且汇率必须大于0`);
          }
          
          // 验证货币代码格式
          if (!/^[A-Z]{3}$/.test(fromCurrency)) {
            throw new Error(`汇率 #${index + 1}：源货币格式不正确，应为3位大写字母，如 CNY、USD、EGP`);
          }
          if (!/^[A-Z]{3}$/.test(toCurrency)) {
            throw new Error(`汇率 #${index + 1}：目标货币格式不正确，应为3位大写字母，如 CNY、USD、EGP`);
          }
          
          // 如果该源货币已存在，添加目标货币
          if (!exchangeRates[fromCurrency]) {
            exchangeRates[fromCurrency] = {};
          }
          exchangeRates[fromCurrency][toCurrency] = rate;
        });
        
        // 将汇率对象合并到data中
        Object.assign(data, exchangeRates);
        
        // 添加更新时间
        const updateTime = document.getElementById('exchangeUpdateTime').value;
        if (updateTime) {
          data.updateTime = new Date(updateTime).toISOString();
        }
      }
      
      return data;
    }
    
    // 保存文章
    async function savePost(event) {
      event.preventDefault();
      
      const id = document.getElementById('postId').value;
      const name = document.getElementById('postName').value.trim();
      // name和title保持一致
      const title = name;
      const slug = document.getElementById('postSlug').value.trim();
      const excerpt = document.getElementById('postExcerpt').value.trim();
      const image = document.getElementById('postImage').value.trim();
      const apiName = document.getElementById('postApiName').value.trim();
      const category = document.getElementById('postCategory').value.trim();
      
      // 检查是否是特殊类别
      const specialType = isSpecialCategory(apiName);
      
      // 获取htmlContent（统一使用htmlContent字段）
      let htmlContent = '';
      let specialData = null;
      
      // 只有 weather、exchange-rate、translation 不使用 htmlContent
      // second-hand 和 rentals 仍然需要 htmlContent
      const needsSpecialDataOnly = specialType && (specialType === 'weather' || specialType === 'exchange-rate' || specialType === 'translation');
      
      if (specialType) {
        // 特殊类别：收集特殊数据
        try {
          specialData = collectSpecialCategoryData(specialType);
          // 只有 weather、exchange-rate、translation 不需要 htmlContent
          // second-hand 和 rentals 仍然需要 htmlContent
          if (!needsSpecialDataOnly) {
            // 获取htmlContent（second-hand 和 rentals 需要）
            if (currentEditorMode === 'html' && quillEditor) {
              htmlContent = quillEditor.root.innerHTML;
            } else {
              // Markdown模式：将Markdown转换为HTML
              const markdownContent = simpleMDE ? simpleMDE.value() : document.getElementById('postContent').value;
              if (markdownContent) {
                // 如果内容看起来像HTML，直接使用
                if (markdownContent.trim().startsWith('<')) {
                  htmlContent = markdownContent;
                } else {
                  // 使用 marked.js 将 Markdown 转换为 HTML
                  if (typeof marked !== 'undefined') {
                    htmlContent = marked.parse(markdownContent);
                  } else {
                    htmlContent = markdownContent; // 如果没有 marked.js，直接使用原始内容
                  }
                }
              }
            }
          } else {
            // weather、exchange-rate、translation 不需要 htmlContent
            htmlContent = undefined;
          }
        } catch (error) {
          showToast(error.message, 'error');
          return;
        }
      } else {
        // 普通类别：获取htmlContent
        if (currentEditorMode === 'html' && quillEditor) {
          htmlContent = quillEditor.root.innerHTML;
        } else {
          // Markdown模式：将Markdown转换为HTML
          const markdownContent = simpleMDE ? simpleMDE.value() : document.getElementById('postContent').value;
          if (markdownContent) {
            // 如果内容看起来像HTML，直接使用
            if (markdownContent.trim().startsWith('<')) {
              htmlContent = markdownContent;
            } else {
              // 否则，简单处理：将Markdown换行转换为HTML段落
              htmlContent = '<p>' + markdownContent.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
            }
          }
        }
      }
      
      const published = document.getElementById('postPublished').checked;

      if (!name) {
        showToast('请填写文章名称', 'error');
        return;
      }

      if (!apiName) {
        showToast('请选择API（分类）', 'error');
        return;
      }

      // 验证必填字段
      // specialType 已经在上面声明过了（第2076行），这里直接使用
      const needsLocation = needsLocationFields(apiName);
      const isLocationReq = isLocationRequired(apiName);
      
      // 验证联系方式（在租房、二手集市和寻味中国中必填，防骗指南等可选）
      const needsPhone = needsPhoneField(apiName);
      // 判断电话字段是否为必填（寻味中国必填，防骗指南等可选）
      const lowerNameForPhone = apiName.toLowerCase();
      const isPhoneRequired = lowerNameForPhone.includes('chinese-food') || 
                              lowerNameForPhone.includes('寻味') ||
                              specialType === 'second-hand' || 
                              specialType === 'rentals';
      
      if (needsPhone && isPhoneRequired) {
        let phoneInput;
        if (specialType === 'second-hand') {
          phoneInput = document.getElementById('secondHandPhone');
        } else if (specialType === 'rentals') {
          phoneInput = document.getElementById('rentalsPhone');
        } else {
          // 寻味中国等其他分类使用通用电话字段
          phoneInput = document.getElementById('commonPhone');
        }
        
        // 检查字段是否可见（不在隐藏的表单中）
        if (phoneInput) {
          const isVisible = phoneInput.offsetParent !== null; // 检查元素是否可见
          if (isVisible && !phoneInput.value.trim()) {
            showToast('联系方式是必填项', 'error');
            phoneInput.focus();
            return;
          }
        }
      }
      
      // 验证位置信息（只在必填分类中验证）
      if (needsLocation && isLocationReq) {
        let addressInput, latInput, lngInput;
        
        if (specialType === 'second-hand') {
          addressInput = document.getElementById('secondHandAddress');
          latInput = document.getElementById('secondHandLatitude');
          lngInput = document.getElementById('secondHandLongitude');
        } else if (specialType === 'rentals') {
          addressInput = document.getElementById('rentalsAddress');
          latInput = document.getElementById('rentalsLatitude');
          lngInput = document.getElementById('rentalsLongitude');
        } else {
          addressInput = document.getElementById('commonAddress');
          latInput = document.getElementById('commonLatitude');
          lngInput = document.getElementById('commonLongitude');
        }
        
        // 只验证可见的字段
        if (addressInput) {
          const isVisible = addressInput.offsetParent !== null;
          if (isVisible && !addressInput.value.trim()) {
            showToast('地址是必填项', 'error');
            addressInput.focus();
            return;
          }
        }
        if (latInput) {
          const isVisible = latInput.offsetParent !== null;
          if (isVisible && !latInput.value.trim()) {
            showToast('纬度是必填项', 'error');
            latInput.focus();
            return;
          }
        }
        if (lngInput) {
          const isVisible = lngInput.offsetParent !== null;
          if (isVisible && !lngInput.value.trim()) {
            showToast('经度是必填项', 'error');
            lngInput.focus();
            return;
          }
        }
      }

      if (!category) {
        showToast('请填写分类/标签', 'error');
        return;
      }

      try {
        // 直接使用id（id现在是全局唯一的UUID）
        const url = id ? `${BLOG_ADMIN_API}/posts/${id}` : `${BLOG_ADMIN_API}/posts`;
        const method = id ? 'PUT' : 'POST';
        
        const requestBody = {
          name,
          title: title, // name和title保持一致
          slug: slug || undefined,
          excerpt,
          image: image || undefined,
          apiName: apiName, // API名称（用于确定数据存储位置）
          category: category, // 分类/标签（用于博客展示，替代原来的tags字段）
          published
        };
        
        // 添加特殊字段（二手市场和租房酒店）
        // specialType 和 needsLocation 已经在上面声明过了，这里直接使用
        
        if (specialType === 'second-hand') {
          const price = document.getElementById('secondHandPrice').value.trim();
          const phone = document.getElementById('secondHandPhone').value.trim();
          const address = document.getElementById('secondHandAddress').value.trim();
          const latitude = document.getElementById('secondHandLatitude').value.trim();
          const longitude = document.getElementById('secondHandLongitude').value.trim();
          if (price) requestBody.price = price;
          if (phone) requestBody.phone = phone;
          if (address) requestBody.address = address;
          if (latitude) requestBody.latitude = parseFloat(latitude);
          if (longitude) requestBody.longitude = parseFloat(longitude);
        } else if (specialType === 'rentals') {
          const price = document.getElementById('rentalsPrice').value.trim();
          const rooms = document.getElementById('rentalsRooms').value.trim();
          const area = document.getElementById('rentalsArea').value.trim();
          const views = document.getElementById('rentalsViews').value.trim();
          const phone = document.getElementById('rentalsPhone').value.trim();
          const address = document.getElementById('rentalsAddress').value.trim();
          const latitude = document.getElementById('rentalsLatitude').value.trim();
          const longitude = document.getElementById('rentalsLongitude').value.trim();
          if (price) requestBody.price = price;
          if (rooms) requestBody.rooms = rooms;
          if (area) requestBody.area = area;
          if (views) requestBody.views = parseInt(views) || 0;
          if (phone) requestBody.phone = phone;
          if (address) requestBody.address = address;
          if (latitude) requestBody.latitude = parseFloat(latitude);
          if (longitude) requestBody.longitude = parseFloat(longitude);
        } else if (needsLocation) {
          // 通用位置字段（用于其他需要位置的分类）
          const addressInput = document.getElementById('commonAddress');
          const latInput = document.getElementById('commonLatitude');
          const lngInput = document.getElementById('commonLongitude');
          if (addressInput) {
            const address = addressInput.value.trim();
            if (address) requestBody.address = address;
          }
          if (latInput) {
            const latitude = latInput.value.trim();
            if (latitude) requestBody.latitude = parseFloat(latitude);
          }
          if (lngInput) {
            const longitude = lngInput.value.trim();
            if (longitude) requestBody.longitude = parseFloat(longitude);
          }
        }
        
        // 添加通用电话字段（用于寻味中国等分类）
        const needsPhone = needsPhoneField(apiName);
        if (needsPhone && specialType !== 'second-hand' && specialType !== 'rentals') {
          const phoneInput = document.getElementById('commonPhone');
          if (phoneInput) {
            const phone = phoneInput.value.trim();
            if (phone) requestBody.phone = phone;
          }
        }
        
        // 如果是特殊类别，添加特殊数据
        // 注意：second-hand 和 rentals 虽然需要特殊字段，但仍然需要 htmlContent
        const needsSpecialDataOnly = specialType && (specialType === 'weather' || specialType === 'exchange-rate' || specialType === 'translation');
        
        if (specialType && specialData) {
          requestBody._specialData = specialData;
          requestBody._specialType = specialType;
          
          // 只有 weather、exchange-rate、translation 不使用 htmlContent
          // second-hand 和 rentals 仍然需要 htmlContent
          if (!needsSpecialDataOnly) {
            requestBody.htmlContent = htmlContent || undefined;
          }
          
          // 添加调试信息
          console.log('保存特殊类别文章', {
            specialType,
            needsSpecialDataOnly,
            specialDataKeys: Object.keys(specialData),
            specialDataPreview: JSON.stringify(specialData).substring(0, 500),
            hasHtmlContent: !needsSpecialDataOnly && htmlContent
          });
        } else {
          // 普通类别才添加htmlContent
          requestBody.htmlContent = htmlContent || undefined;
        }
        
        console.log('发送请求', {
          url,
          method,
          requestBody: JSON.stringify(requestBody, null, 2)
        });
        
        const response = await adminApiRequest(url, {
          method,
          body: JSON.stringify(requestBody)
        });
        
        console.log('收到响应', {
          success: response?.success,
          data: response?.data,
          message: response?.message
        });
        
        // 显示调试信息面板
        showDebugInfo({
          request: requestBody,
          response: response,
          specialType: specialType,
          specialData: specialData
        });
        
        if (response && response.success) {
          // 显示详细的成功信息（包含调试信息）
          const debugInfo = specialType && specialData 
            ? `\n调试信息：\n- 类型: ${specialType}\n- 数据键: ${Object.keys(specialData).join(', ')}\n- 数据预览: ${JSON.stringify(specialData).substring(0, 200)}`
            : '';
          
          console.log('保存成功', {
            id: response.data?.id,
            name: response.data?.name,
            apiName: response.data?.category,
            debugInfo
          });
          
          showToast(id ? '文章更新成功' : '文章创建成功', 'success');
          window.currentEditingPost = null; // 清除当前编辑的文章
          
          // 如果是在新窗口中打开的，刷新父窗口并关闭当前窗口
          if (window.opener) {
            // 通知父窗口刷新内容（根据父窗口类型调用不同的刷新方法）
            try {
              // blog-admin.html 使用 loadPosts
              if (typeof window.opener.loadPosts === 'function') {
                window.opener.loadPosts(false);
              }
              // blog-detail.html 使用 loadPost
              if (typeof window.opener.loadPost === 'function') {
                window.opener.loadPost();
              }
              // blog.html 可能使用 loadPosts 或 loadArchive（已在窗口关闭时处理）
            } catch (e) {
              console.warn('无法通知父窗口刷新:', e);
            }
            // 延迟关闭，让用户看到成功提示
            setTimeout(() => {
              window.close();
            }, 1000);
          } else {
            // 在当前窗口中，正常处理
            hidePostForm();
            loadPosts(false); // 保存后保持展开状态
          }
        } else {
          console.error('保存失败', response);
          showToast('保存失败: ' + (response?.message || '未知错误'), 'error');
        }
      } catch (error) {
        console.error('保存文章失败:', error);
        showToast('保存文章失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    // 编辑文章（在新窗口打开）
    function editPost(id) {
      // 在新窗口打开编辑页面
      const editUrl = `${window.location.pathname}?edit=${encodeURIComponent(id)}`;
      const editWindow = window.open(editUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!editWindow) {
        showToast('无法打开新窗口，请检查浏览器弹窗设置', 'error');
        return;
      }
      
      // 监听新窗口关闭事件，刷新文章列表
      const checkClosed = setInterval(() => {
        if (editWindow.closed) {
          clearInterval(checkClosed);
          // 刷新文章列表
          loadPosts(false);
        }
      }, 500);
    }
    
    // 编辑文章（内部函数，用于在新窗口中加载文章数据）
    async function editPostInternal(id) {
      const postForm = document.getElementById('postForm');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      try {
        // 显示表单和加载提示
        if (postForm) {
          postForm.style.display = 'block';
          postForm.classList.add('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'flex';
        }
        if (postFormContent) {
          postFormContent.style.display = 'none';
        }
        
        // 切换到文章标签页（如果不在新窗口）
        if (!window.opener) {
          switchTab('posts');
        }
        
        console.log('编辑文章，ID:', id);
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
        console.log('获取文章列表响应:', response);
        
        if (response && response.success && response.data) {
          // 直接使用id匹配（id现在是全局唯一的UUID）
          const post = response.data.find(p => {
            const pId = String(p.id || '');
            const searchId = String(id || '');
            return pId === searchId;
          });
          
          console.log('找到的文章:', post);
          
          if (post) {
            // 保存当前文章对象，用于后续保存时使用
            window.currentEditingPost = post;
            // 隐藏加载提示，显示表单内容
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postFormContent) {
              postFormContent.style.display = 'block';
            }
            // 填充表单数据
            showPostForm(post);
          } else {
            console.error('未找到文章，ID:', id, '可用文章ID:', response.data.map(p => p.id));
            // 隐藏加载提示
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postForm) {
              postForm.style.display = 'none';
            }
            showToast('未找到要编辑的文章', 'error');
          }
        } else {
          console.error('获取文章列表失败:', response);
          // 隐藏加载提示
          if (postForm) {
            postForm.classList.remove('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'none';
          }
          if (postForm) {
            postForm.style.display = 'none';
          }
          showToast('获取文章列表失败', 'error');
        }
      } catch (error) {
        console.error('加载文章失败:', error);
        // 隐藏加载提示
        if (postForm) {
          postForm.classList.remove('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'none';
        }
        if (postForm) {
          postForm.style.display = 'none';
        }
        showToast('加载文章失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    // 删除文章
    async function deletePost(id) {
      if (!confirm('确定要删除这篇文章吗？')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('文章删除成功', 'success');
          loadPosts(false); // 删除后保持展开状态
        }
      } catch (error) {
        console.error('删除文章失败:', error);
      }
    }

    // 分类管理函数
    async function loadCategories() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories`);
        if (response && response.success) {
          const tbody = document.getElementById('categoriesTableBody');
          const categories = response.data || [];
          if (categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="blog-empty">暂无分类</td></tr>';
          } else {
            tbody.innerHTML = categories.map(cat => `
              <tr>
                <td>${escapeHtml(cat.name)}</td>
                <td>${escapeHtml(cat.description || cat.path || '')}</td>
                <td>${cat.postCount || 0}</td>
                <td>
                  <div class="admin-actions">
                    <button class="admin-btn-small admin-btn-edit" onclick="editCategory(${cat.id})">编辑</button>
                    <button class="admin-btn-small admin-btn-delete" onclick="deleteCategory(${cat.id})">删除</button>
                  </div>
                </td>
              </tr>
            `).join('');
          }
        }
      } catch (error) {
        document.getElementById('categoriesTableBody').innerHTML = '<tr><td colspan="4" class="blog-empty">加载失败</td></tr>';
      }
    }

    function showCategoryForm(category = null) {
      const form = document.getElementById('categoryForm');
      const formTitle = document.getElementById('categoryFormTitle');
      
      if (category) {
        formTitle.textContent = '编辑分类';
        document.getElementById('categoryId').value = category.id;
        document.getElementById('categoryName').value = category.name || '';
        document.getElementById('categoryPath').value = category.description || category.path || '';
      } else {
        formTitle.textContent = '新建分类';
        document.getElementById('categoryFormElement').reset();
        document.getElementById('categoryId').value = '';
      }
      
      form.style.display = 'block';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    function hideCategoryForm() {
      document.getElementById('categoryForm').style.display = 'none';
      document.getElementById('categoryFormElement').reset();
      document.getElementById('categoryId').value = '';
    }

    async function saveCategory(event) {
      event.preventDefault();
      const id = document.getElementById('categoryId').value;
      const name = document.getElementById('categoryName').value.trim();
      const path = document.getElementById('categoryPath').value.trim();

      if (!name || !path) {
        showToast('请填写所有必填项', 'error');
        return;
      }

      if (!path.startsWith('/')) {
        showToast('路径必须以 / 开头', 'error');
        return;
      }

      try {
        const url = id ? `${BLOG_ADMIN_API}/categories/${id}` : `${BLOG_ADMIN_API}/categories`;
        const method = id ? 'PUT' : 'POST';
        
        const response = await adminApiRequest(url, {
          method,
          body: JSON.stringify({ name, path })
        });

        if (response && response.success) {
          showToast(id ? '分类更新成功' : '分类创建成功', 'success');
          hideCategoryForm();
          loadCategories();
        }
      } catch (error) {
        console.error('保存分类失败:', error);
        showToast('保存分类失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    async function editCategory(id) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories`);
        if (response && response.success) {
          const category = response.data.find(c => c.id === id);
          if (category) {
            showCategoryForm(category);
          }
        }
      } catch (error) {
        console.error('加载分类失败:', error);
      }
    }

    async function deleteCategory(id) {
      if (!confirm('确定要删除这个分类吗？如果有文章使用此分类，删除将失败。')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('分类删除成功', 'success');
          loadCategories();
        }
      } catch (error) {
        console.error('删除分类失败:', error);
        showToast('删除分类失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    // 标签管理函数
    async function loadTags() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/tags`);
        if (response && response.success) {
          const tbody = document.getElementById('tagsTableBody');
          const tags = response.data || [];
          if (tags.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="blog-empty">暂无标签</td></tr>';
          } else {
            tbody.innerHTML = tags.map(tag => `
              <tr>
                <td>${escapeHtml(tag.name)}</td>
                <td>${tag.postCount || 0}</td>
              </tr>
            `).join('');
          }
        }
      } catch (error) {
        document.getElementById('tagsTableBody').innerHTML = '<tr><td colspan="2" class="blog-empty">加载失败</td></tr>';
      }
    }

    function showTagForm() {
      document.getElementById('tagForm').style.display = 'block';
    }

    function hideTagForm() {
      document.getElementById('tagForm').style.display = 'none';
      document.getElementById('tagForm').querySelector('form').reset();
    }

    async function saveTag(event) {
      event.preventDefault();
      const name = document.getElementById('tagName').value.trim();

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/tags`, {
          method: 'POST',
          body: JSON.stringify({ name })
        });

        if (response && response.success) {
          showToast('标签创建成功', 'success');
          hideTagForm();
          loadTags();
        }
      } catch (error) {
        console.error('创建标签失败:', error);
      }
    }

    // 评论管理函数
    async function loadComments() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments`);
        if (response && response.success) {
          const tbody = document.getElementById('commentsTableBody');
          const comments = response.data || [];
          if (comments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="blog-empty">暂无评论</td></tr>';
          } else {
            tbody.innerHTML = comments.map(comment => {
              const date = formatDateTime(comment.createdAt || comment.created_at);
              return `
                <tr>
                  <td>${escapeHtml(comment.postName || '')}</td>
                  <td>${escapeHtml(comment.authorName)}</td>
                  <td>${escapeHtml(truncate(comment.content, 50))}</td>
                  <td>${comment.approved ? '<span style="color: #10b981;">已审核</span>' : '<span style="color: #f59e0b;">待审核</span>'}</td>
                  <td>${date}</td>
                  <td>
                    <div class="admin-actions">
                      ${!comment.approved ? `<button class="admin-btn-small admin-btn-approve" onclick="approveComment('${comment.id}')">审核</button>` : ''}
                      <button class="admin-btn-small admin-btn-delete" onclick="deleteComment('${comment.id}')">删除</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('');
          }
        }
      } catch (error) {
        document.getElementById('commentsTableBody').innerHTML = '<tr><td colspan="6" class="blog-empty">加载失败</td></tr>';
      }
    }

    async function approveComment(id) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments/${id}/approve`, {
          method: 'PUT',
          body: JSON.stringify({ approved: true })
        });

        if (response && response.success) {
          showToast('评论已审核通过', 'success');
          loadComments();
        }
      } catch (error) {
        console.error('审核评论失败:', error);
      }
    }

    async function deleteComment(id) {
      if (!confirm('确定要删除这条评论吗？')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('评论删除成功', 'success');
          loadComments();
        }
      } catch (error) {
        console.error('删除评论失败:', error);
      }
    }

    // 初始化
    // 获取URL参数
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // 检查URL参数并自动打开编辑对话框
    async function checkUrlParams() {
      const editId = getUrlParam('edit');
      if (editId) {
        // 等待页面加载完成后再执行编辑
        setTimeout(async () => {
          await editPostInternal(editId);
          // 清除URL参数，避免刷新时重复执行
          const url = new URL(window.location);
          url.searchParams.delete('edit');
          window.history.replaceState({}, '', url);
        }, 500);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // 如果是在新窗口中打开编辑页面，只加载必要的资源
      const isEditWindow = window.opener && getUrlParam('edit');
      
      if (isEditWindow) {
        // 新窗口：隐藏不相关的元素，只显示编辑表单
        hideUnnecessaryElements();
        // 更新页面标题
        updatePageTitleForEdit();
        // 立即显示表单和加载提示（等待DOM完全加载）
        setTimeout(() => {
          const postForm = document.getElementById('postForm');
          const postFormLoading = document.getElementById('postFormLoading');
          const postFormContent = document.getElementById('postFormContent');
          if (postForm) {
            postForm.style.display = 'block';
            postForm.classList.add('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'flex';
          }
          if (postFormContent) {
            postFormContent.style.display = 'none';
          }
        }, 100);
      } else {
        // 主窗口：加载文章列表
      loadPosts();
      }
      
      // 所有窗口都需要加载API列表
      loadApis();
      
      // 监听图片URL输入框变化，实时更新预览
      const postImageInput = document.getElementById('postImage');
      if (postImageInput) {
        postImageInput.addEventListener('input', function() {
          updateImagePreview(this.value);
        });
        
        // 初始化时也检查一次
        updateImagePreview(postImageInput.value);
      }
      
      // 检查URL参数，如果有edit参数，自动打开编辑对话框
      await checkUrlParams();
    });
    
    // 隐藏新窗口中不需要的元素
    function hideUnnecessaryElements() {
      // 隐藏标签页导航
      const tabsContainer = document.querySelector('.admin-tabs');
      if (tabsContainer) {
        tabsContainer.style.display = 'none';
      }
      
      // 隐藏文章管理标题和新建按钮
      const postsHeader = document.querySelector('#tab-posts > div:first-child');
      if (postsHeader) {
        postsHeader.style.display = 'none';
      }
      
      // 隐藏文章列表表格
      const postsTable = document.querySelector('#tab-posts > div:last-child');
      if (postsTable && postsTable.querySelector('#postsTableBody')) {
        postsTable.style.display = 'none';
      }
      
      // 隐藏其他标签页内容
      const otherTabs = ['tab-categories', 'tab-tags', 'tab-comments'];
      otherTabs.forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (tab) {
          tab.style.display = 'none';
        }
      });
      
      // 确保文章表单容器可见
      const postsTab = document.getElementById('tab-posts');
      if (postsTab) {
        postsTab.style.display = 'block';
        postsTab.classList.add('active');
      }
      
      // 隐藏"返回博客"按钮（新窗口中不需要）
      const returnButton = document.querySelector('.admin-header a[href="/blog.html"]');
      if (returnButton) {
        returnButton.style.display = 'none';
      }
      
      // 调整容器样式，让编辑表单更突出
      const adminContainer = document.querySelector('.admin-container');
      if (adminContainer) {
        adminContainer.style.maxWidth = '100%';
        adminContainer.style.padding = '1rem';
      }
    }
    
    // 更新页面标题为编辑模式
    function updatePageTitleForEdit() {
      const headerTitle = document.querySelector('.admin-header h1');
      if (headerTitle) {
        headerTitle.textContent = '编辑文章';
      }
      
      const headerSubtitle = document.querySelector('.admin-header p');
      if (headerSubtitle) {
        headerSubtitle.textContent = '编辑文章内容';
      }
    }
    
    /**
     * 处理图片上传
     */
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) {
        return;
      }
      
      // 验证文件类型
      if (!file.type.startsWith('image/')) {
        alert('请选择图片文件');
        event.target.value = '';
        return;
      }
      
      // 验证文件大小（10MB）
      if (file.size > 10 * 1024 * 1024) {
        alert('图片文件大小不能超过10MB');
        event.target.value = '';
        return;
      }
      
      // 显示上传进度
      const progressDiv = document.getElementById('imageUploadProgress');
      const progressBar = document.getElementById('imageUploadProgressBar');
      const statusSpan = document.getElementById('imageUploadStatus');
      
      progressDiv.style.display = 'block';
      progressBar.style.width = '0%';
      statusSpan.textContent = '上传中...';
      
      try {
        // 创建FormData
        const formData = new FormData();
        formData.append('image', file);
        
        // 发送上传请求
        const response = await fetch('/api/admin/custom-apis/upload-image', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin' // 包含cookie用于身份验证
        });
        
        // 模拟上传进度
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress < 90) {
            progressBar.style.width = progress + '%';
          }
        }, 100);
        
        const result = await response.json();
        clearInterval(progressInterval);
        
        if (!response.ok || !result.success) {
          throw new Error(result.message || '上传失败');
        }
        
        // 上传成功
        progressBar.style.width = '100%';
        statusSpan.textContent = '上传成功！';
        
        // 获取完整URL（根据当前请求域名）
        const imageUrl = result.image.url;
        
        // 填充到图片URL输入框
        document.getElementById('postImage').value = imageUrl;
        
        // 更新预览
        updateImagePreview(imageUrl);
        
        // 2秒后隐藏进度条
        setTimeout(() => {
          progressDiv.style.display = 'none';
          progressBar.style.width = '0%';
        }, 2000);
        
        // 清空文件输入框，允许重复上传同一文件
        event.target.value = '';
        
      } catch (error) {
        console.error('图片上传失败:', error);
        progressBar.style.width = '0%';
        statusSpan.textContent = '上传失败: ' + error.message;
        statusSpan.style.color = '#ef4444';
        
        setTimeout(() => {
          progressDiv.style.display = 'none';
          statusSpan.style.color = '#6b7280';
        }, 3000);
        
        event.target.value = '';
      }
    }
    
    /**
     * 更新图片预览
     */
    function updateImagePreview(imageUrl) {
      const previewDiv = document.getElementById('imagePreview');
      const previewImg = document.getElementById('imagePreviewImg');
      
      if (imageUrl && imageUrl.trim()) {
        previewImg.src = imageUrl;
        previewDiv.style.display = 'block';
      } else {
        previewDiv.style.display = 'none';
      }
    }
    
    /**
     * 同步name和title字段
     */
    function syncNameAndTitle() {
      const nameInput = document.getElementById('postName');
      if (nameInput) {
        // name和title保持一致，这里只需要确保name字段的值正确即可
        // title会在保存时自动设置为与name相同
      }
    }
    
    /**
     * 显示调试信息面板
     */
    function showDebugInfo(info) {
      // 创建或获取调试面板
      let debugPanel = document.getElementById('debugPanel');
      if (!debugPanel) {
        debugPanel = document.createElement('div');
        debugPanel.id = 'debugPanel';
        debugPanel.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          width: 500px;
          max-height: 80vh;
          background: #1f2937;
          color: #f3f4f6;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
          z-index: 10000;
          font-family: 'Courier New', monospace;
          font-size: 12px;
          overflow-y: auto;
          display: none;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '×';
        closeBtn.style.cssText = `
          position: absolute;
          top: 10px;
          right: 10px;
          background: #ef4444;
          color: white;
          border: none;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 20px;
          line-height: 1;
        `;
        closeBtn.onclick = () => {
          debugPanel.style.display = 'none';
        };
        debugPanel.appendChild(closeBtn);
        
        const title = document.createElement('h3');
        title.textContent = '调试信息';
        title.style.cssText = 'margin: 0 0 15px 0; color: #60a5fa;';
        debugPanel.appendChild(title);
        
        document.body.appendChild(debugPanel);
      }
      
      // 清空内容（保留标题和关闭按钮）
      const title = debugPanel.querySelector('h3');
      const closeBtn = debugPanel.querySelector('button');
      debugPanel.innerHTML = '';
      debugPanel.appendChild(closeBtn);
      debugPanel.appendChild(title);
      
      // 添加调试信息
      const sections = [
        { title: '请求数据', data: info.request },
        { title: '响应数据', data: info.response },
        { title: '特殊类型', data: info.specialType },
        { title: '特殊数据', data: info.specialData }
      ];
      
      sections.forEach(section => {
        if (section.data) {
          const sectionDiv = document.createElement('div');
          sectionDiv.style.cssText = 'margin-bottom: 15px;';
          
          const sectionTitle = document.createElement('h4');
          sectionTitle.textContent = section.title;
          sectionTitle.style.cssText = 'color: #34d399; margin: 0 0 5px 0; font-size: 14px;';
          sectionDiv.appendChild(sectionTitle);
          
          const pre = document.createElement('pre');
          pre.style.cssText = 'margin: 0; padding: 10px; background: #111827; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;';
          pre.textContent = JSON.stringify(section.data, null, 2);
          sectionDiv.appendChild(pre);
          
          debugPanel.appendChild(sectionDiv);
        }
      });
      
      // 显示面板
      debugPanel.style.display = 'block';
      
      // 5秒后自动隐藏（可选）
      setTimeout(() => {
        if (debugPanel.style.display === 'block') {
          debugPanel.style.display = 'none';
        }
      }, 10000);
    }
  </script>
</body>
</html>
