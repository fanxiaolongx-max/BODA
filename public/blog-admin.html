<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>博客管理 - DevBlog</title>
  <link rel="stylesheet" href="/css/blog.css">
  <link rel="stylesheet" href="/css/blog-unified.css">
  <style>
    /* 全局防止溢出 */
    html, body {
      width: 100% !important;
      max-width: 100% !important;
      overflow-x: hidden !important;
      box-sizing: border-box !important;
    }
    
    * {
      box-sizing: border-box;
    }
    
    /* 全局强制所有表格单元格左对齐（最高优先级，覆盖 blog-unified.css） */
    .admin-table td,
    .admin-table td *,
    #tab-categories .admin-table td,
    #tab-categories .admin-table td *,
    #tab-comments .admin-table td,
    #tab-comments .admin-table td * {
      text-align: left !important;
    }
    
    /* 在所有媒体查询中都强制左对齐 */
    @media (max-width: 640px) {
      .admin-table td,
      .admin-table td *,
      #tab-categories .admin-table td,
      #tab-categories .admin-table td *,
      #tab-comments .admin-table td,
      #tab-comments .admin-table td * {
        text-align: left !important;
      }
    }
    
    @media (max-width: 768px) {
      .admin-table td,
      .admin-table td *,
      #tab-categories .admin-table td,
      #tab-categories .admin-table td *,
      #tab-comments .admin-table td,
      #tab-comments .admin-table td * {
        text-align: left !important;
      }
    }
    
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
      background-color: #F9FAFB;
      min-height: 100vh;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      overflow-x: hidden;
    }
    
    /* 全局强制所有表格单元格左对齐（覆盖 blog-unified.css） */
    .admin-table td,
    #tab-categories .admin-table td,
    #tab-comments .admin-table td {
      text-align: left !important;
    }
    
    /* 移动端容器优化 */
    @media (max-width: 768px) {
      /* 强制所有表格单元格左对齐 */
      .admin-table td,
      #tab-categories .admin-table td,
      #tab-comments .admin-table td {
        text-align: left !important;
      }
      /* 全局防止横向滚动 */
      html, body {
        overflow-x: hidden !important;
        width: 100% !important;
        max-width: 100vw !important;
        padding-right: env(safe-area-inset-right, 0px) !important;
        box-sizing: border-box !important;
        position: relative !important;
      }
      
      /* 确保所有直接子元素不超出 */
      body > * {
        max-width: 100vw !important;
        box-sizing: border-box !important;
        overflow-x: hidden !important;
      }
      
      .admin-container {
        padding: 1rem 0.5rem 1rem 0.5rem !important;
        padding-right: calc(0.5rem + env(safe-area-inset-right, 0.5rem)) !important;
        max-width: 100%;
        width: 100%;
        box-sizing: border-box;
        overflow-x: hidden;
      }
      
      /* iOS安全区域适配 */
      @supports (padding: max(0px)) {
        .admin-container {
          padding-right: max(0.5rem, env(safe-area-inset-right)) !important;
        }
      }
      
      /* 确保表单不会溢出 */
      form {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: hidden !important;
      }
      
      /* 确保表单内的所有容器不会溢出 */
      form > div,
      form > div > div,
      #postFormContent,
      #postFormContent > div,
      #postFormContent > div > div {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 强制覆盖所有内联样式中的固定max-width */
      form div[style*="max-width: 500px"],
      form div[style*="max-width: 400px"],
      form div[style*="max-width: 300px"],
      form div[style*="max-width: 350px"] {
        max-width: 100% !important;
      }
      
      /* 确保flex容器不会溢出 */
      form div[style*="display: flex"] {
        max-width: 100% !important;
        box-sizing: border-box !important;
        flex-wrap: wrap !important;
      }
      
      .admin-card {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0 !important;
        box-sizing: border-box !important;
      }
      
      /* 确保所有表单容器都能正确适配 */
      .admin-form {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding: 1rem 0.75rem !important;
      }
      
      /* 强制覆盖表单的grid布局 - 这是关键！ */
      form > div[style*="grid-template-columns"],
      form > div[style*="display: grid"],
      #postFormContent > div[style*="grid-template-columns"],
      #postFormContent > div[style*="display: grid"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 确保grid布局中的子元素不会溢出 */
      form > div[style*="grid-template-columns"] > *,
      form > div[style*="display: grid"] > *,
      #postFormContent > div[style*="grid-template-columns"] > *,
      #postFormContent > div[style*="display: grid"] > * {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        min-width: 0 !important;
      }
      
      /* 确保侧边栏在移动端不sticky */
      form > div[style*="grid-template-columns"] > div[style*="position: sticky"],
      form > div[style*="display: grid"] > div[style*="position: sticky"],
      #postFormContent > div[style*="grid-template-columns"] > div[style*="position: sticky"],
      #postFormContent > div[style*="display: grid"] > div[style*="position: sticky"] {
        position: static !important;
        order: -1 !important; /* 移到顶部 */
        margin-bottom: 1.5rem !important;
      }
      
      /* 确保所有表单组都能正确适配 */
      .admin-form-group {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 覆盖所有内联样式中的max-width */
      div[style*="max-width"] {
        max-width: 100% !important;
      }
      
      /* 确保封面图容器正确适配 */
      #coverImageContainer {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        aspect-ratio: 16/9 !important;
      }
      
      /* 确保编辑器容器正确适配 */
      #htmlEditorContainer,
      #wang-editor-container {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 确保所有输入框容器正确适配 */
      input,
      textarea,
      select {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 确保所有flex容器不会溢出 */
      div[style*="display: flex"] {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
    }
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .admin-tabs {
      display: flex;
      gap: 0;
      border-bottom: 1px solid #E5E7EB;
      margin-bottom: 1.5rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      background: transparent;
    }
    .admin-tabs::-webkit-scrollbar {
      display: none;
    }
    .admin-tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: #6B7280;
      transition: all 0.2s;
      white-space: nowrap;
      font-family: var(--font-family-base);
      position: relative;
    }
    .admin-tab:hover {
      color: #9333ea;
    }
    .admin-tab.active {
      color: #9333ea;
      border-bottom-color: #9333ea;
      background: transparent;
    }
    .admin-tab-content {
      display: none;
    }
    .admin-tab-content.active {
      display: block !important;
    }
    
    /* 确保移动端选项卡内容正确显示 */
    @media (max-width: 768px) {
      .admin-tab-content {
        display: none !important;
      }
      .admin-tab-content.active {
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 确保选项卡内容内的容器元素都能正确显示 */
      .admin-tab-content.active > .admin-card-header {
        display: flex !important;
      }
      
      .admin-tab-content.active > .admin-card {
        display: block !important;
      }
      
      /* 只有明确设置了display: block的表单才显示，避免自动显示postForm */
      .admin-tab-content.active > .admin-form[style*="display: block"] {
        display: block !important;
      }
      
      /* 确保postForm默认隐藏，除非明确显示 */
      .admin-tab-content.active > #postForm {
        display: none !important;
      }
      
      .admin-tab-content.active > #postForm[style*="display: block"] {
        display: block !important;
      }
      
      /* 确保表格结构正确显示 */
      .admin-tab-content.active table {
        display: table !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      .admin-tab-content.active thead {
        display: table-header-group !important;
      }
      
      .admin-tab-content.active tbody {
        display: table-row-group !important;
      }
      
      .admin-tab-content.active tr {
        display: table-row !important;
      }
      
      .admin-tab-content.active td,
      .admin-tab-content.active th {
        display: table-cell !important;
      }
      
      /* 确保分类、评论选项卡的内容容器可见 */
      #tab-categories,
      #tab-comments {
        display: none !important;
      }
      
      #tab-categories.active,
      #tab-comments.active {
        display: block !important;
      }
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: #FFFFFF;
      border-radius: 0;
      overflow: hidden;
    }
    
    /* 覆盖 blog-unified.css 中的响应式表格规则，移除 ::before 伪元素的冒号 */
    /* blog-unified.css 第292-297行有 .admin-table td:before { content: attr(data-label) ': '; } */
    /* blog-unified.css 第286行有 text-align: right; 需要覆盖为左对齐 */
    .admin-table td::before,
    .admin-table td:before,
    .admin-table th::before,
    .admin-table th:before {
      content: '' !important;
      display: none !important;
      visibility: hidden !important;
      width: 0 !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      float: none !important;
      font-weight: normal !important;
      color: transparent !important;
    }
    
    /* 覆盖 blog-unified.css 中的右对齐规则，强制左对齐 */
    .admin-table td {
      text-align: left !important;
    }
    
    /* 在所有媒体查询中都强制左对齐 */
    @media (max-width: 640px) {
      .admin-table td {
        text-align: left !important;
      }
      
      #tab-categories .admin-table td,
      #tab-tags .admin-table td,
      #tab-comments .admin-table td {
        text-align: left !important;
      }
    }
    
    @media (max-width: 768px) {
      .admin-table td {
        text-align: left !important;
      }
      
      #tab-categories .admin-table td,
      #tab-tags .admin-table td,
      #tab-comments .admin-table td {
        text-align: left !important;
      }
    }
    
    /* 特别针对分类、标签、评论表格移除冒号 */
    #tab-categories .admin-table td::before,
    #tab-categories .admin-table td:before,
    #tab-tags .admin-table td::before,
    #tab-tags .admin-table td:before,
    #tab-comments .admin-table td::before,
    #tab-comments .admin-table td:before,
    #tab-categories .admin-table th::before,
    #tab-categories .admin-table th:before,
    #tab-tags .admin-table th::before,
    #tab-tags .admin-table th:before,
    #tab-comments .admin-table th::before,
    #tab-comments .admin-table th:before {
      content: '' !important;
      display: none !important;
      visibility: hidden !important;
      width: 0 !important;
      height: 0 !important;
      padding: 0 !important;
      margin: 0 !important;
      float: none !important;
      font-weight: normal !important;
      color: transparent !important;
    }
    .admin-table th {
      background: #F9FAFB;
      padding: 0.875rem 1rem;
      text-align: left;
      font-weight: 600;
      color: #6B7280;
      font-family: var(--font-family-base);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid #E5E7EB;
    }
    .admin-table td {
      padding: 1rem;
      border-top: 1px solid #F3F4F6;
      background: #FFFFFF;
      text-align: left !important;
    }
    
    /* 全局覆盖 blog-unified.css 中的右对齐规则 */
    .admin-table td,
    #tab-categories .admin-table td,
    #tab-tags .admin-table td,
    #tab-comments .admin-table td {
      text-align: left !important;
    }
    .admin-table tbody tr {
      background: #FFFFFF;
    }
    .admin-table tbody tr:hover {
      background: #F9FAFB;
    }
    .admin-table tr.category-header-row {
      background: #FFFFFF !important;
    }
    .admin-table tr.category-header-row:hover {
      background: #F9FAFB !important;
    }
    .admin-table tr.category-post-row {
      background: #FFFFFF !important;
    }
    .admin-table tr.category-post-row:hover {
      background: #F9FAFB !important;
    }
    .admin-table tr.category-header-row + tr {
      border-top: 1px solid #F3F4F6;
    }
    .admin-card {
      background: #FFFFFF;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #E5E7EB;
      margin-bottom: 1.5rem;
    }
    
    /* 移动端允许卡片内的按钮可见 */
    @media (max-width: 768px) {
      .admin-card {
        overflow-x: visible !important;
        overflow-y: hidden !important;
      }
      
      /* 确保移动端卡片容器允许按钮溢出 */
      #postsTableBodyMobile {
        overflow-x: visible !important;
        overflow-y: visible !important;
      }
    }
    .admin-form {
      background: #FFFFFF;
      padding: 2rem;
      border-radius: 0.5rem;
      border: 1px solid #E5E7EB;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 1.5rem;
    }
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-badge.published {
      background-color: #D1FAE5;
      color: #065F46;
    }
    .status-badge.draft {
      background-color: #F3F4F6;
      color: #6B7280;
    }
    .category-tag {
      display: inline-flex;
      align-items: center;
      padding: 0.1875rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
      background-color: #F3F4F6;
      color: #6B7280;
      border: none;
    }
    
    /* 状态指示器样式 */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.1875rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
      border: none;
    }
    
    .status-badge.published {
      background-color: #ECFDF5;
      color: #059669;
    }
    
    .status-badge.published::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #10B981;
      display: inline-block;
    }
    
    .status-badge.draft {
      background-color: #FEF3C7;
      color: #D97706;
    }
    
    .status-badge.draft::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #F59E0B;
      display: inline-block;
    }
    
    /* 文章行样式优化 */
    .category-post-row {
      transition: all 0.2s ease;
    }
    
    .category-post-row:hover {
      background-color: #F9FAFB !important;
    }
    
    .category-post-row:hover .admin-actions {
      opacity: 1;
      visibility: visible;
    }
    
    /* 操作按钮组优化 */
    .admin-actions {
      display: flex !important;
      gap: 0.375rem;
      opacity: 1 !important;
      visibility: visible !important;
      transition: all 0.2s ease;
      flex-wrap: nowrap !important;
    }
    
    .category-post-row:hover .admin-actions {
      opacity: 1 !important;
      visibility: visible !important;
    }
    
    /* 确保所有按钮都可见 */
    .admin-actions .admin-btn-edit,
    .admin-actions .admin-btn-copy,
    .admin-actions .admin-btn-delete {
      display: inline-flex !important;
      visibility: visible !important;
      opacity: 1 !important;
      flex-shrink: 0 !important;
    }
    
    /* 特别确保分类、标签、评论表格的删除按钮可见 */
    #tab-categories .admin-actions .admin-btn-delete,
    #tab-tags .admin-actions .admin-btn-delete,
    #tab-comments .admin-actions .admin-btn-delete {
      display: inline-flex !important;
      visibility: visible !important;
      opacity: 1 !important;
      flex-shrink: 0 !important;
      width: auto !important;
      min-width: auto !important;
    }
    
    .admin-btn-small {
      padding: 0.375rem 0.625rem;
      font-size: 0.75rem;
      border-radius: 0.25rem;
      border: 1px solid #E5E7EB;
      background: white;
      color: #6B7280;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    
    .admin-btn-small:hover {
      background: #F9FAFB;
      border-color: #D1D5DB;
      color: #374151;
      transform: translateY(-1px);
    }
    
    .admin-btn-edit:hover {
      background: #EEF2FF;
      border-color: #9333EA;
      color: #9333EA;
    }
    
    .admin-btn-copy:hover {
      background: #F0FDF4;
      border-color: #10B981;
      color: #10B981;
    }
    
    .admin-btn-delete:hover {
      background: #FEF2F2;
      border-color: #EF4444;
      color: #EF4444;
    }
    
    /* 分类标题行优化 */
    .category-header-row {
      border-bottom: 1px solid #E5E7EB;
      background: #FAFBFC !important;
    }
    
    .category-header-row:hover {
      background: #F3F4F6 !important;
    }
    
    /* 表格单元格紧凑化 */
    .admin-table td {
      padding: 0.625rem 0.75rem;
      vertical-align: middle;
    }
    
    .admin-table th {
      padding: 0.625rem 0.75rem;
    }
    
    /* 标题列加粗 */
    .category-post-row td:first-child {
      font-weight: 600;
      font-size: 0.9375rem;
      color: #111827;
    }
    .admin-form-group {
      margin-bottom: 1.5rem;
    }
    
    /* 左右分栏布局 - 平板和移动端 */
    @media (max-width: 1024px) {
      /* 表单grid布局移动端改为单列 */
      form > div[style*="grid-template-columns"],
      .admin-form > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
      }
      
      form > div[style*="grid-template-columns"] > div:last-child,
      .admin-form > div[style*="grid-template-columns"] > div:last-child {
        position: static !important;
        order: -1 !important; /* 侧边栏内容移到顶部 */
        margin-bottom: 1.5rem !important;
      }
      
      /* 确保侧边栏在移动端不sticky */
      form > div[style*="grid-template-columns"] > div:last-child[style*="position: sticky"],
      .admin-form > div[style*="grid-template-columns"] > div:last-child[style*="position: sticky"] {
        position: static !important;
      }
    }
    
    /* 封面图容器样式 */
    #coverImageContainer {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    #coverImageContainer:hover #coverImageOverlay {
      display: flex !important;
    }
    
    #coverImageContainer:hover {
      border-color: #9333ea;
    }
    
    #coverImagePreview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    
    /* 移动端封面图容器优化 */
    @media (max-width: 768px) {
      #coverImageContainer {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        aspect-ratio: 16/9 !important;
      }
      
      #coverImagePreview {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
      }
    }
    
    @media (max-width: 480px) {
      #coverImageContainer {
        aspect-ratio: 16/9 !important;
        border-radius: 0.375rem !important;
      }
    }
    
    /* 编辑器内图片和视频预览优化 */
    #wang-editor-container img,
    #wang-editor-container .w-e-text img,
    #wang-editor-container video,
    #wang-editor-container .w-e-text video,
    #wang-editor-container iframe,
    #wang-editor-container .w-e-text iframe {
      border-radius: 8px !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      background: #ffffff !important;
      max-width: 100% !important;
      height: auto !important;
      box-sizing: border-box !important;
    }
    
    /* 编辑器内所有媒体元素通用响应式规则 */
    #wang-editor-container img,
    #wang-editor-container .w-e-text img {
      max-width: 100% !important;
      width: auto !important;
      height: auto !important;
      display: block !important;
      margin: 1rem auto !important;
    }
    
    #wang-editor-container video,
    #wang-editor-container .w-e-text video {
      max-width: 100% !important;
      width: 100% !important;
      height: auto !important;
      display: block !important;
      margin: 1rem auto !important;
    }
    
    #wang-editor-container iframe,
    #wang-editor-container .w-e-text iframe {
      max-width: 100% !important;
      width: 100% !important;
      height: auto !important;
      min-height: 400px;
      display: block !important;
      margin: 1rem auto !important;
    }
    
    /* 编辑器内所有容器和块级元素响应式 */
    #wang-editor-container .w-e-text > * {
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    
    /* 编辑器内文字内容自动换行 */
    #wang-editor-container .w-e-text p,
    #wang-editor-container .w-e-text div,
    #wang-editor-container .w-e-text span,
    #wang-editor-container .w-e-text h1,
    #wang-editor-container .w-e-text h2,
    #wang-editor-container .w-e-text h3,
    #wang-editor-container .w-e-text h4,
    #wang-editor-container .w-e-text h5,
    #wang-editor-container .w-e-text h6 {
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    
    /* 确保编辑器内所有媒体元素响应式 */
    #wang-editor-container img,
    #wang-editor-container .w-e-text img {
      max-width: 100% !important;
      width: auto !important;
      height: auto !important;
      display: block !important;
      margin: 1rem auto !important;
    }
    
    #wang-editor-container video,
    #wang-editor-container .w-e-text video {
      max-width: 100% !important;
      width: 100% !important;
      height: auto !important;
      display: block !important;
      margin: 1rem auto !important;
    }
    
    #wang-editor-container iframe,
    #wang-editor-container .w-e-text iframe {
      max-width: 100% !important;
      width: 100% !important;
      height: auto !important;
      min-height: 400px;
      display: block !important;
      margin: 1rem auto !important;
    }
    
    /* 编辑器背景优化 */
    #wang-editor-container .w-e-text-container {
      background: #ffffff !important;
    }
    
    /* 侧边栏卡片样式 */
    form > div[style*="grid-template-columns"] > div:last-child > div {
      transition: box-shadow 0.2s;
    }
    
    form > div[style*="grid-template-columns"] > div:last-child > div:hover {
      box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
    }
    
    /* 输入框聚焦样式 */
    .admin-form-input:focus,
    .admin-form-select:focus,
    .admin-form-textarea:focus {
      outline: none;
      border-color: #9333ea;
      box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
    }
    
    /* 统一间距 */
    .admin-form-group {
      margin-bottom: 1rem;
    }
    
    .admin-form-label {
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      color: #6b7280;
      font-weight: 500;
    }
    .admin-form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #374151;
    }
    .admin-form-input,
    .admin-form-textarea,
    .admin-form-select {
      width: 100%;
      max-width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      box-sizing: border-box;
    }
    
    /* 确保所有输入框在移动端都能正确缩放 */
    @media (max-width: 768px) {
      .admin-form-input,
      .admin-form-textarea,
      .admin-form-select {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        font-size: 16px !important; /* 防止iOS自动缩放 */
      }
    }
    
    @media (max-width: 480px) {
      .admin-form-input,
      .admin-form-textarea,
      .admin-form-select {
        padding: 0.625rem !important;
        font-size: 16px !important; /* 防止iOS自动缩放 */
      }
    }
    
    /* 特殊类别表单中的输入框样式 */
    .weather-item .admin-form-input,
    .weather-item .admin-form-select,
    .exchange-rate-item .admin-form-input {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    /* 确保grid布局中的输入框不会溢出 */
    .weather-item > div[style*="grid"],
    .exchange-rate-item > div[style*="grid"] {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .weather-item .admin-form-group,
    .exchange-rate-item .admin-form-group {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .admin-form-textarea {
      min-height: 200px;
      font-family: monospace;
    }
    .admin-form-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* 文章表单加载提示样式 */
    .post-form-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      min-height: 300px;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #9333ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    
    .loading-text {
      color: #6b7280;
      font-size: 0.875rem;
      margin: 0;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    /* 可爱的加载动画 */
    @keyframes bounce {
      0%, 100% {
        transform: translateY(0) scale(1);
      }
      50% {
        transform: translateY(-10px) scale(1.1);
      }
    }
    
    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }
    
    @keyframes rotateEmoji {
      0% {
        transform: rotate(0deg) scale(1);
      }
      25% {
        transform: rotate(-10deg) scale(1.05);
      }
      50% {
        transform: rotate(0deg) scale(1.1);
      }
      75% {
        transform: rotate(10deg) scale(1.05);
      }
      100% {
        transform: rotate(0deg) scale(1);
      }
    }
    
    /* 加载时隐藏表单内容 */
    #postForm.loading #postFormContent {
      display: none;
    }
    
    #postForm.loading #postFormLoading {
      display: flex !important;
    }
    .admin-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid #E5E7EB;
      background: #FFFFFF;
      flex-wrap: nowrap;
      gap: 1rem;
    }
    .admin-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .admin-btn-small {
      padding: 0.5rem 1rem;
      font-size: 0.8125rem;
      border-radius: 0.5rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      font-family: var(--font-family-base);
      font-weight: 500;
      backdrop-filter: blur(10px);
    }
    .admin-btn-edit {
      background: rgba(59, 130, 246, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    .admin-btn-edit:hover {
      background: rgba(37, 99, 235, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
    }
    .admin-btn-delete {
      background: rgba(239, 68, 68, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
    }
    .admin-btn-delete:hover {
      background: rgba(220, 38, 38, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
    }
    .admin-btn-copy {
      background: rgba(16, 185, 129, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    .admin-btn-copy:hover {
      background: rgba(5, 150, 105, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
    }
    .admin-btn-approve {
      background: rgba(16, 185, 129, 0.9);
      backdrop-filter: blur(10px);
      color: white;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    .admin-btn-approve:hover {
      background: rgba(5, 150, 105, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
    }
    
    /* 移动端响应式优化 */
    @media (max-width: 768px) {
      .admin-container {
        padding: 1rem 0.5rem;
      }
      
      .admin-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
      }
      
      .admin-header h1 {
        font-size: 1.5rem;
        margin: 0;
      }
      
      .admin-header p {
        font-size: 0.875rem;
        margin-top: 0.25rem;
      }
      
      .admin-header > div:last-child {
        width: 100%;
      }
      
      .admin-header .blog-btn {
        width: 100%;
        justify-content: center;
      }
      
      .admin-tabs {
        width: 100%;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
      }
      
      .admin-tab {
        padding: 0.5rem 0.75rem;
        font-size: 0.8125rem;
        min-width: auto;
      }
      
      .admin-card-header {
        flex-direction: row !important;
        align-items: center !important;
        gap: 0.375rem !important;
        flex-wrap: nowrap !important;
        padding: 0.5rem 0.75rem !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      /* 移动端隐藏"文章管理"标题 */
      .admin-card-header h2 {
        display: none !important;
      }
      
      /* 强制覆盖内联样式，确保移动端不换行 - 使用更小的gap */
      .admin-card-header > div,
      .admin-card-header .admin-header-actions,
      .admin-card-header .admin-header-actions-container {
        display: flex !important;
        align-items: center !important;
        gap: 0.25rem !important;
        flex: 1 !important;
        min-width: 0 !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        scrollbar-width: thin !important;
      }
      
      /* 覆盖内联样式中的flex-wrap和gap - 使用!important强制覆盖 */
      .admin-card-header > div[style*="flex-wrap"],
      .admin-header-actions[style*="flex-wrap"],
      .admin-header-actions-container[style*="flex-wrap"],
      .admin-card-header > div[style*="gap"],
      .admin-header-actions[style*="gap"],
      .admin-header-actions-container[style*="gap"],
      .admin-card-header > div[style*="gap: 0.75rem"],
      .admin-header-actions[style*="gap: 0.75rem"],
      .admin-header-actions-container[style*="gap: 0.75rem"] {
        flex-wrap: nowrap !important;
        gap: 0.25rem !important;
      }
      
      /* 确保所有子元素都不换行 */
      .admin-card-header > div > *,
      .admin-header-actions > *,
      .admin-header-actions-container > * {
        flex-shrink: 0 !important;
        white-space: nowrap !important;
      }
      
      /* 搜索框除外，它需要收缩 */
      .admin-card-header > div > .admin-search-container,
      .admin-header-actions > .admin-search-container,
      .admin-header-actions-container > .admin-search-container {
        flex-shrink: 1 !important;
      }
      
      /* 搜索框移动端优化 - 缩小尺寸，确保不换行 */
      .admin-card-header > div > div:first-child,
      .admin-search-container {
        flex: 1 1 0% !important;
        min-width: 0 !important;
        max-width: none !important;
        flex-shrink: 1 !important;
        width: 0 !important; /* 强制flex收缩 */
      }
      
      .admin-card-header input[type="text"] {
        font-size: 0.6875rem !important;
        padding: 0.25rem 0.375rem 0.25rem 1.25rem !important;
        min-width: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        flex: 1 1 0% !important;
      }
      
      /* 搜索框图标缩小 */
      .admin-card-header input[type="text"] + svg {
        width: 12px !important;
        height: 12px !important;
        left: 0.375rem !important;
      }
      
      /* 搜索框占位符文字缩小 */
      .admin-card-header input[type="text"]::placeholder {
        font-size: 0.6875rem !important;
      }
      
      /* 状态筛选移动端优化 - 更紧凑，更小 */
      .admin-card-header select {
        font-size: 0.6875rem !important;
        padding: 0.25rem 0.375rem !important;
        flex-shrink: 0 !important;
        min-width: auto !important;
        width: auto !important;
        max-width: 65px !important;
        white-space: nowrap !important;
      }
      
      /* 新建文章按钮移动端优化 - 更紧凑，确保显示"+ 新建" */
      .admin-card-header .blog-btn {
        padding: 0.25rem 0.375rem !important;
        font-size: 0.6875rem !important;
        white-space: nowrap !important;
        flex-shrink: 0 !important;
        width: auto !important;
        min-width: auto !important;
        max-width: 60px !important;
        line-height: 1.2 !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      
      /* 确保按钮文字是"+ 新建" */
      .admin-card-header .blog-btn[onclick*="openNewPostInNewWindow"] {
        font-size: 0.6875rem !important;
        padding: 0.25rem 0.375rem !important;
      }
      
      /* 强制按钮文字显示"+ 新建"，防止被覆盖 */
      #tab-posts .admin-card-header .blog-btn[onclick*="openNewPostInNewWindow"],
      #tab-posts .admin-card-header .blog-btn-primary {
        font-size: 0.6875rem !important;
      }
      
      /* 确保按钮文字不被JavaScript修改 */
      #tab-posts .admin-card-header .blog-btn[onclick*="openNewPostInNewWindow"]::before {
        content: none !important;
        display: none !important;
      }
      
      /* 确保按钮文字不被覆盖，移除任何伪元素 */
      .admin-card-header .blog-btn::before,
      .admin-card-header .blog-btn::after {
        display: none !important;
        content: none !important;
      }
      
      /* 确保搜索框容器不换行 */
      .admin-card-header > div > div[style*="position: relative"],
      .admin-search-container {
        flex-shrink: 1 !important;
        min-width: 0 !important;
        max-width: none !important;
      }
      
      .admin-form {
        padding: 1rem 0.75rem;
      }
      
      /* 表单顶部栏移动端优化 */
      .admin-form > div:first-child {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        padding-bottom: 1rem;
      }
      
      .admin-form > div:first-child > div:last-child {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .admin-form > div:first-child > div:last-child .blog-btn {
        width: 100%;
        justify-content: center;
      }
      
      /* 左右分栏布局改为单列 - 强制覆盖内联样式 */
      form > div[style*="grid-template-columns"],
      form > div[style*="display: grid"],
      .admin-form > div[style*="grid-template-columns"],
      .admin-form > div[style*="display: grid"],
      #postFormElement > div[style*="grid-template-columns"],
      #postFormElement > div[style*="display: grid"] {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 1.5rem !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 侧边栏卡片在移动端全宽显示 */
      form > div[style*="grid-template-columns"] > div:last-child,
      form > div[style*="display: grid"] > div:last-child,
      .admin-form > div[style*="grid-template-columns"] > div:last-child,
      .admin-form > div[style*="display: grid"] > div:last-child,
      #postFormElement > div[style*="grid-template-columns"] > div:last-child,
      #postFormElement > div[style*="display: grid"] > div:last-child {
        position: static !important;
        order: -1 !important; /* 侧边栏内容移到顶部 */
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 确保grid布局中的左侧内容区也不会溢出 */
      form > div[style*="grid-template-columns"] > div:first-child,
      form > div[style*="display: grid"] > div:first-child,
      #postFormElement > div[style*="grid-template-columns"] > div:first-child,
      #postFormElement > div[style*="display: grid"] > div:first-child {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        min-width: 0 !important;
      }
      
      .admin-form-group {
        margin-bottom: 1rem;
      }
      
      .admin-form-label {
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
      }
      
      .admin-form-input,
      .admin-form-select,
      .admin-form-textarea {
        font-size: 16px !important; /* 防止iOS自动缩放 */
        padding: 0.75rem;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }
      
      /* 确保输入框在移动端不会缩放 */
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="url"],
      input[type="password"],
      input[type="datetime-local"],
      textarea,
      select {
        font-size: 16px !important; /* 防止iOS自动缩放 */
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 标题输入框特殊处理 */
      #postName {
        font-size: 1.125rem !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 摘要输入框特殊处理 */
      #postExcerpt {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        resize: vertical !important;
      }
      
      /* 图片URL输入框特殊处理 */
      #postImage {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      @media (min-width: 481px) {
        input[type="text"],
        input[type="number"],
        input[type="email"],
        input[type="url"],
        input[type="password"],
        input[type="datetime-local"],
        textarea,
        select {
          font-size: 0.9375rem !important;
        }
        
        #postName {
          font-size: 1.25rem !important;
        }
      }
      
      /* 表格移动端优化 - 隐藏表格，显示卡片列表 */
      .admin-table-wrapper,
      .admin-card > div.desktop-table-container {
        display: none !important;
      }
      
      /* 隐藏表格，使用卡片布局 */
      .admin-table {
        display: none !important;
      }
      
      /* 显示移动端卡片容器 */
      #postsTableBodyMobile {
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding: 0 !important;
        margin: 0 !important;
        overflow-x: visible !important;
        overflow-y: visible !important;
      }
      
      /* 桌面端显示表格，隐藏卡片 */
      @media (min-width: 769px) {
        .admin-card > div.desktop-table-container {
          display: block !important;
        }
        
        #postsTableBodyMobile {
          display: none !important;
        }
      }
      
      /* 移动端卡片样式 */
      .admin-post-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        padding: 0.625rem 0.75rem;
        margin-bottom: 0.5rem;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-height: auto;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: visible !important;
        overflow-y: hidden !important;
        flex-wrap: nowrap !important;
      }
      
      .admin-post-card-header {
        flex: 1;
        min-width: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0;
        overflow: hidden;
      }
      
      .admin-post-card-title {
        font-weight: 500;
        font-size: 0.875rem;
        color: #111827;
        flex: 1;
        min-width: 0;
        word-break: break-word;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      /* 状态标签在移动端显示在标题旁边 */
      .admin-post-card-header .status-badge {
        flex-shrink: 0;
        font-size: 0.6875rem !important;
        padding: 0.125rem 0.375rem !important;
        white-space: nowrap;
      }
      
      .admin-post-card-meta {
        display: none; /* 移动端隐藏详细元信息 */
      }
      
      .admin-post-card-meta-item {
        display: none;
      }
      
      /* 移动端显示简化的状态和分类 */
      .admin-post-card-header::after {
        content: '';
        display: none;
      }
      
      .admin-post-card-actions {
        display: flex !important;
        gap: 0.25rem;
        margin-top: 0;
        padding-top: 0;
        border-top: none;
        flex-shrink: 0 !important;
        width: auto !important;
        min-width: auto !important;
        max-width: none !important;
        box-sizing: border-box;
        overflow-x: visible !important;
        overflow-y: visible !important;
        flex-wrap: nowrap !important;
        align-items: center !important;
      }
      
      .admin-post-card-actions .admin-btn-small {
        padding: 0.375rem 0.5rem !important;
        font-size: 0.75rem !important;
        min-width: auto !important;
        flex: 0 0 auto !important;
        white-space: nowrap !important;
        flex-shrink: 0 !important;
        max-width: none !important;
        box-sizing: border-box !important;
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        width: auto !important;
      }
      
      /* 确保所有按钮都可见 */
      .admin-post-card-actions .admin-btn-edit,
      .admin-post-card-actions .admin-btn-copy,
      .admin-post-card-actions .admin-btn-delete {
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* 如果空间不足，让按钮可以横向滚动 */
      @media (max-width: 480px) {
        .admin-post-card {
          flex-wrap: nowrap;
          overflow-x: visible;
        }
        
        .admin-post-card-header {
          flex: 1;
          min-width: 0;
          max-width: none !important;
          overflow: hidden;
        }
        
        .admin-post-card {
          overflow-x: visible !important;
          overflow-y: hidden !important;
        }
        
        .admin-post-card-header {
          flex: 1 !important;
          min-width: 0 !important;
          max-width: none !important;
          overflow: hidden !important;
        }
        
        .admin-post-card-actions {
          flex-shrink: 0 !important;
          width: auto !important;
          min-width: auto !important;
          max-width: none !important;
          overflow-x: visible !important;
          overflow-y: visible !important;
          display: flex !important;
          visibility: visible !important;
        }
        
        .admin-post-card-actions .admin-btn-small {
          padding: 0.25rem 0.375rem !important;
          font-size: 0.6875rem !important;
          min-width: auto !important;
          max-width: none !important;
          white-space: nowrap !important;
          display: inline-flex !important;
          visibility: visible !important;
          opacity: 1 !important;
          flex-shrink: 0 !important;
        }
        
        /* 确保所有按钮在超小屏幕也可见 */
        .admin-post-card-actions .admin-btn-edit,
        .admin-post-card-actions .admin-btn-copy,
        .admin-post-card-actions .admin-btn-delete {
          display: inline-flex !important;
          visibility: visible !important;
          opacity: 1 !important;
        }
      }
      
      /* 确保文章卡片整体不溢出，但允许按钮可见 */
      .admin-post-card {
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: visible !important;
        overflow-y: hidden !important;
      }
      
      /* 确保标题区域不会挤压按钮 */
      .admin-post-card-header {
        min-width: 0 !important;
        overflow: hidden !important;
      }
      
      /* 移动端分类标题样式 */
      .admin-category-header-mobile {
        background: #f9fafb;
        padding: 0.5rem 0.75rem;
        font-weight: 600;
        font-size: 0.8125rem;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        user-select: none;
      }
      
      .admin-category-header-mobile:first-child {
        margin-top: 0;
      }
      
      .admin-category-header-mobile .category-expand-icon {
        display: inline-block;
        width: 12px;
        text-align: center;
        color: #6b7280;
        font-size: 0.75rem;
      }
      
      /* 折叠状态下的分类文章隐藏 */
      .admin-category-mobile.collapsed ~ .admin-post-card {
        display: none;
      }
      
      .admin-category-mobile.collapsed ~ .admin-category-header-mobile ~ .admin-post-card {
        display: none;
      }
      
      /* 分类标签样式 */
      .category-tag {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        background: #f3f4f6;
        color: #6b7280;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
      }
      
      /* 状态标签样式 */
      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
      }
      
      .status-badge.published {
        background: #d1fae5;
        color: #065f46;
      }
      
      .status-badge.draft {
        background: #fee2e2;
        color: #991b1b;
      }
      
      /* 分类标题行移动端样式 */
      .category-header-row {
        display: none !important;
      }
      
      .admin-category-header-mobile {
        display: block !important;
        background: #f9fafb;
        padding: 0.75rem 1rem;
        margin: 1rem 0 0.5rem 0;
        border-radius: 0.375rem;
        font-weight: 600;
        font-size: 0.875rem;
        color: #374151;
        border-left: 3px solid #9333ea;
      }
      
      .admin-category-header-mobile:first-child {
        margin-top: 0;
      }
      
      .admin-table th {
        padding: 0.75rem 0.5rem;
        font-size: 0.6875rem;
      }
      
      .admin-table td {
        padding: 0.75rem 0.5rem;
      }
      
      /* 表格操作按钮移动端优化 - 移除sticky定位 */
      .admin-table td:last-child {
        position: static !important;
        right: auto !important;
        background: transparent !important;
        z-index: auto !important;
        min-width: auto;
        white-space: nowrap;
      }
      
      .admin-table tbody tr:hover td:last-child {
        background: transparent !important;
      }
      
      /* 表格中的按钮组移动端优化 */
      .admin-table .admin-actions {
        display: flex !important;
        flex-direction: row;
        gap: 0.25rem;
        flex-wrap: wrap;
        opacity: 1 !important;
        visibility: visible !important;
      }
      
      .admin-table .admin-btn-small {
        padding: 0.375rem 0.5rem;
        font-size: 0.75rem;
        min-width: auto;
        width: auto;
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* 操作按钮组移动端优化 */
      .admin-actions {
        flex-direction: column;
        gap: 0.5rem;
        opacity: 1 !important;
        visibility: visible !important;
      }
      
      /* 确保所有操作按钮在移动端都可见 */
      .admin-actions .admin-btn-edit,
      .admin-actions .admin-btn-copy,
      .admin-actions .admin-btn-delete {
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      .admin-btn-small,
      .admin-btn {
        width: 100%;
        justify-content: center;
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
      }
      
      /* 按钮组横向排列时改为纵向（但排除表格内的按钮组） */
      div[style*="display: flex"][style*="gap"]:not(.admin-actions):not(.admin-table .admin-actions) {
        flex-direction: column !important;
        gap: 0.75rem !important;
      }
      
      /* 表单底部的按钮组 */
      form > div:last-child[style*="display: flex"],
      .admin-form > div:last-child[style*="display: flex"] {
        flex-direction: column !important;
        gap: 0.75rem !important;
      }
      
      form > div:last-child[style*="display: flex"] .blog-btn,
      .admin-form > div:last-child[style*="display: flex"] .blog-btn {
        width: 100%;
        justify-content: center;
      }
      
      /* 特殊表单移动端优化 */
      #specialForm-translation,
      #specialForm-weather,
      #specialForm-exchangeRate,
      #specialForm-rentals {
        max-width: 100% !important;
      }
      
      #specialForm-translation .admin-form-group,
      #specialForm-weather .admin-form-group,
      #specialForm-exchangeRate .admin-form-group,
      #specialForm-rentals .admin-form-group {
        max-width: 100% !important;
      }
      
      /* 特殊表单中的网格布局移动端优化 */
      #specialForm-weather > div[style*="grid-template-columns"],
      #specialForm-exchangeRate > div[style*="grid-template-columns"],
      #specialForm-rentals > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      
      /* 封面图容器移动端优化 */
      #coverImageContainer {
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* 编辑器工具栏移动端优化 */
      .editor-toolbar {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        flex-wrap: nowrap !important;
        white-space: nowrap !important;
        padding: 0.5rem !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      .editor-toolbar a {
        margin: 0.125rem !important;
        padding: 0.375rem 0.5rem !important;
        font-size: 0.875rem !important;
        flex-shrink: 0 !important;
      }
      
      /* HTML编辑器容器移动端优化 */
      #htmlEditorContainer {
        width: 100% !important;
        max-width: 100% !important;
        overflow: hidden !important;
        box-sizing: border-box !important;
      }
      
      #postHtmlContent {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      #wang-editor-toolbar {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        box-sizing: border-box !important;
      }
      
      #wang-editor-container {
        width: 100% !important;
        max-width: 100% !important;
        min-height: 300px !important;
        box-sizing: border-box !important;
        overflow-x: hidden !important;
      }
      
      /* WangEditor工具栏按钮组 */
      #wang-editor-toolbar .w-e-bar-item {
        flex-shrink: 0 !important;
      }
      
      /* WangEditor编辑区域 */
      #wang-editor-container .w-e-text-container {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: hidden !important;
      }
      
      #wang-editor-container .w-e-text {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
      }
      
      /* 表单顶部栏移动端优化 */
      form > div:first-child[style*="display: flex"],
      #postFormContent > div:first-child[style*="display: flex"] {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 1rem !important;
        padding-bottom: 1rem !important;
      }
      
      form > div:first-child[style*="display: flex"] > div:last-child,
      #postFormContent > div:first-child[style*="display: flex"] > div:last-child {
        width: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 0.5rem !important;
      }
      
      form > div:first-child[style*="display: flex"] > div:last-child button,
      #postFormContent > div:first-child[style*="display: flex"] > div:last-child button {
        width: 100% !important;
        justify-content: center !important;
      }
      
      /* 标题输入框移动端优化 */
      #postName {
        font-size: 1.125rem !important;
        padding: 0.625rem 0 !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 摘要输入框移动端优化 */
      #postExcerpt {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        resize: vertical !important;
      }
      
      /* 侧边栏在移动端移到顶部 */
      form > div[style*="grid-template-columns"] > div:last-child {
        position: static !important;
        order: -1 !important;
        margin-bottom: 1.5rem !important;
      }
      
      /* 侧边栏卡片移动端优化 */
      form > div[style*="grid-template-columns"] > div:last-child > div {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 封面图容器移动端优化 */
      #coverImageContainer {
        width: 100% !important;
        max-width: 100% !important;
        aspect-ratio: 16/9 !important;
        box-sizing: border-box !important;
      }
      
      /* 所有输入框和选择框移动端优化 */
      .admin-form-input,
      .admin-form-select,
      .admin-form-textarea {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 特殊表单中的按钮组移动端优化 */
      #specialForm-translation button,
      #specialForm-weather button,
      #specialForm-exchangeRate button,
      #specialForm-rentals button {
        width: 100% !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        padding: 0.5rem 0.75rem !important;
        font-size: 0.875rem !important;
      }
      
      /* 特殊表单中的网格布局移动端改为单列 */
      #specialForm-translation > div[style*="grid-template-columns"],
      #specialForm-weather > div[style*="grid-template-columns"],
      #specialForm-exchangeRate > div[style*="grid-template-columns"],
      #specialForm-rentals > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
        gap: 0.75rem !important;
      }
      
      /* 地址搜索按钮组移动端优化 */
      div[style*="display: flex"][style*="gap"] button {
        width: 100% !important;
        white-space: normal !important;
        word-wrap: break-word !important;
      }
    }
    
    /* 超小屏幕优化 */
    @media (max-width: 480px) {
      .admin-container {
        padding: 0.75rem 0.5rem;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      .admin-header h1 {
        font-size: 1.25rem;
      }
      
      .admin-tab {
        padding: 0.5rem;
        font-size: 0.75rem;
      }
      
      .admin-form {
        padding: 0.75rem 0.5rem !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      .admin-table {
        min-width: 500px;
        font-size: 0.8125rem;
      }
      
      .admin-table th,
      .admin-table td {
        padding: 0.5rem 0.375rem;
      }
      
      /* 超小屏幕下的卡片头部 */
      .admin-card-header {
        padding: 0.5rem 0.375rem !important;
        gap: 0.25rem !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
      }
      
      /* 超小屏也隐藏标题 */
      .admin-card-header h2 {
        display: none !important;
      }
      
      .admin-card-header > div,
      .admin-header-actions,
      .admin-header-actions-container {
        gap: 0.125rem !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        flex: 1 !important;
        min-width: 0 !important;
      }
      
      /* 确保容器内的元素正确排列 */
      .admin-header-actions-container {
        display: flex !important;
        align-items: center !important;
        flex-wrap: nowrap !important;
      }
      
      /* 确保搜索框、筛选、按钮都在一行 */
      .admin-header-actions-container > * {
        flex-shrink: 0 !important;
        white-space: nowrap !important;
      }
      
      .admin-header-actions-container > .admin-search-container {
        flex-shrink: 1 !important;
        flex: 1 1 0% !important;
        min-width: 0 !important;
      }
      
      .admin-card-header input[type="text"] {
        font-size: 0.625rem !important;
        padding: 0.25rem 0.25rem 0.25rem 1rem !important;
        min-width: 0 !important;
      }
      
      .admin-card-header input[type="text"] + svg {
        width: 10px !important;
        height: 10px !important;
        left: 0.25rem !important;
      }
      
      .admin-card-header input[type="text"]::placeholder {
        font-size: 0.625rem !important;
      }
      
      .admin-card-header select {
        font-size: 0.625rem !important;
        padding: 0.25rem 0.25rem !important;
        max-width: 60px !important;
      }
      
      .admin-card-header .blog-btn {
        font-size: 0.625rem !important;
        padding: 0.25rem 0.25rem !important;
        line-height: 1.2 !important;
      }
      
      /* 确保表单默认不显示 - 强制隐藏 */
      #postForm {
        display: none !important;
      }
      
      /* 只有明确设置了display: block时才显示 */
      #postForm[style*="display: block"] {
        display: block !important;
      }
      
      /* 防止其他CSS规则覆盖 */
      .admin-tab-content.active > #postForm:not([style*="display: block"]) {
        display: none !important;
      }
      
      /* 所有标签页内容增加右侧边距适配iOS */
      .admin-tab-content {
        padding-right: env(safe-area-inset-right, 0.5rem) !important;
        box-sizing: border-box !important;
      }
      
      @supports (padding: max(0px)) {
        .admin-tab-content {
          padding-right: max(0.5rem, env(safe-area-inset-right)) !important;
        }
      }
      
      .admin-card,
      .admin-form {
        padding-right: env(safe-area-inset-right, 0.5rem) !important;
        box-sizing: border-box !important;
      }
      
      @supports (padding: max(0px)) {
        .admin-card,
        .admin-form {
          padding-right: max(0.5rem, env(safe-area-inset-right)) !important;
        }
      }
      
      .admin-card-header {
        padding-right: env(safe-area-inset-right, 0.5rem) !important;
        box-sizing: border-box !important;
      }
      
      @supports (padding: max(0px)) {
        .admin-card-header {
          padding-right: max(0.5rem, env(safe-area-inset-right)) !important;
        }
      }
      
      /* 分类、标签、评论头部移动端优化 */
      #tab-categories .admin-card-header,
      #tab-tags .admin-card-header,
      #tab-comments .admin-card-header {
        flex-direction: row !important;
        align-items: center !important;
        gap: 0.375rem !important;
        flex-wrap: nowrap !important;
        padding: 0.5rem 0.75rem !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      #tab-categories .admin-card-header h2,
      #tab-tags .admin-card-header h2,
      #tab-comments .admin-card-header h2 {
        font-size: 0.875rem !important;
        margin: 0 !important;
        flex-shrink: 0 !important;
        white-space: nowrap !important;
      }
      
      #tab-categories .admin-card-header .blog-btn,
      #tab-tags .admin-card-header .blog-btn {
        padding: 0.375rem 0.625rem !important;
        font-size: 0.75rem !important;
        white-space: nowrap !important;
        flex-shrink: 0 !important;
        width: auto !important;
      }
      
      /* 响应式表格：移动端显示卡片，桌面端显示表格 */
      /* 移动端：隐藏表格，显示卡片 */
      .categories-table-desktop,
      .tags-table-desktop,
      .comments-table-desktop {
        display: none !important;
      }
      
      .categories-table-mobile,
      .tags-table-mobile,
      .comments-table-mobile {
        display: block !important;
      }
      
      /* 桌面端：显示表格，隐藏卡片 */
      @media (min-width: 769px) {
        .categories-table-desktop,
        .tags-table-desktop,
        .comments-table-desktop {
          display: block !important;
        }
        
        .categories-table-mobile,
        .tags-table-mobile,
        .comments-table-mobile {
          display: none !important;
        }
      }
      
      /* 移动端卡片样式 */
      .admin-table-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        text-align: left !important;
      }
      
      .admin-table-card-row {
        display: flex;
        align-items: flex-start;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f3f4f6;
        text-align: left !important;
        justify-content: flex-start !important;
      }
      
      .admin-table-card-row:last-child {
        border-bottom: none;
      }
      
      .admin-table-card-row.admin-table-card-actions-row {
        padding-top: 0.75rem;
        margin-top: 0.5rem;
        border-top: 1px solid #e5e7eb;
        border-bottom: none;
        justify-content: flex-start !important;
      }
      
      .admin-table-card-label {
        font-weight: 600;
        color: #6b7280;
        font-size: 0.875rem;
        min-width: 80px;
        flex-shrink: 0;
        margin-right: 0.5rem;
        text-align: left !important;
      }
      
      .admin-table-card-value {
        flex: 1;
        color: #111827;
        font-size: 0.875rem;
        word-break: break-word;
        text-align: left !important;
      }
      
      .admin-table-card-actions-row .admin-actions {
        width: 100%;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        justify-content: flex-start !important;
      }
      
      /* 覆盖 blog-unified.css 中的右对齐规则 */
      #tab-categories .admin-table td,
      #tab-tags .admin-table td,
      #tab-comments .admin-table td {
        text-align: left !important;
      }
      
      .categories-table-mobile,
      .tags-table-mobile,
      .comments-table-mobile {
        text-align: left !important;
      }
      
      .categories-table-mobile *,
      .tags-table-mobile *,
      .comments-table-mobile * {
        text-align: left !important;
      }
      
      /* 分类、标签、评论移动端表格优化 */
      #tab-categories .admin-card,
      #tab-tags .admin-card,
      #tab-comments .admin-card {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: visible !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      /* 移动端表格容器显示滚动条 */
      .categories-table-desktop,
      .tags-table-desktop,
      .comments-table-desktop {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        scrollbar-width: thin !important; /* Firefox - 显示细滚动条 */
        scrollbar-color: #d1d5db #f3f4f6 !important; /* Firefox - 滚动条颜色 */
      }
      
      /* WebKit 浏览器滚动条样式（Chrome, Safari, Edge） */
      .categories-table-desktop::-webkit-scrollbar,
      .tags-table-desktop::-webkit-scrollbar,
      .comments-table-desktop::-webkit-scrollbar {
        height: 8px !important;
        display: block !important; /* 始终显示滚动条 */
      }
      
      .categories-table-desktop::-webkit-scrollbar-track,
      .tags-table-desktop::-webkit-scrollbar-track,
      .comments-table-desktop::-webkit-scrollbar-track {
        background: #f3f4f6 !important;
        border-radius: 4px !important;
      }
      
      .categories-table-desktop::-webkit-scrollbar-thumb,
      .tags-table-desktop::-webkit-scrollbar-thumb,
      .comments-table-desktop::-webkit-scrollbar-thumb {
        background: #d1d5db !important;
        border-radius: 4px !important;
      }
      
      .categories-table-desktop::-webkit-scrollbar-thumb:hover,
      .tags-table-desktop::-webkit-scrollbar-thumb:hover,
      .comments-table-desktop::-webkit-scrollbar-thumb:hover {
        background: #9ca3af !important;
      }
      
      /* 确保表格容器内的滚动容器也显示滚动条 */
      .categories-table-desktop > div,
      .tags-table-desktop > div,
      .comments-table-desktop > div {
        overflow-x: auto !important;
        scrollbar-width: thin !important;
        scrollbar-color: #d1d5db #f3f4f6 !important;
      }
      
      .categories-table-desktop > div::-webkit-scrollbar,
      .tags-table-desktop > div::-webkit-scrollbar,
      .comments-table-desktop > div::-webkit-scrollbar {
        height: 8px !important;
        display: block !important;
      }
      
      .categories-table-desktop > div::-webkit-scrollbar-track,
      .tags-table-desktop > div::-webkit-scrollbar-track,
      .comments-table-desktop > div::-webkit-scrollbar-track {
        background: #f3f4f6 !important;
        border-radius: 4px !important;
      }
      
      .categories-table-desktop > div::-webkit-scrollbar-thumb,
      .tags-table-desktop > div::-webkit-scrollbar-thumb,
      .comments-table-desktop > div::-webkit-scrollbar-thumb {
        background: #d1d5db !important;
        border-radius: 4px !important;
      }
      
      /* 移动端头部按钮组也显示滚动条 */
      #tab-categories .admin-card-header,
      #tab-tags .admin-card-header,
      #tab-comments .admin-card-header {
        scrollbar-width: thin !important;
        scrollbar-color: #d1d5db #f3f4f6 !important;
      }
      
      #tab-categories .admin-card-header::-webkit-scrollbar,
      #tab-tags .admin-card-header::-webkit-scrollbar,
      #tab-comments .admin-card-header::-webkit-scrollbar {
        height: 6px !important;
        display: block !important;
      }
      
      #tab-categories .admin-card-header::-webkit-scrollbar-track,
      #tab-tags .admin-card-header::-webkit-scrollbar-track,
      #tab-comments .admin-card-header::-webkit-scrollbar-track {
        background: #f3f4f6 !important;
        border-radius: 3px !important;
      }
      
      #tab-categories .admin-card-header::-webkit-scrollbar-thumb,
      #tab-tags .admin-card-header::-webkit-scrollbar-thumb,
      #tab-comments .admin-card-header::-webkit-scrollbar-thumb {
        background: #d1d5db !important;
        border-radius: 3px !important;
      }
      
      #tab-categories table,
      #tab-tags table,
      #tab-comments table {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        font-size: 0.8125rem !important;
      }
      
      /* 确保分类、标签、评论表格在移动端正常显示 */
      #tab-categories table,
      #tab-tags table,
      #tab-comments table {
        display: table !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        font-size: 0.8125rem !important;
        table-layout: auto !important;
        border-collapse: collapse !important;
      }
      
      #tab-categories thead,
      #tab-tags thead,
      #tab-comments thead {
        display: table-header-group !important;
      }
      
      #tab-categories tbody,
      #tab-tags tbody,
      #tab-comments tbody {
        display: table-row-group !important;
      }
      
      #tab-categories tr,
      #tab-tags tr,
      #tab-comments tr {
        display: table-row !important;
      }
      
      #tab-categories th,
      #tab-tags th,
      #tab-comments th,
      #tab-categories td,
      #tab-tags td,
      #tab-comments td {
        display: table-cell !important;
        padding: 0.5rem 0.375rem !important;
        font-size: 0.75rem !important;
        white-space: nowrap !important;
        word-break: break-word !important;
        max-width: 150px !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        text-align: left !important;
        vertical-align: middle !important;
        border: none !important;
      }
      
      /* 移除移动端表格单元格的伪元素内容（如果有冒号） */
      #tab-categories td::before,
      #tab-tags td::before,
      #tab-comments td::before,
      #tab-categories td::after,
      #tab-tags td::after,
      #tab-comments td::after,
      #tab-categories th::before,
      #tab-tags th::before,
      #tab-comments th::before,
      #tab-categories th::after,
      #tab-tags th::after,
      #tab-comments th::after {
        content: none !important;
        display: none !important;
      }
      
      /* 全局移除所有表格单元格的伪元素冒号（桌面端和移动端） */
      #tab-categories table td::before,
      #tab-tags table td::before,
      #tab-comments table td::before,
      #tab-categories table td::after,
      #tab-tags table td::after,
      #tab-comments table td::after,
      #tab-categories table th::before,
      #tab-tags table th::before,
      #tab-comments table th::before,
      #tab-categories table th::after,
      #tab-tags table th::after,
      #tab-comments table th::after {
        content: '' !important;
        display: none !important;
        visibility: hidden !important;
        width: 0 !important;
        height: 0 !important;
        padding: 0 !important;
        margin: 0 !important;
      }
      
      /* 确保表格列对齐，防止错位 */
      #tab-categories table th,
      #tab-tags table th,
      #tab-comments table th {
        text-align: left !important;
        vertical-align: middle !important;
        font-weight: 600 !important;
      }
      
      #tab-categories table td,
      #tab-tags table td,
      #tab-comments table td {
        text-align: left !important;
        vertical-align: middle !important;
      }
      
      /* 强制所有分类、标签、评论内容左对齐（覆盖 blog-unified.css 的右对齐规则） */
      #tab-categories,
      #tab-tags,
      #tab-comments {
        text-align: left !important;
      }
      
      #tab-categories .admin-card,
      #tab-tags .admin-card,
      #tab-comments .admin-card {
        text-align: left !important;
      }
      
      /* 确保表格容器也左对齐 */
      .categories-table-desktop,
      .tags-table-desktop,
      .comments-table-desktop,
      .categories-table-mobile,
      .tags-table-mobile,
      .comments-table-mobile {
        text-align: left !important;
      }
      
      /* 确保表格内的所有元素都左对齐 */
      .categories-table-desktop *,
      .tags-table-desktop *,
      .comments-table-desktop *,
      .categories-table-mobile *,
      .tags-table-mobile *,
      .comments-table-mobile * {
        text-align: left !important;
      }
      
      /* 特别覆盖 blog-unified.css 中移动端的右对齐规则 */
      @media (max-width: 640px) {
        .admin-table td {
          text-align: left !important;
        }
        
        #tab-categories .admin-table td,
        #tab-tags .admin-table td,
        #tab-comments .admin-table td {
          text-align: left !important;
        }
        
        .categories-table-desktop .admin-table td,
        .tags-table-desktop .admin-table td,
        .comments-table-desktop .admin-table td {
          text-align: left !important;
        }
      }
      
      @media (max-width: 768px) {
        .admin-table td {
          text-align: left !important;
        }
        
        #tab-categories .admin-table td,
        #tab-tags .admin-table td,
        #tab-comments .admin-table td {
          text-align: left !important;
        }
      }
      
      /* 操作按钮移动端优化 */
      #tab-categories .admin-actions,
      #tab-tags .admin-actions,
      #tab-comments .admin-actions {
        display: flex !important;
        gap: 0.25rem !important;
        flex-wrap: nowrap !important;
        opacity: 1 !important;
        visibility: visible !important;
      }
      
      #tab-categories .admin-btn-small,
      #tab-tags .admin-btn-small,
      #tab-comments .admin-btn-small {
        padding: 0.25rem 0.5rem !important;
        font-size: 0.6875rem !important;
        white-space: nowrap !important;
        flex-shrink: 0 !important;
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* 确保所有操作按钮在移动端都可见 */
      #tab-categories .admin-btn-edit,
      #tab-categories .admin-btn-delete,
      #tab-tags .admin-btn-edit,
      #tab-tags .admin-btn-delete,
      #tab-comments .admin-btn-edit,
      #tab-comments .admin-btn-delete {
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* 确保操作列宽度足够显示所有按钮 */
      #tab-categories table td:last-child,
      #tab-tags table td:last-child,
      #tab-comments table td:last-child {
        min-width: 120px !important;
        width: auto !important;
        max-width: none !important;
      }
      
      /* 确保操作按钮组不换行 */
      #tab-categories .admin-actions,
      #tab-tags .admin-actions,
      #tab-comments .admin-actions {
        flex-wrap: nowrap !important;
        gap: 0.375rem !important;
      }
      
      /* 分类、评论表单移动端优化 - 默认隐藏 */
      #categoryForm {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        padding: 1rem 0.75rem !important;
        display: none !important;
      }
      
      /* 只有在显式显示时才显示 */
      #categoryForm[style*="display: block"] {
        display: block !important;
      }
      
      #categoryForm .admin-form-group {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      #categoryForm input {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        font-size: 16px !important; /* 防止iOS自动缩放 */
      }
      
      #categoryForm button {
        width: 100% !important;
        box-sizing: border-box !important;
        margin-top: 0.5rem !important;
      }
      
      #categoryForm > div[style*="display: flex"] {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }
      
      /* 超小屏幕进一步优化 */
      @media (max-width: 480px) {
        #tab-categories .admin-card-header,
        #tab-tags .admin-card-header,
        #tab-comments .admin-card-header {
          padding: 0.5rem !important;
          gap: 0.25rem !important;
        }
        
        #tab-categories .admin-card-header h2,
        #tab-tags .admin-card-header h2,
        #tab-comments .admin-card-header h2 {
          font-size: 0.8125rem !important;
        }
        
        #tab-categories .admin-card-header .blog-btn,
        #tab-tags .admin-card-header .blog-btn {
          padding: 0.25rem 0.5rem !important;
          font-size: 0.6875rem !important;
        }
        
        #tab-categories th,
        #tab-tags th,
        #tab-comments th,
        #tab-categories td,
        #tab-tags td,
        #tab-comments td {
          padding: 0.375rem 0.25rem !important;
          font-size: 0.6875rem !important;
          max-width: 120px !important;
        }
        
        #tab-categories .admin-btn-small,
        #tab-tags .admin-btn-small,
        #tab-comments .admin-btn-small {
          padding: 0.25rem 0.375rem !important;
          font-size: 0.625rem !important;
        }
      }
      
      /* 超小屏幕文章卡片优化 */
      .admin-post-card {
        padding: 0.5rem 0.625rem !important;
        gap: 0.5rem !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: visible !important;
        overflow-y: hidden !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        flex-wrap: nowrap !important;
      }
      
      .admin-post-card-title {
        font-size: 0.8125rem !important;
        flex: 1 !important;
        min-width: 0 !important;
        overflow: hidden !important;
      }
      
      .admin-post-card-header {
        flex: 1 !important;
        min-width: 0 !important;
        overflow: hidden !important;
        max-width: none !important;
      }
      
      .admin-post-card-actions {
        flex-shrink: 0 !important;
        gap: 0.25rem !important;
        width: auto !important;
        min-width: auto !important;
        max-width: none !important;
        overflow-x: visible !important;
        overflow-y: visible !important;
        flex-wrap: nowrap !important;
        display: flex !important;
        align-items: center !important;
      }
      
      .admin-post-card-actions .admin-btn-small {
        padding: 0.25rem 0.375rem !important;
        font-size: 0.6875rem !important;
        flex: 0 0 auto !important;
        min-width: auto !important;
        max-width: none !important;
        white-space: nowrap !important;
        overflow: visible !important;
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      /* 超小屏幕下的表单标题 */
      .admin-form h3,
      #postFormTitle {
        font-size: 1.125rem !important;
      }
      
      /* HTML编辑器超小屏幕优化 */
      #wang-editor-container {
        min-height: 250px !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      #wang-editor-toolbar {
        padding: 0.375rem !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      .editor-toolbar a {
        padding: 0.25rem 0.375rem !important;
        font-size: 0.8125rem !important;
      }
      
      /* 标题输入框超小屏幕优化 */
      #postName {
        font-size: 1rem !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 摘要输入框超小屏幕优化 */
      #postExcerpt {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        min-height: 80px !important;
      }
      
      /* 封面图容器超小屏幕优化 */
      #coverImageContainer {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        aspect-ratio: 16/9 !important;
      }
      
      /* 所有输入框超小屏幕优化 */
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="url"],
      input[type="password"],
      input[type="datetime-local"],
      textarea,
      select {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        font-size: 16px !important; /* 防止iOS自动缩放 */
      }
      
      /* 按钮超小屏幕优化 */
      .blog-btn,
      .admin-btn {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.875rem !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* HTML编辑器容器超小屏幕优化 */
      #htmlEditorContainer {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      #postHtmlContent {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
    }
    
    /* 中等屏幕（平板横屏）优化 */
    @media (min-width: 481px) and (max-width: 768px) {
      .admin-container {
        padding: 1rem;
      }
      
      .admin-table {
        min-width: 550px;
      }
      
      /* 表格操作按钮可以横向排列 */
      .admin-table .admin-actions {
        flex-direction: row;
        flex-wrap: wrap;
      }
    }
    .markdown-editor {
      min-height: 400px;
    }
    
    /* 编辑器容器响应式样式 */
    #wang-editor-container {
      max-width: 100%;
      overflow-x: auto;
    }
    
    /* 编辑器内容区域响应式 */
    #wang-editor-container .w-e-text-container {
      max-width: 100%;
      overflow-x: auto;
    }
    
    /* 编辑器内所有图片响应式 */
    #wang-editor-container img,
    #wang-editor-container .w-e-text img {
      max-width: 100% !important;
      width: auto !important;
      height: auto !important;
      display: block !important;
      margin: 1rem auto !important;
      border-radius: 0.375rem !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      object-fit: contain !important;
    }
    
    /* 编辑器内所有视频响应式 */
    #wang-editor-container video,
    #wang-editor-container .w-e-text video {
      max-width: 100% !important;
      width: 100% !important;
      height: auto !important;
      display: block !important;
      margin: 1rem auto !important;
      border-radius: 0.375rem !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
    }
    
    /* 编辑器内iframe响应式 */
    #wang-editor-container iframe,
    #wang-editor-container .w-e-text iframe {
      max-width: 100% !important;
      width: 100% !important;
      height: auto !important;
      min-height: 400px;
      display: block !important;
      margin: 1rem auto !important;
      border-radius: 0.375rem !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      border: none !important;
    }
    
    /* 移动端编辑器内媒体元素优化 */
    @media (max-width: 768px) {
      #wang-editor-container img,
      #wang-editor-container .w-e-text img {
        max-width: 100% !important;
        width: auto !important;
        height: auto !important;
        margin: 0.75rem auto !important;
      }
      
      #wang-editor-container video,
      #wang-editor-container .w-e-text video {
        max-width: 100% !important;
        width: 100% !important;
        height: auto !important;
        margin: 0.75rem auto !important;
      }
      
      #wang-editor-container iframe,
      #wang-editor-container .w-e-text iframe {
        max-width: 100% !important;
        width: 100% !important;
        height: 250px !important;
        min-height: 250px !important;
        margin: 0.75rem auto !important;
      }
    }
    
    @media (max-width: 480px) {
      #wang-editor-container img,
      #wang-editor-container .w-e-text img {
        margin: 0.5rem auto !important;
      }
      
      #wang-editor-container video,
      #wang-editor-container .w-e-text video {
        margin: 0.5rem auto !important;
      }
      
      #wang-editor-container iframe,
      #wang-editor-container .w-e-text iframe {
        height: 200px !important;
        min-height: 200px !important;
        margin: 0.5rem auto !important;
      }
    }
    
    /* 视频块样式（兼容Quill和WangEditor） */
    .ql-video-block,
    .video-block {
      margin: 1rem 0;
      width: 100% !important;
      max-width: 100% !important;
      overflow: hidden;
      box-sizing: border-box !important;
    }
    
    .ql-video-block video,
    .video-block video {
      max-width: 100% !important;
      width: 100% !important;
      height: auto !important;
      display: block !important;
      margin: 1rem 0 !important;
      border-radius: 0.375rem !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      box-sizing: border-box !important;
    }
    
    .ql-video-block iframe,
    .video-block iframe {
      max-width: 100% !important;
      width: 100% !important;
      height: 400px !important;
      display: block !important;
      margin: 1rem 0 !important;
      border-radius: 0.375rem !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      border: none !important;
      box-sizing: border-box !important;
    }
    
    /* 移动端视频块优化 */
    @media (max-width: 768px) {
      .ql-video-block,
      .video-block {
        width: 100% !important;
        max-width: 100% !important;
        margin: 0.75rem 0 !important;
      }
      
      .ql-video-block video,
      .video-block video {
        max-width: 100% !important;
        width: 100% !important;
        height: auto !important;
        margin: 0.75rem 0 !important;
      }
      
      .ql-video-block iframe,
      .video-block iframe {
        max-width: 100% !important;
        width: 100% !important;
        height: 250px !important;
        min-height: 250px !important;
        margin: 0.75rem 0 !important;
      }
    }
    
    @media (max-width: 480px) {
      .ql-video-block iframe,
      .video-block iframe {
        height: 200px !important;
        min-height: 200px !important;
        margin: 0.5rem 0 !important;
      }
    }
    
    /* 移动端响应式 */
    @media (max-width: 768px) {
      #wang-editor-container iframe,
      #wang-editor-container .w-e-text iframe,
      .ql-video-block iframe,
      .video-block iframe {
        height: 250px !important;
        min-height: 250px;
        max-width: 100% !important;
        width: 100% !important;
      }
      
      #wang-editor-container {
        font-size: 14px;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow-x: hidden !important;
      }
      
      /* 确保编辑器容器内的所有元素都不会溢出 */
      #wang-editor-container * {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 强制覆盖编辑器内可能存在的固定宽度样式 */
      #wang-editor-container [style*="width"],
      #wang-editor-container [style*="max-width"],
      #wang-editor-container [style*="min-width"] {
        max-width: 100% !important;
      }
      
      /* 确保编辑器内的图片不会超出容器 */
      #wang-editor-container img[style*="width"],
      #wang-editor-container .w-e-text img[style*="width"] {
        max-width: 100% !important;
        width: auto !important;
        height: auto !important;
      }
      
      /* WangEditor工具栏移动端优化 */
      #wang-editor-toolbar {
        width: 100% !important;
        max-width: 100% !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0.5rem !important;
      }
      
      #wang-editor-toolbar .w-e-bar {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important;
        min-width: max-content !important;
        width: 100% !important;
      }
      
      #wang-editor-toolbar .w-e-bar-item {
        flex-shrink: 0 !important;
        white-space: nowrap !important;
        padding: 0.375rem 0.5rem !important;
        font-size: 0.875rem !important;
      }
      
      /* WangEditor编辑区域移动端优化 */
      #wang-editor-container .w-e-text-container {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow-x: hidden !important;
      }
      
      #wang-editor-container .w-e-text {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        overflow-x: hidden !important;
        padding: 0.75rem !important;
        font-size: 16px !important; /* 防止iOS自动缩放 */
        line-height: 1.6 !important;
      }
      
      /* 编辑器内所有内容强制响应式 */
      #wang-editor-container .w-e-text *,
      #wang-editor-container .w-e-text-container * {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 编辑器内所有图片强制响应式 */
      #wang-editor-container .w-e-text img,
      #wang-editor-container img {
        max-width: 100% !important;
        width: auto !important;
        height: auto !important;
        display: block !important;
        margin: 0.75rem auto !important;
        border-radius: 0.375rem !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      }
      
      /* 编辑器内所有视频强制响应式 */
      #wang-editor-container .w-e-text video,
      #wang-editor-container video {
        max-width: 100% !important;
        width: 100% !important;
        height: auto !important;
        display: block !important;
        margin: 0.75rem auto !important;
        border-radius: 0.375rem !important;
      }
      
      /* 编辑器内所有iframe强制响应式 */
      #wang-editor-container .w-e-text iframe,
      #wang-editor-container iframe {
        max-width: 100% !important;
        width: 100% !important;
        height: 250px !important;
        min-height: 250px !important;
        display: block !important;
        margin: 0.75rem auto !important;
        border-radius: 0.375rem !important;
      }
      
      /* 编辑器内表格强制响应式 */
      #wang-editor-container .w-e-text table,
      #wang-editor-container table {
        width: 100% !important;
        max-width: 100% !important;
        display: block !important;
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
      }
      
      #wang-editor-container .w-e-text table td,
      #wang-editor-container table td,
      #wang-editor-container .w-e-text table th,
      #wang-editor-container table th {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        max-width: 100% !important;
      }
      
      /* 编辑器内所有div和容器强制响应式 */
      #wang-editor-container .w-e-text > div,
      #wang-editor-container .w-e-text > p,
      #wang-editor-container .w-e-text > section,
      #wang-editor-container .w-e-text > article {
        max-width: 100% !important;
        width: 100% !important;
        box-sizing: border-box !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
      }
      
      /* 编辑器内所有内联元素强制换行 */
      #wang-editor-container .w-e-text span,
      #wang-editor-container .w-e-text a {
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        max-width: 100% !important;
      }
      
      /* WangEditor中的图片和视频移动端优化 */
      #wang-editor-container img,
      #wang-editor-container .w-e-text img {
        max-width: 100% !important;
        width: auto !important;
        height: auto !important;
        display: block !important;
        margin: 0.75rem auto !important;
        border-radius: 0.375rem !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
      }
      
      #wang-editor-container video,
      #wang-editor-container .w-e-text video {
        max-width: 100% !important;
        width: 100% !important;
        height: auto !important;
        display: block !important;
        margin: 0.75rem auto !important;
        border-radius: 0.375rem !important;
      }
      
      /* 封面图容器移动端优化 */
      #coverImageContainer {
        width: 100% !important;
        max-width: 100% !important;
        aspect-ratio: 16/9 !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        border-radius: 0.5rem !important;
      }
      
      #coverImagePreview {
        width: 100% !important;
        height: 100% !important;
        object-fit: cover !important;
      }
      
      /* 所有输入框移动端优化 */
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="url"],
      input[type="password"],
      input[type="datetime-local"],
      textarea,
      select {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        font-size: 16px !important; /* 防止iOS自动缩放 */
        padding: 0.75rem !important;
        border-radius: 0.375rem !important;
        -webkit-appearance: none !important;
        -moz-appearance: none !important;
        appearance: none !important;
      }
      
      /* 标题输入框特殊优化 */
      #postName {
        font-size: 1.125rem !important;
        padding: 0.75rem 0 !important;
        width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 摘要输入框优化 */
      #postExcerpt {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        min-height: 100px !important;
        resize: vertical !important;
      }
      
      /* 图片URL输入框优化 */
      #postImage {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        margin-top: 0.75rem !important;
      }
      
      /* HTML编辑器容器优化 */
      #htmlEditorContainer {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0 !important;
        overflow-x: hidden !important;
      }
      
      #postHtmlContent {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: hidden !important;
      }
      
      /* 确保编辑器容器内的所有内容都不会溢出 */
      #htmlEditorContainer *,
      #postHtmlContent * {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
    }
    
    /* 超小屏幕 */
    @media (max-width: 480px) {
      #wang-editor-container iframe,
      #wang-editor-container .w-e-text iframe,
      .ql-video-block iframe,
      .video-block iframe {
        height: 200px !important;
        min-height: 200px;
        max-width: 100% !important;
        width: 100% !important;
      }
      
      #wang-editor-container {
        min-height: 250px !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        margin: 0 !important;
        padding: 0 !important;
      }
      
      #wang-editor-container {
        overflow-x: hidden !important;
      }
      
      #wang-editor-container .w-e-text {
        padding: 0.5rem !important;
        font-size: 16px !important; /* 防止iOS自动缩放 */
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: hidden !important;
      }
      
      /* 超小屏幕下编辑器内所有内容强制响应式 */
      #wang-editor-container .w-e-text * {
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
      
      /* 超小屏幕下编辑器内图片优化 */
      #wang-editor-container .w-e-text img,
      #wang-editor-container img {
        max-width: 100% !important;
        width: auto !important;
        height: auto !important;
        margin: 0.5rem auto !important;
      }
      
      /* 超小屏幕下编辑器内视频优化 */
      #wang-editor-container .w-e-text video,
      #wang-editor-container video {
        max-width: 100% !important;
        width: 100% !important;
        height: auto !important;
        margin: 0.5rem auto !important;
      }
      
      /* 超小屏幕下编辑器内iframe优化 */
      #wang-editor-container .w-e-text iframe,
      #wang-editor-container iframe {
        max-width: 100% !important;
        width: 100% !important;
        height: 200px !important;
        min-height: 200px !important;
        margin: 0.5rem auto !important;
      }
      
      #wang-editor-toolbar {
        padding: 0.375rem !important;
      }
      
      #wang-editor-toolbar .w-e-bar-item {
        padding: 0.25rem 0.375rem !important;
        font-size: 0.8125rem !important;
      }
      
      /* 编辑器内图片超小屏幕优化 */
      #wang-editor-container img,
      #wang-editor-container .w-e-text img {
        max-width: 100% !important;
        width: auto !important;
        height: auto !important;
        margin: 0.5rem auto !important;
      }
      
      /* 封面图容器超小屏幕优化 */
      #coverImageContainer {
        width: 100% !important;
        max-width: 100% !important;
        aspect-ratio: 16/9 !important;
        box-sizing: border-box !important;
        border-radius: 0.375rem !important;
      }
      
      /* 所有输入框超小屏幕优化 */
      input[type="text"],
      input[type="number"],
      input[type="email"],
      input[type="url"],
      input[type="password"],
      input[type="datetime-local"],
      textarea,
      select {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        font-size: 16px !important; /* 防止iOS自动缩放 */
        padding: 0.625rem !important;
      }
      
      /* 标题输入框超小屏幕优化 */
      #postName {
        font-size: 1rem !important;
        padding: 0.625rem 0 !important;
      }
      
      /* HTML编辑器容器超小屏幕优化 */
      #htmlEditorContainer {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
      }
    }
    
    /* SimpleMDE 工具栏样式修复 */
    .editor-toolbar {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem 0.375rem 0 0;
      background: #f9fafb;
      padding: 0.5rem;
    }
    
    .editor-toolbar a {
      color: #374151;
      border: 1px solid transparent;
      border-radius: 0.25rem;
      padding: 0.375rem 0.5rem;
      margin: 0 0.125rem;
      display: inline-block;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .editor-toolbar a:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      color: #111827;
    }
    
    .editor-toolbar a.active {
      background: #9333ea;
      color: white;
      border-color: #9333ea;
    }
    
    .editor-toolbar i.separator {
      display: inline-block;
      width: 0;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      color: transparent;
      text-indent: -10000px;
      margin: 0 0.5rem;
      height: 1.5rem;
    }
    
    .editor-toolbar a.fa {
      font-family: FontAwesome;
      font-style: normal;
      font-weight: normal;
      text-decoration: none;
    }
    
    .CodeMirror {
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.375rem 0.375rem;
      font-size: 0.875rem;
      min-height: 400px;
    }
    
    .editor-preview {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 1rem;
      background: white;
    }
    
    .editor-preview-side {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 1rem;
      background: white;
    }
    
    /* WangEditor全屏模式z-index优化 - 确保全屏时位于最顶层 */
    /* 覆盖所有可能的WangEditor全屏类名 */
    .w-e-full-screen-container,
    .w-e-full-screen,
    .w-e-fullscreen-container,
    .w-e-fullscreen,
    [class*="w-e"][class*="full-screen"],
    [class*="w-e"][class*="fullscreen"],
    [class*="full-screen"][class*="w-e"],
    [class*="fullscreen"][class*="w-e"] {
      z-index: 99999 !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: white !important;
      pointer-events: auto !important; /* 确保全屏容器本身可交互 */
    }
    
    /* 全屏模式下确保编辑器内容在最上层且可交互 */
    .w-e-full-screen-container *,
    .w-e-full-screen *,
    .w-e-fullscreen-container *,
    .w-e-fullscreen *,
    [class*="w-e"][class*="full-screen"] *,
    [class*="w-e"][class*="fullscreen"] * {
      pointer-events: auto !important; /* 确保编辑器内所有元素可交互 */
    }
    
    .w-e-full-screen-container .w-e-text-container,
    .w-e-full-screen .w-e-text-container,
    .w-e-fullscreen-container .w-e-text-container,
    .w-e-fullscreen .w-e-text-container {
      z-index: 100000 !important;
      pointer-events: auto !important;
    }
    
    /* 全屏模式下确保工具栏在最上层且可交互 */
    .w-e-full-screen-container .w-e-toolbar,
    .w-e-full-screen .w-e-toolbar,
    .w-e-fullscreen-container .w-e-toolbar,
    .w-e-fullscreen .w-e-toolbar,
    .w-e-full-screen-container .w-e-bar,
    .w-e-full-screen .w-e-bar,
    .w-e-fullscreen-container .w-e-bar,
    .w-e-fullscreen .w-e-bar {
      z-index: 100001 !important;
      pointer-events: auto !important;
    }
    
    /* 确保全屏模式下侧边栏和其他背景元素被遮挡且不可交互 */
    /* 只针对侧边栏等背景元素，不影响全屏编辑器 */
    body:has(.w-e-full-screen-container) .admin-card:not(.w-e-full-screen-container):not([class*="w-e"]),
    body:has(.w-e-full-screen-container) .admin-form > div:last-child:not(.w-e-full-screen-container):not([class*="w-e"]),
    body:has(.w-e-full-screen) .admin-card:not(.w-e-full-screen):not([class*="w-e"]),
    body:has(.w-e-full-screen) .admin-form > div:last-child:not(.w-e-full-screen):not([class*="w-e"]),
    body:has(.w-e-fullscreen-container) .admin-card:not(.w-e-fullscreen-container):not([class*="w-e"]),
    body:has(.w-e-fullscreen-container) .admin-form > div:last-child:not(.w-e-fullscreen-container):not([class*="w-e"]),
    body:has(.w-e-fullscreen) .admin-card:not(.w-e-fullscreen):not([class*="w-e"]),
    body:has(.w-e-fullscreen) .admin-form > div:last-child:not(.w-e-fullscreen):not([class*="w-e"]) {
      z-index: 1 !important;
      pointer-events: none !important; /* 只对背景元素禁用交互 */
    }
    
    /* 兼容性：使用属性选择器确保全屏模式 */
    [data-fullscreen="true"],
    [data-full-screen="true"],
    [class*="fullscreen"][class*="w-e"],
    [class*="full-screen"][class*="w-e"] {
      z-index: 99999 !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      bottom: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      background: white !important;
      pointer-events: auto !important;
    }
    
    /* 移动端和桌面端通用：确保全屏时所有其他元素都在下方 */
    @media (max-width: 768px) {
      .w-e-full-screen-container,
      .w-e-full-screen,
      .w-e-fullscreen-container,
      .w-e-fullscreen {
        z-index: 99999 !important;
        pointer-events: auto !important;
      }
      
      /* 移动端也确保编辑器内容可交互 */
      .w-e-full-screen-container *,
      .w-e-full-screen *,
      .w-e-fullscreen-container *,
      .w-e-fullscreen * {
        pointer-events: auto !important;
      }
      
      /* 移动端只对背景元素禁用交互 */
      body:has(.w-e-full-screen-container) .admin-card:not(.w-e-full-screen-container):not([class*="w-e"]),
      body:has(.w-e-full-screen-container) .admin-form:not(.w-e-full-screen-container):not([class*="w-e"]),
      body:has(.w-e-full-screen) .admin-card:not(.w-e-full-screen):not([class*="w-e"]),
      body:has(.w-e-full-screen) .admin-form:not(.w-e-full-screen):not([class*="w-e"]),
      body:has(.w-e-fullscreen-container) .admin-card:not(.w-e-fullscreen-container):not([class*="w-e"]),
      body:has(.w-e-fullscreen-container) .admin-form:not(.w-e-fullscreen-container):not([class*="w-e"]),
      body:has(.w-e-fullscreen) .admin-card:not(.w-e-fullscreen):not([class*="w-e"]),
      body:has(.w-e-fullscreen) .admin-form:not(.w-e-fullscreen):not([class*="w-e"]) {
        z-index: 1 !important;
        pointer-events: none !important;
      }
    }
  </style>
  <!-- WangEditor v5 (使用jsdelivr CDN以符合CSP策略) -->
  <link href="https://cdn.jsdelivr.net/npm/@wangeditor/editor@5.1.23/dist/css/style.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@wangeditor/editor@5.1.23/dist/index.js"></script>
</head>
<body class="blog-page">
  <!-- 登录页面 -->
  <div id="loginPage" style="display: none; min-height: 100vh; align-items: center; justify-content: center; background: #F9FAFB;">
    <div style="max-width: 400px; width: 100%; padding: 2rem; background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <div style="text-align: center; margin-bottom: 2rem;">
        <h2 style="font-size: 1.5rem; font-weight: bold; color: #111827; margin-bottom: 0.5rem;">博客管理登录</h2>
        <p style="color: #6b7280; font-size: 0.875rem;">请输入管理员账号和密码</p>
      </div>
      <form id="loginForm" onsubmit="handleLogin(event)" style="space-y: 1.5rem;">
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">用户名</label>
          <input type="text" id="loginUsername" required
                 style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; font-size: 1rem; box-sizing: border-box;"
                 placeholder="请输入用户名">
        </div>
        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.5rem;">密码</label>
          <input type="password" id="loginPassword" required
                 style="width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.375rem; font-size: 1rem; box-sizing: border-box;"
                 placeholder="请输入密码">
        </div>
        <button type="submit" 
                style="width: 100%; padding: 0.75rem; background-color: #9333ea; color: white; border: none; border-radius: 0.375rem; font-weight: 500; font-size: 1rem; cursor: pointer; transition: background-color 0.2s;"
                onmouseover="this.style.backgroundColor='#7e22ce'" 
                onmouseout="this.style.backgroundColor='#9333ea'">
          登录
        </button>
      </form>
      <div id="loginError" style="display: none; margin-top: 1rem; padding: 0.75rem; background: #FEE2E2; border: 1px solid #FECACA; border-radius: 0.375rem; color: #991B1B; font-size: 0.875rem;"></div>
    </div>
  </div>

  <!-- 主内容区域 -->
  <div id="mainContent" class="admin-container" style="display: none;">
    <div class="admin-header">
      <div>
        <h1 style="font-size: 2rem; font-weight: bold; color: #111827;">
          博客管理
        </h1>
        <p style="color: #6b7280; margin-top: 0.5rem;">管理文章、分类和评论</p>
      </div>
      <div style="display: flex; gap: 1rem; align-items: center;">
        <span id="adminNameDisplay" style="color: #6b7280; font-size: 0.875rem;"></span>
        <button onclick="handleLogout()" class="blog-btn blog-btn-secondary" style="padding: 0.5rem 1rem;">退出登录</button>
        <a href="/blog.html" class="blog-btn blog-btn-secondary">返回博客</a>
      </div>
    </div>

    <!-- 标签页 -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('posts', this)">文章</button>
      <button class="admin-tab" onclick="switchTab('categories', this)">分类</button>
      <button class="admin-tab" onclick="switchTab('comments', this)">评论</button>
      <button class="admin-tab" onclick="switchTab('weather', this)">天气</button>
      <button class="admin-tab" onclick="switchTab('exchange-rate', this)">汇率</button>
      <button class="admin-tab" onclick="switchTab('translation', this)">翻译</button>
    </div>

    <!-- 文章管理 -->
    <div id="tab-posts" class="admin-tab-content active">
      <div class="admin-card-header" style="justify-content: flex-start; gap: 1rem; flex-wrap: wrap;">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0;">文章管理</h2>
        <button class="blog-btn blog-btn-primary" onclick="openNewPostInNewWindow(); return false;" style="background-color: #9333ea; border-color: #9333ea;">+ 新建文章</button>
        <!-- 批量操作区域 -->
        <div id="batchActions" style="display: none; gap: 0.5rem; align-items: center; margin-left: auto;">
          <span id="selectedCount" style="color: #6b7280; font-size: 0.875rem;">已选择 <strong id="selectedCountNum">0</strong> 篇</span>
          <button class="blog-btn blog-btn-secondary" onclick="selectAllDrafts()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">全选草稿</button>
          <button class="blog-btn blog-btn-primary" onclick="batchPublish()" style="padding: 0.5rem 1rem; font-size: 0.875rem; background-color: #10b981; border-color: #10b981;">批量发布</button>
          <button class="blog-btn blog-btn-secondary" onclick="clearSelection()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">取消选择</button>
        </div>
      </div>
      
      <!-- 搜索和展开控制栏 -->
      <div style="padding: 1rem; background: white; border-radius: 0.5rem; margin-bottom: 1rem; border: 1px solid #e5e7eb; display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <!-- 搜索框 -->
        <div style="flex: 1; min-width: 250px; position: relative;">
          <div style="position: relative;">
            <input 
              type="text" 
              id="postsSearchInput" 
              placeholder="搜索文章标题..." 
              style="width: 100%; padding: 0.625rem 2.5rem 0.625rem 2.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; transition: all 0.2s;"
              oninput="handlePostsSearch(this.value)"
              onkeydown="if(event.key === 'Enter') event.preventDefault()"
            >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none;">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <button 
              type="button" 
              id="clearSearchBtn" 
              onclick="clearPostsSearch()" 
              style="display: none; position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: 0.25rem; color: #9ca3af; transition: color 0.2s;"
              onmouseover="this.style.color='#ef4444'"
              onmouseout="this.style.color='#9ca3af'"
              title="清除搜索"
            >
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- 展开/折叠控制 -->
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button 
            class="blog-btn blog-btn-secondary" 
            onclick="expandAllCategories()" 
            id="expandAllBtn"
            style="padding: 0.625rem 1rem; font-size: 0.875rem; white-space: nowrap;"
            title="展开所有分类"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 0.25rem;">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
            展开全部
          </button>
          <button 
            class="blog-btn blog-btn-secondary" 
            onclick="collapseAllCategories()" 
            id="collapseAllBtn"
            style="padding: 0.625rem 1rem; font-size: 0.875rem; white-space: nowrap;"
            title="折叠所有分类"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 0.25rem;">
              <polyline points="18 15 12 9 6 15"></polyline>
            </svg>
            折叠全部
          </button>
        </div>
        
        <!-- 状态筛选 -->
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <select 
            id="statusFilterSelect" 
            onchange="handleStatusFilter(this.value)"
            style="padding: 0.625rem 2rem 0.625rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; background: white; cursor: pointer; appearance: none; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 24 24\' fill=\'none\' stroke=\'%236b7280\' stroke-width=\'2\'><polyline points=\'6 9 12 15 18 9\'></polyline></svg>'); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 16px;"
          >
            <option value="">全部状态</option>
            <option value="published">已发布</option>
            <option value="draft">草稿</option>
          </select>
        </div>
      </div>

      <!-- 文章表单 -->
      <div id="postForm" class="admin-form" style="display: none;">
        <!-- 加载提示 -->
        <div id="postFormLoading" class="post-form-loading" style="display: none;">
          <div class="loading-spinner"></div>
          <p class="loading-text">正在加载文章内容...</p>
          <div style="width: 100%; max-width: 400px; margin: 1rem auto 0;">
            <div style="height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
              <div id="postFormLoadingProgressBar" style="height: 100%; background: linear-gradient(90deg, #9333ea, #a855f7); width: 0%; transition: width 0.3s ease; border-radius: 2px;"></div>
            </div>
          </div>
        </div>
        <!-- 表单内容 -->
        <div id="postFormContent">
        <!-- 顶部栏：标题和操作按钮 -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb;">
          <h3 id="postFormTitle" style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #111827;">新建文章</h3>
          <div style="display: flex; gap: 0.75rem;">
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hidePostForm()" style="padding: 0.5rem 1rem;">取消</button>
            <button type="submit" form="postFormElement" class="blog-btn blog-btn-primary" style="padding: 0.5rem 1.5rem; background-color: #9333ea; border-color: #9333ea;">保存</button>
          </div>
        </div>
        
        <form id="postFormElement" onsubmit="savePost(event)">
          <input type="hidden" id="postId">
          
          <!-- 左右分栏布局 -->
          <div style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem; align-items: start;">
            
            <!-- 左侧主内容区 (70%) -->
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
              <!-- 文章标题 -->
              <div class="admin-form-group" style="margin-bottom: 0;">
                <input type="text" id="postName" class="admin-form-input" required oninput="syncNameAndTitle()" placeholder="输入文章标题..." style="font-size: 1.25rem; font-weight: 600; padding: 0.75rem 0; border: none; border-bottom: 2px solid #e5e7eb; border-radius: 0; background: transparent;">
                <p style="color: #9ca3af; font-size: 0.75rem; margin-top: 0.25rem; margin-bottom: 0;">名称和标题会自动保持同步</p>
              </div>
              
              <!-- 摘要 -->
              <div class="admin-form-group" style="margin-bottom: 0;">
                <label class="admin-form-label" for="postExcerpt" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">摘要</label>
                <textarea id="postExcerpt" class="admin-form-input" rows="3" placeholder="输入文章摘要..." style="padding: 0.75rem; font-size: 0.9375rem; resize: vertical;"></textarea>
              </div>
              
              <!-- 字段映射提示 -->
              <div class="admin-form-group" id="fieldMappingInfo" style="display: none; margin-bottom: 0;">
                <div style="padding: 0.75rem; background: #eff6ff; border-left: 4px solid #3b82f6; border-radius: 0.375rem;">
                  <p style="margin: 0; font-size: 0.875rem; color: #1e40af;">此API已配置字段映射，文章将根据映射规则保存到对应字段</p>
                </div>
              </div>
          
          <!-- 特殊类别定制化表单 -->
          <!-- 翻译卡片 (translation) -->
          <div id="specialForm-translation" class="admin-form-group" style="display: none;">
            <h4 style="color: #9333ea; margin-bottom: 1rem;">翻译卡片编辑</h4>
            <div class="admin-form-group" style="max-width: 500px;">
              <label class="admin-form-label" for="translationChinese">中文 *</label>
              <input type="text" id="translationChinese" class="admin-form-input" placeholder="输入中文" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 500px;">
              <label class="admin-form-label" for="translationArabic">阿拉伯文 *</label>
              <input type="text" id="translationArabic" class="admin-form-input" placeholder="输入阿拉伯文" dir="rtl" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="translationCategory">分类</label>
              <input type="text" id="translationCategory" class="admin-form-input" placeholder="如：问候、礼貌、购物等" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- 天气路况 (weather) -->
          <div id="specialForm-weather" class="admin-form-group" style="display: none;">
            <h4 style="color: #3b82f6; margin-bottom: 1rem;">天气路况编辑</h4>
            
            <!-- Global Alert 全局预警 -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <h5 style="color: #3b82f6; margin-bottom: 0.75rem;">全局预警 (Global Alert)</h5>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="weatherGlobalAlertLevel">预警级别</label>
              <select id="weatherGlobalAlertLevel" class="admin-form-select" style="width: 100%; max-width: 100%; box-sizing: border-box;">
                <option value="low">低 (low)</option>
                <option value="medium">中 (medium)</option>
                <option value="high">高 (high)</option>
              </select>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="weatherGlobalAlertMessage">预警消息 *</label>
              <textarea id="weatherGlobalAlertMessage" class="admin-form-input" rows="3" placeholder="输入预警消息" style="width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
            </div>
            </div>
            
            <!-- Attractions 景点天气 -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #3b82f6; margin: 0;">景点天气 (Attractions)</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addWeatherAttraction()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>添加景点
                </button>
              </div>
              <div id="weatherAttractionsList"></div>
            </div>
            
            <!-- Traffic 路况信息 -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #3b82f6; margin: 0;">路况信息 (Traffic)</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addWeatherTraffic()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>添加路况
                </button>
              </div>
              <div id="weatherTrafficList"></div>
            </div>
          </div>
          
          <!-- 汇率转换 (exchange-rate) -->
          <div id="specialForm-exchange-rate" class="admin-form-group" style="display: none;">
            <h4 style="color: #10b981; margin-bottom: 1rem;">汇率转换编辑</h4>
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #10b981; margin: 0;">汇率列表</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addExchangeRate()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>添加汇率
                </button>
              </div>
              <div id="exchangeRatesList"></div>
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="exchangeUpdateTime">更新时间</label>
              <input type="datetime-local" id="exchangeUpdateTime" class="admin-form-input" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- 二手市场 (second-hand) 特殊字段 -->
          <div id="specialForm-second-hand" class="admin-form-group" style="display: none;">
            <h4 style="color: #f59e0b; margin-bottom: 1rem;">二手市场特殊字段</h4>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="secondHandPrice">价格 *</label>
              <input type="text" id="secondHandPrice" class="admin-form-input" placeholder="如：500、1000等" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="secondHandPhone">联系方式 *</label>
              <input type="text" id="secondHandPhone" name="secondHandPhone" class="admin-form-input" placeholder="如：+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="secondHandAddress">地址 *</label>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="secondHandAddress" name="secondHandAddress" class="admin-form-input" placeholder="如：开罗市中心，Heliopolis 区" style="flex: 1; width: 100%; max-width: 100%; box-sizing: border-box;" required>
                <button type="button" id="secondHandAddressSearchBtn" class="blog-btn blog-btn-secondary" onclick="openMapPicker('second-hand')" style="white-space: nowrap; padding: 0.75rem 1rem;">
                  <span style="margin-right: 0.25rem;">🗺️</span>地图选点
                </button>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="openLinkParser('second-hand')" style="white-space: nowrap; padding: 0.75rem 1rem;" title="粘贴谷歌地图链接自动解析">
                  <span style="margin-right: 0.25rem;">🔗</span>解析链接
                </button>
              </div>
              <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">点击"地图选点"在地图上选择位置，或点击"解析链接"粘贴谷歌地图链接自动获取位置</p>
            </div>
            <details style="margin-top: 0.5rem;">
              <summary style="cursor: pointer; font-size: 0.8125rem; color: #6b7280; padding: 0.5rem; border-radius: 0.375rem; background: #f9fafb; user-select: none;">高级位置信息（经纬度）</summary>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem;">
                <div class="admin-form-group" style="margin-bottom: 0;">
                  <label class="admin-form-label" for="secondHandLatitude" style="font-size: 0.75rem; margin-bottom: 0.25rem;">纬度 *</label>
                  <input type="number" step="any" id="secondHandLatitude" name="secondHandLatitude" class="admin-form-input" placeholder="如：30.0444" style="padding: 0.5rem; font-size: 0.875rem;" required>
                </div>
                <div class="admin-form-group" style="margin-bottom: 0;">
                  <label class="admin-form-label" for="secondHandLongitude" style="font-size: 0.75rem; margin-bottom: 0.25rem;">经度 *</label>
                  <input type="number" step="any" id="secondHandLongitude" name="secondHandLongitude" class="admin-form-input" placeholder="如：31.2357" style="padding: 0.5rem; font-size: 0.875rem;" required>
                </div>
              </div>
            </details>
          </div>
          
          <!-- 租房酒店 (rentals) 特殊字段 -->
          <div id="specialForm-rentals" class="admin-form-group" style="display: none;">
            <h4 style="color: #8b5cf6; margin-bottom: 1rem;">租房酒店特殊字段</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; width: 100%; max-width: 100%; box-sizing: border-box;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsPrice">价格 *</label>
                <input type="text" id="rentalsPrice" class="admin-form-input" placeholder="如：3500" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsRooms">房间数 *</label>
                <input type="text" id="rentalsRooms" class="admin-form-input" placeholder="如：2" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsArea">面积 *</label>
                <input type="text" id="rentalsArea" class="admin-form-input" placeholder="如：80" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsViews">浏览次数</label>
                <input type="number" id="rentalsViews" class="admin-form-input" placeholder="如：1" min="0" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="rentalsPhone">联系方式 *</label>
              <input type="text" id="rentalsPhone" name="rentalsPhone" class="admin-form-input" placeholder="如：+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="rentalsAddress">地址 *</label>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="rentalsAddress" name="rentalsAddress" class="admin-form-input" placeholder="如：开罗市中心，Heliopolis 区" style="flex: 1; width: 100%; max-width: 100%; box-sizing: border-box;" required>
                <button type="button" id="rentalsAddressSearchBtn" class="blog-btn blog-btn-secondary" onclick="openMapPicker('rentals')" style="white-space: nowrap; padding: 0.75rem 1rem;">
                  <span style="margin-right: 0.25rem;">🗺️</span>地图选点
                </button>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="openLinkParser('rentals')" style="white-space: nowrap; padding: 0.75rem 1rem;" title="粘贴谷歌地图链接自动解析">
                  <span style="margin-right: 0.25rem;">🔗</span>解析链接
                </button>
              </div>
              <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">点击"地图选点"在地图上选择位置，或点击"解析链接"粘贴谷歌地图链接自动获取位置</p>
            </div>
            <details style="margin-top: 0.5rem;">
              <summary style="cursor: pointer; font-size: 0.8125rem; color: #6b7280; padding: 0.5rem; border-radius: 0.375rem; background: #f9fafb; user-select: none;">高级位置信息（经纬度）</summary>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem;">
                <div class="admin-form-group" style="margin-bottom: 0;">
                  <label class="admin-form-label" for="rentalsLatitude" style="font-size: 0.75rem; margin-bottom: 0.25rem;">纬度 *</label>
                  <input type="number" step="any" id="rentalsLatitude" name="rentalsLatitude" class="admin-form-input" placeholder="如：30.0444" style="padding: 0.5rem; font-size: 0.875rem;" required>
                </div>
                <div class="admin-form-group" style="margin-bottom: 0;">
                  <label class="admin-form-label" for="rentalsLongitude" style="font-size: 0.75rem; margin-bottom: 0.25rem;">经度 *</label>
                  <input type="number" step="any" id="rentalsLongitude" name="rentalsLongitude" class="admin-form-input" placeholder="如：31.2357" style="padding: 0.5rem; font-size: 0.875rem;" required>
                </div>
              </div>
            </details>
          </div>
          
          <!-- 通用位置字段（用于其他需要位置的分类） -->
          <div id="commonLocationFields" class="admin-form-group" style="display: none;">
            <h4 style="color: #059669; margin-bottom: 1rem;">位置信息</h4>
            <div class="admin-form-group" id="commonPhoneField" style="max-width: 300px; display: none;">
              <label class="admin-form-label" id="commonPhoneLabel" for="commonPhone">联系方式 *</label>
              <input type="text" id="commonPhone" name="commonPhone" class="admin-form-input" placeholder="如：+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" id="commonAddressLabel" for="commonAddress">地址 *</label>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="commonAddress" name="commonAddress" class="admin-form-input" placeholder="如：开罗市中心，Heliopolis 区" style="flex: 1; width: 100%; max-width: 100%; box-sizing: border-box;" required>
                <button type="button" id="commonAddressSearchBtn" class="blog-btn blog-btn-secondary" onclick="openMapPicker('common')" style="white-space: nowrap; padding: 0.75rem 1rem;">
                  <span style="margin-right: 0.25rem;">🗺️</span>地图选点
                </button>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="openLinkParser('common')" style="white-space: nowrap; padding: 0.75rem 1rem;" title="粘贴谷歌地图链接自动解析">
                  <span style="margin-right: 0.25rem;">🔗</span>解析链接
                </button>
              </div>
              <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">点击"地图选点"在地图上选择位置，或点击"解析链接"粘贴谷歌地图链接自动获取位置</p>
            </div>
            <!-- 折叠的经纬度信息 -->
            <details style="margin-top: 0.5rem;">
              <summary style="cursor: pointer; font-size: 0.8125rem; color: #6b7280; padding: 0.5rem; border-radius: 0.375rem; background: #f9fafb; user-select: none;">高级位置信息（经纬度）</summary>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem;">
                <div class="admin-form-group" style="margin-bottom: 0;">
                  <label class="admin-form-label" id="commonLatitudeLabel" for="commonLatitude" style="font-size: 0.75rem; margin-bottom: 0.25rem;">纬度 *</label>
                  <input type="number" step="any" id="commonLatitude" name="commonLatitude" class="admin-form-input" placeholder="如：30.0444" style="padding: 0.5rem; font-size: 0.875rem;" required>
                </div>
                <div class="admin-form-group" style="margin-bottom: 0;">
                  <label class="admin-form-label" id="commonLongitudeLabel" for="commonLongitude" style="font-size: 0.75rem; margin-bottom: 0.25rem;">经度 *</label>
                  <input type="number" step="any" id="commonLongitude" name="commonLongitude" class="admin-form-input" placeholder="如：31.2357" style="padding: 0.5rem; font-size: 0.875rem;" required>
                </div>
              </div>
            </details>
          </div>
              <!-- 内容编辑器 -->
              <div class="admin-form-group" id="normalContentEditor" style="margin-bottom: 0;">
                <label class="admin-form-label" for="postContent" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">内容 *</label>
                <div id="htmlEditorContainer">
                  <div id="postHtmlContent" style="min-height: 500px;"></div>
                </div>
              </div>
            </div>
            
            <!-- 右侧边栏 (30%) -->
            <div style="display: flex; flex-direction: column; gap: 1.5rem; position: sticky; top: 1rem;">
              <!-- 封面图卡片 -->
              <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <label class="admin-form-label" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.75rem; display: block;">封面图</label>
                <div id="coverImageContainer" style="position: relative; width: 100%; aspect-ratio: 16/9; background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 0.5rem; overflow: hidden; cursor: pointer; transition: all 0.3s;" onclick="document.getElementById('imageUploadInput').click()">
                  <div id="coverImagePlaceholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9ca3af;">
                    <i class="fa fa-image" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                    <span style="font-size: 0.875rem;">点击上传封面图</span>
                  </div>
                  <img id="coverImagePreview" src="" alt="封面预览" style="display: none; width: 100%; height: 100%; object-fit: cover;">
                  <div id="coverImageOverlay" style="display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; color: white; font-size: 0.875rem;">
                    <span>点击更换</span>
                  </div>
                </div>
                <input type="text" id="postImage" class="admin-form-input" placeholder="或输入图片URL" style="margin-top: 0.75rem; padding: 0.5rem; font-size: 0.875rem;" oninput="updateCoverImagePreview(this.value)">
                <input type="file" id="imageUploadInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <div id="imageUploadProgress" style="display: none; margin-top: 0.5rem;">
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <div style="flex: 1; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                      <div id="imageUploadProgressBar" style="height: 100%; background: #9333ea; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <span id="imageUploadStatus" style="font-size: 0.75rem; color: #6b7280;">上传中...</span>
                  </div>
                </div>
              </div>
              
              <!-- 基本信息卡片 -->
              <div style="background: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                <h4 style="font-size: 0.875rem; font-weight: 600; color: #374151; margin: 0 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 1px solid #e5e7eb;">基本信息</h4>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                  <div class="admin-form-group" style="margin-bottom: 0;">
                    <label class="admin-form-label" for="postSlug" style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.375rem;">Slug</label>
                    <input type="text" id="postSlug" class="admin-form-input" placeholder="留空自动生成" style="padding: 0.5rem; font-size: 0.875rem;">
                  </div>
                  <div class="admin-form-group" style="margin-bottom: 0;">
                    <label class="admin-form-label" for="postApiName" style="font-size: 0.8125rem; color: #6b7280; margin-bottom: 0.375rem;">API/分类 *</label>
                    <select id="postApiName" class="admin-form-select" required onchange="onApiNameChange()" style="padding: 0.5rem; font-size: 0.875rem;">
                      <option value="">请选择API（分类）</option>
                    </select>
                  </div>
                  <div class="admin-form-group" style="margin-bottom: 0;">
                    <div class="admin-form-checkbox" style="display: flex; align-items: center; gap: 0.5rem;">
                      <input type="checkbox" id="postPublished" style="width: 18px; height: 18px; cursor: pointer;">
                      <label for="postPublished" style="margin: 0; font-size: 0.875rem; color: #374151; cursor: pointer;">发布</label>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 特殊类别表单将动态插入到这里 -->
              <div id="specialCategorySidebar"></div>
            </div>
          </div>
        </form>
        </div>
      </div>

      <!-- 文章列表 -->
      <div class="admin-card">
        <!-- 加载进度条 - 可爱动画版 -->
        <div id="postsLoadingProgress" style="display: none; padding: 2rem; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-bottom: 1px solid #e5e7eb;">
          <div style="display: flex; flex-direction: column; align-items: center; gap: 1rem;">
            <!-- 可爱的表情符号动画 -->
            <div id="loadingEmoji" style="font-size: 3rem; animation: bounce 1s ease-in-out infinite; filter: drop-shadow(0 2px 4px rgba(147, 51, 234, 0.2));">📝✨</div>
            
            <!-- 有趣的加载提示文字 -->
            <div id="loadingText" style="font-size: 1rem; color: #6b7280; font-weight: 500; text-align: center; min-height: 1.5rem;">
              正在加载文章列表...
            </div>
            
            <!-- 进度条 -->
            <div style="width: 100%; max-width: 400px;">
              <div style="height: 6px; background: #e5e7eb; border-radius: 10px; overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);">
                <div id="postsLoadingProgressBar" style="height: 100%; background: linear-gradient(90deg, #9333ea, #a855f7, #ec4899); width: 0%; transition: width 0.3s ease; border-radius: 10px; box-shadow: 0 0 10px rgba(147, 51, 234, 0.5); position: relative; overflow: hidden;">
                  <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 1.5s infinite;"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 桌面端表格 -->
        <div style="overflow-x: auto; width: 100%; max-width: 100%; box-sizing: border-box; -webkit-overflow-scrolling: touch;" class="desktop-table-container">
          <table class="admin-table">
          <thead>
            <tr>
              <th style="min-width: 40px; width: 40px;">
                <input type="checkbox" id="selectAllPosts" onchange="toggleSelectAll(this)" style="width: 18px; height: 18px; cursor: pointer;" title="全选">
              </th>
              <th style="min-width: 200px;">标题</th>
              <th style="min-width: 80px;">分类</th>
              <th style="min-width: 80px;">状态</th>
              <th style="min-width: 90px;">阅读量</th>
              <th style="min-width: 110px;">日期</th>
              <th style="min-width: 140px;">操作</th>
            </tr>
          </thead>
          <tbody id="postsTableBody">
            <tr><td colspan="7" class="blog-loading">加载中...</td></tr>
          </tbody>
          </table>
        </div>
        
        <!-- 移动端卡片列表 -->
        <div id="postsTableBodyMobile" style="display: none;">
          <div class="blog-loading" style="padding: 2rem; text-align: center;">加载中...</div>
        </div>
      </div>
    </div>

    <!-- 分类管理 -->
    <div id="tab-categories" class="admin-tab-content">
      <div class="admin-card-header">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0;">分类管理</h2>
        <button class="blog-btn blog-btn-primary" onclick="showCategoryForm()" style="background-color: #9333ea; border-color: #9333ea;">+ 新建分类</button>
      </div>

      <div id="categoryForm" class="admin-form" style="display: none;">
        <h3 id="categoryFormTitle">新建分类</h3>
        <form id="categoryFormElement" onsubmit="saveCategory(event)">
          <input type="hidden" id="categoryId">
          <div class="admin-form-group">
            <label class="admin-form-label" for="categoryName">分类名称 *</label>
            <input type="text" id="categoryName" class="admin-form-input" required>
            <p class="text-xs text-gray-500 mt-1">此名称将显示在博客分类列表中</p>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="categoryPath">分类路径/描述 *</label>
            <input type="text" id="categoryPath" class="admin-form-input" required placeholder="/category-name">
            <p class="text-xs text-gray-500 mt-1">路径必须以 / 开头，将作为分类的描述信息</p>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">保存</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hideCategoryForm()">取消</button>
          </div>
        </form>
      </div>

      <div class="admin-card">
        <!-- 桌面端表格 -->
        <div class="categories-table-desktop" style="overflow-x: auto; width: 100%; max-width: 100%; box-sizing: border-box; -webkit-overflow-scrolling: touch;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>名称</th>
                <th>路径/描述</th>
                <th>文章数</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="categoriesTableBody">
              <tr><td colspan="4" class="blog-loading">加载中...</td></tr>
            </tbody>
          </table>
        </div>
        <!-- 移动端卡片 -->
        <div id="categoriesTableMobile" class="categories-table-mobile" style="display: none;">
          <div class="blog-loading" style="padding: 2rem; text-align: center;">加载中...</div>
        </div>
      </div>
    </div>

    <!-- 评论管理 -->
    <div id="tab-comments" class="admin-tab-content">
      <div class="admin-card-header">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0;">评论管理</h2>
      </div>
      <div class="admin-card">
        <!-- 桌面端表格 -->
        <div class="comments-table-desktop" style="overflow-x: auto; width: 100%; max-width: 100%; box-sizing: border-box; -webkit-overflow-scrolling: touch;">
          <table class="admin-table">
            <thead>
              <tr>
                <th>文章</th>
                <th>作者</th>
                <th>内容</th>
                <th>状态</th>
                <th>日期</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="commentsTableBody">
              <tr><td colspan="6" class="blog-loading">加载中...</td></tr>
            </tbody>
          </table>
        </div>
        <!-- 移动端卡片 -->
        <div id="commentsTableMobile" class="comments-table-mobile" style="display: none;">
          <div class="blog-loading" style="padding: 2rem; text-align: center;">加载中...</div>
        </div>
      </div>
    </div>

    <!-- 天气管理 -->
    <div id="tab-weather" class="admin-tab-content">
      <div class="admin-card-header" style="justify-content: flex-start; gap: 1rem; flex-wrap: wrap;">
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0;">天气路况管理</h2>
        <span id="weatherLastUpdate" style="color: #6b7280; font-size: 0.875rem; margin-left: auto; align-self: center;"></span>
        <button class="blog-btn blog-btn-secondary" onclick="showWeatherEditForm()" id="weatherEditBtn" style="background-color: #9333ea; border-color: #9333ea;">编辑</button>
        <button class="blog-btn blog-btn-secondary" onclick="hideWeatherEditForm()" id="weatherCancelBtn" style="display: none;">取消</button>
      </div>
      
      <!-- 编辑表单 -->
      <div id="weatherEditForm" class="admin-form" style="display: none;">
        <form id="weatherFormElement" onsubmit="saveWeatherContent(event)">
          <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <!-- 全局预警 -->
            <div style="padding: 1.5rem; background: #f9fafb; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
              <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 1rem;">全局预警</h3>
              <div style="display: grid; gap: 1rem;">
                <div class="admin-form-group">
                  <label class="admin-form-label" for="weatherGlobalAlertLevel">预警级别 *</label>
                  <select id="weatherGlobalAlertLevel" class="admin-form-select" required>
                    <option value="low">低</option>
                    <option value="medium" selected>中</option>
                    <option value="high">高</option>
                  </select>
                </div>
                <div class="admin-form-group">
                  <label class="admin-form-label" for="weatherGlobalAlertMessage">预警消息 *</label>
                  <textarea id="weatherGlobalAlertMessage" class="admin-form-input" rows="3" required placeholder="输入预警消息..."></textarea>
                </div>
              </div>
            </div>
            
            <!-- 景点信息 -->
            <div style="padding: 1.5rem; background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin: 0;">景点信息</h3>
                <button type="button" class="blog-btn blog-btn-primary" onclick="addWeatherAttraction()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">+ 添加景点</button>
              </div>
              <div id="weatherAttractionsList"></div>
            </div>
            
            <!-- 交通信息 -->
            <div style="padding: 1.5rem; background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin: 0;">交通信息</h3>
                <button type="button" class="blog-btn blog-btn-primary" onclick="addWeatherTraffic()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">+ 添加路况</button>
              </div>
              <div id="weatherTrafficList"></div>
            </div>
            
            <!-- 操作按钮 -->
            <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
              <button type="submit" class="blog-btn blog-btn-primary" style="padding: 0.75rem 1.5rem;">保存</button>
              <button type="button" class="blog-btn blog-btn-secondary" onclick="hideWeatherEditForm()">取消</button>
            </div>
          </div>
        </form>
      </div>
      
      <!-- 显示内容 -->
      <div class="admin-card">
        <div id="weatherContent" class="blog-loading" style="padding: 2rem; text-align: center;">加载中...</div>
      </div>
    </div>

    <!-- 汇率管理 -->
    <div id="tab-exchange-rate" class="admin-tab-content">
      <div class="admin-card-header" style="justify-content: flex-start; gap: 1rem; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 0;">
          <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0 0 0.25rem 0;">汇率转换管理</h2>
          <span id="exchangeRateLastUpdate" style="color: #6b7280; font-size: 0.875rem;"></span>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
          <button class="blog-btn blog-btn-secondary" onclick="showExchangeRateEditForm()" id="exchangeRateEditBtn" style="background-color: #10b981; border-color: #10b981;">编辑</button>
          <button class="blog-btn blog-btn-secondary" onclick="hideExchangeRateEditForm()" id="exchangeRateCancelBtn" style="display: none;">取消</button>
        </div>
      </div>
      
      <!-- 编辑表单 -->
      <div id="exchangeRateEditForm" class="admin-form" style="display: none;">
        <form id="exchangeRateFormElement" onsubmit="saveExchangeRateContent(event)">
          <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <!-- 汇率列表 -->
            <div style="padding: 1.5rem; background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin: 0;">汇率列表</h3>
                <button type="button" class="blog-btn blog-btn-primary" onclick="addExchangeRate()" style="padding: 0.5rem 1rem; font-size: 0.875rem; background-color: #10b981; border-color: #10b981;">+ 添加汇率</button>
              </div>
              <div id="exchangeRatesList"></div>
            </div>
            
            <!-- 更新时间 -->
            <div class="admin-form-group">
              <label class="admin-form-label" for="exchangeUpdateTime">更新时间</label>
              <input type="datetime-local" id="exchangeUpdateTime" class="admin-form-input">
            </div>
            
            <!-- 操作按钮 -->
            <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
              <button type="submit" class="blog-btn blog-btn-primary" style="padding: 0.75rem 1.5rem; background-color: #10b981; border-color: #10b981;">保存</button>
              <button type="button" class="blog-btn blog-btn-secondary" onclick="hideExchangeRateEditForm()">取消</button>
            </div>
          </div>
        </form>
      </div>
      
      <!-- 显示内容 -->
      <div class="admin-card">
        <div id="exchangeRateContent" class="blog-loading" style="padding: 2rem; text-align: center;">加载中...</div>
      </div>
    </div>

    <!-- 翻译管理 -->
    <div id="tab-translation" class="admin-tab-content">
      <div class="admin-card-header" style="justify-content: flex-start; gap: 1rem; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 0;">
          <h2 style="font-size: 1.5rem; font-weight: 600; color: #111827; margin: 0 0 0.25rem 0;">翻译卡片管理</h2>
          <span id="translationLastUpdate" style="color: #6b7280; font-size: 0.875rem;"></span>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
          <button class="blog-btn blog-btn-secondary" onclick="showTranslationEditForm()" id="translationEditBtn" style="background-color: #9333ea; border-color: #9333ea;">编辑</button>
          <button class="blog-btn blog-btn-secondary" onclick="hideTranslationEditForm()" id="translationCancelBtn" style="display: none;">取消</button>
        </div>
      </div>
      
      <!-- 编辑表单 -->
      <div id="translationEditForm" class="admin-form" style="display: none;">
        <form id="translationFormElement" onsubmit="saveTranslationContent(event)">
          <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            <!-- 翻译列表 -->
            <div style="padding: 1.5rem; background: white; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin: 0;">翻译列表</h3>
                <button type="button" class="blog-btn blog-btn-primary" onclick="addTranslationItem()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">+ 添加翻译</button>
              </div>
              <div id="translationList"></div>
            </div>
            
            <!-- 操作按钮 -->
            <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
              <button type="submit" class="blog-btn blog-btn-primary" style="padding: 0.75rem 1.5rem;">保存</button>
              <button type="button" class="blog-btn blog-btn-secondary" onclick="hideTranslationEditForm()">取消</button>
            </div>
          </div>
        </form>
      </div>
      
      <!-- 显示内容 -->
      <div class="admin-card">
        <div id="translationContent" class="blog-loading" style="padding: 2rem; text-align: center;">加载中...</div>
      </div>
    </div>
  </div>
  
  
  <style>
    /* FAB按钮响应式 - 只在移动端和平板显示 */
    @media (max-width: 1024px) {
      #fabButton {
        display: flex !important;
      }
    }
    
    @media (max-width: 768px) {
      #fabButton {
        bottom: 1.5rem;
        right: 1.5rem;
        width: 52px;
        height: 52px;
        font-size: 1.25rem;
      }
    }
    
    /* 当表单显示时隐藏FAB */
    #postForm[style*="display: block"] ~ #fabButton {
      display: none !important;
    }
    
    /* 确保FAB按钮在滚动时保持可见 */
    #fabButton {
      position: fixed !important;
    }
  </style>

  <script src="/utils/blog.js"></script>
  <script>
    const BLOG_ADMIN_API = '/api/blog-admin';
    let wangEditor = null;
    let availableApis = [];
    let allPostsData = []; // 存储所有文章数据
    let expandedCategories = new Set(); // 存储已展开的分类
    let exchangeRatesCounter = 0; // 汇率转换计数器

    // 加载API列表
    async function loadApis() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/apis`);
        if (response && response.success) {
          availableApis = response.data || [];
          updateApiSelect();
        }
      } catch (error) {
        console.error('加载API列表失败:', error);
      }
    }

    // 更新API选择下拉框
    function updateApiSelect() {
      const select = document.getElementById('postApiName');
      if (!select) return;
      
      // 提取中文名称的函数
      const extractChineseName = (name) => {
        if (!name) return '';
        const chineseRegex = /[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]+/g;
        const chineseMatches = name.match(chineseRegex);
        return chineseMatches && chineseMatches.length > 0 
          ? chineseMatches.join('').trim() 
          : name;
      };
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">请选择API（分类）</option>';
      
      availableApis.forEach(api => {
        const option = document.createElement('option');
        option.value = api.name; // value仍然使用完整的api.name，用于后端匹配
        // 显示文本只显示中文名称
        const displayName = extractChineseName(api.name) || api.name;
        option.textContent = displayName;
        select.appendChild(option);
      });
      
      if (currentValue) {
        select.value = currentValue;
      }
    }

    // 特殊类别定义
    const SPECIAL_CATEGORIES = {
      'weather': {
        name: 'weather',
        displayName: '天气路况',
      },
      'second-hand': {
        name: 'second-hand',
        displayName: '二手市场',
      },
      'rentals': {
        name: 'rentals',
        displayName: '租房酒店',
        color: '#3b82f6',
        fields: ['city', 'temperature', 'condition', 'traffic', 'humidity', 'wind']
      },
      'exchange-rate': {
        name: 'exchange-rate',
        displayName: '汇率转换',
        color: '#10b981',
        fields: ['fromCurrency', 'toCurrency', 'rate', 'updateTime']
      },
      'translation': {
        name: 'translation',
        displayName: '翻译卡片',
        color: '#9333ea',
        fields: ['chinese', 'arabic', 'category']
      }
    };
    
    // 检查是否是特殊类别
    function isSpecialCategory(apiName) {
      if (!apiName) return null;
      // 检查API名称或路径是否匹配
      const lowerName = apiName.toLowerCase();
      if (lowerName === 'weather' || lowerName.includes('weather')) {
        return 'weather';
      }
      if (lowerName === 'exchange-rate' || lowerName === 'exchangerate' || lowerName.includes('exchange')) {
        return 'exchange-rate';
      }
      if (lowerName === 'translation' || lowerName.includes('translation')) {
        return 'translation';
      }
      // 检测二手市场
      if (lowerName === 'second-hand' || lowerName.includes('second-hand') || lowerName.includes('secondhand') || lowerName.includes('二手')) {
        return 'second-hand';
      }
      // 检测租房酒店
      if (lowerName === 'rentals' || lowerName.includes('rental') || lowerName.includes('租房') || lowerName.includes('酒店')) {
        return 'rentals';
      }
      return null;
    }
    
    // API选择改变时的处理
    // 检查是否需要位置信息（latitude, longitude, address）
    function needsLocationFields(apiName) {
      // 所有分类都支持位置字段（可选）
      if (!apiName) return false;
      return true;
    }

    // 检查是否需要电话字段（所有分类都支持电话字段，作为可选）
    function needsPhoneField(apiName) {
      // 所有分类都支持电话字段（可选）
      if (!apiName) return false;
      return true;
    }

    // 检查位置字段是否为必填（必填：寻味中国、常用导航、打卡地、租房、二手集市、热门活动；可选：签证指南、攻略指南、尼罗河应用、防骗指南）
    function isLocationRequired(apiName) {
      if (!apiName) return false;
      const lowerName = apiName.toLowerCase();
      // 必填位置字段的分类
      return lowerName.includes('chinese-food') || 
             lowerName.includes('寻味') || 
             lowerName.includes('location-list') ||
             lowerName.includes('导航') || 
             lowerName.includes('hot-spots') ||
             lowerName.includes('打卡') ||
             lowerName.includes('rental-list') ||
             lowerName.includes('rentals') || 
             lowerName.includes('租房') || 
             lowerName.includes('酒店') ||
             lowerName.includes('second-hand') || 
             lowerName.includes('二手') ||
             lowerName.includes('hot-activity') ||
             (lowerName.includes('活动') && !lowerName.includes('签证') && !lowerName.includes('攻略') && !lowerName.includes('防骗'));
    }

    async function onApiNameChange() {
      const apiName = document.getElementById('postApiName').value;
      const mappingInfo = document.getElementById('fieldMappingInfo');
      
      // 检查是否是特殊类别
      const specialType = isSpecialCategory(apiName);
      const needsLocation = needsLocationFields(apiName);
      
      // 隐藏所有特殊表单
      document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
        el.style.display = 'none';
      });

      // 显示/隐藏通用位置字段
      const commonLocationFields = document.getElementById('commonLocationFields');
      if (commonLocationFields) {
        // 如果已经在特殊表单中显示了位置字段（如rentals或second-hand），就不显示通用位置字段
        const hasLocationInSpecialForm = (specialType === 'rentals' || specialType === 'second-hand');
        // 所有分类都显示位置字段（除了特殊表单的分类）
        const shouldShow = needsLocation && !hasLocationInSpecialForm;
        commonLocationFields.style.display = shouldShow ? 'block' : 'none';
        
        // 显示/隐藏电话字段（所有分类都支持）
        const needsPhone = needsPhoneField(apiName);
        const hasPhoneInSpecialForm = (specialType === 'rentals' || specialType === 'second-hand');
        // 所有分类都显示电话字段（除了特殊表单的分类）
        const shouldShowPhone = needsPhone && !hasPhoneInSpecialForm && shouldShow;
        
        // 判断电话字段是否为必填（寻味中国必填，防骗指南等可选）
        const lowerName = apiName.toLowerCase();
        const isPhoneRequired = lowerName.includes('chinese-food') || lowerName.includes('寻味');
        
        const commonPhoneField = document.getElementById('commonPhoneField');
        const commonPhoneInput = document.getElementById('commonPhone');
        const commonPhoneLabel = document.getElementById('commonPhoneLabel');
        if (commonPhoneField) {
          commonPhoneField.style.display = shouldShowPhone ? 'block' : 'none';
        }
        if (commonPhoneInput) {
          commonPhoneInput.required = shouldShowPhone && isPhoneRequired;
          if (!shouldShowPhone || !isPhoneRequired) commonPhoneInput.removeAttribute('required');
        }
        // 更新电话字段标签
        if (commonPhoneLabel) {
          commonPhoneLabel.textContent = isPhoneRequired ? '联系方式 *' : '联系方式（可选）';
        }
        
        // 动态设置必填属性（只在字段可见且为必填分类时设置）
        const isRequired = isLocationRequired(apiName);
        const addressInput = document.getElementById('commonAddress');
        const latInput = document.getElementById('commonLatitude');
        const lngInput = document.getElementById('commonLongitude');
        const addressLabel = document.getElementById('commonAddressLabel');
        const latLabel = document.getElementById('commonLatitudeLabel');
        const lngLabel = document.getElementById('commonLongitudeLabel');
        
        if (addressInput) {
          addressInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) addressInput.removeAttribute('required');
        }
        // 更新地址字段标签
        if (addressLabel) {
          addressLabel.textContent = isRequired ? '地址 *' : '地址（可选）';
        }
        
        if (latInput) {
          latInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) latInput.removeAttribute('required');
        }
        // 更新纬度字段标签
        if (latLabel) {
          latLabel.textContent = isRequired ? '纬度 *' : '纬度（可选）';
        }
        
        if (lngInput) {
          lngInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) lngInput.removeAttribute('required');
        }
        // 更新经度字段标签
        if (lngLabel) {
          lngLabel.textContent = isRequired ? '经度 *' : '经度（可选）';
        }
      }
      
      // 动态设置特殊表单中字段的必填属性
      // 先移除所有特殊表单字段的必填属性，然后根据当前类型重新设置
      const secondHandPhone = document.getElementById('secondHandPhone');
      const secondHandAddress = document.getElementById('secondHandAddress');
      const secondHandLat = document.getElementById('secondHandLatitude');
      const secondHandLng = document.getElementById('secondHandLongitude');
      const rentalsPhone = document.getElementById('rentalsPhone');
      const rentalsAddress = document.getElementById('rentalsAddress');
      const rentalsLat = document.getElementById('rentalsLatitude');
      const rentalsLng = document.getElementById('rentalsLongitude');
      
      // 先移除所有必填属性
      [secondHandPhone, secondHandAddress, secondHandLat, secondHandLng, 
       rentalsPhone, rentalsAddress, rentalsLat, rentalsLng].forEach(input => {
        if (input) {
          input.removeAttribute('required');
          // 确保字段可见性检查：如果父容器隐藏，也移除required
          const parentForm = input.closest('[id^="specialForm-"]');
          if (parentForm && parentForm.style.display === 'none') {
            input.removeAttribute('required');
          }
        }
      });
      
      // 根据当前类型设置必填属性（只在表单可见时）
      if (specialType === 'second-hand') {
        const secondHandForm = document.getElementById('specialForm-second-hand');
        if (secondHandForm && secondHandForm.style.display !== 'none') {
          if (secondHandPhone) secondHandPhone.required = true;
          if (secondHandAddress) secondHandAddress.required = true;
          if (secondHandLat) secondHandLat.required = true;
          if (secondHandLng) secondHandLng.required = true;
        }
      } else if (specialType === 'rentals') {
        const rentalsForm = document.getElementById('specialForm-rentals');
        if (rentalsForm && rentalsForm.style.display !== 'none') {
          if (rentalsPhone) rentalsPhone.required = true;
          if (rentalsAddress) rentalsAddress.required = true;
          if (rentalsLat) rentalsLat.required = true;
          if (rentalsLng) rentalsLng.required = true;
        }
      }
      
      // 隐藏/显示普通内容编辑器
      const normalEditor = document.getElementById('normalContentEditor');
      if (normalEditor) {
        normalEditor.style.display = specialType ? 'none' : 'block';
      }
      
      if (!apiName) {
        mappingInfo.style.display = 'none';
        return;
      }
      
      // 如果是特殊类别，显示对应的表单（移到右侧边栏）
      if (specialType) {
        const specialForm = document.getElementById(`specialForm-${specialType}`);
        const specialCategorySidebar = document.getElementById('specialCategorySidebar');
        
        // 隐藏所有特殊表单
        document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
          el.style.display = 'none';
        });
        
        // 将特殊表单移到右侧边栏
        if (specialForm && specialCategorySidebar) {
          // 如果表单不在侧边栏中，移动它
          if (specialForm.parentElement !== specialCategorySidebar) {
            specialCategorySidebar.innerHTML = '';
            specialCategorySidebar.appendChild(specialForm);
          }
          specialForm.style.display = 'block';
        }
        
        // 对于second-hand和rentals，也显示标准内容编辑器（因为它们需要编辑普通内容）
        const normalContentEditor = document.getElementById('normalContentEditor');
        if (specialType === 'second-hand' || specialType === 'rentals') {
          if (normalContentEditor) {
            normalContentEditor.style.display = 'block';
          }
        } else {
          if (normalContentEditor) {
            normalContentEditor.style.display = 'none';
          }
        }
        mappingInfo.style.display = 'none';
        return;
      } else {
        // 非特殊类别，清空侧边栏
        const specialCategorySidebar = document.getElementById('specialCategorySidebar');
        if (specialCategorySidebar) {
          specialCategorySidebar.innerHTML = '';
        }
        // 隐藏所有特殊表单
        document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
          el.style.display = 'none';
        });
      }
      
      // 普通类别，检查字段映射
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/apis/${encodeURIComponent(apiName)}/field-mapping`);
        if (response && response.success && response.data) {
          mappingInfo.style.display = 'block';
          mappingInfo.innerHTML = `
            <div class="text-sm text-blue-600">
              <p>此API已配置字段映射，文章将根据映射规则保存到对应字段</p>
              <details class="mt-2">
                <summary class="cursor-pointer text-xs">查看字段映射</summary>
                <pre class="text-xs mt-2 p-2 bg-gray-100 rounded">${JSON.stringify(response.data, null, 2)}</pre>
              </details>
            </div>
          `;
        } else {
          mappingInfo.style.display = 'none';
        }
      } catch (error) {
        mappingInfo.style.display = 'none';
      }
    }

    // 切换标签页
    function switchTab(tabName, tabButton = null) {
      // 隐藏所有标签页内容
      document.querySelectorAll('.admin-tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // 显示选中的标签页
      const tabContent = document.getElementById(`tab-${tabName}`);
      if (tabContent) {
        tabContent.classList.add('active');
      }

      // 激活对应的标签按钮
      if (tabButton) {
        tabButton.classList.add('active');
      } else {
        // 如果没有提供按钮，通过查找包含对应文本的按钮来激活
        const buttons = document.querySelectorAll('.admin-tab');
        buttons.forEach(btn => {
          const text = btn.textContent.trim();
          if ((tabName === 'posts' && text === '文章') ||
              (tabName === 'categories' && text === '分类') ||
              (tabName === 'comments' && text === '评论') ||
              (tabName === 'weather' && text === '天气') ||
              (tabName === 'exchange-rate' && text === '汇率') ||
              (tabName === 'translation' && text === '翻译')) {
            btn.classList.add('active');
          }
        });
      }

      // 切换标签页时隐藏所有表单（移动端默认不显示新建表单）
      const categoryForm = document.getElementById('categoryForm');
      if (categoryForm) {
        categoryForm.style.display = 'none';
      }
      
      // 加载对应数据
      if (tabName === 'posts') {
        loadPosts(true); // 传递 true 重置展开状态，默认折叠
        loadApis(); // 加载API列表
      } else if (tabName === 'categories') {
        loadCategories();
      } else if (tabName === 'comments') {
        loadComments();
      } else if (tabName === 'weather') {
        loadSpecialContent('weather');
      } else if (tabName === 'exchange-rate') {
        loadSpecialContent('exchange-rate');
      } else if (tabName === 'translation') {
        loadSpecialContent('translation');
      }
    }

    // 当前登录的管理员信息
    let currentAdmin = null;

    // 显示登录页面
    function showLoginPage() {
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('mainContent').style.display = 'none';
    }

    // 显示主内容页面
    function showMainPage() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      if (currentAdmin) {
        const adminNameDisplay = document.getElementById('adminNameDisplay');
        if (adminNameDisplay) {
          adminNameDisplay.textContent = `欢迎，${currentAdmin.name || currentAdmin.username}`;
        }
      }
    }

    // 检查认证状态
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/admin/me', {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data && data.success && data.admin) {
            currentAdmin = data.admin;
            showMainPage();
            return true;
          }
        }
        showLoginPage();
        return false;
      } catch (error) {
        console.error('认证检查失败:', error);
        showLoginPage();
        return false;
      }
    }

    // 登录处理
    async function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const errorDiv = document.getElementById('loginError');

      // 隐藏错误信息
      if (errorDiv) {
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
      }

      try {
        const response = await fetch('/api/auth/admin/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          currentAdmin = data.admin;
          showMainPage();
          // 重新加载数据
          if (typeof loadPosts === 'function') {
            loadPosts(true);
          }
          if (typeof loadApis === 'function') {
            loadApis();
          }
        } else {
          // 显示错误信息
          if (errorDiv) {
            errorDiv.style.display = 'block';
            errorDiv.textContent = data.message || '登录失败，请检查用户名和密码';
          }
        }
      } catch (error) {
        console.error('登录失败:', error);
        if (errorDiv) {
          errorDiv.style.display = 'block';
          errorDiv.textContent = '登录失败，请稍后重试';
        }
      }
    }

    // 登出处理
    async function handleLogout() {
      try {
        await fetch('/api/auth/admin/logout', {
          method: 'POST',
          credentials: 'include'
        });
        currentAdmin = null;
        showLoginPage();
        // 清空表单
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
      } catch (error) {
        console.error('登出失败:', error);
        // 即使登出失败，也显示登录页面
        currentAdmin = null;
        showLoginPage();
      }
    }

    // API请求封装（带认证）
    async function adminApiRequest(url, options = {}) {
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          credentials: 'include'
        });

        if (response.status === 401) {
          // 未授权，显示登录页面
          currentAdmin = null;
          showLoginPage();
          showToast('请先登录', 'error');
          return null;
        }

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || '请求失败');
        }
        return data;
      } catch (error) {
        console.error('API请求失败:', error);
        showToast('请求失败: ' + error.message, 'error');
        throw error;
      }
    }

    // 可爱的加载提示文字数组
    const loadingMessages = [
      '📝 正在整理文章列表...',
      '✨ 魔法正在发生中...',
      '🐱 小猫咪正在帮你找文章...',
      '🚀 加速加载中...',
      '💫 文章们正在赶来...',
      '🎨 正在美化文章列表...',
      '🌟 马上就好啦...',
      '📚 正在翻阅文章库...',
      '🎯 精准定位文章中...',
      '💡 灵感正在加载...'
    ];
    
    // 可爱的表情符号数组
    const loadingEmojis = [
      '📝✨', '🐱', '🚀', '💫', '🎨', '🌟', '📚', '🎯', '💡', '✨'
    ];
    
    // 更新加载提示文字和表情
    function updateLoadingMessage() {
      const loadingText = document.getElementById('loadingText');
      const loadingEmoji = document.getElementById('loadingEmoji');
      
      if (loadingText) {
        const randomMessage = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
        loadingText.textContent = randomMessage;
      }
      
      if (loadingEmoji) {
        const randomEmoji = loadingEmojis[Math.floor(Math.random() * loadingEmojis.length)];
        loadingEmoji.textContent = randomEmoji;
        // 添加旋转动画
        loadingEmoji.style.animation = 'rotateEmoji 2s ease-in-out infinite';
      }
    }

    // 加载文章列表
    async function loadPosts(resetExpanded = false) {
      // 显示进度条
      const progressContainer = document.getElementById('postsLoadingProgress');
      const progressBar = document.getElementById('postsLoadingProgressBar');
      
      if (progressContainer && progressBar) {
        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';
        
        // 初始化加载提示
        updateLoadingMessage();
        
        // 每2秒更新一次加载提示，让等待更有趣
        const messageInterval = setInterval(() => {
          updateLoadingMessage();
        }, 2000);
        
        // 模拟进度动画
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 5 + 2; // 随机增加2-7%
          if (progress < 85) {
            progressBar.style.width = Math.min(progress, 85) + '%';
          }
        }, 150);
        
        try {
          const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
          
          // 清除进度动画和消息更新
          clearInterval(progressInterval);
          clearInterval(messageInterval);
          
          if (response && response.success) {
            const posts = response.data || [];
            console.log('获取文章列表成功，文章数:', posts.length);
            
            // 更新加载提示为成功消息
            const loadingText = document.getElementById('loadingText');
            const loadingEmoji = document.getElementById('loadingEmoji');
            if (loadingText) {
              loadingText.textContent = `✅ 成功加载 ${posts.length} 篇文章！`;
              loadingText.style.color = '#10b981';
            }
            if (loadingEmoji) {
              loadingEmoji.textContent = '🎉';
              loadingEmoji.style.animation = 'bounce 0.5s ease-in-out 3';
            }
            
            // 完成进度条
            if (progressBar) {
              progressBar.style.width = '100%';
            }
            
            // 保存所有文章数据
            allPostsData = posts;
            // 按分类统计
            const byCategory = {};
            posts.forEach(p => {
              const cat = p.category || '无分类';
              byCategory[cat] = (byCategory[cat] || 0) + 1;
            });
            console.log('文章分类统计:', byCategory);
            // 如果指定重置展开状态，则清空（默认所有分类都折叠）
            if (resetExpanded) {
              expandedCategories.clear();
            }
            displayPosts(posts);
            
            // 延迟隐藏进度条
            setTimeout(() => {
              if (progressContainer) {
                progressContainer.style.display = 'none';
              }
              if (progressBar) {
                progressBar.style.width = '0%';
              }
              // 重置加载提示
              if (loadingText) {
                loadingText.textContent = '正在加载文章列表...';
                loadingText.style.color = '#6b7280';
              }
              if (loadingEmoji) {
                loadingEmoji.textContent = '📝✨';
                loadingEmoji.style.animation = 'bounce 1s ease-in-out infinite';
              }
            }, 800);
          } else {
            console.error('获取文章列表失败:', response);
            const tbody = document.getElementById('postsTableBody');
            const mobileContainer = document.getElementById('postsTableBodyMobile');
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="7" class="blog-empty">加载失败</td></tr>';
            }
            if (mobileContainer) {
              mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">加载失败</div>';
            }
            
            // 隐藏进度条
            if (progressContainer) {
              progressContainer.style.display = 'none';
            }
            if (progressBar) {
              progressBar.style.width = '0%';
            }
          }
        } catch (error) {
          console.error('加载文章列表异常:', error);
          const tbody = document.getElementById('postsTableBody');
          const mobileContainer = document.getElementById('postsTableBodyMobile');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="blog-empty">加载失败: ' + escapeHtml(error.message) + '</td></tr>';
          }
          if (mobileContainer) {
            mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">加载失败: ' + escapeHtml(error.message) + '</div>';
          }
          
          // 清除进度动画
          clearInterval(progressInterval);
          
          // 隐藏进度条
          if (progressContainer) {
            progressContainer.style.display = 'none';
          }
          if (progressBar) {
            progressBar.style.width = '0%';
          }
        }
      } else {
        // 如果进度条元素不存在，使用原来的逻辑
        try {
          const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
          if (response && response.success) {
            const posts = response.data || [];
            console.log('获取文章列表成功，文章数:', posts.length);
            // 保存所有文章数据
            allPostsData = posts;
            // 按分类统计
            const byCategory = {};
            posts.forEach(p => {
              const cat = p.category || '无分类';
              byCategory[cat] = (byCategory[cat] || 0) + 1;
            });
            console.log('文章分类统计:', byCategory);
            // 如果指定重置展开状态，则清空（默认所有分类都折叠）
            if (resetExpanded) {
              expandedCategories.clear();
            }
            // 应用搜索和筛选（如果有）
            filterAndDisplayPosts();
          } else {
            console.error('获取文章列表失败:', response);
            const tbody = document.getElementById('postsTableBody');
            const mobileContainer = document.getElementById('postsTableBodyMobile');
            if (tbody) {
              tbody.innerHTML = '<tr><td colspan="7" class="blog-empty">加载失败</td></tr>';
            }
            if (mobileContainer) {
              mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">加载失败</div>';
            }
          }
        } catch (error) {
          console.error('加载文章列表异常:', error);
          const tbody = document.getElementById('postsTableBody');
          const mobileContainer = document.getElementById('postsTableBodyMobile');
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="7" class="blog-empty">加载失败: ' + escapeHtml(error.message) + '</td></tr>';
          }
          if (mobileContainer) {
            mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">加载失败: ' + escapeHtml(error.message) + '</div>';
          }
        }
      }
    }

    // 显示文章列表（按分类分组，默认折叠，延迟渲染）
    function displayPosts(posts) {
      try {
        const tbody = document.getElementById('postsTableBody');
        const mobileContainer = document.getElementById('postsTableBodyMobile');
        
        if (!tbody) {
          console.error('找不到 postsTableBody 元素');
          return;
        }
        
        if (!posts || posts.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="blog-empty">暂无文章</td></tr>';
          if (mobileContainer) {
            mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无文章</div>';
          }
          return;
        }

      console.log('displayPosts 接收到的文章数:', posts.length);

      // 按分类分组
      const postsByCategory = {};
      const seenIds = new Set(); // 前端再次去重，确保不显示重复
      let skippedCount = 0;
      
      for (const post of posts) {
        const postId = String(post.id || '');
        // 如果已存在相同id，跳过（防止重复显示）
        if (postId && seenIds.has(postId)) {
          skippedCount++;
          console.warn('跳过重复ID的文章:', { id: postId, category: post.category, name: post.name });
          continue;
        }
        seenIds.add(postId);
        
        // 按apiName（_sourceApiName）分组，而不是category
        // 提取中文名称用于统一分组（避免"二手市场"和"二手市场 second-hand"分成两组）
        const extractChineseName = (name) => {
          if (!name) return '';
          const chineseRegex = /[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]+/g;
          const chineseMatches = name.match(chineseRegex);
          return chineseMatches && chineseMatches.length > 0 
            ? chineseMatches.join('').trim() 
            : name;
        };
        
        const rawApiName = post._sourceApiName || post.category || '无分类';
        const apiName = extractChineseName(rawApiName) || rawApiName; // 统一使用中文名称分组
        
        // 排除"标签"相关的分类，标签管理应该在标签选项卡中显示，不应该出现在文章列表中
        const excludedCategories = ['标签', '标签管理', '博客标签列表', '博客标签列表API'];
        const apiNameLower = apiName.toLowerCase();
        if (excludedCategories.includes(apiName) || 
            apiNameLower === 'tag' || 
            apiNameLower === 'tags' ||
            apiName.includes('标签') ||
            apiName.includes('标签列表')) {
          continue;
        }
        
        if (!postsByCategory[apiName]) {
          postsByCategory[apiName] = [];
        }
        postsByCategory[apiName].push(post);
      }

      console.log('显示文章统计:', {
        总接收: posts.length,
        去重后: seenIds.size,
        跳过重复: skippedCount,
        分类数: Object.keys(postsByCategory).length
      });

      // 保存文章数据到全局变量，用于延迟渲染
      window.postsByCategoryData = postsByCategory;

      // 使用 DocumentFragment 优化 DOM 操作
      const fragment = document.createDocumentFragment();
      const mobileFragment = document.createDocumentFragment();
      const sortedCategories = Object.keys(postsByCategory).sort();
      
      // 移动端卡片HTML
      let mobileHtml = '';
      
      // 只渲染分类标题行（性能优化：不渲染折叠的文章行）
      for (const apiName of sortedCategories) {
        const categoryPosts = postsByCategory[apiName];
        const isExpanded = expandedCategories.has(apiName);
        
        // 分类标题行（按apiName分组）
        const specialType = isSpecialCategory(apiName);
        let categoryDisplayName = apiName;
        
        if (specialType) {
          const specialInfo = SPECIAL_CATEGORIES[specialType];
          categoryDisplayName = specialInfo.displayName;
        }
        
        // 添加点击展开/折叠功能 - 去掉文件夹图标
        const expandIcon = isExpanded ? '▼' : '▶';
        
        // 应用筛选条件计算显示数量
        let displayCount = categoryPosts.length;
        if (currentSearchQuery || currentStatusFilter) {
          let filtered = categoryPosts;
          if (currentSearchQuery) {
            filtered = filtered.filter(post => {
              const title = (post.name || post.title || '').toLowerCase();
              const category = (post.category || post._sourceApiName || '').toLowerCase();
              const excerpt = (post.excerpt || post.description || '').toLowerCase();
              return title.includes(currentSearchQuery) || 
                     category.includes(currentSearchQuery) || 
                     excerpt.includes(currentSearchQuery);
            });
          }
          if (currentStatusFilter) {
            filtered = filtered.filter(post => {
              if (currentStatusFilter === 'published') {
                return post.published === true || post.published === 'true';
              } else if (currentStatusFilter === 'draft') {
                return !post.published || post.published === 'false';
              }
              return true;
            });
          }
          displayCount = filtered.length;
        }
        
        // 创建分类标题行
        const headerRow = document.createElement('tr');
        headerRow.className = 'category-header-row';
        headerRow.style.cssText = 'background: #FAFBFC; font-weight: 600; cursor: pointer;';
        headerRow.setAttribute('data-category-name', apiName);
        headerRow.onclick = function() {
          toggleCategory(this.dataset.categoryName);
        };
        
        headerRow.innerHTML = `
          <td colspan="7" style="padding: 0.5rem 0.75rem; border-bottom: 1px solid #E5E7EB;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="color: #6B7280; font-size: 0.75rem; font-weight: 500; min-width: 16px; text-align: center;">${expandIcon}</span>
              <span style="color: #374151; font-weight: 600; font-size: 0.8125rem;">${escapeHtml(categoryDisplayName)}</span>
              <span style="color: #9CA3AF; font-size: 0.75rem; font-weight: normal; margin-left: auto;">
                ${displayCount}${displayCount !== categoryPosts.length ? `/${categoryPosts.length}` : ''} 篇
              </span>
            </div>
          </td>
        `;
        
        fragment.appendChild(headerRow);
        
        // 该分类下的文章（只渲染展开的分类，性能优化）
        if (isExpanded && displayCount > 0) {
          renderCategoryPosts(apiName, categoryPosts, fragment);
        }
        
        // 移动端：默认折叠，添加分类标题（可点击展开/折叠）
        // 注意：specialType 和 categoryDisplayName 已在上面声明，直接复用
        if (!window.expandedCategoriesMobile) {
          window.expandedCategoriesMobile = new Set(); // 移动端默认全部折叠
        }
        const mobileExpanded = window.expandedCategoriesMobile.has(apiName);
        const mobileExpandIcon = mobileExpanded ? '▼' : '▶';
        // 计算移动端显示数量（考虑搜索和筛选）
        let mobileDisplayCount = categoryPosts.length;
        if (currentSearchQuery || currentStatusFilter) {
          let filtered = categoryPosts;
          if (currentSearchQuery) {
            filtered = filtered.filter(post => {
              const title = (post.name || post.title || '').toLowerCase();
              const category = (post.category || post._sourceApiName || '').toLowerCase();
              const excerpt = (post.excerpt || post.description || '').toLowerCase();
              return title.includes(currentSearchQuery) || 
                     category.includes(currentSearchQuery) || 
                     excerpt.includes(currentSearchQuery);
            });
          }
          if (currentStatusFilter) {
            filtered = filtered.filter(post => {
              if (currentStatusFilter === 'published') {
                return post.published === true || post.published === 'true';
              } else if (currentStatusFilter === 'draft') {
                return !post.published || post.published === 'false';
              }
              return true;
            });
          }
          mobileDisplayCount = filtered.length;
        }
        
        mobileHtml += `<div class="admin-category-header-mobile" data-category-name="${escapeHtml(apiName)}" onclick="toggleCategoryMobile('${escapeHtml(apiName)}')">
          <span class="category-expand-icon">${mobileExpandIcon}</span>
          <span>${escapeHtml(categoryDisplayName)}</span>
          <span style="margin-left: auto; color: #9ca3af; font-weight: normal; font-size: 0.75rem;">${mobileDisplayCount}${mobileDisplayCount !== categoryPosts.length ? `/${categoryPosts.length}` : ''}篇</span>
        </div>`;
        
        // 添加该分类下的所有文章卡片（根据展开状态显示/隐藏）
        if (mobileExpanded) {
          // 应用搜索和筛选
          let filteredPosts = categoryPosts;
          if (currentSearchQuery) {
            filteredPosts = filteredPosts.filter(post => {
              const title = (post.name || post.title || '').toLowerCase();
              const category = (post.category || post._sourceApiName || '').toLowerCase();
              const excerpt = (post.excerpt || post.description || '').toLowerCase();
              return title.includes(currentSearchQuery) || 
                     category.includes(currentSearchQuery) || 
                     excerpt.includes(currentSearchQuery);
            });
          }
          if (currentStatusFilter) {
            filteredPosts = filteredPosts.filter(post => {
              if (currentStatusFilter === 'published') {
                return post.published === true || post.published === 'true';
              } else if (currentStatusFilter === 'draft') {
                return !post.published || post.published === 'false';
              }
              return true;
            });
          }
          
          filteredPosts.forEach(post => {
            const date = formatDate(post.createdAt || post.created_at);
            const postCategory = post.category || apiName;
            const statusBadge = post.published 
              ? '<span class="status-badge published" style="font-size: 0.6875rem; padding: 0.125rem 0.375rem;">已发布</span>' 
              : '<span class="status-badge draft" style="font-size: 0.6875rem; padding: 0.125rem 0.375rem;">草稿</span>';
            
            const isDraft = !post.published || post.published === 'false';
            mobileHtml += `
              <div class="admin-post-card" data-post-id="${post.id}" data-category="${escapeHtml(apiName)}">
                <div class="admin-post-card-header" style="display: flex; align-items: center; gap: 0.5rem;">
                  <input type="checkbox" class="post-checkbox" value="${post.id}" data-published="${post.published ? 'true' : 'false'}" onchange="updateSelection()" style="width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                  <div class="admin-post-card-title" style="flex: 1;">${escapeHtml(post.name || post.title || '未命名')}</div>
                  ${statusBadge}
                </div>
                <div class="admin-post-card-actions">
                  <button class="admin-btn-small admin-btn-edit" onclick="event.stopPropagation(); editPost('${post.id}')" title="编辑">编辑</button>
                  <button class="admin-btn-small admin-btn-copy" onclick="event.stopPropagation(); copyPost('${post.id}')" title="复制文章">复制</button>
                  <button class="admin-btn-small admin-btn-delete" onclick="event.stopPropagation(); deletePost('${post.id}')" title="删除">删除</button>
                </div>
              </div>
            `;
          });
        }
      }

      // 更新移动端容器（mobileContainer已在函数开始处声明）
      if (mobileContainer) {
        mobileContainer.innerHTML = mobileHtml || '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无文章</div>';
      }

      // 批量插入 DOM（性能优化）
      try {
        tbody.innerHTML = '';
        tbody.appendChild(fragment);
        
        // 确保进度条被隐藏
        const progressContainer = document.getElementById('postsLoadingProgress');
        const progressBar = document.getElementById('postsLoadingProgressBar');
        if (progressContainer) {
          progressContainer.style.display = 'none';
        }
        if (progressBar) {
          progressBar.style.width = '0%';
        }
      } catch (error) {
        console.error('渲染文章列表失败:', error);
        const tbody = document.getElementById('postsTableBody');
        const mobileContainer = document.getElementById('postsTableBodyMobile');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="7" class="blog-empty">渲染失败: ' + escapeHtml(error.message) + '</td></tr>';
        }
        if (mobileContainer) {
          mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">渲染失败: ' + escapeHtml(error.message) + '</div>';
        }
        
        // 确保进度条被隐藏
        const progressContainer = document.getElementById('postsLoadingProgress');
        const progressBar = document.getElementById('postsLoadingProgressBar');
        if (progressContainer) {
          progressContainer.style.display = 'none';
        }
        if (progressBar) {
          progressBar.style.width = '0%';
        }
      }
      } catch (outerError) {
        console.error('displayPosts 函数执行失败:', outerError);
        const tbody = document.getElementById('postsTableBody');
        const mobileContainer = document.getElementById('postsTableBodyMobile');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="7" class="blog-empty">显示失败: ' + escapeHtml(outerError.message) + '</td></tr>';
        }
        if (mobileContainer) {
          mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">显示失败: ' + escapeHtml(outerError.message) + '</div>';
        }
      }
    }
    
    // 渲染单个分类的文章行（延迟渲染函数）
    function renderCategoryPosts(apiName, categoryPosts, container) {
      const fragment = container || document.createDocumentFragment();
      
      // 应用筛选条件
      let filteredPosts = categoryPosts;
      
      if (currentSearchQuery) {
        filteredPosts = filteredPosts.filter(post => {
          const title = (post.name || post.title || '').toLowerCase();
          return title.includes(currentSearchQuery);
        });
      }
      
      if (currentStatusFilter) {
        filteredPosts = filteredPosts.filter(post => {
          if (currentStatusFilter === 'published') {
            return post.published === true || post.published === 'true';
          } else if (currentStatusFilter === 'draft') {
            return !post.published || post.published === 'false';
          }
          return true;
        });
      }
      
      // 如果没有匹配的文章，不渲染
      if (filteredPosts.length === 0) {
        return fragment;
      }
      
      for (const post of filteredPosts) {
        const date = formatDate(post.createdAt || post.created_at);
        const postCategory = post.category || apiName;
        const categoryDisplay = `<span class="category-tag">${escapeHtml(postCategory)}</span>`;
        
        // 状态Badge
        const statusBadge = post.published 
          ? '<span class="status-badge published">已发布</span>' 
          : '<span class="status-badge draft">草稿</span>';
        
        const row = document.createElement('tr');
        row.className = 'category-post-row';
        row.setAttribute('data-category', apiName);
        row.setAttribute('data-post-id', post.id);
        row.style.cssText = 'background: #FFFFFF;';
        
        const isDraft = !post.published || post.published === 'false';
        row.innerHTML = `
          <td style="text-align: center;">
            <input type="checkbox" class="post-checkbox" value="${post.id}" data-published="${post.published ? 'true' : 'false'}" onchange="updateSelection()" style="width: 18px; height: 18px; cursor: pointer;">
          </td>
          <td style="font-weight: 600; font-size: 0.9375rem; color: #111827; max-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${escapeHtml(post.name || post.title || '未命名')}
          </td>
          <td style="white-space: nowrap;">${categoryDisplay}</td>
          <td style="white-space: nowrap;">${statusBadge}</td>
          <td style="color: #9CA3AF; font-size: 0.8125rem; white-space: nowrap;">
            <span style="display: inline-flex; align-items: center; gap: 0.25rem;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.6;">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                <circle cx="12" cy="12" r="3"></circle>
              </svg>
              ${post.views || 0}
            </span>
          </td>
          <td style="color: #9CA3AF; font-size: 0.8125rem; white-space: nowrap;">
            <span style="display: inline-flex; align-items: center; gap: 0.25rem;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="opacity: 0.6;">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              ${date}
            </span>
          </td>
          <td style="white-space: nowrap; min-width: 140px;">
            <div class="admin-actions">
              <button class="admin-btn-small admin-btn-edit" onclick="event.stopPropagation(); editPost('${post.id}')" title="编辑">编辑</button>
              <button class="admin-btn-small admin-btn-copy" onclick="event.stopPropagation(); copyPost('${post.id}')" title="复制文章">复制</button>
              <button class="admin-btn-small admin-btn-delete" onclick="event.stopPropagation(); deletePost('${post.id}')" title="删除">删除</button>
            </div>
          </td>
        `;
        
        fragment.appendChild(row);
      }
      
      return fragment;
    }

    // 筛选文章函数
    let currentSearchQuery = '';
    let currentStatusFilter = '';
    
    // 处理搜索
    function handlePostsSearch(query) {
      currentSearchQuery = query.toLowerCase().trim();
      const clearBtn = document.getElementById('clearSearchBtn');
      
      if (clearBtn) {
        clearBtn.style.display = currentSearchQuery ? 'block' : 'none';
      }
      
      // 实时过滤显示
      filterAndDisplayPosts();
    }
    
    // 清除搜索
    function clearPostsSearch() {
      const searchInput = document.getElementById('postsSearchInput');
      if (searchInput) {
        searchInput.value = '';
      }
      currentSearchQuery = '';
      const clearBtn = document.getElementById('clearSearchBtn');
      if (clearBtn) {
        clearBtn.style.display = 'none';
      }
      filterAndDisplayPosts();
    }
    
    // 处理状态筛选
    function handleStatusFilter(status) {
      currentStatusFilter = status;
      filterAndDisplayPosts();
    }
    
    // 过滤并显示文章
    function filterAndDisplayPosts() {
      if (!allPostsData || allPostsData.length === 0) {
        return;
      }
      
      // 应用搜索和筛选
      let filteredPosts = allPostsData;
      
      if (currentSearchQuery) {
        filteredPosts = filteredPosts.filter(post => {
          const title = (post.name || post.title || '').toLowerCase();
          const category = (post.category || post._sourceApiName || '').toLowerCase();
          const excerpt = (post.excerpt || post.description || '').toLowerCase();
          return title.includes(currentSearchQuery) || 
                 category.includes(currentSearchQuery) || 
                 excerpt.includes(currentSearchQuery);
        });
      }
      
      if (currentStatusFilter) {
        filteredPosts = filteredPosts.filter(post => {
          if (currentStatusFilter === 'published') {
            return post.published === true || post.published === 'true';
          } else if (currentStatusFilter === 'draft') {
            return !post.published || post.published === 'false';
          }
          return true;
        });
      }
      
      // 重新显示过滤后的文章
      displayPosts(filteredPosts);
      
      // 如果有搜索条件，自动展开所有分类以便查看结果
      if (currentSearchQuery || currentStatusFilter) {
        expandAllCategories(true); // true表示静默展开，不显示提示
      }
    }
    
    // 展开所有分类
    function expandAllCategories(silent = false) {
      if (!window.postsByCategoryData) {
        if (!silent) showToast('请先加载文章列表', 'warning');
        return;
      }
      
      const categories = Object.keys(window.postsByCategoryData);
      categories.forEach(category => {
        if (!expandedCategories.has(category)) {
          expandedCategories.add(category);
        }
      });
      
      // 重新渲染以应用展开状态
      if (allPostsData) {
        displayPosts(allPostsData);
      }
      
      if (!silent) {
        showToast(`已展开 ${categories.length} 个分类`, 'success');
      }
    }
    
    // 折叠所有分类
    function collapseAllCategories() {
      expandedCategories.clear();
      
      // 重新渲染以应用折叠状态
      if (allPostsData) {
        displayPosts(allPostsData);
      }
      
      showToast('已折叠所有分类', 'success');
    }
    
    // 筛选功能已移除，保留函数以避免错误
    function filterPosts() {
      filterAndDisplayPosts();
    }
    
    // 切换分类展开/折叠状态（优化：只更新相关行，不重新渲染整个列表）
    function toggleCategory(apiName) {
      const tbody = document.getElementById('postsTableBody');
      const headerRow = tbody.querySelector(`tr[data-category-name="${escapeHtml(apiName)}"]`);
      
      if (!headerRow) return;
      
      const isExpanded = expandedCategories.has(apiName);
      const categoryPosts = window.postsByCategoryData && window.postsByCategoryData[apiName];
      
      if (!categoryPosts) {
        // 如果没有缓存数据，回退到重新加载
        if (expandedCategories.has(apiName)) {
          expandedCategories.delete(apiName);
        } else {
          expandedCategories.add(apiName);
        }
        displayPosts(allPostsData);
        return;
      }
      
      // 更新展开/折叠状态
      if (isExpanded) {
        expandedCategories.delete(apiName);
        // 折叠：删除该分类下的所有文章行
        let nextRow = headerRow.nextElementSibling;
        while (nextRow && nextRow.getAttribute('data-category') === apiName) {
          const toRemove = nextRow;
          nextRow = nextRow.nextElementSibling;
          toRemove.remove();
        }
        // 更新图标
        const iconSpan = headerRow.querySelector('td span');
        if (iconSpan) {
          const text = iconSpan.textContent.replace(/^[▶▼]\s*/, '');
          iconSpan.textContent = '▶ ' + text;
        }
      } else {
        expandedCategories.add(apiName);
        // 展开：在该分类标题行后插入文章行
        const fragment = renderCategoryPosts(apiName, categoryPosts);
        // 找到插入位置（分类标题行的下一个兄弟节点）
        if (headerRow.nextSibling) {
          headerRow.parentNode.insertBefore(fragment, headerRow.nextSibling);
        } else {
          headerRow.parentNode.appendChild(fragment);
        }
        // 更新图标
        const iconSpan = headerRow.querySelector('td span');
        if (iconSpan) {
          const text = iconSpan.textContent.replace(/^[▶▼]\s*/, '');
          iconSpan.textContent = '▼ ' + text;
        }
      }
    }
    
    // 移动端切换分类展开/折叠状态
    function toggleCategoryMobile(apiName) {
      if (!window.expandedCategoriesMobile) {
        window.expandedCategoriesMobile = new Set();
      }
      
      const mobileContainer = document.getElementById('postsTableBodyMobile');
      if (!mobileContainer) return;
      
      const isExpanded = window.expandedCategoriesMobile.has(apiName);
      const categoryHeader = mobileContainer.querySelector(`.admin-category-header-mobile[data-category-name="${escapeHtml(apiName)}"]`);
      if (!categoryHeader) return;
      
      // 更新展开/折叠状态
      if (isExpanded) {
        window.expandedCategoriesMobile.delete(apiName);
        // 折叠：隐藏该分类下的所有文章卡片
        const categoryCards = mobileContainer.querySelectorAll(`.admin-post-card[data-category="${escapeHtml(apiName)}"]`);
        categoryCards.forEach(card => {
          card.style.display = 'none';
        });
        // 更新图标
        const iconSpan = categoryHeader.querySelector('.category-expand-icon');
        if (iconSpan) {
          iconSpan.textContent = '▶';
        }
      } else {
        window.expandedCategoriesMobile.add(apiName);
        // 展开：先检查该分类下的文章卡片是否已存在
        const existingCards = mobileContainer.querySelectorAll(`.admin-post-card[data-category="${escapeHtml(apiName)}"]`);
        
        if (existingCards.length > 0) {
          // 如果卡片已存在，只需显示它们（可能是之前被隐藏了）
          existingCards.forEach(card => {
            card.style.display = 'flex';
          });
        } else {
          // 如果卡片不存在，创建新的卡片
          const categoryPosts = window.postsByCategoryData && window.postsByCategoryData[apiName];
          if (categoryPosts) {
            // 找到分类标题后面的位置
            let nextSibling = categoryHeader.nextElementSibling;
            const fragment = document.createDocumentFragment();
            
            categoryPosts.forEach(post => {
              const date = formatDate(post.createdAt || post.created_at);
              const postCategory = post.category || apiName;
              const statusBadge = post.published 
                ? '<span class="status-badge published" style="font-size: 0.6875rem; padding: 0.125rem 0.375rem;">已发布</span>' 
                : '<span class="status-badge draft" style="font-size: 0.6875rem; padding: 0.125rem 0.375rem;">草稿</span>';
              
              const cardDiv = document.createElement('div');
              cardDiv.className = 'admin-post-card';
              cardDiv.setAttribute('data-post-id', post.id);
              cardDiv.setAttribute('data-category', apiName);
              cardDiv.innerHTML = `
                <div class="admin-post-card-header">
                  <div class="admin-post-card-title">${escapeHtml(post.name || post.title || '未命名')}</div>
                  ${statusBadge}
                </div>
                <div class="admin-post-card-actions">
                  <button class="admin-btn-small admin-btn-edit" onclick="event.stopPropagation(); editPost('${post.id}')" title="编辑">编辑</button>
                  <button class="admin-btn-small admin-btn-copy" onclick="event.stopPropagation(); copyPost('${post.id}')" title="复制文章">复制</button>
                  <button class="admin-btn-small admin-btn-delete" onclick="event.stopPropagation(); deletePost('${post.id}')" title="删除">删除</button>
                </div>
              `;
              fragment.appendChild(cardDiv);
            });
            
            // 插入到分类标题后面
            if (nextSibling) {
              mobileContainer.insertBefore(fragment, nextSibling);
            } else {
              mobileContainer.appendChild(fragment);
            }
          } else {
            // 如果没有缓存数据，尝试显示已存在的卡片（如果存在）
            const categoryCards = mobileContainer.querySelectorAll(`.admin-post-card[data-category="${escapeHtml(apiName)}"]`);
            categoryCards.forEach(card => {
              card.style.display = 'flex';
            });
          }
        }
        // 更新图标
        const iconSpan = categoryHeader.querySelector('.category-expand-icon');
        if (iconSpan) {
          iconSpan.textContent = '▼';
        }
      }
    }

    // 显示文章表单
    // 在新窗口打开新建文章页面
    function openNewPostInNewWindow() {
      const newWindow = window.open('/blog-admin.html?action=new', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      if (!newWindow) {
        alert('无法打开新窗口，请检查浏览器弹窗设置');
      }
    }

    async function showPostForm(post = null) {
      const form = document.getElementById('postForm');
      const formTitle = document.getElementById('postFormTitle');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      // 确保API列表已加载
      if (availableApis.length === 0) {
        loadApis().then(() => {
          showPostForm(post);
        });
        return;
      }
      
      // 确保表单显示，并隐藏加载提示
      if (form) {
        form.style.display = 'block';
        form.classList.remove('loading');
      }
      if (postFormLoading) {
        postFormLoading.style.display = 'none';
      }
      if (postFormContent) {
        postFormContent.style.display = 'block';
      }
      
      // 重置表单
      document.getElementById('postId').value = '';
      document.getElementById('postName').value = '';
      document.getElementById('postSlug').value = '';
      document.getElementById('postExcerpt').value = '';
      document.getElementById('postImage').value = '';
      updateImagePreview('');
      document.getElementById('postPublished').checked = true;
      
      // 清空位置和联系方式字段
      const commonPhone = document.getElementById('commonPhone');
      const commonAddress = document.getElementById('commonAddress');
      const commonLatitude = document.getElementById('commonLatitude');
      const commonLongitude = document.getElementById('commonLongitude');
      const secondHandPhone = document.getElementById('secondHandPhone');
      const secondHandAddress = document.getElementById('secondHandAddress');
      const secondHandLatitude = document.getElementById('secondHandLatitude');
      const secondHandLongitude = document.getElementById('secondHandLongitude');
      const rentalsPhone = document.getElementById('rentalsPhone');
      const rentalsAddress = document.getElementById('rentalsAddress');
      const rentalsLatitude = document.getElementById('rentalsLatitude');
      const rentalsLongitude = document.getElementById('rentalsLongitude');
      
      if (commonPhone) commonPhone.value = '';
      if (commonAddress) commonAddress.value = '';
      if (commonLatitude) commonLatitude.value = '';
      if (commonLongitude) commonLongitude.value = '';
      if (secondHandPhone) secondHandPhone.value = '';
      if (secondHandAddress) secondHandAddress.value = '';
      if (secondHandLatitude) secondHandLatitude.value = '';
      if (secondHandLongitude) secondHandLongitude.value = '';
      if (rentalsPhone) rentalsPhone.value = '';
      if (rentalsAddress) rentalsAddress.value = '';
      if (rentalsLatitude) rentalsLatitude.value = '';
      if (rentalsLongitude) rentalsLongitude.value = '';
      
      if (post) {
        // 如果没有ID，说明是复制或新建，否则是编辑
        formTitle.textContent = post.id ? '编辑文章' : '复制文章';
        document.getElementById('postId').value = post.id || '';
        // name和title保持一致
        const nameValue = post.name || post.title || '';
        document.getElementById('postName').value = nameValue;
        document.getElementById('postSlug').value = post.slug || '';
        document.getElementById('postExcerpt').value = post.excerpt || post.description || '';
        const imageUrl = post.image || '';
        document.getElementById('postImage').value = imageUrl;
        updateImagePreview(imageUrl);
        const apiName = post._sourceApiName || post.category || '';
        
        // 提取中文名称用于匹配（API下拉框中的名称格式可能是"中文 英文"）
        const extractChineseName = (name) => {
          if (!name) return '';
          const chineseRegex = /[\u4e00-\u9fa5\u3000-\u303f\uff00-\uffef]+/g;
          const chineseMatches = name.match(chineseRegex);
          return chineseMatches && chineseMatches.length > 0 
            ? chineseMatches.join('').trim() 
            : name;
        };
        
        const apiNameChinese = extractChineseName(apiName);
        
        // 尝试匹配API下拉框中的选项
        // 首先尝试精确匹配
        let matchedApiName = '';
        if (apiName) {
          // 先尝试精确匹配
          const exactMatch = availableApis.find(api => {
            const apiNameChineseOnly = extractChineseName(api.name);
            return api.name === apiName || 
                   api.name === apiNameChinese || 
                   apiNameChineseOnly === apiNameChinese ||
                   apiNameChineseOnly === apiName;
          });
          
          if (exactMatch) {
            matchedApiName = exactMatch.name;
          } else {
            // 如果精确匹配失败，尝试部分匹配（包含关系）
            const partialMatch = availableApis.find(api => {
              const apiNameChineseOnly = extractChineseName(api.name);
              return api.name.includes(apiName) || 
                     api.name.includes(apiNameChinese) ||
                     apiName.includes(apiNameChineseOnly) ||
                     apiNameChineseOnly.includes(apiNameChinese) ||
                     apiNameChinese.includes(apiNameChineseOnly);
            });
            
            if (partialMatch) {
              matchedApiName = partialMatch.name;
            } else {
              // 如果还是找不到，使用原始值（可能API列表中没有对应的选项）
              matchedApiName = apiName;
            }
          }
        }
        
        document.getElementById('postApiName').value = matchedApiName;
        console.log('设置API名称:', { 
          原始值: apiName, 
          中文部分: apiNameChinese, 
          匹配结果: matchedApiName,
          可用API列表: availableApis.map(a => a.name)
        });
        document.getElementById('postPublished').checked = post.published !== false; // 默认为true
        
        // 触发API选择改变事件
        setTimeout(() => {
          onApiNameChange();
          
          // 如果是特殊类别，加载原始数据到表单
          const specialType = isSpecialCategory(apiName);
          if (specialType && post._originalData) {
            loadSpecialCategoryData(specialType, post._originalData);
          }
          
          // 加载特殊字段（二手市场和租房酒店）
          if (specialType === 'second-hand') {
            const priceInput = document.getElementById('secondHandPrice');
            if (priceInput) {
              // 优先从_originalData获取，如果没有则从post本身获取
              const price = (post._originalData && post._originalData.price) || post.price || '';
              priceInput.value = price;
              console.log('加载二手市场价格字段:', { price, fromOriginalData: post._originalData?.price, fromPost: post.price });
            }
            const phoneInput = document.getElementById('secondHandPhone');
            const addressInput = document.getElementById('secondHandAddress');
            const latInput = document.getElementById('secondHandLatitude');
            const lngInput = document.getElementById('secondHandLongitude');
            if (phoneInput) {
              const phone = (post._originalData && post._originalData.phone) || post.phone || '';
              phoneInput.value = phone;
            }
            if (addressInput) {
              const address = (post._originalData && post._originalData.address) || post.address || '';
              addressInput.value = address;
            }
            if (latInput) {
              const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
              latInput.value = lat;
            }
            if (lngInput) {
              const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
              lngInput.value = lng;
            }
          } else if (specialType === 'rentals') {
            const priceInput = document.getElementById('rentalsPrice');
            const roomsInput = document.getElementById('rentalsRooms');
            const areaInput = document.getElementById('rentalsArea');
            const viewsInput = document.getElementById('rentalsViews');
            const phoneInput = document.getElementById('rentalsPhone');
            const addressInput = document.getElementById('rentalsAddress');
            const latInput = document.getElementById('rentalsLatitude');
            const lngInput = document.getElementById('rentalsLongitude');
            if (priceInput) {
              const price = (post._originalData && post._originalData.price) || post.price || '';
              priceInput.value = price;
            }
            if (roomsInput) {
              const rooms = (post._originalData && post._originalData.rooms) || post.rooms || '';
              roomsInput.value = rooms;
            }
            if (areaInput) {
              const area = (post._originalData && post._originalData.area) || post.area || '';
              areaInput.value = area;
            }
            if (viewsInput) {
              const views = (post._originalData && post._originalData.views) || post.views || 0;
              viewsInput.value = views;
            }
            if (phoneInput) {
              const phone = (post._originalData && post._originalData.phone) || post.phone || '';
              phoneInput.value = phone;
            }
            if (addressInput) {
              const address = (post._originalData && post._originalData.address) || post.address || '';
              addressInput.value = address;
            }
            if (latInput) {
              const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
              latInput.value = lat;
            }
            if (lngInput) {
              const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
              lngInput.value = lng;
            }
            console.log('加载租房酒店特殊字段:', {
              price: (post._originalData && post._originalData.price) || post.price,
              rooms: (post._originalData && post._originalData.rooms) || post.rooms,
              area: (post._originalData && post._originalData.area) || post.area,
              views: (post._originalData && post._originalData.views) || post.views,
              phone: (post._originalData && post._originalData.phone) || post.phone,
              address: (post._originalData && post._originalData.address) || post.address,
              latitude: (post._originalData && post._originalData.latitude) || post.latitude,
              longitude: (post._originalData && post._originalData.longitude) || post.longitude
            });
          } else {
            // 加载通用位置字段（用于其他需要位置的分类）
            const needsLocation = needsLocationFields(apiName);
            const needsPhone = needsPhoneField(apiName);
            if (needsLocation) {
              const addressInput = document.getElementById('commonAddress');
              const latInput = document.getElementById('commonLatitude');
              const lngInput = document.getElementById('commonLongitude');
              if (addressInput) {
                const address = (post._originalData && post._originalData.address) || post.address || '';
                addressInput.value = address;
              }
              if (latInput) {
                const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
                latInput.value = lat;
              }
              if (lngInput) {
                const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
                lngInput.value = lng;
              }
            }
            // 加载通用电话字段（用于寻味中国等分类）
            if (needsPhone) {
              const phoneInput = document.getElementById('commonPhone');
              if (phoneInput) {
                const phone = (post._originalData && post._originalData.phone) || post.phone || '';
                phoneInput.value = phone;
              }
            }
          }
        }, 100);
        
        // 设置htmlContent（统一使用htmlContent）
        const htmlContent = post.htmlContent || (post._originalData ? (post._originalData.htmlContent || '') : '');
        
        // 初始化HTML编辑器并设置内容
        if (!wangEditor) {
          await initQuillEditor();
        }
        if (wangEditor) {
          if (htmlContent) {
            wangEditor.setHtml(htmlContent);
          } else {
            wangEditor.setHtml('');
          }
        }
      } else {
        formTitle.textContent = '新建文章';
        document.getElementById('postFormElement').reset();
        document.getElementById('postId').value = '';
        document.getElementById('postApiName').value = '';
        
        // 重置所有特殊表单
        document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
          el.style.display = 'none';
          // 清空所有输入框
          el.querySelectorAll('input, textarea, select').forEach(input => {
            input.value = '';
          });
        });
        
        // 重置天气路况的动态列表
        document.getElementById('weatherAttractionsList').innerHTML = '';
        document.getElementById('weatherTrafficList').innerHTML = '';
        weatherAttractionsCounter = 0;
        weatherTrafficCounter = 0;
        
        // 重置特殊字段（二手市场和租房酒店）
        const secondHandPriceInput = document.getElementById('secondHandPrice');
        if (secondHandPriceInput) secondHandPriceInput.value = '';
        const rentalsPriceInput = document.getElementById('rentalsPrice');
        if (rentalsPriceInput) rentalsPriceInput.value = '';
        const rentalsRoomsInput = document.getElementById('rentalsRooms');
        if (rentalsRoomsInput) rentalsRoomsInput.value = '';
        const rentalsAreaInput = document.getElementById('rentalsArea');
        if (rentalsAreaInput) rentalsAreaInput.value = '';
        const rentalsViewsInput = document.getElementById('rentalsViews');
        if (rentalsViewsInput) rentalsViewsInput.value = '';
        
        // 重置汇率转换列表
        const exchangeRatesList = document.getElementById('exchangeRatesList');
        if (exchangeRatesList) exchangeRatesList.innerHTML = '';
        exchangeRatesCounter = 0;
        
        // 显示普通内容编辑器
        const normalEditor = document.getElementById('normalContentEditor');
        if (normalEditor) {
          normalEditor.style.display = 'block';
        }
        
        // 初始化HTML编辑器
        if (!wangEditor) {
          await initQuillEditor();
        }
        if (wangEditor) {
          wangEditor.setHtml('');
        }
        document.getElementById('fieldMappingInfo').style.display = 'none';
      }
      
      form.style.display = 'block';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    // 切换编辑器模式（全局函数，供HTML调用）
    window.switchEditorMode = async function switchEditorMode(mode) {
      const markdownContainer = document.getElementById('markdownEditorContainer');
      const htmlContainer = document.getElementById('htmlEditorContainer');
      
      // 保存当前编辑器内容到临时变量（在切换前）
      let currentContent = '';
      
      if (currentEditorMode === 'html' && wangEditor) {
        // 当前是HTML模式，保存HTML内容
        currentContent = wangEditor.getHtml();
      } else if (currentEditorMode === 'markdown' && simpleMDE) {
        // 当前是Markdown模式，保存Markdown内容
        currentContent = simpleMDE.value();
      } else if (currentEditorMode === 'markdown') {
        // Markdown模式但simpleMDE未初始化，从textarea获取
        const textarea = document.getElementById('postContent');
        if (textarea) {
          currentContent = textarea.value;
        }
      }
      
      // 更新当前模式
      currentEditorMode = mode;
      
      if (mode === 'markdown') {
        markdownContainer.style.display = 'block';
        htmlContainer.style.display = 'none';
        
        // 确保SimpleMDE已初始化
        if (!simpleMDE) {
          simpleMDE = new SimpleMDE({
            element: document.getElementById('postContent'),
            spellChecker: false,
            placeholder: '输入Markdown内容...'
          });
        }
        
        // 如果切换到Markdown，将HTML内容转换为Markdown显示
        if (currentContent) {
          if (currentContent.trim().startsWith('<')) {
            // HTML内容，转换为Markdown
            const markdownContent = htmlToMarkdown(currentContent);
            simpleMDE.value(markdownContent);
          } else {
            // 已经是Markdown内容，直接使用
            simpleMDE.value(currentContent);
          }
        } else {
          // 没有内容，清空
          simpleMDE.value('');
        }
      } else {
        // HTML模式
        markdownContainer.style.display = 'none';
        htmlContainer.style.display = 'block';
        
        // 初始化WangEditor编辑器（如果还没有初始化）
        if (!wangEditor) {
          await initQuillEditor();
          // 等待WangEditor完全初始化
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // 如果切换到HTML，将Markdown内容转换为HTML
        if (currentContent && wangEditor) {
          if (currentContent.trim().startsWith('<')) {
            // 已经是HTML内容，直接使用
            wangEditor.setHtml(currentContent);
          } else {
            // Markdown内容，转换为HTML（使用async函数）
            markdownToHtml(currentContent).then(htmlContent => {
              if (wangEditor) {
                wangEditor.setHtml(htmlContent);
              }
            }).catch(error => {
              console.error('Markdown转换失败:', error);
              if (wangEditor) {
                wangEditor.setHtml('<p>转换失败: ' + escapeHtml(error.message) + '</p>');
              }
            });
          }
        } else if (wangEditor) {
          // 没有内容，清空
          wangEditor.setHtml('');
        }
      }
    }
    
    // HTML转Markdown的辅助函数
    function htmlToMarkdown(html) {
      if (!html) return '';
      
      let markdown = html
        // 标题
        .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
        .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
        .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
        .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n')
        .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n\n')
        .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n\n')
        // 粗体和斜体
        .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
        .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
        .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
        .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
        // 链接
        .replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, '[$2]($1)')
        // 图片
        .replace(/<img[^>]*src=["']([^"']*)["'][^>]*alt=["']([^"']*)["'][^>]*>/gi, '![$2]($1)')
        .replace(/<img[^>]*src=["']([^"']*)["'][^>]*>/gi, '![]($1)')
        // 列表
        .replace(/<ul[^>]*>/gi, '')
        .replace(/<\/ul>/gi, '\n')
        .replace(/<ol[^>]*>/gi, '')
        .replace(/<\/ol>/gi, '\n')
        .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
        // 代码块
        .replace(/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/gis, '```\n$1\n```\n')
        .replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`')
        // 段落和换行
        .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
        .replace(/<br[^>]*>/gi, '\n')
        .replace(/<div[^>]*>(.*?)<\/div>/gis, '$1\n')
        // 移除所有剩余的HTML标签
        .replace(/<[^>]+>/g, '')
        // 清理多余的空行
        .replace(/\n{3,}/g, '\n\n')
        .trim();
      
      return markdown;
    }
    
    // Markdown转HTML的辅助函数（使用marked.js）
    async function markdownToHtml(markdown) {
      if (!markdown) return '';
      
      // 如果已经是HTML，直接返回
      if (markdown.trim().startsWith('<')) {
        return markdown;
      }
      
      // 使用marked.js进行转换
      if (typeof marked !== 'undefined') {
        try {
          // 配置marked选项
          marked.setOptions({
            breaks: true, // 支持GFM换行
            gfm: true, // 启用GitHub Flavored Markdown
            headerIds: true,
            mangle: false
          });
          return marked.parse(markdown);
        } catch (error) {
          console.error('Markdown转换失败，使用简单转换:', error);
          // 如果marked.js转换失败，使用简单转换作为后备
        }
      }
      
      // 后备方案：简单转换（如果marked.js未加载）
      let html = markdown
        // 标题
        .replace(/^###### (.*?)$/gm, '<h6>$1</h6>')
        .replace(/^##### (.*?)$/gm, '<h5>$1</h5>')
        .replace(/^#### (.*?)$/gm, '<h4>$1</h4>')
        .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
        .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
        // 粗体和斜体
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // 链接
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        // 图片
        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')
        // 代码块
        .replace(/```([^`]+)```/gs, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // 列表
        .replace(/^\- (.*?)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        // 段落（处理双换行）
        .split(/\n\n+/)
        .map(para => {
          para = para.trim();
          if (!para) return '';
          // 如果已经是HTML标签，不包装
          if (para.match(/^<(h[1-6]|ul|ol|pre|code|div)/)) {
            return para;
          }
          return '<p>' + para.replace(/\n/g, '<br>') + '</p>';
        })
        .join('\n');
      
      return html;
    }
    
    // 初始化WangEditor v5 HTML编辑器
    function initQuillEditor() {
      // 兼容性：保持函数名不变，内部使用WangEditor
      return initWangEditor();
    }
    
    async function initWangEditor() {
      // 检查WangEditor是否已加载（WangEditor v5使用window.wangEditor）
      // 等待WangEditor加载
      return new Promise((resolve) => {
        let checkCount = 0;
        const maxChecks = 50; // 最多检查5秒（50 * 100ms）
        
        const checkWangEditor = setInterval(() => {
          checkCount++;
          
          // 检查window.wangEditor是否存在
          if (typeof window.wangEditor !== 'undefined' && 
              window.wangEditor && 
              window.wangEditor.createEditor && 
              window.wangEditor.createToolbar) {
            clearInterval(checkWangEditor);
            console.log('WangEditor已加载，开始初始化编辑器');
            try {
              initWangEditorInternal();
              resolve();
            } catch (e) {
              console.error('WangEditor初始化失败:', e);
              showToast('HTML编辑器初始化失败: ' + e.message, 'error');
              resolve();
            }
          } else if (checkCount >= maxChecks) {
            clearInterval(checkWangEditor);
            console.error('WangEditor加载超时', {
              windowWangEditor: typeof window.wangEditor,
              wangEditorType: typeof wangEditor,
              checkCount: checkCount
            });
            showToast('HTML编辑器加载失败，请刷新页面重试', 'error');
            resolve();
          }
        }, 100);
      });
    }
    
    function initWangEditorInternal() {
      const editorContainer = document.getElementById('postHtmlContent');
      if (!editorContainer) {
        console.error('编辑器容器不存在');
        return;
      }
      
      // 如果已经初始化，先销毁
      if (wangEditor) {
        try {
          wangEditor.destroy();
          wangEditor = null;
        } catch (e) {
          console.warn('销毁编辑器时出错:', e);
        }
      }
      
      // 清空容器内容，创建编辑器和工具栏容器
      editorContainer.innerHTML = `
        <div id="wang-editor-toolbar" style="border: 1px solid #ccc; border-bottom: none;"></div>
        <div id="wang-editor-container" style="border: 1px solid #ccc; min-height: 500px;"></div>
      `;
      
      try {
        // 使用CDN版本的WangEditor（@wangeditor/editor v5）
        // WangEditor v5通过CDN加载后，通过window.wangEditor导出
        if (typeof window.wangEditor === 'undefined') {
          console.error('WangEditor未加载，请检查CDN链接');
          throw new Error('WangEditor未正确加载，请检查CDN链接和CSP策略');
        }
        
        const { createEditor, createToolbar } = window.wangEditor;
        
        if (!createEditor || !createToolbar) {
          console.error('WangEditor API不存在:', window.wangEditor);
          throw new Error('WangEditor API未正确导出，请检查CDN版本');
        }
        
        // WangEditor v5配置
        const editorConfig = {
          placeholder: '输入HTML内容...',
          MENU_CONF: {
            uploadImage: {
              server: '/api/admin/custom-apis/upload-image',
              fieldName: 'image',
              maxFileSize: 10 * 1024 * 1024, // 10MB
              allowedFileTypes: ['image/*'],
              withCredentials: true,
              customUpload: async (file, insertFn) => {
                try {
                  const imageUrl = await uploadImageToServer(file);
                  // 插入带响应式样式的图片
                  const imageHtml = `<img src="${imageUrl}" alt="${file.name}" style="max-width: 100%; height: auto; display: block; margin: 1rem auto; border-radius: 0.375rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />`;
                  if (wangEditor && wangEditor.dangerouslyInsertHtml) {
                    wangEditor.dangerouslyInsertHtml(imageHtml);
                  } else {
                    insertFn(imageUrl, file.name, imageUrl);
                  }
                  showToast('图片上传成功', 'success');
                } catch (error) {
                  showToast('图片上传失败: ' + error.message, 'error');
                }
              }
            },
            uploadVideo: {
              server: '/api/admin/custom-apis/upload-video',
              fieldName: 'video',
              maxFileSize: 200 * 1024 * 1024, // 200MB
              allowedFileTypes: ['video/*'],
              withCredentials: true,
              customUpload: async (file, insertFn) => {
                // 创建全局进度显示
                const globalProgressId = 'wangEditorVideoProgress';
                let progressContainer = document.getElementById(globalProgressId);
                
                if (!progressContainer) {
                  progressContainer = document.createElement('div');
                  progressContainer.id = globalProgressId;
                  progressContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; background: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10001; min-width: 300px; max-width: 400px;';
                  progressContainer.innerHTML = `
                    <div style="margin-bottom: 0.5rem; font-weight: 600; color: #333;">视频上传中...</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                      <div style="flex: 1; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
                        <div id="wangEditorVideoProgressBar" style="height: 100%; background: #9333ea; width: 0%; transition: width 0.3s;"></div>
                      </div>
                      <span id="wangEditorVideoStatus" style="font-size: 0.875rem; color: #6b7280; white-space: nowrap; min-width: 60px; text-align: right;">0%</span>
                    </div>
                    <div id="wangEditorVideoMessage" style="font-size: 0.75rem; color: #6b7280;">准备上传...</div>
                  `;
                  document.body.appendChild(progressContainer);
                } else {
                  // 重置进度
                  const progressBar = document.getElementById('wangEditorVideoProgressBar');
                  const statusSpan = document.getElementById('wangEditorVideoStatus');
                  const messageSpan = document.getElementById('wangEditorVideoMessage');
                  if (progressBar) progressBar.style.width = '0%';
                  if (statusSpan) statusSpan.textContent = '0%';
                  if (messageSpan) messageSpan.textContent = '准备上传...';
                  progressContainer.style.display = 'block';
                }
                
                const progressBar = document.getElementById('wangEditorVideoProgressBar');
                const statusSpan = document.getElementById('wangEditorVideoStatus');
                const messageSpan = document.getElementById('wangEditorVideoMessage');
                
                try {
                  const videoInfo = await uploadVideoToServer(file, (progress, message) => {
                    // 更新全局进度显示
                    if (progressBar && statusSpan) {
                      progressBar.style.width = Math.min(Math.max(progress, 0), 100) + '%';
                      statusSpan.textContent = `${Math.round(progress)}%`;
                      if (progress >= 100) {
                        statusSpan.style.color = '#10b981'; // 绿色表示完成
                      } else {
                        statusSpan.style.color = '#6b7280'; // 灰色表示进行中
                      }
                    }
                    if (messageSpan && message) {
                      messageSpan.textContent = message;
                    }
                  });
                  
                  // 完成
                  if (progressBar && statusSpan && messageSpan) {
                    progressBar.style.width = '100%';
                    statusSpan.textContent = '100%';
                    statusSpan.style.color = '#10b981';
                    messageSpan.textContent = '上传完成！';
                  }
                  
                  // 使用WangEditor v5的标准方法插入视频
                  // insertFn是WangEditor提供的标准插入函数，会自动创建正确的Slate节点结构
                  let inserted = false;
                  
                  try {
                    // 确保编辑器有焦点，这样可以确保光标位置正确
                    if (wangEditor && wangEditor.focus) {
                      wangEditor.focus();
                    }
                    
                    // insertFn的参数: (videoUrl, posterUrl)
                    // 根据WangEditor v5文档，insertFn接收视频URL和可选的poster URL
                    const posterUrl = videoInfo.posterUrl || '';
                    
                    // 调用WangEditor提供的标准插入函数
                    // 这个函数会自动创建正确的Slate节点结构（包括data-slate-node等属性）
                    insertFn(videoInfo.url, posterUrl);
                    inserted = true;
                    showToast('视频上传成功', 'success');
                  } catch (error) {
                    console.error('insertFn插入视频失败:', error);
                    console.log('尝试使用备用方法插入视频...');
                    
                    // 如果insertFn失败，尝试使用WangEditor的API
                    if (wangEditor) {
                      try {
                        // 方法1: 尝试使用restoreSelection和insertNode
                        if (wangEditor.restoreSelection && wangEditor.insertNode) {
                          wangEditor.restoreSelection();
                          const videoNode = {
                            type: 'video',
                            src: videoInfo.url,
                            poster: videoInfo.posterUrl || ''
                          };
                          wangEditor.insertNode(videoNode);
                          inserted = true;
                          showToast('视频上传成功', 'success');
                        } 
                        // 方法2: 直接使用insertNode（如果restoreSelection不存在）
                        else if (wangEditor.insertNode) {
                          const videoNode = {
                            type: 'video',
                            src: videoInfo.url,
                            poster: videoInfo.posterUrl || ''
                          };
                          wangEditor.insertNode(videoNode);
                          inserted = true;
                          showToast('视频上传成功', 'success');
                        } 
                        // 方法3: 使用setHtml追加（最后的后备方案）
                        else if (wangEditor.getHtml && wangEditor.setHtml) {
                          const currentHtml = wangEditor.getHtml() || '';
                          const videoHtml = `<p><video src="${videoInfo.url}"${videoInfo.posterUrl ? ` poster="${videoInfo.posterUrl}"` : ''} controls></video></p>`;
                          wangEditor.setHtml(currentHtml + videoHtml);
                          inserted = true;
                          showToast('视频上传成功', 'success');
                        }
                      } catch (e) {
                        console.error('所有插入方法都失败:', e);
                        showToast('视频上传成功，但插入编辑器失败，请手动插入视频URL: ' + videoInfo.url, 'warning');
                      }
                    } else {
                      console.error('编辑器未初始化');
                      showToast('视频上传成功，但编辑器未初始化，请手动插入视频URL: ' + videoInfo.url, 'warning');
                    }
                  }
                  
                  if (!inserted) {
                    console.warn('视频插入失败，视频URL:', videoInfo.url);
                  }
                  
                  // 3秒后隐藏进度条
                  setTimeout(() => {
                    if (progressContainer) {
                      progressContainer.style.display = 'none';
                    }
                  }, 3000);
                } catch (error) {
                  // 显示错误
                  if (progressBar && statusSpan && messageSpan) {
                    progressBar.style.width = '0%';
                    statusSpan.textContent = '失败';
                    statusSpan.style.color = '#ef4444';
                    messageSpan.textContent = '上传失败: ' + error.message;
                  }
                  
                  showToast('视频上传失败: ' + error.message, 'error');
                  
                  // 5秒后隐藏进度条
                  setTimeout(() => {
                    if (progressContainer) {
                      progressContainer.style.display = 'none';
                    }
                  }, 5000);
                }
              }
            }
          }
        };
        
        // 创建编辑器
        wangEditor = createEditor({
          selector: '#wang-editor-container',
          config: editorConfig,
          mode: 'default'
        });
        
        // 创建工具栏
        const toolbar = createToolbar({
          editor: wangEditor,
          selector: '#wang-editor-toolbar',
          config: {},
          mode: 'default'
        });
        
        // 监听粘贴事件，处理粘贴的图片文件和外部图片URL
        const editorDom = document.getElementById('wang-editor-container');
        if (editorDom) {
          editorDom.addEventListener('paste', async function(e) {
            const clipboardData = e.clipboardData || window.clipboardData;
            if (!clipboardData) return;
            
            // 检查剪贴板中是否有base64图片数据
            const pasteData = clipboardData.getData('text/html');
            if (pasteData && (pasteData.includes('data:image') || pasteData.includes('data:video'))) {
              // 如果包含base64图片或视频，阻止默认行为
              e.preventDefault();
              showToast('检测到base64内容，请使用上传功能上传文件', 'warning');
              return;
            }
            
            const items = clipboardData.items;
            let hasImageFile = false;
            let externalImageUrl = null;
            
            // 检查是否有图片文件
            for (let i = 0; i < items.length; i++) {
              const item = items[i];
              if (item.kind === 'file' && item.type.indexOf('image') !== -1) {
                hasImageFile = true;
                break;
              }
            }
            
            // 如果没有图片文件，检查HTML内容中是否有外部图片URL
            if (!hasImageFile) {
              const htmlPromise = new Promise((resolve) => {
                for (let i = 0; i < items.length; i++) {
                  const item = items[i];
                  if (item.kind === 'string' && item.type === 'text/html') {
                    item.getAsString(function(html) {
                      resolve(html);
                    });
                    return;
                  }
                }
                resolve(null);
              });
              
              const html = await htmlPromise;
              if (html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const images = doc.querySelectorAll('img');
                
                if (images.length > 0) {
                  const imgSrc = images[0].src;
                  if (imgSrc && !imgSrc.startsWith('data:') && !imgSrc.startsWith('blob:')) {
                    try {
                      const currentHost = window.location.host;
                      const imgUrl = new URL(imgSrc, window.location.origin);
                      if (imgUrl.host !== currentHost && imgUrl.host !== '') {
                        externalImageUrl = imgSrc;
                      }
                    } catch (e) {
                      // URL解析失败，忽略
                    }
                  }
                }
              }
            }
            
            // 如果有图片文件，阻止默认行为并上传
            if (hasImageFile) {
              e.preventDefault();
              
              for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.kind === 'file' && item.type.indexOf('image') !== -1) {
                  const file = item.getAsFile();
                  if (!file) continue;
                  
                  if (file.size > 10 * 1024 * 1024) {
                    showToast('图片文件大小不能超过10MB', 'error');
                    continue;
                  }
                  
                  try {
                    const imageUrl = await uploadImageToServer(file);
                    // 插入带响应式样式的图片
                    const imageHtml = `<img src="${imageUrl}" alt="${file.name}" style="max-width: 100%; height: auto; display: block; margin: 1rem auto; border-radius: 0.375rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />`;
                    if (wangEditor && wangEditor.dangerouslyInsertHtml) {
                      wangEditor.dangerouslyInsertHtml(imageHtml);
                    } else if (wangEditor && wangEditor.insertNode) {
                      const imageNode = {
                        type: 'image',
                        src: imageUrl,
                        alt: file.name,
                        href: ''
                      };
                      wangEditor.insertNode(imageNode);
                    }
                    showToast('图片上传成功', 'success');
                  } catch (error) {
                    showToast('图片上传失败: ' + error.message, 'error');
                  }
                  break;
                }
              }
            } else if (externalImageUrl) {
              // 如果有外部图片URL，阻止默认行为，下载并上传
              e.preventDefault();
              
              try {
                const response = await fetch(externalImageUrl, { 
                  mode: 'cors',
                  credentials: 'omit'
                });
                
                if (!response.ok) {
                  throw new Error('下载图片失败: ' + response.statusText);
                }
                
                const blob = await response.blob();
                
                if (blob.size > 10 * 1024 * 1024) {
                  throw new Error('图片文件大小不能超过10MB');
                }
                
                if (!blob.type.startsWith('image/')) {
                  throw new Error('下载的文件不是图片格式');
                }
                
                const fileExtension = blob.type.split('/')[1] || 'jpg';
                const fileName = `image.${fileExtension}`;
                const file = new File([blob], fileName, { type: blob.type });
                
                const imageUrl = await uploadImageToServer(file);
                
                // 插入带响应式样式的图片
                const imageHtml = `<img src="${imageUrl}" alt="${fileName}" style="max-width: 100%; height: auto; display: block; margin: 1rem auto; border-radius: 0.375rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />`;
                if (wangEditor && wangEditor.dangerouslyInsertHtml) {
                  wangEditor.dangerouslyInsertHtml(imageHtml);
                } else if (wangEditor && wangEditor.insertNode) {
                  const imageNode = {
                    type: 'image',
                    src: imageUrl,
                    alt: fileName,
                    href: ''
                  };
                  wangEditor.insertNode(imageNode);
                }
                
                showToast('图片上传成功', 'success');
              } catch (error) {
                showToast('图片上传失败: ' + error.message, 'error');
                console.error('下载并上传外部图片失败:', error);
              }
            }
          });
          
          // 添加拖放上传图片功能
          // 阻止默认的拖放行为
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            editorDom.addEventListener(eventName, function(e) {
              e.preventDefault();
              e.stopPropagation();
            });
          });
          
          // 添加拖放区域视觉反馈
          ['dragenter', 'dragover'].forEach(eventName => {
            editorDom.addEventListener(eventName, function() {
              editorDom.style.border = '2px dashed #3b82f6';
              editorDom.style.backgroundColor = '#eff6ff';
            });
          });
          
          ['dragleave', 'drop'].forEach(eventName => {
            editorDom.addEventListener(eventName, function() {
              editorDom.style.border = '';
              editorDom.style.backgroundColor = '';
            });
          });
          
          // 处理文件拖放
          editorDom.addEventListener('drop', async function(e) {
            const files = e.dataTransfer.files;
            
            if (!files || files.length === 0) return;
            
            for (let i = 0; i < files.length; i++) {
              const file = files[i];
              
              if (!file.type.startsWith('image/')) {
                continue;
              }
              
              if (file.size > 10 * 1024 * 1024) {
                showToast(`图片 ${file.name} 大小超过10MB，已跳过`, 'error');
                continue;
              }
              
              try {
                const imageUrl = await uploadImageToServer(file);
                  // 插入带响应式样式的图片
                  const imageHtml = `<img src="${imageUrl}" alt="${file.name}" style="max-width: 100%; height: auto; display: block; margin: 1rem auto; border-radius: 0.375rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" />`;
                  if (wangEditor && wangEditor.dangerouslyInsertHtml) {
                    wangEditor.dangerouslyInsertHtml(imageHtml);
                  } else if (wangEditor && wangEditor.insertNode) {
                    const imageNode = {
                      type: 'image',
                      src: imageUrl,
                      alt: file.name,
                      href: ''
                    };
                    wangEditor.insertNode(imageNode);
                  }
                showToast(`图片 ${file.name} 上传成功`, 'success');
              } catch (error) {
                showToast(`图片 ${file.name} 上传失败: ${error.message}`, 'error');
                console.error('拖放上传图片失败:', error);
              }
            }
          });
        }
        
        console.log('WangEditor v5编辑器初始化成功', {
          editor: wangEditor,
          container: document.getElementById('wang-editor-container'),
          toolbar: document.getElementById('wang-editor-toolbar')
        });
      } catch (error) {
        console.error('初始化WangEditor编辑器失败:', error);
        console.error('错误详情:', {
          message: error.message,
          stack: error.stack,
          windowWangEditor: typeof window.wangEditor,
          wangEditor: typeof wangEditor
        });
        
        // 显示错误信息并恢复容器
        const editorContainer = document.getElementById('postHtmlContent');
        if (editorContainer) {
          editorContainer.innerHTML = `
            <div style="padding: 2rem; text-align: center; color: #ef4444; border: 1px solid #ef4444; border-radius: 0.375rem; background: #fef2f2;">
              <p style="margin: 0 0 1rem 0; font-weight: 500;">编辑器加载失败</p>
              <p style="margin: 0; font-size: 0.875rem;">${error.message}</p>
              <p style="margin: 1rem 0 0 0; font-size: 0.875rem;">请刷新页面重试，或检查浏览器控制台获取更多信息。</p>
            </div>
          `;
        }
        showToast('HTML编辑器初始化失败: ' + error.message, 'error');
      }
    }
    
    // Video handler已集成到WangEditor配置中，此函数保留用于兼容
    function initVideoHandler() {
                  // 创建视频插入对话框（WangEditor已支持视频上传）
                  const dialog = document.createElement('div');
                  dialog.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 10000; min-width: 400px; max-width: 600px;';
                  
                  dialog.innerHTML = `
                    <h3 style="margin-top: 0; margin-bottom: 1rem; color: #333;">插入视频</h3>
                    <div style="margin-bottom: 1rem;">
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">视频URL：</label>
                      <input type="text" id="videoUrlInput" placeholder="输入视频URL" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">或上传视频文件：</label>
                      <input type="file" id="videoFileInput" accept="video/*" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">视频格式：</label>
                      <select id="videoFormatSelect" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; box-sizing: border-box;">
                        <option value="video-tag">方式1: video标签（带src，符合示例格式）</option>
                        <option value="video-source">方式2: video标签（带source）</option>
                        <option value="youtube-iframe">方式3: YouTube iframe嵌入</option>
                        <option value="video-link">方式4: 视频链接</option>
                      </select>
                      <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                        方式1格式：&lt;video src="..." poster="..."&gt;&lt;/video&gt;
                      </p>
                    </div>
                    <div style="margin-bottom: 1rem;" id="posterUrlContainer">
                      <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">封面图片URL（可选）：</label>
                      <input type="text" id="posterUrlInput" placeholder="输入封面图片URL" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.25rem; box-sizing: border-box;">
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                      <button id="videoInsertCancel" style="padding: 0.5rem 1rem; background: #e5e7eb; border: none; border-radius: 0.25rem; cursor: pointer;">取消</button>
                      <button id="videoInsertConfirm" style="padding: 0.5rem 1rem; background: #9333ea; color: white; border: none; border-radius: 0.25rem; cursor: pointer;">插入</button>
                    </div>
                  `;
                  
                  // 添加遮罩层
                  const overlay = document.createElement('div');
                  overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;';
                  
                  document.body.appendChild(overlay);
                  document.body.appendChild(dialog);
                  
                  // 根据格式选择显示/隐藏封面输入框
                  const formatSelect = dialog.querySelector('#videoFormatSelect');
                  const posterContainer = dialog.querySelector('#posterUrlContainer');
                  const urlInput = dialog.querySelector('#videoUrlInput');
                  
                  // 初始化显示状态
                  if (formatSelect.value === 'video-tag' || formatSelect.value === 'video-source') {
                    posterContainer.style.display = 'block';
                  } else {
                    posterContainer.style.display = 'none';
                  }
                  
                  formatSelect.addEventListener('change', function() {
                    if (this.value === 'video-tag' || this.value === 'video-source') {
                      posterContainer.style.display = 'block';
                    } else {
                      posterContainer.style.display = 'none';
                    }
                    
                    // 如果是YouTube格式，更新提示
                    if (this.value === 'youtube-iframe') {
                      urlInput.placeholder = '输入YouTube视频URL或视频ID（如：https://www.youtube.com/watch?v=VIDEO_ID 或 VIDEO_ID）';
                    } else {
                      urlInput.placeholder = '输入视频URL';
                    }
                  });
                  
                  // 添加进度显示元素
                  const progressContainer = document.createElement('div');
                  progressContainer.id = 'videoUploadProgress';
                  progressContainer.style.cssText = 'display: none; margin-top: 1rem; margin-bottom: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 0.25rem; border: 1px solid #e5e7eb;';
                  progressContainer.innerHTML = `
                    <div style="margin-bottom: 0.5rem; font-weight: 600; color: #333; font-size: 0.875rem;">视频上传进度</div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <div style="flex: 1; height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden;">
                        <div id="videoUploadProgressBar" style="height: 100%; background: linear-gradient(90deg, #9333ea, #a855f7); width: 0%; transition: width 0.3s ease;"></div>
                      </div>
                      <span id="videoUploadStatus" style="font-size: 0.875rem; color: #6b7280; white-space: nowrap; min-width: 80px; text-align: right; font-weight: 500;">0%</span>
                    </div>
                    <div id="videoUploadMessage" style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">准备上传...</div>
                  `;
                  // 插入到poster输入框之后，按钮之前（posterContainer已在上面声明）
                  if (posterContainer && posterContainer.nextSibling) {
                    posterContainer.parentNode.insertBefore(progressContainer, posterContainer.nextSibling);
                  } else {
                    // 如果找不到，插入到按钮容器之前
                    const buttonContainer = dialog.querySelector('div[style*="flex"][style*="justify-content: flex-end"]');
                    if (buttonContainer && buttonContainer.parentNode) {
                      buttonContainer.parentNode.insertBefore(progressContainer, buttonContainer);
                    } else {
                      // 最后的后备方案：插入到对话框内容的最后
                      dialog.appendChild(progressContainer);
                    }
                  }
                  
                  // 上传状态标志（在对话框作用域内）
                  let isUploading = false;
                  
                  // 禁用/启用对话框控件的辅助函数
                  function setDialogControlsEnabled(enabled) {
                    isUploading = !enabled;
                    const urlInput = dialog.querySelector('#videoUrlInput');
                    const fileInput = dialog.querySelector('#videoFileInput');
                    const formatSelect = dialog.querySelector('#videoFormatSelect');
                    const posterInput = dialog.querySelector('#posterUrlInput');
                    const cancelBtn = dialog.querySelector('#videoInsertCancel');
                    const confirmBtn = dialog.querySelector('#videoInsertConfirm');
                    
                    const controls = [urlInput, fileInput, formatSelect, posterInput, cancelBtn, confirmBtn];
                    controls.forEach(control => {
                      if (control) {
                        control.disabled = !enabled;
                        if (control.style) {
                          control.style.opacity = enabled ? '1' : '0.6';
                          control.style.cursor = enabled ? '' : 'not-allowed';
                        }
                      }
                    });
                    
                    // 禁用/启用遮罩层点击（overlay在外部作用域）
                    // overlay变量在initVideoHandler函数的作用域中，这里通过闭包访问
                    try {
                      if (typeof overlay !== 'undefined' && overlay) {
                        overlay.style.pointerEvents = enabled ? 'auto' : 'none';
                      }
                    } catch (e) {
                      // 如果overlay不可访问，忽略错误
                    }
                  }
                  
                  // 文件选择处理
                  const fileInput = dialog.querySelector('#videoFileInput');
                  fileInput.addEventListener('change', async function() {
                    const file = this.files[0];
                    if (!file) return;
                    
                    // 验证文件类型
                    if (!file.type.startsWith('video/')) {
                      showToast('请选择视频文件', 'error');
                      this.value = '';
                      return;
                    }
                    
                    // 验证文件大小（200MB）
                    if (file.size > 200 * 1024 * 1024) {
                      showToast('视频文件大小不能超过200MB', 'error');
                      this.value = '';
                      return;
                    }
                    
                    // 显示进度条
                    progressContainer.style.display = 'block';
                    const progressBar = dialog.querySelector('#videoUploadProgressBar');
                    const statusSpan = dialog.querySelector('#videoUploadStatus');
                    const messageSpan = dialog.querySelector('#videoUploadMessage');
                    
                    // 重置进度
                    if (progressBar) progressBar.style.width = '0%';
                    if (statusSpan) {
                      statusSpan.textContent = '0%';
                      statusSpan.style.color = '#6b7280';
                    }
                    if (messageSpan) messageSpan.textContent = '准备上传...';
                    
                    // 禁用所有控件，防止用户操作
                    setDialogControlsEnabled(false);
                    
                    // 检查文件格式
                    const ext = file.name.split('.').pop().toLowerCase();
                    const needsConversion = ext !== 'mp4';
                    
                    try {
                      // 上传视频（带进度回调）- 进度已合并为0-100%
                      const videoInfo = await uploadVideoToServer(file, (progress, message) => {
                        // 确保进度条和状态元素存在
                        if (progressBar) {
                          progressBar.style.width = Math.min(Math.max(progress, 0), 100) + '%';
                        }
                        if (statusSpan) {
                          statusSpan.textContent = `${Math.round(progress)}%`;
                          // 更新颜色
                          if (progress >= 100) {
                            statusSpan.style.color = '#10b981'; // 绿色表示完成
                          } else {
                            statusSpan.style.color = '#6b7280'; // 灰色表示进行中
                          }
                        }
                        if (messageSpan && message) {
                          messageSpan.textContent = message;
                        }
                      });
                      
                      // 完成进度
                      if (progressBar) progressBar.style.width = '100%';
                      if (statusSpan) {
                        statusSpan.textContent = '100%';
                        statusSpan.style.color = '#10b981'; // 绿色表示完成
                      }
                      if (messageSpan) messageSpan.textContent = '处理完成！';
                      
                      // 将视频URL填充到输入框，等待用户点击"插入"按钮
                      dialog.querySelector('#videoUrlInput').value = videoInfo.url;
                      
                      // 如果有poster URL，自动填充到poster输入框
                      if (videoInfo.posterUrl) {
                        dialog.querySelector('#posterUrlInput').value = videoInfo.posterUrl;
                        // 确保poster输入框可见（如果格式支持）
                        // 使用dialog重新查询，避免作用域问题
                        const posterContainerEl = dialog.querySelector('#posterUrlContainer');
                        if (posterContainerEl && (formatSelect.value === 'video-tag' || formatSelect.value === 'video-source')) {
                          posterContainerEl.style.display = 'block';
                        }
                      }
                      
                      const successMessage = videoInfo.converted 
                        ? '视频上传成功，已自动转换为MP4格式，请点击"插入"按钮插入视频'
                        : '视频上传成功，请点击"插入"按钮插入视频';
                      showToast(successMessage, 'success');
                      
                      // 恢复所有控件
                      setDialogControlsEnabled(true);
                      
                      // 不自动关闭对话框，等待用户点击"插入"按钮
                    } catch (error) {
                      // 显示错误
                      if (progressBar) progressBar.style.width = '0%';
                      if (statusSpan) {
                        statusSpan.textContent = '失败';
                        statusSpan.style.color = '#ef4444'; // 红色表示错误
                      }
                      if (messageSpan) messageSpan.textContent = '上传失败: ' + error.message;
                      
                      // 恢复所有控件
                      setDialogControlsEnabled(true);
                      
                      // 检查是否是格式不兼容错误
                      let errorMessage = error.message;
                      if (errorMessage.includes('格式不兼容') || errorMessage.includes('无法转换为MP4')) {
                        errorMessage = `视频格式不兼容：${errorMessage}。建议使用MP4格式的视频文件。`;
                      } else if (errorMessage.includes('ffmpeg')) {
                        errorMessage = `视频转换失败：${errorMessage}。请确保服务器已安装ffmpeg，或使用MP4格式的视频文件。`;
                      }
                      
                      showToast('视频上传失败: ' + errorMessage, 'error');
                      
                      // 5秒后重置状态文本颜色
                      setTimeout(() => {
                        if (statusSpan) {
                          statusSpan.style.color = '#6b7280';
                        }
                      }, 5000); // 错误信息显示5秒
                    }
                  });
                  
                  // 确认按钮处理
                  dialog.querySelector('#videoInsertConfirm').addEventListener('click', function() {
                    const videoUrl = dialog.querySelector('#videoUrlInput').value.trim();
                    const format = formatSelect.value;
                    let posterUrl = dialog.querySelector('#posterUrlInput').value.trim();
                    
                    if (!videoUrl) {
                      showToast('请输入视频URL或选择视频文件', 'error');
                      return;
                    }
                    
                    // 验证poster URL（必须是图片，不能是视频）
                    if (posterUrl) {
                      const fullPosterUrl = ensureFullUrl(posterUrl);
                      if (!isValidPosterUrl(fullPosterUrl)) {
                        showToast('封面图片URL不能是视频文件，请输入图片URL（如.jpg、.png等）', 'error');
                        return;
                      }
                    }
                    
                    // 如果是YouTube格式，验证URL格式
                    if (format === 'youtube-iframe') {
                      const youtubePattern = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                      if (!youtubePattern.test(videoUrl) && !/^[a-zA-Z0-9_-]{11}$/.test(videoUrl)) {
                        showToast('请输入有效的YouTube视频URL或视频ID', 'error');
                        return;
                      }
                    }
                    
                    try {
                      // 确保URL是完整的网络地址（兼容小程序等环境）
                      const fullVideoUrl = ensureFullUrl(videoUrl);
                      // poster URL验证已在generateVideoHtml函数中处理
                      const fullPosterUrl = posterUrl ? ensureFullUrl(posterUrl) : '';
                      
                      // 根据选择的格式生成视频HTML（会自动验证poster URL）
                      const videoHtml = generateVideoHtml(fullVideoUrl, format, fullPosterUrl);
                      
                      // 使用WangEditor插入HTML
                      if (wangEditor && wangEditor.dangerouslyInsertHtml) {
                        wangEditor.dangerouslyInsertHtml(`<div class="video-block">${videoHtml}</div><p><br></p>`);
                      } else if (wangEditor && wangEditor.insertNode) {
                        // 如果支持insertNode，创建视频节点（使用完整URL）
                        // 确保poster是有效的图片URL（generateVideoHtml已经验证过）
                        const validPosterUrl = fullPosterUrl && isValidPosterUrl(fullPosterUrl) ? fullPosterUrl : '';
                        const videoNode = {
                          type: 'video',
                          src: fullVideoUrl,
                          poster: validPosterUrl
                        };
                        wangEditor.insertNode(videoNode);
                      } else {
                        // 后备方案：直接插入HTML
                        const currentHtml = wangEditor ? wangEditor.getHtml() : '';
                        if (wangEditor) {
                          wangEditor.setHtml(currentHtml + `<div class="video-block">${videoHtml}</div><p><br></p>`);
                        }
                      }
                      
                      showToast('视频插入成功', 'success');
                      
                      // 关闭对话框
                      document.body.removeChild(overlay);
                      document.body.removeChild(dialog);
                    } catch (error) {
                      console.error('插入视频失败:', error);
                      showToast('插入视频失败: ' + error.message, 'error');
                    }
                  });
                  
                  // 取消按钮处理
                  dialog.querySelector('#videoInsertCancel').addEventListener('click', function() {
                    // 如果正在上传，不允许关闭
                    if (isUploading) {
                      showToast('正在上传视频，请稍候...', 'warning');
                      return;
                    }
                    document.body.removeChild(overlay);
                    document.body.removeChild(dialog);
                  });
                  
                  // 点击遮罩层关闭
                  overlay.addEventListener('click', function() {
                    // 如果正在上传，不允许关闭
                    if (isUploading) {
                      showToast('正在上传视频，请稍候...', 'warning');
                      return;
                    }
                    document.body.removeChild(overlay);
                    document.body.removeChild(dialog);
                  });
                  
                  // 聚焦URL输入框
                  dialog.querySelector('#videoUrlInput').focus();
    }
    
    // 隐藏文章表单
    function hidePostForm() {
      document.getElementById('postForm').style.display = 'none';
      // 如果是在新窗口中打开的，关闭窗口
      if (window.opener) {
        window.close();
      }
    }

    // 天气路况数据管理
    let weatherAttractionsCounter = 0;
    let weatherTrafficCounter = 0;
    
    // 添加景点天气
    function addWeatherAttraction(attraction = null) {
      const container = document.getElementById('weatherAttractionsList');
      const index = attraction ? attraction._index : weatherAttractionsCounter++;
      const itemId = attraction ? attraction.id : '';
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'weather-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #3b82f6;">景点 #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeWeatherAttraction(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> 删除
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ID</label>
            <input type="number" class="admin-form-input weather-attraction-id" value="${itemId}" placeholder="自动生成" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">景点名称 *</label>
            <input type="text" class="admin-form-input weather-attraction-name" value="${attraction ? escapeHtml(attraction.name || '') : ''}" placeholder="如：金字塔" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">温度 (°C) *</label>
            <input type="number" class="admin-form-input weather-attraction-temperature" value="${attraction ? attraction.temperature || '' : ''}" placeholder="如：36" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">能见度</label>
            <input type="text" class="admin-form-input weather-attraction-visibility" value="${attraction ? escapeHtml(attraction.visibility || '') : ''}" placeholder="如：高、中、低" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">紫外线指数</label>
            <input type="number" class="admin-form-input weather-attraction-uvIndex" value="${attraction ? attraction.uvIndex || '' : ''}" placeholder="如：10" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">风速</label>
            <input type="text" class="admin-form-input weather-attraction-windSpeed" value="${attraction ? escapeHtml(attraction.windSpeed || '') : ''}" placeholder="如：3级" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
        </div>
        <div class="admin-form-group" style="margin-bottom: 0; margin-top: 0.75rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          <label class="admin-form-label" style="font-size: 0.875rem;">建议</label>
          <textarea class="admin-form-input weather-attraction-suggestion" rows="2" placeholder="如：早晨 8 点前去，带足水。" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;">${attraction ? escapeHtml(attraction.suggestion || '') : ''}</textarea>
        </div>
      `;
      
      container.appendChild(itemDiv);
    }
    
    // 删除景点天气
    function removeWeatherAttraction(index) {
      const container = document.getElementById('weatherAttractionsList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('确定要删除这个景点吗？')) {
        item.remove();
      }
    }
    
    // 添加路况信息
    function addWeatherTraffic(traffic = null) {
      const container = document.getElementById('weatherTrafficList');
      const index = traffic ? traffic._index : weatherTrafficCounter++;
      const itemId = traffic ? traffic.id : '';
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'weather-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #3b82f6;">路况 #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeWeatherTraffic(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> 删除
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ID</label>
            <input type="number" class="admin-form-input weather-traffic-id" value="${itemId}" placeholder="自动生成" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">时间 *</label>
            <input type="text" class="admin-form-input weather-traffic-time" value="${traffic ? escapeHtml(traffic.time || '') : ''}" placeholder="如：10:30" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">类型 *</label>
            <select class="admin-form-select weather-traffic-type" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
              <option value="车祸" ${traffic && traffic.type === '车祸' ? 'selected' : ''}>车祸</option>
              <option value="施工" ${traffic && traffic.type === '施工' ? 'selected' : ''}>施工</option>
              <option value="天气" ${traffic && traffic.type === '天气' ? 'selected' : ''}>天气</option>
              <option value="拥堵" ${traffic && traffic.type === '拥堵' ? 'selected' : ''}>拥堵</option>
              <option value="其他" ${traffic && traffic.type === '其他' ? 'selected' : ''}>其他</option>
            </select>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; grid-column: 1 / -1; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">地点 *</label>
            <input type="text" class="admin-form-input weather-traffic-location" value="${traffic ? escapeHtml(traffic.location || '') : ''}" placeholder="如：环城路 Maadi 出口方向" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; grid-column: 1 / -1; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">消息 *</label>
            <textarea class="admin-form-input weather-traffic-message" rows="2" placeholder="如：发生追尾，极度拥堵。" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;">${traffic ? escapeHtml(traffic.message || '') : ''}</textarea>
          </div>
        </div>
      `;
      
      container.appendChild(itemDiv);
    }
    
    // 删除路况信息
    function removeWeatherTraffic(index) {
      const container = document.getElementById('weatherTrafficList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('确定要删除这条路况信息吗？')) {
        item.remove();
      }
    }
    
    // 添加汇率转换项
    function addExchangeRate(rate = null) {
      const container = document.getElementById('exchangeRatesList');
      const index = rate ? rate._index : exchangeRatesCounter++;
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'exchange-rate-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #10b981;">汇率 #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeExchangeRate(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> 删除
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">源货币 *</label>
            <input type="text" class="admin-form-input exchange-rate-from" value="${rate ? escapeHtml(rate.fromCurrency || '') : ''}" placeholder="如：CNY" pattern="^[A-Z]{3}$" maxlength="3" style="font-size: 0.875rem; text-transform: uppercase; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">3位大写字母</small>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">目标货币 *</label>
            <input type="text" class="admin-form-input exchange-rate-to" value="${rate ? escapeHtml(rate.toCurrency || '') : ''}" placeholder="如：EGP" pattern="^[A-Z]{3}$" maxlength="3" style="font-size: 0.875rem; text-transform: uppercase; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">3位大写字母</small>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">汇率 *</label>
            <input type="number" class="admin-form-input exchange-rate-value" value="${rate ? escapeHtml(rate.rate || '') : ''}" placeholder="如：6.74" step="0.0001" min="0" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">1源货币=?目标货币</small>
          </div>
        </div>
      `;
      
      container.appendChild(itemDiv);
      
      // 自动转换为大写
      const fromInput = itemDiv.querySelector('.exchange-rate-from');
      const toInput = itemDiv.querySelector('.exchange-rate-to');
      fromInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
      toInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
    }
    
    // 删除汇率转换项
    function removeExchangeRate(index) {
      const container = document.getElementById('exchangeRatesList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('确定要删除这条汇率吗？')) {
        item.remove();
      }
    }
    
    // 加载特殊类别数据到表单
    function loadSpecialCategoryData(specialType, originalData) {
      if (specialType === 'translation') {
        document.getElementById('translationChinese').value = originalData.chinese || '';
        document.getElementById('translationArabic').value = originalData.arabic || '';
        document.getElementById('translationCategory').value = originalData.category || '';
      } else if (specialType === 'weather') {
        // 加载globalAlert
        if (originalData.globalAlert) {
          document.getElementById('weatherGlobalAlertLevel').value = originalData.globalAlert.level || 'medium';
          document.getElementById('weatherGlobalAlertMessage').value = originalData.globalAlert.message || '';
        }
        
        // 加载attractions
        const attractionsContainer = document.getElementById('weatherAttractionsList');
        attractionsContainer.innerHTML = '';
        weatherAttractionsCounter = 0;
        if (originalData.attractions && Array.isArray(originalData.attractions)) {
          originalData.attractions.forEach((attraction, index) => {
            attraction._index = index;
            addWeatherAttraction(attraction);
            weatherAttractionsCounter++;
          });
        }
        
        // 加载traffic
        const trafficContainer = document.getElementById('weatherTrafficList');
        trafficContainer.innerHTML = '';
        weatherTrafficCounter = 0;
        if (originalData.traffic && Array.isArray(originalData.traffic)) {
          originalData.traffic.forEach((traffic, index) => {
            traffic._index = index;
            addWeatherTraffic(traffic);
            weatherTrafficCounter++;
          });
        }
      } else if (specialType === 'exchange-rate') {
        // 加载所有货币汇率
        const ratesContainer = document.getElementById('exchangeRatesList');
        ratesContainer.innerHTML = '';
        exchangeRatesCounter = 0;
        
        // 遍历originalData中的所有货币字段（CNY, USD, EUR等）
        Object.keys(originalData).forEach(currency => {
          // 跳过标准字段
          if (['id', 'name', 'title', 'slug', 'excerpt', 'description', 'htmlContent', 'image', 'category', 'tags', 'published', 'views', 'createdAt', 'updatedAt', 'detailApi', 'updateTime'].includes(currency)) {
            return;
          }
          
          // 如果该字段是一个对象（包含目标货币和汇率）
          if (originalData[currency] && typeof originalData[currency] === 'object' && !Array.isArray(originalData[currency])) {
            // 遍历该货币的所有目标货币
            Object.keys(originalData[currency]).forEach(targetCurrency => {
              const rate = originalData[currency][targetCurrency];
              addExchangeRate({
                fromCurrency: currency,
                toCurrency: targetCurrency,
                rate: rate
              });
              exchangeRatesCounter++;
            });
          }
        });
        
        // 如果没有汇率数据，至少添加一行空行
        if (exchangeRatesCounter === 0) {
          addExchangeRate();
        }
        
        // 加载更新时间
        if (originalData.updateTime) {
          const date = new Date(originalData.updateTime);
          const localDateTime = date.toISOString().slice(0, 16);
          document.getElementById('exchangeUpdateTime').value = localDateTime;
        }
      }
    }
    
    // 从表单收集特殊类别数据
    function collectSpecialCategoryData(specialType) {
      const data = {};
      
      if (specialType === 'translation') {
        data.chinese = document.getElementById('translationChinese').value.trim();
        data.arabic = document.getElementById('translationArabic').value.trim();
        data.category = document.getElementById('translationCategory').value.trim();
        
        if (!data.chinese || !data.arabic) {
          throw new Error('中文和阿拉伯文为必填项');
        }
      } else if (specialType === 'weather') {
        // 收集globalAlert
        const alertLevel = document.getElementById('weatherGlobalAlertLevel').value;
        const alertMessage = document.getElementById('weatherGlobalAlertMessage').value.trim();
        
        if (!alertMessage) {
          throw new Error('预警消息为必填项');
        }
        
        data.globalAlert = {
          level: alertLevel,
          message: alertMessage
        };
        
        // 收集attractions
        const attractionsContainer = document.getElementById('weatherAttractionsList');
        const attractionItems = attractionsContainer.querySelectorAll('.weather-item');
        data.attractions = [];
        
        attractionItems.forEach((item, index) => {
          const idInput = item.querySelector('.weather-attraction-id');
          const nameInput = item.querySelector('.weather-attraction-name');
          const tempInput = item.querySelector('.weather-attraction-temperature');
          const visibilityInput = item.querySelector('.weather-attraction-visibility');
          const uvIndexInput = item.querySelector('.weather-attraction-uvIndex');
          const windSpeedInput = item.querySelector('.weather-attraction-windSpeed');
          const suggestionInput = item.querySelector('.weather-attraction-suggestion');
          
          const name = nameInput.value.trim();
          const temperature = tempInput.value.trim();
          
          if (!name || !temperature) {
            throw new Error(`景点 #${index + 1}：名称和温度为必填项`);
          }
          
          const attraction = {
            id: idInput.value ? parseInt(idInput.value) : index + 1,
            name: name,
            temperature: parseInt(temperature),
            visibility: visibilityInput.value.trim() || undefined,
            uvIndex: uvIndexInput.value ? parseInt(uvIndexInput.value) : undefined,
            windSpeed: windSpeedInput.value.trim() || undefined,
            suggestion: suggestionInput.value.trim() || undefined
          };
          
          // 移除undefined字段
          Object.keys(attraction).forEach(key => {
            if (attraction[key] === undefined) {
              delete attraction[key];
            }
          });
          
          data.attractions.push(attraction);
        });
        
        // 收集traffic
        const trafficContainer = document.getElementById('weatherTrafficList');
        const trafficItems = trafficContainer.querySelectorAll('.weather-item');
        data.traffic = [];
        
        trafficItems.forEach((item, index) => {
          const idInput = item.querySelector('.weather-traffic-id');
          const timeInput = item.querySelector('.weather-traffic-time');
          const typeInput = item.querySelector('.weather-traffic-type');
          const locationInput = item.querySelector('.weather-traffic-location');
          const messageInput = item.querySelector('.weather-traffic-message');
          
          const time = timeInput.value.trim();
          const type = typeInput.value;
          const location = locationInput.value.trim();
          const message = messageInput.value.trim();
          
          if (!time || !type || !location || !message) {
            throw new Error(`路况 #${index + 1}：时间、类型、地点和消息为必填项`);
          }
          
          const traffic = {
            id: idInput.value ? parseInt(idInput.value) : index + 1,
            time: time,
            type: type,
            location: location,
            message: message
          };
          
          data.traffic.push(traffic);
        });
        
        // 保留data字段（如果存在，用于列表显示）
        // data字段会在后端处理时自动生成或保留
      } else if (specialType === 'exchange-rate') {
        // 收集所有汇率项
        const ratesContainer = document.getElementById('exchangeRatesList');
        const rateItems = ratesContainer.querySelectorAll('.exchange-rate-item');
        
        // 构建汇率对象：{CNY: {EGP: 6.74}, USD: {EGP: 30.5}, ...}
        const exchangeRates = {};
        
        rateItems.forEach((item, index) => {
          const fromInput = item.querySelector('.exchange-rate-from');
          const toInput = item.querySelector('.exchange-rate-to');
          const rateInput = item.querySelector('.exchange-rate-value');
          
          const fromCurrency = fromInput.value.trim().toUpperCase();
          const toCurrency = toInput.value.trim().toUpperCase();
          const rate = parseFloat(rateInput.value);
          
          if (!fromCurrency || !toCurrency || isNaN(rate) || rate <= 0) {
            throw new Error(`汇率 #${index + 1}：源货币、目标货币和汇率为必填项，且汇率必须大于0`);
          }
          
          // 验证货币代码格式
          if (!/^[A-Z]{3}$/.test(fromCurrency)) {
            throw new Error(`汇率 #${index + 1}：源货币格式不正确，应为3位大写字母，如 CNY、USD、EGP`);
          }
          if (!/^[A-Z]{3}$/.test(toCurrency)) {
            throw new Error(`汇率 #${index + 1}：目标货币格式不正确，应为3位大写字母，如 CNY、USD、EGP`);
          }
          
          // 如果该源货币已存在，添加目标货币
          if (!exchangeRates[fromCurrency]) {
            exchangeRates[fromCurrency] = {};
          }
          exchangeRates[fromCurrency][toCurrency] = rate;
        });
        
        // 将汇率对象合并到data中
        Object.assign(data, exchangeRates);
        
        // 添加更新时间
        const updateTime = document.getElementById('exchangeUpdateTime').value;
        if (updateTime) {
          data.updateTime = new Date(updateTime).toISOString();
        }
      }
      
      return data;
    }
    
    // 保存文章
    async function savePost(event) {
      event.preventDefault();
      
      const id = document.getElementById('postId').value;
      const name = document.getElementById('postName').value.trim();
      // name和title保持一致
      const title = name;
      const slug = document.getElementById('postSlug').value.trim();
      const excerpt = document.getElementById('postExcerpt').value.trim();
      const image = document.getElementById('postImage').value.trim();
      const apiName = document.getElementById('postApiName').value.trim();
      
      // 验证API/分类是否已选择
      if (!apiName) {
        showToast('请选择API/分类', 'error');
        return;
      }
      
      // category直接使用apiName
      const category = apiName;
      
      // 检查是否是特殊类别
      const specialType = isSpecialCategory(apiName);
      
      // 获取htmlContent（统一使用htmlContent字段）
      let htmlContent = '';
      let specialData = null;
      
          // 只有 weather、exchange-rate、translation 不使用 htmlContent
          // second-hand 和 rentals 仍然需要 htmlContent
          const needsSpecialDataOnly = specialType && (specialType === 'weather' || specialType === 'exchange-rate' || specialType === 'translation');
          
          if (specialType) {
            // 特殊类别：收集特殊数据
            try {
              specialData = collectSpecialCategoryData(specialType);
              // 只有 weather、exchange-rate、translation 不需要 htmlContent
              // second-hand 和 rentals 仍然需要 htmlContent
              if (!needsSpecialDataOnly) {
                // 获取htmlContent（second-hand 和 rentals 需要）
                if (wangEditor) {
                  htmlContent = wangEditor.getHtml();
                  // 确保所有URL都是完整的网络地址（兼容小程序等环境）
                  htmlContent = ensureFullUrlsInHtml(htmlContent);
                  // 清理所有base64图片和视频
                  htmlContent = removeBase64Content(htmlContent);
                }
              } else {
                // weather、exchange-rate、translation 不需要 htmlContent
                htmlContent = undefined;
              }
            } catch (error) {
              showToast(error.message, 'error');
              return;
            }
          } else {
            // 普通类别：获取htmlContent
                if (wangEditor) {
                  htmlContent = wangEditor.getHtml();
                  // 确保所有URL都是完整的网络地址（兼容小程序等环境）
                  htmlContent = ensureFullUrlsInHtml(htmlContent);
                  // 清理所有base64图片和视频
                  htmlContent = removeBase64Content(htmlContent);
                }
          }
      
      const published = document.getElementById('postPublished').checked;

      if (!name) {
        showToast('请填写文章名称', 'error');
        return;
      }

      if (!apiName) {
        showToast('请选择API（分类）', 'error');
        return;
      }

      // 在验证前，先移除所有隐藏表单字段的required属性，避免浏览器验证错误
      const allSpecialForms = ['specialForm-second-hand', 'specialForm-rentals', 'specialForm-weather', 
                               'specialForm-exchange-rate', 'specialForm-translation'];
      allSpecialForms.forEach(formId => {
        const form = document.getElementById(formId);
        if (form && form.style.display === 'none') {
          // 表单隐藏时，移除其中所有字段的required属性
          const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
          inputs.forEach(input => {
            input.removeAttribute('required');
          });
        }
      });

      // 验证必填字段
      // specialType 已经在上面声明过了（第2076行），这里直接使用
      const needsLocation = needsLocationFields(apiName);
      const isLocationReq = isLocationRequired(apiName);
      
      // 验证联系方式（在租房、二手集市和寻味中国中必填，防骗指南等可选）
      const needsPhone = needsPhoneField(apiName);
      // 判断电话字段是否为必填（寻味中国必填，防骗指南等可选）
      const lowerNameForPhone = apiName.toLowerCase();
      const isPhoneRequired = lowerNameForPhone.includes('chinese-food') || 
                              lowerNameForPhone.includes('寻味') ||
                              specialType === 'second-hand' || 
                              specialType === 'rentals';
      
      if (needsPhone && isPhoneRequired) {
        let phoneInput;
        if (specialType === 'second-hand') {
          phoneInput = document.getElementById('secondHandPhone');
        } else if (specialType === 'rentals') {
          phoneInput = document.getElementById('rentalsPhone');
        } else {
          // 寻味中国等其他分类使用通用电话字段
          phoneInput = document.getElementById('commonPhone');
        }
        
        // 检查字段是否可见（不在隐藏的表单中）
        if (phoneInput) {
          const isVisible = phoneInput.offsetParent !== null; // 检查元素是否可见
          if (isVisible && !phoneInput.value.trim()) {
            showToast('联系方式是必填项', 'error');
            phoneInput.focus();
            return;
          }
        }
      }
      
      // 验证位置信息（只在必填分类中验证）
      if (needsLocation && isLocationReq) {
        let addressInput, latInput, lngInput;
        
        if (specialType === 'second-hand') {
          addressInput = document.getElementById('secondHandAddress');
          latInput = document.getElementById('secondHandLatitude');
          lngInput = document.getElementById('secondHandLongitude');
        } else if (specialType === 'rentals') {
          addressInput = document.getElementById('rentalsAddress');
          latInput = document.getElementById('rentalsLatitude');
          lngInput = document.getElementById('rentalsLongitude');
        } else {
          addressInput = document.getElementById('commonAddress');
          latInput = document.getElementById('commonLatitude');
          lngInput = document.getElementById('commonLongitude');
        }
        
        // 只验证可见的字段
        if (addressInput) {
          const isVisible = addressInput.offsetParent !== null;
          if (isVisible && !addressInput.value.trim()) {
            showToast('地址是必填项', 'error');
            addressInput.focus();
            return;
          }
        }
        if (latInput) {
          const isVisible = latInput.offsetParent !== null;
          if (isVisible && !latInput.value.trim()) {
            showToast('纬度是必填项', 'error');
            latInput.focus();
            return;
          }
        }
        if (lngInput) {
          const isVisible = lngInput.offsetParent !== null;
          if (isVisible && !lngInput.value.trim()) {
            showToast('经度是必填项', 'error');
            lngInput.focus();
            return;
          }
        }
      }

      try {
        // 直接使用id（id现在是全局唯一的UUID）
        // 如果ID为空字符串或null/undefined，则创建新文章
        const hasId = id && id.trim() !== '';
        const url = hasId ? `${BLOG_ADMIN_API}/posts/${id}` : `${BLOG_ADMIN_API}/posts`;
        const method = hasId ? 'PUT' : 'POST';
        
        const requestBody = {
          name,
          title: title, // name和title保持一致
          slug: slug || undefined,
          excerpt,
          image: image || undefined,
          apiName: apiName, // API名称（用于确定数据存储位置）
          category: category, // 分类（用于博客展示）
          published
        };
        
        // 添加特殊字段（二手市场和租房酒店）
        // specialType 和 needsLocation 已经在上面声明过了，这里直接使用
        
        if (specialType === 'second-hand') {
          const price = document.getElementById('secondHandPrice').value.trim();
          const phone = document.getElementById('secondHandPhone').value.trim();
          const address = document.getElementById('secondHandAddress').value.trim();
          const latitude = document.getElementById('secondHandLatitude').value.trim();
          const longitude = document.getElementById('secondHandLongitude').value.trim();
          // 即使字段为空也要发送，以便后端可以删除这些字段
          requestBody.price = price || null;
          requestBody.phone = phone || null;
          requestBody.address = address || null;
          requestBody.latitude = latitude ? parseFloat(latitude) : null;
          requestBody.longitude = longitude ? parseFloat(longitude) : null;
        } else if (specialType === 'rentals') {
          const price = document.getElementById('rentalsPrice').value.trim();
          const rooms = document.getElementById('rentalsRooms').value.trim();
          const area = document.getElementById('rentalsArea').value.trim();
          const views = document.getElementById('rentalsViews').value.trim();
          const phone = document.getElementById('rentalsPhone').value.trim();
          const address = document.getElementById('rentalsAddress').value.trim();
          const latitude = document.getElementById('rentalsLatitude').value.trim();
          const longitude = document.getElementById('rentalsLongitude').value.trim();
          // 即使字段为空也要发送，以便后端可以删除这些字段
          requestBody.price = price || null;
          requestBody.rooms = rooms || null;
          requestBody.area = area || null;
          requestBody.views = views ? parseInt(views) || 0 : null;
          requestBody.phone = phone || null;
          requestBody.address = address || null;
          requestBody.latitude = latitude ? parseFloat(latitude) : null;
          requestBody.longitude = longitude ? parseFloat(longitude) : null;
        } else if (needsLocation) {
          // 通用位置字段（用于其他需要位置的分类）
          const addressInput = document.getElementById('commonAddress');
          const latInput = document.getElementById('commonLatitude');
          const lngInput = document.getElementById('commonLongitude');
          // 即使字段为空也要发送，以便后端可以删除这些字段
          if (addressInput) {
            const address = addressInput.value.trim();
            requestBody.address = address || null;
          }
          if (latInput) {
            const latitude = latInput.value.trim();
            requestBody.latitude = latitude ? parseFloat(latitude) : null;
          }
          if (lngInput) {
            const longitude = lngInput.value.trim();
            requestBody.longitude = longitude ? parseFloat(longitude) : null;
          }
        }
        
        // 添加通用电话字段（用于寻味中国等分类）
        const needsPhone = needsPhoneField(apiName);
        if (needsPhone && specialType !== 'second-hand' && specialType !== 'rentals') {
          const phoneInput = document.getElementById('commonPhone');
          if (phoneInput) {
            const phone = phoneInput.value.trim();
            // 即使字段为空也要发送，以便后端可以删除这些字段
            requestBody.phone = phone || null;
          }
        }
        
        // 如果是特殊类别，添加特殊数据
        // 注意：second-hand 和 rentals 虽然需要特殊字段，但仍然需要 htmlContent
        const needsSpecialDataOnly = specialType && (specialType === 'weather' || specialType === 'exchange-rate' || specialType === 'translation');
        
        if (specialType && specialData) {
          requestBody._specialData = specialData;
          requestBody._specialType = specialType;
          
          // 只有 weather、exchange-rate、translation 不使用 htmlContent
          // second-hand 和 rentals 仍然需要 htmlContent
          if (!needsSpecialDataOnly) {
            requestBody.htmlContent = htmlContent || undefined;
          }
          
          // 添加调试信息
          console.log('保存特殊类别文章', {
            specialType,
            needsSpecialDataOnly,
            specialDataKeys: Object.keys(specialData),
            specialDataPreview: JSON.stringify(specialData).substring(0, 500),
            hasHtmlContent: !needsSpecialDataOnly && htmlContent
          });
        } else {
          // 普通类别才添加htmlContent
          requestBody.htmlContent = htmlContent || undefined;
        }
        
        console.log('发送请求', {
          url,
          method,
          requestBody: JSON.stringify(requestBody, null, 2)
        });
        
        const response = await adminApiRequest(url, {
          method,
          body: JSON.stringify(requestBody)
        });
        
        console.log('收到响应', {
          success: response?.success,
          data: response?.data,
          message: response?.message
        });
        
        // 显示调试信息面板
        showDebugInfo({
          request: requestBody,
          response: response,
          specialType: specialType,
          specialData: specialData
        });
        
        if (response && response.success) {
          // 显示详细的成功信息（包含调试信息）
          const debugInfo = specialType && specialData 
            ? `\n调试信息：\n- 类型: ${specialType}\n- 数据键: ${Object.keys(specialData).join(', ')}\n- 数据预览: ${JSON.stringify(specialData).substring(0, 200)}`
            : '';
          
          console.log('保存成功', {
            id: response.data?.id,
            name: response.data?.name,
            apiName: response.data?.category,
            debugInfo
          });
          
          showToast(id ? '文章更新成功' : '文章创建成功', 'success');
          window.currentEditingPost = null; // 清除当前编辑的文章
          
          // 如果是在新窗口中打开的，刷新父窗口并关闭当前窗口
          if (window.opener) {
            // 通知父窗口刷新内容（根据父窗口类型调用不同的刷新方法）
            try {
              // blog-admin.html 使用 loadPosts
              if (typeof window.opener.loadPosts === 'function') {
                window.opener.loadPosts(false);
              }
              // blog-detail.html 使用 loadPost
              if (typeof window.opener.loadPost === 'function') {
                window.opener.loadPost();
              }
              // blog.html 可能使用 loadPosts 或 loadArchive（已在窗口关闭时处理）
            } catch (e) {
              console.warn('无法通知父窗口刷新:', e);
            }
            // 延迟关闭，让用户看到成功提示
            setTimeout(() => {
              window.close();
            }, 1000);
          } else {
            // 在当前窗口中，正常处理
            hidePostForm();
            loadPosts(false); // 保存后保持展开状态
          }
        } else {
          console.error('保存失败', response);
          showToast('保存失败: ' + (response?.message || '未知错误'), 'error');
        }
      } catch (error) {
        console.error('保存文章失败:', error);
        showToast('保存文章失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    // 编辑文章（在新窗口打开）
    function editPost(id) {
      // 在新窗口打开编辑页面
      const editUrl = `${window.location.pathname}?edit=${encodeURIComponent(id)}`;
      const editWindow = window.open(editUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!editWindow) {
        showToast('无法打开新窗口，请检查浏览器弹窗设置', 'error');
        return;
      }
      
      // 监听新窗口关闭事件，刷新文章列表
      const checkClosed = setInterval(() => {
        if (editWindow.closed) {
          clearInterval(checkClosed);
          // 刷新文章列表
          loadPosts(false);
        }
      }, 500);
    }
    
    // 编辑文章（内部函数，用于在新窗口中加载文章数据）
    async function editPostInternal(id) {
      const postForm = document.getElementById('postForm');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      const progressBar = document.getElementById('postFormLoadingProgressBar');
      
      try {
        // 显示表单和加载提示
        if (postForm) {
          postForm.style.display = 'block';
          postForm.classList.add('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'flex';
        }
        if (postFormContent) {
          postFormContent.style.display = 'none';
        }
        if (progressBar) {
          progressBar.style.width = '0%';
        }
        
        // 切换到文章标签页（如果不在新窗口）
        if (!window.opener) {
          switchTab('posts');
        }
        
        console.log('编辑文章，ID:', id);
        
        // 直接通过文章ID获取完整内容（不使用列表API，避免htmlContent被裁剪）
        console.log('通过文章ID获取完整内容，ID:', id);
        
        // 更新进度条
        if (progressBar) {
          progressBar.style.width = '50%';
        }
        
        let post = null;
        try {
          // 使用单篇文章详情API获取完整内容
          const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts/${id}`);
          
          if (progressBar) {
            progressBar.style.width = '90%';
          }
          
          console.log('获取文章详情响应:', response);
          
          if (response && response.success && response.data) {
            post = response.data;
            console.log('获取到完整文章数据:', {
              id: post.id,
              name: post.name,
              hasHtmlContent: !!post.htmlContent,
              htmlContentLength: post.htmlContent ? post.htmlContent.length : 0
            });
          } else {
            console.error('获取文章详情失败:', response);
            if (progressBar) {
              progressBar.style.width = '0%';
            }
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postForm) {
              postForm.style.display = 'none';
            }
            showToast('获取文章详情失败: ' + (response?.message || '未知错误'), 'error');
            return;
          }
        } catch (error) {
          console.error('获取文章详情异常:', error);
          if (progressBar) {
            progressBar.style.width = '0%';
          }
          if (postForm) {
            postForm.classList.remove('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'none';
          }
          if (postForm) {
            postForm.style.display = 'none';
          }
          showToast('获取文章详情失败: ' + (error.message || '未知错误'), 'error');
          return;
        }
        
        // 完成进度条
        if (progressBar) {
          progressBar.style.width = '100%';
        }
        
        console.log('找到的文章:', post);
        
        if (post) {
          // 保存当前文章对象，用于后续保存时使用
          window.currentEditingPost = post;
          
          // 延迟一下再隐藏加载提示，让用户看到完成状态
          setTimeout(() => {
            // 隐藏加载提示，显示表单内容
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postFormContent) {
              postFormContent.style.display = 'block';
            }
            if (progressBar) {
              progressBar.style.width = '0%';
            }
            // 填充表单数据
            showPostForm(post);
          }, 200);
        } else {
          console.error('未找到文章，ID:', id, '可用文章ID:', posts.map(p => p.id));
          // 隐藏加载提示
          if (postForm) {
            postForm.classList.remove('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'none';
          }
          if (postForm) {
            postForm.style.display = 'none';
          }
          if (progressBar) {
            progressBar.style.width = '0%';
          }
          showToast('未找到要编辑的文章', 'error');
        }
      } catch (error) {
        console.error('加载文章失败:', error);
        // 隐藏加载提示
        if (postForm) {
          postForm.classList.remove('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'none';
        }
        if (postForm) {
          postForm.style.display = 'none';
        }
        if (progressBar) {
          progressBar.style.width = '0%';
        }
        showToast('加载文章失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    // 复制文章（在新窗口打开）
    function copyPost(id) {
      // 在新窗口打开复制页面
      const copyUrl = `${window.location.pathname}?copy=${encodeURIComponent(id)}`;
      const copyWindow = window.open(copyUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!copyWindow) {
        showToast('无法打开新窗口，请检查浏览器弹窗设置', 'error');
        return;
      }
      
      // 监听新窗口关闭事件，刷新文章列表
      const checkClosed = setInterval(() => {
        if (copyWindow.closed) {
          clearInterval(checkClosed);
          // 刷新文章列表
          loadPosts(false);
        }
      }, 500);
    }
    
    // 复制文章（内部函数，用于在新窗口中加载文章数据）
    async function copyPostInternal(id) {
      const postForm = document.getElementById('postForm');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      try {
        // 显示表单和加载提示
        if (postForm) {
          postForm.style.display = 'block';
          postForm.classList.add('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'flex';
        }
        if (postFormContent) {
          postFormContent.style.display = 'none';
        }
        
        // 切换到文章标签页（如果不在新窗口）
        if (!window.opener) {
          switchTab('posts');
        }
        
        console.log('复制文章，ID:', id);
        // 使用单篇文章详情API获取完整内容（包括完整的htmlContent）
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts/${encodeURIComponent(id)}`);
        console.log('获取文章详情响应:', response);
        
        if (response && response.success && response.data) {
          const post = response.data;
          
          console.log('找到的文章:', post);
          console.log('文章HTML内容长度:', post.htmlContent ? post.htmlContent.length : 0);
          
          if (post) {
            // 创建文章副本，清除ID和slug，修改标题
            const copiedPost = {
              ...post,
              id: '', // 清除ID，保存时会创建新文章
              slug: '', // 清除slug，系统会自动生成新的
              name: (post.name || post.title || '未命名') + '（副本）',
              title: (post.name || post.title || '未命名') + '（副本）',
              published: false, // 默认设为草稿
              views: 0, // 重置浏览量
              createdAt: null, // 清除创建时间
              updatedAt: null // 清除更新时间
            };
            
            // 保存当前文章对象（用于后续保存时使用）
            window.currentEditingPost = copiedPost;
            
            // 隐藏加载提示，显示表单内容
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postFormContent) {
              postFormContent.style.display = 'block';
            }
            // 填充表单数据
            showPostForm(copiedPost);
          } else {
            console.error('未找到文章，ID:', id);
            // 隐藏加载提示
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postForm) {
              postForm.style.display = 'none';
            }
            showToast('未找到要复制的文章', 'error');
          }
        } else {
          console.error('获取文章详情失败:', response);
          // 隐藏加载提示
          if (postForm) {
            postForm.classList.remove('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'none';
          }
          if (postForm) {
            postForm.style.display = 'none';
          }
          showToast('获取文章详情失败: ' + (response?.message || '未知错误'), 'error');
        }
      } catch (error) {
        console.error('加载文章失败:', error);
        // 隐藏加载提示
        if (postForm) {
          postForm.classList.remove('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'none';
        }
        if (postForm) {
          postForm.style.display = 'none';
        }
        showToast('加载文章失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    // 删除文章
    async function deletePost(id) {
      if (!confirm('确定要删除这篇文章吗？')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('文章删除成功', 'success');
          loadPosts(false); // 删除后保持展开状态
        }
      } catch (error) {
        console.error('删除文章失败:', error);
      }
    }

    // 分类管理函数
    async function loadCategories() {
      try {
        const tbody = document.getElementById('categoriesTableBody');
        const mobileContainer = document.getElementById('categoriesTableMobile');
        
        if (!tbody) {
          console.error('找不到 categoriesTableBody 元素');
          return;
        }
        
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories`);
        if (response && response.success) {
          const categories = response.data || [];
          if (categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="blog-empty">暂无分类</td></tr>';
            if (mobileContainer) {
              mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无分类</div>';
            }
          } else {
            // 桌面端表格
            tbody.innerHTML = categories.map(cat => `
              <tr>
                <td>${escapeHtml(cat.name)}</td>
                <td>${escapeHtml(cat.description || cat.path || '')}</td>
                <td>${cat.postCount || 0}</td>
                <td>
                  <div class="admin-actions">
                    <button class="admin-btn-small admin-btn-edit" onclick="editCategory(${cat.id})">编辑</button>
                    <button class="admin-btn-small admin-btn-delete" onclick="deleteCategory(${cat.id})">删除</button>
                  </div>
                </td>
              </tr>
            `).join('');
            
            // 移动端卡片
            if (mobileContainer) {
              mobileContainer.innerHTML = categories.map(cat => `
                <div class="admin-table-card">
                  <div class="admin-table-card-row">
                    <span class="admin-table-card-label">名称：</span>
                    <span class="admin-table-card-value">${escapeHtml(cat.name)}</span>
                  </div>
                  <div class="admin-table-card-row">
                    <span class="admin-table-card-label">路径/描述：</span>
                    <span class="admin-table-card-value">${escapeHtml(cat.description || cat.path || '')}</span>
                  </div>
                  <div class="admin-table-card-row">
                    <span class="admin-table-card-label">文章数：</span>
                    <span class="admin-table-card-value">${cat.postCount || 0}</span>
                  </div>
                  <div class="admin-table-card-row admin-table-card-actions-row">
                    <div class="admin-actions">
                      <button class="admin-btn-small admin-btn-edit" onclick="editCategory(${cat.id})">编辑</button>
                      <button class="admin-btn-small admin-btn-delete" onclick="deleteCategory(${cat.id})">删除</button>
                    </div>
                  </div>
                </div>
              `).join('');
            }
          }
        } else {
          tbody.innerHTML = '<tr><td colspan="4" class="blog-empty">加载失败: ' + (response?.message || '未知错误') + '</td></tr>';
          if (mobileContainer) {
            mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">加载失败: ' + escapeHtml(response?.message || '未知错误') + '</div>';
          }
        }
      } catch (error) {
        console.error('加载分类失败:', error);
        const tbody = document.getElementById('categoriesTableBody');
        const mobileContainer = document.getElementById('categoriesTableMobile');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="4" class="blog-empty">加载失败: ' + escapeHtml(error.message || '未知错误') + '</td></tr>';
        }
        if (mobileContainer) {
          mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">加载失败: ' + escapeHtml(error.message || '未知错误') + '</div>';
        }
      }
    }

    function showCategoryForm(category = null) {
      const form = document.getElementById('categoryForm');
      const formTitle = document.getElementById('categoryFormTitle');
      
      if (category) {
        formTitle.textContent = '编辑分类';
        document.getElementById('categoryId').value = category.id;
        document.getElementById('categoryName').value = category.name || '';
        document.getElementById('categoryPath').value = category.description || category.path || '';
      } else {
        formTitle.textContent = '新建分类';
        document.getElementById('categoryFormElement').reset();
        document.getElementById('categoryId').value = '';
      }
      
      form.style.display = 'block';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    function hideCategoryForm() {
      document.getElementById('categoryForm').style.display = 'none';
      document.getElementById('categoryFormElement').reset();
      document.getElementById('categoryId').value = '';
    }

    async function saveCategory(event) {
      event.preventDefault();
      const id = document.getElementById('categoryId').value;
      const name = document.getElementById('categoryName').value.trim();
      const path = document.getElementById('categoryPath').value.trim();

      if (!name || !path) {
        showToast('请填写所有必填项', 'error');
        return;
      }

      if (!path.startsWith('/')) {
        showToast('路径必须以 / 开头', 'error');
        return;
      }

      try {
        const url = id ? `${BLOG_ADMIN_API}/categories/${id}` : `${BLOG_ADMIN_API}/categories`;
        const method = id ? 'PUT' : 'POST';
        
        const response = await adminApiRequest(url, {
          method,
          body: JSON.stringify({ name, path })
        });

        if (response && response.success) {
          showToast(id ? '分类更新成功' : '分类创建成功', 'success');
          hideCategoryForm();
          loadCategories();
        }
      } catch (error) {
        console.error('保存分类失败:', error);
        showToast('保存分类失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    async function editCategory(id) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories`);
        if (response && response.success) {
          const category = response.data.find(c => c.id === id);
          if (category) {
            showCategoryForm(category);
          }
        }
      } catch (error) {
        console.error('加载分类失败:', error);
      }
    }

    async function deleteCategory(id) {
      if (!confirm('确定要删除这个分类吗？如果有文章使用此分类，删除将失败。')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('分类删除成功', 'success');
          loadCategories();
        }
      } catch (error) {
        console.error('删除分类失败:', error);
        showToast('删除分类失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    // 评论管理函数
    async function loadComments() {
      try {
        const tbody = document.getElementById('commentsTableBody');
        const mobileContainer = document.getElementById('commentsTableMobile');
        
        if (!tbody) {
          console.error('找不到 commentsTableBody 元素');
          return;
        }
        
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments`);
        if (response && response.success) {
          const comments = response.data || [];
          if (comments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="blog-empty">暂无评论</td></tr>';
            if (mobileContainer) {
              mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无评论</div>';
            }
          } else {
            // 桌面端表格
            tbody.innerHTML = comments.map(comment => {
              const date = formatDateTime(comment.createdAt || comment.created_at);
              return `
                <tr>
                  <td>${escapeHtml(comment.postName || '')}</td>
                  <td>${escapeHtml(comment.authorName)}</td>
                  <td>${escapeHtml(truncate(comment.content, 50))}</td>
                  <td>${comment.approved ? '<span style="color: #10b981;">已审核</span>' : '<span style="color: #f59e0b;">待审核</span>'}</td>
                  <td>${date}</td>
                  <td>
                    <div class="admin-actions">
                      ${!comment.approved ? `<button class="admin-btn-small admin-btn-approve" onclick="approveComment('${comment.id}')">审核</button>` : ''}
                      <button class="admin-btn-small admin-btn-delete" onclick="deleteComment('${comment.id}')">删除</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('');
            
            // 移动端卡片
            if (mobileContainer) {
              mobileContainer.innerHTML = comments.map(comment => {
                const date = formatDateTime(comment.createdAt || comment.created_at);
                return `
                  <div class="admin-table-card">
                    <div class="admin-table-card-row">
                      <span class="admin-table-card-label">文章：</span>
                      <span class="admin-table-card-value">${escapeHtml(comment.postName || '')}</span>
                    </div>
                    <div class="admin-table-card-row">
                      <span class="admin-table-card-label">作者：</span>
                      <span class="admin-table-card-value">${escapeHtml(comment.authorName)}</span>
                    </div>
                    <div class="admin-table-card-row">
                      <span class="admin-table-card-label">内容：</span>
                      <span class="admin-table-card-value">${escapeHtml(truncate(comment.content, 50))}</span>
                    </div>
                    <div class="admin-table-card-row">
                      <span class="admin-table-card-label">状态：</span>
                      <span class="admin-table-card-value">${comment.approved ? '<span style="color: #10b981;">已审核</span>' : '<span style="color: #f59e0b;">待审核</span>'}</span>
                    </div>
                    <div class="admin-table-card-row">
                      <span class="admin-table-card-label">日期：</span>
                      <span class="admin-table-card-value">${date}</span>
                    </div>
                    <div class="admin-table-card-row admin-table-card-actions-row">
                      <div class="admin-actions">
                        ${!comment.approved ? `<button class="admin-btn-small admin-btn-approve" onclick="approveComment('${comment.id}')">审核</button>` : ''}
                        <button class="admin-btn-small admin-btn-delete" onclick="deleteComment('${comment.id}')">删除</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('');
            }
          }
        } else {
          tbody.innerHTML = '<tr><td colspan="6" class="blog-empty">加载失败: ' + (response?.message || '未知错误') + '</td></tr>';
          if (mobileContainer) {
            mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">加载失败: ' + escapeHtml(response?.message || '未知错误') + '</div>';
          }
        }
      } catch (error) {
        console.error('加载评论失败:', error);
        const tbody = document.getElementById('commentsTableBody');
        const mobileContainer = document.getElementById('commentsTableMobile');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="6" class="blog-empty">加载失败: ' + escapeHtml(error.message || '未知错误') + '</td></tr>';
        }
        if (mobileContainer) {
          mobileContainer.innerHTML = '<div class="blog-empty" style="padding: 2rem; text-align: center;">加载失败: ' + escapeHtml(error.message || '未知错误') + '</div>';
        }
      }
    }

    async function approveComment(id) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments/${id}/approve`, {
          method: 'PUT',
          body: JSON.stringify({ approved: true })
        });

        if (response && response.success) {
          showToast('评论已审核通过', 'success');
          loadComments();
        }
      } catch (error) {
        console.error('审核评论失败:', error);
      }
    }

    async function deleteComment(id) {
      if (!confirm('确定要删除这条评论吗？')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('评论删除成功', 'success');
          loadComments();
        }
      } catch (error) {
        console.error('删除评论失败:', error);
      }
    }

    // 特殊内容管理函数（天气、汇率、翻译）
    async function loadSpecialContent(type) {
      try {
        // 将type转换为实际的元素ID（exchange-rate -> exchangeRate）
        const contentElementIdMap = {
          'weather': 'weatherContent',
          'exchange-rate': 'exchangeRateContent',
          'translation': 'translationContent'
        };
        const contentElementId = contentElementIdMap[type] || `${type}Content`;
        const contentElement = document.getElementById(contentElementId);
        if (!contentElement) {
          console.error(`找不到 ${contentElementId} 元素`);
          return;
        }

        contentElement.innerHTML = '<div class="blog-loading" style="padding: 2rem; text-align: center;">加载中...</div>';

        const response = await adminApiRequest(`${BLOG_ADMIN_API}/special-content/${type}`);
        
        let html = '';
        let lastUpdateEl = null;
        let updatedAt = null;
        
        if (response && response.success && response.data) {
          const data = response.data;
          const content = data.content || {};
          updatedAt = data.updatedAt;
          
          if (type === 'weather') {
            html = renderWeatherContent(content);
            lastUpdateEl = document.getElementById('weatherLastUpdate');
          } else if (type === 'exchange-rate') {
            html = renderExchangeRateContent(content);
            lastUpdateEl = document.getElementById('exchangeRateLastUpdate');
          } else if (type === 'translation') {
            html = renderTranslationContent(content);
            lastUpdateEl = document.getElementById('translationLastUpdate');
          }
          
          // 确保html不为空
          if (!html || html.trim() === '') {
            html = '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无数据</div>';
          }
          
          // 更新最后更新时间
          if (lastUpdateEl && updatedAt) {
            lastUpdateEl.textContent = `最后更新: ${formatDateTime(updatedAt)}`;
          }
          
          contentElement.innerHTML = html;
        } else {
          // 即使API返回失败，也尝试渲染空内容
          if (type === 'exchange-rate') {
            html = renderExchangeRateContent({});
            lastUpdateEl = document.getElementById('exchangeRateLastUpdate');
          } else if (type === 'translation') {
            html = renderTranslationContent([]);
            lastUpdateEl = document.getElementById('translationLastUpdate');
          } else if (type === 'weather') {
            html = renderWeatherContent({});
            lastUpdateEl = document.getElementById('weatherLastUpdate');
          }
          
          if (!html || html.trim() === '') {
            html = `<div class="blog-empty" style="padding: 2rem; text-align: center;">
              <p>${response?.message || '未找到内容'}</p>
              <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem;">请先创建对应的API</p>
            </div>`;
          }
          
          contentElement.innerHTML = html;
        }
      } catch (error) {
        console.error(`加载${type}内容失败:`, error);
        // 将type转换为实际的元素ID（exchange-rate -> exchangeRate）
        const contentElementIdMap = {
          'weather': 'weatherContent',
          'exchange-rate': 'exchangeRateContent',
          'translation': 'translationContent'
        };
        const contentElementId = contentElementIdMap[type] || `${type}Content`;
        const contentElement = document.getElementById(contentElementId);
        if (contentElement) {
          // 尝试渲染空内容而不是显示错误
          let html = '';
          if (type === 'exchange-rate') {
            html = renderExchangeRateContent({});
          } else if (type === 'translation') {
            html = renderTranslationContent([]);
          } else if (type === 'weather') {
            html = renderWeatherContent({});
          }
          
          if (!html || html.trim() === '') {
            html = `<div class="blog-empty" style="padding: 2rem; text-align: center;">
              加载失败: ${escapeHtml(error.message || '未知错误')}
            </div>`;
          }
          
          contentElement.innerHTML = html;
        }
      }
    }

    function renderWeatherContent(content) {
      if (!content.globalAlert && !content.attractions && !content.traffic) {
        return '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无天气数据</div>';
      }

      let html = '<div style="display: flex; flex-direction: column; gap: 1.5rem;">';
      
      // 全局预警
      if (content.globalAlert) {
        const levelColors = {
          low: '#10b981',
          medium: '#f59e0b',
          high: '#ef4444'
        };
        const levelText = {
          low: '低',
          medium: '中',
          high: '高'
        };
        html += `
          <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem; border-left: 4px solid ${levelColors[content.globalAlert.level] || '#6b7280'};">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <span style="font-weight: 600; color: #111827;">全局预警</span>
              <span style="padding: 0.25rem 0.5rem; background: ${levelColors[content.globalAlert.level] || '#6b7280'}; color: white; border-radius: 0.25rem; font-size: 0.75rem;">
                ${levelText[content.globalAlert.level] || content.globalAlert.level}
              </span>
            </div>
            <p style="color: #374151; margin: 0;">${escapeHtml(content.globalAlert.message || '')}</p>
          </div>
        `;
      }
      
      // 景点信息
      if (content.attractions && Array.isArray(content.attractions) && content.attractions.length > 0) {
        html += '<div><h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 0.75rem;">景点信息</h3>';
        html += '<div style="display: grid; gap: 0.75rem;">';
        content.attractions.forEach((attraction, index) => {
          html += `
            <div style="padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-weight: 600; color: #111827; font-size: 1rem;">${escapeHtml(attraction.name || `景点 ${index + 1}`)}</span>
                ${attraction.id ? `<span style="color: #6b7280; font-size: 0.75rem;">ID: ${attraction.id}</span>` : ''}
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                ${attraction.temperature !== undefined ? `
                  <div>
                    <span style="color: #6b7280; font-size: 0.75rem;">温度：</span>
                    <span style="color: #111827; font-weight: 500;">${attraction.temperature}°C</span>
                  </div>
                ` : ''}
                ${attraction.visibility ? `
                  <div>
                    <span style="color: #6b7280; font-size: 0.75rem;">能见度：</span>
                    <span style="color: #111827;">${escapeHtml(attraction.visibility)}</span>
                  </div>
                ` : ''}
                ${attraction.uvIndex !== undefined ? `
                  <div>
                    <span style="color: #6b7280; font-size: 0.75rem;">紫外线指数：</span>
                    <span style="color: #111827;">${attraction.uvIndex}</span>
                  </div>
                ` : ''}
                ${attraction.windSpeed ? `
                  <div>
                    <span style="color: #6b7280; font-size: 0.75rem;">风速：</span>
                    <span style="color: #111827;">${escapeHtml(attraction.windSpeed)}</span>
                  </div>
                ` : ''}
              </div>
              ${attraction.suggestion ? `
                <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                  <span style="color: #6b7280; font-size: 0.75rem;">建议：</span>
                  <div style="color: #374151; font-size: 0.875rem; margin-top: 0.25rem;">${escapeHtml(attraction.suggestion)}</div>
                </div>
              ` : ''}
            </div>
          `;
        });
        html += '</div></div>';
      }
      
      // 交通信息
      if (content.traffic && Array.isArray(content.traffic) && content.traffic.length > 0) {
        html += '<div><h3 style="font-size: 1.125rem; font-weight: 600; color: #111827; margin-bottom: 0.75rem;">交通信息</h3>';
        html += '<div style="display: grid; gap: 0.75rem;">';
        content.traffic.forEach((traffic, index) => {
          html += `
            <div style="padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-weight: 600; color: #111827; font-size: 1rem;">${escapeHtml(traffic.route || traffic.location || `路况 ${index + 1}`)}</span>
                ${traffic.id ? `<span style="color: #6b7280; font-size: 0.75rem;">ID: ${traffic.id}</span>` : ''}
              </div>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;">
                ${traffic.time ? `
                  <div>
                    <span style="color: #6b7280; font-size: 0.75rem;">时间：</span>
                    <span style="color: #111827;">${escapeHtml(traffic.time)}</span>
                  </div>
                ` : ''}
                ${traffic.type ? `
                  <div>
                    <span style="color: #6b7280; font-size: 0.75rem;">类型：</span>
                    <span style="color: #111827; font-weight: 500;">${escapeHtml(traffic.type)}</span>
                  </div>
                ` : ''}
                ${traffic.location ? `
                  <div>
                    <span style="color: #6b7280; font-size: 0.75rem;">位置：</span>
                    <span style="color: #111827;">${escapeHtml(traffic.location)}</span>
                  </div>
                ` : ''}
                ${traffic.status ? `
                  <div>
                    <span style="color: #6b7280; font-size: 0.75rem;">状态：</span>
                    <span style="color: #111827;">${escapeHtml(traffic.status)}</span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        });
        html += '</div></div>';
      }
      
      html += '</div>';
      return html;
    }

    function renderExchangeRateContent(content) {
      // 检查内容是否为空
      if (!content) {
        return '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无汇率数据</div>';
      }
      
      // 检查是否是空对象
      if (typeof content === 'object' && !Array.isArray(content)) {
        const keys = Object.keys(content);
        // 排除标准字段
        const standardFields = ['id', 'name', 'title', 'slug', 'excerpt', 'description', 'htmlContent', 'image', 'category', 'tags', 'published', 'views', 'createdAt', 'updatedAt', 'detailApi', 'updateTime'];
        const rateKeys = keys.filter(key => !standardFields.includes(key));
        if (rateKeys.length === 0) {
          return '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无汇率数据</div>';
        }
      }

      let html = '<div style="overflow-x: auto;">';
      
      // 如果是数组格式
      if (Array.isArray(content)) {
        if (content.length === 0) {
          return '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无汇率数据</div>';
        }
        html += '<table class="admin-table" style="width: 100%;">';
        html += '<thead><tr><th>来源货币</th><th>目标货币</th><th>汇率</th><th>更新时间</th></tr></thead>';
        html += '<tbody>';
        content.forEach(item => {
          html += `
            <tr>
              <td>${escapeHtml(item.fromCurrency || '')}</td>
              <td>${escapeHtml(item.toCurrency || '')}</td>
              <td>${escapeHtml(String(item.rate || ''))}</td>
              <td>${escapeHtml(item.updateTime || '')}</td>
            </tr>
          `;
        });
        html += '</tbody></table>';
      } else {
        // 对象格式：{CNY: {EGP: 6.74}, USD: {EGP: 30.5}}
        const standardFields = ['id', 'name', 'title', 'slug', 'excerpt', 'description', 'htmlContent', 'image', 'category', 'tags', 'published', 'views', 'createdAt', 'updatedAt', 'detailApi', 'updateTime'];
        const rateKeys = Object.keys(content).filter(key => !standardFields.includes(key));
        
        if (rateKeys.length === 0) {
          return '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无汇率数据</div>';
        }
        
        // 先收集所有有效的汇率数据
        let hasValidRates = false;
        let tableRows = '';
        
        rateKeys.forEach(fromCurrency => {
          const rates = content[fromCurrency];
          if (typeof rates === 'object' && rates !== null && !Array.isArray(rates)) {
            Object.keys(rates).forEach(toCurrency => {
              const rateValue = rates[toCurrency];
              if (rateValue !== null && rateValue !== undefined && rateValue !== '') {
                hasValidRates = true;
                tableRows += `
                  <tr>
                    <td>${escapeHtml(fromCurrency)}</td>
                    <td>${escapeHtml(toCurrency)}</td>
                    <td>${escapeHtml(String(rateValue))}</td>
                  </tr>
                `;
              }
            });
          }
        });
        
        // 如果没有有效的汇率数据，返回空状态
        if (!hasValidRates) {
          return '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无汇率数据</div>';
        }
        
        html += '<table class="admin-table" style="width: 100%;">';
        html += '<thead><tr><th>来源货币</th><th>目标货币</th><th>汇率</th></tr></thead>';
        html += '<tbody>';
        html += tableRows;
        html += '</tbody></table>';
      }
      
      html += '</div>';
      return html;
    }

    function renderTranslationContent(content) {
      if (!Array.isArray(content) || content.length === 0) {
        return '<div class="blog-empty" style="padding: 2rem; text-align: center;">暂无翻译数据</div>';
      }

      // 响应式网格布局：根据窗口大小自动调整列数
      // 使用CSS Grid的auto-fit和minmax实现响应式，减小卡片尺寸以显示更多列
      // 确保容器有正确的宽度，让Grid布局能正确计算列数
      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem; padding: 0.5rem; width: 100%; box-sizing: border-box;">';
      content.forEach((item, index) => {
        html += `
          <div style="padding: 0.625rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; transition: box-shadow 0.2s; min-width: 0;" onmouseover="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
              <div style="min-width: 0;">
                <div style="font-size: 0.625rem; color: #6b7280; margin-bottom: 0.125rem; font-weight: 500;">中文</div>
                <div style="font-weight: 500; color: #111827; font-size: 0.8125rem; word-break: break-word; line-height: 1.4;">${escapeHtml(item.chinese || '')}</div>
              </div>
              <div style="min-width: 0;">
                <div style="font-size: 0.625rem; color: #6b7280; margin-bottom: 0.125rem; font-weight: 500;">阿拉伯文</div>
                <div style="font-weight: 500; color: #111827; font-size: 0.8125rem; direction: rtl; text-align: right; word-break: break-word; line-height: 1.4;">${escapeHtml(item.arabic || '')}</div>
              </div>
            </div>
            ${item.category ? `<div style="font-size: 0.625rem; color: #6b7280; padding-top: 0.375rem; border-top: 1px solid #f3f4f6;">分类: ${escapeHtml(item.category)}</div>` : ''}
          </div>
        `;
      });
      html += '</div>';
      return html;
    }

    // 天气编辑表单管理
    async function showWeatherEditForm() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/special-content/weather`);
        if (!response || !response.success || !response.data) {
          showToast('未找到天气API，请先创建', 'error');
          return;
        }
        
        const content = response.data.content || {};
        loadWeatherDataToForm(content);
        
        document.getElementById('weatherEditForm').style.display = 'block';
        document.getElementById('weatherEditBtn').style.display = 'none';
        document.getElementById('weatherCancelBtn').style.display = 'inline-block';
        document.getElementById('weatherContent').style.display = 'none';
      } catch (error) {
        console.error('加载天气数据失败:', error);
        showToast('加载失败: ' + (error.message || '未知错误'), 'error');
      }
    }
    
    function hideWeatherEditForm() {
      document.getElementById('weatherEditForm').style.display = 'none';
      document.getElementById('weatherEditBtn').style.display = 'inline-block';
      document.getElementById('weatherCancelBtn').style.display = 'none';
      document.getElementById('weatherContent').style.display = 'block';
      // 重新加载天气内容，确保正确显示
      loadSpecialContent('weather');
    }
    
    function loadWeatherDataToForm(content) {
      // 加载全局预警
      if (content.globalAlert) {
        document.getElementById('weatherGlobalAlertLevel').value = content.globalAlert.level || 'medium';
        document.getElementById('weatherGlobalAlertMessage').value = content.globalAlert.message || '';
      }
      
      // 加载景点
      const attractionsContainer = document.getElementById('weatherAttractionsList');
      attractionsContainer.innerHTML = '';
      weatherAttractionsCounter = 0;
      if (content.attractions && Array.isArray(content.attractions)) {
        content.attractions.forEach((attraction, index) => {
          attraction._index = index;
          addWeatherAttraction(attraction);
          weatherAttractionsCounter++;
        });
      }
      if (weatherAttractionsCounter === 0) {
        addWeatherAttraction();
      }
      
      // 加载交通
      const trafficContainer = document.getElementById('weatherTrafficList');
      trafficContainer.innerHTML = '';
      weatherTrafficCounter = 0;
      if (content.traffic && Array.isArray(content.traffic)) {
        content.traffic.forEach((traffic, index) => {
          traffic._index = index;
          addWeatherTraffic(traffic);
          weatherTrafficCounter++;
        });
      }
      if (weatherTrafficCounter === 0) {
        addWeatherTraffic();
      }
    }
    
    async function saveWeatherContent(event) {
      event.preventDefault();
      try {
        const data = collectWeatherData();
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/special-content/weather`, {
          method: 'PUT',
          body: JSON.stringify({ content: data })
        });
        
        if (response && response.success) {
          showToast('天气内容保存成功', 'success');
          hideWeatherEditForm();
          loadSpecialContent('weather');
        } else {
          showToast('保存失败: ' + (response?.message || '未知错误'), 'error');
        }
      } catch (error) {
        console.error('保存天气内容失败:', error);
        showToast('保存失败: ' + (error.message || '未知错误'), 'error');
      }
    }
    
    function collectWeatherData() {
      const data = {
        globalAlert: {
          level: document.getElementById('weatherGlobalAlertLevel').value,
          message: document.getElementById('weatherGlobalAlertMessage').value.trim()
        },
        attractions: [],
        traffic: []
      };
      
      // 收集景点
      const attractionsContainer = document.getElementById('weatherAttractionsList');
      const attractionItems = attractionsContainer.querySelectorAll('.weather-item');
      attractionItems.forEach((item, index) => {
        const idInput = item.querySelector('.weather-attraction-id');
        const nameInput = item.querySelector('.weather-attraction-name');
        const tempInput = item.querySelector('.weather-attraction-temperature');
        const visibilityInput = item.querySelector('.weather-attraction-visibility');
        const uvIndexInput = item.querySelector('.weather-attraction-uvIndex');
        const windSpeedInput = item.querySelector('.weather-attraction-windSpeed');
        const suggestionInput = item.querySelector('.weather-attraction-suggestion');
        
        const name = nameInput.value.trim();
        const temperature = tempInput.value.trim();
        
        if (!name || !temperature) {
          return; // 跳过空项
        }
        
        const attraction = {
          id: idInput.value ? parseInt(idInput.value) : index + 1,
          name: name,
          temperature: parseInt(temperature),
        };
        
        if (visibilityInput.value.trim()) attraction.visibility = visibilityInput.value.trim();
        if (uvIndexInput.value) attraction.uvIndex = parseInt(uvIndexInput.value);
        if (windSpeedInput.value.trim()) attraction.windSpeed = windSpeedInput.value.trim();
        if (suggestionInput.value.trim()) attraction.suggestion = suggestionInput.value.trim();
        
        data.attractions.push(attraction);
      });
      
      // 收集交通
      const trafficContainer = document.getElementById('weatherTrafficList');
      const trafficItems = trafficContainer.querySelectorAll('.weather-item');
      trafficItems.forEach((item, index) => {
        const idInput = item.querySelector('.weather-traffic-id');
        const timeInput = item.querySelector('.weather-traffic-time');
        const typeInput = item.querySelector('.weather-traffic-type');
        const locationInput = item.querySelector('.weather-traffic-location');
        const routeInput = item.querySelector('.weather-traffic-route');
        const statusInput = item.querySelector('.weather-traffic-status');
        
        const time = timeInput.value.trim();
        const type = typeInput.value;
        
        if (!time || !type) {
          return; // 跳过空项
        }
        
        const traffic = {
          id: idInput.value ? parseInt(idInput.value) : index + 1,
          time: time,
          type: type,
        };
        
        if (locationInput.value.trim()) traffic.location = locationInput.value.trim();
        if (routeInput.value.trim()) traffic.route = routeInput.value.trim();
        if (statusInput.value.trim()) traffic.status = statusInput.value.trim();
        
        data.traffic.push(traffic);
      });
      
      return data;
    }
    
    // 汇率编辑表单管理
    async function showExchangeRateEditForm() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/special-content/exchange-rate`);
        if (!response || !response.success || !response.data) {
          showToast('未找到汇率API，请先创建', 'error');
          return;
        }
        
        const content = response.data.content || {};
        loadExchangeRateDataToForm(content);
        
        document.getElementById('exchangeRateEditForm').style.display = 'block';
        document.getElementById('exchangeRateEditBtn').style.display = 'none';
        document.getElementById('exchangeRateCancelBtn').style.display = 'inline-block';
        document.getElementById('exchangeRateContent').style.display = 'none';
      } catch (error) {
        console.error('加载汇率数据失败:', error);
        showToast('加载失败: ' + (error.message || '未知错误'), 'error');
      }
    }
    
    function hideExchangeRateEditForm() {
      document.getElementById('exchangeRateEditForm').style.display = 'none';
      document.getElementById('exchangeRateEditBtn').style.display = 'inline-block';
      document.getElementById('exchangeRateCancelBtn').style.display = 'none';
      document.getElementById('exchangeRateContent').style.display = 'block';
      // 重新加载汇率内容，确保正确显示
      loadSpecialContent('exchange-rate');
    }
    
    function loadExchangeRateDataToForm(content) {
      const ratesContainer = document.getElementById('exchangeRatesList');
      ratesContainer.innerHTML = '';
      exchangeRatesCounter = 0;
      
      // 处理数组格式
      if (Array.isArray(content)) {
        content.forEach((item, index) => {
          addExchangeRate({
            fromCurrency: item.fromCurrency,
            toCurrency: item.toCurrency,
            rate: item.rate,
            _index: index
          });
          exchangeRatesCounter++;
        });
      } else if (typeof content === 'object') {
        // 处理对象格式 {CNY: {EGP: 6.74}}
        Object.keys(content).forEach(fromCurrency => {
          if (['id', 'name', 'title', 'slug', 'excerpt', 'description', 'htmlContent', 'image', 'category', 'tags', 'published', 'views', 'createdAt', 'updatedAt', 'detailApi', 'updateTime'].includes(fromCurrency)) {
            return;
          }
          const rates = content[fromCurrency];
          if (typeof rates === 'object' && !Array.isArray(rates)) {
            Object.keys(rates).forEach(toCurrency => {
              addExchangeRate({
                fromCurrency: fromCurrency,
                toCurrency: toCurrency,
                rate: rates[toCurrency],
                _index: exchangeRatesCounter
              });
              exchangeRatesCounter++;
            });
          }
        });
      }
      
      if (exchangeRatesCounter === 0) {
        addExchangeRate();
      }
      
      // 加载更新时间
      if (content.updateTime) {
        const date = new Date(content.updateTime);
        const localDateTime = date.toISOString().slice(0, 16);
        document.getElementById('exchangeUpdateTime').value = localDateTime;
      }
    }
    
    async function saveExchangeRateContent(event) {
      event.preventDefault();
      try {
        const data = collectExchangeRateData();
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/special-content/exchange-rate`, {
          method: 'PUT',
          body: JSON.stringify({ content: data })
        });
        
        if (response && response.success) {
          showToast('汇率内容保存成功', 'success');
          hideExchangeRateEditForm();
          loadSpecialContent('exchange-rate');
        } else {
          showToast('保存失败: ' + (response?.message || '未知错误'), 'error');
        }
      } catch (error) {
        console.error('保存汇率内容失败:', error);
        showToast('保存失败: ' + (error.message || '未知错误'), 'error');
      }
    }
    
    function collectExchangeRateData() {
      const rates = [];
      const updateTime = document.getElementById('exchangeUpdateTime').value;
      
      const ratesContainer = document.getElementById('exchangeRatesList');
      const rateItems = ratesContainer.querySelectorAll('.exchange-rate-item');
      
      rateItems.forEach(item => {
        const fromInput = item.querySelector('.exchange-rate-from');
        const toInput = item.querySelector('.exchange-rate-to');
        const rateInput = item.querySelector('.exchange-rate-value');
        
        const fromCurrency = fromInput.value.trim().toUpperCase();
        const toCurrency = toInput.value.trim().toUpperCase();
        const rate = parseFloat(rateInput.value);
        
        if (fromCurrency && toCurrency && !isNaN(rate) && rate > 0) {
          rates.push({
            fromCurrency: fromCurrency,
            toCurrency: toCurrency,
            rate: rate
          });
        }
      });
      
      const result = {};
      rates.forEach(item => {
        if (!result[item.fromCurrency]) {
          result[item.fromCurrency] = {};
        }
        result[item.fromCurrency][item.toCurrency] = item.rate;
      });
      
      if (updateTime) {
        result.updateTime = updateTime;
      }
      
      return result;
    }
    
    // 翻译编辑表单管理
    let translationCounter = 0;
    
    async function showTranslationEditForm() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/special-content/translation`);
        if (!response || !response.success || !response.data) {
          showToast('未找到翻译API，请先创建', 'error');
          return;
        }
        
        const content = response.data.content || [];
        loadTranslationDataToForm(content);
        
        document.getElementById('translationEditForm').style.display = 'block';
        document.getElementById('translationEditBtn').style.display = 'none';
        document.getElementById('translationCancelBtn').style.display = 'inline-block';
        document.getElementById('translationContent').style.display = 'none';
      } catch (error) {
        console.error('加载翻译数据失败:', error);
        showToast('加载失败: ' + (error.message || '未知错误'), 'error');
      }
    }
    
    function hideTranslationEditForm() {
      document.getElementById('translationEditForm').style.display = 'none';
      document.getElementById('translationEditBtn').style.display = 'inline-block';
      document.getElementById('translationCancelBtn').style.display = 'none';
      document.getElementById('translationContent').style.display = 'block';
      // 重新加载翻译内容，确保正确显示多列布局
      loadSpecialContent('translation');
    }
    
    function loadTranslationDataToForm(content) {
      const translationContainer = document.getElementById('translationList');
      translationContainer.innerHTML = '';
      translationCounter = 0;
      
      if (Array.isArray(content) && content.length > 0) {
        content.forEach((item, index) => {
          addTranslationItem(item, index);
          translationCounter++;
        });
      } else {
        addTranslationItem();
      }
    }
    
    function addTranslationItem(item = null, index = null) {
      const container = document.getElementById('translationList');
      const itemIndex = index !== null ? index : translationCounter++;
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'translation-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = itemIndex;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #9333ea;">翻译 #${itemIndex + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeTranslationItem(${itemIndex})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">删除</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0.75rem;">
          <div class="admin-form-group" style="margin-bottom: 0;">
            <label class="admin-form-label" style="font-size: 0.875rem;">中文 *</label>
            <input type="text" class="admin-form-input translation-chinese" value="${item ? escapeHtml(item.chinese || '') : ''}" placeholder="输入中文" required style="font-size: 0.875rem;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0;">
            <label class="admin-form-label" style="font-size: 0.875rem;">阿拉伯文 *</label>
            <input type="text" class="admin-form-input translation-arabic" value="${item ? escapeHtml(item.arabic || '') : ''}" placeholder="输入阿拉伯文" required dir="rtl" style="font-size: 0.875rem;">
          </div>
        </div>
        <div class="admin-form-group" style="margin-bottom: 0;">
          <label class="admin-form-label" style="font-size: 0.875rem;">分类</label>
          <input type="text" class="admin-form-input translation-category" value="${item ? escapeHtml(item.category || '') : ''}" placeholder="输入分类（可选）" style="font-size: 0.875rem;">
        </div>
      `;
      
      container.appendChild(itemDiv);
    }
    
    function removeTranslationItem(index) {
      const container = document.getElementById('translationList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('确定要删除这条翻译吗？')) {
        item.remove();
      }
    }
    
    async function saveTranslationContent(event) {
      event.preventDefault();
      try {
        const data = collectTranslationData();
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/special-content/translation`, {
          method: 'PUT',
          body: JSON.stringify({ content: data })
        });
        
        if (response && response.success) {
          showToast('翻译内容保存成功', 'success');
          hideTranslationEditForm();
          loadSpecialContent('translation');
        } else {
          showToast('保存失败: ' + (response?.message || '未知错误'), 'error');
        }
      } catch (error) {
        console.error('保存翻译内容失败:', error);
        showToast('保存失败: ' + (error.message || '未知错误'), 'error');
      }
    }
    
    function collectTranslationData() {
      const translations = [];
      const translationContainer = document.getElementById('translationList');
      const translationItems = translationContainer.querySelectorAll('.translation-item');
      
      translationItems.forEach(item => {
        const chineseInput = item.querySelector('.translation-chinese');
        const arabicInput = item.querySelector('.translation-arabic');
        const categoryInput = item.querySelector('.translation-category');
        
        const chinese = chineseInput.value.trim();
        const arabic = arabicInput.value.trim();
        const category = categoryInput.value.trim();
        
        if (chinese && arabic) {
          const translation = {
            chinese: chinese,
            arabic: arabic
          };
          if (category) {
            translation.category = category;
          }
          translations.push(translation);
        }
      });
      
      return translations;
    }

    // 批量操作相关函数
    let selectedPostIds = new Set();
    
    // 更新选择状态
    function updateSelection() {
      const checkboxes = document.querySelectorAll('.post-checkbox:checked');
      selectedPostIds.clear();
      checkboxes.forEach(checkbox => {
        selectedPostIds.add(checkbox.value);
      });
      
      const count = selectedPostIds.size;
      const selectedCountNum = document.getElementById('selectedCountNum');
      const batchActions = document.getElementById('batchActions');
      
      if (selectedCountNum) {
        selectedCountNum.textContent = count;
      }
      
      if (batchActions) {
        batchActions.style.display = count > 0 ? 'flex' : 'none';
      }
      
      // 更新全选复选框状态
      const selectAllCheckbox = document.getElementById('selectAllPosts');
      if (selectAllCheckbox) {
        const allCheckboxes = document.querySelectorAll('.post-checkbox:not(#selectAllPosts)');
        const allChecked = allCheckboxes.length > 0 && Array.from(allCheckboxes).every(cb => cb.checked);
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = !allChecked && count > 0;
      }
    }
    
    // 全选/取消全选
    function toggleSelectAll(checkbox) {
      const allCheckboxes = document.querySelectorAll('.post-checkbox:not(#selectAllPosts)');
      allCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
      });
      updateSelection();
    }
    
    // 全选草稿
    function selectAllDrafts() {
      const draftCheckboxes = document.querySelectorAll('.post-checkbox[data-published="false"]');
      draftCheckboxes.forEach(cb => {
        cb.checked = true;
      });
      updateSelection();
      
      const count = draftCheckboxes.length;
      if (count > 0) {
        showToast(`已选择 ${count} 篇草稿文章`, 'success');
      } else {
        showToast('没有找到草稿文章', 'info');
      }
    }
    
    // 清除选择
    function clearSelection() {
      const allCheckboxes = document.querySelectorAll('.post-checkbox');
      allCheckboxes.forEach(cb => {
        cb.checked = false;
      });
      selectedPostIds.clear();
      updateSelection();
    }
    
    // 批量发布
    async function batchPublish() {
      const selectedIds = Array.from(selectedPostIds);
      
      if (selectedIds.length === 0) {
        showToast('请先选择要发布的文章', 'warning');
        return;
      }
      
      // 确认对话框
      const confirmed = confirm(`确定要批量发布选中的 ${selectedIds.length} 篇文章吗？`);
      if (!confirmed) {
        return;
      }
      
      try {
        showToast('正在批量发布...', 'info');
        
        // 调用批量发布API
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts/batch-publish`, {
          method: 'POST',
          body: JSON.stringify({ ids: selectedIds })
        });
        
        if (response && response.success) {
          const successCount = response.data?.successCount || 0;
          const failedCount = response.data?.failedCount || 0;
          
          if (failedCount === 0) {
            showToast(`成功发布 ${successCount} 篇文章`, 'success');
          } else {
            showToast(`成功发布 ${successCount} 篇，失败 ${failedCount} 篇`, 'warning');
          }
          
          // 清除选择并刷新列表
          clearSelection();
          loadPosts(false);
        } else {
          showToast('批量发布失败: ' + (response?.message || '未知错误'), 'error');
        }
      } catch (error) {
        console.error('批量发布失败:', error);
        showToast('批量发布失败: ' + (error.message || '未知错误'), 'error');
      }
    }

    // 初始化
    // 获取URL参数
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // 检查URL参数并自动打开编辑对话框
    async function checkUrlParams() {
      const editId = getUrlParam('edit');
      const copyId = getUrlParam('copy');
      const action = getUrlParam('action');
      
      // 只有在明确有edit或copy参数时才显示表单
      if (editId) {
        // 等待页面加载完成后再执行编辑
        setTimeout(async () => {
          await editPostInternal(editId);
          // 清除URL参数，避免刷新时重复执行
          const url = new URL(window.location);
          url.searchParams.delete('edit');
          window.history.replaceState({}, '', url);
        }, 500);
      }
      
      if (copyId) {
        // 等待页面加载完成后再执行复制
        setTimeout(async () => {
          await copyPostInternal(copyId);
          // 清除URL参数，避免刷新时重复执行
          const url = new URL(window.location);
          url.searchParams.delete('copy');
          window.history.replaceState({}, '', url);
        }, 500);
      }
      
      // 如果有action=new参数，显示新建表单（仅在新窗口中）
      if (action === 'new' && window.opener) {
        setTimeout(() => {
          showPostForm();
        }, 500);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // 首先检查认证状态
      const isAuthenticated = await checkAuth();
      
      // 如果未认证，不继续初始化
      if (!isAuthenticated) {
        return;
      }

      // 确保所有表单默认隐藏（除非有明确的URL参数）
      const postForm = document.getElementById('postForm');
      const categoryForm = document.getElementById('categoryForm');
      
      const action = getUrlParam('action');
      const editId = getUrlParam('edit');
      const copyId = getUrlParam('copy');
      
      // 只有在明确有edit、copy或action=new参数时才显示文章表单
      if (postForm && !editId && !copyId && action !== 'new') {
        postForm.style.display = 'none';
      }
      
      // 确保分类表单默认隐藏
      if (categoryForm) {
        categoryForm.style.display = 'none';
      }
      
      // 如果是在新窗口中打开编辑或复制页面，只加载必要的资源
      const isEditWindow = window.opener && (editId || copyId || action === 'new');
      
      // 如果不是编辑窗口，初始化默认标签页
      if (!isEditWindow) {
        // 确保默认折叠所有分类
        expandedCategories.clear();
        
        // 确保表单隐藏
        if (postForm) {
          postForm.style.display = 'none';
        }
        
        // 确保文章标签页是激活状态并加载数据
        const postsTab = document.querySelector('.admin-tab.active');
        if (postsTab && postsTab.textContent.trim() === '文章') {
          // 如果文章标签页已经是激活状态，直接加载数据（默认折叠）
          loadPosts(true);
          loadApis();
        } else {
          // 否则切换到文章标签页（会自动加载数据，默认折叠）
          switchTab('posts');
        }
      } else if (isEditWindow) {
        // 新窗口：隐藏不相关的元素，只显示编辑表单
        hideUnnecessaryElements();
        // 更新页面标题
        if (copyId) {
          updatePageTitleForEdit('复制文章');
        } else {
          updatePageTitleForEdit();
        }
        // 立即显示表单和加载提示（等待DOM完全加载）
        setTimeout(() => {
          const postForm = document.getElementById('postForm');
          const postFormLoading = document.getElementById('postFormLoading');
          const postFormContent = document.getElementById('postFormContent');
          if (postForm) {
            postForm.style.display = 'block';
            postForm.classList.add('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'flex';
          }
          if (postFormContent) {
            postFormContent.style.display = 'none';
          }
        }, 100);
      } else {
        // 主窗口：加载文章列表
      loadPosts();
      }
      
      // 所有窗口都需要加载API列表
      loadApis();
      
      // 监听图片URL输入框变化，实时更新预览
      const postImageInput = document.getElementById('postImage');
      if (postImageInput) {
        postImageInput.addEventListener('input', function() {
          updateImagePreview(this.value);
        });
        
        // 初始化时也检查一次
        updateImagePreview(postImageInput.value);
      }
      
      // 检查URL参数，如果有edit参数，自动打开编辑对话框
      await checkUrlParams();
    });
    
    // 隐藏新窗口中不需要的元素
    function hideUnnecessaryElements() {
      // 隐藏标签页导航
      const tabsContainer = document.querySelector('.admin-tabs');
      if (tabsContainer) {
        tabsContainer.style.display = 'none';
      }
      
      // 隐藏文章管理标题和新建按钮
      const postsHeader = document.querySelector('#tab-posts > div:first-child');
      if (postsHeader) {
        postsHeader.style.display = 'none';
      }
      
      // 隐藏文章列表 - 使用更精确的选择器
      // 查找包含文章列表表格的admin-card容器
      const postsTableBody = document.getElementById('postsTableBody');
      if (postsTableBody) {
        // 向上查找包含它的admin-card容器
        let parent = postsTableBody.closest('.admin-card');
        if (parent) {
          parent.style.display = 'none';
        }
      }
      
      // 也隐藏移动端的文章列表容器
      const postsTableMobile = document.getElementById('postsTableBodyMobile');
      if (postsTableMobile) {
        let parent = postsTableMobile.closest('.admin-card');
        if (parent && parent.style.display !== 'none') {
          parent.style.display = 'none';
        }
      }
      
      // 隐藏文章列表的加载进度条容器
      const postsLoadingProgress = document.getElementById('postsLoadingProgress');
      if (postsLoadingProgress) {
        let parent = postsLoadingProgress.closest('.admin-card');
        if (parent && parent.style.display !== 'none') {
          parent.style.display = 'none';
        }
      }
      
      // 隐藏所有文章列表相关的加载提示（包括移动端）
      const blogLoadingElements = document.querySelectorAll('#tab-posts .blog-loading');
      blogLoadingElements.forEach(element => {
        element.style.display = 'none';
      });
      
      // 确保移动端文章列表容器也被隐藏
      const postsTableBodyMobile = document.getElementById('postsTableBodyMobile');
      if (postsTableBodyMobile) {
        postsTableBodyMobile.style.display = 'none';
      }
      
      // 隐藏其他标签页内容
      const otherTabs = ['tab-categories', 'tab-tags', 'tab-comments'];
      otherTabs.forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (tab) {
          tab.style.display = 'none';
        }
      });
      
      // 确保文章表单容器可见
      const postsTab = document.getElementById('tab-posts');
      if (postsTab) {
        postsTab.style.display = 'block';
        postsTab.classList.add('active');
      }
      
      // 隐藏"返回博客"按钮（新窗口中不需要）
      const returnButton = document.querySelector('.admin-header a[href="/blog.html"]');
      if (returnButton) {
        returnButton.style.display = 'none';
      }
      
      // 调整容器样式，让编辑表单更突出
      const adminContainer = document.querySelector('.admin-container');
      if (adminContainer) {
        adminContainer.style.maxWidth = '100%';
        adminContainer.style.padding = '1rem';
      }
    }
    
    // 更新页面标题为编辑模式
    function updatePageTitleForEdit(customTitle) {
      const headerTitle = document.querySelector('.admin-header h1');
      if (headerTitle) {
        headerTitle.textContent = customTitle || '编辑文章';
      }
      
      const headerSubtitle = document.querySelector('.admin-header p');
      if (headerSubtitle) {
        if (customTitle === '复制文章') {
          headerSubtitle.textContent = '复制并编辑文章内容';
        } else {
          headerSubtitle.textContent = '编辑文章内容';
        }
      }
    }
    
    /**
     * 上传图片到服务器（通用函数）
     * @param {File} file - 图片文件
     * @returns {Promise<string>} 返回图片URL
     */
    async function uploadImageToServer(file) {
      // 验证文件类型
      if (!file.type.startsWith('image/')) {
        throw new Error('请选择图片文件');
      }
      
      // 验证文件大小（10MB）
      if (file.size > 10 * 1024 * 1024) {
        throw new Error('图片文件大小不能超过10MB');
      }
      
      // 创建FormData
      const formData = new FormData();
      formData.append('image', file);
      
      // 发送上传请求
      const response = await fetch('/api/admin/custom-apis/upload-image', {
        method: 'POST',
        body: formData,
        credentials: 'same-origin' // 包含cookie用于身份验证
      });
      
      const result = await response.json();
      
      if (!response.ok || !result.success) {
        throw new Error(result.message || '上传失败');
      }
      
      // 返回图片URL
      return result.image.url;
    }
    
    /**
     * 上传视频到服务器（通用函数）
     * @param {File} file - 视频文件
     * @param {Function} onProgress - 进度回调函数 (progress: number) => void
     * @returns {Promise<string>} 返回视频URL
     */
    async function uploadVideoToServer(file, onProgress) {
      // 验证文件类型
      if (!file.type.startsWith('video/')) {
        throw new Error('请选择视频文件');
      }
      
      // 验证文件大小（200MB）
      if (file.size > 200 * 1024 * 1024) {
        throw new Error('视频文件大小不能超过200MB');
      }
      
      // 检查文件格式
      const ext = file.name.split('.').pop().toLowerCase();
      const supportedFormats = ['mp4', 'mov', 'webm', 'ogg', 'ogv', 'avi', 'wmv', 'flv', 'mkv', 'm4v'];
      if (!supportedFormats.includes(ext)) {
        throw new Error(`不支持的视频格式（${ext}）。支持的格式：${supportedFormats.join(', ')}`);
      }
      
      // 创建FormData
      const formData = new FormData();
      formData.append('video', file);
      
      // 使用XMLHttpRequest以支持上传进度
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        let uploadComplete = false;
        let taskId = null;
        let progressInterval = null;
        
        // 监听上传进度
        if (onProgress) {
          // 立即显示开始上传
          onProgress(0, '开始上传...');
          
          xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable && !uploadComplete) {
              // 上传进度（0-30%），剩余70%用于服务器端处理（转换通常需要更长时间）
              const percentComplete = Math.min((e.loaded / e.total) * 30, 30);
              const uploadPercent = Math.round((e.loaded / e.total) * 100);
              onProgress(percentComplete, `上传中... ${uploadPercent}%`);
            }
          });
        }
        
        // 监听完成（上传完成，开始处理）
        xhr.addEventListener('load', function() {
          uploadComplete = true;
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              const result = JSON.parse(xhr.responseText);
              if (result.success && result.taskId) {
                taskId = result.taskId;
                
                // 开始轮询进度
                if (onProgress) {
                  onProgress(30, '上传完成，开始处理...');
                }
                
                // 轮询进度（每200ms）
                progressInterval = setInterval(async () => {
                  try {
                    const progressResponse = await fetch(`/api/admin/custom-apis/video-upload-progress/${taskId}?t=${Date.now()}`, {
                      credentials: 'include',
                      cache: 'no-cache'
                    });
                    
                    if (progressResponse.ok) {
                      const progressData = await progressResponse.json();
                      
                      if (progressData.success) {
                        if (progressData.running) {
                          // 更新进度
                          const progress = progressData.progress || {};
                          const percent = Math.min(Math.max(progress.percent || 0, 0), 100);
                          const message = progress.message || '处理中...';
                          
                          // 进度映射：30% - 100%（上传完成后，处理阶段）
                          // 30% + (percent * 0.7) = 30% + 70%的处理进度
                          const totalPercent = Math.min(30 + (percent * 0.7), 100);
                          if (onProgress) {
                            onProgress(totalPercent, message);
                          }
                        } else {
                          // 处理完成或出错
                          clearInterval(progressInterval);
                          progressInterval = null;
                          
                          if (progressData.error) {
                            if (onProgress) {
                              onProgress(0, '处理失败');
                            }
                            reject(new Error(progressData.error));
                          } else if (progressData.result) {
                            // 完成，返回视频信息
                            if (onProgress) {
                              onProgress(100, '处理完成');
                            }
                            resolve(progressData.result);
                          } else {
                            if (onProgress) {
                              onProgress(0, '处理失败');
                            }
                            reject(new Error('处理完成但未返回结果'));
                          }
                        }
                      } else {
                        clearInterval(progressInterval);
                        progressInterval = null;
                        if (onProgress) {
                          onProgress(0, '获取进度失败');
                        }
                        reject(new Error(progressData.message || '获取进度失败'));
                      }
                    } else {
                      clearInterval(progressInterval);
                      progressInterval = null;
                      if (onProgress) {
                        onProgress(0, '获取进度失败');
                      }
                      reject(new Error('获取进度失败: ' + progressResponse.statusText));
                    }
                  } catch (pollError) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                    if (onProgress) {
                      onProgress(0, '轮询失败');
                    }
                    reject(new Error('轮询进度失败: ' + pollError.message));
                  }
                }, 200); // 每200ms轮询一次
                
                // 设置最大轮询时间（10分钟）
                setTimeout(() => {
                  if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                    if (onProgress) {
                      onProgress(0, '处理超时');
                    }
                    reject(new Error('处理超时，请稍后重试'));
                  }
                }, 10 * 60 * 1000);
              } else {
                if (onProgress) {
                  onProgress(0, '上传失败');
                }
                reject(new Error(result.message || '上传失败'));
              }
            } catch (e) {
              if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
              }
              if (onProgress) {
                onProgress(0, '解析失败');
              }
              reject(new Error('解析响应失败'));
            }
          } else {
            try {
              const errorResult = JSON.parse(xhr.responseText);
              reject(new Error(errorResult.message || '上传失败: ' + xhr.statusText));
            } catch (e) {
              reject(new Error('上传失败: ' + xhr.statusText));
            }
          }
        });
        
        // 监听错误
        xhr.addEventListener('error', function() {
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
          if (onProgress) {
            onProgress(0, '网络错误');
          }
          reject(new Error('网络错误，请检查网络连接'));
        });
        
        // 监听超时
        xhr.addEventListener('timeout', function() {
          if (progressInterval) {
            clearInterval(progressInterval);
            progressInterval = null;
          }
          if (onProgress) {
            onProgress(0, '上传超时');
          }
          reject(new Error('上传超时，视频文件可能过大或网络较慢'));
        });
        
        // 设置超时时间（5分钟，因为视频上传可能需要时间）
        xhr.timeout = 5 * 60 * 1000;
        
        // 发送请求
        xhr.open('POST', '/api/admin/custom-apis/upload-video');
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.withCredentials = true; // 包含cookie用于身份验证
        xhr.send(formData);
      });
    }
    
    /**
     * 确保URL是完整的网络地址（兼容小程序等环境）
     * @param {string} url - 可能是相对路径或完整URL
     * @returns {string} 完整的网络地址
     */
    function ensureFullUrl(url) {
      if (!url) return '';
      
      // 如果已经是完整的URL（http:// 或 https://），直接返回
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return url;
      }
      
      // 如果是相对路径（以 / 开头），转换为完整URL
      if (url.startsWith('/')) {
        const protocol = window.location.protocol;
        const host = window.location.host;
        return `${protocol}//${host}${url}`;
      }
      
      // 如果是相对路径（不以 / 开头），基于当前路径
      if (!url.startsWith('//')) {
        const protocol = window.location.protocol;
        const host = window.location.host;
        const basePath = window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/'));
        return `${protocol}//${host}${basePath}/${url}`;
      }
      
      // 如果是协议相对URL（//example.com），添加当前协议
      if (url.startsWith('//')) {
        return `${window.location.protocol}${url}`;
      }
      
      return url;
    }
    
    /**
     * 验证poster URL是否是图片（不能是视频）
     * @param {string} posterUrl - poster URL
     * @returns {boolean} 如果是图片返回true，如果是视频返回false
     */
    function isValidPosterUrl(posterUrl) {
      if (!posterUrl) return false;
      
      // 视频文件扩展名
      const videoExtensions = ['.mp4', '.mov', '.webm', '.ogg', '.ogv', '.avi', '.wmv', '.flv', '.mkv', '.m4v', '.mpg', '.mpeg', '.3gp'];
      
      // 检查URL是否包含视频扩展名
      const urlLower = posterUrl.toLowerCase();
      for (const ext of videoExtensions) {
        if (urlLower.includes(ext)) {
          return false; // 是视频文件，无效
        }
      }
      
      // 图片文件扩展名
      const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg', '.bmp', '.ico'];
      
      // 检查URL是否包含图片扩展名
      for (const ext of imageExtensions) {
        if (urlLower.includes(ext)) {
          return true; // 是图片文件，有效
        }
      }
      
      // 如果没有明确的扩展名，检查URL路径中是否包含图片相关的关键词
      if (urlLower.includes('/image') || urlLower.includes('/img') || urlLower.includes('/picture') || urlLower.includes('/photo')) {
        return true; // 可能是图片
      }
      
      // 如果包含视频相关的关键词，返回false
      if (urlLower.includes('/video') || urlLower.includes('/videos')) {
        return false;
      }
      
      // 默认情况下，如果没有明确的视频扩展名，允许（可能是图片）
      return true;
    }
    
    /**
     * 生成视频HTML代码
     * @param {string} videoUrl - 视频URL
     * @param {string} format - 视频格式：'video-tag' | 'video-source' | 'video-link'
     * @param {string} posterUrl - 封面图片URL（可选）
     * @returns {string} 视频HTML代码
     */
    /**
     * 确保HTML内容中所有视频和图片URL都是完整的网络地址（兼容小程序等环境）
     * @param {string} html - HTML内容
     * @returns {string} 处理后的HTML内容
     */
    function ensureFullUrlsInHtml(html) {
      if (!html) return html;
      
      // 处理img标签的src属性（确保图片URL是完整的网络地址）
      html = html.replace(/<img([^>]*)>/gi, function(match, attrs) {
        const srcMatch = attrs.match(/src=["']([^"']*)["']/i);
        if (srcMatch) {
          const originalSrc = srcMatch[1];
          // 检查是否是根目录的文件（如 /IMG_1343.MOV），应该移动到uploads目录
          // 但这里只转换URL，不移动文件
          const fullSrc = ensureFullUrl(originalSrc);
          const newAttrs = attrs.replace(/src=["'][^"']*["']/i, `src="${fullSrc}"`);
          return `<img${newAttrs}>`;
        }
        return match;
      });
      
      // 处理video标签的src和poster属性
      html = html.replace(/<video([^>]*)>/gi, function(match, attrs) {
        // 提取src和poster属性
        const srcMatch = attrs.match(/src=["']([^"']*)["']/i);
        const posterMatch = attrs.match(/poster=["']([^"']*)["']/i);
        
        let newAttrs = attrs;
        
        // 处理src属性
        if (srcMatch) {
          const originalSrc = srcMatch[1];
          const fullSrc = ensureFullUrl(originalSrc);
          newAttrs = newAttrs.replace(/src=["'][^"']*["']/i, `src="${fullSrc}"`);
        }
        
        // 处理poster属性（验证必须是图片，不能是视频）
        if (posterMatch) {
          const originalPoster = posterMatch[1];
          const fullPoster = ensureFullUrl(originalPoster);
          
          // 验证poster是否是图片（不能是视频）
          if (isValidPosterUrl(fullPoster)) {
            newAttrs = newAttrs.replace(/poster=["'][^"']*["']/i, `poster="${fullPoster}"`);
          } else {
            // poster是视频URL，移除poster属性（兼容微信小程序）
            console.warn('检测到poster属性使用了视频URL，已移除（poster必须是图片）', { posterUrl: fullPoster });
            newAttrs = newAttrs.replace(/poster=["'][^"']*["']/i, '');
          }
        }
        
        return `<video${newAttrs}>`;
      });
      
      // 处理source标签的src属性（在video标签内）
      html = html.replace(/<source([^>]*)>/gi, function(match, attrs) {
        const srcMatch = attrs.match(/src=["']([^"']*)["']/i);
        if (srcMatch) {
          const originalSrc = srcMatch[1];
          const fullSrc = ensureFullUrl(originalSrc);
          const newAttrs = attrs.replace(/src=["'][^"']*["']/i, `src="${fullSrc}"`);
          return `<source${newAttrs}>`;
        }
        return match;
      });
      
      return html;
    }
    
    /**
     * 移除HTML内容中的所有base64图片和视频
     * @param {string} html - HTML内容
     * @returns {string} 清理后的HTML内容
     */
    function removeBase64Content(html) {
      if (!html) return html;
      
      // 移除base64图片 (data:image/...)
      html = html.replace(/<img[^>]*src=["']data:image\/[^"']*["'][^>]*>/gi, '');
      
      // 移除base64视频 (data:video/...)
      html = html.replace(/<video[^>]*src=["']data:video\/[^"']*["'][^>]*>.*?<\/video>/gi, '');
      html = html.replace(/<source[^>]*src=["']data:video\/[^"']*["'][^>]*>/gi, '');
      
      // 移除包含base64的style属性
      html = html.replace(/style=["'][^"']*data:image\/[^"']*["']/gi, '');
      html = html.replace(/style=["'][^"']*data:video\/[^"']*["']/gi, '');
      
      // 移除blob: URL
      html = html.replace(/src=["']blob:[^"']*["']/gi, '');
      html = html.replace(/href=["']blob:[^"']*["']/gi, '');
      
      return html;
    }
    
    function generateVideoHtml(videoUrl, format, posterUrl = '') {
      // 确保URL是完整的网络地址（兼容小程序等环境）
      const fullVideoUrl = ensureFullUrl(videoUrl);
      
      // 验证并处理poster URL
      let fullPosterUrl = '';
      if (posterUrl) {
        const fullPoster = ensureFullUrl(posterUrl);
        // 验证poster是否是图片（不能是视频）
        if (isValidPosterUrl(fullPoster)) {
          fullPosterUrl = fullPoster;
        } else {
          // poster是视频URL，发出警告并忽略
          console.warn('poster属性使用了视频URL，已忽略（poster必须是图片）', { posterUrl: fullPoster });
          showToast('警告：封面图片URL不能是视频文件，已忽略poster属性', 'warning');
        }
      }
      
      // 转义URL中的特殊字符
      const escapedVideoUrl = fullVideoUrl.replace(/"/g, '&quot;');
      const escapedPosterUrl = fullPosterUrl ? fullPosterUrl.replace(/"/g, '&quot;') : '';
      
      // 响应式样式字符串
      const responsiveVideoStyle = 'max-width: 100%; width: 100%; height: auto; display: block; margin: 1rem auto; border-radius: 0.375rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
      const responsiveIframeStyle = 'max-width: 100%; width: 100%; height: 400px; min-height: 400px; display: block; margin: 1rem auto; border-radius: 0.375rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none;';
      
      switch (format) {
        case 'video-tag':
          // 方式1: 直接 video 标签（符合示例格式：<video src="..." poster="..."></video>）
          // 确保使用完整的网络地址，兼容小程序环境
          if (fullPosterUrl) {
            return `<video src="${escapedVideoUrl}" poster="${escapedPosterUrl}" controls style="${responsiveVideoStyle}"></video>`;
          } else {
            return `<video src="${escapedVideoUrl}" controls style="${responsiveVideoStyle}"></video>`;
          }
        case 'video-source':
          // 方式2: video 标签包含 source（支持多种格式）
          // 检测视频文件扩展名来确定MIME类型
          const videoExt = escapedVideoUrl.split('.').pop().toLowerCase();
          let videoType = 'video/mp4'; // 默认
          if (videoExt === 'mov' || videoExt === 'qt') {
            videoType = 'video/quicktime';
          } else if (videoExt === 'webm') {
            videoType = 'video/webm';
          } else if (videoExt === 'ogg' || videoExt === 'ogv') {
            videoType = 'video/ogg';
          } else if (videoExt === 'avi') {
            videoType = 'video/x-msvideo';
          } else if (videoExt === 'wmv') {
            videoType = 'video/x-ms-wmv';
          } else if (videoExt === 'flv') {
            videoType = 'video/x-flv';
          } else if (videoExt === 'mkv') {
            videoType = 'video/x-matroska';
          }
          
          // 确保使用完整的网络地址（poster已在上方验证）
          if (fullPosterUrl) {
            return `<video poster="${escapedPosterUrl}" controls style="${responsiveVideoStyle}">
  <source src="${escapedVideoUrl}" type="${videoType}">
</video>`;
          } else {
            return `<video controls style="${responsiveVideoStyle}">
  <source src="${escapedVideoUrl}" type="${videoType}">
</video>`;
          }
        case 'youtube-iframe':
          // 方式3: YouTube iframe嵌入（符合示例格式：<iframe src="https://www.youtube.com/embed/VIDEO_ID"></iframe>）
          // 从YouTube URL中提取视频ID
          let videoId = '';
          if (videoUrl.includes('youtube.com/watch?v=')) {
            videoId = videoUrl.split('v=')[1].split('&')[0];
          } else if (videoUrl.includes('youtu.be/')) {
            videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
          } else if (videoUrl.includes('youtube.com/embed/')) {
            videoId = videoUrl.split('embed/')[1].split('?')[0];
          } else {
            // 假设直接输入的是视频ID
            videoId = videoUrl.trim();
          }
          
          if (!videoId) {
            throw new Error('无法从URL中提取YouTube视频ID');
          }
          
          return `<iframe src="https://www.youtube.com/embed/${videoId}" style="${responsiveIframeStyle}"></iframe>`;
        case 'video-link':
          // 方式4: 视频链接（会显示为可点击的链接）
          return `<a href="${escapedVideoUrl}" target="_blank" style="display: inline-block; padding: 0.5rem 1rem; background: #9333ea; color: white; text-decoration: none; border-radius: 0.25rem; margin: 1rem 0;">📹 视频链接</a>`;
        default:
          // 默认使用方式1（符合示例格式）
          // 确保使用完整的网络地址（poster已在上方验证）
          if (fullPosterUrl) {
            return `<video src="${escapedVideoUrl}" poster="${escapedPosterUrl}" controls style="${responsiveVideoStyle}"></video>`;
          } else {
            return `<video src="${escapedVideoUrl}" controls style="${responsiveVideoStyle}"></video>`;
          }
      }
    }
    
    /**
     * 处理图片上传（用于表单中的图片URL输入框）
     */
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) {
        return;
      }
      
      // 验证文件类型
      if (!file.type.startsWith('image/')) {
        alert('请选择图片文件');
        event.target.value = '';
        return;
      }
      
      // 验证文件大小（10MB）
      if (file.size > 10 * 1024 * 1024) {
        alert('图片文件大小不能超过10MB');
        event.target.value = '';
        return;
      }
      
      // 显示上传进度
      const progressDiv = document.getElementById('imageUploadProgress');
      const progressBar = document.getElementById('imageUploadProgressBar');
      const statusSpan = document.getElementById('imageUploadStatus');
      
      progressDiv.style.display = 'block';
      progressBar.style.width = '0%';
      statusSpan.textContent = '上传中...';
      
      try {
        // 模拟上传进度
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress < 90) {
            progressBar.style.width = progress + '%';
          }
        }, 100);
        
        // 使用通用上传函数
        const imageUrl = await uploadImageToServer(file);
        
        clearInterval(progressInterval);
        
        // 上传成功
        progressBar.style.width = '100%';
        statusSpan.textContent = '上传成功！';
        
        // 填充到图片URL输入框
        document.getElementById('postImage').value = imageUrl;
        
        // 更新预览
        updateImagePreview(imageUrl);
        
        // 2秒后隐藏进度条
        setTimeout(() => {
          progressDiv.style.display = 'none';
          progressBar.style.width = '0%';
        }, 2000);
        
        // 清空文件输入框，允许重复上传同一文件
        event.target.value = '';
        
      } catch (error) {
        console.error('图片上传失败:', error);
        progressBar.style.width = '0%';
        statusSpan.textContent = '上传失败: ' + error.message;
        statusSpan.style.color = '#ef4444';
        
        setTimeout(() => {
          progressDiv.style.display = 'none';
          statusSpan.style.color = '#6b7280';
        }, 3000);
        
        event.target.value = '';
      }
    }
    
    /**
     * 更新图片预览
     */
    function updateImagePreview(imageUrl) {
      // 更新封面图预览
      const coverImagePreview = document.getElementById('coverImagePreview');
      const coverImagePlaceholder = document.getElementById('coverImagePlaceholder');
      const coverImageOverlay = document.getElementById('coverImageOverlay');
      
      if (coverImagePreview && coverImagePlaceholder && coverImageOverlay) {
        if (imageUrl && imageUrl.trim()) {
          coverImagePreview.src = imageUrl;
          coverImagePreview.style.display = 'block';
          coverImagePlaceholder.style.display = 'none';
          coverImageOverlay.style.display = 'none';
        } else {
          coverImagePreview.style.display = 'none';
          coverImagePlaceholder.style.display = 'flex';
          coverImageOverlay.style.display = 'none';
        }
      }
      
      // 兼容旧的预览方式
      const previewDiv = document.getElementById('imagePreview');
      const previewImg = document.getElementById('imagePreviewImg');
      
      if (previewDiv && previewImg) {
        if (imageUrl && imageUrl.trim()) {
          previewImg.src = imageUrl;
          previewDiv.style.display = 'block';
        } else {
          previewDiv.style.display = 'none';
        }
      }
    }
    
    // 封面图容器鼠标事件
    document.addEventListener('DOMContentLoaded', function() {
      const coverImageContainer = document.getElementById('coverImageContainer');
      const coverImageOverlay = document.getElementById('coverImageOverlay');
      
      if (coverImageContainer && coverImageOverlay) {
        coverImageContainer.addEventListener('mouseenter', function() {
          const coverImagePreview = document.getElementById('coverImagePreview');
          if (coverImagePreview && coverImagePreview.style.display === 'block') {
            coverImageOverlay.style.display = 'flex';
          }
        });
        
        coverImageContainer.addEventListener('mouseleave', function() {
          coverImageOverlay.style.display = 'none';
        });
      }
    });
    
    /**
     * 同步name和title字段
     */
    function syncNameAndTitle() {
      const nameInput = document.getElementById('postName');
      if (nameInput) {
        // name和title保持一致，这里只需要确保name字段的值正确即可
        // title会在保存时自动设置为与name相同
      }
    }
    
    /**
     * 显示调试信息面板
     */
    function showDebugInfo(info) {
      // 创建或获取调试面板
      let debugPanel = document.getElementById('debugPanel');
      if (!debugPanel) {
        debugPanel = document.createElement('div');
        debugPanel.id = 'debugPanel';
        debugPanel.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          width: 500px;
          max-height: 80vh;
          background: #1f2937;
          color: #f3f4f6;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
          z-index: 10000;
          font-family: 'Courier New', monospace;
          font-size: 12px;
          overflow-y: auto;
          display: none;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = '×';
        closeBtn.style.cssText = `
          position: absolute;
          top: 10px;
          right: 10px;
          background: #ef4444;
          color: white;
          border: none;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 20px;
          line-height: 1;
        `;
        closeBtn.onclick = () => {
          debugPanel.style.display = 'none';
        };
        debugPanel.appendChild(closeBtn);
        
        const title = document.createElement('h3');
        title.textContent = '调试信息';
        title.style.cssText = 'margin: 0 0 15px 0; color: #60a5fa;';
        debugPanel.appendChild(title);
        
        document.body.appendChild(debugPanel);
      }
      
      // 清空内容（保留标题和关闭按钮）
      const title = debugPanel.querySelector('h3');
      const closeBtn = debugPanel.querySelector('button');
      debugPanel.innerHTML = '';
      debugPanel.appendChild(closeBtn);
      debugPanel.appendChild(title);
      
      // 添加调试信息
      const sections = [
        { title: '请求数据', data: info.request },
        { title: '响应数据', data: info.response },
        { title: '特殊类型', data: info.specialType },
        { title: '特殊数据', data: info.specialData }
      ];
      
      sections.forEach(section => {
        if (section.data) {
          const sectionDiv = document.createElement('div');
          sectionDiv.style.cssText = 'margin-bottom: 15px;';
          
          const sectionTitle = document.createElement('h4');
          sectionTitle.textContent = section.title;
          sectionTitle.style.cssText = 'color: #34d399; margin: 0 0 5px 0; font-size: 14px;';
          sectionDiv.appendChild(sectionTitle);
          
          const pre = document.createElement('pre');
          pre.style.cssText = 'margin: 0; padding: 10px; background: #111827; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;';
          pre.textContent = JSON.stringify(section.data, null, 2);
          sectionDiv.appendChild(pre);
          
          debugPanel.appendChild(sectionDiv);
        }
      });
      
      // 显示面板
      debugPanel.style.display = 'block';
      
      // 5秒后自动隐藏（可选）
      setTimeout(() => {
        if (debugPanel.style.display === 'block') {
          debugPanel.style.display = 'none';
        }
      }, 10000);
    }

    // ==================== 地图选点功能 ====================
    let mapPickerModal = null;
    let mapPickerMap = null;
    let mapPickerMarker = null;
    let mapPickerCurrentType = null; // 'common', 'second-hand', 'rentals'

    // 打开地图选点弹窗
    function openMapPicker(type) {
      mapPickerCurrentType = type;
      
      // 创建或显示弹窗
      if (!mapPickerModal) {
        createMapPickerModal();
      }
      
      mapPickerModal.style.display = 'flex';
      
      // 加载Leaflet库（如果未加载）
      if (typeof L === 'undefined') {
        loadLeafletLibrary(() => {
          initMapPicker();
        });
      } else {
        initMapPicker();
      }
    }

    // 创建地图选点弹窗
    function createMapPickerModal() {
      mapPickerModal = document.createElement('div');
      mapPickerModal.id = 'mapPickerModal';
      mapPickerModal.style.cssText = `
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      `;

      // 弹窗头部
      const header = document.createElement('div');
      header.style.cssText = `
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      `;
      header.innerHTML = `
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #374151;">地图选点</h3>
        <button id="mapPickerCloseBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
      `;

      // 搜索框
      const searchContainer = document.createElement('div');
      searchContainer.style.cssText = `
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
      `;
      searchContainer.innerHTML = `
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" id="mapPickerSearchInput" placeholder="搜索地址（如：开罗市中心、Cairo）" 
            style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
          <button id="mapPickerSearchBtn" class="blog-btn blog-btn-primary" style="white-space: nowrap;">搜索</button>
        </div>
        <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">在地图上点击选择位置，或搜索地址后点击结果</p>
      `;

      // 地图容器
      const mapContainer = document.createElement('div');
      mapContainer.id = 'mapPickerMap';
      mapContainer.style.cssText = `
        width: 100%;
        height: 500px;
        min-height: 400px;
        background: #f3f4f6;
      `;

      // 底部按钮
      const footer = document.createElement('div');
      footer.style.cssText = `
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
      `;
      footer.innerHTML = `
        <button id="mapPickerCancelBtn" class="blog-btn blog-btn-secondary">取消</button>
        <button id="mapPickerConfirmBtn" class="blog-btn blog-btn-primary">确认选择</button>
      `;

      modalContent.appendChild(header);
      modalContent.appendChild(searchContainer);
      modalContent.appendChild(mapContainer);
      modalContent.appendChild(footer);
      mapPickerModal.appendChild(modalContent);
      document.body.appendChild(mapPickerModal);

      // 绑定事件
      document.getElementById('mapPickerCloseBtn').onclick = closeMapPicker;
      document.getElementById('mapPickerCancelBtn').onclick = closeMapPicker;
      document.getElementById('mapPickerConfirmBtn').onclick = confirmMapPicker;
      document.getElementById('mapPickerSearchBtn').onclick = searchAddress;
      document.getElementById('mapPickerSearchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          searchAddress();
        }
      });

      // 点击背景关闭
      mapPickerModal.addEventListener('click', (e) => {
        if (e.target === mapPickerModal) {
          closeMapPicker();
        }
      });
    }

    // 加载Leaflet库
    function loadLeafletLibrary(callback) {
      // 加载CSS
      if (!document.querySelector('link[href*="leaflet"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css';
        link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
        link.crossOrigin = '';
        document.head.appendChild(link);
      }

      // 加载JS
      if (typeof L === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
        script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
        script.crossOrigin = '';
        script.onload = callback;
        script.onerror = () => {
          showToast('地图库加载失败，请刷新重试', 'error');
        };
        document.head.appendChild(script);
      } else {
        callback();
      }
    }

    // 初始化地图
    function initMapPicker() {
      const mapContainer = document.getElementById('mapPickerMap');
      if (!mapContainer || !window.L) return;

      // 获取当前经纬度（如果有）
      let currentLat = 30.0444; // 开罗默认位置
      let currentLng = 31.2357;
      
      const addressInput = document.getElementById(getAddressInputId());
      const latInput = document.getElementById(getLatitudeInputId());
      const lngInput = document.getElementById(getLongitudeInputId());
      
      if (latInput && latInput.value) {
        currentLat = parseFloat(latInput.value) || currentLat;
      }
      if (lngInput && lngInput.value) {
        currentLng = parseFloat(lngInput.value) || currentLng;
      }

      // 清除旧地图
      if (mapPickerMap) {
        mapPickerMap.remove();
        mapPickerMap = null;
        mapPickerMarker = null;
      }

      // 创建新地图
      mapPickerMap = L.map('mapPickerMap').setView([currentLat, currentLng], latInput && latInput.value ? 15 : 13);

      // 添加OpenStreetMap图层
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(mapPickerMap);

      // 添加标记（如果有现有值）
      if (latInput && latInput.value && lngInput && lngInput.value) {
        mapPickerMarker = L.marker([currentLat, currentLng]).addTo(mapPickerMap);
        mapPickerMarker.bindPopup(`当前位置<br>${addressInput && addressInput.value ? escapeHtml(addressInput.value) : `${currentLat.toFixed(4)}, ${currentLng.toFixed(4)}`}`).openPopup();
        
        // 如果有地址，显示在搜索框
        if (addressInput && addressInput.value) {
          document.getElementById('mapPickerSearchInput').value = addressInput.value;
        } else {
          // 如果没有地址，尝试反向地理编码
          reverseGeocode(currentLat, currentLng);
        }
      }

      // 地图点击事件
      mapPickerMap.on('click', (e) => {
        const { lat, lng } = e.latlng;
        updateMapMarker(lat, lng);
      });
    }

    // 更新地图标记
    function updateMapMarker(lat, lng) {
      if (!mapPickerMap) return;

      if (mapPickerMarker) {
        mapPickerMarker.setLatLng([lat, lng]);
      } else {
        mapPickerMarker = L.marker([lat, lng]).addTo(mapPickerMap);
      }
      
      mapPickerMap.setView([lat, lng], mapPickerMap.getZoom());
      
      // 反向地理编码获取地址
      reverseGeocode(lat, lng);
    }

    // 搜索地址
    async function searchAddress() {
      const searchInput = document.getElementById('mapPickerSearchInput');
      const query = searchInput.value.trim();
      
      if (!query) {
        showToast('请输入搜索关键词', 'warning');
        return;
      }

      try {
        // 使用Nominatim进行地理编码（免费）
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (!response.ok) {
          throw new Error('搜索失败');
        }

        const results = await response.json();
        
        if (results.length === 0) {
          showToast('未找到相关地址', 'warning');
          return;
        }

        // 如果只有一个结果，直接定位
        if (results.length === 1) {
          const result = results[0];
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          updateMapMarker(lat, lng);
          document.getElementById('mapPickerSearchInput').value = result.display_name;
          showToast('已定位到搜索结果', 'success');
        } else {
          // 多个结果，显示选择列表
          showSearchResults(results);
        }
      } catch (error) {
        console.error('地址搜索失败:', error);
        showToast('地址搜索失败，请稍后重试', 'error');
      }
    }

    // 显示搜索结果列表
    function showSearchResults(results) {
      // 移除旧的结果列表
      const oldResults = document.getElementById('mapPickerSearchResults');
      if (oldResults) {
        oldResults.remove();
      }

      const resultsContainer = document.createElement('div');
      resultsContainer.id = 'mapPickerSearchResults';
      resultsContainer.style.cssText = `
        position: absolute;
        top: 80px;
        left: 1.5rem;
        right: 1.5rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        max-height: 300px;
        overflow-y: auto;
        z-index: 10001;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      `;

      results.forEach((result, index) => {
        const item = document.createElement('div');
        item.style.cssText = `
          padding: 0.75rem 1rem;
          border-bottom: 1px solid #f3f4f6;
          cursor: pointer;
          transition: background 0.2s;
        `;
        item.style.cssText += index === results.length - 1 ? 'border-bottom: none;' : '';
        item.innerHTML = `
          <div style="font-weight: 500; color: #374151; margin-bottom: 0.25rem;">${escapeHtml(result.display_name)}</div>
          <div style="font-size: 0.75rem; color: #6b7280;">${result.lat}, ${result.lon}</div>
        `;
        item.onmouseover = () => { item.style.background = '#f9fafb'; };
        item.onmouseout = () => { item.style.background = 'white'; };
        item.onclick = () => {
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          updateMapMarker(lat, lng);
          document.getElementById('mapPickerSearchInput').value = result.display_name;
          resultsContainer.remove();
          showToast('已定位到选择的位置', 'success');
        };
        resultsContainer.appendChild(item);
      });

      const modalContent = mapPickerModal.querySelector('div');
      modalContent.style.position = 'relative';
      modalContent.appendChild(resultsContainer);
    }

    // 反向地理编码（根据经纬度获取地址）
    async function reverseGeocode(lat, lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.display_name) {
            document.getElementById('mapPickerSearchInput').value = result.display_name;
          }
        }
      } catch (error) {
        console.error('反向地理编码失败:', error);
        // 失败不影响使用，只是不显示地址
      }
    }

    // 确认选择
    function confirmMapPicker() {
      if (!mapPickerMarker) {
        showToast('请先在地图上选择位置', 'warning');
        return;
      }

      const latlng = mapPickerMarker.getLatLng();
      const lat = latlng.lat.toFixed(6);
      const lng = latlng.lng.toFixed(6);
      const address = document.getElementById('mapPickerSearchInput').value.trim();

      // 更新对应的输入框
      const addressInput = document.getElementById(getAddressInputId());
      const latInput = document.getElementById(getLatitudeInputId());
      const lngInput = document.getElementById(getLongitudeInputId());

      if (addressInput) {
        addressInput.value = address || `${lat}, ${lng}`;
      }
      if (latInput) {
        latInput.value = lat;
      }
      if (lngInput) {
        lngInput.value = lng;
      }

      showToast('位置已选择', 'success');
      closeMapPicker();
    }

    // 关闭地图选点弹窗
    function closeMapPicker() {
      if (mapPickerModal) {
        mapPickerModal.style.display = 'none';
        // 清除搜索结果
        const results = document.getElementById('mapPickerSearchResults');
        if (results) {
          results.remove();
        }
      }
    }

    // 获取当前类型的输入框ID
    function getAddressInputId() {
      switch (mapPickerCurrentType) {
        case 'second-hand':
          return 'secondHandAddress';
        case 'rentals':
          return 'rentalsAddress';
        case 'common':
        default:
          return 'commonAddress';
      }
    }

    function getLatitudeInputId() {
      switch (mapPickerCurrentType) {
        case 'second-hand':
          return 'secondHandLatitude';
        case 'rentals':
          return 'rentalsLatitude';
        case 'common':
        default:
          return 'commonLatitude';
      }
    }

    function getLongitudeInputId() {
      switch (mapPickerCurrentType) {
        case 'second-hand':
          return 'secondHandLongitude';
        case 'rentals':
          return 'rentalsLongitude';
        case 'common':
        default:
          return 'commonLongitude';
      }
    }

    // ==================== 谷歌地图链接解析功能 ====================
    let linkParserModal = null;
    let linkParserCurrentType = null;

    // 打开链接解析弹窗
    function openLinkParser(type) {
      linkParserCurrentType = type;
      
      // 创建或显示弹窗
      if (!linkParserModal) {
        createLinkParserModal();
      }
      
      linkParserModal.style.display = 'flex';
      const input = document.getElementById('linkParserInput');
      if (input) {
        input.value = '';
        input.focus();
      }
    }

    // 创建链接解析弹窗
    function createLinkParserModal() {
      linkParserModal = document.createElement('div');
      linkParserModal.id = 'linkParserModal';
      linkParserModal.style.cssText = `
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 600px;
        padding: 2rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      `;

      // 弹窗头部
      const header = document.createElement('div');
      header.style.cssText = `
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      `;
      header.innerHTML = `
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #374151;">解析谷歌地图链接</h3>
        <button id="linkParserCloseBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
      `;

      // 输入框
      const inputContainer = document.createElement('div');
      inputContainer.style.cssText = `margin-bottom: 1rem;`;
      inputContainer.innerHTML = `
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">粘贴谷歌地图链接：</label>
        <input type="text" id="linkParserInput" placeholder="例如：https://www.google.com/maps?q=30.0444,31.2357 或 https://maps.google.com/?q=开罗" 
          style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-sizing: border-box;">
        <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">
          支持格式：<br>
          • https://www.google.com/maps?q=30.0444,31.2357<br>
          • https://maps.google.com/?q=地址名称<br>
          • https://www.google.com/maps/@30.0444,31.2357,15z<br>
          • https://www.google.com/maps/place/.../@30.0444,31.2357,15z<br>
          • https://maps.app.goo.gl/...（短链接）<br>
          • https://goo.gl/maps/...（短链接）
        </p>
      `;

      // 底部按钮
      const footer = document.createElement('div');
      footer.style.cssText = `
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1.5rem;
      `;
      footer.innerHTML = `
        <button id="linkParserCancelBtn" class="blog-btn blog-btn-secondary">取消</button>
        <button id="linkParserParseBtn" class="blog-btn blog-btn-primary">解析并填充</button>
      `;

      modalContent.appendChild(header);
      modalContent.appendChild(inputContainer);
      modalContent.appendChild(footer);
      linkParserModal.appendChild(modalContent);
      document.body.appendChild(linkParserModal);

      // 绑定事件
      document.getElementById('linkParserCloseBtn').onclick = closeLinkParser;
      document.getElementById('linkParserCancelBtn').onclick = closeLinkParser;
      document.getElementById('linkParserParseBtn').onclick = parseGoogleMapsLink;
      document.getElementById('linkParserInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          parseGoogleMapsLink();
        }
      });

      // 点击背景关闭
      linkParserModal.addEventListener('click', (e) => {
        if (e.target === linkParserModal) {
          closeLinkParser();
        }
      });
    }

    // 解析谷歌地图链接
    async function parseGoogleMapsLink() {
      const input = document.getElementById('linkParserInput');
      const link = input.value.trim();
      
      if (!link) {
        showToast('请输入谷歌地图链接', 'warning');
        return;
      }

      try {
        // 检查是否是短链接（goo.gl 或 maps.app.goo.gl）
        const isShortLink = /^(https?:\/\/)?(maps\.app\.)?goo\.gl\/.+$/i.test(link) || 
                            /^(https?:\/\/)?maps\.app\.goo\.gl\/.+$/i.test(link);

        let lat = null;
        let lng = null;
        let address = null;

        // 如果是短链接，使用后端API解析
        if (isShortLink) {
          try {
            // 使用adminApiRequest函数确保正确的认证和错误处理
            const result = await adminApiRequest('/api/admin/parse-google-maps-link', {
              method: 'POST',
              body: JSON.stringify({ link: link })
            });
            
            if (!result) {
              // adminApiRequest返回null表示需要登录
              return;
            }
            
            if (result.success && result.data) {
              lat = result.data.lat;
              lng = result.data.lng;
              address = result.data.address;
              
              // 如果后端返回了经纬度
              if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
                // 如果没有地址，尝试反向地理编码
                if (!address) {
                  try {
                    const addressResult = await reverseGeocodeFromLink(lat, lng);
                    if (addressResult) {
                      address = addressResult;
                    }
                  } catch (error) {
                    console.warn('反向地理编码失败，将只填充经纬度:', error);
                  }
                }
                
                fillLocationFields(lat, lng, address);
                showToast('位置信息已填充', 'success');
                closeLinkParser();
                return;
              }
              
              // 如果只有地址名称，进行地理编码
              if (address && (lat === null || lng === null)) {
                try {
                  const geocodeResult = await geocodeAddress(address);
                  if (geocodeResult && geocodeResult.lat && geocodeResult.lng) {
                    fillLocationFields(geocodeResult.lat, geocodeResult.lng, geocodeResult.address || address);
                    showToast('位置信息已填充', 'success');
                    closeLinkParser();
                    return;
                  }
                } catch (error) {
                  console.error('地理编码失败:', error);
                }
              }
            } else {
              showToast(result.message || '无法解析该短链接', 'error');
              return;
            }
          } catch (error) {
            console.error('后端解析短链接失败:', error);
            showToast('短链接解析失败，请稍后重试', 'error');
            return;
          }
        } else {
          // 长链接，使用前端解析
          // 解析各种谷歌地图链接格式
          // 格式1: https://www.google.com/maps?q=30.0444,31.2357
          // 格式2: https://maps.google.com/?q=30.0444,31.2357
          let match = link.match(/[?&]q=([^&]+)/);
          if (match) {
            const qValue = decodeURIComponent(match[1]);
            // 检查是否是经纬度格式 (lat,lng)
            const coordsMatch = qValue.match(/^(-?\d+\.?\d*),(-?\d+\.?\d*)$/);
            if (coordsMatch) {
              lat = parseFloat(coordsMatch[1]);
              lng = parseFloat(coordsMatch[2]);
            } else {
              // 否则是地址名称，需要地理编码
              address = qValue;
            }
          }

          // 格式3: https://www.google.com/maps/@30.0444,31.2357,15z
          // 格式4: https://www.google.com/maps/place/.../@30.0444,31.2357,15z
          if (lat === null || lng === null) {
            match = link.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
          }

          // 格式5: 直接包含经纬度的URL参数
          if (lat === null || lng === null) {
            match = link.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
          }

          // 格式6: place链接，尝试从URL中提取
          if (lat === null || lng === null) {
            match = link.match(/place\/[^/]+\/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
          }

          // 如果找到了经纬度
          if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
            // 验证经纬度范围
            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
              // 使用反向地理编码获取地址
              try {
                const addressResult = await reverseGeocodeFromLink(lat, lng);
                if (addressResult) {
                  address = addressResult;
                }
              } catch (error) {
                console.warn('反向地理编码失败，将只填充经纬度:', error);
              }
              
              // 填充字段
              fillLocationFields(lat, lng, address);
              showToast('位置信息已填充', 'success');
              closeLinkParser();
              return;
            }
          }

          // 如果只有地址名称，进行地理编码
          if (address) {
            try {
              const result = await geocodeAddress(address);
              if (result && result.lat && result.lng) {
                fillLocationFields(result.lat, result.lng, result.address || address);
                showToast('位置信息已填充', 'success');
                closeLinkParser();
                return;
              }
            } catch (error) {
              console.error('地理编码失败:', error);
              showToast('无法解析该链接，请检查链接格式', 'error');
              return;
            }
          }

          // 如果都没有找到
          showToast('无法从链接中提取位置信息，请检查链接格式', 'error');
        }
      } catch (error) {
        console.error('解析链接失败:', error);
        showToast('解析失败，请稍后重试', 'error');
      }
    }

    // 反向地理编码（从经纬度获取地址）
    async function reverseGeocodeFromLink(lat, lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          return result.display_name || null;
        }
      } catch (error) {
        console.error('反向地理编码失败:', error);
      }
      return null;
    }

    // 地理编码（从地址获取经纬度）
    async function geocodeAddress(address) {
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (response.ok) {
          const results = await response.json();
          if (results.length > 0) {
            const result = results[0];
            return {
              lat: parseFloat(result.lat),
              lng: parseFloat(result.lon),
              address: result.display_name
            };
          }
        }
      } catch (error) {
        console.error('地理编码失败:', error);
      }
      return null;
    }

    // 填充位置字段
    function fillLocationFields(lat, lng, address) {
      const addressInput = document.getElementById(getAddressInputIdForParser());
      const latInput = document.getElementById(getLatitudeInputIdForParser());
      const lngInput = document.getElementById(getLongitudeInputIdForParser());

      if (addressInput) {
        addressInput.value = address || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
      if (latInput) {
        latInput.value = lat.toFixed(6);
      }
      if (lngInput) {
        lngInput.value = lng.toFixed(6);
      }
    }

    // 获取当前类型的输入框ID（用于链接解析）
    function getAddressInputIdForParser() {
      switch (linkParserCurrentType) {
        case 'second-hand':
          return 'secondHandAddress';
        case 'rentals':
          return 'rentalsAddress';
        case 'common':
        default:
          return 'commonAddress';
      }
    }

    function getLatitudeInputIdForParser() {
      switch (linkParserCurrentType) {
        case 'second-hand':
          return 'secondHandLatitude';
        case 'rentals':
          return 'rentalsLatitude';
        case 'common':
        default:
          return 'commonLatitude';
      }
    }

    function getLongitudeInputIdForParser() {
      switch (linkParserCurrentType) {
        case 'second-hand':
          return 'secondHandLongitude';
        case 'rentals':
          return 'rentalsLongitude';
        case 'common':
        default:
          return 'commonLongitude';
      }
    }

    // 关闭链接解析弹窗
    function closeLinkParser() {
      if (linkParserModal) {
        linkParserModal.style.display = 'none';
        const input = document.getElementById('linkParserInput');
        if (input) {
          input.value = '';
        }
      }
    }
  </script>
</body>
</html>
