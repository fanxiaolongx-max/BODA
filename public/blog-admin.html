<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åšå®¢ç®¡ç† - DevBlog</title>
  <link rel="stylesheet" href="/css/blog.css">
  <style>
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    .admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .admin-tabs {
      display: flex;
      gap: 1rem;
      border-bottom: 2px solid #e5e7eb;
      margin-bottom: 2rem;
    }
    .admin-tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      cursor: pointer;
      font-weight: 500;
      color: #6b7280;
      transition: all 0.3s;
    }
    .admin-tab.active {
      color: #9333ea;
      border-bottom-color: #9333ea;
    }
    .admin-tab-content {
      display: none;
    }
    .admin-tab-content.active {
      display: block;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .admin-table th {
      background: linear-gradient(to right, rgba(236, 72, 153, 0.1), rgba(147, 51, 234, 0.1));
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #171717;
    }
    .admin-table td {
      padding: 1rem;
      border-top: 1px solid #f3f4f6;
    }
    .admin-table tr:hover {
      background: rgba(147, 51, 234, 0.05);
    }
    .admin-table tr.category-header-row:hover {
      background: linear-gradient(to right, rgba(236, 72, 153, 0.15), rgba(147, 51, 234, 0.15));
    }
    .admin-table tr.category-header-row + tr {
      border-top: 2px solid rgba(147, 51, 234, 0.2);
    }
    .admin-form {
      background: white;
      padding: 2rem;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    .admin-form-group {
      margin-bottom: 1.5rem;
    }
    .admin-form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #374151;
    }
    .admin-form-input,
    .admin-form-textarea,
    .admin-form-select {
      width: 100%;
      max-width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
      box-sizing: border-box;
    }
    
    /* ç‰¹æ®Šç±»åˆ«è¡¨å•ä¸­çš„è¾“å…¥æ¡†æ ·å¼ */
    .weather-item .admin-form-input,
    .weather-item .admin-form-select,
    .exchange-rate-item .admin-form-input {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    /* ç¡®ä¿gridå¸ƒå±€ä¸­çš„è¾“å…¥æ¡†ä¸ä¼šæº¢å‡º */
    .weather-item > div[style*="grid"],
    .exchange-rate-item > div[style*="grid"] {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .weather-item .admin-form-group,
    .exchange-rate-item .admin-form-group {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }
    .admin-form-textarea {
      min-height: 200px;
      font-family: monospace;
    }
    .admin-form-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* æ–‡ç« è¡¨å•åŠ è½½æç¤ºæ ·å¼ */
    .post-form-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4rem 2rem;
      min-height: 300px;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid #e5e7eb;
      border-top-color: #9333ea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    
    .loading-text {
      color: #6b7280;
      font-size: 0.875rem;
      margin: 0;
      animation: pulse 1.5s ease-in-out infinite;
    }
    
    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    
    /* åŠ è½½æ—¶éšè—è¡¨å•å†…å®¹ */
    #postForm.loading #postFormContent {
      display: none;
    }
    
    #postForm.loading #postFormLoading {
      display: flex !important;
    }
    .admin-actions {
      display: flex;
      gap: 0.5rem;
    }
    .admin-btn-small {
      padding: 0.375rem 0.75rem;
      font-size: 0.875rem;
      border-radius: 0.375rem;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
    }
    .admin-btn-edit {
      background: #3b82f6;
      color: white;
    }
    .admin-btn-edit:hover {
      background: #2563eb;
    }
    .admin-btn-delete {
      background: #ef4444;
      color: white;
    }
    .admin-btn-delete:hover {
      background: #dc2626;
    }
    .admin-btn-copy {
      background: #10b981;
      color: white;
    }
    .admin-btn-copy:hover {
      background: #059669;
    }
    .admin-btn-approve {
      background: #10b981;
      color: white;
    }
    .admin-btn-approve:hover {
      background: #059669;
    }
    .markdown-editor {
      min-height: 400px;
    }
    
    /* SimpleMDE å·¥å…·æ æ ·å¼ä¿®å¤ */
    .editor-toolbar {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem 0.375rem 0 0;
      background: #f9fafb;
      padding: 0.5rem;
    }
    
    .editor-toolbar a {
      color: #374151;
      border: 1px solid transparent;
      border-radius: 0.25rem;
      padding: 0.375rem 0.5rem;
      margin: 0 0.125rem;
      display: inline-block;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .editor-toolbar a:hover {
      background: #e5e7eb;
      border-color: #d1d5db;
      color: #111827;
    }
    
    .editor-toolbar a.active {
      background: #9333ea;
      color: white;
      border-color: #9333ea;
    }
    
    .editor-toolbar i.separator {
      display: inline-block;
      width: 0;
      border-left: 1px solid #d1d5db;
      border-right: 1px solid #d1d5db;
      color: transparent;
      text-indent: -10000px;
      margin: 0 0.5rem;
      height: 1.5rem;
    }
    
    .editor-toolbar a.fa {
      font-family: FontAwesome;
      font-style: normal;
      font-weight: normal;
      text-decoration: none;
    }
    
    .CodeMirror {
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.375rem 0.375rem;
      font-size: 0.875rem;
      min-height: 400px;
    }
    
    .editor-preview {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 1rem;
      background: white;
    }
    
    .editor-preview-side {
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      padding: 1rem;
      background: white;
    }
  </style>
  <!-- Font Awesome for SimpleMDE toolbar icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
  <!-- SimpleMDE Markdown Editor -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
  <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
  <!-- Quill HTML Editor -->
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
</head>
<body class="blog-page">
  <div class="admin-container">
    <div class="admin-header">
      <div>
        <h1 style="font-size: 2rem; font-weight: bold; background: linear-gradient(to right, #ec4899, #9333ea); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
          åšå®¢ç®¡ç†
        </h1>
        <p style="color: #6b7280; margin-top: 0.5rem;">ç®¡ç†æ–‡ç« ã€åˆ†ç±»ã€æ ‡ç­¾å’Œè¯„è®º</p>
      </div>
      <div>
        <a href="/blog.html" class="blog-btn blog-btn-secondary">è¿”å›åšå®¢</a>
      </div>
    </div>

    <!-- æ ‡ç­¾é¡µ -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('posts', this)">æ–‡ç« </button>
      <button class="admin-tab" onclick="switchTab('categories', this)">åˆ†ç±»</button>
      <button class="admin-tab" onclick="switchTab('tags', this)">æ ‡ç­¾</button>
      <button class="admin-tab" onclick="switchTab('comments', this)">è¯„è®º</button>
    </div>

    <!-- æ–‡ç« ç®¡ç† -->
    <div id="tab-posts" class="admin-tab-content active">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>æ–‡ç« ç®¡ç†</h2>
        <button class="blog-btn blog-btn-primary" onclick="showPostForm()">æ–°å»ºæ–‡ç« </button>
      </div>

      <!-- æ–‡ç« è¡¨å• -->
      <div id="postForm" class="admin-form" style="display: none;">
        <!-- åŠ è½½æç¤º -->
        <div id="postFormLoading" class="post-form-loading" style="display: none;">
          <div class="loading-spinner"></div>
          <p class="loading-text">æ­£åœ¨åŠ è½½æ–‡ç« å†…å®¹...</p>
        </div>
        <!-- è¡¨å•å†…å®¹ -->
        <div id="postFormContent">
        <h3 id="postFormTitle">æ–°å»ºæ–‡ç« </h3>
        <form id="postFormElement" onsubmit="savePost(event)">
          <input type="hidden" id="postId">
          <div class="admin-form-group">
            <label class="admin-form-label" for="postName">æ–‡ç« åç§°/æ ‡é¢˜ *</label>
            <input type="text" id="postName" class="admin-form-input" required oninput="syncNameAndTitle()">
            <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">åç§°å’Œæ ‡é¢˜ä¼šè‡ªåŠ¨ä¿æŒåŒæ­¥</p>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postSlug">Slug</label>
            <input type="text" id="postSlug" class="admin-form-input" placeholder="ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postExcerpt">æ‘˜è¦</label>
            <textarea id="postExcerpt" class="admin-form-input" rows="3"></textarea>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postImage">å›¾ç‰‡URL</label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
              <input type="text" id="postImage" class="admin-form-input" style="flex: 1;" placeholder="è¾“å…¥å›¾ç‰‡URLæˆ–ç‚¹å‡»ä¸Šä¼ æŒ‰é’®ä¸Šä¼ å›¾ç‰‡">
              <button type="button" class="blog-btn blog-btn-secondary" onclick="document.getElementById('imageUploadInput').click()" style="white-space: nowrap;">
                <i class="fa fa-upload" style="margin-right: 0.25rem;"></i>ä¸Šä¼ å›¾ç‰‡
              </button>
            </div>
            <input type="file" id="imageUploadInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            <div id="imageUploadProgress" style="display: none; margin-top: 0.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="flex: 1; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                  <div id="imageUploadProgressBar" style="height: 100%; background: #9333ea; width: 0%; transition: width 0.3s;"></div>
                </div>
                <span id="imageUploadStatus" style="font-size: 0.875rem; color: #6b7280;">ä¸Šä¼ ä¸­...</span>
              </div>
            </div>
            <div id="imagePreview" style="margin-top: 0.5rem; display: none;">
              <img id="imagePreviewImg" src="" alt="é¢„è§ˆ" style="max-width: 200px; max-height: 200px; border-radius: 0.375rem; border: 1px solid #d1d5db;">
            </div>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="postApiName">API/åˆ†ç±» *</label>
            <select id="postApiName" class="admin-form-select" required onchange="onApiNameChange()">
              <option value="">è¯·é€‰æ‹©APIï¼ˆåˆ†ç±»ï¼‰</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">é€‰æ‹©æ–‡ç« æ‰€å±çš„APIï¼ŒAPIåç§°å°†ä½œä¸ºæ–‡ç« åˆ†ç±»</p>
          </div>
          <div class="admin-form-group" id="fieldMappingInfo" style="display: none;">
            <div class="text-sm text-blue-600">
              <p>æ­¤APIå·²é…ç½®å­—æ®µæ˜ å°„ï¼Œæ–‡ç« å°†æ ¹æ®æ˜ å°„è§„åˆ™ä¿å­˜åˆ°å¯¹åº”å­—æ®µ</p>
            </div>
          </div>
          
          <!-- ç‰¹æ®Šç±»åˆ«å®šåˆ¶åŒ–è¡¨å• -->
          <!-- ç¿»è¯‘å¡ç‰‡ (translation) -->
          <div id="specialForm-translation" class="admin-form-group" style="display: none;">
            <h4 style="color: #9333ea; margin-bottom: 1rem;">ç¿»è¯‘å¡ç‰‡ç¼–è¾‘</h4>
            <div class="admin-form-group" style="max-width: 500px;">
              <label class="admin-form-label" for="translationChinese">ä¸­æ–‡ *</label>
              <input type="text" id="translationChinese" class="admin-form-input" placeholder="è¾“å…¥ä¸­æ–‡" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 500px;">
              <label class="admin-form-label" for="translationArabic">é˜¿æ‹‰ä¼¯æ–‡ *</label>
              <input type="text" id="translationArabic" class="admin-form-input" placeholder="è¾“å…¥é˜¿æ‹‰ä¼¯æ–‡" dir="rtl" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="translationCategory">åˆ†ç±»</label>
              <input type="text" id="translationCategory" class="admin-form-input" placeholder="å¦‚ï¼šé—®å€™ã€ç¤¼è²Œã€è´­ç‰©ç­‰" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- å¤©æ°”è·¯å†µ (weather) -->
          <div id="specialForm-weather" class="admin-form-group" style="display: none;">
            <h4 style="color: #3b82f6; margin-bottom: 1rem;">å¤©æ°”è·¯å†µç¼–è¾‘</h4>
            
            <!-- Global Alert å…¨å±€é¢„è­¦ -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <h5 style="color: #3b82f6; margin-bottom: 0.75rem;">å…¨å±€é¢„è­¦ (Global Alert)</h5>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="weatherGlobalAlertLevel">é¢„è­¦çº§åˆ«</label>
              <select id="weatherGlobalAlertLevel" class="admin-form-select" style="width: 100%; max-width: 100%; box-sizing: border-box;">
                <option value="low">ä½ (low)</option>
                <option value="medium">ä¸­ (medium)</option>
                <option value="high">é«˜ (high)</option>
              </select>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="weatherGlobalAlertMessage">é¢„è­¦æ¶ˆæ¯ *</label>
              <textarea id="weatherGlobalAlertMessage" class="admin-form-input" rows="3" placeholder="è¾“å…¥é¢„è­¦æ¶ˆæ¯" style="width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;"></textarea>
            </div>
            </div>
            
            <!-- Attractions æ™¯ç‚¹å¤©æ°” -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #3b82f6; margin: 0;">æ™¯ç‚¹å¤©æ°” (Attractions)</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addWeatherAttraction()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>æ·»åŠ æ™¯ç‚¹
                </button>
              </div>
              <div id="weatherAttractionsList"></div>
            </div>
            
            <!-- Traffic è·¯å†µä¿¡æ¯ -->
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #3b82f6; margin: 0;">è·¯å†µä¿¡æ¯ (Traffic)</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addWeatherTraffic()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>æ·»åŠ è·¯å†µ
                </button>
              </div>
              <div id="weatherTrafficList"></div>
            </div>
          </div>
          
          <!-- æ±‡ç‡è½¬æ¢ (exchange-rate) -->
          <div id="specialForm-exchange-rate" class="admin-form-group" style="display: none;">
            <h4 style="color: #10b981; margin-bottom: 1rem;">æ±‡ç‡è½¬æ¢ç¼–è¾‘</h4>
            <div style="background: #f3f4f6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <h5 style="color: #10b981; margin: 0;">æ±‡ç‡åˆ—è¡¨</h5>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="addExchangeRate()" style="font-size: 0.875rem; padding: 0.375rem 0.75rem;">
                  <i class="fa fa-plus" style="margin-right: 0.25rem;"></i>æ·»åŠ æ±‡ç‡
                </button>
              </div>
              <div id="exchangeRatesList"></div>
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="exchangeUpdateTime">æ›´æ–°æ—¶é—´</label>
              <input type="datetime-local" id="exchangeUpdateTime" class="admin-form-input" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- äºŒæ‰‹å¸‚åœº (second-hand) ç‰¹æ®Šå­—æ®µ -->
          <div id="specialForm-second-hand" class="admin-form-group" style="display: none;">
            <h4 style="color: #f59e0b; margin-bottom: 1rem;">äºŒæ‰‹å¸‚åœºç‰¹æ®Šå­—æ®µ</h4>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="secondHandPrice">ä»·æ ¼ *</label>
              <input type="text" id="secondHandPrice" class="admin-form-input" placeholder="å¦‚ï¼š500ã€1000ç­‰" style="width: 100%; max-width: 100%; box-sizing: border-box;">
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="secondHandPhone">è”ç³»æ–¹å¼ *</label>
              <input type="text" id="secondHandPhone" name="secondHandPhone" class="admin-form-input" placeholder="å¦‚ï¼š+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="secondHandAddress">åœ°å€ *</label>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="secondHandAddress" name="secondHandAddress" class="admin-form-input" placeholder="å¦‚ï¼šå¼€ç½—å¸‚ä¸­å¿ƒï¼ŒHeliopolis åŒº" style="flex: 1; width: 100%; max-width: 100%; box-sizing: border-box;" required>
                <button type="button" id="secondHandAddressSearchBtn" class="blog-btn blog-btn-secondary" onclick="openMapPicker('second-hand')" style="white-space: nowrap; padding: 0.75rem 1rem;">
                  <span style="margin-right: 0.25rem;">ğŸ—ºï¸</span>åœ°å›¾é€‰ç‚¹
                </button>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="openLinkParser('second-hand')" style="white-space: nowrap; padding: 0.75rem 1rem;" title="ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è§£æ">
                  <span style="margin-right: 0.25rem;">ğŸ”—</span>è§£æé“¾æ¥
                </button>
              </div>
              <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">ç‚¹å‡»"åœ°å›¾é€‰ç‚¹"åœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®ï¼Œæˆ–ç‚¹å‡»"è§£æé“¾æ¥"ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è·å–ä½ç½®</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 100%;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="secondHandLatitude">çº¬åº¦ *</label>
                <input type="number" step="any" id="secondHandLatitude" name="secondHandLatitude" class="admin-form-input" placeholder="å¦‚ï¼š30.0444" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="secondHandLongitude">ç»åº¦ *</label>
                <input type="number" step="any" id="secondHandLongitude" name="secondHandLongitude" class="admin-form-input" placeholder="å¦‚ï¼š31.2357" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
            </div>
          </div>
          
          <!-- ç§Ÿæˆ¿é…’åº— (rentals) ç‰¹æ®Šå­—æ®µ -->
          <div id="specialForm-rentals" class="admin-form-group" style="display: none;">
            <h4 style="color: #8b5cf6; margin-bottom: 1rem;">ç§Ÿæˆ¿é…’åº—ç‰¹æ®Šå­—æ®µ</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; width: 100%; max-width: 100%; box-sizing: border-box;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsPrice">ä»·æ ¼ *</label>
                <input type="text" id="rentalsPrice" class="admin-form-input" placeholder="å¦‚ï¼š3500" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsRooms">æˆ¿é—´æ•° *</label>
                <input type="text" id="rentalsRooms" class="admin-form-input" placeholder="å¦‚ï¼š2" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsArea">é¢ç§¯ *</label>
                <input type="text" id="rentalsArea" class="admin-form-input" placeholder="å¦‚ï¼š80" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsViews">æµè§ˆæ¬¡æ•°</label>
                <input type="number" id="rentalsViews" class="admin-form-input" placeholder="å¦‚ï¼š1" min="0" style="width: 100%; max-width: 100%; box-sizing: border-box;">
              </div>
            </div>
            <div class="admin-form-group" style="max-width: 300px;">
              <label class="admin-form-label" for="rentalsPhone">è”ç³»æ–¹å¼ *</label>
              <input type="text" id="rentalsPhone" name="rentalsPhone" class="admin-form-input" placeholder="å¦‚ï¼š+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" for="rentalsAddress">åœ°å€ *</label>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="rentalsAddress" name="rentalsAddress" class="admin-form-input" placeholder="å¦‚ï¼šå¼€ç½—å¸‚ä¸­å¿ƒï¼ŒHeliopolis åŒº" style="flex: 1; width: 100%; max-width: 100%; box-sizing: border-box;" required>
                <button type="button" id="rentalsAddressSearchBtn" class="blog-btn blog-btn-secondary" onclick="openMapPicker('rentals')" style="white-space: nowrap; padding: 0.75rem 1rem;">
                  <span style="margin-right: 0.25rem;">ğŸ—ºï¸</span>åœ°å›¾é€‰ç‚¹
                </button>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="openLinkParser('rentals')" style="white-space: nowrap; padding: 0.75rem 1rem;" title="ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è§£æ">
                  <span style="margin-right: 0.25rem;">ğŸ”—</span>è§£æé“¾æ¥
                </button>
              </div>
              <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">ç‚¹å‡»"åœ°å›¾é€‰ç‚¹"åœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®ï¼Œæˆ–ç‚¹å‡»"è§£æé“¾æ¥"ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è·å–ä½ç½®</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 100%;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsLatitude">çº¬åº¦ *</label>
                <input type="number" step="any" id="rentalsLatitude" name="rentalsLatitude" class="admin-form-input" placeholder="å¦‚ï¼š30.0444" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" for="rentalsLongitude">ç»åº¦ *</label>
                <input type="number" step="any" id="rentalsLongitude" name="rentalsLongitude" class="admin-form-input" placeholder="å¦‚ï¼š31.2357" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
            </div>
          </div>
          
          <!-- é€šç”¨ä½ç½®å­—æ®µï¼ˆç”¨äºå…¶ä»–éœ€è¦ä½ç½®çš„åˆ†ç±»ï¼‰ -->
          <div id="commonLocationFields" class="admin-form-group" style="display: none;">
            <h4 style="color: #059669; margin-bottom: 1rem;">ä½ç½®ä¿¡æ¯</h4>
            <div class="admin-form-group" id="commonPhoneField" style="max-width: 300px; display: none;">
              <label class="admin-form-label" id="commonPhoneLabel" for="commonPhone">è”ç³»æ–¹å¼ *</label>
              <input type="text" id="commonPhone" name="commonPhone" class="admin-form-input" placeholder="å¦‚ï¼š+201017739088" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
            </div>
            <div class="admin-form-group" style="max-width: 100%;">
              <label class="admin-form-label" id="commonAddressLabel" for="commonAddress">åœ°å€ *</label>
              <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                <input type="text" id="commonAddress" name="commonAddress" class="admin-form-input" placeholder="å¦‚ï¼šå¼€ç½—å¸‚ä¸­å¿ƒï¼ŒHeliopolis åŒº" style="flex: 1; width: 100%; max-width: 100%; box-sizing: border-box;" required>
                <button type="button" id="commonAddressSearchBtn" class="blog-btn blog-btn-secondary" onclick="openMapPicker('common')" style="white-space: nowrap; padding: 0.75rem 1rem;">
                  <span style="margin-right: 0.25rem;">ğŸ—ºï¸</span>åœ°å›¾é€‰ç‚¹
                </button>
                <button type="button" class="blog-btn blog-btn-secondary" onclick="openLinkParser('common')" style="white-space: nowrap; padding: 0.75rem 1rem;" title="ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è§£æ">
                  <span style="margin-right: 0.25rem;">ğŸ”—</span>è§£æé“¾æ¥
                </button>
              </div>
              <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">ç‚¹å‡»"åœ°å›¾é€‰ç‚¹"åœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®ï¼Œæˆ–ç‚¹å‡»"è§£æé“¾æ¥"ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥è‡ªåŠ¨è·å–ä½ç½®</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 100%;">
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" id="commonLatitudeLabel" for="commonLatitude">çº¬åº¦ *</label>
                <input type="number" step="any" id="commonLatitude" name="commonLatitude" class="admin-form-input" placeholder="å¦‚ï¼š30.0444" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
              <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
                <label class="admin-form-label" id="commonLongitudeLabel" for="commonLongitude">ç»åº¦ *</label>
                <input type="number" step="any" id="commonLongitude" name="commonLongitude" class="admin-form-input" placeholder="å¦‚ï¼š31.2357" style="width: 100%; max-width: 100%; box-sizing: border-box;" required>
              </div>
            </div>
          </div>
          
          <div class="admin-form-group">
            <label class="admin-form-label" for="postCategory">åˆ†ç±»/æ ‡ç­¾ *</label>
            <input type="text" id="postCategory" class="admin-form-input" placeholder="æ–‡ç« åˆ†ç±»ï¼ˆä½œä¸ºæ ‡ç­¾ä½¿ç”¨ï¼‰" required>
            <p style="color: #6b7280; font-size: 0.875rem; margin-top: 0.25rem;">æ­¤åˆ†ç±»ç”¨äºåœ¨åšå®¢é¡µé¢ä½œä¸ºæ ‡ç­¾å±•ç¤º</p>
          </div>
          <div class="admin-form-group" style="display: none;">
            <label class="admin-form-label" for="postTags">æ ‡ç­¾ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨ä¸Šé¢çš„åˆ†ç±»å­—æ®µï¼‰</label>
            <input type="text" id="postTags" class="admin-form-input" placeholder="æ ‡ç­¾1, æ ‡ç­¾2" disabled>
          </div>
          <div class="admin-form-group" id="normalContentEditor">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <label class="admin-form-label" for="postContent" style="margin-bottom: 0;">å†…å®¹ *</label>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 0.875rem; color: #6b7280;">ç¼–è¾‘æ¨¡å¼ï¼š</span>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="radio" name="editorMode" value="markdown" checked onchange="switchEditorMode('markdown')">
                  <span>Markdown</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                  <input type="radio" name="editorMode" value="html" onchange="switchEditorMode('html')">
                  <span>HTML</span>
                </label>
              </div>
            </div>
            <div id="markdownEditorContainer">
              <textarea id="postContent" class="admin-form-textarea markdown-editor"></textarea>
            </div>
            <div id="htmlEditorContainer" style="display: none;">
              <div id="postHtmlContent" style="min-height: 400px;"></div>
            </div>
          </div>
          <div class="admin-form-group">
            <div class="admin-form-checkbox">
              <input type="checkbox" id="postPublished">
              <label for="postPublished">å‘å¸ƒ</label>
            </div>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">ä¿å­˜</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hidePostForm()">å–æ¶ˆ</button>
          </div>
        </form>
        </div>
      </div>

      <!-- æ–‡ç« åˆ—è¡¨ -->
      <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <table class="admin-table">
          <thead>
            <tr>
              <th>æ ‡é¢˜</th>
              <th>åˆ†ç±»</th>
              <th>çŠ¶æ€</th>
              <th>é˜…è¯»é‡</th>
              <th>æ—¥æœŸ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="postsTableBody">
            <tr><td colspan="6" class="blog-loading">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- åˆ†ç±»ç®¡ç† -->
    <div id="tab-categories" class="admin-tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>åˆ†ç±»ç®¡ç†</h2>
        <button class="blog-btn blog-btn-primary" onclick="showCategoryForm()">æ–°å»ºåˆ†ç±»</button>
      </div>

      <div id="categoryForm" class="admin-form" style="display: none;">
        <h3 id="categoryFormTitle">æ–°å»ºåˆ†ç±»</h3>
        <form id="categoryFormElement" onsubmit="saveCategory(event)">
          <input type="hidden" id="categoryId">
          <div class="admin-form-group">
            <label class="admin-form-label" for="categoryName">åˆ†ç±»åç§° *</label>
            <input type="text" id="categoryName" class="admin-form-input" required>
            <p class="text-xs text-gray-500 mt-1">æ­¤åç§°å°†æ˜¾ç¤ºåœ¨åšå®¢åˆ†ç±»åˆ—è¡¨ä¸­</p>
          </div>
          <div class="admin-form-group">
            <label class="admin-form-label" for="categoryPath">åˆ†ç±»è·¯å¾„/æè¿° *</label>
            <input type="text" id="categoryPath" class="admin-form-input" required placeholder="/category-name">
            <p class="text-xs text-gray-500 mt-1">è·¯å¾„å¿…é¡»ä»¥ / å¼€å¤´ï¼Œå°†ä½œä¸ºåˆ†ç±»çš„æè¿°ä¿¡æ¯</p>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">ä¿å­˜</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hideCategoryForm()">å–æ¶ˆ</button>
          </div>
        </form>
      </div>

      <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <table class="admin-table">
          <thead>
            <tr>
              <th>åç§°</th>
              <th>è·¯å¾„/æè¿°</th>
              <th>æ–‡ç« æ•°</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="categoriesTableBody">
            <tr><td colspan="4" class="blog-loading">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- æ ‡ç­¾ç®¡ç† -->
    <div id="tab-tags" class="admin-tab-content">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h2>æ ‡ç­¾ç®¡ç†</h2>
        <button class="blog-btn blog-btn-primary" onclick="showTagForm()">æ–°å»ºæ ‡ç­¾</button>
      </div>

      <div id="tagForm" class="admin-form" style="display: none;">
        <h3>æ–°å»ºæ ‡ç­¾</h3>
        <form onsubmit="saveTag(event)">
          <div class="admin-form-group">
            <label class="admin-form-label" for="tagName">æ ‡ç­¾åç§° *</label>
            <input type="text" id="tagName" class="admin-form-input" required>
          </div>
          <div style="display: flex; gap: 1rem;">
            <button type="submit" class="blog-btn blog-btn-primary">ä¿å­˜</button>
            <button type="button" class="blog-btn blog-btn-secondary" onclick="hideTagForm()">å–æ¶ˆ</button>
          </div>
        </form>
      </div>

      <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <table class="admin-table">
          <thead>
            <tr>
              <th>åç§°</th>
              <th>æ–‡ç« æ•°</th>
            </tr>
          </thead>
          <tbody id="tagsTableBody">
            <tr><td colspan="2" class="blog-loading">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- è¯„è®ºç®¡ç† -->
    <div id="tab-comments" class="admin-tab-content">
      <h2>è¯„è®ºç®¡ç†</h2>
      <div style="background: white; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <table class="admin-table">
          <thead>
            <tr>
              <th>æ–‡ç« </th>
              <th>ä½œè€…</th>
              <th>å†…å®¹</th>
              <th>çŠ¶æ€</th>
              <th>æ—¥æœŸ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="commentsTableBody">
            <tr><td colspan="6" class="blog-loading">åŠ è½½ä¸­...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="/utils/blog.js"></script>
  <script>
    const BLOG_ADMIN_API = '/api/blog-admin';
    let simpleMDE = null;
    let quillEditor = null;
    let currentEditorMode = 'markdown'; // 'markdown' or 'html'
    let availableApis = [];
    let allPostsData = []; // å­˜å‚¨æ‰€æœ‰æ–‡ç« æ•°æ®
    let expandedCategories = new Set(); // å­˜å‚¨å·²å±•å¼€çš„åˆ†ç±»
    let exchangeRatesCounter = 0; // æ±‡ç‡è½¬æ¢è®¡æ•°å™¨

    // åŠ è½½APIåˆ—è¡¨
    async function loadApis() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/apis`);
        if (response && response.success) {
          availableApis = response.data || [];
          updateApiSelect();
        }
      } catch (error) {
        console.error('åŠ è½½APIåˆ—è¡¨å¤±è´¥:', error);
      }
    }

    // æ›´æ–°APIé€‰æ‹©ä¸‹æ‹‰æ¡†
    function updateApiSelect() {
      const select = document.getElementById('postApiName');
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '<option value="">è¯·é€‰æ‹©APIï¼ˆåˆ†ç±»ï¼‰</option>';
      
      availableApis.forEach(api => {
        const option = document.createElement('option');
        option.value = api.name;
        option.textContent = `${api.name} (${api.path})`;
        select.appendChild(option);
      });
      
      if (currentValue) {
        select.value = currentValue;
      }
    }

    // ç‰¹æ®Šç±»åˆ«å®šä¹‰
    const SPECIAL_CATEGORIES = {
      'weather': {
        name: 'weather',
        displayName: 'å¤©æ°”è·¯å†µ',
      },
      'second-hand': {
        name: 'second-hand',
        displayName: 'äºŒæ‰‹å¸‚åœº',
      },
      'rentals': {
        name: 'rentals',
        displayName: 'ç§Ÿæˆ¿é…’åº—',
        color: '#3b82f6',
        fields: ['city', 'temperature', 'condition', 'traffic', 'humidity', 'wind']
      },
      'exchange-rate': {
        name: 'exchange-rate',
        displayName: 'æ±‡ç‡è½¬æ¢',
        color: '#10b981',
        fields: ['fromCurrency', 'toCurrency', 'rate', 'updateTime']
      },
      'translation': {
        name: 'translation',
        displayName: 'ç¿»è¯‘å¡ç‰‡',
        color: '#9333ea',
        fields: ['chinese', 'arabic', 'category']
      }
    };
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»åˆ«
    function isSpecialCategory(apiName) {
      if (!apiName) return null;
      // æ£€æŸ¥APIåç§°æˆ–è·¯å¾„æ˜¯å¦åŒ¹é…
      const lowerName = apiName.toLowerCase();
      if (lowerName === 'weather' || lowerName.includes('weather')) {
        return 'weather';
      }
      if (lowerName === 'exchange-rate' || lowerName === 'exchangerate' || lowerName.includes('exchange')) {
        return 'exchange-rate';
      }
      if (lowerName === 'translation' || lowerName.includes('translation')) {
        return 'translation';
      }
      // æ£€æµ‹äºŒæ‰‹å¸‚åœº
      if (lowerName === 'second-hand' || lowerName.includes('second-hand') || lowerName.includes('secondhand') || lowerName.includes('äºŒæ‰‹')) {
        return 'second-hand';
      }
      // æ£€æµ‹ç§Ÿæˆ¿é…’åº—
      if (lowerName === 'rentals' || lowerName.includes('rental') || lowerName.includes('ç§Ÿæˆ¿') || lowerName.includes('é…’åº—')) {
        return 'rentals';
      }
      return null;
    }
    
    // APIé€‰æ‹©æ”¹å˜æ—¶çš„å¤„ç†
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ä½ç½®ä¿¡æ¯ï¼ˆlatitude, longitude, addressï¼‰
    function needsLocationFields(apiName) {
      // æ‰€æœ‰åˆ†ç±»éƒ½æ”¯æŒä½ç½®å­—æ®µï¼ˆå¯é€‰ï¼‰
      if (!apiName) return false;
      return true;
    }

    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç”µè¯å­—æ®µï¼ˆæ‰€æœ‰åˆ†ç±»éƒ½æ”¯æŒç”µè¯å­—æ®µï¼Œä½œä¸ºå¯é€‰ï¼‰
    function needsPhoneField(apiName) {
      // æ‰€æœ‰åˆ†ç±»éƒ½æ”¯æŒç”µè¯å­—æ®µï¼ˆå¯é€‰ï¼‰
      if (!apiName) return false;
      return true;
    }

    // æ£€æŸ¥ä½ç½®å­—æ®µæ˜¯å¦ä¸ºå¿…å¡«ï¼ˆå¿…å¡«ï¼šå¯»å‘³ä¸­å›½ã€å¸¸ç”¨å¯¼èˆªã€æ‰“å¡åœ°ã€ç§Ÿæˆ¿ã€äºŒæ‰‹é›†å¸‚ã€çƒ­é—¨æ´»åŠ¨ï¼›å¯é€‰ï¼šç­¾è¯æŒ‡å—ã€æ”»ç•¥æŒ‡å—ã€å°¼ç½—æ²³åº”ç”¨ã€é˜²éª—æŒ‡å—ï¼‰
    function isLocationRequired(apiName) {
      if (!apiName) return false;
      const lowerName = apiName.toLowerCase();
      // å¿…å¡«ä½ç½®å­—æ®µçš„åˆ†ç±»
      return lowerName.includes('chinese-food') || 
             lowerName.includes('å¯»å‘³') || 
             lowerName.includes('location-list') ||
             lowerName.includes('å¯¼èˆª') || 
             lowerName.includes('hot-spots') ||
             lowerName.includes('æ‰“å¡') ||
             lowerName.includes('rental-list') ||
             lowerName.includes('rentals') || 
             lowerName.includes('ç§Ÿæˆ¿') || 
             lowerName.includes('é…’åº—') ||
             lowerName.includes('second-hand') || 
             lowerName.includes('äºŒæ‰‹') ||
             lowerName.includes('hot-activity') ||
             (lowerName.includes('æ´»åŠ¨') && !lowerName.includes('ç­¾è¯') && !lowerName.includes('æ”»ç•¥') && !lowerName.includes('é˜²éª—'));
    }

    async function onApiNameChange() {
      const apiName = document.getElementById('postApiName').value;
      const mappingInfo = document.getElementById('fieldMappingInfo');
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»åˆ«
      const specialType = isSpecialCategory(apiName);
      const needsLocation = needsLocationFields(apiName);
      
      // éšè—æ‰€æœ‰ç‰¹æ®Šè¡¨å•
      document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
        el.style.display = 'none';
      });

      // æ˜¾ç¤º/éšè—é€šç”¨ä½ç½®å­—æ®µ
      const commonLocationFields = document.getElementById('commonLocationFields');
      if (commonLocationFields) {
        // å¦‚æœå·²ç»åœ¨ç‰¹æ®Šè¡¨å•ä¸­æ˜¾ç¤ºäº†ä½ç½®å­—æ®µï¼ˆå¦‚rentalsæˆ–second-handï¼‰ï¼Œå°±ä¸æ˜¾ç¤ºé€šç”¨ä½ç½®å­—æ®µ
        const hasLocationInSpecialForm = (specialType === 'rentals' || specialType === 'second-hand');
        // æ‰€æœ‰åˆ†ç±»éƒ½æ˜¾ç¤ºä½ç½®å­—æ®µï¼ˆé™¤äº†ç‰¹æ®Šè¡¨å•çš„åˆ†ç±»ï¼‰
        const shouldShow = needsLocation && !hasLocationInSpecialForm;
        commonLocationFields.style.display = shouldShow ? 'block' : 'none';
        
        // æ˜¾ç¤º/éšè—ç”µè¯å­—æ®µï¼ˆæ‰€æœ‰åˆ†ç±»éƒ½æ”¯æŒï¼‰
        const needsPhone = needsPhoneField(apiName);
        const hasPhoneInSpecialForm = (specialType === 'rentals' || specialType === 'second-hand');
        // æ‰€æœ‰åˆ†ç±»éƒ½æ˜¾ç¤ºç”µè¯å­—æ®µï¼ˆé™¤äº†ç‰¹æ®Šè¡¨å•çš„åˆ†ç±»ï¼‰
        const shouldShowPhone = needsPhone && !hasPhoneInSpecialForm && shouldShow;
        
        // åˆ¤æ–­ç”µè¯å­—æ®µæ˜¯å¦ä¸ºå¿…å¡«ï¼ˆå¯»å‘³ä¸­å›½å¿…å¡«ï¼Œé˜²éª—æŒ‡å—ç­‰å¯é€‰ï¼‰
        const lowerName = apiName.toLowerCase();
        const isPhoneRequired = lowerName.includes('chinese-food') || lowerName.includes('å¯»å‘³');
        
        const commonPhoneField = document.getElementById('commonPhoneField');
        const commonPhoneInput = document.getElementById('commonPhone');
        const commonPhoneLabel = document.getElementById('commonPhoneLabel');
        if (commonPhoneField) {
          commonPhoneField.style.display = shouldShowPhone ? 'block' : 'none';
        }
        if (commonPhoneInput) {
          commonPhoneInput.required = shouldShowPhone && isPhoneRequired;
          if (!shouldShowPhone || !isPhoneRequired) commonPhoneInput.removeAttribute('required');
        }
        // æ›´æ–°ç”µè¯å­—æ®µæ ‡ç­¾
        if (commonPhoneLabel) {
          commonPhoneLabel.textContent = isPhoneRequired ? 'è”ç³»æ–¹å¼ *' : 'è”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼‰';
        }
        
        // åŠ¨æ€è®¾ç½®å¿…å¡«å±æ€§ï¼ˆåªåœ¨å­—æ®µå¯è§ä¸”ä¸ºå¿…å¡«åˆ†ç±»æ—¶è®¾ç½®ï¼‰
        const isRequired = isLocationRequired(apiName);
        const addressInput = document.getElementById('commonAddress');
        const latInput = document.getElementById('commonLatitude');
        const lngInput = document.getElementById('commonLongitude');
        const addressLabel = document.getElementById('commonAddressLabel');
        const latLabel = document.getElementById('commonLatitudeLabel');
        const lngLabel = document.getElementById('commonLongitudeLabel');
        
        if (addressInput) {
          addressInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) addressInput.removeAttribute('required');
        }
        // æ›´æ–°åœ°å€å­—æ®µæ ‡ç­¾
        if (addressLabel) {
          addressLabel.textContent = isRequired ? 'åœ°å€ *' : 'åœ°å€ï¼ˆå¯é€‰ï¼‰';
        }
        
        if (latInput) {
          latInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) latInput.removeAttribute('required');
        }
        // æ›´æ–°çº¬åº¦å­—æ®µæ ‡ç­¾
        if (latLabel) {
          latLabel.textContent = isRequired ? 'çº¬åº¦ *' : 'çº¬åº¦ï¼ˆå¯é€‰ï¼‰';
        }
        
        if (lngInput) {
          lngInput.required = shouldShow && isRequired;
          if (!shouldShow || !isRequired) lngInput.removeAttribute('required');
        }
        // æ›´æ–°ç»åº¦å­—æ®µæ ‡ç­¾
        if (lngLabel) {
          lngLabel.textContent = isRequired ? 'ç»åº¦ *' : 'ç»åº¦ï¼ˆå¯é€‰ï¼‰';
        }
      }
      
      // åŠ¨æ€è®¾ç½®ç‰¹æ®Šè¡¨å•ä¸­å­—æ®µçš„å¿…å¡«å±æ€§
      // å…ˆç§»é™¤æ‰€æœ‰ç‰¹æ®Šè¡¨å•å­—æ®µçš„å¿…å¡«å±æ€§ï¼Œç„¶åæ ¹æ®å½“å‰ç±»å‹é‡æ–°è®¾ç½®
      const secondHandPhone = document.getElementById('secondHandPhone');
      const secondHandAddress = document.getElementById('secondHandAddress');
      const secondHandLat = document.getElementById('secondHandLatitude');
      const secondHandLng = document.getElementById('secondHandLongitude');
      const rentalsPhone = document.getElementById('rentalsPhone');
      const rentalsAddress = document.getElementById('rentalsAddress');
      const rentalsLat = document.getElementById('rentalsLatitude');
      const rentalsLng = document.getElementById('rentalsLongitude');
      
      // å…ˆç§»é™¤æ‰€æœ‰å¿…å¡«å±æ€§
      [secondHandPhone, secondHandAddress, secondHandLat, secondHandLng, 
       rentalsPhone, rentalsAddress, rentalsLat, rentalsLng].forEach(input => {
        if (input) {
          input.removeAttribute('required');
          // ç¡®ä¿å­—æ®µå¯è§æ€§æ£€æŸ¥ï¼šå¦‚æœçˆ¶å®¹å™¨éšè—ï¼Œä¹Ÿç§»é™¤required
          const parentForm = input.closest('[id^="specialForm-"]');
          if (parentForm && parentForm.style.display === 'none') {
            input.removeAttribute('required');
          }
        }
      });
      
      // æ ¹æ®å½“å‰ç±»å‹è®¾ç½®å¿…å¡«å±æ€§ï¼ˆåªåœ¨è¡¨å•å¯è§æ—¶ï¼‰
      if (specialType === 'second-hand') {
        const secondHandForm = document.getElementById('specialForm-second-hand');
        if (secondHandForm && secondHandForm.style.display !== 'none') {
          if (secondHandPhone) secondHandPhone.required = true;
          if (secondHandAddress) secondHandAddress.required = true;
          if (secondHandLat) secondHandLat.required = true;
          if (secondHandLng) secondHandLng.required = true;
        }
      } else if (specialType === 'rentals') {
        const rentalsForm = document.getElementById('specialForm-rentals');
        if (rentalsForm && rentalsForm.style.display !== 'none') {
          if (rentalsPhone) rentalsPhone.required = true;
          if (rentalsAddress) rentalsAddress.required = true;
          if (rentalsLat) rentalsLat.required = true;
          if (rentalsLng) rentalsLng.required = true;
        }
      }
      
      // éšè—/æ˜¾ç¤ºæ™®é€šå†…å®¹ç¼–è¾‘å™¨
      const normalEditor = document.getElementById('normalContentEditor');
      if (normalEditor) {
        normalEditor.style.display = specialType ? 'none' : 'block';
      }
      
      if (!apiName) {
        mappingInfo.style.display = 'none';
        return;
      }
      
      // å¦‚æœæ˜¯ç‰¹æ®Šç±»åˆ«ï¼Œæ˜¾ç¤ºå¯¹åº”çš„è¡¨å•
      if (specialType) {
        const specialForm = document.getElementById(`specialForm-${specialType}`);
        if (specialForm) {
          specialForm.style.display = 'block';
        }
        // å¯¹äºsecond-handå’Œrentalsï¼Œä¹Ÿæ˜¾ç¤ºæ ‡å‡†å†…å®¹ç¼–è¾‘å™¨ï¼ˆå› ä¸ºå®ƒä»¬éœ€è¦ç¼–è¾‘æ™®é€šå†…å®¹ï¼‰
        const normalContentEditor = document.getElementById('normalContentEditor');
        if (specialType === 'second-hand' || specialType === 'rentals') {
          if (normalContentEditor) {
            normalContentEditor.style.display = 'block';
          }
        } else {
          if (normalContentEditor) {
            normalContentEditor.style.display = 'none';
          }
        }
        mappingInfo.style.display = 'none';
        return;
      }
      
      // æ™®é€šç±»åˆ«ï¼Œæ£€æŸ¥å­—æ®µæ˜ å°„
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/apis/${encodeURIComponent(apiName)}/field-mapping`);
        if (response && response.success && response.data) {
          mappingInfo.style.display = 'block';
          mappingInfo.innerHTML = `
            <div class="text-sm text-blue-600">
              <p>æ­¤APIå·²é…ç½®å­—æ®µæ˜ å°„ï¼Œæ–‡ç« å°†æ ¹æ®æ˜ å°„è§„åˆ™ä¿å­˜åˆ°å¯¹åº”å­—æ®µ</p>
              <details class="mt-2">
                <summary class="cursor-pointer text-xs">æŸ¥çœ‹å­—æ®µæ˜ å°„</summary>
                <pre class="text-xs mt-2 p-2 bg-gray-100 rounded">${JSON.stringify(response.data, null, 2)}</pre>
              </details>
            </div>
          `;
        } else {
          mappingInfo.style.display = 'none';
        }
      } catch (error) {
        mappingInfo.style.display = 'none';
      }
    }

    // åˆ‡æ¢æ ‡ç­¾é¡µ
    function switchTab(tabName, tabButton = null) {
      // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
      document.querySelectorAll('.admin-tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
      const tabContent = document.getElementById(`tab-${tabName}`);
      if (tabContent) {
        tabContent.classList.add('active');
      }

      // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
      if (tabButton) {
        tabButton.classList.add('active');
      } else {
        // å¦‚æœæ²¡æœ‰æä¾›æŒ‰é’®ï¼Œé€šè¿‡æŸ¥æ‰¾åŒ…å«å¯¹åº”æ–‡æœ¬çš„æŒ‰é’®æ¥æ¿€æ´»
        const buttons = document.querySelectorAll('.admin-tab');
        buttons.forEach(btn => {
          const text = btn.textContent.trim();
          if ((tabName === 'posts' && text === 'æ–‡ç« ') ||
              (tabName === 'categories' && text === 'åˆ†ç±»') ||
              (tabName === 'tags' && text === 'æ ‡ç­¾') ||
              (tabName === 'comments' && text === 'è¯„è®º')) {
            btn.classList.add('active');
          }
        });
      }

      // åŠ è½½å¯¹åº”æ•°æ®
      if (tabName === 'posts') {
        loadPosts();
        loadApis(); // åŠ è½½APIåˆ—è¡¨
      } else if (tabName === 'categories') {
        loadCategories();
      } else if (tabName === 'tags') {
        loadTags();
      } else if (tabName === 'comments') {
        loadComments();
      }
    }

    // APIè¯·æ±‚å°è£…ï¼ˆå¸¦è®¤è¯ï¼‰
    async function adminApiRequest(url, options = {}) {
      try {
        const response = await fetch(url, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          credentials: 'include'
        });

        if (response.status === 401) {
          showToast('è¯·å…ˆç™»å½•', 'error');
          window.location.href = '/admin.html';
          return null;
        }

        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
        }
        return data;
      } catch (error) {
        console.error('APIè¯·æ±‚å¤±è´¥:', error);
        showToast('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
        throw error;
      }
    }

    // åŠ è½½æ–‡ç« åˆ—è¡¨
    async function loadPosts(resetExpanded = false) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
        if (response && response.success) {
          const posts = response.data || [];
          console.log('è·å–æ–‡ç« åˆ—è¡¨æˆåŠŸï¼Œæ–‡ç« æ•°:', posts.length);
          // ä¿å­˜æ‰€æœ‰æ–‡ç« æ•°æ®
          allPostsData = posts;
          // æŒ‰åˆ†ç±»ç»Ÿè®¡
          const byCategory = {};
          posts.forEach(p => {
            const cat = p.category || 'æ— åˆ†ç±»';
            byCategory[cat] = (byCategory[cat] || 0) + 1;
          });
          console.log('æ–‡ç« åˆ†ç±»ç»Ÿè®¡:', byCategory);
          // å¦‚æœæŒ‡å®šé‡ç½®å±•å¼€çŠ¶æ€ï¼Œåˆ™æ¸…ç©ºï¼ˆé»˜è®¤æ‰€æœ‰åˆ†ç±»éƒ½æŠ˜å ï¼‰
          if (resetExpanded) {
            expandedCategories.clear();
          }
          displayPosts(posts);
        } else {
          console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', response);
          document.getElementById('postsTableBody').innerHTML = '<tr><td colspan="6" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¼‚å¸¸:', error);
        document.getElementById('postsTableBody').innerHTML = '<tr><td colspan="6" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    // æ˜¾ç¤ºæ–‡ç« åˆ—è¡¨ï¼ˆæŒ‰åˆ†ç±»åˆ†ç»„ï¼Œé»˜è®¤æŠ˜å ï¼‰
    function displayPosts(posts) {
      const tbody = document.getElementById('postsTableBody');
      if (!posts || posts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="blog-empty">æš‚æ— æ–‡ç« </td></tr>';
        return;
      }

      console.log('displayPosts æ¥æ”¶åˆ°çš„æ–‡ç« æ•°:', posts.length);

      // æŒ‰åˆ†ç±»åˆ†ç»„
      const postsByCategory = {};
      const seenIds = new Set(); // å‰ç«¯å†æ¬¡å»é‡ï¼Œç¡®ä¿ä¸æ˜¾ç¤ºé‡å¤
      let skippedCount = 0;
      
      for (const post of posts) {
        const postId = String(post.id || '');
        // å¦‚æœå·²å­˜åœ¨ç›¸åŒidï¼Œè·³è¿‡ï¼ˆé˜²æ­¢é‡å¤æ˜¾ç¤ºï¼‰
        if (postId && seenIds.has(postId)) {
          skippedCount++;
          console.warn('è·³è¿‡é‡å¤IDçš„æ–‡ç« :', { id: postId, category: post.category, name: post.name });
          continue;
        }
        seenIds.add(postId);
        
        // æŒ‰apiNameï¼ˆ_sourceApiNameï¼‰åˆ†ç»„ï¼Œè€Œä¸æ˜¯category
        const apiName = post._sourceApiName || post.category || 'æ— åˆ†ç±»';
        if (!postsByCategory[apiName]) {
          postsByCategory[apiName] = [];
        }
        postsByCategory[apiName].push(post);
      }

      console.log('æ˜¾ç¤ºæ–‡ç« ç»Ÿè®¡:', {
        æ€»æ¥æ”¶: posts.length,
        å»é‡å: seenIds.size,
        è·³è¿‡é‡å¤: skippedCount,
        åˆ†ç±»æ•°: Object.keys(postsByCategory).length
      });

      // ç”ŸæˆHTMLï¼šæŒ‰åˆ†ç±»åˆ†ç»„æ˜¾ç¤ºï¼Œé»˜è®¤æŠ˜å 
      let html = '';
      const sortedCategories = Object.keys(postsByCategory).sort();
      
      for (const apiName of sortedCategories) {
        const categoryPosts = postsByCategory[apiName];
        const isExpanded = expandedCategories.has(apiName);
        
        // åˆ†ç±»æ ‡é¢˜è¡Œï¼ˆæŒ‰apiNameåˆ†ç»„ï¼‰
        const specialType = isSpecialCategory(apiName);
        let categoryHeaderStyle = 'background: linear-gradient(to right, rgba(236, 72, 153, 0.1), rgba(147, 51, 234, 0.1));';
        let categoryHeaderColor = '#9333ea';
        let categoryDisplayName = apiName;
        
        if (specialType) {
          const specialInfo = SPECIAL_CATEGORIES[specialType];
          categoryHeaderStyle = `background: linear-gradient(to right, ${specialInfo.color}20, ${specialInfo.color}10);`;
          categoryHeaderColor = specialInfo.color;
          categoryDisplayName = specialInfo.displayName;
        }
        
        // æ·»åŠ ç‚¹å‡»å±•å¼€/æŠ˜å åŠŸèƒ½
        const expandIcon = isExpanded ? 'ğŸ“‚' : 'ğŸ“';
        // ä½¿ç”¨ data-* å±æ€§ä¼ é€’åˆ†ç±»åç§°ï¼Œé¿å…è½¬ä¹‰é—®é¢˜
        html += `
          <tr class="category-header-row" style="${categoryHeaderStyle} font-weight: 600; cursor: pointer;" data-category-name="${escapeHtml(apiName)}" onclick="toggleCategory(this.dataset.categoryName)">
            <td colspan="6" style="padding: 0.75rem 1rem;">
              <span style="color: ${categoryHeaderColor}; font-weight: 600;">${expandIcon} ${escapeHtml(categoryDisplayName)}</span>
              <span style="color: #6b7280; font-size: 0.875rem; font-weight: normal; margin-left: 0.5rem;">
                (${categoryPosts.length} ç¯‡æ–‡ç« )
              </span>
              <span style="color: #9ca3af; font-size: 0.75rem; margin-left: 0.5rem;">
                ${isExpanded ? 'ç‚¹å‡»æŠ˜å ' : 'ç‚¹å‡»å±•å¼€'}
              </span>
            </td>
          </tr>
        `;
        
        // è¯¥åˆ†ç±»ä¸‹çš„æ–‡ç« ï¼ˆæ ¹æ®å±•å¼€çŠ¶æ€æ˜¾ç¤º/éšè—ï¼‰
        if (isExpanded) {
        for (const post of categoryPosts) {
          const date = formatDate(post.createdAt || post.created_at);
          const postSpecialType = isSpecialCategory(apiName);
          let rowStyle = '';
          // æ˜¾ç¤ºcategoryä½œä¸ºæ ‡ç­¾ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ˜¾ç¤ºapiName
          const postCategory = post.category || apiName;
          let categoryDisplay = escapeHtml(postCategory);
          
          // ä¸ºç‰¹æ®Šç±»åˆ«æ·»åŠ é¢œè‰²æ ‡è¯†
          if (postSpecialType) {
            const specialInfo = SPECIAL_CATEGORIES[postSpecialType];
            rowStyle = `background-color: ${specialInfo.color}15; border-left: 3px solid ${specialInfo.color};`;
            categoryDisplay = `<span style="color: ${specialInfo.color}; font-weight: 600;">${escapeHtml(postCategory)}</span>`;
          }
          
          html += `
              <tr class="category-post-row" data-category="${escapeHtml(apiName)}" style="${rowStyle}">
              <td>${escapeHtml(post.name || post.title || 'æœªå‘½å')}</td>
              <td>${categoryDisplay}</td>
              <td>${post.published ? '<span style="color: #10b981;">å·²å‘å¸ƒ</span>' : '<span style="color: #f59e0b;">è‰ç¨¿</span>'}</td>
              <td>${post.views || 0}</td>
              <td>${date}</td>
              <td>
                <div class="admin-actions">
                  <button class="admin-btn-small admin-btn-edit" onclick="editPost('${post.id}')">ç¼–è¾‘</button>
                  <button class="admin-btn-small admin-btn-copy" onclick="copyPost('${post.id}')" title="å¤åˆ¶æ–‡ç« ">å¤åˆ¶</button>
                  <button class="admin-btn-small admin-btn-delete" onclick="deletePost('${post.id}')">åˆ é™¤</button>
                </div>
              </td>
            </tr>
          `;
          }
        }
      }

      tbody.innerHTML = html;
    }

    // åˆ‡æ¢åˆ†ç±»å±•å¼€/æŠ˜å çŠ¶æ€
    function toggleCategory(apiName) {
      if (expandedCategories.has(apiName)) {
        expandedCategories.delete(apiName);
      } else {
        expandedCategories.add(apiName);
      }
      // é‡æ–°æ¸²æŸ“åˆ—è¡¨
      displayPosts(allPostsData);
    }

    // æ˜¾ç¤ºæ–‡ç« è¡¨å•
    async function showPostForm(post = null) {
      const form = document.getElementById('postForm');
      const formTitle = document.getElementById('postFormTitle');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      // ç¡®ä¿APIåˆ—è¡¨å·²åŠ è½½
      if (availableApis.length === 0) {
        loadApis().then(() => {
          showPostForm(post);
        });
        return;
      }
      
      // ç¡®ä¿è¡¨å•æ˜¾ç¤ºï¼Œå¹¶éšè—åŠ è½½æç¤º
      if (form) {
        form.style.display = 'block';
        form.classList.remove('loading');
      }
      if (postFormLoading) {
        postFormLoading.style.display = 'none';
      }
      if (postFormContent) {
        postFormContent.style.display = 'block';
      }
      
      // é‡ç½®è¡¨å•
      document.getElementById('postId').value = '';
      document.getElementById('postName').value = '';
      document.getElementById('postSlug').value = '';
      document.getElementById('postExcerpt').value = '';
      document.getElementById('postImage').value = '';
      updateImagePreview('');
      document.getElementById('postCategory').value = '';
      document.getElementById('postTags').value = '';
      document.getElementById('postPublished').checked = true;
      
      // æ¸…ç©ºä½ç½®å’Œè”ç³»æ–¹å¼å­—æ®µ
      const commonPhone = document.getElementById('commonPhone');
      const commonAddress = document.getElementById('commonAddress');
      const commonLatitude = document.getElementById('commonLatitude');
      const commonLongitude = document.getElementById('commonLongitude');
      const secondHandPhone = document.getElementById('secondHandPhone');
      const secondHandAddress = document.getElementById('secondHandAddress');
      const secondHandLatitude = document.getElementById('secondHandLatitude');
      const secondHandLongitude = document.getElementById('secondHandLongitude');
      const rentalsPhone = document.getElementById('rentalsPhone');
      const rentalsAddress = document.getElementById('rentalsAddress');
      const rentalsLatitude = document.getElementById('rentalsLatitude');
      const rentalsLongitude = document.getElementById('rentalsLongitude');
      
      if (commonPhone) commonPhone.value = '';
      if (commonAddress) commonAddress.value = '';
      if (commonLatitude) commonLatitude.value = '';
      if (commonLongitude) commonLongitude.value = '';
      if (secondHandPhone) secondHandPhone.value = '';
      if (secondHandAddress) secondHandAddress.value = '';
      if (secondHandLatitude) secondHandLatitude.value = '';
      if (secondHandLongitude) secondHandLongitude.value = '';
      if (rentalsPhone) rentalsPhone.value = '';
      if (rentalsAddress) rentalsAddress.value = '';
      if (rentalsLatitude) rentalsLatitude.value = '';
      if (rentalsLongitude) rentalsLongitude.value = '';
      
      if (post) {
        // å¦‚æœæ²¡æœ‰IDï¼Œè¯´æ˜æ˜¯å¤åˆ¶æˆ–æ–°å»ºï¼Œå¦åˆ™æ˜¯ç¼–è¾‘
        formTitle.textContent = post.id ? 'ç¼–è¾‘æ–‡ç« ' : 'å¤åˆ¶æ–‡ç« ';
        document.getElementById('postId').value = post.id || '';
        // nameå’Œtitleä¿æŒä¸€è‡´
        const nameValue = post.name || post.title || '';
        document.getElementById('postName').value = nameValue;
        document.getElementById('postSlug').value = post.slug || '';
        document.getElementById('postExcerpt').value = post.excerpt || post.description || '';
        const imageUrl = post.image || '';
        document.getElementById('postImage').value = imageUrl;
        updateImagePreview(imageUrl);
        const apiName = post._sourceApiName || post.category || '';
        document.getElementById('postApiName').value = apiName;
        // categoryå­—æ®µä½œä¸ºæ ‡ç­¾ä½¿ç”¨
        const category = post.category || post._sourceApiName || '';
        document.getElementById('postCategory').value = category;
        // tagså­—æ®µå·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨
        document.getElementById('postPublished').checked = post.published !== false; // é»˜è®¤ä¸ºtrue
        
        // è§¦å‘APIé€‰æ‹©æ”¹å˜äº‹ä»¶
        setTimeout(() => {
          onApiNameChange();
          
          // å¦‚æœæ˜¯ç‰¹æ®Šç±»åˆ«ï¼ŒåŠ è½½åŸå§‹æ•°æ®åˆ°è¡¨å•
          const specialType = isSpecialCategory(apiName);
          if (specialType && post._originalData) {
            loadSpecialCategoryData(specialType, post._originalData);
          }
          
          // åŠ è½½ç‰¹æ®Šå­—æ®µï¼ˆäºŒæ‰‹å¸‚åœºå’Œç§Ÿæˆ¿é…’åº—ï¼‰
          if (specialType === 'second-hand') {
            const priceInput = document.getElementById('secondHandPrice');
            if (priceInput) {
              // ä¼˜å…ˆä»_originalDataè·å–ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä»postæœ¬èº«è·å–
              const price = (post._originalData && post._originalData.price) || post.price || '';
              priceInput.value = price;
              console.log('åŠ è½½äºŒæ‰‹å¸‚åœºä»·æ ¼å­—æ®µ:', { price, fromOriginalData: post._originalData?.price, fromPost: post.price });
            }
            const phoneInput = document.getElementById('secondHandPhone');
            const addressInput = document.getElementById('secondHandAddress');
            const latInput = document.getElementById('secondHandLatitude');
            const lngInput = document.getElementById('secondHandLongitude');
            if (phoneInput) {
              const phone = (post._originalData && post._originalData.phone) || post.phone || '';
              phoneInput.value = phone;
            }
            if (addressInput) {
              const address = (post._originalData && post._originalData.address) || post.address || '';
              addressInput.value = address;
            }
            if (latInput) {
              const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
              latInput.value = lat;
            }
            if (lngInput) {
              const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
              lngInput.value = lng;
            }
          } else if (specialType === 'rentals') {
            const priceInput = document.getElementById('rentalsPrice');
            const roomsInput = document.getElementById('rentalsRooms');
            const areaInput = document.getElementById('rentalsArea');
            const viewsInput = document.getElementById('rentalsViews');
            const phoneInput = document.getElementById('rentalsPhone');
            const addressInput = document.getElementById('rentalsAddress');
            const latInput = document.getElementById('rentalsLatitude');
            const lngInput = document.getElementById('rentalsLongitude');
            if (priceInput) {
              const price = (post._originalData && post._originalData.price) || post.price || '';
              priceInput.value = price;
            }
            if (roomsInput) {
              const rooms = (post._originalData && post._originalData.rooms) || post.rooms || '';
              roomsInput.value = rooms;
            }
            if (areaInput) {
              const area = (post._originalData && post._originalData.area) || post.area || '';
              areaInput.value = area;
            }
            if (viewsInput) {
              const views = (post._originalData && post._originalData.views) || post.views || 0;
              viewsInput.value = views;
            }
            if (phoneInput) {
              const phone = (post._originalData && post._originalData.phone) || post.phone || '';
              phoneInput.value = phone;
            }
            if (addressInput) {
              const address = (post._originalData && post._originalData.address) || post.address || '';
              addressInput.value = address;
            }
            if (latInput) {
              const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
              latInput.value = lat;
            }
            if (lngInput) {
              const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
              lngInput.value = lng;
            }
            console.log('åŠ è½½ç§Ÿæˆ¿é…’åº—ç‰¹æ®Šå­—æ®µ:', {
              price: (post._originalData && post._originalData.price) || post.price,
              rooms: (post._originalData && post._originalData.rooms) || post.rooms,
              area: (post._originalData && post._originalData.area) || post.area,
              views: (post._originalData && post._originalData.views) || post.views,
              phone: (post._originalData && post._originalData.phone) || post.phone,
              address: (post._originalData && post._originalData.address) || post.address,
              latitude: (post._originalData && post._originalData.latitude) || post.latitude,
              longitude: (post._originalData && post._originalData.longitude) || post.longitude
            });
          } else {
            // åŠ è½½é€šç”¨ä½ç½®å­—æ®µï¼ˆç”¨äºå…¶ä»–éœ€è¦ä½ç½®çš„åˆ†ç±»ï¼‰
            const needsLocation = needsLocationFields(apiName);
            const needsPhone = needsPhoneField(apiName);
            if (needsLocation) {
              const addressInput = document.getElementById('commonAddress');
              const latInput = document.getElementById('commonLatitude');
              const lngInput = document.getElementById('commonLongitude');
              if (addressInput) {
                const address = (post._originalData && post._originalData.address) || post.address || '';
                addressInput.value = address;
              }
              if (latInput) {
                const lat = (post._originalData && post._originalData.latitude) || post.latitude || '';
                latInput.value = lat;
              }
              if (lngInput) {
                const lng = (post._originalData && post._originalData.longitude) || post.longitude || '';
                lngInput.value = lng;
              }
            }
            // åŠ è½½é€šç”¨ç”µè¯å­—æ®µï¼ˆç”¨äºå¯»å‘³ä¸­å›½ç­‰åˆ†ç±»ï¼‰
            if (needsPhone) {
              const phoneInput = document.getElementById('commonPhone');
              if (phoneInput) {
                const phone = (post._originalData && post._originalData.phone) || post.phone || '';
                phoneInput.value = phone;
              }
            }
          }
        }, 100);
        
        // è®¾ç½®htmlContentï¼ˆç»Ÿä¸€ä½¿ç”¨htmlContentï¼‰
        const htmlContent = post.htmlContent || (post._originalData ? (post._originalData.htmlContent || '') : '');
        
        // åˆ¤æ–­å†…å®¹ç±»å‹å¹¶è®¾ç½®ç¼–è¾‘å™¨æ¨¡å¼
        if (htmlContent && htmlContent.trim().startsWith('<')) {
          // HTMLå†…å®¹ï¼Œåˆ‡æ¢åˆ°HTMLç¼–è¾‘å™¨
          document.querySelector('input[name="editorMode"][value="html"]').checked = true;
          await switchEditorMode('html');
          
          // ç­‰å¾…Quillç¼–è¾‘å™¨åˆå§‹åŒ–åè®¾ç½®å†…å®¹
          if (quillEditor) {
            quillEditor.root.innerHTML = htmlContent;
          } else {
            // å¦‚æœQuillè¿˜æ²¡åŠ è½½ï¼Œç­‰å¾…ä¸€ä¸‹å†è¯•
            setTimeout(async () => {
              if (!quillEditor) {
                await initQuillEditor();
              }
              if (quillEditor) {
                quillEditor.root.innerHTML = htmlContent;
              }
            }, 500);
          }
        } else {
          // Markdownå†…å®¹æˆ–ç©ºå†…å®¹ï¼Œä½¿ç”¨Markdownç¼–è¾‘å™¨
          document.querySelector('input[name="editorMode"][value="markdown"]').checked = true;
          await switchEditorMode('markdown');
          
          // åˆå§‹åŒ–Markdownç¼–è¾‘å™¨
          if (!simpleMDE) {
            simpleMDE = new SimpleMDE({
              element: document.getElementById('postContent'),
              spellChecker: false,
              placeholder: 'è¾“å…¥Markdownå†…å®¹...'
            });
          }
          // å¦‚æœæœ‰htmlContentï¼Œç®€å•è½¬æ¢ä¸ºMarkdownæ˜¾ç¤ºï¼ˆç§»é™¤HTMLæ ‡ç­¾ï¼‰
          if (htmlContent) {
            const markdownContent = htmlContent
              .replace(/<h2>/g, '## ')
              .replace(/<\/h2>/g, '\n\n')
              .replace(/<p>/g, '')
              .replace(/<\/p>/g, '\n\n')
              .replace(/<br>/g, '\n')
              .replace(/<[^>]+>/g, '');
            simpleMDE.value(markdownContent.trim());
          } else {
            simpleMDE.value('');
          }
        }
      } else {
        formTitle.textContent = 'æ–°å»ºæ–‡ç« ';
        document.getElementById('postFormElement').reset();
        document.getElementById('postId').value = '';
        document.getElementById('postApiName').value = '';
        
        // é‡ç½®æ‰€æœ‰ç‰¹æ®Šè¡¨å•
        document.querySelectorAll('[id^="specialForm-"]').forEach(el => {
          el.style.display = 'none';
          // æ¸…ç©ºæ‰€æœ‰è¾“å…¥æ¡†
          el.querySelectorAll('input, textarea, select').forEach(input => {
            input.value = '';
          });
        });
        
        // é‡ç½®å¤©æ°”è·¯å†µçš„åŠ¨æ€åˆ—è¡¨
        document.getElementById('weatherAttractionsList').innerHTML = '';
        document.getElementById('weatherTrafficList').innerHTML = '';
        weatherAttractionsCounter = 0;
        weatherTrafficCounter = 0;
        
        // é‡ç½®ç‰¹æ®Šå­—æ®µï¼ˆäºŒæ‰‹å¸‚åœºå’Œç§Ÿæˆ¿é…’åº—ï¼‰
        const secondHandPriceInput = document.getElementById('secondHandPrice');
        if (secondHandPriceInput) secondHandPriceInput.value = '';
        const rentalsPriceInput = document.getElementById('rentalsPrice');
        if (rentalsPriceInput) rentalsPriceInput.value = '';
        const rentalsRoomsInput = document.getElementById('rentalsRooms');
        if (rentalsRoomsInput) rentalsRoomsInput.value = '';
        const rentalsAreaInput = document.getElementById('rentalsArea');
        if (rentalsAreaInput) rentalsAreaInput.value = '';
        const rentalsViewsInput = document.getElementById('rentalsViews');
        if (rentalsViewsInput) rentalsViewsInput.value = '';
        
        // é‡ç½®æ±‡ç‡è½¬æ¢åˆ—è¡¨
        const exchangeRatesList = document.getElementById('exchangeRatesList');
        if (exchangeRatesList) exchangeRatesList.innerHTML = '';
        exchangeRatesCounter = 0;
        
        // æ˜¾ç¤ºæ™®é€šå†…å®¹ç¼–è¾‘å™¨
        const normalEditor = document.getElementById('normalContentEditor');
        if (normalEditor) {
          normalEditor.style.display = 'block';
        }
        
        // é‡ç½®ç¼–è¾‘å™¨æ¨¡å¼ä¸ºMarkdown
        document.querySelector('input[name="editorMode"][value="markdown"]').checked = true;
        await switchEditorMode('markdown');
        
        if (simpleMDE) {
          simpleMDE.value('');
        } else {
          simpleMDE = new SimpleMDE({
            element: document.getElementById('postContent'),
            spellChecker: false,
            placeholder: 'è¾“å…¥Markdownå†…å®¹...'
          });
        }
        document.getElementById('fieldMappingInfo').style.display = 'none';
      }
      
      form.style.display = 'block';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    // åˆ‡æ¢ç¼–è¾‘å™¨æ¨¡å¼ï¼ˆå…¨å±€å‡½æ•°ï¼Œä¾›HTMLè°ƒç”¨ï¼‰
    window.switchEditorMode = async function switchEditorMode(mode) {
      const markdownContainer = document.getElementById('markdownEditorContainer');
      const htmlContainer = document.getElementById('htmlEditorContainer');
      
      // ä¿å­˜å½“å‰ç¼–è¾‘å™¨å†…å®¹åˆ°ä¸´æ—¶å˜é‡ï¼ˆåœ¨åˆ‡æ¢å‰ï¼‰
      let currentContent = '';
      
      if (currentEditorMode === 'html' && quillEditor) {
        // å½“å‰æ˜¯HTMLæ¨¡å¼ï¼Œä¿å­˜HTMLå†…å®¹
        currentContent = quillEditor.root.innerHTML;
      } else if (currentEditorMode === 'markdown' && simpleMDE) {
        // å½“å‰æ˜¯Markdownæ¨¡å¼ï¼Œä¿å­˜Markdownå†…å®¹
        currentContent = simpleMDE.value();
      } else if (currentEditorMode === 'markdown') {
        // Markdownæ¨¡å¼ä½†simpleMDEæœªåˆå§‹åŒ–ï¼Œä»textareaè·å–
        const textarea = document.getElementById('postContent');
        if (textarea) {
          currentContent = textarea.value;
        }
      }
      
      // æ›´æ–°å½“å‰æ¨¡å¼
      currentEditorMode = mode;
      
      if (mode === 'markdown') {
        markdownContainer.style.display = 'block';
        htmlContainer.style.display = 'none';
        
        // ç¡®ä¿SimpleMDEå·²åˆå§‹åŒ–
        if (!simpleMDE) {
          simpleMDE = new SimpleMDE({
            element: document.getElementById('postContent'),
            spellChecker: false,
            placeholder: 'è¾“å…¥Markdownå†…å®¹...'
          });
        }
        
        // å¦‚æœåˆ‡æ¢åˆ°Markdownï¼Œå°†HTMLå†…å®¹è½¬æ¢ä¸ºMarkdownæ˜¾ç¤º
        if (currentContent) {
          if (currentContent.trim().startsWith('<')) {
            // HTMLå†…å®¹ï¼Œè½¬æ¢ä¸ºMarkdown
            const markdownContent = htmlToMarkdown(currentContent);
            simpleMDE.value(markdownContent);
          } else {
            // å·²ç»æ˜¯Markdownå†…å®¹ï¼Œç›´æ¥ä½¿ç”¨
            simpleMDE.value(currentContent);
          }
        } else {
          // æ²¡æœ‰å†…å®¹ï¼Œæ¸…ç©º
          simpleMDE.value('');
        }
      } else {
        // HTMLæ¨¡å¼
        markdownContainer.style.display = 'none';
        htmlContainer.style.display = 'block';
        
        // åˆå§‹åŒ–Quillç¼–è¾‘å™¨ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
        if (!quillEditor) {
          await initQuillEditor();
          // ç­‰å¾…Quillå®Œå…¨åˆå§‹åŒ–
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // å¦‚æœåˆ‡æ¢åˆ°HTMLï¼Œå°†Markdownå†…å®¹è½¬æ¢ä¸ºHTML
        if (currentContent && quillEditor) {
          if (currentContent.trim().startsWith('<')) {
            // å·²ç»æ˜¯HTMLå†…å®¹ï¼Œç›´æ¥ä½¿ç”¨
            quillEditor.root.innerHTML = currentContent;
          } else {
            // Markdownå†…å®¹ï¼Œè½¬æ¢ä¸ºHTMLï¼ˆä½¿ç”¨asyncå‡½æ•°ï¼‰
            markdownToHtml(currentContent).then(htmlContent => {
              if (quillEditor) {
                quillEditor.root.innerHTML = htmlContent;
              }
            }).catch(error => {
              console.error('Markdownè½¬æ¢å¤±è´¥:', error);
              if (quillEditor) {
                quillEditor.root.innerHTML = '<p>è½¬æ¢å¤±è´¥: ' + escapeHtml(error.message) + '</p>';
              }
            });
          }
        } else if (quillEditor) {
          // æ²¡æœ‰å†…å®¹ï¼Œæ¸…ç©º
          quillEditor.root.innerHTML = '';
        }
      }
    }
    
    // HTMLè½¬Markdownçš„è¾…åŠ©å‡½æ•°
    function htmlToMarkdown(html) {
      if (!html) return '';
      
      let markdown = html
        // æ ‡é¢˜
        .replace(/<h1[^>]*>(.*?)<\/h1>/gi, '# $1\n\n')
        .replace(/<h2[^>]*>(.*?)<\/h2>/gi, '## $1\n\n')
        .replace(/<h3[^>]*>(.*?)<\/h3>/gi, '### $1\n\n')
        .replace(/<h4[^>]*>(.*?)<\/h4>/gi, '#### $1\n\n')
        .replace(/<h5[^>]*>(.*?)<\/h5>/gi, '##### $1\n\n')
        .replace(/<h6[^>]*>(.*?)<\/h6>/gi, '###### $1\n\n')
        // ç²—ä½“å’Œæ–œä½“
        .replace(/<strong[^>]*>(.*?)<\/strong>/gi, '**$1**')
        .replace(/<b[^>]*>(.*?)<\/b>/gi, '**$1**')
        .replace(/<em[^>]*>(.*?)<\/em>/gi, '*$1*')
        .replace(/<i[^>]*>(.*?)<\/i>/gi, '*$1*')
        // é“¾æ¥
        .replace(/<a[^>]*href=["']([^"']*)["'][^>]*>(.*?)<\/a>/gi, '[$2]($1)')
        // å›¾ç‰‡
        .replace(/<img[^>]*src=["']([^"']*)["'][^>]*alt=["']([^"']*)["'][^>]*>/gi, '![$2]($1)')
        .replace(/<img[^>]*src=["']([^"']*)["'][^>]*>/gi, '![]($1)')
        // åˆ—è¡¨
        .replace(/<ul[^>]*>/gi, '')
        .replace(/<\/ul>/gi, '\n')
        .replace(/<ol[^>]*>/gi, '')
        .replace(/<\/ol>/gi, '\n')
        .replace(/<li[^>]*>(.*?)<\/li>/gi, '- $1\n')
        // ä»£ç å—
        .replace(/<pre[^>]*><code[^>]*>(.*?)<\/code><\/pre>/gis, '```\n$1\n```\n')
        .replace(/<code[^>]*>(.*?)<\/code>/gi, '`$1`')
        // æ®µè½å’Œæ¢è¡Œ
        .replace(/<p[^>]*>(.*?)<\/p>/gi, '$1\n\n')
        .replace(/<br[^>]*>/gi, '\n')
        .replace(/<div[^>]*>(.*?)<\/div>/gis, '$1\n')
        // ç§»é™¤æ‰€æœ‰å‰©ä½™çš„HTMLæ ‡ç­¾
        .replace(/<[^>]+>/g, '')
        // æ¸…ç†å¤šä½™çš„ç©ºè¡Œ
        .replace(/\n{3,}/g, '\n\n')
        .trim();
      
      return markdown;
    }
    
    // Markdownè½¬HTMLçš„è¾…åŠ©å‡½æ•°ï¼ˆä½¿ç”¨marked.jsï¼‰
    async function markdownToHtml(markdown) {
      if (!markdown) return '';
      
      // å¦‚æœå·²ç»æ˜¯HTMLï¼Œç›´æ¥è¿”å›
      if (markdown.trim().startsWith('<')) {
        return markdown;
      }
      
      // ä½¿ç”¨marked.jsè¿›è¡Œè½¬æ¢
      if (typeof marked !== 'undefined') {
        try {
          // é…ç½®markedé€‰é¡¹
          marked.setOptions({
            breaks: true, // æ”¯æŒGFMæ¢è¡Œ
            gfm: true, // å¯ç”¨GitHub Flavored Markdown
            headerIds: true,
            mangle: false
          });
          return marked.parse(markdown);
        } catch (error) {
          console.error('Markdownè½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨ç®€å•è½¬æ¢:', error);
          // å¦‚æœmarked.jsè½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨ç®€å•è½¬æ¢ä½œä¸ºåå¤‡
        }
      }
      
      // åå¤‡æ–¹æ¡ˆï¼šç®€å•è½¬æ¢ï¼ˆå¦‚æœmarked.jsæœªåŠ è½½ï¼‰
      let html = markdown
        // æ ‡é¢˜
        .replace(/^###### (.*?)$/gm, '<h6>$1</h6>')
        .replace(/^##### (.*?)$/gm, '<h5>$1</h5>')
        .replace(/^#### (.*?)$/gm, '<h4>$1</h4>')
        .replace(/^### (.*?)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*?)$/gm, '<h2>$1</h2>')
        .replace(/^# (.*?)$/gm, '<h1>$1</h1>')
        // ç²—ä½“å’Œæ–œä½“
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // é“¾æ¥
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
        // å›¾ç‰‡
        .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')
        // ä»£ç å—
        .replace(/```([^`]+)```/gs, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // åˆ—è¡¨
        .replace(/^\- (.*?)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
        // æ®µè½ï¼ˆå¤„ç†åŒæ¢è¡Œï¼‰
        .split(/\n\n+/)
        .map(para => {
          para = para.trim();
          if (!para) return '';
          // å¦‚æœå·²ç»æ˜¯HTMLæ ‡ç­¾ï¼Œä¸åŒ…è£…
          if (para.match(/^<(h[1-6]|ul|ol|pre|code|div)/)) {
            return para;
          }
          return '<p>' + para.replace(/\n/g, '<br>') + '</p>';
        })
        .join('\n');
      
      return html;
    }
    
    // åˆå§‹åŒ–Quill HTMLç¼–è¾‘å™¨
    function initQuillEditor() {
      // æ£€æŸ¥Quillæ˜¯å¦å·²åŠ è½½
      if (typeof Quill === 'undefined') {
        console.error('QuillæœªåŠ è½½ï¼Œç­‰å¾…åŠ è½½...');
        // ç­‰å¾…QuillåŠ è½½
        return new Promise((resolve) => {
          const checkQuill = setInterval(() => {
            if (typeof Quill !== 'undefined') {
              clearInterval(checkQuill);
              initQuillEditorInternal();
              resolve();
            }
          }, 100);
          setTimeout(() => {
            clearInterval(checkQuill);
            if (typeof Quill === 'undefined') {
              showToast('HTMLç¼–è¾‘å™¨åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
            }
            resolve();
          }, 5000);
        });
      } else {
        initQuillEditorInternal();
      }
    }
    
    function initQuillEditorInternal() {
      if (typeof Quill === 'undefined') {
        return;
      }
      
      const editorContainer = document.getElementById('postHtmlContent');
      if (!editorContainer) {
        console.error('ç¼–è¾‘å™¨å®¹å™¨ä¸å­˜åœ¨');
        return;
      }
      
      // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œå…ˆé”€æ¯
      if (quillEditor) {
        try {
          quillEditor = null;
        } catch (e) {
          console.warn('é”€æ¯ç¼–è¾‘å™¨æ—¶å‡ºé”™:', e);
        }
      }
      
      // æ¸…ç©ºå®¹å™¨å†…å®¹ï¼ˆQuillä¼šåœ¨å®¹å™¨å†…åˆ›å»ºç¼–è¾‘å™¨ï¼‰
      editorContainer.innerHTML = '';
      
      try {
        // åˆ›å»ºQuillç¼–è¾‘å™¨
        quillEditor = new Quill('#postHtmlContent', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              ['bold', 'italic', 'underline', 'strike'],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'align': [] }],
              ['link', 'image'],
              ['blockquote', 'code-block'],
              ['clean']
            ]
          },
          placeholder: 'è¾“å…¥HTMLå†…å®¹...'
        });
        console.log('Quillç¼–è¾‘å™¨åˆå§‹åŒ–æˆåŠŸ');
      } catch (error) {
        console.error('åˆå§‹åŒ–Quillç¼–è¾‘å™¨å¤±è´¥:', error);
        showToast('HTMLç¼–è¾‘å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
      }
    }
    
    // éšè—æ–‡ç« è¡¨å•
    function hidePostForm() {
      document.getElementById('postForm').style.display = 'none';
      // å¦‚æœæ˜¯åœ¨æ–°çª—å£ä¸­æ‰“å¼€çš„ï¼Œå…³é—­çª—å£
      if (window.opener) {
        window.close();
      }
    }

    // å¤©æ°”è·¯å†µæ•°æ®ç®¡ç†
    let weatherAttractionsCounter = 0;
    let weatherTrafficCounter = 0;
    
    // æ·»åŠ æ™¯ç‚¹å¤©æ°”
    function addWeatherAttraction(attraction = null) {
      const container = document.getElementById('weatherAttractionsList');
      const index = attraction ? attraction._index : weatherAttractionsCounter++;
      const itemId = attraction ? attraction.id : '';
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'weather-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #3b82f6;">æ™¯ç‚¹ #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeWeatherAttraction(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> åˆ é™¤
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ID</label>
            <input type="number" class="admin-form-input weather-attraction-id" value="${itemId}" placeholder="è‡ªåŠ¨ç”Ÿæˆ" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ™¯ç‚¹åç§° *</label>
            <input type="text" class="admin-form-input weather-attraction-name" value="${attraction ? escapeHtml(attraction.name || '') : ''}" placeholder="å¦‚ï¼šé‡‘å­—å¡”" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ¸©åº¦ (Â°C) *</label>
            <input type="number" class="admin-form-input weather-attraction-temperature" value="${attraction ? attraction.temperature || '' : ''}" placeholder="å¦‚ï¼š36" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">èƒ½è§åº¦</label>
            <input type="text" class="admin-form-input weather-attraction-visibility" value="${attraction ? escapeHtml(attraction.visibility || '') : ''}" placeholder="å¦‚ï¼šé«˜ã€ä¸­ã€ä½" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ç´«å¤–çº¿æŒ‡æ•°</label>
            <input type="number" class="admin-form-input weather-attraction-uvIndex" value="${attraction ? attraction.uvIndex || '' : ''}" placeholder="å¦‚ï¼š10" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">é£é€Ÿ</label>
            <input type="text" class="admin-form-input weather-attraction-windSpeed" value="${attraction ? escapeHtml(attraction.windSpeed || '') : ''}" placeholder="å¦‚ï¼š3çº§" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
        </div>
        <div class="admin-form-group" style="margin-bottom: 0; margin-top: 0.75rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          <label class="admin-form-label" style="font-size: 0.875rem;">å»ºè®®</label>
          <textarea class="admin-form-input weather-attraction-suggestion" rows="2" placeholder="å¦‚ï¼šæ—©æ™¨ 8 ç‚¹å‰å»ï¼Œå¸¦è¶³æ°´ã€‚" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;">${attraction ? escapeHtml(attraction.suggestion || '') : ''}</textarea>
        </div>
      `;
      
      container.appendChild(itemDiv);
    }
    
    // åˆ é™¤æ™¯ç‚¹å¤©æ°”
    function removeWeatherAttraction(index) {
      const container = document.getElementById('weatherAttractionsList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ™¯ç‚¹å—ï¼Ÿ')) {
        item.remove();
      }
    }
    
    // æ·»åŠ è·¯å†µä¿¡æ¯
    function addWeatherTraffic(traffic = null) {
      const container = document.getElementById('weatherTrafficList');
      const index = traffic ? traffic._index : weatherTrafficCounter++;
      const itemId = traffic ? traffic.id : '';
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'weather-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #3b82f6;">è·¯å†µ #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeWeatherTraffic(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> åˆ é™¤
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ID</label>
            <input type="number" class="admin-form-input weather-traffic-id" value="${itemId}" placeholder="è‡ªåŠ¨ç”Ÿæˆ" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ—¶é—´ *</label>
            <input type="text" class="admin-form-input weather-traffic-time" value="${traffic ? escapeHtml(traffic.time || '') : ''}" placeholder="å¦‚ï¼š10:30" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ç±»å‹ *</label>
            <select class="admin-form-select weather-traffic-type" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
              <option value="è½¦ç¥¸" ${traffic && traffic.type === 'è½¦ç¥¸' ? 'selected' : ''}>è½¦ç¥¸</option>
              <option value="æ–½å·¥" ${traffic && traffic.type === 'æ–½å·¥' ? 'selected' : ''}>æ–½å·¥</option>
              <option value="å¤©æ°”" ${traffic && traffic.type === 'å¤©æ°”' ? 'selected' : ''}>å¤©æ°”</option>
              <option value="æ‹¥å µ" ${traffic && traffic.type === 'æ‹¥å µ' ? 'selected' : ''}>æ‹¥å µ</option>
              <option value="å…¶ä»–" ${traffic && traffic.type === 'å…¶ä»–' ? 'selected' : ''}>å…¶ä»–</option>
            </select>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; grid-column: 1 / -1; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">åœ°ç‚¹ *</label>
            <input type="text" class="admin-form-input weather-traffic-location" value="${traffic ? escapeHtml(traffic.location || '') : ''}" placeholder="å¦‚ï¼šç¯åŸè·¯ Maadi å‡ºå£æ–¹å‘" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; grid-column: 1 / -1; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ¶ˆæ¯ *</label>
            <textarea class="admin-form-input weather-traffic-message" rows="2" placeholder="å¦‚ï¼šå‘ç”Ÿè¿½å°¾ï¼Œæåº¦æ‹¥å µã€‚" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box; resize: vertical;">${traffic ? escapeHtml(traffic.message || '') : ''}</textarea>
          </div>
        </div>
      `;
      
      container.appendChild(itemDiv);
    }
    
    // åˆ é™¤è·¯å†µä¿¡æ¯
    function removeWeatherTraffic(index) {
      const container = document.getElementById('weatherTrafficList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è·¯å†µä¿¡æ¯å—ï¼Ÿ')) {
        item.remove();
      }
    }
    
    // æ·»åŠ æ±‡ç‡è½¬æ¢é¡¹
    function addExchangeRate(rate = null) {
      const container = document.getElementById('exchangeRatesList');
      const index = rate ? rate._index : exchangeRatesCounter++;
      
      const itemDiv = document.createElement('div');
      itemDiv.className = 'exchange-rate-item';
      itemDiv.style.cssText = 'background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 0.75rem; border: 1px solid #d1d5db;';
      itemDiv.dataset.index = index;
      
      itemDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
          <strong style="color: #10b981;">æ±‡ç‡ #${index + 1}</strong>
          <button type="button" class="blog-btn blog-btn-secondary" onclick="removeExchangeRate(${index})" style="font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #ef4444; color: white;">
            <i class="fa fa-trash"></i> åˆ é™¤
          </button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; width: 100%; box-sizing: border-box;">
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æºè´§å¸ *</label>
            <input type="text" class="admin-form-input exchange-rate-from" value="${rate ? escapeHtml(rate.fromCurrency || '') : ''}" placeholder="å¦‚ï¼šCNY" pattern="^[A-Z]{3}$" maxlength="3" style="font-size: 0.875rem; text-transform: uppercase; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">3ä½å¤§å†™å­—æ¯</small>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">ç›®æ ‡è´§å¸ *</label>
            <input type="text" class="admin-form-input exchange-rate-to" value="${rate ? escapeHtml(rate.toCurrency || '') : ''}" placeholder="å¦‚ï¼šEGP" pattern="^[A-Z]{3}$" maxlength="3" style="font-size: 0.875rem; text-transform: uppercase; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">3ä½å¤§å†™å­—æ¯</small>
          </div>
          <div class="admin-form-group" style="margin-bottom: 0; width: 100%; max-width: 100%; box-sizing: border-box;">
            <label class="admin-form-label" style="font-size: 0.875rem;">æ±‡ç‡ *</label>
            <input type="number" class="admin-form-input exchange-rate-value" value="${rate ? escapeHtml(rate.rate || '') : ''}" placeholder="å¦‚ï¼š6.74" step="0.0001" min="0" style="font-size: 0.875rem; width: 100%; max-width: 100%; box-sizing: border-box;">
            <small style="color: #6b7280; font-size: 0.75rem;">1æºè´§å¸=?ç›®æ ‡è´§å¸</small>
          </div>
        </div>
      `;
      
      container.appendChild(itemDiv);
      
      // è‡ªåŠ¨è½¬æ¢ä¸ºå¤§å†™
      const fromInput = itemDiv.querySelector('.exchange-rate-from');
      const toInput = itemDiv.querySelector('.exchange-rate-to');
      fromInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
      toInput.addEventListener('input', function() {
        this.value = this.value.toUpperCase();
      });
    }
    
    // åˆ é™¤æ±‡ç‡è½¬æ¢é¡¹
    function removeExchangeRate(index) {
      const container = document.getElementById('exchangeRatesList');
      const item = container.querySelector(`[data-index="${index}"]`);
      if (item && confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ±‡ç‡å—ï¼Ÿ')) {
        item.remove();
      }
    }
    
    // åŠ è½½ç‰¹æ®Šç±»åˆ«æ•°æ®åˆ°è¡¨å•
    function loadSpecialCategoryData(specialType, originalData) {
      if (specialType === 'translation') {
        document.getElementById('translationChinese').value = originalData.chinese || '';
        document.getElementById('translationArabic').value = originalData.arabic || '';
        document.getElementById('translationCategory').value = originalData.category || '';
      } else if (specialType === 'weather') {
        // åŠ è½½globalAlert
        if (originalData.globalAlert) {
          document.getElementById('weatherGlobalAlertLevel').value = originalData.globalAlert.level || 'medium';
          document.getElementById('weatherGlobalAlertMessage').value = originalData.globalAlert.message || '';
        }
        
        // åŠ è½½attractions
        const attractionsContainer = document.getElementById('weatherAttractionsList');
        attractionsContainer.innerHTML = '';
        weatherAttractionsCounter = 0;
        if (originalData.attractions && Array.isArray(originalData.attractions)) {
          originalData.attractions.forEach((attraction, index) => {
            attraction._index = index;
            addWeatherAttraction(attraction);
            weatherAttractionsCounter++;
          });
        }
        
        // åŠ è½½traffic
        const trafficContainer = document.getElementById('weatherTrafficList');
        trafficContainer.innerHTML = '';
        weatherTrafficCounter = 0;
        if (originalData.traffic && Array.isArray(originalData.traffic)) {
          originalData.traffic.forEach((traffic, index) => {
            traffic._index = index;
            addWeatherTraffic(traffic);
            weatherTrafficCounter++;
          });
        }
      } else if (specialType === 'exchange-rate') {
        // åŠ è½½æ‰€æœ‰è´§å¸æ±‡ç‡
        const ratesContainer = document.getElementById('exchangeRatesList');
        ratesContainer.innerHTML = '';
        exchangeRatesCounter = 0;
        
        // éå†originalDataä¸­çš„æ‰€æœ‰è´§å¸å­—æ®µï¼ˆCNY, USD, EURç­‰ï¼‰
        Object.keys(originalData).forEach(currency => {
          // è·³è¿‡æ ‡å‡†å­—æ®µ
          if (['id', 'name', 'title', 'slug', 'excerpt', 'description', 'htmlContent', 'image', 'category', 'tags', 'published', 'views', 'createdAt', 'updatedAt', 'detailApi', 'updateTime'].includes(currency)) {
            return;
          }
          
          // å¦‚æœè¯¥å­—æ®µæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆåŒ…å«ç›®æ ‡è´§å¸å’Œæ±‡ç‡ï¼‰
          if (originalData[currency] && typeof originalData[currency] === 'object' && !Array.isArray(originalData[currency])) {
            // éå†è¯¥è´§å¸çš„æ‰€æœ‰ç›®æ ‡è´§å¸
            Object.keys(originalData[currency]).forEach(targetCurrency => {
              const rate = originalData[currency][targetCurrency];
              addExchangeRate({
                fromCurrency: currency,
                toCurrency: targetCurrency,
                rate: rate
              });
              exchangeRatesCounter++;
            });
          }
        });
        
        // å¦‚æœæ²¡æœ‰æ±‡ç‡æ•°æ®ï¼Œè‡³å°‘æ·»åŠ ä¸€è¡Œç©ºè¡Œ
        if (exchangeRatesCounter === 0) {
          addExchangeRate();
        }
        
        // åŠ è½½æ›´æ–°æ—¶é—´
        if (originalData.updateTime) {
          const date = new Date(originalData.updateTime);
          const localDateTime = date.toISOString().slice(0, 16);
          document.getElementById('exchangeUpdateTime').value = localDateTime;
        }
      }
    }
    
    // ä»è¡¨å•æ”¶é›†ç‰¹æ®Šç±»åˆ«æ•°æ®
    function collectSpecialCategoryData(specialType) {
      const data = {};
      
      if (specialType === 'translation') {
        data.chinese = document.getElementById('translationChinese').value.trim();
        data.arabic = document.getElementById('translationArabic').value.trim();
        data.category = document.getElementById('translationCategory').value.trim();
        
        if (!data.chinese || !data.arabic) {
          throw new Error('ä¸­æ–‡å’Œé˜¿æ‹‰ä¼¯æ–‡ä¸ºå¿…å¡«é¡¹');
        }
      } else if (specialType === 'weather') {
        // æ”¶é›†globalAlert
        const alertLevel = document.getElementById('weatherGlobalAlertLevel').value;
        const alertMessage = document.getElementById('weatherGlobalAlertMessage').value.trim();
        
        if (!alertMessage) {
          throw new Error('é¢„è­¦æ¶ˆæ¯ä¸ºå¿…å¡«é¡¹');
        }
        
        data.globalAlert = {
          level: alertLevel,
          message: alertMessage
        };
        
        // æ”¶é›†attractions
        const attractionsContainer = document.getElementById('weatherAttractionsList');
        const attractionItems = attractionsContainer.querySelectorAll('.weather-item');
        data.attractions = [];
        
        attractionItems.forEach((item, index) => {
          const idInput = item.querySelector('.weather-attraction-id');
          const nameInput = item.querySelector('.weather-attraction-name');
          const tempInput = item.querySelector('.weather-attraction-temperature');
          const visibilityInput = item.querySelector('.weather-attraction-visibility');
          const uvIndexInput = item.querySelector('.weather-attraction-uvIndex');
          const windSpeedInput = item.querySelector('.weather-attraction-windSpeed');
          const suggestionInput = item.querySelector('.weather-attraction-suggestion');
          
          const name = nameInput.value.trim();
          const temperature = tempInput.value.trim();
          
          if (!name || !temperature) {
            throw new Error(`æ™¯ç‚¹ #${index + 1}ï¼šåç§°å’Œæ¸©åº¦ä¸ºå¿…å¡«é¡¹`);
          }
          
          const attraction = {
            id: idInput.value ? parseInt(idInput.value) : index + 1,
            name: name,
            temperature: parseInt(temperature),
            visibility: visibilityInput.value.trim() || undefined,
            uvIndex: uvIndexInput.value ? parseInt(uvIndexInput.value) : undefined,
            windSpeed: windSpeedInput.value.trim() || undefined,
            suggestion: suggestionInput.value.trim() || undefined
          };
          
          // ç§»é™¤undefinedå­—æ®µ
          Object.keys(attraction).forEach(key => {
            if (attraction[key] === undefined) {
              delete attraction[key];
            }
          });
          
          data.attractions.push(attraction);
        });
        
        // æ”¶é›†traffic
        const trafficContainer = document.getElementById('weatherTrafficList');
        const trafficItems = trafficContainer.querySelectorAll('.weather-item');
        data.traffic = [];
        
        trafficItems.forEach((item, index) => {
          const idInput = item.querySelector('.weather-traffic-id');
          const timeInput = item.querySelector('.weather-traffic-time');
          const typeInput = item.querySelector('.weather-traffic-type');
          const locationInput = item.querySelector('.weather-traffic-location');
          const messageInput = item.querySelector('.weather-traffic-message');
          
          const time = timeInput.value.trim();
          const type = typeInput.value;
          const location = locationInput.value.trim();
          const message = messageInput.value.trim();
          
          if (!time || !type || !location || !message) {
            throw new Error(`è·¯å†µ #${index + 1}ï¼šæ—¶é—´ã€ç±»å‹ã€åœ°ç‚¹å’Œæ¶ˆæ¯ä¸ºå¿…å¡«é¡¹`);
          }
          
          const traffic = {
            id: idInput.value ? parseInt(idInput.value) : index + 1,
            time: time,
            type: type,
            location: location,
            message: message
          };
          
          data.traffic.push(traffic);
        });
        
        // ä¿ç•™dataå­—æ®µï¼ˆå¦‚æœå­˜åœ¨ï¼Œç”¨äºåˆ—è¡¨æ˜¾ç¤ºï¼‰
        // dataå­—æ®µä¼šåœ¨åç«¯å¤„ç†æ—¶è‡ªåŠ¨ç”Ÿæˆæˆ–ä¿ç•™
      } else if (specialType === 'exchange-rate') {
        // æ”¶é›†æ‰€æœ‰æ±‡ç‡é¡¹
        const ratesContainer = document.getElementById('exchangeRatesList');
        const rateItems = ratesContainer.querySelectorAll('.exchange-rate-item');
        
        // æ„å»ºæ±‡ç‡å¯¹è±¡ï¼š{CNY: {EGP: 6.74}, USD: {EGP: 30.5}, ...}
        const exchangeRates = {};
        
        rateItems.forEach((item, index) => {
          const fromInput = item.querySelector('.exchange-rate-from');
          const toInput = item.querySelector('.exchange-rate-to');
          const rateInput = item.querySelector('.exchange-rate-value');
          
          const fromCurrency = fromInput.value.trim().toUpperCase();
          const toCurrency = toInput.value.trim().toUpperCase();
          const rate = parseFloat(rateInput.value);
          
          if (!fromCurrency || !toCurrency || isNaN(rate) || rate <= 0) {
            throw new Error(`æ±‡ç‡ #${index + 1}ï¼šæºè´§å¸ã€ç›®æ ‡è´§å¸å’Œæ±‡ç‡ä¸ºå¿…å¡«é¡¹ï¼Œä¸”æ±‡ç‡å¿…é¡»å¤§äº0`);
          }
          
          // éªŒè¯è´§å¸ä»£ç æ ¼å¼
          if (!/^[A-Z]{3}$/.test(fromCurrency)) {
            throw new Error(`æ±‡ç‡ #${index + 1}ï¼šæºè´§å¸æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º3ä½å¤§å†™å­—æ¯ï¼Œå¦‚ CNYã€USDã€EGP`);
          }
          if (!/^[A-Z]{3}$/.test(toCurrency)) {
            throw new Error(`æ±‡ç‡ #${index + 1}ï¼šç›®æ ‡è´§å¸æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º3ä½å¤§å†™å­—æ¯ï¼Œå¦‚ CNYã€USDã€EGP`);
          }
          
          // å¦‚æœè¯¥æºè´§å¸å·²å­˜åœ¨ï¼Œæ·»åŠ ç›®æ ‡è´§å¸
          if (!exchangeRates[fromCurrency]) {
            exchangeRates[fromCurrency] = {};
          }
          exchangeRates[fromCurrency][toCurrency] = rate;
        });
        
        // å°†æ±‡ç‡å¯¹è±¡åˆå¹¶åˆ°dataä¸­
        Object.assign(data, exchangeRates);
        
        // æ·»åŠ æ›´æ–°æ—¶é—´
        const updateTime = document.getElementById('exchangeUpdateTime').value;
        if (updateTime) {
          data.updateTime = new Date(updateTime).toISOString();
        }
      }
      
      return data;
    }
    
    // ä¿å­˜æ–‡ç« 
    async function savePost(event) {
      event.preventDefault();
      
      const id = document.getElementById('postId').value;
      const name = document.getElementById('postName').value.trim();
      // nameå’Œtitleä¿æŒä¸€è‡´
      const title = name;
      const slug = document.getElementById('postSlug').value.trim();
      const excerpt = document.getElementById('postExcerpt').value.trim();
      const image = document.getElementById('postImage').value.trim();
      const apiName = document.getElementById('postApiName').value.trim();
      const category = document.getElementById('postCategory').value.trim();
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»åˆ«
      const specialType = isSpecialCategory(apiName);
      
      // è·å–htmlContentï¼ˆç»Ÿä¸€ä½¿ç”¨htmlContentå­—æ®µï¼‰
      let htmlContent = '';
      let specialData = null;
      
      // åªæœ‰ weatherã€exchange-rateã€translation ä¸ä½¿ç”¨ htmlContent
      // second-hand å’Œ rentals ä»ç„¶éœ€è¦ htmlContent
      const needsSpecialDataOnly = specialType && (specialType === 'weather' || specialType === 'exchange-rate' || specialType === 'translation');
      
      if (specialType) {
        // ç‰¹æ®Šç±»åˆ«ï¼šæ”¶é›†ç‰¹æ®Šæ•°æ®
        try {
          specialData = collectSpecialCategoryData(specialType);
          // åªæœ‰ weatherã€exchange-rateã€translation ä¸éœ€è¦ htmlContent
          // second-hand å’Œ rentals ä»ç„¶éœ€è¦ htmlContent
          if (!needsSpecialDataOnly) {
            // è·å–htmlContentï¼ˆsecond-hand å’Œ rentals éœ€è¦ï¼‰
            if (currentEditorMode === 'html' && quillEditor) {
              htmlContent = quillEditor.root.innerHTML;
            } else {
              // Markdownæ¨¡å¼ï¼šå°†Markdownè½¬æ¢ä¸ºHTML
              const markdownContent = simpleMDE ? simpleMDE.value() : document.getElementById('postContent').value;
              if (markdownContent) {
                // å¦‚æœå†…å®¹çœ‹èµ·æ¥åƒHTMLï¼Œç›´æ¥ä½¿ç”¨
                if (markdownContent.trim().startsWith('<')) {
                  htmlContent = markdownContent;
                } else {
                  // ä½¿ç”¨ marked.js å°† Markdown è½¬æ¢ä¸º HTML
                  if (typeof marked !== 'undefined') {
                    htmlContent = marked.parse(markdownContent);
                  } else {
                    htmlContent = markdownContent; // å¦‚æœæ²¡æœ‰ marked.jsï¼Œç›´æ¥ä½¿ç”¨åŸå§‹å†…å®¹
                  }
                }
              }
            }
          } else {
            // weatherã€exchange-rateã€translation ä¸éœ€è¦ htmlContent
            htmlContent = undefined;
          }
        } catch (error) {
          showToast(error.message, 'error');
          return;
        }
      } else {
        // æ™®é€šç±»åˆ«ï¼šè·å–htmlContent
        if (currentEditorMode === 'html' && quillEditor) {
          htmlContent = quillEditor.root.innerHTML;
        } else {
          // Markdownæ¨¡å¼ï¼šå°†Markdownè½¬æ¢ä¸ºHTML
          const markdownContent = simpleMDE ? simpleMDE.value() : document.getElementById('postContent').value;
          if (markdownContent) {
            // å¦‚æœå†…å®¹çœ‹èµ·æ¥åƒHTMLï¼Œç›´æ¥ä½¿ç”¨
            if (markdownContent.trim().startsWith('<')) {
              htmlContent = markdownContent;
            } else {
              // å¦åˆ™ï¼Œç®€å•å¤„ç†ï¼šå°†Markdownæ¢è¡Œè½¬æ¢ä¸ºHTMLæ®µè½
              htmlContent = '<p>' + markdownContent.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
            }
          }
        }
      }
      
      const published = document.getElementById('postPublished').checked;

      if (!name) {
        showToast('è¯·å¡«å†™æ–‡ç« åç§°', 'error');
        return;
      }

      if (!apiName) {
        showToast('è¯·é€‰æ‹©APIï¼ˆåˆ†ç±»ï¼‰', 'error');
        return;
      }

      // åœ¨éªŒè¯å‰ï¼Œå…ˆç§»é™¤æ‰€æœ‰éšè—è¡¨å•å­—æ®µçš„requiredå±æ€§ï¼Œé¿å…æµè§ˆå™¨éªŒè¯é”™è¯¯
      const allSpecialForms = ['specialForm-second-hand', 'specialForm-rentals', 'specialForm-weather', 
                               'specialForm-exchange-rate', 'specialForm-translation'];
      allSpecialForms.forEach(formId => {
        const form = document.getElementById(formId);
        if (form && form.style.display === 'none') {
          // è¡¨å•éšè—æ—¶ï¼Œç§»é™¤å…¶ä¸­æ‰€æœ‰å­—æ®µçš„requiredå±æ€§
          const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
          inputs.forEach(input => {
            input.removeAttribute('required');
          });
        }
      });

      // éªŒè¯å¿…å¡«å­—æ®µ
      // specialType å·²ç»åœ¨ä¸Šé¢å£°æ˜è¿‡äº†ï¼ˆç¬¬2076è¡Œï¼‰ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
      const needsLocation = needsLocationFields(apiName);
      const isLocationReq = isLocationRequired(apiName);
      
      // éªŒè¯è”ç³»æ–¹å¼ï¼ˆåœ¨ç§Ÿæˆ¿ã€äºŒæ‰‹é›†å¸‚å’Œå¯»å‘³ä¸­å›½ä¸­å¿…å¡«ï¼Œé˜²éª—æŒ‡å—ç­‰å¯é€‰ï¼‰
      const needsPhone = needsPhoneField(apiName);
      // åˆ¤æ–­ç”µè¯å­—æ®µæ˜¯å¦ä¸ºå¿…å¡«ï¼ˆå¯»å‘³ä¸­å›½å¿…å¡«ï¼Œé˜²éª—æŒ‡å—ç­‰å¯é€‰ï¼‰
      const lowerNameForPhone = apiName.toLowerCase();
      const isPhoneRequired = lowerNameForPhone.includes('chinese-food') || 
                              lowerNameForPhone.includes('å¯»å‘³') ||
                              specialType === 'second-hand' || 
                              specialType === 'rentals';
      
      if (needsPhone && isPhoneRequired) {
        let phoneInput;
        if (specialType === 'second-hand') {
          phoneInput = document.getElementById('secondHandPhone');
        } else if (specialType === 'rentals') {
          phoneInput = document.getElementById('rentalsPhone');
        } else {
          // å¯»å‘³ä¸­å›½ç­‰å…¶ä»–åˆ†ç±»ä½¿ç”¨é€šç”¨ç”µè¯å­—æ®µ
          phoneInput = document.getElementById('commonPhone');
        }
        
        // æ£€æŸ¥å­—æ®µæ˜¯å¦å¯è§ï¼ˆä¸åœ¨éšè—çš„è¡¨å•ä¸­ï¼‰
        if (phoneInput) {
          const isVisible = phoneInput.offsetParent !== null; // æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯è§
          if (isVisible && !phoneInput.value.trim()) {
            showToast('è”ç³»æ–¹å¼æ˜¯å¿…å¡«é¡¹', 'error');
            phoneInput.focus();
            return;
          }
        }
      }
      
      // éªŒè¯ä½ç½®ä¿¡æ¯ï¼ˆåªåœ¨å¿…å¡«åˆ†ç±»ä¸­éªŒè¯ï¼‰
      if (needsLocation && isLocationReq) {
        let addressInput, latInput, lngInput;
        
        if (specialType === 'second-hand') {
          addressInput = document.getElementById('secondHandAddress');
          latInput = document.getElementById('secondHandLatitude');
          lngInput = document.getElementById('secondHandLongitude');
        } else if (specialType === 'rentals') {
          addressInput = document.getElementById('rentalsAddress');
          latInput = document.getElementById('rentalsLatitude');
          lngInput = document.getElementById('rentalsLongitude');
        } else {
          addressInput = document.getElementById('commonAddress');
          latInput = document.getElementById('commonLatitude');
          lngInput = document.getElementById('commonLongitude');
        }
        
        // åªéªŒè¯å¯è§çš„å­—æ®µ
        if (addressInput) {
          const isVisible = addressInput.offsetParent !== null;
          if (isVisible && !addressInput.value.trim()) {
            showToast('åœ°å€æ˜¯å¿…å¡«é¡¹', 'error');
            addressInput.focus();
            return;
          }
        }
        if (latInput) {
          const isVisible = latInput.offsetParent !== null;
          if (isVisible && !latInput.value.trim()) {
            showToast('çº¬åº¦æ˜¯å¿…å¡«é¡¹', 'error');
            latInput.focus();
            return;
          }
        }
        if (lngInput) {
          const isVisible = lngInput.offsetParent !== null;
          if (isVisible && !lngInput.value.trim()) {
            showToast('ç»åº¦æ˜¯å¿…å¡«é¡¹', 'error');
            lngInput.focus();
            return;
          }
        }
      }

      if (!category) {
        showToast('è¯·å¡«å†™åˆ†ç±»/æ ‡ç­¾', 'error');
        return;
      }

      try {
        // ç›´æ¥ä½¿ç”¨idï¼ˆidç°åœ¨æ˜¯å…¨å±€å”¯ä¸€çš„UUIDï¼‰
        // å¦‚æœIDä¸ºç©ºå­—ç¬¦ä¸²æˆ–null/undefinedï¼Œåˆ™åˆ›å»ºæ–°æ–‡ç« 
        const hasId = id && id.trim() !== '';
        const url = hasId ? `${BLOG_ADMIN_API}/posts/${id}` : `${BLOG_ADMIN_API}/posts`;
        const method = hasId ? 'PUT' : 'POST';
        
        const requestBody = {
          name,
          title: title, // nameå’Œtitleä¿æŒä¸€è‡´
          slug: slug || undefined,
          excerpt,
          image: image || undefined,
          apiName: apiName, // APIåç§°ï¼ˆç”¨äºç¡®å®šæ•°æ®å­˜å‚¨ä½ç½®ï¼‰
          category: category, // åˆ†ç±»/æ ‡ç­¾ï¼ˆç”¨äºåšå®¢å±•ç¤ºï¼Œæ›¿ä»£åŸæ¥çš„tagså­—æ®µï¼‰
          published
        };
        
        // æ·»åŠ ç‰¹æ®Šå­—æ®µï¼ˆäºŒæ‰‹å¸‚åœºå’Œç§Ÿæˆ¿é…’åº—ï¼‰
        // specialType å’Œ needsLocation å·²ç»åœ¨ä¸Šé¢å£°æ˜è¿‡äº†ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨
        
        if (specialType === 'second-hand') {
          const price = document.getElementById('secondHandPrice').value.trim();
          const phone = document.getElementById('secondHandPhone').value.trim();
          const address = document.getElementById('secondHandAddress').value.trim();
          const latitude = document.getElementById('secondHandLatitude').value.trim();
          const longitude = document.getElementById('secondHandLongitude').value.trim();
          // å³ä½¿å­—æ®µä¸ºç©ºä¹Ÿè¦å‘é€ï¼Œä»¥ä¾¿åç«¯å¯ä»¥åˆ é™¤è¿™äº›å­—æ®µ
          requestBody.price = price || null;
          requestBody.phone = phone || null;
          requestBody.address = address || null;
          requestBody.latitude = latitude ? parseFloat(latitude) : null;
          requestBody.longitude = longitude ? parseFloat(longitude) : null;
        } else if (specialType === 'rentals') {
          const price = document.getElementById('rentalsPrice').value.trim();
          const rooms = document.getElementById('rentalsRooms').value.trim();
          const area = document.getElementById('rentalsArea').value.trim();
          const views = document.getElementById('rentalsViews').value.trim();
          const phone = document.getElementById('rentalsPhone').value.trim();
          const address = document.getElementById('rentalsAddress').value.trim();
          const latitude = document.getElementById('rentalsLatitude').value.trim();
          const longitude = document.getElementById('rentalsLongitude').value.trim();
          // å³ä½¿å­—æ®µä¸ºç©ºä¹Ÿè¦å‘é€ï¼Œä»¥ä¾¿åç«¯å¯ä»¥åˆ é™¤è¿™äº›å­—æ®µ
          requestBody.price = price || null;
          requestBody.rooms = rooms || null;
          requestBody.area = area || null;
          requestBody.views = views ? parseInt(views) || 0 : null;
          requestBody.phone = phone || null;
          requestBody.address = address || null;
          requestBody.latitude = latitude ? parseFloat(latitude) : null;
          requestBody.longitude = longitude ? parseFloat(longitude) : null;
        } else if (needsLocation) {
          // é€šç”¨ä½ç½®å­—æ®µï¼ˆç”¨äºå…¶ä»–éœ€è¦ä½ç½®çš„åˆ†ç±»ï¼‰
          const addressInput = document.getElementById('commonAddress');
          const latInput = document.getElementById('commonLatitude');
          const lngInput = document.getElementById('commonLongitude');
          // å³ä½¿å­—æ®µä¸ºç©ºä¹Ÿè¦å‘é€ï¼Œä»¥ä¾¿åç«¯å¯ä»¥åˆ é™¤è¿™äº›å­—æ®µ
          if (addressInput) {
            const address = addressInput.value.trim();
            requestBody.address = address || null;
          }
          if (latInput) {
            const latitude = latInput.value.trim();
            requestBody.latitude = latitude ? parseFloat(latitude) : null;
          }
          if (lngInput) {
            const longitude = lngInput.value.trim();
            requestBody.longitude = longitude ? parseFloat(longitude) : null;
          }
        }
        
        // æ·»åŠ é€šç”¨ç”µè¯å­—æ®µï¼ˆç”¨äºå¯»å‘³ä¸­å›½ç­‰åˆ†ç±»ï¼‰
        const needsPhone = needsPhoneField(apiName);
        if (needsPhone && specialType !== 'second-hand' && specialType !== 'rentals') {
          const phoneInput = document.getElementById('commonPhone');
          if (phoneInput) {
            const phone = phoneInput.value.trim();
            // å³ä½¿å­—æ®µä¸ºç©ºä¹Ÿè¦å‘é€ï¼Œä»¥ä¾¿åç«¯å¯ä»¥åˆ é™¤è¿™äº›å­—æ®µ
            requestBody.phone = phone || null;
          }
        }
        
        // å¦‚æœæ˜¯ç‰¹æ®Šç±»åˆ«ï¼Œæ·»åŠ ç‰¹æ®Šæ•°æ®
        // æ³¨æ„ï¼šsecond-hand å’Œ rentals è™½ç„¶éœ€è¦ç‰¹æ®Šå­—æ®µï¼Œä½†ä»ç„¶éœ€è¦ htmlContent
        const needsSpecialDataOnly = specialType && (specialType === 'weather' || specialType === 'exchange-rate' || specialType === 'translation');
        
        if (specialType && specialData) {
          requestBody._specialData = specialData;
          requestBody._specialType = specialType;
          
          // åªæœ‰ weatherã€exchange-rateã€translation ä¸ä½¿ç”¨ htmlContent
          // second-hand å’Œ rentals ä»ç„¶éœ€è¦ htmlContent
          if (!needsSpecialDataOnly) {
            requestBody.htmlContent = htmlContent || undefined;
          }
          
          // æ·»åŠ è°ƒè¯•ä¿¡æ¯
          console.log('ä¿å­˜ç‰¹æ®Šç±»åˆ«æ–‡ç« ', {
            specialType,
            needsSpecialDataOnly,
            specialDataKeys: Object.keys(specialData),
            specialDataPreview: JSON.stringify(specialData).substring(0, 500),
            hasHtmlContent: !needsSpecialDataOnly && htmlContent
          });
        } else {
          // æ™®é€šç±»åˆ«æ‰æ·»åŠ htmlContent
          requestBody.htmlContent = htmlContent || undefined;
        }
        
        console.log('å‘é€è¯·æ±‚', {
          url,
          method,
          requestBody: JSON.stringify(requestBody, null, 2)
        });
        
        const response = await adminApiRequest(url, {
          method,
          body: JSON.stringify(requestBody)
        });
        
        console.log('æ”¶åˆ°å“åº”', {
          success: response?.success,
          data: response?.data,
          message: response?.message
        });
        
        // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯é¢æ¿
        showDebugInfo({
          request: requestBody,
          response: response,
          specialType: specialType,
          specialData: specialData
        });
        
        if (response && response.success) {
          // æ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸä¿¡æ¯ï¼ˆåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼‰
          const debugInfo = specialType && specialData 
            ? `\nè°ƒè¯•ä¿¡æ¯ï¼š\n- ç±»å‹: ${specialType}\n- æ•°æ®é”®: ${Object.keys(specialData).join(', ')}\n- æ•°æ®é¢„è§ˆ: ${JSON.stringify(specialData).substring(0, 200)}`
            : '';
          
          console.log('ä¿å­˜æˆåŠŸ', {
            id: response.data?.id,
            name: response.data?.name,
            apiName: response.data?.category,
            debugInfo
          });
          
          showToast(id ? 'æ–‡ç« æ›´æ–°æˆåŠŸ' : 'æ–‡ç« åˆ›å»ºæˆåŠŸ', 'success');
          window.currentEditingPost = null; // æ¸…é™¤å½“å‰ç¼–è¾‘çš„æ–‡ç« 
          
          // å¦‚æœæ˜¯åœ¨æ–°çª—å£ä¸­æ‰“å¼€çš„ï¼Œåˆ·æ–°çˆ¶çª—å£å¹¶å…³é—­å½“å‰çª—å£
          if (window.opener) {
            // é€šçŸ¥çˆ¶çª—å£åˆ·æ–°å†…å®¹ï¼ˆæ ¹æ®çˆ¶çª—å£ç±»å‹è°ƒç”¨ä¸åŒçš„åˆ·æ–°æ–¹æ³•ï¼‰
            try {
              // blog-admin.html ä½¿ç”¨ loadPosts
              if (typeof window.opener.loadPosts === 'function') {
                window.opener.loadPosts(false);
              }
              // blog-detail.html ä½¿ç”¨ loadPost
              if (typeof window.opener.loadPost === 'function') {
                window.opener.loadPost();
              }
              // blog.html å¯èƒ½ä½¿ç”¨ loadPosts æˆ– loadArchiveï¼ˆå·²åœ¨çª—å£å…³é—­æ—¶å¤„ç†ï¼‰
            } catch (e) {
              console.warn('æ— æ³•é€šçŸ¥çˆ¶çª—å£åˆ·æ–°:', e);
            }
            // å»¶è¿Ÿå…³é—­ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
            setTimeout(() => {
              window.close();
            }, 1000);
          } else {
            // åœ¨å½“å‰çª—å£ä¸­ï¼Œæ­£å¸¸å¤„ç†
            hidePostForm();
            loadPosts(false); // ä¿å­˜åä¿æŒå±•å¼€çŠ¶æ€
          }
        } else {
          console.error('ä¿å­˜å¤±è´¥', response);
          showToast('ä¿å­˜å¤±è´¥: ' + (response?.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
      } catch (error) {
        console.error('ä¿å­˜æ–‡ç« å¤±è´¥:', error);
        showToast('ä¿å­˜æ–‡ç« å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    // ç¼–è¾‘æ–‡ç« ï¼ˆåœ¨æ–°çª—å£æ‰“å¼€ï¼‰
    function editPost(id) {
      // åœ¨æ–°çª—å£æ‰“å¼€ç¼–è¾‘é¡µé¢
      const editUrl = `${window.location.pathname}?edit=${encodeURIComponent(id)}`;
      const editWindow = window.open(editUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!editWindow) {
        showToast('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
        return;
      }
      
      // ç›‘å¬æ–°çª—å£å…³é—­äº‹ä»¶ï¼Œåˆ·æ–°æ–‡ç« åˆ—è¡¨
      const checkClosed = setInterval(() => {
        if (editWindow.closed) {
          clearInterval(checkClosed);
          // åˆ·æ–°æ–‡ç« åˆ—è¡¨
          loadPosts(false);
        }
      }, 500);
    }
    
    // ç¼–è¾‘æ–‡ç« ï¼ˆå†…éƒ¨å‡½æ•°ï¼Œç”¨äºåœ¨æ–°çª—å£ä¸­åŠ è½½æ–‡ç« æ•°æ®ï¼‰
    async function editPostInternal(id) {
      const postForm = document.getElementById('postForm');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      try {
        // æ˜¾ç¤ºè¡¨å•å’ŒåŠ è½½æç¤º
        if (postForm) {
          postForm.style.display = 'block';
          postForm.classList.add('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'flex';
        }
        if (postFormContent) {
          postFormContent.style.display = 'none';
        }
        
        // åˆ‡æ¢åˆ°æ–‡ç« æ ‡ç­¾é¡µï¼ˆå¦‚æœä¸åœ¨æ–°çª—å£ï¼‰
        if (!window.opener) {
          switchTab('posts');
        }
        
        console.log('ç¼–è¾‘æ–‡ç« ï¼ŒID:', id);
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
        console.log('è·å–æ–‡ç« åˆ—è¡¨å“åº”:', response);
        
        if (response && response.success && response.data) {
          // ç›´æ¥ä½¿ç”¨idåŒ¹é…ï¼ˆidç°åœ¨æ˜¯å…¨å±€å”¯ä¸€çš„UUIDï¼‰
          const post = response.data.find(p => {
            const pId = String(p.id || '');
            const searchId = String(id || '');
            return pId === searchId;
          });
          
          console.log('æ‰¾åˆ°çš„æ–‡ç« :', post);
          
          if (post) {
            // ä¿å­˜å½“å‰æ–‡ç« å¯¹è±¡ï¼Œç”¨äºåç»­ä¿å­˜æ—¶ä½¿ç”¨
            window.currentEditingPost = post;
            // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºè¡¨å•å†…å®¹
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postFormContent) {
              postFormContent.style.display = 'block';
            }
            // å¡«å……è¡¨å•æ•°æ®
            showPostForm(post);
          } else {
            console.error('æœªæ‰¾åˆ°æ–‡ç« ï¼ŒID:', id, 'å¯ç”¨æ–‡ç« ID:', response.data.map(p => p.id));
            // éšè—åŠ è½½æç¤º
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postForm) {
              postForm.style.display = 'none';
            }
            showToast('æœªæ‰¾åˆ°è¦ç¼–è¾‘çš„æ–‡ç« ', 'error');
          }
        } else {
          console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', response);
          // éšè—åŠ è½½æç¤º
          if (postForm) {
            postForm.classList.remove('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'none';
          }
          if (postForm) {
            postForm.style.display = 'none';
          }
          showToast('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
        // éšè—åŠ è½½æç¤º
        if (postForm) {
          postForm.classList.remove('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'none';
        }
        if (postForm) {
          postForm.style.display = 'none';
        }
        showToast('åŠ è½½æ–‡ç« å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    // å¤åˆ¶æ–‡ç« ï¼ˆåœ¨æ–°çª—å£æ‰“å¼€ï¼‰
    function copyPost(id) {
      // åœ¨æ–°çª—å£æ‰“å¼€å¤åˆ¶é¡µé¢
      const copyUrl = `${window.location.pathname}?copy=${encodeURIComponent(id)}`;
      const copyWindow = window.open(copyUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!copyWindow) {
        showToast('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
        return;
      }
      
      // ç›‘å¬æ–°çª—å£å…³é—­äº‹ä»¶ï¼Œåˆ·æ–°æ–‡ç« åˆ—è¡¨
      const checkClosed = setInterval(() => {
        if (copyWindow.closed) {
          clearInterval(checkClosed);
          // åˆ·æ–°æ–‡ç« åˆ—è¡¨
          loadPosts(false);
        }
      }, 500);
    }
    
    // å¤åˆ¶æ–‡ç« ï¼ˆå†…éƒ¨å‡½æ•°ï¼Œç”¨äºåœ¨æ–°çª—å£ä¸­åŠ è½½æ–‡ç« æ•°æ®ï¼‰
    async function copyPostInternal(id) {
      const postForm = document.getElementById('postForm');
      const postFormLoading = document.getElementById('postFormLoading');
      const postFormContent = document.getElementById('postFormContent');
      
      try {
        // æ˜¾ç¤ºè¡¨å•å’ŒåŠ è½½æç¤º
        if (postForm) {
          postForm.style.display = 'block';
          postForm.classList.add('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'flex';
        }
        if (postFormContent) {
          postFormContent.style.display = 'none';
        }
        
        // åˆ‡æ¢åˆ°æ–‡ç« æ ‡ç­¾é¡µï¼ˆå¦‚æœä¸åœ¨æ–°çª—å£ï¼‰
        if (!window.opener) {
          switchTab('posts');
        }
        
        console.log('å¤åˆ¶æ–‡ç« ï¼ŒID:', id);
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts`);
        console.log('è·å–æ–‡ç« åˆ—è¡¨å“åº”:', response);
        
        if (response && response.success && response.data) {
          // ç›´æ¥ä½¿ç”¨idåŒ¹é…ï¼ˆidç°åœ¨æ˜¯å…¨å±€å”¯ä¸€çš„UUIDï¼‰
          const post = response.data.find(p => {
            const pId = String(p.id || '');
            const searchId = String(id || '');
            return pId === searchId;
          });
          
          console.log('æ‰¾åˆ°çš„æ–‡ç« :', post);
          
          if (post) {
            // åˆ›å»ºæ–‡ç« å‰¯æœ¬ï¼Œæ¸…é™¤IDå’Œslugï¼Œä¿®æ”¹æ ‡é¢˜
            const copiedPost = {
              ...post,
              id: '', // æ¸…é™¤IDï¼Œä¿å­˜æ—¶ä¼šåˆ›å»ºæ–°æ–‡ç« 
              slug: '', // æ¸…é™¤slugï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆæ–°çš„
              name: (post.name || post.title || 'æœªå‘½å') + 'ï¼ˆå‰¯æœ¬ï¼‰',
              title: (post.name || post.title || 'æœªå‘½å') + 'ï¼ˆå‰¯æœ¬ï¼‰',
              published: false, // é»˜è®¤è®¾ä¸ºè‰ç¨¿
              views: 0, // é‡ç½®æµè§ˆé‡
              createdAt: null, // æ¸…é™¤åˆ›å»ºæ—¶é—´
              updatedAt: null // æ¸…é™¤æ›´æ–°æ—¶é—´
            };
            
            // ä¿å­˜å½“å‰æ–‡ç« å¯¹è±¡ï¼ˆç”¨äºåç»­ä¿å­˜æ—¶ä½¿ç”¨ï¼‰
            window.currentEditingPost = copiedPost;
            
            // éšè—åŠ è½½æç¤ºï¼Œæ˜¾ç¤ºè¡¨å•å†…å®¹
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postFormContent) {
              postFormContent.style.display = 'block';
            }
            // å¡«å……è¡¨å•æ•°æ®
            showPostForm(copiedPost);
          } else {
            console.error('æœªæ‰¾åˆ°æ–‡ç« ï¼ŒID:', id, 'å¯ç”¨æ–‡ç« ID:', response.data.map(p => p.id));
            // éšè—åŠ è½½æç¤º
            if (postForm) {
              postForm.classList.remove('loading');
            }
            if (postFormLoading) {
              postFormLoading.style.display = 'none';
            }
            if (postForm) {
              postForm.style.display = 'none';
            }
            showToast('æœªæ‰¾åˆ°è¦å¤åˆ¶çš„æ–‡ç« ', 'error');
          }
        } else {
          console.error('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥:', response);
          // éšè—åŠ è½½æç¤º
          if (postForm) {
            postForm.classList.remove('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'none';
          }
          if (postForm) {
            postForm.style.display = 'none';
          }
          showToast('è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
        // éšè—åŠ è½½æç¤º
        if (postForm) {
          postForm.classList.remove('loading');
        }
        if (postFormLoading) {
          postFormLoading.style.display = 'none';
        }
        if (postForm) {
          postForm.style.display = 'none';
        }
        showToast('åŠ è½½æ–‡ç« å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    // åˆ é™¤æ–‡ç« 
    async function deletePost(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/posts/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('æ–‡ç« åˆ é™¤æˆåŠŸ', 'success');
          loadPosts(false); // åˆ é™¤åä¿æŒå±•å¼€çŠ¶æ€
        }
      } catch (error) {
        console.error('åˆ é™¤æ–‡ç« å¤±è´¥:', error);
      }
    }

    // åˆ†ç±»ç®¡ç†å‡½æ•°
    async function loadCategories() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories`);
        if (response && response.success) {
          const tbody = document.getElementById('categoriesTableBody');
          const categories = response.data || [];
          if (categories.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="blog-empty">æš‚æ— åˆ†ç±»</td></tr>';
          } else {
            tbody.innerHTML = categories.map(cat => `
              <tr>
                <td>${escapeHtml(cat.name)}</td>
                <td>${escapeHtml(cat.description || cat.path || '')}</td>
                <td>${cat.postCount || 0}</td>
                <td>
                  <div class="admin-actions">
                    <button class="admin-btn-small admin-btn-edit" onclick="editCategory(${cat.id})">ç¼–è¾‘</button>
                    <button class="admin-btn-small admin-btn-delete" onclick="deleteCategory(${cat.id})">åˆ é™¤</button>
                  </div>
                </td>
              </tr>
            `).join('');
          }
        }
      } catch (error) {
        document.getElementById('categoriesTableBody').innerHTML = '<tr><td colspan="4" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    function showCategoryForm(category = null) {
      const form = document.getElementById('categoryForm');
      const formTitle = document.getElementById('categoryFormTitle');
      
      if (category) {
        formTitle.textContent = 'ç¼–è¾‘åˆ†ç±»';
        document.getElementById('categoryId').value = category.id;
        document.getElementById('categoryName').value = category.name || '';
        document.getElementById('categoryPath').value = category.description || category.path || '';
      } else {
        formTitle.textContent = 'æ–°å»ºåˆ†ç±»';
        document.getElementById('categoryFormElement').reset();
        document.getElementById('categoryId').value = '';
      }
      
      form.style.display = 'block';
      form.scrollIntoView({ behavior: 'smooth' });
    }

    function hideCategoryForm() {
      document.getElementById('categoryForm').style.display = 'none';
      document.getElementById('categoryFormElement').reset();
      document.getElementById('categoryId').value = '';
    }

    async function saveCategory(event) {
      event.preventDefault();
      const id = document.getElementById('categoryId').value;
      const name = document.getElementById('categoryName').value.trim();
      const path = document.getElementById('categoryPath').value.trim();

      if (!name || !path) {
        showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
        return;
      }

      if (!path.startsWith('/')) {
        showToast('è·¯å¾„å¿…é¡»ä»¥ / å¼€å¤´', 'error');
        return;
      }

      try {
        const url = id ? `${BLOG_ADMIN_API}/categories/${id}` : `${BLOG_ADMIN_API}/categories`;
        const method = id ? 'PUT' : 'POST';
        
        const response = await adminApiRequest(url, {
          method,
          body: JSON.stringify({ name, path })
        });

        if (response && response.success) {
          showToast(id ? 'åˆ†ç±»æ›´æ–°æˆåŠŸ' : 'åˆ†ç±»åˆ›å»ºæˆåŠŸ', 'success');
          hideCategoryForm();
          loadCategories();
        }
      } catch (error) {
        console.error('ä¿å­˜åˆ†ç±»å¤±è´¥:', error);
        showToast('ä¿å­˜åˆ†ç±»å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    async function editCategory(id) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories`);
        if (response && response.success) {
          const category = response.data.find(c => c.id === id);
          if (category) {
            showCategoryForm(category);
          }
        }
      } catch (error) {
        console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
      }
    }

    async function deleteCategory(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿå¦‚æœæœ‰æ–‡ç« ä½¿ç”¨æ­¤åˆ†ç±»ï¼Œåˆ é™¤å°†å¤±è´¥ã€‚')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/categories/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('åˆ†ç±»åˆ é™¤æˆåŠŸ', 'success');
          loadCategories();
        }
      } catch (error) {
        console.error('åˆ é™¤åˆ†ç±»å¤±è´¥:', error);
        showToast('åˆ é™¤åˆ†ç±»å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    // æ ‡ç­¾ç®¡ç†å‡½æ•°
    async function loadTags() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/tags`);
        if (response && response.success) {
          const tbody = document.getElementById('tagsTableBody');
          const tags = response.data || [];
          if (tags.length === 0) {
            tbody.innerHTML = '<tr><td colspan="2" class="blog-empty">æš‚æ— æ ‡ç­¾</td></tr>';
          } else {
            tbody.innerHTML = tags.map(tag => `
              <tr>
                <td>${escapeHtml(tag.name)}</td>
                <td>${tag.postCount || 0}</td>
              </tr>
            `).join('');
          }
        }
      } catch (error) {
        document.getElementById('tagsTableBody').innerHTML = '<tr><td colspan="2" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    function showTagForm() {
      document.getElementById('tagForm').style.display = 'block';
    }

    function hideTagForm() {
      document.getElementById('tagForm').style.display = 'none';
      document.getElementById('tagForm').querySelector('form').reset();
    }

    async function saveTag(event) {
      event.preventDefault();
      const name = document.getElementById('tagName').value.trim();

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/tags`, {
          method: 'POST',
          body: JSON.stringify({ name })
        });

        if (response && response.success) {
          showToast('æ ‡ç­¾åˆ›å»ºæˆåŠŸ', 'success');
          hideTagForm();
          loadTags();
        }
      } catch (error) {
        console.error('åˆ›å»ºæ ‡ç­¾å¤±è´¥:', error);
      }
    }

    // è¯„è®ºç®¡ç†å‡½æ•°
    async function loadComments() {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments`);
        if (response && response.success) {
          const tbody = document.getElementById('commentsTableBody');
          const comments = response.data || [];
          if (comments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="blog-empty">æš‚æ— è¯„è®º</td></tr>';
          } else {
            tbody.innerHTML = comments.map(comment => {
              const date = formatDateTime(comment.createdAt || comment.created_at);
              return `
                <tr>
                  <td>${escapeHtml(comment.postName || '')}</td>
                  <td>${escapeHtml(comment.authorName)}</td>
                  <td>${escapeHtml(truncate(comment.content, 50))}</td>
                  <td>${comment.approved ? '<span style="color: #10b981;">å·²å®¡æ ¸</span>' : '<span style="color: #f59e0b;">å¾…å®¡æ ¸</span>'}</td>
                  <td>${date}</td>
                  <td>
                    <div class="admin-actions">
                      ${!comment.approved ? `<button class="admin-btn-small admin-btn-approve" onclick="approveComment('${comment.id}')">å®¡æ ¸</button>` : ''}
                      <button class="admin-btn-small admin-btn-delete" onclick="deleteComment('${comment.id}')">åˆ é™¤</button>
                    </div>
                  </td>
                </tr>
              `;
            }).join('');
          }
        }
      } catch (error) {
        document.getElementById('commentsTableBody').innerHTML = '<tr><td colspan="6" class="blog-empty">åŠ è½½å¤±è´¥</td></tr>';
      }
    }

    async function approveComment(id) {
      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments/${id}/approve`, {
          method: 'PUT',
          body: JSON.stringify({ approved: true })
        });

        if (response && response.success) {
          showToast('è¯„è®ºå·²å®¡æ ¸é€šè¿‡', 'success');
          loadComments();
        }
      } catch (error) {
        console.error('å®¡æ ¸è¯„è®ºå¤±è´¥:', error);
      }
    }

    async function deleteComment(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
        return;
      }

      try {
        const response = await adminApiRequest(`${BLOG_ADMIN_API}/comments/${id}`, {
          method: 'DELETE'
        });

        if (response && response.success) {
          showToast('è¯„è®ºåˆ é™¤æˆåŠŸ', 'success');
          loadComments();
        }
      } catch (error) {
        console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
      }
    }

    // åˆå§‹åŒ–
    // è·å–URLå‚æ•°
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // æ£€æŸ¥URLå‚æ•°å¹¶è‡ªåŠ¨æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
    async function checkUrlParams() {
      const editId = getUrlParam('edit');
      const copyId = getUrlParam('copy');
      
      if (editId) {
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåå†æ‰§è¡Œç¼–è¾‘
        setTimeout(async () => {
          await editPostInternal(editId);
          // æ¸…é™¤URLå‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤æ‰§è¡Œ
          const url = new URL(window.location);
          url.searchParams.delete('edit');
          window.history.replaceState({}, '', url);
        }, 500);
      }
      
      if (copyId) {
        // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåå†æ‰§è¡Œå¤åˆ¶
        setTimeout(async () => {
          await copyPostInternal(copyId);
          // æ¸…é™¤URLå‚æ•°ï¼Œé¿å…åˆ·æ–°æ—¶é‡å¤æ‰§è¡Œ
          const url = new URL(window.location);
          url.searchParams.delete('copy');
          window.history.replaceState({}, '', url);
        }, 500);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // å¦‚æœæ˜¯åœ¨æ–°çª—å£ä¸­æ‰“å¼€ç¼–è¾‘æˆ–å¤åˆ¶é¡µé¢ï¼ŒåªåŠ è½½å¿…è¦çš„èµ„æº
      const editId = getUrlParam('edit');
      const copyId = getUrlParam('copy');
      const isEditWindow = window.opener && (editId || copyId);
      
      if (isEditWindow) {
        // æ–°çª—å£ï¼šéšè—ä¸ç›¸å…³çš„å…ƒç´ ï¼Œåªæ˜¾ç¤ºç¼–è¾‘è¡¨å•
        hideUnnecessaryElements();
        // æ›´æ–°é¡µé¢æ ‡é¢˜
        if (copyId) {
          updatePageTitleForEdit('å¤åˆ¶æ–‡ç« ');
        } else {
          updatePageTitleForEdit();
        }
        // ç«‹å³æ˜¾ç¤ºè¡¨å•å’ŒåŠ è½½æç¤ºï¼ˆç­‰å¾…DOMå®Œå…¨åŠ è½½ï¼‰
        setTimeout(() => {
          const postForm = document.getElementById('postForm');
          const postFormLoading = document.getElementById('postFormLoading');
          const postFormContent = document.getElementById('postFormContent');
          if (postForm) {
            postForm.style.display = 'block';
            postForm.classList.add('loading');
          }
          if (postFormLoading) {
            postFormLoading.style.display = 'flex';
          }
          if (postFormContent) {
            postFormContent.style.display = 'none';
          }
        }, 100);
      } else {
        // ä¸»çª—å£ï¼šåŠ è½½æ–‡ç« åˆ—è¡¨
      loadPosts();
      }
      
      // æ‰€æœ‰çª—å£éƒ½éœ€è¦åŠ è½½APIåˆ—è¡¨
      loadApis();
      
      // ç›‘å¬å›¾ç‰‡URLè¾“å…¥æ¡†å˜åŒ–ï¼Œå®æ—¶æ›´æ–°é¢„è§ˆ
      const postImageInput = document.getElementById('postImage');
      if (postImageInput) {
        postImageInput.addEventListener('input', function() {
          updateImagePreview(this.value);
        });
        
        // åˆå§‹åŒ–æ—¶ä¹Ÿæ£€æŸ¥ä¸€æ¬¡
        updateImagePreview(postImageInput.value);
      }
      
      // æ£€æŸ¥URLå‚æ•°ï¼Œå¦‚æœæœ‰editå‚æ•°ï¼Œè‡ªåŠ¨æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
      await checkUrlParams();
    });
    
    // éšè—æ–°çª—å£ä¸­ä¸éœ€è¦çš„å…ƒç´ 
    function hideUnnecessaryElements() {
      // éšè—æ ‡ç­¾é¡µå¯¼èˆª
      const tabsContainer = document.querySelector('.admin-tabs');
      if (tabsContainer) {
        tabsContainer.style.display = 'none';
      }
      
      // éšè—æ–‡ç« ç®¡ç†æ ‡é¢˜å’Œæ–°å»ºæŒ‰é’®
      const postsHeader = document.querySelector('#tab-posts > div:first-child');
      if (postsHeader) {
        postsHeader.style.display = 'none';
      }
      
      // éšè—æ–‡ç« åˆ—è¡¨è¡¨æ ¼
      const postsTable = document.querySelector('#tab-posts > div:last-child');
      if (postsTable && postsTable.querySelector('#postsTableBody')) {
        postsTable.style.display = 'none';
      }
      
      // éšè—å…¶ä»–æ ‡ç­¾é¡µå†…å®¹
      const otherTabs = ['tab-categories', 'tab-tags', 'tab-comments'];
      otherTabs.forEach(tabId => {
        const tab = document.getElementById(tabId);
        if (tab) {
          tab.style.display = 'none';
        }
      });
      
      // ç¡®ä¿æ–‡ç« è¡¨å•å®¹å™¨å¯è§
      const postsTab = document.getElementById('tab-posts');
      if (postsTab) {
        postsTab.style.display = 'block';
        postsTab.classList.add('active');
      }
      
      // éšè—"è¿”å›åšå®¢"æŒ‰é’®ï¼ˆæ–°çª—å£ä¸­ä¸éœ€è¦ï¼‰
      const returnButton = document.querySelector('.admin-header a[href="/blog.html"]');
      if (returnButton) {
        returnButton.style.display = 'none';
      }
      
      // è°ƒæ•´å®¹å™¨æ ·å¼ï¼Œè®©ç¼–è¾‘è¡¨å•æ›´çªå‡º
      const adminContainer = document.querySelector('.admin-container');
      if (adminContainer) {
        adminContainer.style.maxWidth = '100%';
        adminContainer.style.padding = '1rem';
      }
    }
    
    // æ›´æ–°é¡µé¢æ ‡é¢˜ä¸ºç¼–è¾‘æ¨¡å¼
    function updatePageTitleForEdit(customTitle) {
      const headerTitle = document.querySelector('.admin-header h1');
      if (headerTitle) {
        headerTitle.textContent = customTitle || 'ç¼–è¾‘æ–‡ç« ';
      }
      
      const headerSubtitle = document.querySelector('.admin-header p');
      if (headerSubtitle) {
        if (customTitle === 'å¤åˆ¶æ–‡ç« ') {
          headerSubtitle.textContent = 'å¤åˆ¶å¹¶ç¼–è¾‘æ–‡ç« å†…å®¹';
        } else {
          headerSubtitle.textContent = 'ç¼–è¾‘æ–‡ç« å†…å®¹';
        }
      }
    }
    
    /**
     * å¤„ç†å›¾ç‰‡ä¸Šä¼ 
     */
    async function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) {
        return;
      }
      
      // éªŒè¯æ–‡ä»¶ç±»å‹
      if (!file.type.startsWith('image/')) {
        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
        event.target.value = '';
        return;
      }
      
      // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆ10MBï¼‰
      if (file.size > 10 * 1024 * 1024) {
        alert('å›¾ç‰‡æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB');
        event.target.value = '';
        return;
      }
      
      // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
      const progressDiv = document.getElementById('imageUploadProgress');
      const progressBar = document.getElementById('imageUploadProgressBar');
      const statusSpan = document.getElementById('imageUploadStatus');
      
      progressDiv.style.display = 'block';
      progressBar.style.width = '0%';
      statusSpan.textContent = 'ä¸Šä¼ ä¸­...';
      
      try {
        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('image', file);
        
        // å‘é€ä¸Šä¼ è¯·æ±‚
        const response = await fetch('/api/admin/custom-apis/upload-image', {
          method: 'POST',
          body: formData,
          credentials: 'same-origin' // åŒ…å«cookieç”¨äºèº«ä»½éªŒè¯
        });
        
        // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress < 90) {
            progressBar.style.width = progress + '%';
          }
        }, 100);
        
        const result = await response.json();
        clearInterval(progressInterval);
        
        if (!response.ok || !result.success) {
          throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
        }
        
        // ä¸Šä¼ æˆåŠŸ
        progressBar.style.width = '100%';
        statusSpan.textContent = 'ä¸Šä¼ æˆåŠŸï¼';
        
        // è·å–å®Œæ•´URLï¼ˆæ ¹æ®å½“å‰è¯·æ±‚åŸŸåï¼‰
        const imageUrl = result.image.url;
        
        // å¡«å……åˆ°å›¾ç‰‡URLè¾“å…¥æ¡†
        document.getElementById('postImage').value = imageUrl;
        
        // æ›´æ–°é¢„è§ˆ
        updateImagePreview(imageUrl);
        
        // 2ç§’åéšè—è¿›åº¦æ¡
        setTimeout(() => {
          progressDiv.style.display = 'none';
          progressBar.style.width = '0%';
        }, 2000);
        
        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
        event.target.value = '';
        
      } catch (error) {
        console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
        progressBar.style.width = '0%';
        statusSpan.textContent = 'ä¸Šä¼ å¤±è´¥: ' + error.message;
        statusSpan.style.color = '#ef4444';
        
        setTimeout(() => {
          progressDiv.style.display = 'none';
          statusSpan.style.color = '#6b7280';
        }, 3000);
        
        event.target.value = '';
      }
    }
    
    /**
     * æ›´æ–°å›¾ç‰‡é¢„è§ˆ
     */
    function updateImagePreview(imageUrl) {
      const previewDiv = document.getElementById('imagePreview');
      const previewImg = document.getElementById('imagePreviewImg');
      
      if (imageUrl && imageUrl.trim()) {
        previewImg.src = imageUrl;
        previewDiv.style.display = 'block';
      } else {
        previewDiv.style.display = 'none';
      }
    }
    
    /**
     * åŒæ­¥nameå’Œtitleå­—æ®µ
     */
    function syncNameAndTitle() {
      const nameInput = document.getElementById('postName');
      if (nameInput) {
        // nameå’Œtitleä¿æŒä¸€è‡´ï¼Œè¿™é‡Œåªéœ€è¦ç¡®ä¿nameå­—æ®µçš„å€¼æ­£ç¡®å³å¯
        // titleä¼šåœ¨ä¿å­˜æ—¶è‡ªåŠ¨è®¾ç½®ä¸ºä¸nameç›¸åŒ
      }
    }
    
    /**
     * æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯é¢æ¿
     */
    function showDebugInfo(info) {
      // åˆ›å»ºæˆ–è·å–è°ƒè¯•é¢æ¿
      let debugPanel = document.getElementById('debugPanel');
      if (!debugPanel) {
        debugPanel = document.createElement('div');
        debugPanel.id = 'debugPanel';
        debugPanel.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          width: 500px;
          max-height: 80vh;
          background: #1f2937;
          color: #f3f4f6;
          padding: 20px;
          border-radius: 8px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
          z-index: 10000;
          font-family: 'Courier New', monospace;
          font-size: 12px;
          overflow-y: auto;
          display: none;
        `;
        
        const closeBtn = document.createElement('button');
        closeBtn.textContent = 'Ã—';
        closeBtn.style.cssText = `
          position: absolute;
          top: 10px;
          right: 10px;
          background: #ef4444;
          color: white;
          border: none;
          width: 30px;
          height: 30px;
          border-radius: 50%;
          cursor: pointer;
          font-size: 20px;
          line-height: 1;
        `;
        closeBtn.onclick = () => {
          debugPanel.style.display = 'none';
        };
        debugPanel.appendChild(closeBtn);
        
        const title = document.createElement('h3');
        title.textContent = 'è°ƒè¯•ä¿¡æ¯';
        title.style.cssText = 'margin: 0 0 15px 0; color: #60a5fa;';
        debugPanel.appendChild(title);
        
        document.body.appendChild(debugPanel);
      }
      
      // æ¸…ç©ºå†…å®¹ï¼ˆä¿ç•™æ ‡é¢˜å’Œå…³é—­æŒ‰é’®ï¼‰
      const title = debugPanel.querySelector('h3');
      const closeBtn = debugPanel.querySelector('button');
      debugPanel.innerHTML = '';
      debugPanel.appendChild(closeBtn);
      debugPanel.appendChild(title);
      
      // æ·»åŠ è°ƒè¯•ä¿¡æ¯
      const sections = [
        { title: 'è¯·æ±‚æ•°æ®', data: info.request },
        { title: 'å“åº”æ•°æ®', data: info.response },
        { title: 'ç‰¹æ®Šç±»å‹', data: info.specialType },
        { title: 'ç‰¹æ®Šæ•°æ®', data: info.specialData }
      ];
      
      sections.forEach(section => {
        if (section.data) {
          const sectionDiv = document.createElement('div');
          sectionDiv.style.cssText = 'margin-bottom: 15px;';
          
          const sectionTitle = document.createElement('h4');
          sectionTitle.textContent = section.title;
          sectionTitle.style.cssText = 'color: #34d399; margin: 0 0 5px 0; font-size: 14px;';
          sectionDiv.appendChild(sectionTitle);
          
          const pre = document.createElement('pre');
          pre.style.cssText = 'margin: 0; padding: 10px; background: #111827; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word;';
          pre.textContent = JSON.stringify(section.data, null, 2);
          sectionDiv.appendChild(pre);
          
          debugPanel.appendChild(sectionDiv);
        }
      });
      
      // æ˜¾ç¤ºé¢æ¿
      debugPanel.style.display = 'block';
      
      // 5ç§’åè‡ªåŠ¨éšè—ï¼ˆå¯é€‰ï¼‰
      setTimeout(() => {
        if (debugPanel.style.display === 'block') {
          debugPanel.style.display = 'none';
        }
      }, 10000);
    }

    // ==================== åœ°å›¾é€‰ç‚¹åŠŸèƒ½ ====================
    let mapPickerModal = null;
    let mapPickerMap = null;
    let mapPickerMarker = null;
    let mapPickerCurrentType = null; // 'common', 'second-hand', 'rentals'

    // æ‰“å¼€åœ°å›¾é€‰ç‚¹å¼¹çª—
    function openMapPicker(type) {
      mapPickerCurrentType = type;
      
      // åˆ›å»ºæˆ–æ˜¾ç¤ºå¼¹çª—
      if (!mapPickerModal) {
        createMapPickerModal();
      }
      
      mapPickerModal.style.display = 'flex';
      
      // åŠ è½½Leafletåº“ï¼ˆå¦‚æœæœªåŠ è½½ï¼‰
      if (typeof L === 'undefined') {
        loadLeafletLibrary(() => {
          initMapPicker();
        });
      } else {
        initMapPicker();
      }
    }

    // åˆ›å»ºåœ°å›¾é€‰ç‚¹å¼¹çª—
    function createMapPickerModal() {
      mapPickerModal = document.createElement('div');
      mapPickerModal.id = 'mapPickerModal';
      mapPickerModal.style.cssText = `
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      `;

      // å¼¹çª—å¤´éƒ¨
      const header = document.createElement('div');
      header.style.cssText = `
        padding: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      `;
      header.innerHTML = `
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #374151;">åœ°å›¾é€‰ç‚¹</h3>
        <button id="mapPickerCloseBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
      `;

      // æœç´¢æ¡†
      const searchContainer = document.createElement('div');
      searchContainer.style.cssText = `
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
      `;
      searchContainer.innerHTML = `
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" id="mapPickerSearchInput" placeholder="æœç´¢åœ°å€ï¼ˆå¦‚ï¼šå¼€ç½—å¸‚ä¸­å¿ƒã€Cairoï¼‰" 
            style="flex: 1; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem;">
          <button id="mapPickerSearchBtn" class="blog-btn blog-btn-primary" style="white-space: nowrap;">æœç´¢</button>
        </div>
        <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">åœ¨åœ°å›¾ä¸Šç‚¹å‡»é€‰æ‹©ä½ç½®ï¼Œæˆ–æœç´¢åœ°å€åç‚¹å‡»ç»“æœ</p>
      `;

      // åœ°å›¾å®¹å™¨
      const mapContainer = document.createElement('div');
      mapContainer.id = 'mapPickerMap';
      mapContainer.style.cssText = `
        width: 100%;
        height: 500px;
        min-height: 400px;
        background: #f3f4f6;
      `;

      // åº•éƒ¨æŒ‰é’®
      const footer = document.createElement('div');
      footer.style.cssText = `
        padding: 1.5rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
      `;
      footer.innerHTML = `
        <button id="mapPickerCancelBtn" class="blog-btn blog-btn-secondary">å–æ¶ˆ</button>
        <button id="mapPickerConfirmBtn" class="blog-btn blog-btn-primary">ç¡®è®¤é€‰æ‹©</button>
      `;

      modalContent.appendChild(header);
      modalContent.appendChild(searchContainer);
      modalContent.appendChild(mapContainer);
      modalContent.appendChild(footer);
      mapPickerModal.appendChild(modalContent);
      document.body.appendChild(mapPickerModal);

      // ç»‘å®šäº‹ä»¶
      document.getElementById('mapPickerCloseBtn').onclick = closeMapPicker;
      document.getElementById('mapPickerCancelBtn').onclick = closeMapPicker;
      document.getElementById('mapPickerConfirmBtn').onclick = confirmMapPicker;
      document.getElementById('mapPickerSearchBtn').onclick = searchAddress;
      document.getElementById('mapPickerSearchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          searchAddress();
        }
      });

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      mapPickerModal.addEventListener('click', (e) => {
        if (e.target === mapPickerModal) {
          closeMapPicker();
        }
      });
    }

    // åŠ è½½Leafletåº“
    function loadLeafletLibrary(callback) {
      // åŠ è½½CSS
      if (!document.querySelector('link[href*="leaflet"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css';
        link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
        link.crossOrigin = '';
        document.head.appendChild(link);
      }

      // åŠ è½½JS
      if (typeof L === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
        script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
        script.crossOrigin = '';
        script.onload = callback;
        script.onerror = () => {
          showToast('åœ°å›¾åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•', 'error');
        };
        document.head.appendChild(script);
      } else {
        callback();
      }
    }

    // åˆå§‹åŒ–åœ°å›¾
    function initMapPicker() {
      const mapContainer = document.getElementById('mapPickerMap');
      if (!mapContainer || !window.L) return;

      // è·å–å½“å‰ç»çº¬åº¦ï¼ˆå¦‚æœæœ‰ï¼‰
      let currentLat = 30.0444; // å¼€ç½—é»˜è®¤ä½ç½®
      let currentLng = 31.2357;
      
      const addressInput = document.getElementById(getAddressInputId());
      const latInput = document.getElementById(getLatitudeInputId());
      const lngInput = document.getElementById(getLongitudeInputId());
      
      if (latInput && latInput.value) {
        currentLat = parseFloat(latInput.value) || currentLat;
      }
      if (lngInput && lngInput.value) {
        currentLng = parseFloat(lngInput.value) || currentLng;
      }

      // æ¸…é™¤æ—§åœ°å›¾
      if (mapPickerMap) {
        mapPickerMap.remove();
        mapPickerMap = null;
        mapPickerMarker = null;
      }

      // åˆ›å»ºæ–°åœ°å›¾
      mapPickerMap = L.map('mapPickerMap').setView([currentLat, currentLng], latInput && latInput.value ? 15 : 13);

      // æ·»åŠ OpenStreetMapå›¾å±‚
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(mapPickerMap);

      // æ·»åŠ æ ‡è®°ï¼ˆå¦‚æœæœ‰ç°æœ‰å€¼ï¼‰
      if (latInput && latInput.value && lngInput && lngInput.value) {
        mapPickerMarker = L.marker([currentLat, currentLng]).addTo(mapPickerMap);
        mapPickerMarker.bindPopup(`å½“å‰ä½ç½®<br>${addressInput && addressInput.value ? escapeHtml(addressInput.value) : `${currentLat.toFixed(4)}, ${currentLng.toFixed(4)}`}`).openPopup();
        
        // å¦‚æœæœ‰åœ°å€ï¼Œæ˜¾ç¤ºåœ¨æœç´¢æ¡†
        if (addressInput && addressInput.value) {
          document.getElementById('mapPickerSearchInput').value = addressInput.value;
        } else {
          // å¦‚æœæ²¡æœ‰åœ°å€ï¼Œå°è¯•åå‘åœ°ç†ç¼–ç 
          reverseGeocode(currentLat, currentLng);
        }
      }

      // åœ°å›¾ç‚¹å‡»äº‹ä»¶
      mapPickerMap.on('click', (e) => {
        const { lat, lng } = e.latlng;
        updateMapMarker(lat, lng);
      });
    }

    // æ›´æ–°åœ°å›¾æ ‡è®°
    function updateMapMarker(lat, lng) {
      if (!mapPickerMap) return;

      if (mapPickerMarker) {
        mapPickerMarker.setLatLng([lat, lng]);
      } else {
        mapPickerMarker = L.marker([lat, lng]).addTo(mapPickerMap);
      }
      
      mapPickerMap.setView([lat, lng], mapPickerMap.getZoom());
      
      // åå‘åœ°ç†ç¼–ç è·å–åœ°å€
      reverseGeocode(lat, lng);
    }

    // æœç´¢åœ°å€
    async function searchAddress() {
      const searchInput = document.getElementById('mapPickerSearchInput');
      const query = searchInput.value.trim();
      
      if (!query) {
        showToast('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
        return;
      }

      try {
        // ä½¿ç”¨Nominatimè¿›è¡Œåœ°ç†ç¼–ç ï¼ˆå…è´¹ï¼‰
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (!response.ok) {
          throw new Error('æœç´¢å¤±è´¥');
        }

        const results = await response.json();
        
        if (results.length === 0) {
          showToast('æœªæ‰¾åˆ°ç›¸å…³åœ°å€', 'warning');
          return;
        }

        // å¦‚æœåªæœ‰ä¸€ä¸ªç»“æœï¼Œç›´æ¥å®šä½
        if (results.length === 1) {
          const result = results[0];
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          updateMapMarker(lat, lng);
          document.getElementById('mapPickerSearchInput').value = result.display_name;
          showToast('å·²å®šä½åˆ°æœç´¢ç»“æœ', 'success');
        } else {
          // å¤šä¸ªç»“æœï¼Œæ˜¾ç¤ºé€‰æ‹©åˆ—è¡¨
          showSearchResults(results);
        }
      } catch (error) {
        console.error('åœ°å€æœç´¢å¤±è´¥:', error);
        showToast('åœ°å€æœç´¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœåˆ—è¡¨
    function showSearchResults(results) {
      // ç§»é™¤æ—§çš„ç»“æœåˆ—è¡¨
      const oldResults = document.getElementById('mapPickerSearchResults');
      if (oldResults) {
        oldResults.remove();
      }

      const resultsContainer = document.createElement('div');
      resultsContainer.id = 'mapPickerSearchResults';
      resultsContainer.style.cssText = `
        position: absolute;
        top: 80px;
        left: 1.5rem;
        right: 1.5rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        max-height: 300px;
        overflow-y: auto;
        z-index: 10001;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      `;

      results.forEach((result, index) => {
        const item = document.createElement('div');
        item.style.cssText = `
          padding: 0.75rem 1rem;
          border-bottom: 1px solid #f3f4f6;
          cursor: pointer;
          transition: background 0.2s;
        `;
        item.style.cssText += index === results.length - 1 ? 'border-bottom: none;' : '';
        item.innerHTML = `
          <div style="font-weight: 500; color: #374151; margin-bottom: 0.25rem;">${escapeHtml(result.display_name)}</div>
          <div style="font-size: 0.75rem; color: #6b7280;">${result.lat}, ${result.lon}</div>
        `;
        item.onmouseover = () => { item.style.background = '#f9fafb'; };
        item.onmouseout = () => { item.style.background = 'white'; };
        item.onclick = () => {
          const lat = parseFloat(result.lat);
          const lng = parseFloat(result.lon);
          updateMapMarker(lat, lng);
          document.getElementById('mapPickerSearchInput').value = result.display_name;
          resultsContainer.remove();
          showToast('å·²å®šä½åˆ°é€‰æ‹©çš„ä½ç½®', 'success');
        };
        resultsContainer.appendChild(item);
      });

      const modalContent = mapPickerModal.querySelector('div');
      modalContent.style.position = 'relative';
      modalContent.appendChild(resultsContainer);
    }

    // åå‘åœ°ç†ç¼–ç ï¼ˆæ ¹æ®ç»çº¬åº¦è·å–åœ°å€ï¼‰
    async function reverseGeocode(lat, lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          if (result.display_name) {
            document.getElementById('mapPickerSearchInput').value = result.display_name;
          }
        }
      } catch (error) {
        console.error('åå‘åœ°ç†ç¼–ç å¤±è´¥:', error);
        // å¤±è´¥ä¸å½±å“ä½¿ç”¨ï¼Œåªæ˜¯ä¸æ˜¾ç¤ºåœ°å€
      }
    }

    // ç¡®è®¤é€‰æ‹©
    function confirmMapPicker() {
      if (!mapPickerMarker) {
        showToast('è¯·å…ˆåœ¨åœ°å›¾ä¸Šé€‰æ‹©ä½ç½®', 'warning');
        return;
      }

      const latlng = mapPickerMarker.getLatLng();
      const lat = latlng.lat.toFixed(6);
      const lng = latlng.lng.toFixed(6);
      const address = document.getElementById('mapPickerSearchInput').value.trim();

      // æ›´æ–°å¯¹åº”çš„è¾“å…¥æ¡†
      const addressInput = document.getElementById(getAddressInputId());
      const latInput = document.getElementById(getLatitudeInputId());
      const lngInput = document.getElementById(getLongitudeInputId());

      if (addressInput) {
        addressInput.value = address || `${lat}, ${lng}`;
      }
      if (latInput) {
        latInput.value = lat;
      }
      if (lngInput) {
        lngInput.value = lng;
      }

      showToast('ä½ç½®å·²é€‰æ‹©', 'success');
      closeMapPicker();
    }

    // å…³é—­åœ°å›¾é€‰ç‚¹å¼¹çª—
    function closeMapPicker() {
      if (mapPickerModal) {
        mapPickerModal.style.display = 'none';
        // æ¸…é™¤æœç´¢ç»“æœ
        const results = document.getElementById('mapPickerSearchResults');
        if (results) {
          results.remove();
        }
      }
    }

    // è·å–å½“å‰ç±»å‹çš„è¾“å…¥æ¡†ID
    function getAddressInputId() {
      switch (mapPickerCurrentType) {
        case 'second-hand':
          return 'secondHandAddress';
        case 'rentals':
          return 'rentalsAddress';
        case 'common':
        default:
          return 'commonAddress';
      }
    }

    function getLatitudeInputId() {
      switch (mapPickerCurrentType) {
        case 'second-hand':
          return 'secondHandLatitude';
        case 'rentals':
          return 'rentalsLatitude';
        case 'common':
        default:
          return 'commonLatitude';
      }
    }

    function getLongitudeInputId() {
      switch (mapPickerCurrentType) {
        case 'second-hand':
          return 'secondHandLongitude';
        case 'rentals':
          return 'rentalsLongitude';
        case 'common':
        default:
          return 'commonLongitude';
      }
    }

    // ==================== è°·æ­Œåœ°å›¾é“¾æ¥è§£æåŠŸèƒ½ ====================
    let linkParserModal = null;
    let linkParserCurrentType = null;

    // æ‰“å¼€é“¾æ¥è§£æå¼¹çª—
    function openLinkParser(type) {
      linkParserCurrentType = type;
      
      // åˆ›å»ºæˆ–æ˜¾ç¤ºå¼¹çª—
      if (!linkParserModal) {
        createLinkParserModal();
      }
      
      linkParserModal.style.display = 'flex';
      const input = document.getElementById('linkParserInput');
      if (input) {
        input.value = '';
        input.focus();
      }
    }

    // åˆ›å»ºé“¾æ¥è§£æå¼¹çª—
    function createLinkParserModal() {
      linkParserModal = document.createElement('div');
      linkParserModal.id = 'linkParserModal';
      linkParserModal.style.cssText = `
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 0.75rem;
        width: 90%;
        max-width: 600px;
        padding: 2rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      `;

      // å¼¹çª—å¤´éƒ¨
      const header = document.createElement('div');
      header.style.cssText = `
        margin-bottom: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      `;
      header.innerHTML = `
        <h3 style="margin: 0; font-size: 1.25rem; font-weight: 600; color: #374151;">è§£æè°·æ­Œåœ°å›¾é“¾æ¥</h3>
        <button id="linkParserCloseBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
      `;

      // è¾“å…¥æ¡†
      const inputContainer = document.createElement('div');
      inputContainer.style.cssText = `margin-bottom: 1rem;`;
      inputContainer.innerHTML = `
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #374151;">ç²˜è´´è°·æ­Œåœ°å›¾é“¾æ¥ï¼š</label>
        <input type="text" id="linkParserInput" placeholder="ä¾‹å¦‚ï¼šhttps://www.google.com/maps?q=30.0444,31.2357 æˆ– https://maps.google.com/?q=å¼€ç½—" 
          style="width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; box-sizing: border-box;">
        <p style="margin: 0.5rem 0 0 0; font-size: 0.75rem; color: #6b7280;">
          æ”¯æŒæ ¼å¼ï¼š<br>
          â€¢ https://www.google.com/maps?q=30.0444,31.2357<br>
          â€¢ https://maps.google.com/?q=åœ°å€åç§°<br>
          â€¢ https://www.google.com/maps/@30.0444,31.2357,15z<br>
          â€¢ https://www.google.com/maps/place/.../@30.0444,31.2357,15z<br>
          â€¢ https://maps.app.goo.gl/...ï¼ˆçŸ­é“¾æ¥ï¼‰<br>
          â€¢ https://goo.gl/maps/...ï¼ˆçŸ­é“¾æ¥ï¼‰
        </p>
      `;

      // åº•éƒ¨æŒ‰é’®
      const footer = document.createElement('div');
      footer.style.cssText = `
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        margin-top: 1.5rem;
      `;
      footer.innerHTML = `
        <button id="linkParserCancelBtn" class="blog-btn blog-btn-secondary">å–æ¶ˆ</button>
        <button id="linkParserParseBtn" class="blog-btn blog-btn-primary">è§£æå¹¶å¡«å……</button>
      `;

      modalContent.appendChild(header);
      modalContent.appendChild(inputContainer);
      modalContent.appendChild(footer);
      linkParserModal.appendChild(modalContent);
      document.body.appendChild(linkParserModal);

      // ç»‘å®šäº‹ä»¶
      document.getElementById('linkParserCloseBtn').onclick = closeLinkParser;
      document.getElementById('linkParserCancelBtn').onclick = closeLinkParser;
      document.getElementById('linkParserParseBtn').onclick = parseGoogleMapsLink;
      document.getElementById('linkParserInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          parseGoogleMapsLink();
        }
      });

      // ç‚¹å‡»èƒŒæ™¯å…³é—­
      linkParserModal.addEventListener('click', (e) => {
        if (e.target === linkParserModal) {
          closeLinkParser();
        }
      });
    }

    // è§£æè°·æ­Œåœ°å›¾é“¾æ¥
    async function parseGoogleMapsLink() {
      const input = document.getElementById('linkParserInput');
      const link = input.value.trim();
      
      if (!link) {
        showToast('è¯·è¾“å…¥è°·æ­Œåœ°å›¾é“¾æ¥', 'warning');
        return;
      }

      try {
        // æ£€æŸ¥æ˜¯å¦æ˜¯çŸ­é“¾æ¥ï¼ˆgoo.gl æˆ– maps.app.goo.glï¼‰
        const isShortLink = /^(https?:\/\/)?(maps\.app\.)?goo\.gl\/.+$/i.test(link) || 
                            /^(https?:\/\/)?maps\.app\.goo\.gl\/.+$/i.test(link);

        let lat = null;
        let lng = null;
        let address = null;

        // å¦‚æœæ˜¯çŸ­é“¾æ¥ï¼Œä½¿ç”¨åç«¯APIè§£æ
        if (isShortLink) {
          try {
            // ä½¿ç”¨adminApiRequestå‡½æ•°ç¡®ä¿æ­£ç¡®çš„è®¤è¯å’Œé”™è¯¯å¤„ç†
            const result = await adminApiRequest('/api/admin/parse-google-maps-link', {
              method: 'POST',
              body: JSON.stringify({ link: link })
            });
            
            if (!result) {
              // adminApiRequestè¿”å›nullè¡¨ç¤ºéœ€è¦ç™»å½•
              return;
            }
            
            if (result.success && result.data) {
              lat = result.data.lat;
              lng = result.data.lng;
              address = result.data.address;
              
              // å¦‚æœåç«¯è¿”å›äº†ç»çº¬åº¦
              if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
                // å¦‚æœæ²¡æœ‰åœ°å€ï¼Œå°è¯•åå‘åœ°ç†ç¼–ç 
                if (!address) {
                  try {
                    const addressResult = await reverseGeocodeFromLink(lat, lng);
                    if (addressResult) {
                      address = addressResult;
                    }
                  } catch (error) {
                    console.warn('åå‘åœ°ç†ç¼–ç å¤±è´¥ï¼Œå°†åªå¡«å……ç»çº¬åº¦:', error);
                  }
                }
                
                fillLocationFields(lat, lng, address);
                showToast('ä½ç½®ä¿¡æ¯å·²å¡«å……', 'success');
                closeLinkParser();
                return;
              }
              
              // å¦‚æœåªæœ‰åœ°å€åç§°ï¼Œè¿›è¡Œåœ°ç†ç¼–ç 
              if (address && (lat === null || lng === null)) {
                try {
                  const geocodeResult = await geocodeAddress(address);
                  if (geocodeResult && geocodeResult.lat && geocodeResult.lng) {
                    fillLocationFields(geocodeResult.lat, geocodeResult.lng, geocodeResult.address || address);
                    showToast('ä½ç½®ä¿¡æ¯å·²å¡«å……', 'success');
                    closeLinkParser();
                    return;
                  }
                } catch (error) {
                  console.error('åœ°ç†ç¼–ç å¤±è´¥:', error);
                }
              }
            } else {
              showToast(result.message || 'æ— æ³•è§£æè¯¥çŸ­é“¾æ¥', 'error');
              return;
            }
          } catch (error) {
            console.error('åç«¯è§£æçŸ­é“¾æ¥å¤±è´¥:', error);
            showToast('çŸ­é“¾æ¥è§£æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
            return;
          }
        } else {
          // é•¿é“¾æ¥ï¼Œä½¿ç”¨å‰ç«¯è§£æ
          // è§£æå„ç§è°·æ­Œåœ°å›¾é“¾æ¥æ ¼å¼
          // æ ¼å¼1: https://www.google.com/maps?q=30.0444,31.2357
          // æ ¼å¼2: https://maps.google.com/?q=30.0444,31.2357
          let match = link.match(/[?&]q=([^&]+)/);
          if (match) {
            const qValue = decodeURIComponent(match[1]);
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç»çº¬åº¦æ ¼å¼ (lat,lng)
            const coordsMatch = qValue.match(/^(-?\d+\.?\d*),(-?\d+\.?\d*)$/);
            if (coordsMatch) {
              lat = parseFloat(coordsMatch[1]);
              lng = parseFloat(coordsMatch[2]);
            } else {
              // å¦åˆ™æ˜¯åœ°å€åç§°ï¼Œéœ€è¦åœ°ç†ç¼–ç 
              address = qValue;
            }
          }

          // æ ¼å¼3: https://www.google.com/maps/@30.0444,31.2357,15z
          // æ ¼å¼4: https://www.google.com/maps/place/.../@30.0444,31.2357,15z
          if (lat === null || lng === null) {
            match = link.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
          }

          // æ ¼å¼5: ç›´æ¥åŒ…å«ç»çº¬åº¦çš„URLå‚æ•°
          if (lat === null || lng === null) {
            match = link.match(/[?&]ll=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
          }

          // æ ¼å¼6: placeé“¾æ¥ï¼Œå°è¯•ä»URLä¸­æå–
          if (lat === null || lng === null) {
            match = link.match(/place\/[^/]+\/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
            if (match) {
              lat = parseFloat(match[1]);
              lng = parseFloat(match[2]);
            }
          }

          // å¦‚æœæ‰¾åˆ°äº†ç»çº¬åº¦
          if (lat !== null && lng !== null && !isNaN(lat) && !isNaN(lng)) {
            // éªŒè¯ç»çº¬åº¦èŒƒå›´
            if (lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
              // ä½¿ç”¨åå‘åœ°ç†ç¼–ç è·å–åœ°å€
              try {
                const addressResult = await reverseGeocodeFromLink(lat, lng);
                if (addressResult) {
                  address = addressResult;
                }
              } catch (error) {
                console.warn('åå‘åœ°ç†ç¼–ç å¤±è´¥ï¼Œå°†åªå¡«å……ç»çº¬åº¦:', error);
              }
              
              // å¡«å……å­—æ®µ
              fillLocationFields(lat, lng, address);
              showToast('ä½ç½®ä¿¡æ¯å·²å¡«å……', 'success');
              closeLinkParser();
              return;
            }
          }

          // å¦‚æœåªæœ‰åœ°å€åç§°ï¼Œè¿›è¡Œåœ°ç†ç¼–ç 
          if (address) {
            try {
              const result = await geocodeAddress(address);
              if (result && result.lat && result.lng) {
                fillLocationFields(result.lat, result.lng, result.address || address);
                showToast('ä½ç½®ä¿¡æ¯å·²å¡«å……', 'success');
                closeLinkParser();
                return;
              }
            } catch (error) {
              console.error('åœ°ç†ç¼–ç å¤±è´¥:', error);
              showToast('æ— æ³•è§£æè¯¥é“¾æ¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ ¼å¼', 'error');
              return;
            }
          }

          // å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°
          showToast('æ— æ³•ä»é“¾æ¥ä¸­æå–ä½ç½®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ ¼å¼', 'error');
        }
      } catch (error) {
        console.error('è§£æé“¾æ¥å¤±è´¥:', error);
        showToast('è§£æå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
      }
    }

    // åå‘åœ°ç†ç¼–ç ï¼ˆä»ç»çº¬åº¦è·å–åœ°å€ï¼‰
    async function reverseGeocodeFromLink(lat, lng) {
      try {
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (response.ok) {
          const result = await response.json();
          return result.display_name || null;
        }
      } catch (error) {
        console.error('åå‘åœ°ç†ç¼–ç å¤±è´¥:', error);
      }
      return null;
    }

    // åœ°ç†ç¼–ç ï¼ˆä»åœ°å€è·å–ç»çº¬åº¦ï¼‰
    async function geocodeAddress(address) {
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&accept-language=zh,ar,en`;
        
        const response = await fetch(url, {
          headers: {
            'User-Agent': 'BODA Blog Admin'
          }
        });
        
        if (response.ok) {
          const results = await response.json();
          if (results.length > 0) {
            const result = results[0];
            return {
              lat: parseFloat(result.lat),
              lng: parseFloat(result.lon),
              address: result.display_name
            };
          }
        }
      } catch (error) {
        console.error('åœ°ç†ç¼–ç å¤±è´¥:', error);
      }
      return null;
    }

    // å¡«å……ä½ç½®å­—æ®µ
    function fillLocationFields(lat, lng, address) {
      const addressInput = document.getElementById(getAddressInputIdForParser());
      const latInput = document.getElementById(getLatitudeInputIdForParser());
      const lngInput = document.getElementById(getLongitudeInputIdForParser());

      if (addressInput) {
        addressInput.value = address || `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
      if (latInput) {
        latInput.value = lat.toFixed(6);
      }
      if (lngInput) {
        lngInput.value = lng.toFixed(6);
      }
    }

    // è·å–å½“å‰ç±»å‹çš„è¾“å…¥æ¡†IDï¼ˆç”¨äºé“¾æ¥è§£æï¼‰
    function getAddressInputIdForParser() {
      switch (linkParserCurrentType) {
        case 'second-hand':
          return 'secondHandAddress';
        case 'rentals':
          return 'rentalsAddress';
        case 'common':
        default:
          return 'commonAddress';
      }
    }

    function getLatitudeInputIdForParser() {
      switch (linkParserCurrentType) {
        case 'second-hand':
          return 'secondHandLatitude';
        case 'rentals':
          return 'rentalsLatitude';
        case 'common':
        default:
          return 'commonLatitude';
      }
    }

    function getLongitudeInputIdForParser() {
      switch (linkParserCurrentType) {
        case 'second-hand':
          return 'secondHandLongitude';
        case 'rentals':
          return 'rentalsLongitude';
        case 'common':
        default:
          return 'commonLongitude';
      }
    }

    // å…³é—­é“¾æ¥è§£æå¼¹çª—
    function closeLinkParser() {
      if (linkParserModal) {
        linkParserModal.style.display = 'none';
        const input = document.getElementById('linkParserInput');
        if (input) {
          input.value = '';
        }
      }
    }
  </script>
</body>
</html>
