<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ–‡ç« è¯¦æƒ… - DevBlog</title>
  <link rel="stylesheet" href="/css/blog.css">
  <style>
    /* é˜…è¯»è¿›åº¦æ¡ */
    .reading-progress {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(to right, #d97706, #f59e0b);
      z-index: 100;
      transition: width 0.1s ease;
    }
    
    /* è”ç³»æ–¹å¼å’Œä½ç½®ä¿¡æ¯å¡ç‰‡ */
    .blog-contact-location-card {
      max-width: 48rem;
      margin: 0 auto 2rem;
    }
    
    /* Leafletåœ°å›¾æ ·å¼è¦†ç›– */
    .blog-contact-location-card .leaflet-container {
      font-family: inherit;
    }
    
    /* ç¡®ä¿æ–‡ç« å†…å®¹ä¸­çš„æ‰€æœ‰å›¾ç‰‡å’Œè§†é¢‘è‡ªé€‚åº”å±å¹•å¤§å° */
    .blog-detail-content img,
    .blog-detail-content video,
    .blog-detail-content iframe,
    .blog-detail-content embed,
    .blog-detail-content object {
      max-width: 100% !important;
      height: auto !important;
      display: block;
      margin: 1rem auto;
    }
    
    /* è§†é¢‘æ ‡ç­¾ç‰¹æ®Šå¤„ç† */
    .blog-detail-content video {
      width: 100%;
      max-width: 100%;
    }
    
    /* iframe è§†é¢‘ï¼ˆå¦‚ YouTube, Bilibili ç­‰ï¼‰ */
    .blog-detail-content iframe {
      max-width: 100%;
      aspect-ratio: 16 / 9;
      width: 100%;
      height: auto;
      min-height: 300px;
    }
    
    /* ç¡®ä¿æ–‡ç« å†…å®¹åŒºåŸŸä¸ä¼šæº¢å‡º */
    .blog-detail-content {
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    
    /* å¤„ç†è¡¨æ ¼æº¢å‡º */
    .blog-detail-content table {
      max-width: 100%;
      overflow-x: auto;
      display: block;
    }
    
    /* å°çº¢ä¹¦å¼è½®æ’­å›¾å®¹å™¨ */
    .blog-carousel-container {
      width: 100%;
      max-width: 100%;
      margin: 0 auto 1.5rem;
      position: relative;
      background: #000;
    }
    .blog-carousel-wrapper {
      position: relative;
      width: 100%;
      overflow: hidden;
      aspect-ratio: 1 / 1;
      max-height: 80vh;
    }
    .blog-carousel-track {
      display: flex;
      transition: transform 0.3s ease;
      height: 100%;
    }
    .blog-carousel-item {
      min-width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: #000;
    }
    .blog-carousel-item img,
    .blog-carousel-item video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
      background: #000;
    }
    /* è½®æ’­å›¾åˆ‡æ¢æŒ‰é’® */
    .blog-carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    .blog-carousel-btn:hover {
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    .blog-carousel-btn-prev { left: 12px; }
    .blog-carousel-btn-next { right: 12px; }
    .blog-carousel-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    /* è½®æ’­å›¾æŒ‡ç¤ºå™¨ */
    .blog-carousel-indicators {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 10;
    }
    .blog-carousel-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0;
    }
    .blog-carousel-indicator.active {
      background: rgba(255, 255, 255, 1);
      width: 24px;
      border-radius: 4px;
    }
    /* çº¯æ–‡å­—å†…å®¹åŒºåŸŸï¼šéšè—å›¾ç‰‡/è§†é¢‘ */
    .blog-detail-content img,
    .blog-detail-content video {
      display: none !important;
    }
    /* æ–‡ç« ä¸»å›¾ç‰‡å…¼å®¹æ ·å¼ï¼ˆå·²ç”¨äºè½®æ’­å†…ï¼‰ */
    .blog-detail-image img {
      max-width: 100%;
      height: auto;
      object-fit: contain;
    }
    
    /* ç‰¹æ®Šå†…å®¹ç±»å‹çš„å“åº”å¼æ ·å¼ */
    @media (max-width: 768px) {
      /* æ±‡ç‡å¡ç‰‡åœ¨ç§»åŠ¨ç«¯å•åˆ—æ˜¾ç¤º */
      .exchange-rate-display {
        padding: 0.5rem !important;
      }
      .exchange-rate-display > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      
      /* ç¿»è¯‘å¡ç‰‡åœ¨ç§»åŠ¨ç«¯ä¼˜åŒ– */
      .translation-display {
        padding: 0.5rem !important;
      }
      .translation-display > div[style*="padding: 2.5rem"] {
        padding: 1.5rem !important;
      }
      
      /* å¤©æ°”å¡ç‰‡åœ¨ç§»åŠ¨ç«¯å•åˆ—æ˜¾ç¤º */
      .weather-display {
        padding: 0.5rem !important;
      }
      .weather-display > div[style*="grid-template-columns"] {
        grid-template-columns: 1fr !important;
      }
      
      /* æ™¯ç‚¹å¤©æ°”ä¿¡æ¯åœ¨ç§»åŠ¨ç«¯å•åˆ—æ˜¾ç¤º */
      .weather-display div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
</head>
<body class="blog-detail-page">
  <!-- é˜…è¯»è¿›åº¦æ¡ -->
  <div class="reading-progress" id="readingProgress"></div>

  <!-- å¯¼èˆªæ  -->
  <nav class="blog-detail-nav">
    <a href="/blog.html" class="blog-detail-back">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      è¿”å›é¦–é¡µ
    </a>
  </nav>

  <!-- æ–‡ç« å†…å®¹ -->
  <article class="blog-detail-article">
    <header class="blog-detail-header">
      <div class="blog-detail-meta" id="articleMeta">
        <span id="articleDate"></span>
        <span>â€¢</span>
        <span id="articleViews">0 é˜…è¯»</span>
        <span>â€¢</span>
        <span id="readingTime">çº¦ 0 åˆ†é’Ÿé˜…è¯»</span>
      </div>
      <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;">
        <h1 class="blog-detail-title" id="articleTitle" style="flex: 1;">åŠ è½½ä¸­...</h1>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <button id="articleNewPostBtn" class="blog-detail-edit-btn" onclick="newPost()" title="æ–°å»ºæ–‡ç« " style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"></path>
            </svg>
            <span>æ–°å»º</span>
          </button>
          <button id="articleEditBtn" class="blog-detail-edit-btn" onclick="editPost()" title="ç¼–è¾‘æ–‡ç« " style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <span>ç¼–è¾‘</span>
          </button>
          <button id="articleDeleteBtn" class="blog-detail-edit-btn" onclick="deletePost()" title="åˆ é™¤æ–‡ç« " style="display: none; background-color: rgba(239,68,68,0.1); border-color: rgba(239,68,68,0.3); color: #ef4444;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            <span>åˆ é™¤</span>
          </button>
        </div>
      </div>
      <div id="shareButtons"></div>
    </header>

    <!-- å°çº¢ä¹¦å¼è½®æ’­å›¾/è§†é¢‘åŒºåŸŸ -->
    <div class="blog-carousel-container" id="articleCarousel" style="display: none;">
      <div class="blog-carousel-wrapper">
        <div class="blog-carousel-track" id="carouselTrack"></div>
        <!-- å·¦å³åˆ‡æ¢æŒ‰é’® -->
        <button class="blog-carousel-btn blog-carousel-btn-prev" id="carouselPrevBtn" onclick="carouselPrev()" aria-label="ä¸Šä¸€å¼ " style="display: none;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <button class="blog-carousel-btn blog-carousel-btn-next" id="carouselNextBtn" onclick="carouselNext()" aria-label="ä¸‹ä¸€å¼ " style="display: none;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
        <!-- æŒ‡ç¤ºå™¨ -->
        <div class="blog-carousel-indicators" id="carouselIndicators"></div>
      </div>
    </div>

    <!-- çº¯æ–‡å­—å†…å®¹åŒºåŸŸ -->
    <div class="blog-detail-content" id="articleContent">
      <div class="blog-loading">åŠ è½½ä¸­...</div>
    </div>

    <!-- è”ç³»æ–¹å¼å’Œä½ç½®ä¿¡æ¯ -->
    <div id="articleContactLocation" style="display: none;"></div>

    <div class="blog-detail-tags" id="articleTags" style="display: none;"></div>
  </article>

  <!-- è¯„è®ºåŒºåŸŸ -->
  <section class="blog-comments-section">
    <h2 class="blog-comments-title">è¯„è®º</h2>
    
    <!-- è¯„è®ºè¡¨å• -->
    <form class="blog-comment-form" id="commentForm" onsubmit="submitComment(event)">
      <div class="blog-comment-form-group">
        <label class="blog-comment-form-label" for="commentAuthorName">å§“å *</label>
        <input 
          type="text" 
          id="commentAuthorName" 
          class="blog-comment-form-input" 
          required
          placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å"
        >
      </div>
      <div class="blog-comment-form-group">
        <label class="blog-comment-form-label" for="commentAuthorEmail">é‚®ç®± *</label>
        <input 
          type="email" 
          id="commentAuthorEmail" 
          class="blog-comment-form-input" 
          required
          placeholder="è¯·è¾“å…¥æ‚¨çš„é‚®ç®±"
        >
      </div>
      <div class="blog-comment-form-group">
        <label class="blog-comment-form-label" for="commentContent">è¯„è®ºå†…å®¹ *</label>
        <textarea 
          id="commentContent" 
          class="blog-comment-form-textarea" 
          required
          placeholder="è¯·è¾“å…¥æ‚¨çš„è¯„è®º"
        ></textarea>
      </div>
      <button type="submit" class="blog-btn blog-btn-primary">æäº¤è¯„è®º</button>
    </form>

    <!-- è¯„è®ºåˆ—è¡¨ -->
    <div class="blog-comment-list" id="commentsList">
      <div class="blog-loading">åŠ è½½ä¸­...</div>
    </div>

    <!-- è¯„è®ºåˆ†é¡µ -->
    <div class="blog-pagination" id="commentsPagination"></div>
  </section>

  <!-- è„šæœ¬ -->
  <script src="/utils/blog.js"></script>
  <script src="/utils/markdown.js"></script>
  <script>
    // éªŒè¯å¹¶ä¿®å¤å›¾ç‰‡URL
    function validateImageUrl(url) {
      if (!url) return '';
      
      // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥è¿”å›
      if (url.startsWith('/') || url.startsWith('./')) {
        return url;
      }
      
      // å¦‚æœæ˜¯http/httpsï¼Œè¿”å›
      if (url.startsWith('http://') || url.startsWith('https://')) {
        return url;
      }
      
      // å¦‚æœæ˜¯data URIï¼Œè¿”å›
      if (url.startsWith('data:')) {
        return url;
      }
      
      // é»˜è®¤æ·»åŠ /uploadså‰ç¼€
      return '/uploads/' + url;
    }
    let currentPost = null;
    let currentPostId = null;
    let commentsPage = 1;
    const commentsPageSize = 10;
    let isAdminLoggedIn = false; // ç®¡ç†å‘˜ç™»å½•çŠ¶æ€

    // å½“å‰ç”¨æˆ·ä¿¡æ¯
    let currentUser = null;

    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    async function checkUserAuth() {
      try {
        const response = await fetch('/api/auth/user/me', {
          credentials: 'include',
          method: 'GET'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data && data.success && data.user) {
            currentUser = data.user;
            return true;
          }
        }
        currentUser = null;
        return false;
      } catch (error) {
        console.error('æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        currentUser = null;
        return false;
      }
    }

    // æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€
    async function checkAdminAuth() {
      try {
        const response = await fetch('/api/auth/admin/me', {
          credentials: 'include',
          method: 'GET'
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data && data.success && data.admin) {
            isAdminLoggedIn = true;
            return true;
          }
        }
        isAdminLoggedIn = false;
        return false;
      } catch (error) {
        console.error('æ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€å¤±è´¥:', error);
        isAdminLoggedIn = false;
        return false;
      }
    }

    // ç¼–è¾‘æ–‡ç« ï¼ˆåœ¨æ–°çª—å£æ‰“å¼€ï¼‰
    function editPost() {
      if (!currentPostId) {
        showToast('æ— æ³•è·å–æ–‡ç« ID', 'error');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜ç™»å½•ï¼Œæˆ–è€…ç”¨æˆ·æ˜¯å¦æœ‰ç¼–è¾‘æƒé™
      // æ³¨æ„ï¼šè¿™é‡Œåªæ£€æŸ¥ç®¡ç†å‘˜ç™»å½•çŠ¶æ€ï¼Œæ™®é€šç”¨æˆ·çš„canEditæƒé™åœ¨æ˜¾ç¤ºæŒ‰é’®æ—¶å·²ç»åˆ¤æ–­
      // å¦‚æœæ™®é€šç”¨æˆ·ç‚¹å‡»ç¼–è¾‘æŒ‰é’®ï¼Œè¯´æ˜è¯¥æ–‡ç« æœ‰canEditæƒé™ï¼Œå…è®¸ç¼–è¾‘
      if (!isAdminLoggedIn && !currentUser) {
        // å¦‚æœæœªç™»å½•ï¼Œè·³è½¬åˆ°ç®¡ç†ç•Œé¢ç™»å½•
        window.location.href = '/blog-admin.html';
        return;
      }
      
      // åœ¨æ–°çª—å£æ‰“å¼€ç¼–è¾‘é¡µé¢
      const editUrl = `/blog-admin.html?edit=${encodeURIComponent(currentPostId)}`;
      const editWindow = window.open(editUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!editWindow) {
        showToast('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
        return;
      }
      
      // ç›‘å¬æ–°çª—å£å…³é—­äº‹ä»¶ï¼Œé‡æ–°åŠ è½½æ–‡ç« è¯¦æƒ…
      const checkClosed = setInterval(() => {
        if (editWindow.closed) {
          clearInterval(checkClosed);
          // é‡æ–°åŠ è½½æ–‡ç« è¯¦æƒ…
          loadPost();
        }
      }, 500);
    }

    // æ–°å»ºæ–‡ç« ï¼ˆåœ¨æ–°çª—å£æ‰“å¼€ï¼‰
    function newPost() {
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
      if (!currentUser) {
        showToast('è¯·å…ˆç™»å½•', 'error');
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ç™»å½•é€»è¾‘
        return;
      }
      
      // åœ¨æ–°çª—å£æ‰“å¼€æ–°å»ºæ–‡ç« é¡µé¢
      const newUrl = `/blog-admin.html?action=new`;
      const newWindow = window.open(newUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      
      if (!newWindow) {
        showToast('æ— æ³•æ‰“å¼€æ–°çª—å£ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨å¼¹çª—è®¾ç½®', 'error');
        return;
      }
      
      // ç›‘å¬æ–°çª—å£å…³é—­äº‹ä»¶ï¼Œé‡æ–°åŠ è½½æ–‡ç« è¯¦æƒ…ï¼ˆå¦‚æœåˆ›å»ºäº†æ–°æ–‡ç« ï¼Œå¯èƒ½éœ€è¦åˆ·æ–°ï¼‰
      const checkClosed = setInterval(() => {
        if (newWindow.closed) {
          clearInterval(checkClosed);
          // å¯ä»¥é€‰æ‹©åˆ·æ–°é¡µé¢æˆ–ä¿æŒå½“å‰çŠ¶æ€
        }
      }, 500);
    }

    // åˆ é™¤æ–‡ç« ï¼ˆä½¿ç”¨å°ç¨‹åºAPIï¼‰
    async function deletePost() {
      if (!currentPostId) {
        showToast('æ— æ³•è·å–æ–‡ç« ID', 'error');
        return;
      }
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜ç™»å½•ï¼Œæˆ–è€…ç”¨æˆ·æ˜¯å¦æœ‰ç¼–è¾‘æƒé™
      if (!isAdminLoggedIn && !currentUser) {
        showToast('è¯·å…ˆç™»å½•', 'error');
        return;
      }
      
      // ç¡®è®¤åˆ é™¤
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/blog-admin/posts/${currentPostId}`, {
          method: 'DELETE',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showToast('æ–‡ç« åˆ é™¤æˆåŠŸ', 'success');
          // è·³è½¬å›åšå®¢é¦–é¡µ
          setTimeout(() => {
            window.location.href = '/blog.html';
          }, 1000);
        } else {
          showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('åˆ é™¤æ–‡ç« å¤±è´¥:', error);
        showToast('åˆ é™¤å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      }
    }

    // è·å–URLå‚æ•°
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // åŠ è½½æ–‡ç« è¯¦æƒ…ï¼ˆä½¿ç”¨å°ç¨‹åºAPIï¼‰
    async function loadPost() {
      const slug = getUrlParam('slug');
      if (!slug) {
        document.getElementById('articleContent').innerHTML = '<div class="blog-empty">æ–‡ç« ä¸å­˜åœ¨</div>';
        return;
      }
      
      // æ£€æŸ¥ç®¡ç†å‘˜å’Œç”¨æˆ·ç™»å½•çŠ¶æ€
      await Promise.all([checkAdminAuth(), checkUserAuth()]);

      try {
        // å…ˆé€šè¿‡slugè·å–æ–‡ç« IDï¼ˆä½¿ç”¨å…¬å¼€APIï¼‰
        const publicResponse = await getPost(slug);
        if (!publicResponse.success || !publicResponse.data) {
          document.getElementById('articleContent').innerHTML = '<div class="blog-empty">æ–‡ç« ä¸å­˜åœ¨</div>';
          return;
        }
        
        const postId = publicResponse.data.id;
        currentPostId = postId;
        
        // ä½¿ç”¨å°ç¨‹åºAPIè·å–å®Œæ•´æ–‡ç« è¯¦æƒ…ï¼ˆæ”¯æŒç¼–è¾‘æƒé™æ£€æŸ¥ï¼‰
        const response = await fetch(`/api/blog-admin/posts/${postId}`, {
          method: 'GET',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success && data.data) {
          currentPost = data.data;
          displayPost(data.data);
          loadComments(1);
        } else {
          // å¦‚æœå°ç¨‹åºAPIå¤±è´¥ï¼Œä½¿ç”¨å…¬å¼€APIçš„æ•°æ®
          currentPost = publicResponse.data;
          displayPost(publicResponse.data);
          loadComments(1);
        }
      } catch (error) {
        console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
        document.getElementById('articleContent').innerHTML = '<div class="blog-empty">åŠ è½½å¤±è´¥: ' + escapeHtml(error.message) + '</div>';
      }
    }

    // è½®æ’­å›¾æ•°æ®
    let carouselItems = [];
    let carouselIndex = 0;
    const carouselTrackEl = document.getElementById('carouselTrack');
    const carouselPrevBtn = document.getElementById('carouselPrevBtn');
    const carouselNextBtn = document.getElementById('carouselNextBtn');
    const carouselIndicatorsEl = document.getElementById('carouselIndicators');

    function extractCarouselItems(post) {
      const items = [];
      // ä¸»å›¾
      if (post.image) {
        items.push({ type: 'image', src: validateImageUrl(post.image) });
      }
      // ä» htmlContent ä¸­æå–å›¾ç‰‡å’Œè§†é¢‘
      if (post.htmlContent) {
        const temp = document.createElement('div');
        temp.innerHTML = post.htmlContent;
        temp.querySelectorAll('img').forEach(img => {
          const src = img.getAttribute('src');
          if (src) items.push({ type: 'image', src: validateImageUrl(src) });
        });
        temp.querySelectorAll('video').forEach(video => {
          let src = video.getAttribute('src');
          if (!src) {
            const source = video.querySelector('source');
            if (source) src = source.getAttribute('src');
          }
          if (src) items.push({ type: 'video', src: validateImageUrl(src) });
        });
      }
      // å»é‡
      const seen = new Set();
      return items.filter(item => {
        if (!item.src) return false;
        if (seen.has(item.src)) return false;
        seen.add(item.src);
        return true;
      });
    }

    function renderCarousel() {
      const container = document.getElementById('articleCarousel');
      if (!container) return;
      if (!carouselItems.length) {
        container.style.display = 'none';
        return;
      }
      container.style.display = 'block';
      // è½¨é“
      carouselTrackEl.innerHTML = '';
      carouselItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'blog-carousel-item';
        if (item.type === 'video') {
          div.innerHTML = `<video src="${escapeHtml(item.src)}" controls preload="metadata"></video>`;
        } else {
          div.innerHTML = `<img src="${escapeHtml(item.src)}" alt="">`;
        }
        carouselTrackEl.appendChild(div);
      });
      // æŒ‡ç¤ºå™¨
      carouselIndicatorsEl.innerHTML = '';
      carouselItems.forEach((_, idx) => {
        const btn = document.createElement('button');
        btn.className = 'blog-carousel-indicator' + (idx === carouselIndex ? ' active' : '');
        btn.onclick = () => { carouselIndex = idx; updateCarouselPosition(); };
        carouselIndicatorsEl.appendChild(btn);
      });
      // æŒ‰é’®å¯è§æ€§
      if (carouselItems.length > 1) {
        carouselPrevBtn.style.display = 'flex';
        carouselNextBtn.style.display = 'flex';
      } else {
        carouselPrevBtn.style.display = 'none';
        carouselNextBtn.style.display = 'none';
      }
      updateCarouselPosition();
    }

    function updateCarouselPosition() {
      if (!carouselItems.length) return;
      if (carouselIndex < 0) carouselIndex = carouselItems.length - 1;
      if (carouselIndex >= carouselItems.length) carouselIndex = 0;
      const offset = -carouselIndex * 100;
      carouselTrackEl.style.transform = `translateX(${offset}%)`;
      // æ›´æ–°æŒ‡ç¤ºå™¨
      const indicators = carouselIndicatorsEl.querySelectorAll('.blog-carousel-indicator');
      indicators.forEach((ind, idx) => {
        if (idx === carouselIndex) ind.classList.add('active'); else ind.classList.remove('active');
      });
    }
    function carouselPrev() { carouselIndex--; updateCarouselPosition(); }
    function carouselNext() { carouselIndex++; updateCarouselPosition(); }

    // æ˜¾ç¤ºæ–‡ç« 
    async function displayPost(post) {
      // æ ‡é¢˜
      document.getElementById('articleTitle').textContent = post.name || post.title || 'æœªå‘½å';
      document.title = (post.name || post.title || 'æœªå‘½å') + ' - DevBlog';

      // Metaä¿¡æ¯
      const date = formatDate(post.createdAt || post.created_at);
      const views = post.views || 0;
      const contentLength = (post.htmlContent || '').length;
      const readingTime = Math.ceil(contentLength / 500);
      
      // æ„å»ºMetaä¿¡æ¯HTMLï¼ŒåŒ…å«æ˜µç§°å’Œæ‰‹æœºå·
      let metaHtml = `<span id="articleDate">${date}</span>`;
      if (post.nickname || post.phone) {
        metaHtml += '<span>â€¢</span>';
        if (post.nickname) {
          metaHtml += `<span style="display: inline-flex; align-items: center; gap: 0.25rem;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            ${escapeHtml(post.nickname)}
          </span>`;
        }
        if (post.phone) {
          metaHtml += `<span style="display: inline-flex; align-items: center; gap: 0.25rem;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
            ${escapeHtml(post.phone)}
          </span>`;
        }
      }
      metaHtml += '<span>â€¢</span>';
      metaHtml += `<span id="articleViews">${views} é˜…è¯»</span>`;
      metaHtml += '<span>â€¢</span>';
      metaHtml += `<span id="readingTime">çº¦ ${readingTime} åˆ†é’Ÿé˜…è¯»</span>`;
      
      document.getElementById('articleMeta').innerHTML = metaHtml;

      // å†…å®¹ï¼ˆç»Ÿä¸€ä½¿ç”¨htmlContentï¼‰
      const contentDiv = document.getElementById('articleContent');
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹æ®Šç±»åˆ«ï¼Œéœ€è¦å®šåˆ¶æ˜¾ç¤º
      // ä¼˜å…ˆä½¿ç”¨ _specialType å’Œ _specialDataï¼ˆæ–°æ ¼å¼ï¼‰
      // å…¼å®¹ _originalDataï¼ˆæ—§æ ¼å¼ï¼‰
      const specialType = post._specialType;
      const specialData = post._specialData || post._originalData;
      const apiName = post._sourceApiName || '';
      
      const isExchangeRate = specialType === 'exchange-rate' || 
                            apiName.toLowerCase().includes('exchange') || 
                            apiName.toLowerCase().includes('æ±‡ç‡');
      const isTranslation = specialType === 'translation' || 
                           apiName.toLowerCase().includes('translation') || 
                           apiName.toLowerCase().includes('ç¿»è¯‘');
      const isWeather = specialType === 'weather' || 
                       apiName.toLowerCase().includes('weather') || 
                       apiName.toLowerCase().includes('å¤©æ°”');
      
      if (isWeather && specialData) {
        // å¤©æ°”è·¯å†µï¼šå®šåˆ¶æ˜¾ç¤º
        renderWeather(specialData, contentDiv);
      } else if (isExchangeRate && specialData) {
        // æ±‡ç‡è½¬æ¢ï¼šå®šåˆ¶æ˜¾ç¤º
        renderExchangeRate(specialData, contentDiv);
      } else if (isTranslation && specialData) {
        // ç¿»è¯‘å¡ç‰‡ï¼šå®šåˆ¶æ˜¾ç¤º
        renderTranslation(specialData, contentDiv);
      } else if (post.htmlContent) {
        contentDiv.innerHTML = post.htmlContent;
        // åˆ é™¤å›¾ç‰‡/è§†é¢‘/iframeï¼Œä¿ç•™çº¯æ–‡å­—
        contentDiv.querySelectorAll('img, video, iframe, picture, source').forEach(el => el.remove());
      } else {
        // å¦‚æœæ²¡æœ‰htmlContentï¼Œæ˜¾ç¤ºæ‰€æœ‰å­—æ®µå†…å®¹
        renderPostFields(post, contentDiv);
      }

      // æ„å»ºè½®æ’­å›¾
      carouselItems = extractCarouselItems(post);
      renderCarousel();

      // æ˜¾ç¤ºè”ç³»æ–¹å¼å’Œä½ç½®ä¿¡æ¯
      displayContactLocation(post);

      // æ˜¾ç¤ºè”ç³»æ–¹å¼å’Œä½ç½®ä¿¡æ¯
      displayContactLocation(post);

      // åˆ†ç±»æ˜¾ç¤º
      const category = post.category || post._sourceApiName || '';
      if (category) {
        const tagsDiv = document.getElementById('articleTags');
        tagsDiv.style.display = 'flex';
        tagsDiv.innerHTML = `<a href="/blog.html?category=${encodeURIComponent(category)}" class="blog-detail-tag">#${escapeHtml(category)}</a>`;
      }

      // åˆ†äº«æŒ‰é’®
      const shareUrl = window.location.href;
      const shareTitle = post.name || post.title || '';
      const shareText = post.excerpt || post.description || '';
      
      document.getElementById('shareButtons').innerHTML = `
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
          <button class="blog-btn blog-btn-secondary" onclick="shareToWeibo('${shareUrl}', '${shareTitle}')" style="font-size: 0.875rem; padding: 0.5rem 1rem;">åˆ†äº«åˆ°å¾®åš</button>
          <button class="blog-btn blog-btn-secondary" onclick="copyLink('${shareUrl}')" style="font-size: 0.875rem; padding: 0.5rem 1rem;">å¤åˆ¶é“¾æ¥</button>
        </div>
      `;

      // æ˜¾ç¤ºç¼–è¾‘æŒ‰é’®ï¼šç®¡ç†å‘˜ç™»å½• æˆ– ç”¨æˆ·æ‰‹æœºå·ä¸æ–‡ç« deviceIdä¸€è‡´
      const editBtn = document.getElementById('articleEditBtn');
      if (editBtn) {
        const canEdit = isAdminLoggedIn || post.canEdit;
        editBtn.style.display = canEdit ? 'inline-flex' : 'none';
      }
      
      // æ˜¾ç¤ºæ–°å»ºæ–‡ç« æŒ‰é’®ï¼šç”¨æˆ·å·²ç™»å½•
      const newPostBtn = document.getElementById('articleNewPostBtn');
      if (newPostBtn) {
        newPostBtn.style.display = currentUser ? 'inline-flex' : 'none';
      }
      
      // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ï¼šç®¡ç†å‘˜ç™»å½• æˆ– ç”¨æˆ·æ‰‹æœºå·ä¸æ–‡ç« deviceIdä¸€è‡´
      const deleteBtn = document.getElementById('articleDeleteBtn');
      if (deleteBtn) {
        const canDelete = isAdminLoggedIn || post.canEdit;
        deleteBtn.style.display = canDelete ? 'inline-flex' : 'none';
      }

      // æ›´æ–°é˜…è¯»è¿›åº¦
      updateReadingProgress();
    }

    // æ›´æ–°é˜…è¯»è¿›åº¦
    function updateReadingProgress() {
      const progressBar = document.getElementById('readingProgress');
      const article = document.querySelector('.blog-detail-article');
      
      function updateProgress() {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const scrollableHeight = documentHeight - windowHeight;
        const progress = scrollableHeight > 0 ? (scrollTop / scrollableHeight) * 100 : 0;
        progressBar.style.width = progress + '%';
      }

      window.addEventListener('scroll', updateProgress);
      updateProgress();
    }

    // åŠ è½½è¯„è®º
    async function loadComments(page = 1) {
      if (!currentPostId) return;

      try {
        const response = await getComments(currentPostId, {
          page,
          pageSize: commentsPageSize
        });

        if (response.success) {
          displayComments(response.comments || []);
          displayCommentsPagination(response);
          commentsPage = page;
        }
      } catch (error) {
        console.error('åŠ è½½è¯„è®ºå¤±è´¥:', error);
        document.getElementById('commentsList').innerHTML = '<div class="blog-empty">åŠ è½½è¯„è®ºå¤±è´¥</div>';
      }
    }

    // æ˜¾ç¤ºè¯„è®º
    function displayComments(comments) {
      const list = document.getElementById('commentsList');

      if (!comments || comments.length === 0) {
        list.innerHTML = '<div class="blog-empty">æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</div>';
        return;
      }

      list.innerHTML = comments.map(comment => {
        const date = formatDateTime(comment.createdAt || comment.created_at);
        return `
          <div class="blog-comment">
            <div class="blog-comment-author">${escapeHtml(comment.authorName)}</div>
            <div class="blog-comment-date">${date}</div>
            <div class="blog-comment-content">${escapeHtml(comment.content)}</div>
          </div>
        `;
      }).join('');
    }

    // æ˜¾ç¤ºè¯„è®ºåˆ†é¡µ
    function displayCommentsPagination(data) {
      const pagination = document.getElementById('commentsPagination');
      const totalPages = data.totalPages || 1;

      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let html = '';
      if (commentsPage > 1) {
        html += `<a href="#" class="blog-pagination-btn" onclick="loadComments(${commentsPage - 1}); return false;">ä¸Šä¸€é¡µ</a>`;
      }
      for (let i = 1; i <= totalPages; i++) {
        if (i === commentsPage) {
          html += `<span class="blog-pagination-btn active">${i}</span>`;
        } else {
          html += `<a href="#" class="blog-pagination-btn" onclick="loadComments(${i}); return false;">${i}</a>`;
        }
      }
      if (commentsPage < totalPages) {
        html += `<a href="#" class="blog-pagination-btn" onclick="loadComments(${commentsPage + 1}); return false;">ä¸‹ä¸€é¡µ</a>`;
      }

      pagination.innerHTML = html;
    }

    // æäº¤è¯„è®º
    async function submitComment(event) {
      event.preventDefault();

      if (!currentPostId) {
        showToast('æ–‡ç« IDä¸å­˜åœ¨', 'error');
        return;
      }

      const authorName = document.getElementById('commentAuthorName').value.trim();
      const authorEmail = document.getElementById('commentAuthorEmail').value.trim();
      const content = document.getElementById('commentContent').value.trim();

      if (!authorName || !authorEmail || !content) {
        showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
        return;
      }

      try {
        const response = await createComment(currentPostId, {
          authorName,
          authorEmail,
          content
        });

        if (response.success) {
          showToast('è¯„è®ºå·²æäº¤ï¼Œç­‰å¾…å®¡æ ¸', 'success');
          document.getElementById('commentForm').reset();
          // é‡æ–°åŠ è½½è¯„è®ºï¼ˆè™½ç„¶æ–°è¯„è®ºéœ€è¦å®¡æ ¸ï¼Œä½†å¯ä»¥åˆ·æ–°åˆ—è¡¨ï¼‰
          loadComments(commentsPage);
        } else {
          showToast(response.message || 'æäº¤è¯„è®ºå¤±è´¥', 'error');
        }
      } catch (error) {
        console.error('æäº¤è¯„è®ºå¤±è´¥:', error);
        showToast('æäº¤è¯„è®ºå¤±è´¥: ' + error.message, 'error');
      }
    }

    // åˆ†äº«åˆ°å¾®åš
    function shareToWeibo(url, title) {
      const shareUrl = `https://service.weibo.com/share/share.php?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
      window.open(shareUrl, '_blank', 'width=600,height=400');
    }

    // å¤åˆ¶é“¾æ¥
    function copyLink(url) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(url).then(() => {
          showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        }).catch(() => {
          fallbackCopyLink(url);
        });
      } else {
        fallbackCopyLink(url);
      }
    }

    function fallbackCopyLink(url) {
      const textarea = document.createElement('textarea');
      textarea.value = url;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand('copy');
        showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
      } catch (err) {
        showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
      }
      document.body.removeChild(textarea);
    }

    // æ¸²æŸ“æ–‡ç« çš„æ‰€æœ‰å­—æ®µ
    function renderPostFields(post, container) {
      // æ’é™¤ä¸€äº›å†…éƒ¨å­—æ®µ
      const excludeFields = ['_sourceApiName', '_originalData', 'id', 'slug', 'category', 'published', 'views', 'createdAt', 'created_at', 'updatedAt', 'updated_at'];
      
      let html = '<div class="post-fields">';
      
      // å¦‚æœæœ‰åŸå§‹æ•°æ®ï¼Œä¼˜å…ˆæ˜¾ç¤ºåŸå§‹æ•°æ®çš„æ‰€æœ‰å­—æ®µ
      if (post._originalData) {
        html += '<h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #374151;">æ–‡ç« è¯¦æƒ…</h2>';
        html += '<div style="display: grid; gap: 1rem;">';
        
        Object.keys(post._originalData).forEach(key => {
          if (excludeFields.includes(key)) return;
          
          const value = post._originalData[key];
          if (value === null || value === undefined) return;
          
          html += renderField(key, value);
        });
        
        html += '</div>';
      } else {
        // å¦åˆ™æ˜¾ç¤ºpostå¯¹è±¡çš„æ‰€æœ‰å­—æ®µ
        html += '<h2 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #374151;">æ–‡ç« è¯¦æƒ…</h2>';
        html += '<div style="display: grid; gap: 1rem;">';
        
        Object.keys(post).forEach(key => {
          if (excludeFields.includes(key)) return;
          
          const value = post[key];
          if (value === null || value === undefined || value === '') return;
          
          html += renderField(key, value);
        });
        
        html += '</div>';
      }
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // æ¸²æŸ“å•ä¸ªå­—æ®µ
    function renderField(key, value) {
      const fieldName = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
      
      let valueHtml = '';
      
      if (typeof value === 'object' && value !== null) {
        if (Array.isArray(value)) {
          valueHtml = `<div style="padding-left: 1rem;">
            ${value.map(item => {
              if (typeof item === 'object') {
                return `<div style="margin-bottom: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 0.25rem;">
                  ${Object.keys(item).map(k => `<div><strong>${k}:</strong> ${escapeHtml(String(item[k]))}</div>`).join('')}
                </div>`;
              }
              return `<div style="margin-bottom: 0.25rem;">${escapeHtml(String(item))}</div>`;
            }).join('')}
          </div>`;
        } else {
          valueHtml = `<div style="padding: 0.75rem; background: #f9fafb; border-radius: 0.25rem; font-family: monospace; font-size: 0.875rem;">
            ${Object.keys(value).map(k => `<div><strong>${k}:</strong> ${escapeHtml(String(value[k]))}</div>`).join('')}
          </div>`;
        }
      } else if (typeof value === 'string' && (value.startsWith('http://') || value.startsWith('https://') || value.startsWith('/'))) {
        // å¦‚æœæ˜¯URLï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡
        if (/\.(jpg|jpeg|png|gif|webp|svg)$/i.test(value)) {
          valueHtml = `<div>
            <img src="${validateImageUrl(value)}" alt="${fieldName}" style="max-width: 100%; height: auto; border-radius: 0.5rem; margin-top: 0.5rem;" onerror="this.style.display='none';">
            <div style="margin-top: 0.25rem; font-size: 0.875rem; color: #6b7280;">${escapeHtml(value)}</div>
          </div>`;
        } else {
          valueHtml = `<a href="${escapeHtml(value)}" target="_blank" rel="noopener noreferrer" style="color: #2563eb; text-decoration: underline;">${escapeHtml(value)}</a>`;
        }
      } else {
        valueHtml = escapeHtml(String(value));
      }
      
      return `
        <div style="padding: 1rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem;">
          <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em;">${escapeHtml(fieldName)}</div>
          <div style="color: #1f2937; word-break: break-word;">${valueHtml}</div>
        </div>
      `;
    }

    // æ¸²æŸ“æ±‡ç‡è½¬æ¢å†…å®¹
    function renderExchangeRate(data, container) {
      // è´§å¸åç§°æ˜ å°„
      const currencyNames = {
        'CNY': 'äººæ°‘å¸',
        'USD': 'ç¾å…ƒ',
        'EUR': 'æ¬§å…ƒ',
        'SAR': 'æ²™ç‰¹é‡Œäºšå°”',
        'GBP': 'è‹±é•‘',
        'JPY': 'æ—¥å…ƒ',
        'AED': 'é˜¿è”é…‹è¿ªæ‹‰å§†',
        'EGP': 'åŸƒåŠé•‘',
        'RUB': 'ä¿„ç½—æ–¯å¢å¸ƒ',
        'INR': 'å°åº¦å¢æ¯”',
        'KRW': 'éŸ©å…ƒ',
        'THB': 'æ³°é“¢'
      };
      
      // è´§å¸å›¾æ ‡æ˜ å°„
      const currencyIcons = {
        'CNY': 'ğŸ‡¨ğŸ‡³',
        'USD': 'ğŸ‡ºğŸ‡¸',
        'EUR': 'ğŸ‡ªğŸ‡º',
        'SAR': 'ğŸ‡¸ğŸ‡¦',
        'GBP': 'ğŸ‡¬ğŸ‡§',
        'JPY': 'ğŸ‡¯ğŸ‡µ',
        'AED': 'ğŸ‡¦ğŸ‡ª',
        'EGP': 'ğŸ‡ªğŸ‡¬',
        'RUB': 'ğŸ‡·ğŸ‡º',
        'INR': 'ğŸ‡®ğŸ‡³',
        'KRW': 'ğŸ‡°ğŸ‡·',
        'THB': 'ğŸ‡¹ğŸ‡­'
      };
      
      // æ’é™¤æ ‡å‡†å­—æ®µ
      const excludeFields = ['id', 'name', 'title', 'slug', 'excerpt', 'description', 'htmlContent', 'image', 'category', 'tags', 'published', 'views', 'createdAt', 'updatedAt', 'detailApi', 'updateTime'];
      
      let html = '<div class="exchange-rate-display" style="max-width: 900px; margin: 0 auto; padding: 1rem;">';
      
      // æ ‡é¢˜åŒºåŸŸ
      html += '<div style="text-align: center; margin-bottom: 2rem;">';
      html += '<div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸ’±</div>';
      html += '<h2 style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; color: #1f2937; background: linear-gradient(to right, #10b981, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">æ±‡ç‡è½¬æ¢</h2>';
      html += '<p style="color: #6b7280; font-size: 0.9375rem;">å®æ—¶æ±‡ç‡ä¿¡æ¯ï¼Œæ–¹ä¾¿æ‚¨è¿›è¡Œè´§å¸æ¢ç®—</p>';
      html += '</div>';
      
      // æ„å»ºæ±‡ç‡æ•°æ® - éå†æ‰€æœ‰å­—æ®µï¼Œæ‰¾å‡ºè´§å¸å­—æ®µ
      const exchangeData = [];
      Object.keys(data).forEach(fromCurrency => {
        // è·³è¿‡æ ‡å‡†å­—æ®µ
        if (excludeFields.includes(fromCurrency)) return;
        
        // å¦‚æœè¯¥å­—æ®µæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼ˆåŒ…å«ç›®æ ‡è´§å¸å’Œæ±‡ç‡ï¼‰
        if (data[fromCurrency] && typeof data[fromCurrency] === 'object' && !Array.isArray(data[fromCurrency])) {
          Object.keys(data[fromCurrency]).forEach(toCurrency => {
            const rate = data[fromCurrency][toCurrency];
            if (typeof rate === 'number' && rate > 0) {
              exchangeData.push({
                from: fromCurrency,
                fromName: currencyNames[fromCurrency] || fromCurrency,
                fromIcon: currencyIcons[fromCurrency] || 'ğŸ’µ',
                to: toCurrency,
                toName: currencyNames[toCurrency] || toCurrency,
                toIcon: currencyIcons[toCurrency] || 'ğŸ’µ',
                rate: rate
              });
            }
          });
        }
      });
      
      if (exchangeData.length > 0) {
        // ä½¿ç”¨å¡ç‰‡å¼å¸ƒå±€ï¼Œæ›´ç¾è§‚
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; margin-bottom: 2rem;">';
        
        exchangeData.forEach((item, index) => {
          html += `<div style="background: white; border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); border: 1px solid #e5e7eb; transition: all 0.3s ease; position: relative; overflow: hidden;" 
            onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05)';" 
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)';">`;
          
          // é¡¶éƒ¨è£…é¥°æ¡
          html += '<div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(to right, #10b981, #059669);"></div>';
          
          // è´§å¸è½¬æ¢ä¿¡æ¯
          html += '<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">';
          
          // æºè´§å¸
          html += '<div style="flex: 1; text-align: center;">';
          html += `<div style="font-size: 2rem; margin-bottom: 0.5rem;">${item.fromIcon}</div>`;
          html += `<div style="font-size: 1.125rem; font-weight: 700; color: #374151; margin-bottom: 0.25rem;">${item.from}</div>`;
          html += `<div style="font-size: 0.875rem; color: #6b7280;">${item.fromName}</div>`;
          html += '</div>';
          
          // ç®­å¤´
          html += '<div style="flex-shrink: 0; padding: 0 1rem;">';
          html += '<div style="font-size: 1.5rem; color: #10b981;">â†’</div>';
          html += '</div>';
          
          // ç›®æ ‡è´§å¸
          html += '<div style="flex: 1; text-align: center;">';
          html += `<div style="font-size: 2rem; margin-bottom: 0.5rem;">${item.toIcon}</div>`;
          html += `<div style="font-size: 1.125rem; font-weight: 700; color: #374151; margin-bottom: 0.25rem;">${item.to}</div>`;
          html += `<div style="font-size: 0.875rem; color: #6b7280;">${item.toName}</div>`;
          html += '</div>';
          
          html += '</div>';
          
          // æ±‡ç‡æ˜¾ç¤º
          html += '<div style="background: linear-gradient(to right, #ecfdf5, #d1fae5); border-radius: 0.75rem; padding: 1.25rem; text-align: center; border: 2px solid #10b981;">';
          html += `<div style="font-size: 2rem; font-weight: bold; color: #059669; margin-bottom: 0.5rem;">${item.rate.toFixed(4)}</div>`;
          html += `<div style="font-size: 0.875rem; color: #047857; font-weight: 600;">1 ${item.from} = ${item.rate.toFixed(4)} ${item.to}</div>`;
          html += '</div>';
          
          html += '</div>';
        });
        
        html += '</div>';
        
        // æ˜¾ç¤ºæ›´æ–°æ—¶é—´
        if (data.updateTime) {
          const updateDate = new Date(data.updateTime);
          html += `<div style="text-align: center; padding: 1rem; background: #f9fafb; border-radius: 0.75rem; margin-top: 1rem;">`;
          html += `<div style="display: inline-flex; align-items: center; gap: 0.5rem; color: #6b7280; font-size: 0.875rem;">`;
          html += '<span>ğŸ•</span>';
          html += `<span>æ›´æ–°æ—¶é—´ï¼š${formatDateTime(updateDate)}</span>`;
          html += '</div>';
          html += '</div>';
        }
      } else {
        html += '<div style="text-align: center; padding: 3rem; background: #f9fafb; border-radius: 0.75rem; color: #6b7280;">';
        html += '<div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“Š</div>';
        html += '<div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">æš‚æ— æ±‡ç‡æ•°æ®</div>';
        html += '<div style="font-size: 0.875rem;">è¯·ç¨åå†è¯•</div>';
        html += '</div>';
      }
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // æ¸²æŸ“ç¿»è¯‘å¡ç‰‡å†…å®¹
    function renderTranslation(data, container) {
      // å¦‚æœdataä¸ºç©ºæˆ–ä¸æ˜¯å¯¹è±¡ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      if (!data || typeof data !== 'object') {
        container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #6b7280;"><div style="font-size: 3rem; margin-bottom: 1rem;">âš ï¸</div><div style="font-size: 1.125rem; font-weight: 600;">æ•°æ®æ ¼å¼é”™è¯¯</div></div>';
        return;
      }
      
      let html = '<div class="translation-display" style="max-width: 900px; margin: 0 auto; padding: 1rem;">';
      
      // æ ‡é¢˜åŒºåŸŸ
      html += '<div style="text-align: center; margin-bottom: 2rem;">';
      html += '<div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸ—£ï¸</div>';
      html += '<h2 style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; color: #1f2937; background: linear-gradient(to right, #9333ea, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ç¿»è¯‘å¡ç‰‡</h2>';
      html += '<p style="color: #6b7280; font-size: 0.9375rem;">ä¸­é˜¿åŒè¯­å¯¹ç…§ï¼Œå¸®åŠ©æ‚¨æ›´å¥½åœ°æ²Ÿé€š</p>';
      html += '</div>';
      
      html += '<div style="background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); padding: 2.5rem; border: 1px solid #e5e7eb; position: relative; overflow: hidden;">';
      
      // é¡¶éƒ¨è£…é¥°æ¡
      html += '<div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(to right, #9333ea, #7c3aed);"></div>';
      
      // æ£€æŸ¥æ•°æ®å­—æ®µï¼ˆæ”¯æŒå¤šç§å­—æ®µåï¼‰
      const chinese = data.chinese || data.name || data.title || '';
      const arabic = data.arabic || '';
      
      if (chinese && arabic) {
        // ä¸­æ–‡éƒ¨åˆ†
        html += '<div style="margin-bottom: 2rem; padding-bottom: 2rem; border-bottom: 2px solid #e5e7eb;">';
        html += '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">';
        html += '<span style="font-size: 1.5rem;">ğŸ‡¨ğŸ‡³</span>';
        html += '<div style="font-size: 0.875rem; color: #9333ea; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">ä¸­æ–‡ (Chinese)</div>';
        html += '</div>';
        html += `<div style="font-size: 1.75rem; color: #1f2937; line-height: 1.8; font-weight: 500; padding: 1rem; background: linear-gradient(to right, #faf5ff, #f3e8ff); border-radius: 0.75rem; border-left: 4px solid #9333ea;">${escapeHtml(chinese)}</div>`;
        html += '</div>';
        
        // é˜¿æ‹‰ä¼¯æ–‡éƒ¨åˆ†
        html += '<div style="margin-bottom: 2rem;">';
        html += '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">';
        html += '<span style="font-size: 1.5rem;">ğŸ‡ªğŸ‡¬</span>';
        html += '<div style="font-size: 0.875rem; color: #9333ea; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</div>';
        html += '</div>';
        html += `<div style="font-size: 1.75rem; color: #1f2937; line-height: 1.8; font-weight: 500; padding: 1rem; background: linear-gradient(to right, #faf5ff, #f3e8ff); border-radius: 0.75rem; border-left: 4px solid #9333ea; direction: rtl; text-align: right; font-family: "Arial", "Tahoma", "Segoe UI", sans-serif;">${escapeHtml(arabic)}</div>`;
        html += '</div>';
        
        // åˆ†ç±»æ ‡ç­¾
        if (data.category) {
          html += '<div style="display: flex; align-items: center; gap: 0.75rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">';
          html += '<span style="font-size: 1.25rem;">ğŸ·ï¸</span>';
          html += `<div style="display: inline-flex; align-items: center; gap: 0.5rem;">`;
          html += `<span style="background: linear-gradient(to right, #9333ea, #7c3aed); color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 600;">${escapeHtml(data.category)}</span>`;
          html += '</div>';
          html += '</div>';
        }
      } else {
        html += '<div style="text-align: center; padding: 3rem; color: #6b7280;">';
        html += '<div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“</div>';
        html += '<div style="font-size: 1.125rem; font-weight: 600; margin-bottom: 0.5rem;">æš‚æ— ç¿»è¯‘æ•°æ®</div>';
        html += '<div style="font-size: 0.875rem;">è¯·ç¨åå†è¯•</div>';
        html += '</div>';
      }
      
      html += '</div>';
      html += '</div>';
      container.innerHTML = html;
    }
    
    // æ¸²æŸ“å¤©æ°”è·¯å†µå†…å®¹
    function renderWeather(data, container) {
      let html = '<div class="weather-display" style="max-width: 1000px; margin: 0 auto; padding: 1rem;">';
      
      // æ ‡é¢˜åŒºåŸŸ
      html += '<div style="text-align: center; margin-bottom: 2rem;">';
      html += '<div style="font-size: 3rem; margin-bottom: 0.5rem;">ğŸŒ¤ï¸</div>';
      html += '<h2 style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem; color: #1f2937; background: linear-gradient(to right, #3b82f6, #2563eb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">å¤©æ°”è·¯å†µ</h2>';
      html += '<p style="color: #6b7280; font-size: 0.9375rem;">å®æ—¶å¤©æ°”ä¿¡æ¯ä¸è·¯å†µæé†’ï¼ŒåŠ©æ‚¨å‡ºè¡Œæ— å¿§</p>';
      html += '</div>';
      
      // å…¨å±€é¢„è­¦
      if (data.globalAlert) {
        const alertLevel = data.globalAlert.level || 'medium';
        const alertMessage = data.globalAlert.message || '';
        const levelColors = {
          'low': { bg: 'linear-gradient(to right, #dbeafe, #bfdbfe)', border: '#3b82f6', text: '#1e40af', icon: 'â„¹ï¸', shadow: '0 4px 6px -1px rgba(59, 130, 246, 0.3)' },
          'medium': { bg: 'linear-gradient(to right, #fef3c7, #fde68a)', border: '#f59e0b', text: '#92400e', icon: 'âš ï¸', shadow: '0 4px 6px -1px rgba(245, 158, 11, 0.3)' },
          'high': { bg: 'linear-gradient(to right, #fee2e2, #fecaca)', border: '#ef4444', text: '#991b1b', icon: 'ğŸš¨', shadow: '0 4px 6px -1px rgba(239, 68, 68, 0.3)' }
        };
        const levelNames = {
          'low': 'ä½é£é™©',
          'medium': 'ä¸­é£é™©',
          'high': 'é«˜é£é™©'
        };
        const colors = levelColors[alertLevel] || levelColors['medium'];
        
        html += `<div style="background: ${colors.bg}; border-left: 5px solid ${colors.border}; border-radius: 1rem; padding: 2rem; margin-bottom: 2rem; box-shadow: ${colors.shadow}; position: relative; overflow: hidden;">`;
        html += '<div style="position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%); border-radius: 50%; transform: translate(30px, -30px);"></div>';
        html += '<div style="display: flex; align-items: flex-start; gap: 1rem; position: relative; z-index: 1;">';
        html += `<div style="flex-shrink: 0; font-size: 3rem; line-height: 1;">${colors.icon}</div>`;
        html += '<div style="flex: 1;">';
        html += '<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">';
        html += `<span style="font-weight: 700; color: ${colors.text}; font-size: 1.25rem;">å…¨å±€é¢„è­¦</span>`;
        html += `<span style="background: ${colors.border}; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${levelNames[alertLevel]}</span>`;
        html += '</div>';
        html += `<div style="color: ${colors.text}; font-size: 1.125rem; line-height: 1.7; font-weight: 500;">${escapeHtml(alertMessage)}</div>`;
        html += '</div>';
        html += '</div>';
        html += '</div>';
      }
      
      // æ™¯ç‚¹å¤©æ°”
      if (data.attractions && Array.isArray(data.attractions) && data.attractions.length > 0) {
        html += '<div style="margin-bottom: 2.5rem;">';
        html += '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">';
        html += '<span style="font-size: 2rem;">ğŸ“</span>';
        html += '<h3 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">æ™¯ç‚¹å¤©æ°”</h3>';
        html += '</div>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">';
        
        data.attractions.forEach((attraction, index) => {
          html += `<div style="background: white; border-radius: 1rem; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); border: 1px solid #e5e7eb; transition: all 0.3s ease; position: relative; overflow: hidden;" 
            onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05)';" 
            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)';">`;
          
          // é¡¶éƒ¨è£…é¥°æ¡
          html += '<div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(to right, #3b82f6, #2563eb);"></div>';
          
          // æ™¯ç‚¹åç§°
          html += '<div style="font-size: 1.375rem; font-weight: 700; color: #1f2937; margin-bottom: 1.25rem; padding-bottom: 1rem; border-bottom: 2px solid #e5e7eb; display: flex; align-items: center; gap: 0.75rem;">';
          html += '<span style="font-size: 1.5rem;">ğŸ›ï¸</span>';
          html += '<span>' + escapeHtml(attraction.name || 'æœªå‘½åæ™¯ç‚¹') + '</span>';
          html += '</div>';
          
          // å¤©æ°”ä¿¡æ¯ç½‘æ ¼
          html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">';
          
          // æ¸©åº¦
          if (attraction.temperature !== undefined) {
            html += '<div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 1rem; border-radius: 0.75rem; border: 2px solid #fbbf24; box-shadow: 0 2px 4px rgba(251, 191, 36, 0.2);">';
            html += '<div style="font-size: 0.875rem; color: #92400e; margin-bottom: 0.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">';
            html += '<span>ğŸŒ¡ï¸</span><span>æ¸©åº¦</span>';
            html += '</div>';
            html += '<div style="font-size: 2rem; font-weight: bold; color: #92400e; line-height: 1;">' + escapeHtml(String(attraction.temperature)) + '<span style="font-size: 1.25rem; margin-left: 0.25rem;">Â°C</span></div>';
            html += '</div>';
          }
          
          // èƒ½è§åº¦
          if (attraction.visibility) {
            html += '<div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 1rem; border-radius: 0.75rem; border: 2px solid #60a5fa; box-shadow: 0 2px 4px rgba(96, 165, 250, 0.2);">';
            html += '<div style="font-size: 0.875rem; color: #1e40af; margin-bottom: 0.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">';
            html += '<span>ğŸ‘ï¸</span><span>èƒ½è§åº¦</span>';
            html += '</div>';
            html += '<div style="font-size: 1.5rem; font-weight: bold; color: #1e40af;">' + escapeHtml(attraction.visibility) + '</div>';
            html += '</div>';
          }
          
          // ç´«å¤–çº¿æŒ‡æ•°
          if (attraction.uvIndex !== undefined) {
            html += '<div style="background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); padding: 1rem; border-radius: 0.75rem; border: 2px solid #f87171; box-shadow: 0 2px 4px rgba(248, 113, 113, 0.2);">';
            html += '<div style="font-size: 0.875rem; color: #991b1b; margin-bottom: 0.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">';
            html += '<span>â˜€ï¸</span><span>ç´«å¤–çº¿</span>';
            html += '</div>';
            html += '<div style="font-size: 1.5rem; font-weight: bold; color: #991b1b;">' + escapeHtml(String(attraction.uvIndex)) + '</div>';
            html += '</div>';
          }
          
          // é£é€Ÿ
          if (attraction.windSpeed) {
            html += '<div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 1rem; border-radius: 0.75rem; border: 2px solid #818cf8; box-shadow: 0 2px 4px rgba(129, 140, 248, 0.2);">';
            html += '<div style="font-size: 0.875rem; color: #3730a3; margin-bottom: 0.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">';
            html += '<span>ğŸ’¨</span><span>é£é€Ÿ</span>';
            html += '</div>';
            html += '<div style="font-size: 1.5rem; font-weight: bold; color: #3730a3;">' + escapeHtml(attraction.windSpeed) + '</div>';
            html += '</div>';
          }
          
          html += '</div>';
          
          // å»ºè®®
          if (attraction.suggestion) {
            html += '<div style="background: linear-gradient(to right, #f0f9ff, #e0f2fe); padding: 1rem; border-radius: 0.75rem; border-left: 4px solid #3b82f6; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);">';
            html += '<div style="font-size: 0.875rem; color: #0369a1; margin-bottom: 0.5rem; font-weight: 700; display: flex; align-items: center; gap: 0.5rem;">';
            html += '<span>ğŸ’¡</span><span>å‡ºè¡Œå»ºè®®</span>';
            html += '</div>';
            html += '<div style="color: #1e40af; line-height: 1.7; font-size: 0.9375rem; font-weight: 500;">' + escapeHtml(attraction.suggestion) + '</div>';
            html += '</div>';
          }
          
          html += '</div>';
        });
        
        html += '</div>';
        html += '</div>';
      }
      
      // è·¯å†µä¿¡æ¯
      if (data.traffic && Array.isArray(data.traffic) && data.traffic.length > 0) {
        html += '<div style="margin-bottom: 2rem;">';
        html += '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">';
        html += '<span style="font-size: 2rem;">ğŸš¦</span>';
        html += '<h3 style="font-size: 1.5rem; font-weight: 700; color: #1f2937; margin: 0;">è·¯å†µä¿¡æ¯</h3>';
        html += '</div>';
        html += '<div style="display: grid; gap: 1.25rem;">';
        
        data.traffic.forEach((traffic, index) => {
          const typeColors = {
            'è½¦ç¥¸': { bg: 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)', border: '#ef4444', icon: 'ğŸš¨', shadow: '0 4px 6px -1px rgba(239, 68, 68, 0.3)' },
            'æ–½å·¥': { bg: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', border: '#f59e0b', icon: 'ğŸš§', shadow: '0 4px 6px -1px rgba(245, 158, 11, 0.3)' },
            'å¤©æ°”': { bg: 'linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%)', border: '#3b82f6', icon: 'ğŸŒ§ï¸', shadow: '0 4px 6px -1px rgba(59, 130, 246, 0.3)' },
            'æ‹¥å µ': { bg: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', border: '#f59e0b', icon: 'ğŸš—', shadow: '0 4px 6px -1px rgba(245, 158, 11, 0.3)' },
            'å…¶ä»–': { bg: 'linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%)', border: '#6b7280', icon: 'âš ï¸', shadow: '0 4px 6px -1px rgba(107, 114, 128, 0.3)' }
          };
          const colors = typeColors[traffic.type] || typeColors['å…¶ä»–'];
          
          html += `<div style="background: white; border-left: 5px solid ${colors.border}; border-radius: 1rem; padding: 1.5rem; box-shadow: ${colors.shadow}; position: relative; overflow: hidden; transition: all 0.3s ease;" 
            onmouseover="this.style.transform='translateX(4px)'; this.style.boxShadow='0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05)';" 
            onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='${colors.shadow}';">`;
          
          // èƒŒæ™¯è£…é¥°
          html += `<div style="position: absolute; top: 0; right: 0; width: 80px; height: 80px; background: ${colors.bg}; border-radius: 50%; transform: translate(20px, -20px); opacity: 0.3;"></div>`;
          
          html += '<div style="display: flex; align-items: flex-start; gap: 1.25rem; position: relative; z-index: 1;">';
          
          // å·¦ä¾§ï¼šå›¾æ ‡å’Œæ—¶é—´
          html += '<div style="flex-shrink: 0; text-align: center;">';
          html += `<div style="font-size: 2.5rem; margin-bottom: 0.75rem; line-height: 1;">${colors.icon}</div>`;
          if (traffic.time) {
            html += `<div style="background: ${colors.border}; color: white; padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${escapeHtml(traffic.time)}</div>`;
          }
          html += '</div>';
          
          // å³ä¾§ï¼šç±»å‹ã€åœ°ç‚¹å’Œæ¶ˆæ¯
          html += '<div style="flex: 1;">';
          html += '<div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; flex-wrap: wrap;">';
          html += `<span style="background: ${colors.border}; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">${escapeHtml(traffic.type || 'å…¶ä»–')}</span>`;
          if (traffic.location) {
            html += '<div style="display: flex; align-items: center; gap: 0.5rem; color: #6b7280; font-size: 0.9375rem; font-weight: 600;">';
            html += '<span>ğŸ“</span>';
            html += `<span>${escapeHtml(traffic.location)}</span>`;
            html += '</div>';
          }
          html += '</div>';
          if (traffic.message) {
            html += `<div style="color: #374151; line-height: 1.7; font-size: 1rem; font-weight: 500; padding: 0.75rem; background: ${colors.bg}; border-radius: 0.5rem;">${escapeHtml(traffic.message)}</div>`;
          }
          html += '</div>';
          
          html += '</div>';
          html += '</div>';
        });
        
        html += '</div>';
        html += '</div>';
      }
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
    function formatDateTime(date) {
      // å¦‚æœä¼ å…¥çš„ä¸æ˜¯Dateå¯¹è±¡ï¼Œå…ˆè½¬æ¢ä¸ºDateå¯¹è±¡
      if (!(date instanceof Date)) {
        if (!date) return '';
        date = new Date(date);
        // æ£€æŸ¥æ—¥æœŸæ˜¯å¦æœ‰æ•ˆ
        if (isNaN(date.getTime())) {
          return '';
        }
      }
      
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // æ˜¾ç¤ºè”ç³»æ–¹å¼å’Œä½ç½®ä¿¡æ¯
    function displayContactLocation(post) {
      const container = document.getElementById('articleContactLocation');
      if (!container) return;

      // è·å–è”ç³»æ–¹å¼å’Œä½ç½®ä¿¡æ¯ï¼ˆä¼˜å…ˆä»_originalDataè·å–ï¼‰
      const phone = (post._originalData && post._originalData.phone) || post.phone || '';
      const address = (post._originalData && post._originalData.address) || post.address || '';
      const latitude = (post._originalData && post._originalData.latitude) || post.latitude;
      const longitude = (post._originalData && post._originalData.longitude) || post.longitude;

      // å¦‚æœæ²¡æœ‰è”ç³»æ–¹å¼å’Œä½ç½®ä¿¡æ¯ï¼Œéšè—å®¹å™¨
      if (!phone && !address && (latitude === undefined || longitude === undefined || isNaN(latitude) || isNaN(longitude))) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'block';
      
      let html = '<div class="blog-contact-location-card" style="background: white; border-radius: 1rem; border: 1px solid #e5e7eb; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">';
      
      // è”ç³»æ–¹å¼
      if (phone) {
        html += `
          <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              <span style="font-weight: 600; color: #374151; font-size: 1rem;">è”ç³»æ–¹å¼</span>
            </div>
            <a href="tel:${escapeHtml(phone)}" style="color: #d97706; text-decoration: none; font-size: 1.125rem; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;">
              ${escapeHtml(phone)}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 4h4l2 5l-2.5 2.5a11 11 0 0 0 5 5l2.5 -2.5l5 2v4a2 2 0 0 1 -2 2a16 16 0 0 1 -15 -15a2 2 0 0 1 2 -2"></path>
              </svg>
            </a>
          </div>
        `;
      }

      // ä½ç½®ä¿¡æ¯
      if (address || (latitude !== undefined && longitude !== undefined && !isNaN(latitude) && !isNaN(longitude))) {
        html += `
          <div>
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
              </svg>
              <span style="font-weight: 600; color: #374151; font-size: 1rem;">ä½ç½®ä¿¡æ¯</span>
            </div>
        `;
        
        if (address) {
          html += `<div style="color: #6b7280; margin-bottom: 1rem; line-height: 1.6;">${escapeHtml(address)}</div>`;
        }

        // åœ°å›¾æ˜¾ç¤º
        if (latitude !== undefined && longitude !== undefined && !isNaN(latitude) && !isNaN(longitude)) {
          const mapId = 'locationMap_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
          html += `
            <div id="${mapId}" style="width: 100%; height: 300px; border-radius: 0.5rem; overflow: hidden; margin-top: 1rem; border: 1px solid #e5e7eb; background: #f9fafb;"></div>
          `;
          
          // å»¶è¿ŸåŠ è½½åœ°å›¾ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
          setTimeout(() => {
            initMap(mapId, parseFloat(latitude), parseFloat(longitude), address || '');
          }, 200);
        }
        
        html += `</div>`;
      }

      html += '</div>';
      container.innerHTML = html;
    }

    // åˆå§‹åŒ–åœ°å›¾ï¼ˆä½¿ç”¨Leaflet + OpenStreetMapï¼‰
    function initMap(mapId, lat, lng, address) {
      const mapContainer = document.getElementById(mapId);
      if (!mapContainer) return;

      // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½Leaflet
      if (typeof L === 'undefined') {
        // åŠ¨æ€åŠ è½½Leaflet CSSå’ŒJSï¼ˆä½¿ç”¨jsdelivr CDNï¼Œå·²åœ¨CSPç™½åå•ä¸­ï¼‰
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css';
        link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
        link.crossOrigin = '';
        document.head.appendChild(link);

        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
        script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
        script.crossOrigin = '';
        script.onload = () => {
          createMap(mapContainer, lat, lng, address);
        };
        script.onerror = () => {
          mapContainer.innerHTML = `<div style="padding: 2rem; text-align: center; color: #6b7280;">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>`;
        };
        document.head.appendChild(script);
      } else {
        createMap(mapContainer, lat, lng, address);
      }
    }

    function createMap(container, lat, lng, address) {
      try {
        // åˆ›å»ºåœ°å›¾
        const map = L.map(container).setView([lat, lng], 15);

        // æ·»åŠ OpenStreetMapå›¾å±‚ï¼ˆä½¿ç”¨jsdelivrçš„ä»£ç†ï¼Œé¿å…CSPé—®é¢˜ï¼‰
        // å¦‚æœç›´æ¥ä½¿ç”¨OpenStreetMapå¯èƒ½è¢«CSPé˜»æ­¢ï¼Œä½¿ç”¨jsdelivrçš„ä»£ç†
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors',
          maxZoom: 19,
          // æ·»åŠ é”™è¯¯å¤„ç†
          errorTileUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2Y5ZmFmYiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5Y2EzYWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj7lm77niYfliqDovb3lpLHotKU8L3RleHQ+PC9zdmc+'
        }).addTo(map);

        // æ·»åŠ æ ‡è®°
        const marker = L.marker([lat, lng]).addTo(map);
        const popupContent = address 
          ? `<div style="font-weight: 600; margin-bottom: 0.25rem;">${escapeHtml(address)}</div><div style="font-size: 0.875rem; color: #6b7280;">${lat.toFixed(4)}, ${lng.toFixed(4)}</div>`
          : `<div style="font-size: 0.875rem;">${lat.toFixed(4)}, ${lng.toFixed(4)}</div>`;
        marker.bindPopup(popupContent).openPopup();
      } catch (error) {
        console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
        container.innerHTML = `<div style="padding: 2rem; text-align: center; color: #6b7280;">åœ°å›¾åŠ è½½å¤±è´¥</div>`;
      }
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadPost();
    });
  </script>
</body>
</html>
