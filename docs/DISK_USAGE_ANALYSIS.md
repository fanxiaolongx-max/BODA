# 磁盘使用情况分析报告

## 📊 总体情况

**磁盘总容量：50 GB**  
**已使用：15 GB (30%)**  
**可用空间：35 GB**

## 🔍 主要占用分析

### 1. 根目录各目录占用（Top 10）

| 目录 | 大小 | 占比 | 说明 |
|------|------|------|------|
| `/usr` | 4.6 GB | 30.7% | 系统程序和库文件 |
| **`/data`** | **3.6 GB** | **24.0%** | **应用数据（主要占用）** |
| `/swapfile` | 2.1 GB | 14.0% | 交换文件 |
| `/home` | 1.6 GB | 10.7% | 用户目录 |
| `/var` | 1.4 GB | 9.3% | 日志和缓存 |
| `/root` | 1.4 GB | 9.3% | root用户目录 |

### 2. /data 目录详细分析（3.6 GB）

| 子目录/文件 | 大小 | 占比 | 说明 |
|------------|------|------|------|
| **`/data/logs`** | **2.8 GB** | **77.8%** | **日志和备份（主要问题）** |
| `/data/uploads` | 773 MB | 21.5% | 上传文件 |
| `/data/boda.db` | 42 MB | 1.2% | 数据库文件（已优化） |
| `/data/show` | 160 KB | <0.1% | 展示文件 |

#### /data/logs 详细分析（2.8 GB）

| 类型 | 大小 | 说明 |
|------|------|------|
| **备份文件** | **2.6 GB** | **数据库和完整备份** |
| 应用日志 | 200 MB | 访问日志和组合日志 |

**备份文件详情：**
- 数据库备份：4 个文件，总计约 2.33 GB
  - `boda-backup-2025-12-26T09-09-09.db`: **2.32 GB** ⚠️（压缩前的备份）
  - `boda-backup-2025-12-12T21-40-52.db`: 7.39 MB
  - `boda-backup-2025-12-12T21-50-03.db`: 3.42 MB
  - `boda-backup-2025-12-06T08-39-58.db`: 252 KB
- 完整备份：5 个 ZIP 文件，总计约 230 MB
  - `boda-full-backup-2025-12-21T15-58-23.zip`: 166.08 MB
  - 其他4个：约 64 MB

**应用日志详情：**
- 多个日期日志文件，每个约 3-17 MB
- 主要是访问日志和组合日志

#### /data/uploads 详细分析（773 MB）

| 子目录 | 大小 | 说明 |
|--------|------|------|
| `/data/uploads/custom-api-videos` | 607 MB | 自定义API视频 |
| `/data/uploads/videos` | 95 MB | 视频文件 |
| `/data/uploads/custom-api-images` | 39 MB | 自定义API图片 |
| `/data/uploads/payments` | 12 MB | 支付截图 |
| `/data/uploads/images` | 11 MB | 图片文件 |
| `/data/uploads/products` | 7.9 MB | 产品图片 |
| `/data/uploads/tts` | 3.7 MB | TTS音频 |

### 3. /var/log 目录分析（1.4 GB）

| 文件/目录 | 大小 | 说明 |
|-----------|------|------|
| `/var/log/journal` | 774 MB | systemd 日志 |
| `/var/log/btmp` | 122 MB | 失败的登录尝试日志 |
| `/var/log/auth.log.1` | 52 MB | 认证日志（已轮转） |
| `/var/log/auth.log` | 35 MB | 当前认证日志 |
| `/var/log/nginx` | 7 MB | Nginx 日志 |
| 其他日志文件 | ~50 MB | 各种系统日志 |

## ⚠️ 主要问题

### 1. 备份文件占用过大（2.6 GB）

**问题：**
- 最新的数据库备份文件 `boda-backup-2025-12-26T09-09-09.db` 占用 **2.32 GB**
- 这是压缩前的数据库备份（当时数据库是 2.67 GB）
- 现在数据库已经压缩到 42 MB，但旧备份仍然占用大量空间

**影响：**
- 占用了 `/data/logs` 目录 93% 的空间
- 占用了整个 `/data` 目录 72% 的空间
- 占用了整个磁盘 17% 的空间

### 2. 应用日志文件较多（200 MB）

**问题：**
- 多个日期的日志文件累积
- 每个日志文件约 3-17 MB

### 3. systemd 日志占用较大（774 MB）

**问题：**
- `/var/log/journal` 占用 774 MB
- 这是系统日志，会持续增长

## 💡 优化建议

### 立即执行（高优先级）

#### 1. 清理旧备份文件

**可以删除的备份：**
- `boda-backup-2025-12-26T09-09-09.db` (2.32 GB) - 这是压缩前的备份，现在数据库已优化
- 保留最新的 1-2 个备份即可

**执行命令：**
```bash
# 查看备份文件
ls -lh /data/logs/backup/

# 删除旧备份（保留最新的）
rm /data/logs/backup/boda-backup-2025-12-26T09-09-09.db

# 或者使用备份清理脚本（如果存在）
node scripts/backup.js --cleanup
```

**预期效果：** 释放约 **2.3 GB** 空间

#### 2. 清理 systemd 日志

**执行命令：**
```bash
# 只保留最近30天的日志
sudo journalctl --vacuum-time=30d

# 或者限制日志大小为500MB
sudo journalctl --vacuum-size=500M
```

**预期效果：** 释放约 **500-700 MB** 空间

#### 3. 清理 /var/log/btmp

**执行命令：**
```bash
# 清空失败的登录尝试日志
sudo truncate -s 0 /var/log/btmp
```

**预期效果：** 释放约 **122 MB** 空间

### 中期优化（中优先级）

#### 4. 配置日志轮转

- 配置应用日志自动轮转和清理
- 只保留最近 7-30 天的日志

#### 5. 定期清理备份

- 设置备份保留策略（如只保留最近7天的备份）
- 自动清理旧备份

#### 6. 优化上传文件存储

- 检查 `/data/uploads/custom-api-videos` (607 MB) 是否有重复或不需要的文件
- 考虑使用对象存储服务（如 S3）存储大文件

### 长期优化（低优先级）

#### 7. 监控磁盘使用

- 设置磁盘使用告警（如超过80%）
- 定期运行磁盘分析脚本

#### 8. 考虑扩展磁盘

- 如果持续增长，考虑增加磁盘容量

## 📈 预期优化效果

执行上述优化后：

| 优化项 | 可释放空间 | 累计释放 |
|--------|-----------|---------|
| 清理旧备份 | 2.3 GB | 2.3 GB |
| 清理 systemd 日志 | 0.7 GB | 3.0 GB |
| 清理 btmp | 0.12 GB | 3.12 GB |
| **总计** | **~3.1 GB** | **磁盘使用率降至 ~24%** |

## 🔧 执行步骤

### 步骤 1：清理备份文件
```bash
# 查看备份文件列表
ls -lh /data/logs/backup/

# 删除最大的旧备份（压缩前的备份）
rm /data/logs/backup/boda-backup-2025-12-26T09-09-09.db

# 验证
du -sh /data/logs/backup/
```

### 步骤 2：清理系统日志
```bash
# 清理 systemd 日志（保留30天）
sudo journalctl --vacuum-time=30d

# 清空 btmp
sudo truncate -s 0 /var/log/btmp

# 验证
du -sh /var/log/
```

### 步骤 3：验证结果
```bash
# 查看磁盘使用情况
df -h /

# 查看主要目录大小
du -sh /data /var/log /usr
```

## 📝 总结

**当前状态：**
- ✅ 数据库已优化（从 2.67 GB 到 42 MB）
- ⚠️ 备份文件占用 2.6 GB（主要是压缩前的旧备份）
- ⚠️ 系统日志占用 1 GB

**主要问题：**
1. 🔴 **备份文件占用过大**（2.6 GB）- 可以立即清理
2. 🟡 **系统日志占用较大**（1 GB）- 可以定期清理
3. 🟢 **应用日志正常**（200 MB）- 可配置自动清理

**建议优先级：**
1. 🔴 **立即清理旧备份**（可释放 2.3 GB）
2. 🟡 **清理系统日志**（可释放 0.7 GB）
3. 🟢 **配置自动清理策略**

