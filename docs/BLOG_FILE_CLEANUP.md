# 博客文件清理功能说明

## 📋 概述

博客系统现在支持自动清理文章关联的图片和视频文件，避免服务器上积累未使用的文件。

## ✨ 功能特性

### 1. 删除文章时自动清理文件

当删除文章时，系统会自动删除：
- 文章主图片（`image` 字段）
- HTML内容中的所有图片（`<img>` 标签的 `src` 属性）
- HTML内容中的所有视频（`<video>` 标签的 `src` 和 `<source>` 标签的 `src` 属性）
- 视频封面图片（`<video>` 标签的 `poster` 属性）

### 2. 更新文章时自动清理旧文件

当更新文章时，系统会：
- 如果主图片改变，删除旧的主图片文件
- 如果HTML内容改变，对比新旧内容，删除不再使用的图片和视频文件

### 3. 检查未使用的文件

提供工具脚本检查服务器上有多少文件没有被文章引用但残留在服务器上。

## 🛠️ 使用方法

### 检查未使用的文件

```bash
# 检查未使用的文件（只查看，不删除）
node db/check-unused-files.js
```

**输出示例**：
```
开始检查未使用的文件...

找到 80 篇文章

找到 57 个被引用的文件

找到 87 个上传文件

================================================================================
检查结果
================================================================================
总文件数: 87
已使用文件数: 46
未使用文件数: 41
未使用文件总大小: 59.36 MB
================================================================================

未使用的文件列表（前20个）:
--------------------------------------------------------------------------------
1. uploads/videos/2025/12/1766680945852-wnq7yej.mp4 (2.72 MB)
2. uploads/videos/2025/12/1766681673641-uefskmb.mp4 (2.72 MB)
...
```

### 清理未使用的文件

```bash
# 预览模式（默认，不会实际删除）
node db/cleanup-unused-files.js

# 实际删除模式（需要添加 --execute 参数）
node db/cleanup-unused-files.js --execute
```

**预览模式输出**：
```
开始清理未使用的文件...

⚠️  这是预览模式（dry-run），不会实际删除文件

...
预览模式: 将删除 41 个文件
将释放空间: 59.36 MB

要实际执行删除，请运行:
node db/cleanup-unused-files.js --execute
```

**实际删除模式输出**：
```
开始清理未使用的文件...

⚠️  这是实际删除模式，将永久删除文件！

...
✅ 已删除: uploads/videos/2025/12/1766680945852-wnq7yej.mp4 (2.72 MB)
✅ 已删除: uploads/videos/2025/12/1766681673641-uefskmb.mp4 (2.72 MB)
...

已删除文件数: 41
失败文件数: 0
释放空间: 59.36 MB
```

## 🔍 工作原理

### 文件路径识别

系统支持以下URL格式的文件路径识别：
- 完整URL: `https://bobapro.life/uploads/images/2025/01/xxx.jpg`
- 相对路径: `/uploads/images/2025/01/xxx.jpg`
- 相对路径: `uploads/images/2025/01/xxx.jpg`

### HTML内容解析

系统会从HTML内容中提取以下媒体文件：
- `<img src="...">` - 图片
- `<video src="...">` - 视频
- `<source src="...">` - 视频源（在video标签内）
- `<video poster="...">` - 视频封面图片

### 文件清理逻辑

1. **删除文章时**：
   - 获取文章的所有文件引用
   - 删除所有关联的文件

2. **更新文章时**：
   - 对比新旧内容
   - 找出不再使用的文件
   - 只删除不再使用的文件

## ⚠️ 注意事项

1. **外部URL不会被删除**：只有 `uploads/` 目录下的本地文件才会被删除
2. **Base64图片不会被处理**：Base64编码的图片和视频不会被识别为文件
3. **删除失败不影响操作**：如果文件删除失败，不会影响文章的删除或更新操作
4. **建议定期检查**：建议定期运行检查脚本，清理未使用的文件

## 📊 统计信息

根据当前检查结果：
- **总文件数**: 87 个
- **已使用文件**: 46 个
- **未使用文件**: 41 个
- **未使用文件总大小**: 59.36 MB

## 🔧 技术实现

### 核心函数

- `extractMediaUrls(htmlContent)` - 提取HTML中的媒体URL
- `urlToLocalPath(url)` - 将URL转换为本地文件路径
- `deleteFileIfExists(filePath)` - 删除文件（如果存在）
- `cleanupPostFiles(post)` - 清理文章关联的文件

### 文件位置

- 工具函数: `utils/blog-helper.js`
- 检查脚本: `db/check-unused-files.js`
- 清理脚本: `db/cleanup-unused-files.js`

