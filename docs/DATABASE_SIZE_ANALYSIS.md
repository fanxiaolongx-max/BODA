# 数据库大小分析报告

## 📊 总体情况

**数据库文件大小：2.67 GB**
- 主文件 (boda.db): **2.65 GB**
- WAL 文件 (boda.db-wal): 23.31 MB
- SHM 文件 (boda.db-shm): 64 KB

**实际数据大小：38.26 MB**

**问题：数据库文件大小是实际数据的 69.7 倍！** 这说明存在大量碎片空间。

## 🔍 详细分析

### 1. 表大小排名（按占用空间）

| 表名 | 记录数 | 数据大小 | 占比 |
|------|--------|----------|------|
| **logs** | 2,710 | **28.42 MB** | 74.28% |
| **custom_api_logs** | 8,468 | **8.51 MB** | 22.25% |
| **custom_apis** | 14 | **1.17 MB** | 3.07% |
| login_attempts_audit | 460 | 77.75 KB | 0.20% |
| blog_posts | 55 | 32.58 KB | 0.08% |
| 其他表 | - | < 15 KB | < 0.05% |

### 2. logs 表详细分析

**总记录数：2,710 条**
**占用空间：28.42 MB**
**主要字段占用：**
- `details` 字段：**27.96 MB** (98.40%)
- `user_agent` 字段：310.28 KB (1.07%)
- 其他字段：< 100 KB

#### details 字段大小分布

| 大小范围 | 记录数 | 总大小 | 平均大小 | 最大大小 |
|----------|--------|--------|----------|----------|
| <100B | 1,927 | 104.27 KB | 55 B | 99 B |
| 100B-1KB | 605 | 162.98 KB | 276 B | 1 KB |
| 1KB-10KB | 140 | 255.04 KB | 1.82 KB | 6.74 KB |
| 100KB-1MB | 29 | 17.41 MB | 614.86 KB | 952 KB |
| **>1MB** | **9** | **10.04 MB** | **1.12 MB** | **1.12 MB** |

#### 按操作类型统计

| Action | 记录数 | 总大小 | 平均大小 |
|--------|--------|--------|----------|
| **UPDATE** | 1,197 | **27.84 MB** | **23.81 KB** |
| LOGIN | 606 | 41.80 KB | 71 B |
| CREATE | 219 | 33.81 KB | 158 B |
| USER_LOGIN | 280 | 20.67 KB | 76 B |
| DELETE | 248 | 15.67 KB | 65 B |

#### 问题发现

1. **9 条记录超过 1MB**，全部是 `blog_post` 的 `UPDATE` 操作
   - 每条记录约 1.12 MB
   - 存储了完整的博客文章内容（包括 HTML）
   - 示例：`{"name":"【新开罗】2026音乐节","title":"...","html_content":"..."}`

2. **29 条记录在 100KB-1MB 之间**，主要是 `blog_post` 的 `UPDATE` 操作

3. **发现重复内容**：923.74 KB 的内容重复了 2 次

### 3. custom_api_logs 表分析

**总记录数：8,468 条**
**占用空间：8.51 MB**
**主要字段占用：**
- `request_headers`：5.99 MB (70.42%)
- `user_agent`：1.52 MB (17.90%)
- `request_query`：337.59 KB (3.87%)

**好消息：消息体清理机制工作正常**
- 当前保留消息体的记录：68 条（仅最近1小时）
- 超过3小时的消息体：**已全部清理** ✅
- 按时间分布：
  - 1小时内：68 条，126.45 KB
  - 3-24小时：485 条，0 B（已清理）
  - 1-7天：6,354 条，0 B（已清理）
  - 7-30天：1,561 条，0 B（已清理）

## ⚠️ 主要问题

### 1. 数据库碎片化严重
- **文件大小 2.67 GB，实际数据仅 38.26 MB**
- 碎片率：**98.6%**
- **需要立即运行 VACUUM 压缩数据库**

### 2. logs 表存储了过多冗余数据
- `UPDATE` 操作存储了完整的对象内容
- `blog_post` 更新时存储了完整的 HTML 内容（超过 1MB）
- 建议：只存储变更的字段，而不是完整对象

### 3. custom_api_logs 表的 request_headers 占用较大
- 8.51 MB 中有 5.99 MB 是 `request_headers`
- 建议：考虑清理超过一定时间的 `request_headers`

## 💡 优化建议

### 立即执行（高优先级）

1. **运行 VACUUM 压缩数据库**
   ```bash
   node db/cleanup-api-logs.js 3 --vacuum
   ```
   或直接运行：
   ```bash
   sqlite3 /data/boda.db "VACUUM;"
   ```
   **预期效果：** 数据库文件从 2.67 GB 压缩到约 50-100 MB

2. **优化 logs 表的 details 字段存储**
   - 对于 `UPDATE` 操作，只存储变更的字段，而不是完整对象
   - 对于 `blog_post`，可以考虑不存储完整的 HTML 内容
   - 或者限制 `details` 字段的最大长度

### 中期优化（中优先级）

3. **清理旧的 logs 记录**
   - 考虑只保留最近 30-90 天的操作日志
   - 或者定期归档旧日志

4. **优化 custom_api_logs 表**
   - 考虑清理超过 24 小时的 `request_headers`
   - 或者限制 `request_headers` 的大小

5. **添加数据库大小监控**
   - 定期运行 `db/analyze-db-size.js` 监控数据库大小
   - 设置告警阈值

### 长期优化（低优先级）

6. **考虑使用日志轮转**
   - 将旧日志迁移到归档表或文件
   - 只保留最近的数据在主表中

7. **优化日志记录策略**
   - 对于大对象（如 blog_post），只记录关键字段
   - 或者使用引用而不是完整内容

## 📈 预期优化效果

执行 VACUUM 后：
- **数据库文件大小：从 2.67 GB 降至约 50-100 MB**
- **空间节省：约 2.5 GB**

优化 logs 表存储后：
- **logs 表大小：从 28.42 MB 降至约 5-10 MB**
- **空间节省：约 20 MB**

## 🔧 执行步骤

### 步骤 1：备份数据库（重要！）
```bash
node scripts/backup.js
```

### 步骤 2：运行 VACUUM
```bash
sqlite3 /data/boda.db "VACUUM;"
```

### 步骤 3：验证结果
```bash
node db/analyze-db-size.js
```

### 步骤 4：优化 logs 表存储（可选）
需要修改 `utils/logger.js` 中的 `logAction` 函数，只存储变更字段。

## 📝 总结

**当前状态：**
- ✅ custom_api_logs 表的清理机制工作正常
- ⚠️ 数据库文件碎片化严重（2.67 GB vs 38.26 MB）
- ⚠️ logs 表存储了过多冗余数据（特别是 blog_post 的完整内容）

**建议优先级：**
1. 🔴 **立即运行 VACUUM**（可节省约 2.5 GB）
2. 🟡 **优化 logs 表存储策略**（可节省约 20 MB）
3. 🟢 **定期监控数据库大小**

