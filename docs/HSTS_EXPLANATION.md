# HSTS 配置说明

## 什么是 HSTS？

HSTS (HTTP Strict Transport Security) 是一种安全机制，告诉浏览器"这个网站必须使用HTTPS访问"。

## maxAge 参数的含义

### ❌ 错误理解
- "程序只能使用1年"
- "1年后程序会停止工作"
- "1年后需要重新配置"

### ✅ 正确理解
`maxAge: 31536000` (1年) 表示：

1. **浏览器缓存时长**：浏览器会记住"这个网站必须用HTTPS"这个规则，记住1年
2. **自动续期**：只要服务器继续发送HSTS响应头，浏览器会**自动更新**这个记忆
3. **不影响程序**：这个值只影响浏览器端的缓存，**完全不影响服务器程序运行**

## 工作原理

### 第一次访问（HTTPS）
```
用户访问: https://yourdomain.com
服务器响应: Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
浏览器行为: "好的，我记住了，这个网站必须用HTTPS，我会记住1年"
```

### 1年内再次访问
```
用户访问: http://yourdomain.com (错误，用了HTTP)
浏览器行为: "我记得这个网站必须用HTTPS，自动重定向到HTTPS"
```

### 1年后（如果服务器不再发送HSTS头）
```
用户访问: http://yourdomain.com
浏览器行为: "我已经忘记HSTS规则了，允许HTTP访问"
```

### 1年后（如果服务器继续发送HSTS头）✅ 正常情况
```
用户访问: https://yourdomain.com
服务器响应: Strict-Transport-Security: max-age=31536000; ...
浏览器行为: "好的，我继续记住1年"（自动续期）
```

## 实际影响

### 对程序运行的影响
- ✅ **完全没有影响**
- ✅ 程序可以一直运行
- ✅ 不需要1年后重新配置
- ✅ 只要服务器正常运行，HSTS头会持续发送

### 对用户的影响
- ✅ 用户访问体验更好（自动HTTPS）
- ✅ 更安全（防止中间人攻击）
- ⚠️ 如果1年后服务器停止发送HSTS头，浏览器会"忘记"规则（但程序仍可正常访问）

## 配置建议

### 当前配置（推荐）
```javascript
hsts: {
  maxAge: 31536000, // 1年（31536000秒）
  includeSubDomains: true,
  preload: true
}
```

### 可以调整的值

| 时长 | 秒数 | 说明 |
|------|------|------|
| 6个月 | 15552000 | 较短，适合测试 |
| 1年 | 31536000 | **推荐**，平衡安全性和灵活性 |
| 2年 | 63072000 | 更长的缓存，更安全但灵活性降低 |
| 5年 | 157680000 | 非常长，适合长期稳定的网站 |

### 建议
- **生产环境**：使用1年或2年（当前1年已足够）
- **开发环境**：可以设置较短时间（如1小时：3600）或禁用HSTS
- **重要提示**：设置太长时间（如5年）后，如果域名不再使用HTTPS，用户可能无法访问

## 常见问题

### Q: 1年后程序会停止工作吗？
**A: 不会！** 这个值只影响浏览器缓存，不影响服务器程序。

### Q: 需要1年后重新配置吗？
**A: 不需要！** 只要服务器继续发送HSTS头，浏览器会自动续期。

### Q: 如果我想改变这个值怎么办？
**A: 直接修改 `maxAge` 值，重启服务器即可。** 浏览器会在下次访问时更新记忆。

### Q: 设置为更长时间（如5年）会更好吗？
**A: 不一定。** 更长时间意味着：
- ✅ 更安全（浏览器记住更久）
- ⚠️ 如果域名不再使用HTTPS，用户可能长期无法访问
- ⚠️ 灵活性降低

### Q: 开发环境需要HSTS吗？
**A: 通常不需要。** 可以在开发环境禁用或设置很短的时间：
```javascript
hsts: process.env.NODE_ENV === 'production' ? {
  maxAge: 31536000,
  includeSubDomains: true,
  preload: true
} : false
```

## 总结

- ✅ **1年有效期不会影响程序运行**
- ✅ **程序可以一直使用，无需担心**
- ✅ **只要服务器正常运行，HSTS会自动续期**
- ✅ **当前配置（1年）是推荐的最佳实践**

这个配置是**安全增强**，不是**使用限制**！

